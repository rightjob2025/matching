<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>転職支援システム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --sidebar-width: 250px;
            --header-height: 64px;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; background-color: #f8f9fa; }
        .spinner { border-top-color: #4f46e5; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .page { display: none; }
        .page.active { display: block; }
        .sidebar { width: var(--sidebar-width); }
        .main-content { margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #4f46e5; cursor: pointer; margin-top: -6px; box-shadow: 0 0 2px rgba(0,0,0,0.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #ddd; border-radius: 5px; }
        .gemini-content > *:first-child { margin-top: 0; }
        .multi-select-container { position: relative; }
        .multi-select-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #d1d5db; border-top: none; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; z-index: 50; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .multi-select-option { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f3f4f6; }
        .multi-select-option:hover { background-color: #f9fafb; }
        .multi-select-option.selected { background-color: #eff6ff; color: #1d4ed8; }
        .selection-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px; }
        .selection-tag { display: inline-flex; align-items: center; gap: 4px; background-color: #e0e7ff; color: #3730a3; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .selection-tag .remove-tag { cursor: pointer; color: #6366f1; font-weight: bold; }
        .selection-tag .remove-tag:hover { color: #4338ca; }
        .freeword-input { position: relative; }
        .freeword-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px; min-height: 24px; }
        .freeword-tag { display: inline-flex; align-items: center; gap: 4px; background-color: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .freeword-tag .remove-tag { cursor: pointer; color: #d97706; font-weight: bold; }
        .freeword-tag .remove-tag:hover { color: #b45309; }
    </style>
</head>
<body>
    <!-- Auth Container -->
    <div id="auth-container" class="min-h-screen bg-slate-100 flex items-center justify-center p-4">
        <div class="w-full max-w-md">
            <div class="text-center mb-8">
                <i class="fas fa-briefcase text-5xl text-indigo-600"></i>
                <h1 class="mt-4 text-3xl font-bold text-slate-800">転職支援システム</h1>
            </div>
            <div id="login-form-container" class="bg-white p-8 rounded-2xl shadow-lg">
                <form id="login-form" class="space-y-6">
                    <h2 class="text-xl font-bold text-center text-slate-700">ログイン</h2>
                    <div><label for="email" class="block text-sm font-medium text-slate-700">メールアドレス</label><input id="email" name="email" type="email" autocomplete="email" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"></div>
                    <div><label for="password" class="block text-sm font-medium text-slate-700">パスワード</label><input id="password" name="password" type="password" autocomplete="current-password" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"></div>
                    <div><button type="submit" class="w-full font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed bg-indigo-600 hover:bg-indigo-700 text-white mt-2"><i class="fas fa-sign-in-alt mr-2"></i>ログイン</button></div>
                </form>
                <div id="login-error" class="mt-4 text-center text-sm text-red-600 font-medium"></div>
                <div class="mt-4 text-sm text-center">
                    <a href="#" data-form="register" class="auth-link font-medium text-indigo-600 hover:text-indigo-500">アカウントをお持ちでないですか？</a>
                    <span class="mx-2 text-slate-300">|</span>
                    <a href="#" data-form="reset" class="auth-link font-medium text-indigo-600 hover:text-indigo-500">パスワードをお忘れですか？</a>
                </div>
            </div>
            <div id="register-form-container" class="hidden bg-white p-8 rounded-2xl shadow-lg">
                <form id="register-form" class="space-y-4">
                    <h2 class="text-xl font-bold text-center text-slate-700">新規登録</h2>
                    <div><label for="register-name" class="block text-sm font-medium text-slate-700">氏名</label><input id="register-name" type="text" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"></div>
                    <div><label for="register-email" class="block text-sm font-medium text-slate-700">メールアドレス</label><input id="register-email" type="email" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"></div>
                    <div><label for="register-password" class="block text-sm font-medium text-slate-700">パスワード</label><input id="register-password" type="password" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"></div>
                    <div><button type="submit" class="w-full font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed bg-indigo-600 hover:bg-indigo-700 text-white mt-2">登録</button></div>
                </form>
                <div class="mt-4 text-sm text-center"><a href="#" data-form="login" class="auth-link font-medium text-indigo-600 hover:text-indigo-500">既にアカウントをお持ちですか？</a></div>
            </div>
            <div id="reset-form-container" class="hidden bg-white p-8 rounded-2xl shadow-lg">
                 <form id="reset-form" class="space-y-4">
                    <h2 class="text-xl font-bold text-center text-slate-700">パスワードリセット</h2>
                     <p class="text-sm text-slate-600">登録したメールアドレスを入力してください。パスワード再設定用のリンクを送信します。</p>
                    <div><label for="reset-email" class="block text-sm font-medium text-slate-700">メールアドレス</label><input id="reset-email" type="email" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"></div>
                    <div><button type="submit" class="w-full font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed bg-indigo-600 hover:bg-indigo-700 text-white mt-2">送信</button></div>
                </form>
                 <div class="mt-4 text-sm text-center"><a href="#" data-form="login" class="auth-link font-medium text-indigo-600 hover:text-indigo-500">ログイン画面に戻る</a></div>
            </div>
        </div>
    </div>

    <!-- New Password Reset Container -->
    <div id="reset-password-container" class="hidden min-h-screen bg-slate-100 flex items-center justify-center p-4">
         <div class="w-full max-w-md">
              <div class="text-center mb-8">
                <i class="fas fa-key text-5xl text-indigo-600"></i>
                <h1 class="mt-4 text-3xl font-bold text-slate-800">新しいパスワードの設定</h1>
            </div>
             <div class="bg-white p-8 rounded-2xl shadow-lg">
                <form id="reset-password-form" class="space-y-4">
                    <p class="text-sm text-slate-600">新しいパスワードを入力してください。</p>
                    <input type="hidden" id="reset-token-input">
                    <div><label for="new-password" class="block text-sm font-medium text-slate-700">新しいパスワード</label><input id="new-password" type="password" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm"></div>
                    <div><label for="confirm-password" class="block text-sm font-medium text-slate-700">新しいパスワード（確認）</label><input id="confirm-password" type="password" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm"></div>
                    <div><button type="submit" class="w-full font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 bg-indigo-600 hover:bg-indigo-700 text-white mt-2">パスワードを更新</button></div>
                </form>
                 <div id="reset-password-error" class="mt-4 text-center text-sm text-red-600 font-medium"></div>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden">
        <aside class="sidebar bg-slate-800 text-white h-screen fixed top-0 left-0 flex flex-col p-4">
            <div class="text-center py-4 border-b border-slate-700">
                <i class="fas fa-briefcase text-3xl text-indigo-400"></i>
                <h1 class="mt-2 text-xl font-bold">転職支援システム</h1>
            </div>
            <nav id="nav-menu" class="mt-8 flex-grow space-y-2"></nav>
            <div class="mt-auto"><button id="logout-btn" class="w-full font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 bg-slate-700 hover:bg-red-600 text-white"><i class="fas fa-sign-out-alt mr-2"></i>ログアウト</button></div>
        </aside>

        <div class="main-content">
            <header class="bg-white h-[var(--header-height)] flex items-center justify-end px-8 border-b">
                <div id="user-info" class="flex items-center">
                    <i class="fas fa-user-circle text-2xl text-slate-500 mr-3"></i>
                    <span id="user-name-display" class="text-slate-700 font-medium"></span>
                </div>
            </header>
            <main id="page-content" class="p-8">
                <div id="dashboard-page" class="page"></div>
                <div id="job-search-page" class="page"></div>
                <div id="recommendations-list-page" class="page"></div>
                <div id="progress-page" class="page"></div>
                <div id="mypage-page" class="page"></div>
                <div id="user-management-page" class="page"></div>
                <div id="job-management-page" class="page"></div>
            </main>
        </div>
    </div>
    
    <!-- Modal -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
       <div id="modal-dialog" class="bg-white rounded-xl shadow-2xl w-full max-w-lg transition-all duration-300">
            <div id="modal-header" class="p-4 border-b flex justify-between items-center">
                <h3 id="modal-title" class="text-xl font-bold text-slate-800"></h3>
                <button id="modal-close-btn" class="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            </div>
            <div id="modal-content" class="p-6 max-h-[70vh] overflow-y-auto"></div>
            <div id="modal-footer" class="p-4 bg-slate-50 rounded-b-xl text-right">
                <button id="modal-ok-btn" class="font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 bg-indigo-600 hover:bg-indigo-700 text-white">OK</button>
            </div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="//unpkg.com/alpinejs" defer></script>
    <script>
    (($) => {
        'use strict';
        // ========================
        // Master Data (Hard-coded)
        // ========================
        const PREFECTURES = [ '北海道', '青森県', '岩手県', '宮城県', '秋田県', '山形県', '福島県', '茨城県', '栃木県', '群馬県', '埼玉県', '千葉県', '東京都', '神奈川県', '新潟県', '富山県', '石川県', '福井県', '山梨県', '長野県', '岐阜県', '静岡県', '愛知県', '三重県', '滋賀県', '京都府', '大阪府', '兵庫県', '奈良県', '和歌山県', '鳥取県', '島根県', '岡山県', '広島県', '山口県', '徳島県', '香川県', '愛媛県', '高知県', '福岡県', '佐賀県', '長崎県', '熊本県', '大分県', '宮崎県', '鹿児島県', '沖縄県' ];
        const EMPLOYMENT_TYPES = [ '正社員', '契約社員', 'アルバイト・パート', '派遣社員', '業務委託', 'インターン', '嘱託社員', '臨時職員', 'フリーランス' ];

        // ========================
        // Configuration & State
        // ========================
        // ★★★ あなたのGASウェブアプリのURLに書き換えてください ★★★
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyrb6yV6m-zpgJspU6Yfeyp1anph5K85rClorktnGM8p3EXl1sMtx4AN4frLDECozLv/exec";
        
        let CURRENT_USER = null;
        let ALL_JOBS = [];
        let FILTERED_JOBS = [];
        let ALL_USERS = [];
        let MASTERS = {};
        let ALL_APPLICATIONS = [];
        let FAVORITE_JOB_IDS = [];
        
        const JOBS_PER_PAGE = 12;
        let currentJobPage = 1;

        let activeSearchTags = [], selectedIndustries = [], selectedJobTypes = [], selectedEmploymentTypes = [], selectedLocations = [], searchFreewords = [];
        let desiredIndustries = [], desiredJobTypes = [], desiredEmploymentTypes = [], desiredLocations = [], desiredFreewords = [];
        let editedDesiredIndustries = [], editedDesiredJobTypes = [], editedDesiredEmploymentTypes = [], editedDesiredLocations = [], editedDesiredFreewords = [];

        // ========================
        // Permissions
        // ========================
        const pagePermissions = {
            'user': ['dashboard', 'job-search', 'progress', 'mypage', 'recommendations-list'],
            'coach': ['dashboard', 'job-search', 'progress', 'mypage', 'user-management', 'recommendations-list'],
            'admin': ['dashboard', 'job-search', 'progress', 'mypage', 'user-management', 'job-management', 'recommendations-list']
        };

        // ========================
        // API Handler
        // ========================
        const api = {
            call: function(action, params = []) {
                ui.showSpinner();
                const userPayload = CURRENT_USER ? { ...CURRENT_USER } : {};
                delete userPayload.password_hash;

                const bodyPayload = ['resetPassword', 'sendPasswordResetLink'].includes(action) 
                    ? { action, params } 
                    : { action, params, user: userPayload };

                return fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(bodyPayload),
                    redirect: 'follow'
                })
                .then(response => response.ok ? response.text() : Promise.reject(`サーバーエラー: ${response.status}`))
                .then(text => {
                    try { return JSON.parse(text); } 
                    catch (e) { console.error("JSON Parse Error:", text); return Promise.reject('サーバーからの応答が不正です。'); }
                })
                .then(result => {
                    if (result.status === 'success') return result.data;
                    return Promise.reject(result.message || 'APIエラーが発生しました。');
                })
                .catch(error => {
                    console.error('API Call Failed:', action, error);
                    let errorMessage = `APIの呼び出しに失敗しました: ${error.message || error}。`;
                    if (String(error).includes('Failed to fetch')) {
                        errorMessage += '\n\n「確認してください」\n1. GASのウェブアプリURLは正しいですか？\n2. GASを「新しいデプロイ」で公開しましたか？\n3. デプロイ時にアクセス権を「全員」に設定しましたか？';
                    }
                    ui.showAlert('APIエラー', errorMessage);
                    throw error;
                })
                .finally(ui.hideSpinner);
            }
        };
        
        // ========================
        // Multi-Select & Freeword Components (コードは変更なし)
        // ========================
        const multiSelect = { create: function(containerId, options, selectedValues, onSelectionChange) { const container = $(`#${containerId}`); container.empty(); const wrapper = $(`<div class="multi-select-container"><button type="button" class="multi-select-trigger mt-1 block w-full text-left px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"><span class="selected-count">${selectedValues.length>0?`${selectedValues.length}件選択済み`:'選択してください'}</span><i class="fas fa-chevron-down float-right mt-0.5"></i></button><div class="multi-select-dropdown hidden"></div><div class="selection-tags"></div></div>`); const dropdown = wrapper.find('.multi-select-dropdown'); const trigger = wrapper.find('.multi-select-trigger'); const tagsContainer = wrapper.find('.selection-tags'); options.forEach(option => { const isSelected = selectedValues.includes(option); const optionElement = $(`<div class="multi-select-option ${isSelected?'selected':''}" data-value="${option}"><i class="fas ${isSelected?'fa-check-square':'fa-square'} mr-2"></i> ${option}</div>`); dropdown.append(optionElement); }); trigger.on('click', function(e) { e.stopPropagation(); $('.multi-select-dropdown').not(dropdown).addClass('hidden'); dropdown.toggleClass('hidden'); }); dropdown.on('click', '.multi-select-option', function(e) { e.stopPropagation(); const value = $(this).data('value'); const isSelected = $(this).hasClass('selected'); if (isSelected) { selectedValues.splice(selectedValues.indexOf(value), 1); $(this).removeClass('selected').find('i').removeClass('fa-check-square').addClass('fa-square'); } else { selectedValues.push(value); $(this).addClass('selected').find('i').removeClass('fa-square').addClass('fa-check-square'); } updateDisplay(); if (onSelectionChange) onSelectionChange(selectedValues); }); $(document).on('click', function() { dropdown.addClass('hidden'); }); function updateDisplay() { wrapper.find('.selected-count').text(selectedValues.length > 0 ? `${selectedValues.length}件選択済み` : '選択してください'); tagsContainer.empty(); selectedValues.forEach(value => { const tag = $(`<span class="selection-tag">${value}<span class="remove-tag" data-value="${value}">×</span></span>`); tagsContainer.append(tag); }); } tagsContainer.on('click', '.remove-tag', function(e) { e.stopPropagation(); const value = $(this).data('value'); const index = selectedValues.indexOf(value); if (index > -1) { selectedValues.splice(index, 1); dropdown.find(`[data-value="${value}"]`).removeClass('selected').find('i').removeClass('fa-check-square').addClass('fa-square'); updateDisplay(); if (onSelectionChange) onSelectionChange(selectedValues); } }); container.append(wrapper); updateDisplay(); } };
        const freewordInput = { create: function(containerId, freewords, onFreewordsChange) { const container = $(`#${containerId}`); container.empty(); const wrapper = $(`<div class="freeword-input"><input type="text" class="freeword-text-input mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" placeholder="フリーワードを入力してEnter（複数可）"><div class="freeword-tags"></div></div>`); const textInput = wrapper.find('.freeword-text-input'); const tagsContainer = wrapper.find('.freeword-tags'); function updateDisplay() { tagsContainer.empty(); freewords.forEach(word => { const tag = $(`<span class="freeword-tag">${word}<span class="remove-tag" data-word="${word}">×</span></span>`); tagsContainer.append(tag); }); } textInput.on('keydown', function(e) { if (e.key === 'Enter') { e.preventDefault(); const value = $(this).val().trim(); if (value && !freewords.includes(value)) { freewords.push(value); $(this).val(''); updateDisplay(); if (onFreewordsChange) onFreewordsChange(freewords); } } }); tagsContainer.on('click', '.remove-tag', function(e) { e.stopPropagation(); const word = $(this).data('word'); const index = freewords.indexOf(word); if (index > -1) { freewords.splice(index, 1); updateDisplay(); if (onFreewordsChange) onFreewordsChange(freewords); } }); container.append(wrapper); updateDisplay(); } };
        
        // ========================
        // UI Handler
        // ========================
        const ui = {
            showSpinner: () => { if ($('#spinner').length === 0) $('body').append('<div id="spinner" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50"><div class="spinner w-12 h-12 border-4 rounded-full"></div></div>'); },
            hideSpinner: () => $('#spinner').remove(),
            navigateTo: (pageId) => {
                if (!pagePermissions[CURRENT_USER.role]?.includes(pageId)) {
                    ui.showAlert('アクセス権限がありません', 'このページにアクセスする権限がありません。'); return;
                }
                $('.page').removeClass('active'); $(`#${pageId}-page`).addClass('active');
                $('.sidebar-link').removeClass('bg-indigo-600 text-white').addClass('text-gray-300 hover:bg-slate-700');
                $(`.sidebar-link[data-page="${pageId}"]`).addClass('bg-indigo-600 text-white').removeClass('text-gray-300');
                const pageRenderers = { 'dashboard': renderDashboard, 'job-search': renderJobSearch, 'progress': renderProgress, 'mypage': renderMyPage, 'user-management': renderUserManagement, 'job-management': renderJobManagement, 'recommendations-list': renderRecommendationsList };
                pageRenderers[pageId]?.();
            },
            showModal: (title, content, options = {}) => { const { size = 'max-w-lg', showFooter = false } = options; $('#modal-title').text(title); $('#modal-content').html(content); $('#modal-dialog').removeClass('max-w-lg max-w-2xl max-w-3xl').addClass(size); $('#modal-footer').toggle(showFooter); $('#modal-container').removeClass('hidden'); },
            showAlert: (title, message) => { ui.showModal(title, `<p class="text-slate-600">${message.replace(/\n/g, '<br>')}</p>`, { showFooter: true }); },
            hideModal: () => $('#modal-container').addClass('hidden'),
            switchAuthForm: (form) => { $('#login-form-container, #register-form-container, #reset-form-container').hide(); $(`#${form}-form-container`).show(); }
        };

        // ========================
        // Page Rendering Functions (UI部分は変更なし)
        // ========================
        const jobListHtml = (jobsToRender) => { if (!jobsToRender || jobsToRender.length === 0) return ''; const truncate = (text, length) => (!text || typeof text !== 'string' || text.length <= length) ? text || 'N/A' : text.substring(0, length) + '...'; return jobsToRender.map(job => { const isFavorited = FAVORITE_JOB_IDS.includes(job.job_id); const isJobIdUrl = job.job_id && (String(job.job_id).startsWith('http://') || String(job.job_id).startsWith('https://')); const jobIdDisplay = isJobIdUrl ? `<a href="${job.job_id}" target="_blank" class="text-indigo-600 hover:underline">リンクを開く <i class="fas fa-external-link-alt text-xs"></i></a>` : (job.job_id || 'N/A'); return `<div class="bg-white rounded-xl shadow-md transition-all duration-300 hover:shadow-lg hover:-translate-y-1 p-6 flex flex-col"><div><div class="flex justify-between items-start mb-2"><h3 class="font-bold text-lg text-slate-800 pr-2">${job.title}</h3><button class="favorite-btn text-xl ${isFavorited ? 'text-yellow-400' : 'text-slate-400 hover:text-yellow-500'}" data-job-id="${job.job_id}"><i class="${isFavorited ? 'fas' : 'far'} fa-star"></i></button></div><p class="text-slate-500 text-sm mb-3">求人ID: ${jobIdDisplay}</p></div><div class="text-sm text-slate-600 space-y-2 flex-grow"><p><strong><i class="fas fa-building w-5 text-slate-400"></i> 会社名:</strong> ${job.company || 'N/A'}</p><p><strong><i class="fas fa-map-marker-alt w-5 text-slate-400"></i> 勤務地:</strong> ${job.location || 'N/A'}</p><p><strong><i class="fas fa-yen-sign w-5 text-slate-400"></i> 給与:</strong> ${job.salary || 'N/A'}</p><p><strong><i class="fas fa-briefcase w-5 text-slate-400"></i> 雇用形態:</strong> ${job['employment_type'] || job['employment type'] || 'N/A'}</p><p><strong><i class="fas fa-industry w-5 text-slate-400"></i> 業種:</strong> ${job.industrycategory || job.industry || 'N/A'}</p><p><strong><i class="fas fa-user-tie w-5 text-slate-400"></i> 職種:</strong> ${job.jobcategory || job.job_type || 'N/A'}</p><p class="mt-2"><strong>業務内容:</strong> ${truncate(job.description, 50)}</p><p class="mt-2"><strong>応募資格:</strong> ${truncate(job.qualifications, 50)}</p></div><div class="mt-auto pt-4 text-right"><button class="font-bold py-1 px-3 text-sm rounded-lg shadow-md transition-transform transform hover:scale-105 bg-slate-500 hover:bg-slate-600 text-white job-details-btn" data-job-id="${job.job_id}">詳細を見る</button></div></div>`; }).join(''); };
        const displayJobs = () => { const container = $('#job-list-container'); const startIndex = (currentJobPage - 1) * JOBS_PER_PAGE; const endIndex = startIndex + JOBS_PER_PAGE; const jobsToDisplay = FILTERED_JOBS.slice(startIndex, endIndex); if (currentJobPage === 1) container.empty(); container.append(jobListHtml(jobsToDisplay)); if (FILTERED_JOBS.length === 0 && currentJobPage === 1) container.html('<p class="text-slate-500 col-span-full text-center py-8">該当する求人はありません。</p>'); $('#load-more-container').toggle(endIndex < FILTERED_JOBS.length); };
        async function renderDashboard() { try { const data = await api.call('getDashboardData'); const role = CURRENT_USER.role; const cardClass = "bg-white rounded-xl shadow-md transition-all duration-300 hover:shadow-lg hover:-translate-y-1 p-6"; let content = `<h2 class="text-3xl font-bold text-slate-800 mb-6">ダッシュボード</h2>`; if (role === 'user') { let recsHtml = `<div class="${cardClass} col-span-1 md:col-span-2"><h3 class="font-bold text-lg mb-4">あなたへのおすすめ求人</h3>`; if (data.recommendations?.length > 0) { recsHtml += '<div id="recommendations-container" class="space-y-4">' + data.recommendations.map(rec => { const isAI = rec.recommendation_type === 'ai'; const icon = isAI ? 'fa-robot text-indigo-500' : 'fa-user-tie text-green-500'; const reason = rec.recommendation_reason || '担当コーチからのおすすめです。'; return `<div class="border rounded-lg p-4 recommendation-card" data-rec-id="${rec.recommendation_id}"><h4 class="font-bold text-slate-800">${rec.title}</h4><p class="text-sm text-slate-600 mb-2">${rec.company}</p><p class="text-sm text-slate-500 bg-slate-50 p-2 rounded-md"><i class="fas ${icon} mr-2"></i>${reason}</p><div class="text-right mt-3 space-x-2"><button class="font-bold py-1 px-3 text-sm rounded-lg shadow-md transition-transform transform hover:scale-105 bg-slate-400 hover:bg-slate-500 text-white recommendation-feedback-btn" data-rec-id="${rec.recommendation_id}" data-action="rejected">見送り</button><button class="font-bold py-1 px-3 text-sm rounded-lg shadow-md transition-transform transform hover:scale-105 bg-indigo-600 hover:bg-indigo-700 text-white recommendation-feedback-btn" data-rec-id="${rec.recommendation_id}" data-action="view" data-job-id="${rec.job_id}">詳細を見て判断する</button></div></div>`; }).join('') + '</div>'; } else { recsHtml += `<p class="text-slate-600">現在、おすすめの求人はありません。</p>`; } recsHtml += `</div>`; content += `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">${recsHtml}<div class="${cardClass}"><h3 class="font-bold text-lg mb-4">選考中の求人</h3><p class="text-4xl font-bold text-indigo-600 mt-2">${data.inProgressCount || 0}<span class="text-lg ml-1">件</span></p></div></div>`; } else if (role === 'coach') { content += `<div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="${cardClass} text-center"><h3 class="font-bold text-lg">担当求職者数</h3><p class="text-4xl font-bold text-indigo-600 mt-2">${data.totalAssignedUsers || 0}<span class="text-lg ml-1">人</span></p></div><div class="${cardClass} text-center"><h3 class="font-bold text-lg">選考中の案件</h3><p class="text-4xl font-bold text-indigo-600 mt-2">${data.inProgressApplications || 0}<span class="text-lg ml-1">件</span></p></div></div>`; } else if (role === 'admin') { content += `<div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="${cardClass} text-center"><h3 class="font-bold text-lg">登録ユーザー総数</h3><p class="text-4xl font-bold text-indigo-600 mt-2">${data.totalUsers || 0}<span class="text-lg ml-1">人</span></p></div><div class="${cardClass} text-center"><h3 class="font-bold text-lg">公開求人総数</h3><p class="text-4xl font-bold text-indigo-600 mt-2">${data.totalJobs || 0}<span class="text-lg ml-1">件</span></p></div><div class="${cardClass} text-center"><h3 class="font-bold text-lg">応募総数</h3><p class="text-4xl font-bold text-indigo-600 mt-2">${data.totalApplications || 0}<span class="text-lg ml-1">件</span></p></div></div>`; } $('#dashboard-page').html(content); } catch (e) { console.error("Dashboard render failed:", e); } }
        async function renderJobSearch() { try { const { jobs, masters, favoriteJobIds } = await api.call('getJobsAndMasters'); ALL_JOBS = jobs || []; FILTERED_JOBS = ALL_JOBS; MASTERS = masters || {}; FAVORITE_JOB_IDS = favoriteJobIds || []; const industryOptions = MASTERS.industry || []; const jobTypeOptions = MASTERS.job_type || []; let tagsHtml = ''; const allTags = [...new Set(ALL_JOBS.flatMap(j => j.tags ? String(j.tags).split(',').map(t=>t.trim()) : []).filter(Boolean))]; if(allTags.length > 0) { tagsHtml = `<div class="flex flex-wrap gap-2">${allTags.map(tag => `<span class="inline-block bg-slate-100 text-slate-600 cursor-pointer hover:bg-indigo-100 hover:text-indigo-600 px-2 py-1 text-xs font-semibold rounded-full tag-badge">${tag}</span>`).join('')}</div>`; } let content = `<div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-slate-800">求人検索</h2><span id="job-count" class="text-lg font-semibold text-slate-500"></span></div><div class="bg-white rounded-xl shadow-md p-6 mb-8"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><div><label class="block text-sm font-medium text-slate-700">キーワード</label><input id="search-keyword" type="text" placeholder="職種、企業名など" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"></div><div><label class="block text-sm font-medium text-slate-700">業種</label><div id="industry-multi-select"></div></div><div><label class="block text-sm font-medium text-slate-700">職種</label><div id="job-type-multi-select"></div></div></div><div x-data="{ open: false }"><button @click="open = !open" class="text-indigo-600 hover:underline mt-4 text-sm">詳細な条件で絞り込む <i class="fas fa-chevron-down transform transition-transform" :class="{'rotate-180': open}"></i></button><div x-show="open" x-transition class="mt-4 pt-4 border-t"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label class="block text-sm font-medium text-slate-700">雇用形態</label><div id="employment-type-multi-select"></div></div><div><label class="block text-sm font-medium text-slate-700">勤務地</label><div id="location-multi-select"></div></div></div><div class="mt-4"><label class="block text-sm font-medium text-slate-700">フリーワード検索（OR検索）</label><div id="search-freeword-input"></div><p class="text-xs text-slate-500 mt-1">複数入力した場合、いずれかが含まれる求人を検索します</p></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4"><div><label class="block text-sm font-medium text-slate-700">こだわり条件</label><div class="space-y-2 mt-2"><label class="flex items-center"><input type="checkbox" id="search-favorites-only" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"> <span class="ml-2 text-sm text-slate-700">お気に入りのみ表示</span></label></div><div><label for="salary-range" class="block text-sm font-medium text-slate-700 mt-4">希望年収（下限）: <span id="salary-value" class="font-bold text-indigo-600">指定なし</span></label><input type="range" id="salary-range" min="0" max="2000" step="50" value="0" class="w-full mt-2"></div></div><div class="mt-4"><label class="block text-sm font-medium text-slate-700">タグで絞り込む</label><div class="mt-2">${tagsHtml}</div></div></div></div></div><div class="flex justify-end mt-4"><button id="apply-desired-conditions-btn" class="font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 bg-teal-500 hover:bg-teal-600 text-white mr-2"><i class="fas fa-user-check mr-2"></i>希望条件で絞り込む</button><button id="job-search-reset-btn" class="font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 bg-slate-500 hover:bg-slate-600 text-white mr-2">リセット</button><button id="job-search-btn" class="font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 bg-indigo-600 hover:bg-indigo-700 text-white">この条件で検索</button></div></div><div id="job-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div><div id="load-more-container" class="text-center mt-8"><button id="load-more-btn" class="font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 bg-indigo-600 hover:bg-indigo-700 text-white">もっと見る</button></div>`; $('#job-search-page').html(content); multiSelect.create('industry-multi-select', industryOptions, selectedIndustries, v => selectedIndustries=v); multiSelect.create('job-type-multi-select', jobTypeOptions, selectedJobTypes, v => selectedJobTypes=v); multiSelect.create('employment-type-multi-select', EMPLOYMENT_TYPES, selectedEmploymentTypes, v => selectedEmploymentTypes=v); multiSelect.create('location-multi-select', PREFECTURES, selectedLocations, v => selectedLocations=v); freewordInput.create('search-freeword-input', searchFreewords, w => searchFreewords=w); performSearch(); } catch (e) { console.error("Job search render failed:", e); } }
        async function renderRecommendationsList() { try { const recs = await api.call('getAllRecommendations'); const isManager = ['admin', 'coach'].includes(CURRENT_USER.role); const searchFilterHtml = CURRENT_USER.role === 'admin' ? `<div class="mb-4"><input id="recommendation-user-search" type="text" placeholder="求職者名で絞り込み..." class="block w-full max-w-xs px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"></div>` : ''; let content = `<h2 class="text-3xl font-bold text-slate-800 mb-6">おすすめ求人一覧</h2>${searchFilterHtml}`; if (!recs || recs.length === 0) { content += `<div class="bg-white rounded-xl shadow-md p-6"><p class="text-center text-slate-500">過去に推薦された求人はありません。</p></div>`; $('#recommendations-list-page').html(content); return; } const getBadge = r => ({'view':'bg-blue-100 text-blue-700','rejected':'bg-slate-100 text-slate-600','applied':'bg-green-100 text-green-700'}[r] || 'bg-yellow-100 text-yellow-700'); const getBadgeText = r => ({'view':'詳細確認済み','rejected':'見送り','applied':'応募済み'}[r] || '未対応'); const tableRows = recs.map(rec => { const recDate = new Date(rec.created_at).toLocaleDateString('ja-JP'); const isAI = rec.recommendation_type === 'ai'; const recommender = isAI ? `AI (${rec.ai_score||'N/A'}点)` : rec.recommender_name; const managerCell = isManager ? `<td class="p-3 text-slate-700">${rec.user_name}</td>` : ''; return `<tr class="border-b recommendation-row" data-user-name="${rec.user_name||''}"><td class="p-3 text-sm text-slate-600">${recDate}</td>${managerCell}<td class="p-3 font-medium text-slate-800">${rec.title}</td><td class="p-3 text-slate-700">${rec.company}</td><td class="p-3 text-slate-600"><i class="fas ${isAI?'fa-robot text-indigo-500':'fa-user-tie text-green-500'} mr-2"></i>${recommender}</td><td class="p-3"><span class="px-2 py-1 text-xs font-semibold rounded-full ${getBadge(rec.user_reaction)}">${getBadgeText(rec.user_reaction)}</span></td><td class="p-3 text-right"><button class="font-bold py-1 px-3 text-sm rounded-lg shadow-md transition-transform transform hover:scale-105 bg-slate-500 hover:bg-slate-600 text-white job-details-btn" data-job-id="${rec.job_id}">詳細を見る</button></td></tr>`; }).join(''); content += `<div class="bg-white rounded-xl shadow-md overflow-x-auto"><table class="w-full text-left min-w-[700px]"><thead class="bg-slate-50 border-b"><tr><th class="p-3 text-sm font-semibold text-slate-600">推薦日</th>${isManager ? '<th class="p-3 text-sm font-semibold text-slate-600">求職者名</th>':''}<th class="p-3 text-sm font-semibold text-slate-600">求人名</th><th class="p-3 text-sm font-semibold text-slate-600">企業名</th><th class="p-3 text-sm font-semibold text-slate-600">推薦者</th><th class="p-3 text-sm font-semibold text-slate-600">あなたの判断</th><th class="p-3"></th></tr></thead><tbody id="recommendations-table-body">${tableRows}</tbody></table></div>`; $('#recommendations-list-page').html(content); } catch (e) { console.error("Recs list render failed:", e); } }
        async function renderProgress() { try { const { applications, statuses } = await api.call('getProgressData'); ALL_APPLICATIONS = applications || []; MASTERS.application_status = statuses || []; const getBadge = s => ({ "内定": "bg-green-100 text-green-700", "最終面接": "bg-purple-100 text-purple-700", "一次面接": "bg-blue-100 text-blue-700", "二次面接": "bg-blue-100 text-blue-700", "書類選考": "bg-yellow-100 text-yellow-700", "応募完了": "bg-yellow-100 text-yellow-700", "終了": "bg-slate-100 text-slate-600", "見送り": "bg-red-100 text-red-700" }[s] || 'bg-slate-100 text-slate-600'); const tableRows = apps => apps?.length > 0 ? apps.map(app => { const group = ['内定'].includes(app.status)?'offered':(['終了','見送り'].includes(app.status)?'finished':'progress'); return `<tr class="border-b" data-status-group="${group}"><td class="p-3 text-sm text-slate-600">${new Date(app.application_date).toLocaleDateString('ja-JP')}</td><td class="p-3 font-medium text-slate-800">${app.company_name}</td><td class="p-3 text-slate-700">${app.job_title}</td>${['admin','coach'].includes(CURRENT_USER.role)?`<td class="p-3 text-slate-600">${app.user_name}</td>`:''}<td class="p-3"><span class="px-2 py-1 text-xs font-semibold rounded-full ${getBadge(app.status)}">${app.status||'N/A'}</span></td><td class="p-3 text-right space-x-2"><button class="font-bold py-1 px-3 text-sm rounded-lg shadow-md transition-transform transform hover:scale-105 bg-slate-500 hover:bg-slate-600 text-white details-btn" data-id="${app.application_id}">詳細</button>${CURRENT_USER.role==='admin'?`<button class="font-bold py-1 px-3 text-sm rounded-lg shadow-md transition-transform transform hover:scale-105 bg-slate-500 hover:bg-slate-600 text-white edit-status-btn" data-id="${app.application_id}" data-current-status="${app.status}">編集</button>`:''}</td></tr>`; }).join('') : '<tr><td colspan="6" class="text-center text-slate-500 py-8">該当する応募情報はありません。</td></tr>'; let content = `<div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-slate-800">進捗管理</h2></div><div class="bg-white rounded-xl shadow-md p-4 mb-6"><div class="flex items-center space-x-2"><span class="text-sm font-medium text-slate-600">絞り込み:</span><button class="filter-btn font-bold py-1 px-3 text-sm rounded-lg shadow-md bg-indigo-600 text-white" data-filter="progress">進捗中</button><button class="filter-btn font-bold py-1 px-3 text-sm rounded-lg shadow-md bg-slate-500 text-white" data-filter="offered">内定</button><button class="filter-btn font-bold py-1 px-3 text-sm rounded-lg shadow-md bg-slate-500 text-white" data-filter="finished">終了</button><button class="filter-btn font-bold py-1 px-3 text-sm rounded-lg shadow-md bg-slate-500 text-white" data-filter="all">すべて表示</button></div></div><div class="bg-white rounded-xl shadow-md overflow-x-auto"><table class="w-full text-left min-w-[600px]"><thead class="bg-slate-50 border-b"><tr><th class="p-3 text-sm font-semibold text-slate-600">応募日</th><th class="p-3 text-sm font-semibold text-slate-600">企業名</th><th class="p-3 text-sm font-semibold text-slate-600">求人名</th>${['admin','coach'].includes(CURRENT_USER.role)?'<th class="p-3 text-sm font-semibold text-slate-600">応募者</th>':''}<th class="p-3 text-sm font-semibold text-slate-600">ステータス</th><th class="p-3"></th></tr></thead><tbody id="progress-table-body">${tableRows(ALL_APPLICATIONS)}</tbody></table></div>`; $('#progress-page').html(content); if (ALL_APPLICATIONS.length > 0) $('.filter-btn[data-filter="progress"]').click(); } catch (e) { console.error("Progress render failed:", e); } }
        async function renderMyPage() { try { if (!MASTERS.industry || !MASTERS.job_type) { const { masters } = await api.call('getJobsAndMasters'); MASTERS = { ...MASTERS, ...masters }; } const profile = await api.call('getMyProfile'); if (!profile) throw new Error('Profile not found'); desiredIndustries = profile.desired_industry?.split(',').map(s=>s.trim()).filter(Boolean) || []; desiredJobTypes = profile.desired_job_type?.split(',').map(s=>s.trim()).filter(Boolean) || []; desiredEmploymentTypes = profile.desired_employment_type?.split(',').map(s=>s.trim()).filter(Boolean) || []; desiredLocations = profile.desired_location?.split(',').map(s=>s.trim()).filter(Boolean) || []; desiredFreewords = profile.desired_freewords?.split(',').map(s=>s.trim()).filter(Boolean) || []; const fLabel = "block text-sm font-medium text-slate-700"; const fInput = "mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"; const card = "bg-white rounded-xl shadow-md p-6"; const btn = "font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 bg-indigo-600 hover:bg-indigo-700 text-white"; let content = `<h2 class="text-3xl font-bold text-slate-800 mb-6">マイページ</h2><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-2"><form id="profile-form"><div class="${card} mb-8"><h3 class="text-xl font-bold text-slate-800 mb-4">基本情報</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="${fLabel}">氏名</label><input name="name" type="text" class="${fInput}" value="${profile.name||''}"></div><div><label class="${fLabel}">メールアドレス</label><input type="email" class="${fInput} bg-slate-100" value="${profile.email||''}" readonly disabled></div></div></div><div class="${card}"><h3 class="text-xl font-bold text-slate-800 mb-4">希望条件</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="${fLabel}">希望業種</label><div id="desired-industry-multi-select"></div></div><div><label class="${fLabel}">希望職種</label><div id="desired-job-type-multi-select"></div></div><div><label class="${fLabel}">希望勤務形態</label><div id="desired-employment-type-multi-select"></div></div><div><label class="${fLabel}">希望勤務地</label><div id="desired-location-multi-select"></div></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4"><div><label class="${fLabel}">希望年収</label><input name="desired_salary" type="text" placeholder="例: 500万円" class="${fInput}" value="${profile.desired_salary||''}"></div></div><div class="mt-4"><label class="${fLabel}">希望フリーワード（OR検索）</label><div id="desired-freeword-input"></div><p class="text-xs text-slate-500 mt-1">AI推薦で優先的に表示します</p></div><div class="mt-4"><label class="${fLabel}">自己PR・スキル・経験など</label><textarea name="notes" placeholder="スキル、経験などを自由にご記入ください" class="${fInput}" rows="4">${profile.notes||''}</textarea></div><div class="mt-4"><label class="${fLabel}">履歴書 (テキスト)</label><textarea name="resume" placeholder="ここに履歴書のテキスト情報を貼り付けてください" class="${fInput}" rows="10">${profile.resume||''}</textarea></div><div class="mt-4"><label class="${fLabel}">職務経歴書 (テキスト)</label><textarea name="work_history" placeholder="ここに職務経歴書のテキスト情報を貼り付けてください" class="${fInput}" rows="15">${profile.work_history||''}</textarea></div></div><div class="mt-6 text-right"><button type="submit" class="${btn}">プロフィールを更新</button></div></form></div><div><div class="${card}"><h3 class="text-xl font-bold text-slate-800 mb-4">関連資料</h3><p class="text-sm text-slate-600 mb-4">履歴書などはこちらで管理してください。</p><a href="${profile.drive_folder_url||'#'}" target="_blank" class="w-full text-center font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 bg-slate-500 hover:bg-slate-600 text-white block"><i class="fab fa-google-drive mr-2"></i>Google Driveを開く</a></div></div></div>`; $('#mypage-page').html(content); multiSelect.create('desired-industry-multi-select', MASTERS.industry||[], desiredIndustries, v => desiredIndustries=v); multiSelect.create('desired-job-type-multi-select', MASTERS.job_type||[], desiredJobTypes, v => desiredJobTypes=v); multiSelect.create('desired-employment-type-multi-select', EMPLOYMENT_TYPES, desiredEmploymentTypes, v => desiredEmploymentTypes=v); multiSelect.create('desired-location-multi-select', PREFECTURES, desiredLocations, v => desiredLocations=v); freewordInput.create('desired-freeword-input', desiredFreewords, w => desiredFreewords=w); } catch (e) { console.error("MyPage render failed:", e); } }
        async function renderUserManagement() { try { const users = await api.call('getAllUsers'); ALL_USERS = users || []; const coaches = users.filter(u => u.role === 'coach'); const btnPrimary = "font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 bg-indigo-600 hover:bg-indigo-700 text-white"; const btnSecondarySm = "font-bold py-1 px-3 text-sm rounded-lg shadow-md transition-transform transform hover:scale-105 bg-slate-500 hover:bg-slate-600 text-white"; const fInput = "mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"; const userListHtml = usersToRender => usersToRender.map(user => { const editBtn = `<button class="${btnSecondarySm} edit-user-btn" data-user-id="${user.user_id}">編集</button>`; const recommendBtn = `<button class="font-bold py-1 px-3 text-sm rounded-lg shadow-md transition-transform transform hover:scale-105 bg-sky-500 hover:bg-sky-600 text-white ai-recommend-btn" data-user-id="${user.user_id}">✨ AI推薦</button>`; const actions = (CURRENT_USER.role !== 'user' && user.role === 'user') ? `${recommendBtn} ${editBtn}` : (CURRENT_USER.role === 'admin' ? editBtn : ''); return `<tr class="border-b"><td class="p-3 font-medium">${user.name}</td><td class="p-3 text-slate-600">${user.email}</td><td class="p-3 text-slate-600">${user.role}</td><td class="p-3 text-slate-600">${coaches.find(c=>c.user_id===user.coach_id)?.name||'未割り当て'}</td><td class="p-3 text-right space-x-2">${actions}</td></tr>`; }).join(''); let content = `<div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-slate-800">ユーザー管理</h2>${CURRENT_USER.role==='admin'?`<button id="show-new-user-modal-btn" class="${btnPrimary}"><i class="fas fa-user-plus mr-2"></i>新規ユーザー登録</button>`:''}</div><div class="bg-white rounded-xl shadow-md p-6"><input id="user-search-input" type="text" placeholder="氏名、メールアドレスで検索..." class="${fInput} mb-4"><div class="overflow-x-auto"><table class="w-full text-left min-w-[600px]"><thead class="bg-slate-50 border-b"><tr><th class="p-3 text-sm font-semibold text-slate-600">氏名</th><th class="p-3 text-sm font-semibold text-slate-600">メールアドレス</th><th class="p-3 text-sm font-semibold text-slate-600">役割</th><th class="p-3 text-sm font-semibold text-slate-600">担当コーチ</th><th class="p-3"></th></tr></thead><tbody id="user-list-body">${userListHtml(ALL_USERS)}</tbody></table></div></div>`; $('#user-management-page').html(content); } catch (e) { console.error("User Management render failed:", e); } }
        async function renderJobManagement() { try { const { jobs, masters } = await api.call('getJobsAndMasters'); ALL_JOBS = jobs || []; MASTERS = { ...MASTERS, ...masters }; const btnPrimary = "font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 bg-indigo-600 hover:bg-indigo-700 text-white"; const btnSecondary = "font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 bg-slate-500 hover:bg-slate-600 text-white"; const btnSecondarySm = "font-bold py-1 px-3 text-sm rounded-lg shadow-md transition-transform transform hover:scale-105 bg-slate-500 hover:bg-slate-600 text-white"; const fInput = "mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"; const jobListHtml = jobsToRender => jobsToRender.map(job => `<tr class="border-b"><td class="p-3 font-medium">${job.title}</td><td class="p-3 text-slate-600">${job.company}</td><td class="p-3 text-slate-600">${job.status}</td><td class="p-3 text-slate-600">${new Date(job.created_at).toLocaleDateString()}</td><td class="p-3 text-right"><button class="${btnSecondarySm} edit-job-btn" data-job-id="${job.job_id}">編集</button></td></tr>`).join(''); let content = `<div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-slate-800">求人管理</h2><div class="space-x-2"><button id="show-new-job-modal-btn" class="${btnPrimary}"><i class="fas fa-plus mr-2"></i>新規登録</button></div></div><div class="bg-white rounded-xl shadow-md p-6"><input id="job-management-search-input" type="text" placeholder="求人名、企業名で検索..." class="${fInput} mb-4"><div class="overflow-x-auto"><table class="w-full text-left min-w-[600px]"><thead class="bg-slate-50 border-b"><tr><th class="p-3 text-sm font-semibold text-slate-600">求人名</th><th class="p-3 text-sm font-semibold text-slate-600">企業名</th><th class="p-3 text-sm font-semibold text-slate-600">ステータス</th><th class="p-3 text-sm font-semibold text-slate-600">登録日</th><th class="p-3"></th></tr></thead><tbody id="job-list-body">${jobListHtml(ALL_JOBS)}</tbody></table></div></div>`; $('#job-management-page').html(content); } catch(e) { console.error("Job Management render failed:", e); } }
        
        // ========================
        // Application Logic
        // ========================
        function main() {
            $('#auth-container').addClass('hidden'); $('#app-container').removeClass('hidden');
            $('#user-name-display').text(CURRENT_USER.name || 'ゲスト');
            const links = {
                dashboard: `<a href="#" class="sidebar-link flex items-center px-4 py-3 rounded-lg" data-page="dashboard"><i class="fas fa-home w-6 mr-3"></i><span>ダッシュボード</span></a>`,
                jobSearch: `<a href="#" class="sidebar-link flex items-center px-4 py-3 rounded-lg" data-page="job-search"><i class="fas fa-search w-6 mr-3"></i><span>求人検索</span></a>`,
                recommendationsList: `<a href="#" class="sidebar-link flex items-center px-4 py-3 rounded-lg" data-page="recommendations-list"><i class="fas fa-star w-6 mr-3"></i><span>おすすめ求人一覧</span></a>`,
                progress: `<a href="#" class="sidebar-link flex items-center px-4 py-3 rounded-lg" data-page="progress"><i class="fas fa-tasks w-6 mr-3"></i><span>進捗管理</span></a>`,
                mypage: `<a href="#" class="sidebar-link flex items-center px-4 py-3 rounded-lg" data-page="mypage"><i class="fas fa-user-cog w-6 mr-3"></i><span>マイページ</span></a>`,
                userManagement: `<a href="#" class="sidebar-link flex items-center px-4 py-3 rounded-lg" data-page="user-management"><i class="fas fa-users w-6 mr-3"></i><span>ユーザー管理</span></a>`,
                jobManagement: `<a href="#" class="sidebar-link flex items-center px-4 py-3 rounded-lg" data-page="job-management"><i class="fas fa-briefcase w-6 mr-3"></i><span>求人管理</span></a>`
            };
            let navHtml = `${links.dashboard}${links.jobSearch}${links.recommendationsList}${links.progress}${links.mypage}`;
            if (['admin','coach'].includes(CURRENT_USER.role)) navHtml += `<hr class="my-4 border-slate-700"><h3 class="px-4 py-2 text-xs font-semibold text-slate-400 uppercase">管理メニュー</h3>${links.userManagement}`;
            if (CURRENT_USER.role === 'admin') navHtml += `${links.jobManagement}`;
            $('#nav-menu').html(navHtml);
            ui.navigateTo('dashboard');
        }

        const getFilteredJobs = () => {
            const keyword = $('#search-keyword').val().toLowerCase();
            const minSalary = parseInt($('#salary-range').val(), 10);
            const favoritesOnly = $('#search-favorites-only').is(':checked');
            return ALL_JOBS.filter(job => {
                if (!job) return false;
                const keywordMatch = keyword ? (Object.values(job).join(' ').toLowerCase().includes(keyword)) : true;
                const industryMatch = selectedIndustries.length > 0 ? selectedIndustries.includes(job.industrycategory || job.industry) : true;
                const jobTypeMatch = selectedJobTypes.length > 0 ? selectedJobTypes.includes(job.jobcategory || job.job_type) : true;
                const employmentTypeMatch = selectedEmploymentTypes.length > 0 ? selectedEmploymentTypes.some(t => (job.employment_type||job['employment type']||'').includes(t)) : true;
                const locationMatch = selectedLocations.length > 0 ? selectedLocations.some(l => (job.location||'').includes(l)) : true;
                const salaryMatch = minSalary > 0 ? (parseInt(job.salary_min, 10) >= minSalary) : true;
                const tagsMatch = activeSearchTags.length > 0 ? activeSearchTags.every(tag => (job.tags || '').includes(tag)) : true;
                const favoritesMatch = favoritesOnly ? FAVORITE_JOB_IDS.includes(job.job_id) : true;
                const freewordMatch = searchFreewords.length > 0 ? searchFreewords.some(word => Object.values(job).join(' ').toLowerCase().includes(word.toLowerCase())) : true;
                return keywordMatch && industryMatch && jobTypeMatch && employmentTypeMatch && locationMatch && salaryMatch && tagsMatch && favoritesMatch && freewordMatch;
            });
        };
        
        const performSearch = () => { FILTERED_JOBS = getFilteredJobs(); currentJobPage = 1; displayJobs(); $('#job-count').text(`${FILTERED_JOBS.length} 件の求人`); };
        
        async function showJobDetailsModal(jobId) {
            let job = ALL_JOBS.find(j => j.job_id === jobId) || await api.call('getJobDetails', [jobId]);
            if (!job) { ui.showAlert('エラー', '求人情報の取得に失敗しました。'); return; }
            if (!ALL_JOBS.some(j => j.job_id === jobId)) ALL_JOBS.push(job);
            
            ui.showModal(job.title, '<div class="spinner w-8 h-8 mx-auto"></div><p class="text-center mt-2">求人情報を取得中...</p>', { size: 'max-w-3xl' });
            
            if (String(job.job_id).startsWith('http')) {
                 try {
                    const scrapedData = await api.call('scrapeJobDetails', [job.job_id]);
                    if (scrapedData.jobDescription) job.description = `【外部サイトの内容】\n${scrapedData.jobDescription}`;
                    if (scrapedData.requirements) job.qualifications = `【外部サイトの内容】\n${scrapedData.requirements}`;
                } catch (e) { job.description += `\n\n[エラー: サイト内容を取得できませんでした]`; }
            }
            
            const fields = {'company':'企業名','salary':'給与','location':'勤務地','employment_type':'雇用形態','industrycategory':'業種','jobcategory':'職種','description':'業務内容','qualifications':'応募資格'};
            const detailsHtml = Object.entries(fields).map(([k, l]) => job[k] ? `<div class="border-b py-2"><dt class="font-semibold text-slate-600">${l}</dt><dd class="text-slate-800 whitespace-pre-wrap">${job[k]}</dd></div>` : '').join('');
            const userBtns = `<button class="font-bold py-1 px-3 text-sm rounded-lg shadow-md transition-transform transform hover:scale-105 bg-cyan-500 hover:bg-cyan-600 text-white ai-match-analysis-btn" data-job-id="${job.job_id}">✨ AIマッチ度分析</button><button class="font-bold py-1 px-3 text-sm rounded-lg shadow-md transition-transform transform hover:scale-105 bg-indigo-600 hover:bg-indigo-700 text-white job-apply-btn" data-job-id="${job.job_id}">この求人に応募する</button>`;
            const managerBtn = `<button class="font-bold py-1 px-3 text-sm rounded-lg shadow-md transition-transform transform hover:scale-105 bg-indigo-600 hover:bg-indigo-700 text-white job-recommend-btn" data-job-id="${job.job_id}">この求人を紹介する</button>`;
            const finalContent = `<dl>${detailsHtml}</dl><div class="mt-6 pt-4 border-t text-right space-x-2">${CURRENT_USER.role==='user' ? userBtns : (['admin','coach'].includes(CURRENT_USER.role)?managerBtn:'')}</div>`;
            $('#modal-content').html(finalContent); 
        }

        // ========================
        // Event Listeners Setup
        // ========================
        function initializeEvents() {
            $(document).off();

            // --- Auth ---
            $(document).on('submit', '#login-form', async e => { e.preventDefault(); $('#login-error').text(''); try { const user = await api.call('login', [$('#email').val(), $('#password').val()]); CURRENT_USER = user; sessionStorage.setItem('jobAppUser', JSON.stringify(user)); main(); } catch (err) { $('#login-error').text(err.toString()); } });
            $(document).on('submit', '#register-form', async e => { e.preventDefault(); try { await api.call('registerUser', [$('#register-name').val(), $('#register-email').val(), $('#register-password').val()]); ui.showAlert('登録完了', '登録が完了しました。ログインしてください。'); ui.switchAuthForm('login'); } catch (err) { ui.showAlert('登録失敗', `登録に失敗: ${err}`); }});
            $(document).on('submit', '#reset-form', async e => { e.preventDefault(); try { const res = await api.call('sendPasswordResetLink', [$('#reset-email').val()]); ui.showAlert('送信完了', res.message); ui.switchAuthForm('login'); } catch(err) { ui.showAlert('処理失敗', `処理に失敗: ${err}`); }});
            $(document).on('click', '.auth-link', function(e) { e.preventDefault(); ui.switchAuthForm($(this).data('form')); });
            $(document).on('click', '#logout-btn', () => { sessionStorage.removeItem('jobAppUser'); CURRENT_USER = null; location.reload(); });
            $(document).on('submit', '#reset-password-form', async function(e) { e.preventDefault(); $('#reset-password-error').text(''); const newPass = $('#new-password').val(); if (newPass.length<6 || newPass!==$('#confirm-password').val()){ $('#reset-password-error').text('パスワードが6文字未満か、一致しません。'); return; } try { const res = await api.call('resetPassword', [$('#reset-token-input').val(), newPass]); ui.showAlert('更新完了', res.message); setTimeout(()=>window.location.href = window.location.pathname, 2000); } catch (err) { $('#reset-password-error').text(err.toString()); } });

            // --- Navigation & Modal ---
            $(document).on('click', '.sidebar-link', function(e) { e.preventDefault(); ui.navigateTo($(this).data('page')); });
            $(document).on('click', '#modal-close-btn, #modal-ok-btn', ui.hideModal);
            $(document).on('click', '#recommendation-user-search', function() { const term=$(this).val().toLowerCase(); $('#recommendations-table-body .recommendation-row').each(function(){$(this).toggle(($(this).data('user-name')||'').toLowerCase().includes(term));});});

            // --- Job Search ---
            $(document).on('click', '#job-search-btn', performSearch);
            $(document).on('click', '#job-search-reset-btn', () => { $('#search-keyword').val(''); $('#salary-range').val(0); $('#salary-value').text('指定なし'); activeSearchTags=[]; selectedIndustries=[]; selectedJobTypes=[]; selectedEmploymentTypes=[]; selectedLocations=[]; searchFreewords=[]; $('.tag-badge').removeClass('bg-indigo-600 text-white'); setTimeout(()=>{multiSelect.create('industry-multi-select',MASTERS.industry||[],[],v=>selectedIndustries=v); multiSelect.create('job-type-multi-select',MASTERS.job_type||[],[],v=>selectedJobTypes=v); multiSelect.create('employment-type-multi-select',EMPLOYMENT_TYPES,[],v=>selectedEmploymentTypes=v); multiSelect.create('location-multi-select',PREFECTURES,[],v=>selectedLocations=v); freewordInput.create('search-freeword-input',[],w=>searchFreewords=w);},100); performSearch(); });
            $(document).on('click', '#apply-desired-conditions-btn', async () => { if(!CURRENT_USER) return; selectedIndustries = CURRENT_USER.desired_industry?.split(',').map(s=>s.trim()).filter(Boolean) || []; selectedJobTypes = CURRENT_USER.desired_job_type?.split(',').map(s=>s.trim()).filter(Boolean) || []; selectedEmploymentTypes = CURRENT_USER.desired_employment_type?.split(',').map(s=>s.trim()).filter(Boolean) || []; selectedLocations = CURRENT_USER.desired_location?.split(',').map(s=>s.trim()).filter(Boolean) || []; searchFreewords = CURRENT_USER.desired_freewords?.split(',').map(s=>s.trim()).filter(Boolean) || []; const salary = parseInt(CURRENT_USER.desired_salary,10); if(!isNaN(salary) && salary>0){$('#salary-range').val(salary);$('#salary-value').text(`${salary}万円以上`);} setTimeout(()=>{multiSelect.create('industry-multi-select',MASTERS.industry||[],selectedIndustries,v=>selectedIndustries=v); multiSelect.create('job-type-multi-select',MASTERS.job_type||[],selectedJobTypes,v=>selectedJobTypes=v); multiSelect.create('employment-type-multi-select',EMPLOYMENT_TYPES,selectedEmploymentTypes,v=>selectedEmploymentTypes=v); multiSelect.create('location-multi-select',PREFECTURES,selectedLocations,v=>selectedLocations=v); freewordInput.create('search-freeword-input',searchFreewords,w=>searchFreewords=w);},100); ui.showAlert('適用完了', '希望条件を検索フィルターに適用しました。'); performSearch(); });
            $(document).on('input', '#salary-range', function() { const v=$(this).val(); $('#salary-value').text(v>0?`${v}万円以上`:'指定なし'); });
            $(document).on('click', '.tag-badge', function() { $(this).toggleClass('bg-indigo-600 text-white'); activeSearchTags = $('.tag-badge.bg-indigo-600').map((i,el)=>$(el).text()).get(); });
            $(document).on('click', '#load-more-btn', () => { currentJobPage++; displayJobs(); });
            $(document).on('click', '.favorite-btn', async function() { const btn=$(this), id=btn.data('job-id'); try { const res=await api.call('toggleFavoriteJob',[id]); if(res.favorited){btn.addClass('text-yellow-400').find('i').removeClass('far').addClass('fas'); FAVORITE_JOB_IDS.push(id);}else{btn.removeClass('text-yellow-400').find('i').removeClass('fas').addClass('far'); FAVORITE_JOB_IDS=FAVORITE_JOB_IDS.filter(i=>i!==id);}}catch(e){ui.showAlert('エラー',`お気に入り操作失敗: ${e}`);}});

            // --- Job Details & Application ---
            $(document).on('click', '.job-details-btn', function() { showJobDetailsModal($(this).data('job-id')); });
            $(document).on('click', '.job-apply-btn', function() { const id=$(this).data('job-id'); let inputs=''; for(let i=1;i<=3;i++){inputs+=`<div class="mb-2"><label class="block text-sm">希望日時${i}</label><input type="datetime-local" class="mt-1 block w-full px-3 py-2 border rounded-md text-sm interview-date"></div>`;} ui.showModal('応募の確認', `<form id="apply-form" data-job-id="${id}"><p class="mb-4">この求人に応募します。面接の希望日時を3つまで入力してください。</p>${inputs}<div class="mt-6 text-right"><button type="submit" class="font-bold py-2 px-4 rounded-lg shadow-md bg-indigo-600 text-white">応募を確定</button></div></form>`); });
            $(document).on('submit', '#apply-form', async function(e) { e.preventDefault(); const id=$(this).data('job-id'), dates=$('.interview-date').map((i,el)=>$(el).val()).get().filter(Boolean); try { await api.call('applyForJob',[id,dates]); ui.hideModal(); ui.showAlert('応募完了', '応募が完了しました。'); ui.navigateTo('progress'); } catch(e) { ui.showAlert('エラー', `応募失敗: ${e}`); }});
            $(document).on('click', '.job-recommend-btn', async function() { const id=$(this).data('job-id'); try { const users=await api.call('getAllUsers'); const opts=users.filter(u=>u.role==='user').map(u=>`<option value="${u.user_id}">${u.name}</option>`).join(''); ui.showModal('求人を紹介', `<form id="recommend-form" data-job-id="${id}"><p class="mb-4">紹介する求職者を選択してください。</p><div><label class="block text-sm">求職者</label><select name="targetUserId" class="mt-1 block w-full px-3 py-2 border rounded-md text-sm">${opts}</select></div><div class="mt-6 text-right"><button type="submit" class="font-bold py-2 px-4 rounded-lg shadow-md bg-indigo-600 text-white">紹介する</button></div></form>`); } catch(e) { ui.showAlert('エラー', `ユーザー読込失敗: ${e}`); }});
            $(document).on('submit', '#recommend-form', async function(e) { e.preventDefault(); const id=$(this).data('job-id'), targetId=$(this).find('[name=targetUserId]').val(); try { const res=await api.call('recommendJobToUser',[targetId,id]); ui.hideModal(); ui.showAlert('成功', res.message); } catch(e) { ui.showAlert('エラー', `紹介失敗: ${e}`); }});

            // --- Dashboard ---
            $(document).on('click', '.recommendation-feedback-btn', async function() { const btn=$(this), id=btn.data('rec-id'), action=btn.data('action'), jobId=btn.data('job-id'); if(action==='view'){showJobDetailsModal(jobId);}else{try{await api.call('updateRecommendationStatus',[id,action]); btn.closest('.recommendation-card').fadeOut(300,function(){$(this).remove();if($('#recommendations-container').children().length===0){$('#recommendations-container').html('<p class="text-slate-600">現在、おすすめの求人はありません。</p>');}}); } catch(e){ui.showAlert('エラー',`操作失敗: ${e}`);}}});

            // --- Progress Management ---
            $(document).on('click', '#progress-page .filter-btn', function() { const f=$(this).data('filter'); $('#progress-page .filter-btn').removeClass('bg-indigo-600').addClass('bg-slate-500'); $(this).addClass('bg-indigo-600').removeClass('bg-slate-500'); if(f==='all') $('#progress-table-body tr').show(); else {$('#progress-table-body tr').hide();$(`#progress-table-body tr[data-status-group="${f}"]`).show();}});
            $(document).on('click', '#progress-page .edit-status-btn', function() { const id=$(this).data('id'), app=ALL_APPLICATIONS.find(a=>a.application_id===id); if(!app)return; const opts=(MASTERS.application_status||[]).map(s=>`<option value="${s}" ${s===app.status?'selected':''}>${s}</option>`).join(''); ui.showModal('ステータス更新', `<form id="update-status-form" data-id="${id}"><p class="mb-4">ID: ${id} のステータスを更新します。</p><div><label class="block text-sm">新しいステータス</label><select id="new-status" class="mt-1 block w-full px-3 py-2 border rounded-md">${opts}</select></div><div class="mt-4"><label class="block text-sm">メモ</label><textarea id="new-memo" class="mt-1 block w-full px-3 py-2 border rounded-md" rows="4">${app.memo||''}</textarea></div><div class="mt-6 text-right"><button type="submit" class="font-bold py-2 px-4 rounded-lg bg-indigo-600 text-white">更新</button></div></form>`); });
            $(document).on('submit', '#update-status-form', async function(e) { e.preventDefault(); const id=$(this).data('id'), status=$('#new-status').val(), memo=$('#new-memo').val(); try { await api.call('updateApplicationStatus',[id,status,memo]); ui.hideModal(); ui.showAlert('更新完了', 'ステータスを更新しました。'); renderProgress(); } catch(e) { ui.showAlert('エラー',`更新失敗: ${e}`); }});
            $(document).on('click', '#progress-page .details-btn', function() { const id=$(this).data('id'), app=ALL_APPLICATIONS.find(a=>a.application_id===id); if(!app)return; ui.showModal('応募詳細', `<div class="space-y-3"><p><strong>応募者:</strong> ${app.user_name}</p><p><strong>企業名:</strong> ${app.company_name}</p><p><strong>求人名:</strong> ${app.job_title}</p><p><strong>ステータス:</strong> ${app.status}</p><p><strong>面接希望日時:</strong></p><div class="pl-4">${(app.interview_dates||'').split(',').join('<br>')||'未設定'}</div><p><strong>メモ:</strong></p><div class="pl-4 whitespace-pre-wrap bg-slate-50 p-2 rounded-md">${app.memo||'未設定'}</div></div>`, {size:'max-w-2xl'}); });

            // --- MyPage ---
            $(document).on('submit', '#profile-form', async function(e) { e.preventDefault(); const data={}; $(this).serializeArray().forEach(item=>data[item.name]=item.value); data.desired_industry=desiredIndustries.join(','); data.desired_job_type=desiredJobTypes.join(','); data.desired_employment_type=desiredEmploymentTypes.join(','); data.desired_location=desiredLocations.join(','); data.desired_freewords=desiredFreewords.join(','); try { const {message,user}=await api.call('updateMyProfile',[data]); CURRENT_USER=user; sessionStorage.setItem('jobAppUser',JSON.stringify(user)); ui.showAlert('更新完了', message); renderMyPage(); } catch (e) { ui.showAlert('エラー',`更新失敗: ${e}`); }});

            // --- User Management ---
            $(document).on('input', '#user-search-input', function() { const term=$(this).val().toLowerCase(); $('#user-list-body tr').each(function(){$(this).toggle($(this).text().toLowerCase().includes(term));});});
            $(document).on('click', '#show-new-user-modal-btn, .edit-user-btn', async function() { try { if (!MASTERS.industry) { const {masters}=await api.call('getJobsAndMasters'); MASTERS={...MASTERS,...masters};} const id=$(this).data('user-id'), isEdit=!!id, user=isEdit?ALL_USERS.find(u=>u.user_id===id):{}; const coaches=ALL_USERS.filter(u=>u.role==='coach'&&u.user_id!==id); const coachOpts=coaches.map(c=>`<option value="${c.user_id}" ${c.user_id===user.coach_id?'selected':''}>${c.name}</option>`).join(''); if(isEdit){editedDesiredIndustries=user.desired_industry?.split(',').map(s=>s.trim()).filter(Boolean)||[]; editedDesiredJobTypes=user.desired_job_type?.split(',').map(s=>s.trim()).filter(Boolean)||[]; editedDesiredEmploymentTypes=user.desired_employment_type?.split(',').map(s=>s.trim()).filter(Boolean)||[]; editedDesiredLocations=user.desired_location?.split(',').map(s=>s.trim()).filter(Boolean)||[]; editedDesiredFreewords=user.desired_freewords?.split(',').map(s=>s.trim()).filter(Boolean)||[];}else{editedDesiredIndustries=[]; editedDesiredJobTypes=[]; editedDesiredEmploymentTypes=[]; editedDesiredLocations=[]; editedDesiredFreewords=[];} const content=`<form id="user-form"><input type="hidden" name="user_id" value="${user.user_id||''}"><div class="space-y-4">...</div><div class="mt-6 text-right"><button type="submit" class="font-bold py-2 px-4 rounded-lg bg-indigo-600 text-white">${isEdit?'更新':'登録'}</button></div></form>`; ui.showModal(isEdit?'ユーザー編集':'新規登録', content, {size:'max-w-3xl'}); multiSelect.create('edit-user-desired-industry',MASTERS.industry||[],editedDesiredIndustries,v=>editedDesiredIndustries=v); multiSelect.create('edit-user-desired-job-type',MASTERS.job_type||[],editedDesiredJobTypes,v=>editedDesiredJobTypes=v); multiSelect.create('edit-user-desired-employment-type',EMPLOYMENT_TYPES,editedDesiredEmploymentTypes,v=>editedDesiredEmploymentTypes=v); multiSelect.create('edit-user-desired-location',PREFECTURES,editedDesiredLocations,v=>editedDesiredLocations=v); freewordInput.create('edit-user-desired-freewords',editedDesiredFreewords,w=>editedDesiredFreewords=w); } catch(e){ui.showAlert('エラー',`編集画面準備失敗: ${e}`);}});
            $(document).on('submit', '#user-form', async function(e) { e.preventDefault(); const data={}; $(this).serializeArray().forEach(item=>data[item.name]=item.value); data.desired_industry=editedDesiredIndustries.join(','); data.desired_job_type=editedDesiredJobTypes.join(','); data.desired_employment_type=editedDesiredEmploymentTypes.join(','); data.desired_location=editedDesiredLocations.join(','); data.desired_freewords=editedDesiredFreewords.join(','); try { const action=data.user_id?'adminUpdateUser':'adminCreateUser'; if(!data.user_id&&!data.password){ui.showAlert('入力エラー','新規登録にはパスワード必須');return;} await api.call(action,[data]); ui.hideModal(); ui.showAlert('成功',`ユーザー情報を${data.user_id?'更新':'登録'}しました。`); renderUserManagement(); } catch(e){ui.showAlert('エラー',`処理失敗: ${e}`);}});

            // --- Job Management ---
            $(document).on('input', '#job-management-search-input', function() { const term=$(this).val().toLowerCase(); $('#job-list-body tr').each(function(){$(this).toggle($(this).text().toLowerCase().includes(term));});});
            $(document).on('click', '#job-management-page #show-new-job-modal-btn, #job-management-page .edit-job-btn', function() { const id=$(this).data('job-id'), isEdit=!!id, job=isEdit?ALL_JOBS.find(j=>j.job_id===id):{}; const industryOpts=(MASTERS.industry||[]).map(i=>`<option value="${i}" ${(job.industrycategory||job.industry)===i?'selected':''}>${i}</option>`).join(''); const jobTypeOpts=(MASTERS.job_type||[]).map(j=>`<option value="${j}" ${(job.jobcategory||job.job_type)===j?'selected':''}>${j}</option>`).join(''); const content=`<form id="job-form"><input type="hidden" name="job_id" value="${job.job_id||''}"><div class="grid grid-cols-1 md:grid-cols-2 gap-4">...</div><div class="mt-4"><div class="flex justify-between items-center"><label class="block text-sm">業務内容</label><button type="button" id="ai-generate-description-btn" class="text-sm text-indigo-600 hover:underline">✨ AIで作成</button></div><textarea name="description" class="mt-1 block w-full px-3 py-2 border rounded-md" rows="5">${job.description||''}</textarea></div>...<div class="mt-6 text-right"><button type="submit" class="font-bold py-2 px-4 rounded-lg bg-indigo-600 text-white">${isEdit?'更新':'登録'}</button></div></form>`; ui.showModal(isEdit?'求人編集':'新規登録',content,{size:'max-w-3xl'});});
            $(document).on('submit', '#job-form', async function(e) { e.preventDefault(); const data={}; $(this).serializeArray().forEach(item=>data[item.name]=item.value); try { await api.call(data.job_id?'updateJob':'createNewJob',[data]); ui.hideModal(); ui.showAlert('成功', `求人情報を${data.job_id?'更新':'登録'}しました。`); await renderJobManagement(); await renderJobSearch(); } catch(e){ui.showAlert('エラー', `処理失敗: ${e}`);}});

            // --- Gemini AI Features (Backend Call) ---
            $(document).on('click', '.ai-match-analysis-btn', async function() {
                const jobId = $(this).data('job-id');
                ui.showModal('✨ AIマッチ度分析', '<div class="text-center"><div class="spinner w-8 h-8 mx-auto"></div><p class="mt-2 text-slate-600">AIが分析中です...</p></div>', { size: 'max-w-3xl' });
                try {
                    const resultText = await api.call('generateAIMatchAnalysis', [jobId]);
                    const scoreMatch = resultText.match(/総合評価:\s*(\d+)/);
                    const scoreHtml = scoreMatch ? `<div class="bg-indigo-50 border-l-4 border-indigo-500 p-4 mb-6"><h3 class="text-sm font-medium text-indigo-700">総合評価</h3><p class="text-4xl font-bold text-indigo-600 mt-1">${scoreMatch[1]}<span class="text-lg ml-1">点</span></p></div>` : '';
                    const analysisHtml = marked.parse(resultText.replace(/総合評価:\s*\d+点\s*/, ''));
                    $('#modal-content').html(scoreHtml + `<div class="gemini-content prose prose-slate max-w-none">${analysisHtml}</div>`);
                } catch (e) { $('#modal-content').html(`<p class="text-red-500">AI分析に失敗: ${e}</p>`); }
            });
            $(document).on('click', '#ai-generate-description-btn', async function() {
                const form = $(this).closest('form'), title = form.find('[name="title"]').val(), company = form.find('[name="company"]').val();
                if (!title || !company) { ui.showAlert('情報不足', '「求人名」と「企業名」を入力してください。'); return; }
                const btn = $(this); btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>生成中...');
                try {
                    const resultText = await api.call('generateAIDescription', [title, company]);
                    form.find('[name="description"]').val(resultText);
                } catch (e) { ui.showAlert('AIエラー', `生成失敗: ${e}`); } 
                finally { btn.prop('disabled', false).html('✨ AIで作成'); }
            });
            $(document).on('click', '.ai-recommend-btn', async function() {
                const targetUserId = $(this).data('user-id'), targetUser = ALL_USERS.find(u => u.user_id === targetUserId);
                if (!targetUser) return;
                ui.showModal(`✨ ${targetUser.name}さんへのAI推薦`, '<div class="text-center"><div class="spinner w-8 h-8 mx-auto"></div><p class="mt-2 text-slate-600">AIが分析中です...</p></div>', { size: 'max-w-3xl' });
                try {
                    const scoredJobs = await api.call('getAIRecommendations', [targetUserId]);
                    if (scoredJobs.length === 0) { $('#modal-content').html('<p class="text-center py-8">推薦可能な求人は見つかりませんでした。</p>'); return; }
                    let recsHtml = `<div class="mb-4 p-3 bg-blue-50 rounded-md"><h4 class="font-medium text-blue-800">📊 分析結果</h4><p class="text-sm text-blue-600">${targetUser.name}さんの希望条件に合う求人を分析し、マッチ度順に表示しています。</p></div><form id="ai-recommend-form" data-user-id="${targetUserId}">`;
                    recsHtml += scoredJobs.map(job => `<div class="p-4 border rounded-lg mb-3"><div class="flex items-start"><input type="checkbox" name="selected_job" value="${job.job_id}" class="mt-1 h-4 w-4" data-reason="${encodeURIComponent(job.reason)}" data-score="${job.score}"><div class="ml-4 flex-1"><div class="flex justify-between items-center"><h4 class="font-bold">${job.title}</h4><span class="text-lg font-bold text-indigo-600">${job.score}点</span></div><p class="text-sm text-slate-600">${job.company}</p><p class="mt-2 text-sm text-slate-500 bg-slate-50 p-2 rounded">${job.reason}</p></div></div></div>`).join('');
                    recsHtml += `<div class="mt-6 text-right"><button type="submit" class="font-bold py-2 px-4 rounded-lg bg-indigo-600 text-white">選択した求人を推薦として保存</button></div></form>`;
                    $('#modal-content').html(recsHtml);
                } catch(e) { $('#modal-content').html(`<p class="text-red-500">AI推薦の処理中にエラーが発生: ${e}</p>`); }
            });
            $(document).on('submit', '#ai-recommend-form', async function(e) {
                e.preventDefault();
                const targetUserId = $(this).data('user-id');
                const selectedJobs = [];
                $(this).find('input:checked').each(function() { selectedJobs.push({ job_id: $(this).val(), reason: decodeURIComponent($(this).data('reason')), score: $(this).data('score') }); });
                if (selectedJobs.length === 0) { ui.showAlert('選択エラー', '推薦する求人を1つ以上選択してください。'); return; }
                try {
                    const result = await api.call('saveAIRecommendations', [targetUserId, selectedJobs]);
                    ui.hideModal(); ui.showAlert('保存完了', result.message);
                } catch(e) { ui.showAlert('保存エラー', `推薦の保存に失敗: ${e}`); }
            });
        }
        
        // --- Initializer ---
        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const resetToken = urlParams.get('resetToken');
            if (resetToken) {
                $('#auth-container, #app-container').hide();
                $('#reset-password-container').show();
                $('#reset-token-input').val(resetToken);
            } else {
                const userData = sessionStorage.getItem('jobAppUser');
                if (userData) {
                    try { CURRENT_USER = JSON.parse(userData); main(); } 
                    catch (e) { sessionStorage.removeItem('jobAppUser'); $('#auth-container').show(); }
                } else {
                    $('#auth-container').show();
                }
            }
            initializeEvents();
        }
        $(document).ready(init);
    })(jQuery);
    </script>
</body>
</html>
