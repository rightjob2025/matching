<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rightjob マッチング</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap');
        :root {
            --sidebar-width: 250px;
            --header-height: 64px;
        }        
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f8f9fa;
        }

        .spinner {
            border-top-color: #4f46e5;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }
        /* On desktop, sidebar is visible and pushes content */

        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0);
            }
            .main-content {
                margin-left: var(--sidebar-width);
            }
        }

        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }

        input[type=range]:focus {
            outline: none;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.2);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #ddd;
            border-radius: 5px;
        }

        .gemini-content>*:first-child {
            margin-top: 0;
        }

        .prose {
            max-width: none;
        }
        /* Ensure prose styles don't constrain width */

        .multi-select-container {
            position: relative;
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 50;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .multi-select-option {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
        }

        .multi-select-option:hover {
            background-color: #f9fafb;
        }

        .multi-select-option.selected {
            background-color: #eff6ff;
            color: #1d4ed8;
        }

        .selection-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }

        .selection-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background-color: #e0e7ff;
            color: #3730a3;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .selection-tag .remove-tag {
            cursor: pointer;
            color: #6366f1;
            font-weight: bold;
        }

        .selection-tag .remove-tag:hover {
            color: #4338ca;
        }

        .freeword-input {
            position: relative;
        }

        .freeword-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
            min-height: 24px;
        }

        .freeword-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background-color: #fef3c7;
            color: #92400e;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .freeword-tag .remove-tag {
            cursor: pointer;
            color: #d97706;
            font-weight: bold;
        }

        .freeword-tag .remove-tag:hover {
            color: #b45309;
        }

        /* Diagnosis Page Styles */
        .result-content { max-width: 800px; margin: 0 auto; padding: 20px; }
        .strength-ranking-header, .job-recommendation-header { text-align: center; margin-bottom: 24px; }
        .strength-ranking-crown, .job-recommendation-icon { width: 60px; margin: 0 auto 16px; }
        .strength-ranking-title, .job-recommendation-title { font-size: 24px; font-weight: bold; color: #333; }
        .strength-ranking-subtitle, .job-recommendation-subtitle { font-size: 14px; color: #666; line-height: 1.6; margin-top: 8px; }
        .result-card { background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 40px; }
        .result-card-content { padding: 16px; }
        .items-container .item { border-bottom: 1px solid #eee; padding: 16px 8px; }
        .items-container .item:last-child { border-bottom: none; }
        .skill-header-wrapper { display: flex; align-items: center; }
        .rank-badge { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; flex-shrink: 0; margin-right: 12px; }
        .rank-badge.gold { background-color: #ffd700; }
        .rank-badge.silver { background-color: #c0c0c0; }
        .rank-badge.bronze { background-color: #cd7f32; }
        .rank-badge.blue { background-color: #4a90e2; }
        .rank-badge img { width: 100%; height: 100%; }
        .skill-content { flex-grow: 1; }
        .skill-title { font-weight: bold; color: #333; }
        .skill-description { font-size: 13px; color: #777; margin-top: 4px; }

        /* Job recommendation styles */
        .job-container { border: 1px solid #ddd; border-radius: 12px; padding: 24px; margin-bottom: 24px; }
        .job-container.job-engineer { border-color: #4a90e2; }
        .job-container.job-designer { border-color: #d0021b; }
        .job-container.job-marketer { border-color: #f5a623; }
        .job-rank-image { text-align: center; margin-bottom: 16px; }
        .job-rank-no-image { width: 100px; }
        .job-rank-badge { text-align: center; padding: 4px 0; border-radius: 20px; color: white; font-size: 12px; margin: 0 auto 16px; max-width: 250px; }
        .job-rank-badge.badge-engineer { background: #4a90e2; }
        .job-rank-badge.badge-designer { background: #d0021b; }
        .job-rank-badge.badge-marketer { background: #f5a623; }
        .job-name { font-size: 28px; font-weight: bold; text-align: center; margin-bottom: 24px; }
        .job-section { margin-top: 24px; }
        .job-section-title { font-weight: bold; margin-bottom: 8px; border-left: 4px solid #4a90e2; padding-left: 8px; }
        .job-description-text, .job-career-path-text { font-size: 14px; line-height: 1.8; }
        .job-skills-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .job-skill-tag { background: #eef5ff; color: #4a90e2; padding: 4px 12px; border-radius: 16px; font-size: 12px; }
        .job-career-path .job-section-title { border-left-color: #50e3c2; }
         /* 「おすすめ一覧」の一括操作バー（batchActionHtml）内の「メール送信」ボタンのみ非表示にする */
         div.mr-auto + #send-recommendation-email-btn { display: none !important; }
</style>

    </style>

</head>

<body>
    <div id="auth-container" class="min-h-screen bg-slate-100 flex items-center justify-center p-4 relative">
        <div class="w-full max-w-md">
            <div class="text-center mb-8">
                <img src="https://i.imgur.com/CnpEc9o.png" alt="Rightjob Logo" class="h-12 w-auto mx-auto">
                <h1 class="mt-4 text-3xl font-bold text-slate-800"></h1>
            </div>
            <div id="login-form-container" class="bg-white p-8 rounded-2xl shadow-lg">
                <form id="login-form" class="space-y-6">
                    <h2 class="text-xl font-bold text-center text-slate-700">ログイン</h2>
                    <div><label for="email" class="block text-sm font-medium text-slate-700">メールアドレス</label><input id="email" name="email" type="email" autocomplete="email" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"></div>
                    <div><label for="password" class="block text-sm font-medium text-slate-700">パスワード</label><input id="password" name="password" type="password" autocomplete="current-password" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"></div>
                    <div><button type="submit" class="w-full font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed bg-indigo-600 hover:bg-indigo-700 text-white mt-2"><i class="fas fa-sign-in-alt mr-2"></i>ログイン</button></div>
                </form>
                <div id="login-error" class="mt-4 text-center text-sm text-red-600 font-medium"></div>
                <div class="mt-4 text-sm text-center">
                    <a href="#" data-form="register" class="auth-link font-medium text-indigo-600 hover:text-indigo-500">アカウントを開設する</a>
                    <span class="mx-2 text-slate-300">|</span>
                    <a href="#" data-form="reset" class="auth-link font-medium text-indigo-600 hover:text-indigo-500">パスワードをお忘れですか？</a>
                </div>
            </div>
            <div id="register-form-container" class="hidden bg-white p-8 rounded-2xl shadow-lg">
                <form id="register-form" class="space-y-4">
                    <h2 class="text-xl font-bold text-center text-slate-700">新規登録</h2>
                    <div><label for="register-name" class="block text-sm font-medium text-slate-700">氏名</label><input id="register-name" type="text" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"></div>
                    <div><label for="register-email" class="block text-sm font-medium text-slate-700">メールアドレス</label><input id="register-email" type="email" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"></div>
                    <div><label for="register-password" class="block text-sm font-medium text-slate-700">パスワード</label><input id="register-password" type="password" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"></div>
                    <div><button type="submit" class="w-full font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed bg-indigo-600 hover:bg-indigo-700 text-white mt-2">登録</button></div>
                </form>
                <div class="mt-4 text-sm text-center"><a href="#" data-form="login" class="auth-link font-medium text-indigo-600 hover:text-indigo-500">既にアカウントをお持ちですか？</a></div>
            </div>
            <div id="reset-form-container" class="hidden bg-white p-8 rounded-2xl shadow-lg">
                <form id="reset-form" class="space-y-4">
                    <h2 class="text-xl font-bold text-center text-slate-700">パスワードリセット</h2>
                    <p class="text-sm text-slate-600">登録したメールアドレスを入力してください。パスワード再設定用のリンクを送信します。</p>
                    <div><label for="reset-email" class="block text-sm font-medium text-slate-700">メールアドレス</label><input id="reset-email" type="email" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"></div>
                    <div><button type="submit" class="w-full font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed bg-indigo-600 hover:bg-indigo-700 text-white mt-2">送信</button></div>
                </form>
                <div class="mt-4 text-sm text-center"><a href="#" data-form="login" class="auth-link font-medium text-indigo-600 hover:text-indigo-500">ログイン画面に戻る</a></div>
            </div>
        </div>

        <footer class="absolute bottom-0 left-0 w-full bg-slate-800 text-slate-300 p-4">
            <div class="container mx-auto max-w-6xl px-4">
                <div class="flex flex-col sm:flex-row justify-between items-center text-center sm:text-left">
                    <div class="mt-2 sm:mt-0 flex flex-col sm:flex-row sm:gap-4"> <a href="https://rightjob.info/one-record-company/" target="_blank" rel="noopener noreferrer" class="text-xs hover:text-white hover:underline">
                            運営会社
                        </a>
                        <a href="https://rightjob.info/right-job-agent-privacy/" target="_blank" rel="noopener noreferrer" class="text-xs hover:text-white hover:underline mt-1 sm:mt-0">
                            プライバシーポリシー
                        </a>
                        <a href="https://rightjob.info/right-job-agent-terms/" target="_blank" rel="noopener noreferrer" class="text-xs hover:text-white hover:underline mt-1 sm:mt-0">
                            利用規約
                        </a>
                        </div>
                </div>
            </div>
        </footer>
    </div>

    <div id="reset-password-container" class="hidden min-h-screen bg-slate-100 flex items-center justify-center p-4 relative">
        <div class="w-full max-w-md">
            <div class="text-center mb-8">
                <i class="fas fa-key text-5xl text-indigo-600"></i>
                <h1 class="mt-4 text-3xl font-bold text-slate-800">新しいパスワードの設定</h1>
            </div>
            <div class="bg-white p-8 rounded-2xl shadow-lg">
                <form id="reset-password-form" class="space-y-4">
                    <p class="text-sm text-slate-600">新しいパスワードを入力してください。</p>
                    <input type="hidden" id="reset-token-input">
                    <div><label for="new-password" class="block text-sm font-medium text-slate-700">新しいパスワード</label><input id="new-password" type="password" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm"></div>
                    <div><label for="confirm-password" class="block text-sm font-medium text-slate-700">新しいパスワード（確認）</label><input id="confirm-password" type="password" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm"></div>
                    <div><button type="submit" class="w-full font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 bg-indigo-600 hover:bg-indigo-700 text-white mt-2">パスワードを更新</button></div>
                </form>
                <div id="reset-password-error" class="mt-4 text-center text-sm text-red-600 font-medium"></div>
            </div>
        </div>

        <footer class="absolute bottom-0 left-0 w-full bg-slate-800 text-slate-300 p-4">
            <div class="container mx-auto max-w-6xl px-4">
                <div class="flex flex-col sm:flex-row justify-between items-center text-center sm:text-left">
                    <div class="mt-2 sm:mt-0 flex flex-col sm:flex-row sm:gap-4"> <a href="https://rightjob.info/one-record-company/" target="_blank" rel="noopener noreferrer" class="text-xs hover:text-white hover:underline">
                            運営会社
                        </a>
                        <a href="https://rightjob.info/right-job-agent-privacy/" target="_blank" rel="noopener noreferrer" class="text-xs hover:text-white hover:underline mt-1 sm:mt-0">
                            プライバシーポリシー
                        </a>
                        <a href="https://rightjob.info/right-job-agent-terms/" target="_blank" rel="noopener noreferrer" class="text-xs hover:text-white hover:underline mt-1 sm:mt-0">
                            利用規約
                        </a>
                        </div>
                </div>
            </div>
        </footer>
    </div>

    <div id="app-container" class="hidden">
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
        <aside id="sidebar" class="w-[var(--sidebar-width)] bg-slate-800 text-white h-screen fixed top-0 left-0 flex flex-col p-4 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out z-40">
            <div class="text-center py-4 border-b border-slate-700">
                <img src="https://i.imgur.com/CnpEc9o.png" alt="Rightjob Logo" class="h-8 w-auto mx-auto">
            </div>
            <nav id="nav-menu" class="mt-8 flex-grow space-y-2"></nav>
            <div class="mt-auto"><button id="logout-btn" class="w-full font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 bg-slate-700 hover:bg-red-600 text-white"><i class="fas fa-sign-out-alt mr-2"></i>ログアウト</button></div>
        </aside>

        <div class="main-content md:ml-[var(--sidebar-width)] min-h-screen flex flex-col">
            <header class="bg-white h-[var(--header-height)] flex items-center justify-between md:justify-end px-4 md:px-8 border-b fixed top-0 right-0 w-full md:w-[calc(100%_-_var(--sidebar-width))] z-20">
                <div class="flex items-center">
                    <button id="menu-toggle-btn" class="md:hidden text-2xl text-slate-600">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h2 id="mobile-page-title" class="md:hidden text-lg font-bold text-slate-800 ml-4">ホーム</h2>
                </div>
                <div id="user-info" class="flex items-center">
                    <i class="fas fa-user-circle text-2xl text-slate-500 mr-3"></i>
                    <span id="user-name-display" class="text-slate-700 font-medium hidden sm:block"></span>
                </div>
            </header>

            <main id="page-content" class="p-4 md:p-8 mt-[var(--header-height)] flex-grow">
                <div id="dashboard-page" class="page"></div>
                <div id="job-search-page" class="page"></div>
                <div id="recommendations-list-page" class="page"></div>
                <div id="progress-page" class="page"></div>
                <div id="mypage-page" class="page"></div>
                <div id="diagnosis-page" class="page"></div>
                <div id="user-management-page" class="page"></div>
                <div id="job-management-page" class="page"></div>
                <div id="login-history-page" class="page"></div>
                <div id="contact-page" class="page"></div>
            </main>

            <footer class="bg-slate-800 text-slate-300 p-8">
                <div class="container mx-auto max-w-6xl">
                    <div class="flex flex-col md:flex-row justify-between items-center">
                        <div class="text-center md:text-left mb-4 md:mb-0">
                            <p class="text-sm">&copy; Copyright 2025 Right job.inc All right reserved.</p>
                        </div>
                        <div class="text-center md:text-right flex flex-col md:flex-row md:gap-4"> <a href="https://rightjob.info/one-record-company/" target="_blank" rel="noopener noreferrer" class="text-sm hover:text-white hover:underline">
                            運営会社
                        </a>
                        <a href="https://rightjob.info/right-job-agent-privacy/" target="_blank" rel="noopener noreferrer" class="text-sm hover:text-white hover:underline mt-1 md:mt-0">
                            プライバシーポリシー
                        </a>
                        <a href="https://rightjob.info/right-job-agent-terms/" target="_blank" rel="noopener noreferrer" class="text-sm hover:text-white hover:underline mt-1 md:mt-0">
                            利用規約
                        </a>
                        </div>
                </div>
                </div>
            </footer>
        </div>
    </div>

    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div id="modal-dialog" class="bg-white rounded-xl shadow-2xl w-full max-w-lg transition-all duration-300">
            <div id="modal-header" class="p-4 border-b flex justify-between items-center">
                <h3 id="modal-title" class="text-xl font-bold text-slate-800"></h3>
                <button id="modal-close-btn" class="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            </div>
            <div id="modal-content" class="p-6 max-h-[70vh] overflow-y-auto"></div>
            <div id="modal-footer" class="p-4 bg-slate-50 rounded-b-xl text-right">
                <button id="modal-ok-btn" class="font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 bg-indigo-600 hover:bg-indigo-700 text-white">OK</button>
            </div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/alpinejs@3.13.10/dist/cdn.min.js" defer></script>
    <script>
        (($) => {
            'use strict';
            // ========================
            // Master Data & State
            // ========================
            const PREFECTURES = ['北海道', '青森県', '岩手県', '宮城県', '秋田県', '山形県', '福島県', '茨城県', '栃木県', '群馬県', '埼玉県', '千葉県', '東京都', '神奈川県', '新潟県', '富山県', '石川県', '福井県', '山梨県', '長野県', '岐阜県', '静岡県', '愛知県', '三重県', '滋賀県', '京都府', '大阪府', '兵庫県', '奈良県', '和歌山県', '鳥取県', '島根県', '岡山県', '広島県', '山口県', '徳島県', '香川県', '愛媛県', '高知県', '福岡県', '佐賀県', '長崎県', '熊本県', '大分県', '宮崎県', '鹿児島県', '沖縄県'];
            const EMPLOYMENT_TYPES = ['正社員', '契約社員', 'アルバイト・パート', '派遣社員', '業務委託', 'インターン', '嘱託社員', '臨時職員', 'フリーランス'];

            const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxTzuGJkSyOKTKIZUBE-6NSomhovtaSgBoE5-b9i_198JQmuqaSVrBNOTnNgyCbSXqb/exec";
            // https://script.google.com/macros/s/AKfycbz1E3BKqoz7numuXPcI3bbvm2qcWvFHd3NWjrg2SbzXXTWEjJphpYpVsMCTQIYU0PDA/exec

            const skillDetails = {
                '課題解決力': { iconClass: 'problem', description: '見つけた課題に対して、適切な解決策を提示できる力' },
                'データ分析力': { iconClass: 'data', description: 'データや情報を正しく読み解き、意味合いや傾向を導き出す力' },
                '仮説設計力': { iconClass: 'hypothesis', description: '断片的な情報から「こうではないか」という仮説を立て、検証プロセスを組み立てる力' },
                '顧客理解力': { iconClass: 'customer', description: '顧客やユーザーの背景・思考・本質的な欲求を的確に捉え、アクションにつなげる力' },
                '構築力': { iconClass: 'building', description: '仕組みやシステム、デザインを設計・実装し、問題解決に向けたアウトプットを形にできる力' },
                '創造力': { iconClass: 'creativity', description: '新しいアイデアや独自性を生み出し、魅力的な成果物や提案を生み出す力' },
                '言語化・情報伝達力': { iconClass: 'verbalize', description: '自分の考えをわかりやすい言葉で整理し、適切に周囲へ共有する力' },
                'プレゼン力': { iconClass: 'presen', description: '伝えたい内容を効果的に構成し、相手に興味・納得を与えられるプレゼンテーションを行う力' },
                'ヒアリング力': { iconClass: 'hearing', description: '相手の要望や課題を的確に引き出し、情報を整理しながら本質をつかむ力' },
                '社交性': { iconClass: 'sociability', description: '多様な相手に対応し、初対面でもスムーズにやり取りできる力' },
                '根気強さ・継続力': { iconClass: 'perserve', description: '失敗や断念があっても粘り強く取り組み、成果に結びつけるまで行動し続ける力' },
                '慎重さ・几帳面さ': { iconClass: 'neatiness', description: 'ミスを防ぎ、正確性や細部を大切にしながら業務を進める力' },
                '誠実・公正': { iconClass: 'integrity', description: '情報や相手を正しく扱い、倫理観やコンプライアンスを守りながら公正に対応する力' },
                '自己学習力': { iconClass: 'self-learning', description: '新しい知識やスキルを主体的に身につけ、常に知見をアップデートする力' }
            };

            const jobDetails = {
                "Webエンジニア": { className: "job-engineer", badgeClass: "badge-engineer", name: "Webエンジニア", image: "https://rightjob-tenshoku-shindan.website/assets/jobs/web-engineer-27c7e0a83bc4e14c39ab58a7c1b11acb792e7fc798fefa77fcd911c6cfa04f1e.png", alt: "Webエンジニアのイラスト", description: "Webエンジニアは、開発要件を整理し、適切なアルゴリズムやデータ構造を設計することで、システムの課題解決に取り組みます。またバグやエラーを特定して修正し、パフォーマンス向上のための最適化を行うことも重要な業務です。チームや関係者への技術的な説明も担当します。常に登場する新技術を学びながら開発を行います。", skills: ["言語化・情報伝達力", "構築力", "課題解決力"], passion: "作りたい機能を謎解きゲームの感覚で自分で作る面白さがあります。その機能に反響が合ったときのやりがいは大きいです。新しい技術を学ぶほど資産になり、エンジニアとして価値が高まります。", careerPath: "未経験の場合はサーバーサイドエンジニアからスタートしたり、プログラミングスクールに通って(学習時間500時間以上)、SESや受託開発企業に転職することが多いです。" },
                "Webデザイナー": { className: "job-designer", badgeClass: "badge-designer", name: "Webデザイナー", image: "https://rightjob-tenshoku-shindan.website/assets/jobs/web-designer-69f2ea76f8da75ff4c80976a5ab31f6f06f627198d62ee6de1dc60fce09bd879.png", alt: "Webデザイナーのイラスト", description: "Webデザイナーは、お客様の要望を聞き取り、目的に合わせたWebサイトの見た目や構成を考える仕事です。具体的には、どこに何を配置すれば使いやすいかを考え、デザインの下書きを作ります。また、Figmaなどの専用ソフトを使って画面のデザインを作り、訪問者が迷わず、わかりやすく使えるサイトを目指します。見る人が魅力を感じ、使いやすいサイト作りを担当します。", skills: ["課題解決力", "構築力", "創造力"], passion: "自分の技術が形となって社会に残っていくやりがいがあります。また柔軟な働き方がしやすい良さもあります。", careerPath: "「未経験募集」だとしても、ポートフォリオは必要な場合が多いです。アルバイトや派遣から経験を積んで、正社員を目指す道もあります。" },
                "Webマーケター": { className: "job-marketer", badgeClass: "badge-marketer", name: "Webマーケター", image: "https://rightjob-tenshoku-shindan.website/assets/jobs/web-marketer-ae3e1ce8ef1b3622da5e8cb300712a63c5acc50c76176808ce672e6570fc8fc2.png", alt: "Webマーケターのイラスト", description: "Webマーケターは、インターネットを活用して商品の宣伝や販売促進を行う専門家です。主な業務には、検索エンジンでの上位表示を目指すSEO対策、オンライン広告の運用、SNSの管理、ウェブサイトの分析と改善などがあります。データを分析し、顧客の行動や市場の動向を理解し、効果的な戦略を立てることが求められます。", skills: ["顧客理解力", "仮説設計力", "データ分析力"], passion: "仮説を立てて立証する、パズルを解くゲーム的面白さとサービスやプロダクトを広めることで社会を良くできるやりがいがあります。", careerPath: "広告代理店やメディア事業会社等で経験を積み、そのままポジションアップしたり事業会社にマーケティング部に転職するパターンが多くなっています。" },
            };

            let CURRENT_USER = null,
                ALL_JOBS = [],
                FILTERED_JOBS = [],
                ALL_USERS = [],
                MASTERS = {},
                ALL_APPLICATIONS = [],
                FAVORITE_JOB_IDS = [],
                ALL_RECOMMENDATIONS = [];
            let currentJobPage = 1;
            const JOBS_PER_PAGE = 12;

            let activeSearchTags = [],
                selectedIndustries = [],
                selectedJobTypes = [],
                selectedEmploymentTypes = [],
                selectedLocations = [],
                searchFreewords = [];
            let desiredIndustries = [],
                desiredJobTypes = [],
                desiredEmploymentTypes = [],
                desiredLocations = [],
                desiredFreewords = [];
            let editedDesiredIndustries = [],
                editedDesiredJobTypes = [],
                editedDesiredEmploymentTypes = [],
                editedDesiredLocations = [],
                editedDesiredFreewords = [];

            let isFavoritesOnlySearch = false;

            const pagePermissions = {
                'user': ['dashboard', 'job-search', 'progress', 'mypage', 'recommendations-list', 'diagnosis', 'contact'], // ← 追加
                'coach': ['dashboard', 'job-search', 'progress', 'mypage', 'user-management', 'recommendations-list', 'diagnosis', 'contact'], // ← 追加
                'admin': ['dashboard', 'job-search', 'progress', 'mypage', 'user-management', 'job-management', 'recommendations-list', 'login-history', 'diagnosis', 'contact'] // ← 追加
            };
            // ========================
            // API Handler
            // ========================
            const api = {
                call: function(action, params = []) {
                    ui.showSpinner();
                    const userPayload = CURRENT_USER ? { ...CURRENT_USER
                    } : {};
                    delete userPayload.password_hash;
                    const bodyPayload = {
                        action,
                        params,
                        user: userPayload
                    };
                    return fetch(GAS_WEB_APP_URL, {
                            method: 'POST',
                            mode: 'cors',
                            cache: 'no-cache',
                            headers: {
                                'Content-Type': 'text/plain;charset=utf-8'
                            },
                            body: JSON.stringify(bodyPayload),
                            redirect: 'follow'
                        })
                        .then(response => response.ok ? response.text() : Promise.reject(`サーバーエラー: ${response.status}`))
                        .then(text => {
                            try {
                                return JSON.parse(text);
                            } catch (e) {
                                console.error("JSON Parse Error:", text);
                                return Promise.reject('サーバーからの応答が不正です。');
                            }
                        })
                        .then(result => (result.status === 'success') ? result.data : Promise.reject(result.message || 'APIエラー'))
                        .catch(error => {
                            console.error('API Call Failed:', action, error);
                            ui.showAlert('APIエラー', `エラーが発生しました。時間をおいて再度お試しください。: ${error.message || error}`);
                            throw error;
                        })
                        .finally(ui.hideSpinner);
                }
            };

            // ========================
            // UI Components
            // ========================
            const multiSelect = {
                create: function(containerId, options, selectedValues, onSelectionChange) {
                    const container = $(`#${containerId}`);
                    if (!container.length) return;
                    container.empty();
                    const wrapper = $(`<div class="multi-select-container"><button type="button" class="multi-select-trigger mt-1 block w-full text-left px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"><span class="selected-count"></span><i class="fas fa-chevron-down float-right mt-0.5"></i></button><div class="multi-select-dropdown hidden"></div><div class="selection-tags"></div></div>`);
                    const dropdown = wrapper.find('.multi-select-dropdown');
                    const tagsContainer = wrapper.find('.selection-tags');

                    function updateDisplay() {
                        wrapper.find('.selected-count').text(selectedValues.length > 0 ? `${selectedValues.length}件選択済み` : '選択してください');
                        tagsContainer.empty();
                        selectedValues.forEach(value => tagsContainer.append(`<span class="selection-tag">${value}<span class="remove-tag" data-value="${value}">×</span></span>`));
                        dropdown.empty();
                        options.forEach(option => {
                            const isSelected = selectedValues.includes(option);
                            dropdown.append(`<div class="multi-select-option ${isSelected ? 'selected' : ''}" data-value="${option}"><i class="fas ${isSelected ? 'fa-check-square' : 'fa-square'} mr-2"></i> ${option}</div>`);
                        });
                    }

                    wrapper.on('click', '.multi-select-trigger', e => {
                        e.stopPropagation();
                        $('.multi-select-dropdown').not(dropdown).addClass('hidden');
                        dropdown.toggleClass('hidden');
                    });
                    dropdown.on('click', '.multi-select-option', function(e) {
                        e.stopPropagation();
                        const value = $(this).data('value');
                        const index = selectedValues.indexOf(value);
                        if (index > -1) selectedValues.splice(index, 1);
                        else selectedValues.push(value);
                        updateDisplay();
                        if (onSelectionChange) onSelectionChange(selectedValues);
                    });
                    tagsContainer.on('click', '.remove-tag', function(e) {
                        e.stopPropagation();
                        const value = $(this).data('value');
                        const index = selectedValues.indexOf(value);
                        if (index > -1) {
                            selectedValues.splice(index, 1);
                            updateDisplay();
                            if (onSelectionChange) onSelectionChange(selectedValues);
                        }
                    });
                    $(document).on('click', () => dropdown.addClass('hidden'));

                    container.append(wrapper);
                    updateDisplay();
                }
            };

            const freewordInput = {
                create: function(containerId, freewords, onFreewordsChange) {
                    const container = $(`#${containerId}`);
                    if (!container.length) return;
                    container.empty();
                    const wrapper = $(`<div class="freeword-input"><input type="text" class="freeword-text-input mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" placeholder="フリーワードを入力してEnter"><div class="freeword-tags"></div></div>`);
                    const textInput = wrapper.find('.freeword-text-input');
                    const tagsContainer = wrapper.find('.freeword-tags');

                    function updateDisplay() {
                        tagsContainer.empty();
                        freewords.forEach(word => tagsContainer.append(`<span class="freeword-tag">${word}<span class="remove-tag" data-word="${word}">×</span></span>`));
                    }

                    textInput.on('keydown', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const value = $(this).val().trim();
                            if (value && !freewords.includes(value)) {
                                freewords.push(value);
                                $(this).val('');
                                updateDisplay();
                                if (onFreewordsChange) onFreewordsChange(freewords);
                            }
                        }
                    });
                    tagsContainer.on('click', '.remove-tag', function(e) {
                        e.stopPropagation();
                        const word = $(this).data('word');
                        const index = freewords.indexOf(word);
                        if (index > -1) {
                            freewords.splice(index, 1);
                            updateDisplay();
                            if (onFreewordsChange) onFreewordsChange(freewords);
                        }
                    });

                    container.append(wrapper);
                    updateDisplay();
                }
            };

            const ui = {
                showSpinner: () => {
                    if ($('#spinner').length === 0) $('body').append('<div id="spinner" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50"><div class="spinner w-12 h-12 border-4 rounded-full"></div></div>');
                },
                hideSpinner: () => $('#spinner').remove(),
                openSidebar: () => {
                    $('#sidebar').removeClass('-translate-x-full');
                    $('#sidebar-overlay').removeClass('hidden');
                },
                closeSidebar: () => {
                    $('#sidebar').addClass('-translate-x-full');
                    $('#sidebar-overlay').addClass('hidden');
                },
                toggleSidebar: () => {
                    $('#sidebar').toggleClass('-translate-x-full');
                    $('#sidebar-overlay').toggleClass('hidden');
                },
                navigateTo: (pageId, options = {}) => { // options を追加
                    if (!CURRENT_USER) return;
                    if (!pagePermissions[CURRENT_USER.role]?.includes(pageId)) return ui.showAlert('アクセス権限がありません', 'このページにアクセスする権限がありません。');

                    const pageTitles = {
                        'dashboard': 'ホーム',
                        'job-search': '求人を探す',
                        'recommendations-list': 'おすすめ求人',
                        'progress': '応募・選考状況',
                        'mypage': 'プロフィール編集',
                        'diagnosis': 'あなたの天職診断', // デフォルトタイトル
                        'user-management': 'ユーザー管理',
                        'job-management': '求人管理',
                        'login-history': 'ログイン履歴',
                        'contact': 'お問い合わせ' // ← この行を追加
                    };

                    // タイトルを動的に変更
                    let pageTitle = pageTitles[pageId] || 'ホーム';
                    if (pageId === 'diagnosis' && options.userName) {
                         pageTitle = `${options.userName}さんの診断結果`;
                    } else if (pageId === 'diagnosis') {
                         pageTitle = 'あなたの天職診断結果';
                    }
                    $('#mobile-page-title').text(pageTitle);

                    $('.page').removeClass('active');
                    $(`#${pageId}-page`).addClass('active');
                    $('.sidebar-link').removeClass('bg-indigo-600 text-white').addClass('text-gray-300 hover:bg-slate-700');
                    $(`.sidebar-link[data-page="${pageId}"]`).addClass('bg-indigo-600 text-white').removeClass('text-gray-300');

                    const pageRenderers = {
                        'dashboard': renderDashboard,
                        'job-search': renderJobSearch,
                        'progress': renderProgress,
                        'mypage': renderMyPage,
                        'diagnosis': renderDiagnosisPage, // 変更
                        'user-management': renderUserManagement,
                        'job-management': renderJobManagement,
                        'recommendations-list': renderRecommendationsList,
                        'login-history': renderLoginHistory,
                        'contact': renderContactPage // ← この行を追加
                    };
                    pageRenderers[pageId]?.(options); // options を渡す
                    ui.closeSidebar();
                },
                showModal: (title, content, options = {}) => {
                const {
                    size = 'max-w-lg', showFooter = false, paddingClass = 'p-6' // ★ オプション追加
                } = options;
                $('#modal-title').text(title);
                
                // ★ p-6 を動的に制御
                $('#modal-content').removeClass('p-6 p-0').addClass(paddingClass).html(content);
                
                $('#modal-dialog').removeClass('max-w-lg max-w-2xl max-w-3xl').addClass(size);
                $('#modal-footer').toggle(showFooter);
                $('#modal-container').removeClass('hidden');
                },
                showAlert: (title, message) => ui.showModal(title, `<p class="text-slate-600">${message.replace(/\n/g, '<br>')}</p>`, {
                    showFooter: true
                }),
                hideModal: () => $('#modal-container').addClass('hidden'),
                switchAuthForm: (form) => {
                    $('#login-form-container, #register-form-container, #reset-form-container').hide();
                    $(`#${form}-form-container`).show();
                }
            };

            // モーダル内だけに出す非破壊トースト
            function notifyInModal(message) {
              const n = $('<div class="mb-3 text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded px-3 py-2"></div>')
                          .text(message);
              $('#modal-content').prepend(n);
              setTimeout(() => n.fadeOut(200, () => n.remove()), 2200);
            }

            // ========================
            // Page Rendering (Full implementations)
            // ========================
            function jobListHtml(jobsToRender) {
                if (!jobsToRender || jobsToRender.length === 0) return '';
                return jobsToRender.map(job => {
                    const isFavorited = FAVORITE_JOB_IDS.includes(job.job_id);
                    const jobIdDisplay = String(job.job_id).startsWith('http') ? `<a href="${job.job_id}" target="_blank" class="text-indigo-600 hover:underline">リンクを開く <i class="fas fa-external-link-alt text-xs"></i></a>` : (job.job_id || 'N/A');
                    const employmentType = job.employment_type || job['employment type'] || 'N/A';

                    // ▼▼▼ ここから加筆 ▼▼▼
                    // 「職種未経験OK」バッジの生成
                    const expOkBadge = (job.job_experience_ok === 'OK')
                        ? '<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">職種未経験OK</span>'
                        : '';
                    // ▲▲▲ 加筆ここまで ▲▲▲


                    return `<div class="bg-white rounded-xl shadow-md transition-all duration-300 hover:shadow-lg hover:-translate-y-1 p-6 flex flex-col">
                            <div>
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="font-bold text-lg text-slate-800 pr-2">${job.title}${expOkBadge}</h3>
                                    <button class="favorite-btn text-xl ${isFavorited ? 'text-yellow-400' : 'text-slate-400 hover:text-yellow-500'}" data-job-id="${job.job_id}">
                                        <i class="${isFavorited ? 'fas' : 'far'} fa-star"></i>
                                    </button>
                                </div>
                                <p class="text-slate-500 text-sm mb-3">求人ID: ${jobIdDisplay}</p>
                            </div>
                            <div class="text-sm text-slate-600 space-y-2 flex-grow">
                                <p><strong><i class="fas fa-building w-5 text-slate-400"></i> 会社名:</strong> ${job.company || 'N/A'}</p>
                                <p><strong><i class="fas fa-map-marker-alt w-5 text-slate-400"></i> 勤務地:</strong> ${job.location || 'N/A'}</p>
                                <p><strong><i class="fas fa-yen-sign w-5 text-slate-400"></i> 給与:</strong> ${job.salary || 'N/A'}</p>
                                <p><strong><i class="fas fa-briefcase w-5 text-slate-400"></i> 雇用形態:</strong> ${employmentType}</p>
                            </div>
                            <div class="mt-auto pt-4 text-right">
                                <button class="font-bold py-1 px-3 text-sm rounded-lg shadow-md transition-transform transform hover:scale-105 bg-slate-500 hover:bg-slate-600 text-white job-details-btn" data-job-id="${job.job_id}">詳細を見る</button>
                            </div>
                        </div>`;
                }).join('');
            }

            function displayJobs() {
                const container = $('#job-list-container');
                const startIndex = (currentJobPage - 1) * JOBS_PER_PAGE;
                const jobsToDisplay = FILTERED_JOBS.slice(startIndex, startIndex + JOBS_PER_PAGE);
                if (currentJobPage === 1) container.empty();
                container.append(jobListHtml(jobsToDisplay));
                if (FILTERED_JOBS.length === 0 && currentJobPage === 1) container.html('<p class="text-slate-500 col-span-full text-center py-8">該当する求人はありません。</p>');
                $('#load-more-container').toggle(startIndex + JOBS_PER_PAGE < FILTERED_JOBS.length);
            }

            async function renderDashboard() {
                try {
                    const data = await api.call('getDashboardData');
                    ALL_RECOMMENDATIONS = data.recommendations || [];
                    const card = "bg-white rounded-xl shadow-md hover:shadow-lg p-6";
                    let content = `<h2 class="text-3xl font-bold text-slate-800 mb-6">ホーム</h2>`;
                    if (CURRENT_USER.role === 'user') {
                        const recommendationsCount = data.recommendations?.length || 0;
                        const recsCardHtml = `
                        <div class="card-link cursor-pointer" data-page="recommendations-list">
                            <div class="${card}">
                                <h3 class="font-bold text-lg mb-4">あなたへのおすすめ求人</h3>
                                <p class="text-4xl font-bold text-indigo-600 mt-2">${recommendationsCount}<span class="text-lg ml-1">件</span></p>
                            </div>
                        </div>`;
                        const inProgressCardHtml = `
                        <div class="${card}">
                            <h3 class="font-bold text-lg mb-4">選考中の求人</h3>
                            <p class="text-4xl font-bold text-indigo-600 mt-2">${data.inProgressCount || 0}<span class="text-lg ml-1">件</span></p>
                        </div>`;
                        content += `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">${recsCardHtml}${inProgressCardHtml}</div>`;
                    } else {
                        content += `<div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="${card} text-center"><h3 class="font-bold text-lg">${{'coach':'担当求職者数','admin':'登録ユーザー総数'}[CURRENT_USER.role]}</h3><p class="text-4xl font-bold text-indigo-600 mt-2">${data.totalAssignedUsers||data.totalUsers||0}<span class="text-lg ml-1">人</span></p></div><div class="${card} text-center"><h3 class="font-bold text-lg">${{'coach':'選考中の案件','admin':'公開求人総数'}[CURRENT_USER.role]}</h3><p class="text-4xl font-bold text-indigo-600 mt-2">${data.inProgressApplications||data.totalJobs||0}<span class="text-lg ml-1">件</span></p></div>${CURRENT_USER.role==='admin'?`<div class="${card} text-center"><h3 class="font-bold text-lg">応募総数</h3><p class="text-4xl font-bold text-indigo-600 mt-2">${data.totalApplications||0}<span class="text-lg ml-1">件</span></p></div>`:''}</div>`;
                    }
                    $('#dashboard-page').html(content);
                } catch (e) {
                    console.error("Dashboard render failed:", e);
                }
            }

            async function renderJobSearch() {
                try {
                    if (ALL_JOBS.length === 0) {
                        const {
                            jobs,
                            masters,
                            favoriteJobIds
                        } = await api.call('getJobsAndMasters');
                        ALL_JOBS = jobs || [];
                        FILTERED_JOBS = ALL_JOBS;
                        MASTERS = masters || {};
                        FAVORITE_JOB_IDS = favoriteJobIds || [];
                    }

                    const allTags = [...new Set(ALL_JOBS.flatMap(j => j.tags ? String(j.tags).split(',').map(t => t.trim()) : []).filter(Boolean))];
                    let tagsHtml = allTags.length > 0 ?
                        `<div class="mt-4"><label class="block text-sm font-medium">タグ</label><div class="flex flex-wrap gap-2 mt-2">` +
                        allTags.map(tag => `<span class="tag-badge inline-block bg-slate-100 text-slate-600 cursor-pointer hover:bg-indigo-100 px-2 py-1 text-xs font-semibold rounded-full">${tag}</span>`).join('') +
                        `</div></div>` :
                        '';

                    isFavoritesOnlySearch = false;

                    let content = `<div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                            <h2 class="text-3xl font-bold text-slate-800">求人検索</h2>
                            
                            <div class="flex items-center gap-2" x-data="{ tooltipOpen: false }">
                                <button id="user-ai-matching-btn" class="font-bold py-2 px-4 rounded-lg shadow-md bg-gradient-to-r from-cyan-500 to-blue-600 text-white transition-transform transform hover:scale-105">
                                    <i class="fas fa-robot mr-2"></i>AIで求人を探す
                                </button>
                                
                                <div class="relative">
                                    <button @click="tooltipOpen = !tooltipOpen" @click.away="tooltipOpen = false" type="button" class="text-slate-500 hover:text-indigo-600">
                                        <i class="fas fa-question-circle text-xl"></i>
                                    </button>
                                    
                                    <div x-show="tooltipOpen" 
                                         x-transition:enter="transition ease-out duration-200"
                                         x-transition:enter-start="opacity-0 transform scale-95"
                                         x-transition:enter-end="opacity-100 transform scale-100"
                                         x-transition:leave="transition ease-in duration-150"
                                         x-transition:leave-start="opacity-100 transform scale-100"
                                         x-transition:leave-end="opacity-0 transform scale-95"
                                         class="absolute z-30 left-1/2 -translate-x-1/2 md:left-auto md:-translate-x-0 md:right-0 mt-2 w-72 bg-white border border-slate-300 rounded-lg shadow-lg p-4"
                                         style="display: none;">
                                        
                                        <h4 class="font-bold text-slate-800 text-base mb-2">AIで求人を探すとは?</h4>
                                        <p class="text-sm text-slate-600">AIが希望条件に合った求人を抽出し、マッチ度を診断します(0点〜100点)</p>
                                    </div>
                                </div>
                                </div>
                            <div class="flex items-center space-x-4 ml-auto">
                                 <span id="job-count" class="text-lg font-semibold text-slate-500"></span>
                                 <div>
                                     <label for="sort-select" class="text-sm font-medium text-slate-700 sr-only">並び替え:</label>
                                     <select id="sort-select" class="block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-indigo-500">
                                         <option value="created_at-desc">追加日の新しい順</option>
                                         <option value="created_at-asc">追加日の古い順</option>
                                         <option value="salary-desc">年収の高い順</option>
                                         <option value="salary-asc">年収の低い順</option>
                                     </select>
                                 </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div><label class="block text-sm font-medium">業種</label><div id="industry-multi-select"></div></div>
                                <div><label class="block text-sm font-medium">職種</label><div id="job-type-multi-select"></div></div>
                                <div>
                                    <label for="search-salary" class="block text-sm font-medium">希望年収</label>
                                    <div class="mt-1">
                                        <input id="search-salary" type="range" min="300" max="2000" step="50" value="300" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                        <div class="text-right text-sm text-slate-500 mt-1"><span id="search-salary-value">300</span> 万円以上</div>
                                    </div>
                                </div>
                            </div>
                            <div x-data="{ open: false }">
                                <button @click="open=!open" class="text-indigo-600 hover:underline mt-4 text-sm">さらに条件を追加 <i class="fas fa-chevron-down" :class="{'rotate-180': open}"></i></button>
                                <div x-show="open" x-transition class="mt-4 pt-4 border-t">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div><label class="block text-sm font-medium">雇用形態</label><div id="employment-type-multi-select"></div></div>
                                        <div><label class="block text-sm font-medium">勤務地</label><div id="location-multi-select"></div></div>
                                    </div>
                                    <div class="mt-4"><label class="block text-sm font-medium">フリーワード</label><div id="search-freeword-input"></div></div>
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-slate-700">未経験歓迎</label>
                                        <div class="flex space-x-4 mt-2">
                                            <label class="flex items-center">
                                                <input type="checkbox" id="search-job-exp" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                                <span class="ml-2 text-sm text-slate-700">職種未経験OK</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" id="search-industry-exp" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                                <span class="ml-2 text-sm text-slate-700">業種未経験OK</span>
                                            </label>
                                        </div>
                                    </div>
                                    ${tagsHtml}
                                </div>
                            </div>
                            <div class="flex justify-end mt-4">
                                <button id="job-search-favorites-btn" class="font-bold py-2 px-4 rounded-lg shadow-md bg-yellow-400 text-white mr-2"><i class="fas fa-star mr-2"></i>お気に入り</button>
                                <button id="apply-desired-conditions-btn" class="font-bold py-2 px-4 rounded-lg shadow-md bg-teal-500 text-white mr-2">プロフィールに登録した条件で探す</button>
                                <button id="job-search-reset-btn" class="font-bold py-2 px-4 rounded-lg shadow-md bg-slate-500 text-white mr-2">条件をクリア</button>
                                <button id="job-search-btn" class="font-bold py-2 px-4 rounded-lg shadow-md bg-indigo-600 text-white">検索する</button>
                            </div>
                        </div>
                        <div id="job-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                        <div id="load-more-container" class="text-center mt-8"><button id="load-more-btn" class="font-bold py-2 px-4 rounded-lg shadow-md bg-indigo-600 text-white">続きを読み込む</button></div>`;
                    

                    $('#job-search-page').html(content);

// ★ ここで差し込んだ領域を Alpine に再スキャンさせる
                    if (window.Alpine && typeof Alpine.initTree === 'function') {
                          Alpine.initTree(document.getElementById('job-search-page'));
                    }

// (872行目の Alpine.initTree(...) は削除します)

                    // Alpine.js がDOMの初期化を完了させた後に、
                    // DOMを書き換える multiSelect 等を実行する
                    // Alpine.js の自動初期化スキャンと、
                    // 以下の multiSelect/freewordInput によるDOM書き換えが競合するのを防ぐ。
                    //
                    // Alpine のスキャンが完了するのを確実に待つため、
                    // わずかな遅延（10ms）を設けてからDOM操作を実行する。
                    setTimeout(() => {
                        multiSelect.create('industry-multi-select', MASTERS.industry || [], [], v => selectedIndustries = v);
                        multiSelect.create('job-type-multi-select', MASTERS.job_type || [], [], v => selectedJobTypes = v);
                        multiSelect.create('employment-type-multi-select', EMPLOYMENT_TYPES, [], v => selectedEmploymentTypes = v);
                        multiSelect.create('location-multi-select', PREFECTURES, [], v => selectedLocations = v);
                        freewordInput.create('search-freeword-input', [], w => searchFreewords = w);
                        performSearch();
                    }, 10); // 10ミリ秒の遅延


                } catch (e) {
                    console.error("Job search render failed:", e);
                }
            }
            async function renderRecommendationsList() {
                try {
                    const recs = await api.call('getAllRecommendations'); // ★ この行を追加
                    ALL_RECOMMENDATIONS = recs || [];

                    recs.sort((a, b) => {
                        const aExcluded = a.user_reaction === 'excluded';
                        const bExcluded = b.user_reaction === 'excluded';
                        const aRejected = a.user_reaction === 'rejected';
                        const bRejected = b.user_reaction === 'rejected';

                        // 1. 'excluded' (AI除外) を最下部にソート
                        if (aExcluded && !bExcluded) return 1;
                        if (!aExcluded && bExcluded) return -1;

                        // 2. 'rejected' (見送り) をその次に下部にソート
                        if (aRejected && !bRejected) return 1;
                        if (!aRejected && bRejected) return -1;

                        // 3. それ以外は日付の新しい順にソート
                        return new Date(b.created_at) - new Date(a.created_at);
                    });

                    const isManager = ['admin', 'coach'].includes(CURRENT_USER.role);
                    
                    // ▼▼▼ 変更（管理者向けフィルター）▼▼▼
                    const searchFilterHtml = isManager ? `<div class="bg-white rounded-xl shadow-md p-4 mb-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="recommendation-keyword-search" class="text-sm font-medium text-slate-600">キーワード検索</label>
                                        <input id="recommendation-keyword-search" type="text" placeholder="求職者名, 求人名, 企業名..." class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500">
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-slate-600">ステータス絞り込み</label>
                                        <div id="recommendation-status-filter" class="flex items-center space-x-2 mt-2 flex-wrap gap-y-2">
                                            <button class="rec-status-filter-btn font-bold py-1 px-3 text-sm rounded-lg shadow-md bg-indigo-600 text-white" data-status="all">すべて</button>
                                            <button class="rec-status-filter-btn font-bold py-1 px-3 text-sm rounded-lg shadow-md bg-slate-500 text-white" data-status="applied">応募済</button>
                                            <button class="rec-status-filter-btn font-bold py-1 px-3 text-sm rounded-lg shadow-md bg-slate-500 text-white" data-status="rejected">見送り</button>
                                            <button class="rec-status-filter-btn font-bold py-1 px-3 text-sm rounded-lg shadow-md bg-slate-500 text-white" data-status="excluded">除外(AI)</button> </div> 
                                        </div>
                                    </div>
                                </div>
                            <div class="mt-4 pt-4 border-t flex justify-end">
                                <button id="send-recommendation-email-btn" class="font-bold py-2 px-4   rounded-lg shadow-md bg-green-600 hover:bg-green-700 text-white disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                        <i class="fas fa-envelope mr-2"></i>チェックした求人をメール送信
                                    </button>
                                </div>
                            </div>` : '';
                    // ▲▲▲ 変更（管理者向けフィルター）▲▲▲
                    
                    // ▼▼▼ 新規追加（ユーザー向け一括操作ボタン）▼▼▼
                    // ▼▼▼ 変更（全ロール共通の一括操作バー）▼▼▼
                    let batchActionHtml = `
                        <div class="bg-white rounded-xl shadow-md p-4 mb-6">
                            <div class="flex flex-col sm:flex-row justify-end items-center gap-2">
                                <div class="mr-auto">
                                    <span class="text-sm text-slate-600" id="batch-action-label">チェックした求人を一括操作:</span>
                                    <span class="text-sm font-medium text-red-500 hidden" id="batch-action-warning"></span>
                                </div>
                    `;

                    if (isManager) {
                        batchActionHtml += `
                            <button id="send-recommendation-email-btn" class="w-full sm:w-auto font-bold py-2 px-4 rounded-lg shadow-md bg-green-600 hover:bg-green-700 text-white disabled:opacity-50" disabled>
                                <i class="fas fa-envelope mr-2"></i>メール送信
                            </button>
                            <button id="batch-reject-btn" class="w-full sm:w-auto font-bold py-2 px-4 rounded-lg shadow-md bg-slate-500 hover:bg-slate-600 text-white disabled:opacity-50" disabled>
                                <i class="fas fa-times-circle mr-2"></i>一括見送り
                            </button>
                            <button id="batch-apply-btn" class="w-full sm:w-auto font-bold py-2 px-4 rounded-lg shadow-md bg-indigo-600 hover:bg-indigo-700 text-white disabled:opacity-50" disabled>
                                <i class="fas fa-check-double mr-2"></i>一括代理応募
                            </button>
                        `;
                    } else { // User role
                        batchActionHtml += `
                            <button id="batch-apply-btn" class="w-full sm:w-auto font-bold py-2 px-4 rounded-lg shadow-md bg-indigo-600 hover:bg-indigo-700 text-white disabled:opacity-50" disabled>
                                <i class="fas fa-check-double mr-2"></i>一括応募
                            </button>
                            <button id="batch-reject-btn" class="w-full sm:w-auto font-bold py-2 px-4 rounded-lg shadow-md bg-slate-500 hover:bg-slate-600 text-white disabled:opacity-50" disabled>
                                <i class="fas fa-times-circle mr-2"></i>一括見送り
                            </button>
                        `;
                    }
                    
                    batchActionHtml += `</div></div>`;
                    // ▲▲▲ 変更 ▲▲▲


                    let content = `<h2 class="text-3xl font-bold text-slate-800 mb-6">おすすめ求人一覧</h2>${searchFilterHtml}${batchActionHtml}`;
                    
                    if (!recs || recs.length === 0) {
                        content += `<div class="bg-white rounded-xl shadow-md p-6"><p class="text-center text-slate-500">現在、おすすめの求人はありません。</p></div>`;
                        $('#recommendations-list-page').html(content);
                        return;
                    }

                    const getBadge = r => ({
                        'view': 'bg-blue-100 text-blue-700',
                        'rejected': 'bg-slate-100 text-slate-600',
                        'applied': 'bg-green-100 text-green-700'
                    }[r] || 'bg-yellow-100 text-yellow-700');
                    const getBadgeText = r => ({
                        'view': '詳細確認済み',
                        'rejected': '見送り',
                        'applied': '応募済み'
                    }[r] || '未確認');
                    const getStatus = r => {
                        if (r === 'excluded') return 'excluded';
                        if (r === 'applied') return 'applied'; // ★ 追加
                        return r || 'pending';
                    };

                    const tableRows = recs.map(rec => {
                        const isRejected = rec.user_reaction === 'rejected';
                        const isExcluded = rec.user_reaction === 'excluded'; 
                        const isApplied = rec.user_reaction === 'applied'; // ★ 追加
                        const isActionable = !isRejected && !isExcluded && !isApplied; // ★ 追加 (操作可能か)

                        let rowStyle = '';
                        if (isExcluded) {
                            rowStyle = 'bg-slate-200 text-slate-600'; 
                        } else if (isRejected) {
                            rowStyle = 'bg-slate-100 text-slate-500'; 
                        } else if (isApplied) { // ★ 追加
                            rowStyle = 'bg-green-50';
                        }
                        
                        const recDate = new Date(rec.created_at).toLocaleDateString('ja-JP');
                        const isAI = rec.recommendation_type === 'ai';
                        const recommender = isAI ? `AI (${rec.ai_score||'N/A'}点)` : rec.recommender_name;
                        const managerCell = isManager ? `<td class="p-3">${rec.user_name}</td>` : '';
                        
                        // ▼▼▼ 変更（ボタン定義）▼▼▼
                        // 見送りボタン: 操作可能なら全ロール表示
                        const rejectButton = isActionable ? `<button class="font-bold py-1 px-3 text-sm rounded-lg shadow-md bg-slate-400 text-white recommendation-list-reject-btn" data-rec-id="${rec.recommendation_id}">見送る</button>` : '';
                        // 応募ボタン(ユーザー用): 操作可能かつ「ユーザー」ロールの場合のみ表示
                        const applyButtonUser = isActionable && !isManager ? `<button class="font-bold py-1 px-3 text-sm rounded-lg shadow-md bg-indigo-600 text-white recommendation-list-apply-btn" data-job-id="${rec.job_id}" data-rec-id="${rec.recommendation_id}">応募</button>` : '';
                        // ★★★ 代理応募ボタン(管理者用): 操作可能かつ「管理者」ロールの場合のみ表示 ★★★
                        const applyButtonManager = isActionable && isManager ? `<button class="font-bold py-1 px-3 text-sm rounded-lg shadow-md bg-indigo-600 text-white manager-apply-single-btn" data-job-id="${rec.job_id}" data-rec-id="${rec.recommendation_id}" data-user-id="${rec.user_id}" data-user-name="${rec.user_name || ''}">代理応募</button>` : '';
                        // ▲▲▲ 変更 ▲▲▲
                        const applyButton = isManager ? applyButtonManager : applyButtonUser;

                        
                        const reasonHtml = rec.recommendation_reason ? `<p class="text-xs font-normal text-slate-500 mt-1 pl-1 border-l-2 border-slate-200">${rec.recommendation_reason}</p>` : '';
                        const keywords = [rec.user_name, rec.title, rec.company].join(' ').toLowerCase();
                        const jobIdDisplay = String(rec.job_id).startsWith('http') ? `<a href="${rec.job_id}" target="_blank" class="text-indigo-600 hover:underline">リンクを開く <i class="fas fa-external-link-alt text-xs"></i></a>` : (rec.job_id || 'N/A');

                        const jobExpBadge = (rec.job_experience_ok === 'OK')
                            ? '<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">職種未経験OK</span>'
                            : '';
                        const industryExpBadge = (rec.industry_experience_ok === 'OK')
                            ? '<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">業種未経験OK</span>'
                            : '';

                        let shortDescHtml = '';
                        if (rec.description) {
                            let desc = rec.description.replace(/\s+/g, ' ').substring(0, 60);
                            if (rec.description.length > 60) desc += '...';
                            shortDescHtml = `<p class="text-xs font-normal text-gray-600 mt-1">${desc}</p>`;
                        }
                        
                        const salaryHtml = rec.salary 
                            ? `<p class="text-sm font-bold text-orange-600 mt-1">${rec.salary}</p>` // (オレンジ色に変更済み)
                            : '';

                        return `<tr class="border-b recommendation-row ${rowStyle}" data-status="${getStatus(rec.user_reaction)}" data-keywords="${keywords}">
                            <td class="p-3 text-center">
                                <input type="checkbox" class="recommendation-check-item h-4 w-4"
                                       data-user-id="${rec.user_id}" 
                                       data-job-id="${rec.job_id}" 
                                       data-title="${rec.title}" 
                                       data-company="${rec.company}"
                                       data-rec-id="${rec.recommendation_id}"
                                       data-reason="${encodeURIComponent(rec.recommendation_reason || '')}"
                                        data-user-name="${rec.user_name || ''}"
                                       ${!isActionable ? 'disabled' : ''}>
                                </td>
                            <td class="p-3 text-sm">${recDate}</td>
                                ${managerCell}
                                <td class="p-3 font-medium ${isRejected || isExcluded ? '' : 'text-slate-800'}"> 
                                    ${rec.title} ${jobExpBadge} ${industryExpBadge}
                                    ${reasonHtml}
                                    ${shortDescHtml} 
                                </td>
                                <td class="p-3">
                                    ${rec.company}
                                    ${salaryHtml} 
                                </td>
                                <td class="p-3 text-sm">${jobIdDisplay}</td>
                                <td class="p-3"><i class="fas ${isAI?'fa-robot text-indigo-500':'fa-user-tie text-green-500'} mr-2"></i>${recommender}</td>
                                <td class="p-3 status-badge"><span class="px-2 py-1 text-xs font-semibold rounded-full ${getBadge(rec.user_reaction)}">${getBadgeText(rec.user_reaction)}</span></td>
                                <td class="p-3 text-right space-x-2 whitespace-nowrap">
                                    ${rejectButton}
                                    ${applyButton} <button class="font-bold py-1 px-3 text-sm rounded-lg shadow-md transition-transform transform hover:scale-105 bg-slate-500 hover:bg-slate-600 text-white job-details-btn" data-job-id="${rec.job_id}">詳細</button>
                                </td>
                            </tr>`;
                    }).join('');
                                content += `<div class="bg-white rounded-xl shadow-md overflow-x-auto"><table class="w-full text-left min-w-[700px]"><thead class="bg-slate-50 border-b"><tr>
                                <th class="p-3 text-center"><input type="checkbox" id="recommendation-check-all" class="h-4 w-4"></th>
                                <th class="p-3 text-sm font-semibold text-slate-600">推薦日</th>
                                ${isManager ? '<th class="p-3 text-sm font-semibold text-slate-600">求職者名</th>':''}
                                <th class="p-3 text-sm font-semibold text-slate-600">求人名</th>
                                <th class="p-3 text-sm font-semibold text-slate-600">企業名</th>
                                <th class="p-3 text-sm font-semibold text-slate-600">求人ID</th>
                                <th class="p-3 text-sm font-semibold text-slate-600">推薦者</th>
                                <th class="p-3 text-sm font-semibold text-slate-600">判断状況</th>
                                <th class="p-3"></th>
                            </tr></thead><tbody id="recommendations-table-body">${tableRows}</tbody></table></div>`;
                    $('#recommendations-list-page').html(content);
                    filterRecommendations();
                } catch (e) {
                    console.error("Recs list render failed:", e);
                }
            }


            async function renderProgress() {
                try {
                    const {
                        applications,
                        statuses
                    } = await api.call('getProgressData');
                    ALL_APPLICATIONS = applications || [];
                    MASTERS.application_status = statuses || []; // ステータスマスタを保存
                    const isManager = ['admin', 'coach'].includes(CURRENT_USER.role); // 管理者かどうかのフラグ

                    const getBadge = s => ({
                        "内定": "bg-purple-100 text-purple-700",
                        "入社確認済": "bg-green-100 text-green-700",
                        "最終面接": "bg-blue-100 text-blue-700",
                        "一次面接": "bg-blue-100 text-blue-700",
                        "書類選考": "bg-yellow-100 text-yellow-700",
                        "応募完了": "bg-yellow-100 text-yellow-700",
                        "選考終了(書類)": "bg-slate-100 text-slate-600",
                        "選考終了(面接)": "bg-slate-100 text-slate-600",
                        "選考終了(内定辞退)": "bg-slate-100 text-slate-600",
                        "選考終了(充足クローズ)": "bg-slate-100 text-slate-600",
                        "選考終了(その他)": "bg-slate-100 text-slate-600"
                    }[s] || 'bg-slate-100 text-slate-600');

                    // ▼▼▼ テーブル行生成ロジックを変更 ▼▼▼
                    const tableRows = apps => apps?.length > 0 ? apps.map(app => {
                        let group = 'progress';
                        if (app.status === '内定') group = 'offered';
                        else if (app.status === '入社確認済') group = 'decided';
                        else if ((app.status || '').startsWith('選考終了')) group = 'finished';

                        const keywords = [app.user_name, app.company_name, app.job_title].join(' ').toLowerCase();
                        const jobIdDisplay = String(app.job_id).startsWith('http') ? `<a href="${app.job_id}" target="_blank" class="text-indigo-600 hover:underline">リンクを開く <i class="fas fa-external-link-alt text-xs"></i></a>` : (app.job_id || 'N/A');

                        // チェックボックスを追加 (管理者のみ)
                        const checkboxHtml = isManager ? `<td class="p-3 text-center">
                                            <input type="checkbox" class="progress-check-item h-4 w-4"
                                                   data-app-id="${app.application_id}"
                                                   data-user-id="${app.user_id}"
                                                   data-user-name="${app.user_name || ''}">
                                        </td>` : '';

                        return `<tr class="border-b progress-row" data-status-group="${group}" data-keywords="${keywords}">
                                    ${checkboxHtml}
                                    <td class="p-3 text-sm text-slate-600">${new Date(app.application_date).toLocaleDateString('ja-JP')}</td>
                                    <td class="p-3 font-medium text-slate-800">${app.company_name}</td>
                                    <td class="p-3 text-slate-700">${app.job_title}</td>
                                    <td class="p-3 text-sm text-slate-500">${jobIdDisplay}</td>
                                    ${isManager ? `<td class="p-3 text-slate-600">${app.user_name}</td>` : ''}
                                    <td class="p-3"><span class="px-2 py-1 text-xs font-semibold rounded-full ${getBadge(app.status)}">${app.status || 'N/A'}</span></td>
                                    <td class="p-3 text-right space-x-2 whitespace-nowrap">
                                        <button class="font-bold py-1 px-3 text-sm rounded-lg shadow-md transition-transform transform hover:scale-105 bg-slate-500 hover:bg-slate-600 text-white details-btn" data-id="${app.application_id}">詳細</button>
                                        ${isManager ? `<button class="font-bold py-1 px-3 text-sm rounded-lg shadow-md transition-transform transform hover:scale-105 bg-slate-500 hover:bg-slate-600 text-white edit-status-btn" data-id="${app.application_id}" data-current-status="${app.status}">編集</button>` : ''}
                                    </td>
                                </tr>`;
                    }).join('') : `<tr><td colspan="${isManager ? 8 : 7}" class="text-center text-slate-500 py-8">該当する応募情報はありません。</td></tr>`; // colspanを調整
                    // ▲▲▲ テーブル行生成ロジックここまで ▲▲▲

                    const searchBoxHtml = isManager ? `<div>
                                                    <label for="progress-keyword-search" class="text-sm font-medium text-slate-600">キーワード検索</label>
                                                    <input id="progress-keyword-search" type="text" placeholder="求職者名, 企業名, 求人名..." class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500">
                                                </div>` : '<div class="hidden md:block"></div>';

                    // ▼▼▼ 一括操作ボタンを追加 ▼▼▼
                    const batchActionHtml = isManager ? `
                        <div class="bg-white rounded-xl shadow-md p-4 mb-6">
                            <div class="flex flex-col sm:flex-row justify-end items-center gap-2">
                                <div class="mr-auto">
                                    <span class="text-sm text-slate-600" id="progress-batch-action-label">チェックした応募を一括操作:</span>
                                    <span class="text-sm font-medium text-red-500 hidden" id="progress-batch-action-warning"></span>
                                </div>
                                <button id="batch-status-update-btn" class="w-full sm:w-auto font-bold py-2 px-4 rounded-lg shadow-md bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-50" disabled>
                                    <i class="fas fa-edit mr-2"></i>ステータスを一括変更
                                </button>
                            </div>
                        </div>` : '';
                    // ▲▲▲ 一括操作ボタンここまで ▲▲▲

                    let content = `<div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-slate-800">応募・選考状況</h2></div>
                                       <div class="bg-white rounded-xl shadow-md p-4 mb-6">
                                           <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                                               ${searchBoxHtml}
                                               <div>
                                                   <label class="text-sm font-medium text-slate-600">ステータスで絞り込む</label>
                                                   <div class="flex items-center space-x-2 mt-2 flex-wrap gap-y-2">
                                                       <button class="filter-btn font-bold py-1 px-3 text-sm rounded-lg shadow-md bg-indigo-600 text-white" data-filter="progress">選考中</button>
                                                       <button class="filter-btn font-bold py-1 px-3 text-sm rounded-lg shadow-md bg-slate-500 text-white" data-filter="offered">内定</button>
                                                       <button class="filter-btn font-bold py-1 px-3 text-sm rounded-lg shadow-md bg-slate-500 text-white" data-filter="decided">入社決定</button>
                                                       <button class="filter-btn font-bold py-1 px-3 text-sm rounded-lg shadow-md bg-slate-500 text-white" data-filter="finished">終了</button>
                                                       <button class="filter-btn font-bold py-1 px-3 text-sm rounded-lg shadow-md bg-slate-500 text-white" data-filter="all">すべて</button>
                                                   </div>
                                               </div>
                                           </div>
                                       </div>
                                       ${batchActionHtml} <div class="bg-white rounded-xl shadow-md overflow-x-auto">
                                           <table class="w-full text-left min-w-[600px]">
                                               <thead class="bg-slate-50 border-b">
                                                   <tr>
                                                       ${isManager ? '<th class="p-3 text-center"><input type="checkbox" id="progress-check-all" class="h-4 w-4"></th>' : ''} <th class="p-3 text-sm font-semibold text-slate-600">応募日</th>
                                                       <th class="p-3 text-sm font-semibold text-slate-600">企業名</th>
                                                       <th class="p-3 text-sm font-semibold text-slate-600">求人名</th>
                                                       <th class="p-3 text-sm font-semibold text-slate-600">求人ID</th>
                                                       ${isManager ? '<th class="p-3 text-sm font-semibold text-slate-600">応募者</th>' : ''}
                                                       <th class="p-3 text-sm font-semibold text-slate-600">ステータス</th>
                                                       <th class="p-3"></th>
                                                   </tr>
                                               </thead>
                                               <tbody id="progress-table-body">${tableRows(ALL_APPLICATIONS)}</tbody>
                                           </table>
                                       </div>`;
                    $('#progress-page').html(content);
                    // デフォルトで「選考中」をフィルタリング
                    if (ALL_APPLICATIONS.length > 0) filterProgress('progress');
                    // 初期状態でチェックボックスの状態を同期
                    if (isManager) syncProgressHeaderCheckbox();

                } catch (e) {
                    console.error("Progress render failed:", e);
                }
            }
            async function renderMyPage() {
                try {
                    // マスターデータ（業種など）が未読み込みなら取得
                    if (!MASTERS.industry) {
                        const { masters } = await api.call('getJobsAndMasters');
                        MASTERS = { ...MASTERS, ...masters };
                    }
                    // ユーザープロファイルを取得
                    const profile = await api.call('getMyProfile');
                    if (!profile) throw new Error('Profile not found');

                    // 希望条件のデータを準備
                    desiredIndustries = profile.desired_industry?.split(',').map(s => s.trim()).filter(Boolean) || [];
                    desiredJobTypes = profile.desired_job_type?.split(',').map(s => s.trim()).filter(Boolean) || [];
                    desiredEmploymentTypes = profile.desired_employment_type?.split(',').map(s => s.trim()).filter(Boolean) || [];
                    desiredLocations = profile.desired_location?.split(',').map(s => s.trim()).filter(Boolean) || [];
                    desiredFreewords = profile.desired_freewords?.split(',').map(s => s.trim()).filter(Boolean) || [];

                    // UI定数
                    const fLabel = "block text-sm font-medium text-slate-700";
                    const fInput = "mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500";
                    const card = "bg-white rounded-xl shadow-md p-6";

                    // URLボタン
                    const driveUrlButton = profile.drive_folder_url ? `<div class="mt-4"><a href="${profile.drive_folder_url}" target="_blank" class="font-bold py-2 px-4 rounded-lg shadow-md inline-block bg-blue-500 hover:bg-blue-600 text-white"><i class="fab fa-google-drive mr-2"></i>Google Driveを開く</a></div>` : '';
                    const lineUrlFieldHtml = CURRENT_USER.role === 'user' ? '' : `<div class="md:col-span-2"><label class="${fLabel}">LINE URL</label><input name="line_url" type="url" class="${fInput}" value="${profile.line_url||''}"></div>`;

                    let skillsSectionHtml = '';
                    if (profile.diagnosis_flg) {
                        skillsSectionHtml = `
                        <div class="${card} mb-8">
                            <h3 class="text-xl font-bold text-slate-800 mb-4">経歴・スキル</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="resume" class="${fLabel}">履歴書 (テキスト)</label>
                                    <textarea name="resume" id="resume" class="${fInput}" rows="8">${profile.resume || ''}</textarea>
                                </div>
                                <div>
                                    <label for="work_history" class="${fLabel}">職務経歴書 (テキスト)</label>
                                    <textarea name="work_history" id="work_history" class="${fInput}" rows="12">${profile.work_history || ''}</textarea>
                                </div>
                                <div>
                                    <label for="notes" class="${fLabel}">自己PR・スキル等</label>
                                    <textarea name="notes" id="notes" class="${fInput}" rows="5">${profile.notes || ''}</textarea>
                                </div>
                            </div>
                        </div>`;
                    }

                    // ▼▼▼ 変更箇所 ▼▼▼
                    // ページ全体のHTMLを構築 (パスワード変更フィールドを追加)
                    let content = `<h2 class="text-3xl font-bold text-slate-800 mb-6">プロフィール</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2">
                            <form id="profile-form">
                                
                                <div class="${card} mb-8">
                                    <h3 class="text-xl font-bold text-slate-800 mb-4">基本情報</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div><label class="${fLabel}">氏名</label><input name="name" type="text" class="${fInput}" value="${profile.name||''}"></div>
                                        <div><label class="${fLabel}">年齢</label><input name="age" type="number" class="${fInput}" value="${profile.age||''}"></div>
                                        <div class="md:col-span-2"><label class="${fLabel}">メール</label><input type="email" class="${fInput} bg-slate-100" value="${profile.email||''}" readonly></div>
                                        
                                        <div>
                                            <label for="new_password" class="${fLabel}">新しいパスワード</label>
                                            <input id="new_password" name="new_password" type="password" class="${fInput}" placeholder="変更する場合のみ入力">
                                        </div>
                                        <div>
                                            <label for="confirm_password" class="${fLabel}">新しいパスワード（確認）</label>
                                            <input id="confirm_password" name="confirm_password" type="password" class="${fInput}" placeholder="変更する場合のみ入力">
                                        </div>
                                        <div class="md:col-span-2 text-xs text-slate-500">※パスワードを変更しない場合は空欄のままにしてください。</div>
                                        ${lineUrlFieldHtml}
                                    </div>
                                    ${driveUrlButton}
                                </div>

                                ${skillsSectionHtml} 

                                <div class="${card}">
                                    <h3 class="text-xl font-bold text-slate-800 mb-4">希望条件</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div><label class="${fLabel}">希望業種</label><div id="desired-industry-multi-select"></div></div>
                                        <div><label class="${fLabel}">希望職種</label><div id="desired-job-type-multi-select"></div></div>
                                        <div><label class="${fLabel}">希望勤務形態</label><div id="desired-employment-type-multi-select"></div></div>
                                        <div><label class="${fLabel}">希望勤務地</label><div id="desired-location-multi-select"></div></div>
                                        <div class="col-span-2"><label for="desired-salary" class="${fLabel}">希望年収</label><div class="mt-1"><input id="desired-salary" name="desired_salary" type="range" min="300" max="2000" step="50" value="${parseInt(profile.desired_salary, 10) || 300}" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"><div class="text-right text-sm text-slate-500 mt-1"><span id="desired-salary-value">${parseInt(profile.desired_salary, 10) || 300}</span> 万円以上</div></div></div>
                                        <div class="col-span-2"><label class="${fLabel}">希望フリーワード</label><div id="desired-freeword-input"></div></div>
                                        <div class="col-span-2"><label class="block text-sm font-medium text-slate-700">未経験歓迎</label><div class="flex space-x-4 mt-2"><label class="flex items-center"><input type="checkbox" name="desired_job_experience_ok" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${profile.desired_job_experience_ok ? 'checked' : ''}><span class="ml-2 text-sm text-slate-700">職種未経験OK</span></label><label class="flex items-center"><input type="checkbox" name="desired_industry_experience_ok" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${profile.desired_industry_experience_ok ? 'checked' : ''}><span class="ml-2 text-sm text-slate-700">業種未経験OK</span></label></div></div>
                                    </div>
                                </div>
                                
                                <div class="mt-6 text-right">
                                    <button type="submit" class="font-bold py-2 px-4 rounded-lg shadow-md bg-indigo-600 text-white">この内容で更新する</button>
                                </div>
                            </form>
                        </div>
                    </div>`;
                    // ▲▲▲ 変更箇所 ▲▲▲
                    
                    // HTMLを描画
                    $('#mypage-page').html(content);
                    
                    // 「希望条件」のUIを初期化
                    multiSelect.create('desired-industry-multi-select', MASTERS.industry || [], desiredIndustries, v => desiredIndustries = v);
                    multiSelect.create('desired-job-type-multi-select', MASTERS.job_type || [], desiredJobTypes, v => desiredJobTypes = v);
                    multiSelect.create('desired-employment-type-multi-select', EMPLOYMENT_TYPES, desiredEmploymentTypes, v => desiredEmploymentTypes = v);
                    multiSelect.create('desired-location-multi-select', PREFECTURES, desiredLocations, v => desiredLocations = v);
                    freewordInput.create('desired-freeword-input', desiredFreewords, w => desiredFreewords = w);

                } catch (e) {
                    console.error("MyPage render failed:", e);
                }
            }

            async function renderDiagnosisPage(options = {}) { // async に変更, options を追加
                const pageContainer = $('#diagnosis-page');
                pageContainer.html('<div class="text-center p-8"><div class="spinner w-8 h-8 mx-auto"></div><p class="mt-2 text-slate-600">診断結果を読み込み中...</p></div>'); // ローディング表示

                let targetUser = null;
                const targetUserId = options.userId;

                try {
                    if (targetUserId) {
                        // 他のユーザーのプロファイルを取得
                        targetUser = await api.call('getMyProfile', [targetUserId]);
                    } else {
                        // ログイン中のユーザー
                        targetUser = CURRENT_USER;
                    }

                    if (!targetUser) {
                         throw new Error('対象のユーザー情報が見つかりません。');
                    }

                    if (!targetUser.diagnosis_flg || !targetUser.diagnosis_data1 || !targetUser.diagnosis_data2) {
                        const message = (targetUserId) ? '対象ユーザーは診断未実施、またはデータがありません。' : '診断データが見つかりません。';
                        pageContainer.html(`<div class="text-center p-8 bg-white rounded-lg shadow-md"><p class="text-slate-600">${message}</p></div>`);
                        return;
                    }

                    // --- ここから下は targetUser を使う ---
                    const strengthData = JSON.parse(targetUser.diagnosis_data1);
                    const jobData = JSON.parse(targetUser.diagnosis_data2);

                    const contentHtml = `
                        <div class="result-content">
                            <div class="strength-ranking-header">
                                <img alt="王冠アイコン" class="strength-ranking-crown" src="https://rightjob-tenshoku-shindan.website/assets/results/crown_icon-16cd5862e0dccfa83dc55af655048e03eee7cebd8b391258d4caeb2399066d9d.png" />
                                <h1 class="strength-ranking-title">${options.userName ? options.userName + 'さん' : 'あなた'}の強み順位</h1>
                                <p class="strength-ranking-subtitle">診断結果をもとに、強みを<br>ランキング形式で表示しています。</p>
                            </div>
                            <div class="result-card">
                                <div class="result-card-content">
                                    <div class="items-container" id="strengths-container-inner"></div>
                                </div>
                            </div>

                            <div class="job-recommendation-header">
                                <img alt="カバンアイコン" class="job-recommendation-icon" src="https://rightjob-tenshoku-shindan.website/assets/results/briefcase_icon-a46d3c3f25b25256c8a95a7bef7cfb88615b42fed04a0dec3e1f2e0285925875.png" />
                                <h1 class="job-recommendation-title">${options.userName ? options.userName + 'さん' : 'あなた'}の天職（TOP3）</h1>
                                <p class="job-recommendation-subtitle">診断結果をもとに、向いている職業<br>をランキング形式で表示しています。</p>
                            </div>
                            <div class="result-card">
                                <div class="result-card-content">
                                    <div class="items-container" id="jobs-container-inner"></div>
                                </div>
                            </div>
                        </div>`;

                    pageContainer.html(contentHtml);

                    renderStrengthsToDiagnosisPage(strengthData);
                    renderJobsToDiagnosisPage(jobData);

                } catch (e) {
                    console.error("Failed to render diagnosis data:", e);
                    pageContainer.html(`<div class="text-center p-8 bg-white rounded-lg shadow-md"><p class="text-red-500">診断データの読み込みに失敗しました: ${e.message}</p></div>`);
                }
            }
            function renderStrengthsToDiagnosisPage(data) {
                const container = $('#strengths-container-inner');
                if (!container.length) return;

                const sortedStrengths = Object.entries(data)
                    .map(([name, score]) => ({ name, score }))
                    .sort((a, b) => b.score - a.score);

                let html = '';
                sortedStrengths.forEach((strength, index) => {
                    const rank = index + 1;

                    // 順位に応じたバッジクラスを決定
                    let rankBadgeClass = 'rank-badge blue'; // デフォルトは青
                    if (rank === 1) rankBadgeClass = 'rank-badge gold';
                    else if (rank === 2) rankBadgeClass = 'rank-badge silver';
                    else if (rank === 3) rankBadgeClass = 'rank-badge bronze';

                    // ★ シンプルなリストアイテムHTMLを生成
                    html += `
                        <div class="simple-list-item" style="display: flex; align-items: center; padding: 12px 8px; border-bottom: 1px solid #eee;">
                            <span class="${rankBadgeClass}" style="width: 30px; height: 30px; font-size: 14px; margin-right: 15px;">${rank}</span>
                            <span class="item-name" style="font-weight: 500; color: #333;">${strength.name}</span>
                        </div>`;
                });
                // 最後のアイテムの下線を削除するスタイルを追加（任意）
                 container.html(html).find('.simple-list-item:last-child').css('border-bottom', 'none');
            }

            function renderJobsToDiagnosisPage(data) {
                const container = $('#jobs-container-inner');
                if (!container.length) return;
                const rankedJobs = Object.values(data).sort((a, b) => a.rank - b.rank);

                let html = '';
                // TOP3のみ表示
                rankedJobs.slice(0, 3).forEach(job => {
                    const detail = jobDetails[job.job_type]; // jobDetailsから色情報等を取得するため参照は残す
                    if (!detail) return; // jobDetailsにない職種はスキップ

                    const rank = job.rank;

                    // 順位に応じたバッジクラスを決定
                    let rankBadgeClass = 'rank-badge blue'; // デフォルトは青
                    if (rank === 1) rankBadgeClass = 'rank-badge gold';
                    else if (rank === 2) rankBadgeClass = 'rank-badge silver';
                    else if (rank === 3) rankBadgeClass = 'rank-badge bronze';

                     // 職種に応じたクラス (任意: 背景色などに利用可能)
                    const jobColorClass = detail.className || '';

                    // ★ シンプルなリストアイテムHTMLを生成
                    html += `
                        <div class="simple-list-item ${jobColorClass}" style="display: flex; align-items: center; padding: 12px 8px; border-bottom: 1px solid #eee;">
                           <span class="${rankBadgeClass}" style="width: 30px; height: 30px; font-size: 14px; margin-right: 15px;">${rank}</span>
                           <span class="item-name" style="font-weight: 500; color: #333;">${detail.name}</span>
                        </div>`;
                });
                 // 最後のアイテムの下線を削除するスタイルを追加（任意）
                 container.html(html).find('.simple-list-item:last-child').css('border-bottom', 'none');
            }
            async function renderJobManagement() {
                try {
                    const {
                        jobs,
                        masters
                    } = await api.call('getJobsAndMasters');
                    ALL_JOBS = jobs || [];
                    MASTERS = { ...MASTERS,
                        ...masters
                    };
                    const btnPrimary = "font-bold py-2 px-4 rounded-lg shadow-md bg-indigo-600 text-white";
                    const btnSecondarySm = "font-bold py-1 px-3 text-sm rounded-lg shadow-md bg-slate-500 text-white";
                    const fInput = "mt-1 block w-full rounded-md border-slate-300 shadow-sm";
                    const jobListHtml = jobsToRender => jobsToRender.map(job => `<tr class="border-b"><td class="p-3 font-medium">${job.title}</td><td class="p-3">${job.company}</td><td class="p-3">${job.status}</td><td class="p-3">${new Date(job.created_at).toLocaleDateString()}</td><td class="p-3 text-right"><button class="${btnSecondarySm} edit-job-btn" data-job-id="${job.job_id}">ステータス変更</button></td></tr>`).join('');
                    let content = `<div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-slate-800">求人管理</h2><button id="show-new-job-modal-btn" class="${btnPrimary}"><i class="fas fa-plus mr-2"></i>新規登録</button></div><div class="bg-white rounded-xl shadow-md p-6"><input id="job-management-search-input" type="text" placeholder="求人名、企業名で検索..." class="${fInput} mb-4"><div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-slate-50 border-b"><tr><th class="p-3 text-sm font-semibold">求人名</th><th class="p-3 text-sm font-semibold">企業名</th><th class="p-3 text-sm font-semibold">ステータス</th><th class="p-3 text-sm font-semibold">登録日</th><th class="p-3"></th></tr></thead><tbody id="job-list-body">${jobListHtml(ALL_JOBS)}</tbody></table></div></div>`;
                    $('#job-management-page').html(content);
                } catch (e) {
                    console.error("Job Management render failed:", e);
                }
            }

            async function renderUserManagement() {
                try {
                    const users = await api.call('getAllUsers');
                    ALL_USERS = users || [];
                    const coaches = users.filter(u => u.role === 'coach');
                    const btnPrimary = "font-bold py-2 px-4 rounded-lg shadow-md bg-indigo-600 text-white";
                    const btnSecondarySm = "font-bold py-1 px-3 text-sm rounded-lg shadow-md bg-slate-500 text-white";
                    const fInput = "mt-1 block w-full rounded-md border-slate-300 shadow-sm";

                    const userListHtml = usersToRender => usersToRender.map(user => {
                        const editBtn = `<button class="${btnSecondarySm} edit-user-btn" data-user-id="${user.user_id}">編集</button>`;
                        const recommendBtn = `<button class="font-bold py-1 px-3 text-sm rounded-lg shadow-md bg-sky-500 text-white ai-recommend-btn" data-user-id="${user.user_id}">✨ AI推薦</button>`;
                        const diagnosisBtn = user.diagnosis_flg ? `<button class="font-bold py-1 px-3 text-sm rounded-lg shadow-md bg-purple-500 hover:bg-purple-600 text-white view-diagnosis-btn" data-user-id="${user.user_id}" data-user-name="${user.name}">診断結果</button>` : '';

                        let actions = `${diagnosisBtn}`;
                        if (CURRENT_USER.role !== 'user' && user.role === 'user') {
                            actions += ` ${recommendBtn} ${editBtn}`;
                        } else if (CURRENT_USER.role === 'admin') {
                            actions += ` ${editBtn}`;
                        }

                        return `<tr class="border-b"><td class="p-3 font-medium">${user.name}</td><td class="p-3">${user.email}</td><td class="p-3">${user.role}</td><td class="p-3">${coaches.find(c => c.user_id === user.coach_id)?.name || '未割り当て'}</td><td class="p-3 text-right space-x-2">${actions.trim()}</td></tr>`;
                    }).join('');

                    let content = `<div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-slate-800">ユーザー管理</h2>${CURRENT_USER.role === 'admin' ? `<button id="show-new-user-modal-btn" class="${btnPrimary}"><i class="fas fa-user-plus mr-2"></i>新規登録</button>` : ''}</div><div class="bg-white rounded-xl shadow-md p-6"><input id="user-search-input" type="text" placeholder="氏名、メールアドレスで検索..." class="${fInput} mb-4"><div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-slate-50 border-b"><tr><th class="p-3 text-sm font-semibold">氏名</th><th class="p-3 text-sm font-semibold">メール</th><th class="p-3 text-sm font-semibold">役割</th><th class="p-3 text-sm font-semibold">担当</th><th class="p-3"></th></tr></thead><tbody id="user-list-body">${userListHtml(ALL_USERS)}</tbody></table></div></div>`;
                    $('#user-management-page').html(content);
                } catch (e) {
                    console.error("User Management render failed:", e);
                    $('#user-management-page').html(`<p class="text-red-500">ユーザー情報の読み込みに失敗</p>`);
                }
            }

            async function renderLoginHistory() {
                try {
                    const history = await api.call('getLoginHistory');
                    let content = `<h2 class="text-3xl font-bold text-slate-800 mb-6">ログイン履歴</h2>`;

                    if (!history || history.length === 0) {
                        content += `<div class="bg-white rounded-xl shadow-md p-6"><p class="text-center text-slate-500">ログイン履歴はありません。</p></div>`;
                    } else {
                        const tableRows = history.map(log => `
                            <tr class="border-b">
                                <td class="p-3 font-medium text-slate-800">${log.name || 'N/A'}</td>
                                <td class="p-3 text-slate-600">${log.email || 'N/A'}</td>
                                <td class="p-3 text-sm text-slate-500">${new Date(log.timestamp).toLocaleString('ja-JP')}</td>
                            </tr>
                        `).join('');

                        content += `
                        <div class="bg-white rounded-xl shadow-md overflow-x-auto">
                           <table class="w-full text-left min-w-[600px]">
                               <thead class="bg-slate-50 border-b">
                                   <tr>
                                       <th class="p-3 text-sm font-semibold text-slate-600">氏名</th>
                                       <th class="p-3 text-sm font-semibold text-slate-600">メールアドレス</th>
                                       <th class="p-3 text-sm font-semibold text-slate-600">ログイン日時</th>
                                   </tr>
                               </thead>
                               <tbody>
                                   ${tableRows}
                               </tbody>
                           </table>
                        </div>`;
                    }
                    $('#login-history-page').html(content);
                } catch (e) {
                    console.error("Login History render failed:", e);
                    $('#login-history-page').html(`<p class="text-red-500">ログイン履歴の読み込みに失敗しました。</p>`);
                }
            }

            // ▼▼▼ お問い合わせページ レンダリング関数 ▼▼▼
            async function renderContactPage() {
                const content = `
                <h2 class="text-3xl font-bold text-slate-800 mb-6">お問い合わせ</h2>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <p class="text-slate-700 mb-6">サービスに関するお問い合わせは、こちらのフォームからお願いいたします。</p> <a href="https://docs.google.com/forms/d/e/1FAIpQLSefIHx_Uax6l-R0YcsQiANFl_XBRs6fEayv_lFDLvAPonCWzw/viewform?usp=dialog" 
                       target="_blank" 
                       rel="noopener noreferrer" 
                       class="inline-block font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 bg-indigo-600 hover:bg-indigo-700 text-white">
                        <i class="fas fa-external-link-alt mr-2"></i>お問い合わせフォームを開く
                    </a>
                    </div>
          `;
                $('#contact-page').html(content);
            }
            // ▲▲▲ お問い合わせページ レンダリング関数 ▲▲▲

            // ========================
            // App Logic
            // ========================
            function main() {
                if (!CURRENT_USER) {
                    sessionStorage.removeItem('jobAppUser');
                    location.reload();
                    return;
                }
                $('#auth-container').hide();
                $('#app-container').show();
                $('#user-name-display').text(CURRENT_USER.name || 'ゲスト');
                const links = {
                    dashboard: `<a href="#" class="sidebar-link flex items-center px-4 py-3 rounded-lg" data-page="dashboard"><i class="fas fa-home w-6 mr-3"></i><span>ホーム</span></a>`,
                    jobSearch: `<a href="#" class="sidebar-link flex items-center px-4 py-3 rounded-lg" data-page="job-search"><i class="fas fa-search w-6 mr-3"></i><span>求人検索</span></a>`,
                    recommendationsList: `<a href="#" class="sidebar-link flex items-center px-4 py-3 rounded-lg" data-page="recommendations-list"><i class="fas fa-star w-6 mr-3"></i><span>おすすめ</span></a>`,
                    progress: `<a href="#" class="sidebar-link flex items-center px-4 py-3 rounded-lg" data-page="progress"><i class="fas fa-tasks w-6 mr-3"></i><span>応募・選考状況</span></a>`,
                    mypage: `<a href="#" class="sidebar-link flex items-center px-4 py-3 rounded-lg" data-page="mypage"><i class="fas fa-user-cog w-6 mr-3"></i><span>プロフィール編集</span></a>`,
                    userManagement: `<a href="#" class="sidebar-link flex items-center px-4 py-3 rounded-lg" data-page="user-management"><i class="fas fa-users w-6 mr-3"></i><span>ユーザー管理</span></a>`,
                    jobManagement: `<a href="#" class="sidebar-link flex items-center px-4 py-3 rounded-lg" data-page="job-management"><i class="fas fa-briefcase w-6 mr-3"></i><span>求人管理</span></a>`,
                    loginHistory: `<a href="#" class="sidebar-link flex items-center px-4 py-3 rounded-lg" data-page="login-history"><i class="fas fa-history w-6 mr-3"></i><span>ログイン履歴</span></a>`
                };
                let navHtml = `${links.dashboard}${links.jobSearch}${links.recommendationsList}${links.progress}${links.mypage}`;
                // ▼▼▼ お問い合わせリンクの追加 ▼▼▼
                navHtml += `<a href="#" class="sidebar-link flex items-center px-4 py-3 rounded-lg" data-page="contact"><i class="fas fa-envelope w-6 mr-3"></i><span>お問い合わせ</span></a>`;
                // ▲▲▲ お問い合わせリンクの追加 ▲▲▲

                // 診断結果対象ユーザーの場合、診断結果ページへのリンクを追加します。
                if (CURRENT_USER.diagnosis_flg) {
                    navHtml += `<a href="#" class="sidebar-link flex items-center px-4 py-3 rounded-lg" data-page="diagnosis"><i class="fas fa-chart-pie w-6 mr-3"></i><span>天職診断結果</span></a>`;
                }

                // --- 権限に基づく管理メニューの表示制御 ---
                // 'admin' または 'coach' 権限の場合のみ管理メニューを表示します。
                // この条件分岐により、'user' 権限のユーザーには、診断結果の有無にかかわらず管理メニューは表示されません。
                if (['admin', 'coach'].includes(CURRENT_USER.role)) {
                    navHtml += `<hr class="my-4 border-slate-700"><h3 class="px-4 py-2 text-xs font-semibold text-slate-400">管理メニュー</h3>${links.userManagement}`;
                }

                // 'admin' 権限の場合にのみ、さらに追加の管理メニューを表示します。
                if (CURRENT_USER.role === 'admin') {
                    navHtml += `${links.jobManagement}${links.loginHistory}`;
                }

                $('#nav-menu').html(navHtml);
                ui.navigateTo('dashboard');
            }

            function getMinSalary(salaryString) {
                if (!salaryString || typeof salaryString !== 'string') return 0;
                const match = salaryString.match(/(\d+)/);
                return match ? parseInt(match[1], 10) : 0;
            }

            function getFilteredJobs() {
                const jobExpOk = $('#search-job-exp').is(':checked');
                const industryExpOk = $('#search-industry-exp').is(':checked');
                const desiredSalary = parseInt($('#search-salary').val() || '300', 10);

                let baseJobs = ALL_JOBS;
                if (isFavoritesOnlySearch) {
                    baseJobs = ALL_JOBS.filter(job => FAVORITE_JOB_IDS.includes(job.job_id));
                }

                return baseJobs.filter(job => {
                    if (!job) return false;

                    const textToSearch = [job.title, job.company, job.description, job.qualifications].join(' ').toLowerCase();

                    if (selectedIndustries.length > 0 && !selectedIndustries.includes(job.industrycategory)) return false;
                    if (selectedJobTypes.length > 0 && !selectedJobTypes.includes(job.jobcategory)) return false;
                    if (selectedEmploymentTypes.length > 0 && !selectedEmploymentTypes.some(type => (job.employment_type || job['employment type'] || '').includes(type))) return false;
                    if (selectedLocations.length > 0 && !selectedLocations.some(loc => (job.location || '').includes(loc))) return false;
                    if (searchFreewords.length > 0 && !searchFreewords.some(word => textToSearch.includes(word.toLowerCase()))) return false;
                    if (activeSearchTags.length > 0 && !activeSearchTags.every(tag => (job.tags || '').includes(tag))) return false;

                    if (jobExpOk && job.job_experience_ok !== 'OK') return false;
                    if (industryExpOk && job.industry_experience_ok !== 'OK') return false;

                    if (desiredSalary > 300) {
                        const jobMinSalary = getMinSalary(job.salary);
                        if (jobMinSalary && jobMinSalary < desiredSalary) {
                            return false;
                        }
                    }

                    return true;
                });
            }

            const performSearch = () => {
                FILTERED_JOBS = getFilteredJobs();
                const sortValue = $('#sort-select').val();
                if (sortValue) {
                    const [key, order] = sortValue.split('-');
                    FILTERED_JOBS.sort((a, b) => {
                        let valA, valB;
                        if (key === 'created_at') {
                            valA = new Date(a.created_at);
                            valB = new Date(b.created_at);
                        } else if (key === 'salary') {
                            valA = getMinSalary(a.salary);
                            valB = getMinSalary(b.salary);
                        }

                        if (valA < valB) return order === 'asc' ? -1 : 1;
                        if (valA > valB) return order === 'asc' ? 1 : -1;
                        return 0;
                    });
                }

                currentJobPage = 1;
                displayJobs();
                $('#job-count').text(`${FILTERED_JOBS.length} 件`);
            };

            async function showJobDetailsModal(jobId) {
                let job = ALL_JOBS.find(j => j.job_id === jobId);
                if (!job) {
                    try {
                        job = await api.call('getJobDetails', [jobId]);
                        if (job && !ALL_JOBS.some(j => j.job_id === jobId)) {
                            ALL_JOBS.push(job);
                        }
                    } catch (e) {
                        ui.showAlert('エラー', '求人情報の取得に失敗');
                        return;
                    }
                }
                if (!job) return;

                let displayJob = { ...job
                };
                ui.showModal(displayJob.title, '<div class="spinner w-8 h-8 mx-auto"></div><p class="text-center mt-2">情報取得中...</p>', {
                    size: 'max-w-3xl'
                });

                const jobIdDisplay = String(displayJob.job_id).startsWith('http') ? `<a href="${displayJob.job_id}" target="_blank" class="text-indigo-600 hover:underline">リンクを開く <i class="fas fa-external-link-alt text-xs"></i></a>` : (displayJob.job_id || 'N/A');

                let detailsHtml = `<div class="border-b py-2"><dt class="font-semibold text-slate-600">求人ID</dt><dd class="text-slate-800">${jobIdDisplay}</dd></div>`;
                detailsHtml += Object.entries({
                    'company': '企業名',
                    'title': '職種名',
                    'jobcategory': '職種分類',
                    'industrycategory': '業種分類',
                    'salary': '給与',
                    'location': '勤務地',
                    'employment_type': '雇用形態',
                    'description': '業務内容',
                    'qualifications': '必須の経験・スキル',
                    'qualifications_2': '歓迎する経験・スキル',
                    'Strengths': 'この仕事の魅力・特徴'
                }).map(([key, label]) => {
                    const value = displayJob[key] || displayJob[key.replace('_', ' ')];
                    return value ? `<div class="border-b py-2"><dt class="font-semibold text-slate-600">${label}</dt><dd class="text-slate-800 whitespace-pre-wrap">${value}</dd></div>` : ''
                }).join('');

                // ★ 1. ボタンのHTMLを先に定義します
                const buttonBlock = `
                    <div class="mb-4 pt-2 pb-4 border-b text-right space-x-2">
                        ${CURRENT_USER.role === 'user' 
                            ? `<button class="font-bold py-1 px-3 text-sm rounded-lg shadow-md bg-cyan-500 text-white ai-match-analysis-btn" data-job-id="${displayJob.job_id}">✨ AIマッチ度分析</button>
                               <button class="font-bold py-1 px-3 text-sm rounded-lg shadow-md bg-indigo-600 text-white job-apply-btn" data-job-id="${displayJob.job_id}">応募を依頼する</button>` 
                            : ''}
                        ${['admin','coach'].includes(CURRENT_USER.role) 
                            ? `<button class="font-bold py-1 px-3 text-sm rounded-lg shadow-md bg-indigo-600 text-white job-recommend-btn" data-job-id="${displayJob.job_id}">この求人を紹介する</button>` 
                            : ''}
                    </div>`;

                // ★ 2. finalContent を変更し、ボタンを <dl> の前に配置します
                const finalContent = `${buttonBlock}<dl>${detailsHtml}</dl>`;
                $('#modal-content').html(finalContent);
            }

            // ★ 10/23 変更: AI推薦モーダルのロジックをヘルパー関数に分離
            /**
             * AI推薦の第1段階（求人選択リスト）をモーダルに描画する
             * @param {string} userId - 対象のユーザーID
             */
            async function fetchAndRenderAiJobSelection(userId) {
                // モーダル内容をローディング表示に
                // fetchAndRenderAiJobSelection 関数内
                // [変更前]
                // $('#modal-content').html('<div class="text-center"><div class="spinner w-8 h-8 mx-auto"></div><p class="mt-2 text-slate-600">AIが分析中です...</p></div>');
                // [変更後]
                $('#modal-content').html('<div class="text-center"><div class="spinner w-8 h-8 mx-auto"></div><p class="mt-2 text-slate-600">AIがマッチングしています、少々おまちください...</p></div>');

                try {
                    // GASからスコアなしの求人リスト(最大50件)を取得
                    const jobs = await api.call('getAIRecommendations', [userId]);
                    const user = ALL_USERS.find(u => u.user_id === userId);

                    // モーダルのタイトルを更新
                    if (user) {
                        $('#modal-title').text(`✨ ${user.name}さんへのAI推薦`);
                    }

                    if (jobs.length === 0) {
                        $('#modal-content').html('<p class="text-center text-slate-500 py-8">推薦できる求人はありませんでした。</p>');
                        return;
                    }

                    // ★ モーダルの高さを固定し、内部をflex colにする (p-0前提のレイアウト)
                    let html = `<form id="ai-recommend-list-form" data-user-id="${userId}" class="flex flex-col" style="height: 75vh; padding: 24px;">
                        
                        <div class="flex-shrink-0 pb-4 border-b border-slate-200">
                            <div class="mb-3">
                                <label for="ai-job-filter-input" class="sr-only">絞り込み</label>
                                <input type="text" id="ai-job-filter-input" placeholder="求人名、企業名で絞り込み..." class="w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-indigo-500">
                            </div>

                            <div class="mt-3">
                                <label class="flex items-center">
                                    <input type="checkbox" id="ai-job-filter-inexperienced-ok" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-slate-700">未経験OKの求人のみ表示</span>
                                </label>
                            </div>
                            <div class="flex items-center justify-between">
                                <p class="text-sm font-semibold text-indigo-700">AIで診断したい求人をチェックしてください（最大10件）。</p>
                            </div>

                            <div class="flex-shrink-0 mt-4 text-right space-x-2">
                                ${CURRENT_USER.role !== 'user' ? `<button type="button" id="ai-exclude-btn" class="font-bold py-2 px-4 rounded-lg shadow-md bg-slate-500 hover:bg-slate-600 text-white transition-transform transform hover:scale-105">選択した求人を除外</button>` : ''}
                                <button type="button" id="ai-score-btn" class="font-bold py-2 px-4 rounded-lg shadow-md bg-indigo-600 hover:bg-indigo-700 text-white transition-transform transform hover:scale-105">選択した求人をAIスコアリング</button>
                            </div>
                        </div>

                        <div id="ai-job-list-container" class="flex-grow overflow-y-auto pr-2 py-4">`;

                    html += jobs.map(job => {
                        const jobIdDisplay = String(job.job_id).startsWith('http') ? `<a href="${job.job_id}" target="_blank" class="text-indigo-600 hover:underline">${job.job_id} <i class="fas fa-external-link-alt text-xs"></i></a>` : (job.job_id || 'N/A');
                        
                        const expOkBadge = (job.job_experience_ok === 'OK')
                            ? '<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">職種未経験OK</span>'
                            : '';

                        let shortDesc = '概要なし';
                        if (job.description) {
                            shortDesc = job.description.replace(/\n/g, ' ').substring(0, 100); // 改行を削除し100文字抽出
                            if (job.description.length > 100) shortDesc += '...';
                        }
                        
                        // ★ data-keywords を追加
                        const keywords = [job.title, job.company].join(' ').toLowerCase();

                        // ★★★ [ここから修正] ★★★
                        // 未経験OKフラグ (「職種未経験OK」のみを判定)
                        const isExperienceOk = (job.job_experience_ok === 'OK');

                        // ★ ai-job-item クラスを追加
                        return `<div class="p-4 border rounded-lg mb-3 ai-job-item" 
                                     data-keywords="${keywords}"
                                     data-inexperienced-ok="${isExperienceOk}">
                                    <div class="flex items-start">
                                        <input type="checkbox" name="selected_job" value="${job.job_id}" class="mt-1 h-4 w-4 ai-job-checkbox">
                                        <div class="ml-4 flex-1">
                                            <h4 class="font-bold">${job.title}${expOkBadge}</h4>
                                            <p class="text-sm text-slate-600">${job.company}</p>
                                            <p class="text-xs text-slate-400 mt-1">求人ID: ${jobIdDisplay}</p>
                                            <p class="mt-2 text-sm text-gray-700 bg-gray-50 p-2 rounded-md">${shortDesc}</p>
                                        </div>
                                    </div>
                                </div>`
                    }).join('');

                    html += `</div>

                    </form>`;

                    $('#modal-content').html(html);

                } catch (e) {
                    $('#modal-content').html(`<p class="text-red-500">AI推薦の処理中にエラー: ${e}</p>`);
                }
            }

                        // ========================
                        // Event Listeners
                        // ========================
                        function initializeEvents() {
                            $(document).off();
                            // --- Auth ---

                            // initializeEvents 関数内 (末尾などに追加)

                            $(document).on('click', '#user-ai-matching-btn', async function() {
                                try {
                                    // バリデーションのために最新のプロファイル情報を取得
                                    const profile = await api.call('getMyProfile');
                                    CURRENT_USER = { ...CURRENT_USER, ...profile }; // ローカルのユーザー情報を更新

                                    const missing = [];
                                    // バックエンドのAIプロンプトで参照される項目をチェック
                                    if (!profile.desired_location) missing.push('希望勤務地'); //
                                    if (!profile.desired_job_type) missing.push('希望職種'); //
                                    
                                    // ▼▼▼ [ここから修正] ▼▼▼
                                    // 履歴書と職務経歴書の「いずれか」が登録されていればOK
                                    if (!profile.resume && !profile.work_history) {
                                        missing.push('履歴書 または 職務経歴書');
                                    }
                                    // ▲▲▲ [ここまで修正] ▲▲▲

                                    if (missing.length > 0) { //
                                        const message = `AIで求人を探すには、以下の項目の登録が必要です。「プロフィール編集」からご登録ください。\n\n- ${missing.join('\n- ')}`; //
                                        ui.showAlert('入力情報が不足しています', message); //
                                        return;
                                    }

                                    // バリデーション通過
                                    const userId = CURRENT_USER.user_id;
                                    const userName = CURRENT_USER.name;

                                    // ご指定の文言で待機画面を表示
                                    ui.showModal(
                                        `✨ ${userName}さんへのAIマッチング`, 
                                        '<div class="text-center"><div class="spinner w-8 h-8 mx-auto"></div><p class="mt-2 text-slate-600">AIがあなたに合う求人を分析中です。しばらくお待ちください...</p></div>', 
                                        { size: 'max-w-3xl', paddingClass: 'p-0' } // ★ paddingClass 追加
                                    );
                                    
                                    // 既存のAI推薦フロー（第1段階）を呼び出す
                                    await fetchAndRenderAiJobSelection(userId);

                                } catch (e) {
                                    ui.showAlert('エラー', `AIマッチングの準備に失敗しました: ${e}`);
                                }
                            });

                            $(document).on('submit', '#login-form', async e => {
                                e.preventDefault();
                                $('#login-error').text('');
                                try {
                                    const user = await api.call('login', [$('#email').val(), $('#password').val()]);
                                    CURRENT_USER = user;
                                    sessionStorage.setItem('jobAppUser', JSON.stringify(user));
                                    main();
                                } catch (err) {
                                    $('#login-error').text(err.toString());
                                }
                            });
                            $(document).on('submit', '#register-form', async e => {
                                                e.preventDefault();
                                                try {
                                                    await api.call('registerUser', [$('#register-name').val(), $('#register-email').val(), $('#register-password').val()]);
                                                    // ▼▼▼ 修正後の行 ▼▼▼
                                                    ui.showAlert('登録が完了しました', 'ログインページからログインしてください。');
                                                    // ▲▲▲ 修正後の行 ▲▲▲
                                                    ui.switchAuthForm('login');
                                                } catch (err) {
                                                    ui.showAlert('登録失敗', `登録に失敗: ${err}`);
                                                }
                                            });
                            $(document).on('submit', '#reset-form', async e => {
                                e.preventDefault();
                                const email = $('#reset-email').val();
                                try {
                                    await api.call('sendPasswordResetLink', [email]);
                                    ui.showAlert('メール送信完了', 'パスワード再設定用のリンクを記載したメールを送信しました。メールをご確認ください。');
                                } catch (err) {
                                    ui.showAlert('エラー', `処理に失敗しました: ${err}`);
                                }
                            });
                            $(document).on('submit', '#reset-password-form', async e => {
                                e.preventDefault();
                                const newPassword = $('#new-password').val();
                                const confirmPassword = $('#confirm-password').val();
                                const token = $('#reset-token-input').val();
                                $('#reset-password-error').text('');
                                if (newPassword !== confirmPassword) {
                                    $('#reset-password-error').text('パスワードが一致しません。');
                                    return;
                                }
                                try {
                                    await api.call('resetPassword', [token, newPassword]);
                                    ui.showAlert('更新完了', 'パスワードが更新されました。ログインページに戻ります。');
                                    const redirectToLogin = () => {
                                        ui.hideModal();
                                        window.location.href = window.location.pathname;
                                    };
                                    $('#modal-ok-btn').off('click').one('click', redirectToLogin);
                                    $('#modal-close-btn').off('click').one('click', redirectToLogin);
                                } catch (err) {
                                    $('#reset-password-error').text(`エラー: ${err}`);
                                }
                            });
                            $(document).on('click', '.auth-link', function(e) {
                                e.preventDefault();
                                ui.switchAuthForm($(this).data('form'));
                            });
                            $(document).on('click', '#logout-btn', () => {
                                sessionStorage.removeItem('jobAppUser');
                                location.reload();
                            });

                            // --- Modals & Navigation ---
                            $(document).on('click', '.sidebar-link', function(e) {
                                    e.preventDefault();
                                    ui.navigateTo($(this).data('page'));
                                });
                                $(document).on('click', '#modal-close-btn, #modal-ok-btn', ui.hideModal);
                                $(document).on('click', '#menu-toggle-btn', ui.toggleSidebar);
                                $(document).on('click', '#sidebar-overlay', ui.closeSidebar);

                            // --- Dashboard ---
                            $(document).on('click', '.card-link', function() {
                                const page = $(this).data('page');
                                if (page) {
                                    ui.navigateTo(page);
                                }
                            });
                            $(document).on('click', '.recommendation-feedback-btn', async function() {
                                const btn = $(this);
                                const recId = btn.data('rec-id');
                                const action = btn.data('action');
                                if (action === 'view') {
                                    showJobDetailsModal(btn.data('job-id'));
                                } else {
                                    try {
                                        await api.call('updateRecommendationStatus', [recId, action]);
                                        btn.closest('.recommendation-card').fadeOut(300, function() {
                                            $(this).remove();
                                        });
                                    } catch (e) {
                                        ui.showAlert('エラー', `操作に失敗: ${e}`);
                                    }
                                }
                            });

                            // --- Progress Page ---
                            function filterProgress() {
                                const searchTerm = $('#progress-keyword-search').val()?.toLowerCase() || '';
                                const activeStatus = $('#progress-page .filter-btn.bg-indigo-600').data('filter');

                                $('#progress-table-body tr').each(function() {
                                    const row = $(this);
                                    const keywords = row.data('keywords');
                                    const statusGroup = row.data('status-group');

                                    const keywordMatch = keywords.includes(searchTerm);
                                    const statusMatch = (activeStatus === 'all') || (statusGroup === activeStatus);

                                    if (keywordMatch && statusMatch) {
                                        row.show();
                                    } else {
                                        row.hide();
                                    }
                                });
                            }
                            $(document).on('input', '#progress-keyword-search', filterProgress);

                            $(document).on('click', '#progress-page .filter-btn', function() {
                                $('#progress-page .filter-btn').removeClass('bg-indigo-600 text-white').addClass('bg-slate-500 text-white');
                                $(this).removeClass('bg-slate-500 text-white').addClass('bg-indigo-600 text-white');
                                filterProgress();
                            });

                            $(document).on('click', '#progress-page .details-btn', function() {
                                const appId = $(this).data('id');
                                const app = ALL_APPLICATIONS.find(a => a.application_id === appId);
                                if (!app) return;
                                const content = `<div class="space-y-3">
                                        <p><strong>応募者:</strong> ${app.user_name}</p>
                                        <p><strong>企業名:</strong> ${app.company_name}</p>
                                        <p><strong>求人名:</strong> ${app.job_title}</p>
                                        <p><strong>ステータス:</strong> ${app.status}</p>
                                        <p><strong>志望度:</strong> ${app.aspiration_level || '未設定'}</p>
                                        <p><strong>面接希望日時:</strong></p>
                                        <div class="pl-4 text-slate-600">${(app.interview_dates || '').split(',').map(d => d.trim()).join('<br>') || '未設定'}</div>
                                        <p><strong>伝達事項:</strong></p>
                                        <div class="pl-4 text-slate-600 whitespace-pre-wrap bg-slate-50 p-2 rounded-md">${app.notes || 'なし'}</div>
                                        <p><strong>メモ (社内用):</strong></p>
                                        <div class="pl-4 text-slate-600 whitespace-pre-wrap bg-slate-50 p-2 rounded-md">${app.memo || 'なし'}</div>
                                    </div>`;
                                ui.showModal('応募詳細', content, {
                                    size: 'max-w-2xl'
                                });
                            });
                            $(document).on('click', '#progress-page .edit-status-btn', function() {
                                const appId = $(this).data('id');
                                const app = ALL_APPLICATIONS.find(a => a.application_id === appId);
                                if (!app) return;
                                const statusOptions = (MASTERS.application_status || []).map(s => `<option value="${s}" ${s === app.status ? 'selected' : ''}>${s}</option>`).join('');
                                let content = `<form id="update-status-form" data-id="${appId}">
                                <div><label for="new-status" class="block text-sm font-medium">新しいステータス</label><select id="new-status" class="mt-1 block w-full rounded-md border-slate-300">${statusOptions}</select></div>
                                <div class="mt-4"><label for="new-memo" class="block text-sm font-medium">メモ (社内用)</label><textarea id="new-memo" class="mt-1 block w-full rounded-md border-slate-300" rows="4">${app.memo || ''}</textarea></div>
                                <div class="mt-6 text-right"><button type="submit" class="font-bold py-2 px-4 rounded-lg bg-indigo-600 text-white">更新</button></div>
                            </form>`;
                                ui.showModal('ステータス更新', content);
                            });
                            $(document).on('submit', '#update-status-form', async function(e) {
                                e.preventDefault();
                                const appId = $(this).data('id');
                                const newStatus = $('#new-status').val();
                                const newMemo = $('#new-memo').val();
                                try {
                                    await api.call('updateApplicationStatus', [appId, newStatus, newMemo]);
                                    ui.hideModal();
                                    ui.showAlert('更新完了', 'ステータスを更新しました。');
                                    renderProgress();
                                } catch (err) {
                                    ui.showAlert('エラー', `更新に失敗しました: ${err}`);
                                }
                            });

                            // --- Job Search ---
                            $(document).on('click', '#job-search-btn', () => {
                                isFavoritesOnlySearch = false;
                                $('#job-search-favorites-btn').removeClass('bg-yellow-500').addClass('bg-yellow-400');
                                performSearch();
                            });
                            $(document).on('change', '#sort-select', performSearch);

                            $(document).on('click', '#job-search-reset-btn', () => {
                            // フィルターの状態をリセット
                            selectedIndustries = [];
                            selectedJobTypes = [];
                            selectedEmploymentTypes = [];
                            selectedLocations = [];
                            searchFreewords = [];
                            activeSearchTags = [];
                            isFavoritesOnlySearch = false;

                            // UIコンポーネントをリセット
                            $('#search-salary').val(300).trigger('input');
                            $('#search-job-exp').prop('checked', false);
                            $('#search-industry-exp').prop('checked', false);
                            $('.tag-badge').removeClass('bg-indigo-600 text-white').addClass('bg-slate-100 text-slate-600');
                            $('#job-search-favorites-btn').removeClass('bg-yellow-500').addClass('bg-yellow-400');

                            // マルチセレクトとフリーワード入力を再初期化して表示をクリア
                            multiSelect.create('industry-multi-select', MASTERS.industry || [], selectedIndustries, v => selectedIndustries = v);
                            multiSelect.create('job-type-multi-select', MASTERS.job_type || [], selectedJobTypes, v => selectedJobTypes = v);
                            multiSelect.create('employment-type-multi-select', EMPLOYMENT_TYPES, selectedEmploymentTypes, v => selectedEmploymentTypes = v);
                            multiSelect.create('location-multi-select', PREFECTURES, selectedLocations, v => selectedLocations = v);
                            freewordInput.create('search-freeword-input', searchFreewords, w => searchFreewords = w);

                            // リセットされた条件で検索を再実行
                            performSearch();
                            });
                            $(document).on('click', '#job-search-favorites-btn', function() {
                                isFavoritesOnlySearch = !isFavoritesOnlySearch;
                                $(this).toggleClass('bg-yellow-500 bg-yellow-400');
                                performSearch();
                            });
                            $(document).on('click', '#apply-desired-conditions-btn', async () => {
                                try {
                                    const profile = await api.call('getMyProfile');
                                    if (!profile) {
                                        ui.showAlert('エラー', 'プロファイル情報の取得に失敗しました。');
                                        return;
                                    }
                                    selectedIndustries = profile.desired_industry?.split(',').map(s => s.trim()).filter(Boolean) || [];
                                    selectedJobTypes = profile.desired_job_type?.split(',').map(s => s.trim()).filter(Boolean) || [];
                                    selectedEmploymentTypes = profile.desired_employment_type?.split(',').map(s => s.trim()).filter(Boolean) || [];
                                    selectedLocations = profile.desired_location?.split(',').map(s => s.trim()).filter(Boolean) || [];
                                    searchFreewords = profile.desired_freewords?.split(',').map(s => s.trim()).filter(Boolean) || [];
                                    const desiredSalary = parseInt(profile.desired_salary, 10) || 300;

                                    $('#search-salary').val(desiredSalary);
                                    $('#search-salary-value').text(desiredSalary);
                                    $('#search-job-exp').prop('checked', profile.desired_job_experience_ok || false);
                                    $('#search-industry-exp').prop('checked', profile.desired_industry_experience_ok || false);

                                    multiSelect.create('industry-multi-select', MASTERS.industry || [], selectedIndustries, v => selectedIndustries = v);
                                    multiSelect.create('job-type-multi-select', MASTERS.job_type || [], selectedJobTypes, v => selectedJobTypes = v);
                                    multiSelect.create('employment-type-multi-select', EMPLOYMENT_TYPES, selectedEmploymentTypes, v => selectedEmploymentTypes = v);
                                    multiSelect.create('location-multi-select', PREFECTURES, selectedLocations, v => selectedLocations = v);
                                    freewordInput.create('search-freeword-input', searchFreewords, w => searchFreewords = w);

                                    isFavoritesOnlySearch = false;
                                    performSearch();
                                } catch (e) {
                                    console.error("Failed to apply desired conditions:", e);
                                    ui.showAlert('エラー', `希望条件の適用に失敗しました: ${e}`);
                                }
                            });
                            $(document).on('click', '.tag-badge', function() {
                                $(this).toggleClass('bg-indigo-600 text-white bg-slate-100 text-slate-600');
                                activeSearchTags = $('.tag-badge.bg-indigo-600').map((i, el) => $(el).text()).get();
                                performSearch();
                            });
                            $(document).on('click', '#load-more-btn', () => {
                                currentJobPage++;
                                displayJobs();
                            });
                            $(document).on('input', '#search-salary', function() {
                                $('#search-salary-value').text($(this).val());
                            });

                            // --- MyPage ---
                            $(document).on('input', '#desired-salary', function() {
                                $('#desired-salary-value').text($(this).val());
                            });
                            $(document).on('submit', '#profile-form', async function(e) {
                                e.preventDefault();
                                const data = {};
                                $(this).serializeArray().forEach(item => data[item.name] = item.value);

                                // ▼▼▼ 変更箇所 ▼▼▼
                                // パスワード変更の処理を追加
                                const newPassword = $('#new_password').val();
                                const confirmPassword = $('#confirm_password').val();

                                // パスワードフィールドのどちらかに入力がある場合のみチェック
                                if (newPassword || confirmPassword) {
                                    if (newPassword !== confirmPassword) {
                                        ui.showAlert('入力エラー', '新しいパスワードが一致しません。');
                                        return; // 送信を中止
                                    }
                                    if (!newPassword) { // 確認用だけ入力されている場合
                                        ui.showAlert('入力エラー', '新しいパスワードを入力してください。');
                                        return; // 送信を中止
                                    }
                                    // パスワードが一致し、空でない場合は送信データに含める
                                    data.password = newPassword; // バックエンド側で 'password' というキーで受け取ることを想定
                                }
                                // 不要なフィールドは削除
                                delete data.new_password;
                                delete data.confirm_password;
                                // ▲▲▲ 変更箇所 ▲▲▲

                                if (data.age === '') {
                                    data.age = null;
                                }

                                data.desired_industry = desiredIndustries.join(',');
                                data.desired_job_type = desiredJobTypes.join(',');
                                data.desired_employment_type = desiredEmploymentTypes.join(',');
                                data.desired_location = desiredLocations.join(',');
                                data.desired_freewords = desiredFreewords.join(',');
                                data.desired_job_experience_ok = $('[name="desired_job_experience_ok"]').is(':checked');
                                data.desired_industry_experience_ok = $('[name="desired_industry_experience_ok"]').is(':checked');

                                try {
                                    await api.call('updateMyProfile', [data]);
                                    ui.showAlert('成功', 'プロフィールを更新しました。');
                                    // パスワード変更成功時は入力欄をクリア
                                    if (data.password) {
                                        $('#new_password').val('');
                                        $('#confirm_password').val('');
                                    }
                                } catch (e) {
                                    ui.showAlert('エラー', `プロフィールの更新に失敗しました: ${e}`);
                                }
                            });

                            // --- Job Management ---
                            $(document).on('input', '#job-management-search-input', function() {
                                const term = $(this).val().toLowerCase();
                                $('#job-list-body tr').each(function() {
                                    $(this).toggle($(this).text().toLowerCase().includes(term));
                                });
                            });
                            $(document).on('click', '#show-new-job-modal-btn, .edit-job-btn', function() {
                                const jobId = $(this).data('job-id');
                                const isEdit = !!jobId;
                                const job = isEdit ? ALL_JOBS.find(j => j.job_id === jobId) : {};
                                const industryOpts = (MASTERS.industry || []).map(i => `<option value="${i}" ${job.industrycategory === i ? 'selected' : ''}>${i}</option>`).join('');
                                const jobTypeOpts = (MASTERS.job_type || []).map(j => `<option value="${j}" ${job.jobcategory === j ? 'selected' : ''}>${j}</option>`).join('');
                                const content = `<form id="job-form"><input type="hidden" name="job_id" value="${job.job_id || ''}"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm">求人名</label><input name="title" class="mt-1 block w-full rounded-md border-slate-300" value="${job.title || ''}" required></div><div><label class="block text-sm">企業名</label><input name="company" class="mt-1 block w-full rounded-md border-slate-300" value="${job.company || ''}" required></div><div><label class="block text-sm">業種</label><select name="industrycategory" class="mt-1 block w-full rounded-md border-slate-300">${industryOpts}</select></div><div><label class="block text-sm">職種</label><select name="jobcategory" class="mt-1 block w-full rounded-md border-slate-300">${jobTypeOpts}</select></div></div><div class="mt-4"><div class="flex justify-between items-center"><label class="block text-sm">業務内容</label><button type="button" id="ai-generate-description-btn" class="text-sm text-indigo-600 hover:underline">✨ AIで作成</button></div><textarea name="description" rows="5" class="mt-1 block w-full rounded-md border-slate-300">${job.description || ''}</textarea></div><div class="mt-6 text-right"><button type="submit" class="font-bold py-2 px-4 rounded-lg bg-indigo-600 text-white">${isEdit ? '更新' : '登録'}</button></div></form>`;
                                ui.showModal(isEdit ? '求人編集' : '新規求人登録', content, {
                                    size: 'max-w-3xl'
                                });
                            });
                            $(document).on('submit', '#job-form', async function(e) {
                                e.preventDefault();
                                const data = {};
                                $(this).serializeArray().forEach(item => data[item.name] = item.value);
                                try {
                                    await api.call(data.job_id ? 'updateJob' : 'createNewJob', [data]);
                                    ui.hideModal();
                                    ui.showAlert('成功', `求人情報を${data.job_id ? '更新' : '登録'}しました。`);
                                    ALL_JOBS = []; // ★ この行を追加してキャッシュをクリア
                                    renderJobManagement();
                                } catch (err) {
                                    ui.showAlert('エラー', `処理に失敗: ${err}`);
                                }
                            });

                            // --- Job Details, Apply, Recommend, Favorite ---
                            $(document).on('click', '.job-details-btn', function() {
                                showJobDetailsModal($(this).data('job-id'));
                            });

                            $(document).on('click', '.job-apply-btn', function() {
                                const jobId = $(this).data('job-id');
                                const jobTitle = $('#modal-title').text();
                                const buttonBlock = `<div class="mb-4 pb-4 border-b text-right"><button type="submit" class="font-bold py-2 px-4 rounded-lg bg-indigo-600 text-white">この内容で応募する</button></div>`;
                                const content = `<form id="apply-form" data-job-id="${jobId}">
                                        ${buttonBlock}

                                        <p class="mb-4 text-lg font-semibold text-slate-800">${jobTitle || '応募求人'}</p>
                                        <div class="space-y-4">
                                            <div>
                                                <label class="block text-sm font-medium text-slate-700">志望度 <span class="text-red-500">*</span></label>
                                                <select id="aspiration-level" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                                                    <option value="">選択してください</option>
                                                    <option value="A">A: 第一志望群</option>
                                                    <option value="B">B: 第二志望群</option>
                                                    <option value="C">C: 第三志望群</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-slate-700">伝達事項</label>
                                                <textarea id="application-notes" rows="3" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm" placeholder="何か伝えておきたいことがあれば入力してください。"></textarea>
                                            </div>
                                            <hr class="my-4">
                                            <div>
                                                <p class="mb-2 text-sm font-medium text-slate-700">面接希望日時 (3つまで)</p>
                                                ${[1,2,3].map(i => `<div class="mb-2"><label class="block text-xs text-slate-600">希望日時 ${i}</label><input type="datetime-local" class="mt-1 block w-full rounded-md border-slate-300 interview-date"></div>`).join('')}
                                            </div>
                                        </div>
                                    </form>`;
                                ui.showModal('応募内容の確認', content);
                            });

                            $(document).on('submit', '#apply-form', async function(e) {
                                e.preventDefault();
                                const jobId = $(this).data('job-id');
                                const recId = $(this).data('rec-id'); // ▼▼▼ 変更：rec-idを取得
                                const targetUserId = $(this).data('target-user-id') || null; // ★★★ 追加: 代理応募対象IDを取得 ★★★
                                const dates = $('.interview-date').map((i, el) => $(el).val()).get().filter(Boolean);
                                const notes = $('#application-notes').val();
                                const aspirationLevel = $('#aspiration-level').val();

                                if (!aspirationLevel) {
                                    ui.showAlert('必須入力です', '志望度を選択してください。');
                                    return;
                                }

                                try {
                                    // ★★★ 変更: targetUserId をAPI呼び出しに追加 ★★★
                                    await api.call('applyForJob', [jobId, dates, notes, aspirationLevel, targetUserId]);
                                    
                                    // ▼▼▼ 新規追加（応募と同時に推薦ステータスも更新）▼▼▼
                                    if (recId) { 
                                        await api.call('updateRecommendationStatus', [recId, 'applied']);
                                        // Update the row in the UI
                                        const row = $(`.recommendation-check-item[data-rec-id="${recId}"]`).closest('tr');
                                        row.addClass('bg-green-50'); 
                                        row.find('.status-badge').html(`<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-700">応募済み</span>`);
                                        // ★★★ 変更: 代理応募ボタンも削除対象に ★★★
                                        row.find('.recommendation-list-reject-btn, .recommendation-list-apply-btn, .manager-apply-single-btn').remove();
                                        row.find('.recommendation-check-item').prop('checked', false).prop('disabled', true);
                                        syncHeaderCheckbox();
                                    }
                                    // ▲▲▲ 新規追加 ▲▲▲

                                    ui.hideModal();
                                    // ★★★ 変更: メッセージを分岐 ★★★
                                    const message = targetUserId ? '代理応募を受け付けました。' : '求人への応募を受け付けました。「応募・選考状況」ページで確認できます。';
                                    ui.showAlert('応募完了', message);
                                    renderProgress(); // 進捗管理ページも更新
                                } catch (e) {
                                    ui.showAlert('応募に失敗しました。', `応募処理に失敗: ${e}`);
                                }
                            });

                            $(document).on('click', '.job-recommend-btn', async function() {
                                const jobId = $(this).data('job-id');
                                // ★ 1. 現在のモーダル（求人詳細）のタイトルを取得
                                const jobTitle = $('#modal-title').text();
                                try {
                                    const allUsers = await api.call('getAllUsers');
                                    const availableUsers = allUsers.filter(u => u.role === 'user');

                                    if (availableUsers.length === 0) {
                                        ui.showAlert('紹介対象なし', '紹介できる対象ユーザーがいません。');
                                        return;
                                    }

                                    const userOpts = availableUsers.map(u => `<option value="${u.user_id}">${u.name}</option>`).join('');
                                    const buttonBlock = `<div class="mb-4 pb-4 border-b text-right"><button type="submit" class="font-bold py-2 px-4 rounded-lg bg-indigo-600 text-white">紹介する</button></div>`;
                                    
                                    // ▼▼▼ content 変数をこちらに修正 ▼▼▼
                                    const content = `<form id="recommend-form" data-job-id="${jobId}">
                                            ${buttonBlock} 
                                            <p class="mb-4 text-lg font-semibold text-slate-800">${jobTitle || '紹介求人'}</p>
                                            <p class="mb-4">紹介する求職者を選択し、おすすめ理由を記入してください。</p>
                                            <div>
                                                <label class="block text-sm">求職者</label>
                                                <select name="targetUserId" class="mt-1 block w-full rounded-md border-slate-300">${userOpts}</select>
                                            </div>

                                            <div class="mt-4">
                                                <div class="flex justify-between items-center">
                                                    <label class="block text-sm font-medium text-slate-700">おすすめ理由</label>
                                                    <button type="button" id="ai-generate-reason-btn" class="text-sm font-bold py-1 px-3 rounded-lg shadow-md bg-cyan-500 hover:bg-cyan-600 text-white">✨ おすすめ理由生成</button>
                                                </div>
                                                <textarea name="recommendation_reason" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm" rows="4" placeholder="このユーザーになぜこの求人が合うのか、理由を記入してください。この内容は通知メールに記載されます。" required></textarea>
                                            </div>


                                        </form>`;
                                    // ▲▲▲ 修正ここまで ▲▲▲

                                    ui.showModal('求人を紹介', content);
                                } catch (e) {
                                    ui.showAlert('エラー', `ユーザーの読込に失敗: ${e}`);
                                }
                            });
                            $(document).on('submit', '#recommend-form', async function(e) {
                                e.preventDefault();
                                const jobId = $(this).data('job-id');
                                const userId = $(this).find('[name=targetUserId]').val();
                                const reason = $(this).find('[name=recommendation_reason]').val();
                                try {
                                    await api.call('recommendJobToUser', [userId, jobId, reason]);
                                    ui.hideModal();
                                    ui.showAlert('成功', '求人を紹介しました。');
                                } catch (e) {
                                    ui.showAlert('エラー', `紹介に失敗: ${e}`);
                                }
                            });
                            $(document).on('click', '.favorite-btn', async function() {
                                const btn = $(this);
                                const jobId = btn.data('job-id');
                                try {
                                    const res = await api.call('toggleFavoriteJob', [jobId]);
                                    btn.toggleClass('text-yellow-400 text-slate-400').find('i').toggleClass('fas far');
                                    if (res.favorited) {
                                        FAVORITE_JOB_IDS.push(jobId);
                                    } else {
                                        FAVORITE_JOB_IDS = FAVORITE_JOB_IDS.filter(id => id !== jobId);
                                    }
                                } catch (e) {
                                    ui.showAlert('エラー', `お気に入り操作に失敗: ${e}`);
                                }
                            });

                            // --- Recommendations List ---
                            $(document).on('click', '.recommendation-list-reject-btn', async function() {
                                const btn = $(this);
                                const recId = btn.data('rec-id');
                                const row = btn.closest('tr');
                                try {
                                    await api.call('updateRecommendationStatus', [recId, 'rejected']);
                                    row.addClass('bg-slate-100 text-slate-500');
                                    row.find('.font-medium').removeClass('text-slate-800');
                                    row.find('.status-badge').html(`<span class="px-2 py-1 text-xs font-semibold rounded-full bg-slate-100 text-slate-600">見送り</span>`);
                                    row.parent().append(row);
                                    btn.remove();
                                } catch (e) {
                                    ui.showAlert('エラー', `操作に失敗しました: ${e}`);
                                }
                            });

                            function filterRecommendations() {
                                const searchTerm = $('#recommendation-keyword-search').val().toLowerCase();
                                const activeStatus = $('#recommendation-status-filter .bg-indigo-600').data('status');

                                $('#recommendations-table-body .recommendation-row').each(function() {
                                    const row = $(this);
                                    const keywords = row.data('keywords');
                                    const status = row.data('status'); // 'pending', 'applied', 'rejected', 'excluded' など

                                    const keywordMatch = keywords.includes(searchTerm);

                                    let statusMatch = false;
                                    if (activeStatus === 'all') {
                                        // 「すべて」の時は 'excluded' 以外を表示
                                        statusMatch = (status !== 'excluded');
                                    } else {
                                        // それ以外の時は該当ステータスのみ表示
                                        statusMatch = (status === activeStatus);
                                    }

                                    if (keywordMatch && statusMatch) {
                                        row.show();
                                    } else {
                                        row.hide();
                                    }
                                });
                                syncHeaderCheckbox();
                            }
                            $(document).on('input', '#recommendation-keyword-search', filterRecommendations);
                            $(document).on('click', '.rec-status-filter-btn', function() {
                                $('.rec-status-filter-btn').removeClass('bg-indigo-600 text-white').addClass('bg-slate-500 text-white');
                                $(this).removeClass('bg-slate-500').addClass('bg-indigo-600');
                                filterRecommendations();
                            });


                            // --- User Management ---
                            $(document).on('input', '#user-search-input', function() {
                                const term = $(this).val().toLowerCase();
                                $('#user-list-body tr').each(function() {
                                    $(this).toggle($(this).text().toLowerCase().includes(term));
                                });
                            });
                            $(document).on('click', '#show-new-user-modal-btn, .edit-user-btn', async function() {
                                try {
                                    if (!MASTERS.industry) {
                                        const {
                                            masters
                                        } = await api.call('getJobsAndMasters');
                                        MASTERS = { ...MASTERS,
                                            ...masters
                                        };
                                    }
                                    const userId = $(this).data('user-id');
                                    const isEdit = !!userId;
                                    const user = isEdit ? ALL_USERS.find(u => u.user_id === userId) : {};
                                    if (isEdit && !user) return ui.showAlert('エラー', 'ユーザーが見つかりません。');
                                    const coaches = ALL_USERS.filter(u => u.role === 'coach' && u.user_id !== userId);
                                    const coachOpts = coaches.map(c => `<option value="${c.user_id}" ${c.user_id === user.coach_id ? 'selected' : ''}>${c.name}</option>`).join('');
                                    const driveUrlButton = user.drive_folder_url ? `<div class="mt-2"><a href="${user.drive_folder_url}" target="_blank" class="font-bold py-2 px-4 rounded-lg shadow-md inline-block bg-blue-500 hover:bg-blue-600 text-white"><i class="fab fa-google-drive mr-2"></i>Google Driveを開く</a></div>` : '';
                                    const lineUrlButton = user.line_url ? `<div class="mt-2"><a href="${user.line_url}" target="_blank" class="font-bold py-2 px-4 rounded-lg shadow-md inline-block bg-green-500 hover:bg-green-600 text-white"><i class="fab fa-line mr-2"></i>LINEで開く</a></div>` : '';
                                    const notebooklmUrlButton = user.notebooklm_url ? `<div class="mt-2"><a href="${user.notebooklm_url}" target="_blank" class="font-bold py-2 px-4 rounded-lg shadow-md inline-block bg-orange-500 hover:bg-orange-600 text-white"><i class="fas fa-book-open mr-2"></i>NotebookLMを開く</a></div>` : '';

                                    if (isEdit) {
                                        editedDesiredIndustries = user.desired_industry?.split(',').map(s => s.trim()).filter(Boolean) || [];
                                        editedDesiredJobTypes = user.desired_job_type?.split(',').map(s => s.trim()).filter(Boolean) || [];
                                        editedDesiredEmploymentTypes = user.desired_employment_type?.split(',').map(s => s.trim()).filter(Boolean) || [];
                                        editedDesiredLocations = user.desired_location?.split(',').map(s => s.trim()).filter(Boolean) || [];
                                        editedDesiredFreewords = user.desired_freewords?.split(',').map(s => s.trim()).filter(Boolean) || [];
                                    } else {
                                        [editedDesiredIndustries, editedDesiredJobTypes, editedDesiredEmploymentTypes, editedDesiredLocations, editedDesiredFreewords] = [
                                            [],
                                            [],
                                            [],
                                            [],
                                            []
                                        ];
                                    }
                                    const content = `<form id="user-form">
                                        <input type="hidden" name="user_id" value="${user.user_id || ''}">
                                        <div class="space-y-4">
                                            <div><label class="block text-sm font-medium text-slate-700">氏名</label><input name="name" type="text" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm" value="${user.name || ''}" required></div>
                                            <div><label class="block text-sm font-medium text-slate-700">年齢</label><input name="age" type="number" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm" value="${user.age || ''}"></div>
                                            <div><label class="block text-sm font-medium text-slate-700">メールアドレス</label><input name="email" type="email" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm" value="${user.email || ''}" required></div>
                                            <div><label class="block text-sm font-medium text-slate-700">パスワード ${isEdit ? '(変更する場合のみ入力)' : ''}</label><input name="password" type="password" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm"></div>
                                            <div><label class="block text-sm font-medium text-slate-700">役割</label><select name="role" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm"><option value="user" ${user.role === 'user' ? 'selected' : ''}>user</option><option value="coach" ${user.role === 'coach' ? 'selected' : ''}>coach</option><option value="admin" ${user.role === 'admin' ? 'selected' : ''}>admin</option></select></div>
                                            <div><label class="block text-sm font-medium text-slate-700">担当コーチ</label><select name="coach_id" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm"><option value="">なし</option>${coachOpts}</select></div>
                                            <div><label class="block text-sm font-medium text-slate-700">Google Drive URL</label><input name="drive_folder_url" type="url" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm" value="${user.drive_folder_url || ''}">${driveUrlButton}</div>
                                            <div><label class="block text-sm font-medium text-slate-700">LINE URL</label><input name="line_url" type="url" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm" value="${user.line_url || ''}">${lineUrlButton}</div>
                                            <div><label class="block text-sm font-medium text-slate-700">NotebookLM URL</label><input name="notebooklm_url" type="url" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm" value="${user.notebooklm_url || ''}">${notebooklmUrlButton}</div>
                                        </div>
                                        <div class="mt-6 pt-4 border-t">
                                            <h4 class="text-lg font-semibold text-slate-700 mb-4">希望条件</h4>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div><label class="block text-sm font-medium text-slate-700">希望業種</label><div id="edit-user-desired-industry"></div></div>
                                                <div><label class="block text-sm font-medium text-slate-700">希望職種</label><div id="edit-user-desired-job-type"></div></div>
                                                <div><label class="block text-sm font-medium text-slate-700">希望勤務形態</label><div id="edit-user-desired-employment-type"></div></div>
                                                <div><label class="block text-sm font-medium text-slate-700">希望勤務地</label><div id="edit-user-desired-location"></div></div>
                                                <div class="col-span-2"><label class="block text-sm font-medium text-slate-700">希望年収</label><input name="desired_salary" type="text" placeholder="例: 500万円" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm" value="${user.desired_salary || ''}"></div>
                                                <div class="col-span-2"><label class="block text-sm font-medium text-slate-700">希望フリーワード</label><div id="edit-user-desired-freewords"></div></div>
                                            </div>
                                        </div>
                                        <div class="mt-4"><label class="block text-sm font-medium text-slate-700">自己PR・スキル等</label><textarea name="notes" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm" rows="5">${user.notes || ''}</textarea></div>
                                        <div class="mt-4"><label class="block text-sm font-medium text-slate-700">履歴書 (テキスト)</label><textarea name="resume" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm" rows="8">${user.resume || ''}</textarea></div>
                                        <div class="mt-4"><label class="block text-sm font-medium text-slate-700">職務経歴書 (テキスト)</label><textarea name="work_history" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm" rows="12">${user.work_history || ''}</textarea></div>
                                        <div class="mt-6 text-right"><button type="submit" class="font-bold py-2 px-4 rounded-lg bg-indigo-600 text-white">${isEdit ? '更新' : '登録'}</button></div>
                                    </form>`;
                                    ui.showModal(isEdit ? 'ユーザー編集' : '新規ユーザー登録', content, {
                                        size: 'max-w-3xl'
                                    });
                                    multiSelect.create('edit-user-desired-industry', MASTERS.industry || [], editedDesiredIndustries, v => editedDesiredIndustries = v);
                                    multiSelect.create('edit-user-desired-job-type', MASTERS.job_type || [], editedDesiredJobTypes, v => editedDesiredJobTypes = v);
                                    multiSelect.create('edit-user-desired-employment-type', EMPLOYMENT_TYPES, editedDesiredEmploymentTypes, v => editedDesiredEmploymentTypes = v);
                                    multiSelect.create('edit-user-desired-location', PREFECTURES, editedDesiredLocations, v => editedDesiredLocations = v);
                                    freewordInput.create('edit-user-desired-freewords', editedDesiredFreewords, w => editedDesiredFreewords = w);
                                } catch (e) {
                                    ui.showAlert('エラー', `編集画面の準備に失敗しました: ${e}`);
                                }
                            });
                            $(document).on('submit', '#user-form', async function(e) {
                                e.preventDefault();
                                const data = {};
                                $(this).serializeArray().forEach(item => data[item.name] = item.value);

                                if (data.age === '') {
                                    data.age = null;
                                }

                                data.desired_industry = editedDesiredIndustries.join(',');
                                data.desired_job_type = editedDesiredJobTypes.join(',');
                                data.desired_employment_type = editedDesiredEmploymentTypes.join(',');
                                data.desired_location = editedDesiredLocations.join(',');
                                data.desired_freewords = editedDesiredFreewords.join(',');
                                try {
                                    const action = data.user_id ? 'adminUpdateUser' : 'adminCreateUser';
                                    if (!data.user_id && !data.password) return ui.showAlert('入力エラー', '新規登録にはパスワードが必要です。');
                                    await api.call(action, [data]);
                                    ui.hideModal();
                                    ui.showAlert('成功', `ユーザー情報を${data.user_id ? '更新' : '登録'}しました。`);
                                    renderUserManagement();
                                } catch (e) {
                                    ui.showAlert('エラー', `処理に失敗しました: ${e}`);
                                }
                            });

                            // ========================
                            // --- AI Features (★ 10/23 大幅変更) ---
                            // ========================

                            // (変更なし)
                            $(document).on('click', '#ai-generate-description-btn', async function() {
                                const form = $(this).closest('form');
                                const title = form.find('[name="title"]').val();
                                const company = form.find('[name="company"]').val();
                                if (!title || !company) {
                                    ui.showAlert('情報不足', '「求人名」と「企業名」を入力してください。');
                                    return;
                                }
                                const btn = $(this);
                                btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>生成中...');
                                try {
                                    const result = await api.call('generateAIDescription', [title, company]);
                                    form.find('[name="description"]').val(result);
                                } catch (e) {
                                    ui.showAlert('AIエラー', `生成に失敗: ${e}`);
                                } finally {
                                    btn.prop('disabled', false).html('✨ AIで作成');
                                }
                            });

                            // (変更なし)
                            $(document).on('click', '.ai-match-analysis-btn', async function() {
                                const jobId = $(this).data('job-id');
                                ui.showModal('✨ AIマッチ度をチェック', '<div class="text-center"><div class="spinner w-8 h-8 mx-auto"></div><p class="mt-2 text-slate-600">AIが分析中です...</p></div>', {
                                    size: 'max-w-3xl'
                                });
                                try {
                                    const profile = await api.call('getMyProfile');
                                    const analysisPayload = {
                                        age: profile.age || '',
                                        desired_salary: profile.desired_salary || '',
                                        desired_job_experience_ok: profile.desired_job_experience_ok || false,
                                        desired_industry_experience_ok: profile.desired_industry_experience_ok || false
                                    };
                                    const result = await api.call('generateAIMatchAnalysis', [jobId, analysisPayload]);
                                    const recommendation = ALL_RECOMMENDATIONS.find(rec => rec.job_id === jobId && rec.ai_score);
                                    let scoreHtml = '';
                                    let analysisText = result;
                                    if (recommendation) {
                                        scoreHtml = `<div class="bg-indigo-50 p-4 mb-6 rounded-lg"><h3 class="font-medium text-indigo-700">AIマッチ度</h3><p class="text-4xl font-bold text-indigo-600 mt-1">${recommendation.ai_score}<span class="text-lg ml-1">点</span></p></div>`;
                                        analysisText = result.replace(/総合評価:\s*\d+点\n*/, '');
                                    } else {
                                        const scoreMatch = result.match(/総合評価:\s*(\d+)/);
                                        if (scoreMatch) {
                                            scoreHtml = `<div class="bg-indigo-50 p-4 mb-6 rounded-lg"><h3 class="font-medium text-indigo-700">総合評価</h3><p class="text-4xl font-bold text-indigo-600 mt-1">${scoreMatch[1]}<span class="text-lg ml-1">点</span></p></div>`;
                                            analysisText = result.replace(/総合評価:\s*\d+点\n*/, '');
                                        }
                                    }
                                    const disclaimer = '<p class="text-sm text-slate-500 mb-4 border-b pb-4">※AIによる分析結果は、参考情報としてご活用ください。</p>';
                                    const formatAnalysis = (rawText) => {
                                        let html = '<div class="space-y-4">';
                                        const sections = rawText.split('## ').slice(1);
                                        if (sections.length > 0) {
                                            sections.forEach(section => {
                                                const parts = section.split('\n');
                                                const title = parts.shift().trim();
                                                const content = parts.join('\n').trim();
                                                if (title && content) {
                                                    html += `
                                                    <div class="bg-slate-50 rounded-lg p-4">
                                                        <h4 class="font-bold text-slate-700 mb-2">${title}</h4>
                                                        <div class="prose prose-sm max-w-none">${marked.parse(content)}</div>
                                                    </div>
                                                `;
                                                }
                                            });
                                        } else {
                                            html += `<div class="prose prose-sm max-w-none">${marked.parse(rawText)}</div>`;
                                        }
                                        html += '</div>';
                                        return html;
                                    };
                                    const finalHtml = disclaimer + scoreHtml + formatAnalysis(analysisText);
                                    $('#modal-content').html(finalHtml);
                                } catch (e) {
                                    $('#modal-content').html(`<p class="text-red-500">分析に失敗: ${e}</p>`);
                                }
                            });

                            // (変更なし)
                            $(document).on('click', '#ai-generate-reason-btn', async function() {
                                const btn = $(this);
                                const form = btn.closest('form');
                                const jobId = form.data('job-id');
                                const userId = form.find('[name=targetUserId]').val();

                                if (!userId) {
                                    ui.showAlert('求職者未選択', 'おすすめ理由を生成するには、まず求職者を選択してください。');
                                    return;
                                }

                                btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>生成中...');

                                try {
                                    const reason = await api.call('generateAIRecommendationReason', [jobId, userId]);
                                    form.find('[name=recommendation_reason]').val(reason).trigger('input');
                                } catch (e) {
                                    ui.showAlert('AIエラー', `理由の生成に失敗しました: ${e}`);
                                } finally {
                                    btn.prop('disabled', false).html('✨ AIが推薦理由を作成');
                                }
                            });

                            // --- 診断結果 ---
                            $(document).on('click', '.view-diagnosis-btn', function() {
                                const userId = $(this).data('user-id');
                                const userName = $(this).data('user-name');
                                ui.navigateTo('diagnosis', { userId: userId, userName: userName });
                            });


                            // ★ 10/23 追加(10/26 変更): AI推薦モーダル内のチェックボックス上限(10件)を監視 + ヘッダ同期
                            $(document).on('change', '.ai-job-checkbox', function() {
                                const maxChecks = 10;
                                const checkedCount = $('.ai-job-checkbox:checked').length;
                                if (checkedCount > maxChecks) {
                                  $(this).prop('checked', false);
                                  notifyInModal(`一度にスコアリングまたは除外できるのは${maxChecks}件までです。`);
                                }
                            
                            });

                            // ★ 10/23 変更: AI推薦モーダルを開く (第1段階)
                            $(document).on('click', '.ai-recommend-btn', async function() {
                                const userId = $(this).data('user-id');
                                const user = ALL_USERS.find(u => u.user_id === userId);
                                if (!user) return ui.showAlert('エラー', '対象ユーザーが見つかりません。');

                                // モーダルをまず開く
                                ui.showModal(`✨ ${user.name}さんへのAI推薦`, '<div class="text-center"><div class="spinner w-8 h-8 mx-auto"></div><p class="mt-2 text-slate-600">AIが分析中です...</p></div>', {
                                    size: 'max-w-3xl', paddingClass: 'p-0' // ★ paddingClass 追加
                                });

                                // ヘルパー関数を呼び出して中身を描画
                                await fetchAndRenderAiJobSelection(userId);
                            });

                            // ★ 10/23 追加: AIスコアリング実行ボタン (第2段階へ)
                            $(document).on('click', '#ai-score-btn', async function() {
                                const form = $(this).closest('form');
                                const userId = form.data('user-id');
                                const jobIds = form.find('input[name="selected_job"]:checked').map(function() {
                                  return $(this).val();
                                }).get();

                                if (jobIds.length === 0) {
                                    return ui.showAlert('選択エラー', 'スコアリングする求人を1つ以上選択してください。');
                                }
                                if (jobIds.length > 10) {
                                     return ui.showAlert('選択上限', `一度にスコアリングできるのは10件までです。現在 ${jobIds.length} 件選択されています。`);
                                }

                                // ローディング表示
                                // $(document).on('click', '#ai-score-btn', ... 内
                                // [変更前]
                                // $('#modal-content').html('<div class="text-center"><div class="spinner w-8 h-8 mx-auto"></div><p class="mt-2 text-slate-600">AIがスコアリング中です...</p></div>');
                                // [変更後]
                                $('#modal-content').html('<div class="text-center"><div class="spinner w-8 h-8 mx-auto"></div><p class="mt-2 text-slate-600">AIがマッチングしています、数分程度おまちください...</p></div>');
                                try {
                                    // GASのscoreAIRecommendationsを呼び出し
                                    const scoredJobs = await api.call('scoreAIRecommendations', [userId, jobIds]);

                                    // ★ ボタンブロックのHTMLを先に定義 (mt-6 を mb-4 に変更)
                                    const buttonBlockHtml = `<div class="mb-4 text-right space-x-2">
                                                    <button type="button" id="ai-back-to-list-btn" class="font-bold py-2 px-4 rounded-lg bg-slate-500 text-white">戻る</button>
                                                    ${CURRENT_USER.role !== 'user' ? `<button type="button" id="ai-exclude-scored-btn" class="font-bold py-2 px-4 rounded-lg bg-red-600 hover:bg-red-700 text-white">選択した求人を除外</button>` : ''}
                                                    <button type="submit" class="font-bold py-2 px-4 rounded-lg bg-indigo-600 text-white">選択した求人を保存</button>
                                                 </div>`;

                                    const jobsToDisplay = [];
                                    const jobsToAutoExclude = [];

                                    // 49点以下を自動除外、50点以上とエラー（スコアが数値でない場合）を表示対象に振り分け
                                    scoredJobs.forEach(job => {
                                        const score = job.score;
                                        if (typeof score === 'number' && !isNaN(score) && score <= 49) {
                                            jobsToAutoExclude.push(job);
                                        } else {
                                            jobsToDisplay.push(job);
                                        }
                                    });

                                    let autoExcludeMessage = '';
                                    // 自動除外対象がある場合、バックグラウンドで除外処理
                                    if (jobsToAutoExclude.length > 0) {
                                        const jobIdsToExclude = jobsToAutoExclude.map(j => j.job_id);
                                        try {
                                            // バックグラウンドで自動除外を実行 (UIはブロックしない)
                                            api.call('excludeAIRecommendations', [userId, jobIdsToExclude]);
                                            // ユーザーへの通知メッセージを生成
                                            autoExcludeMessage = `<div class="mb-3 text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded px-3 py-2">${jobsToAutoExclude.length}件の求人 (スコア49点以下) が自動的に除外されました。</div>`;
                                        } catch (excludeErr) {
                                            console.error("Auto-exclude failed:", excludeErr);
                                            // 除外に失敗しても、とりあえずUIは進める
                                            autoExcludeMessage = `<div class="mb-3 text-sm text-red-700 bg-red-50 border border-red-200 rounded px-3 py-2">${jobsToAutoExclude.length}件の求人の自動除外に失敗しました。</div>`;
                                        }
                                    }

                                    // 50点以上の求人がない場合の表示
                                    if (jobsToDisplay.length === 0) {
                                        $('#modal-content').html(
                                            autoExcludeMessage + // 自動除外があった場合はそのメッセージを表示
                                            '<p class="text-center text-slate-500 py-8">スコア50点以上の求人はありませんでした。</p>' +
                                            '<div class="mt-4 text-right"><button type="button" id="ai-back-to-list-btn" class="font-bold py-2 px-4 rounded-lg bg-slate-500 text-white">戻る</button></div>'
                                        );
                                        return; // UI構築をここで終了
                                    }

                                    // スコアリング結果表示用のHTMLを生成
                                    let scoredHtml = `<form id="ai-save-form" data-user-id="${userId}">
                                        ${autoExcludeMessage} 
                                        <div class="flex items-center justify-between mb-3">
                                            <p class="text-sm text-slate-600">スコアリングが完了しました。保存または除外する求人を選択してください。</p>
                                        </div>
                                        ${buttonBlockHtml}
                                        <div class="max-h-[60vh] overflow-y-auto pr-2">`;

                                    // スコア順にソート (エラーは最下部へ)
                                    jobsToDisplay.sort((a, b) => {
                                        const scoreA = (typeof a.score === 'number' && !isNaN(a.score)) ? a.score : -Infinity;
                                        const scoreB = (typeof b.score === 'number' && !isNaN(b.score)) ? b.score : -Infinity;
                                        return scoreB - scoreA;
                                    });

                                    // 表示対象の求人のみを描画

                                    // ★★★ ここから置き換え (11/15 修正) ★★★
                                    scoredHtml += jobsToDisplay.map(job => {
                                        const jobIdDisplay = String(job.job_id).startsWith('http') ? `<a href="${job.job_id}" target="_blank" class="text-indigo-600 hover:underline">${job.job_id} <i class="fas fa-external-link-alt text-xs"></i></a>` : (job.job_id || 'N/A');
                                        
                                        // --- 1. 現行スコア ---
                                        const isError = (typeof job.score !== 'number' || isNaN(job.score));
                                        const scoreDisplay = isError
                                            ? `<span class="text-lg font-bold text-red-600">分析エラー</span>`
                                            : `<span class="text-lg font-bold text-indigo-600">${job.score}点</span>`;
                                        const reasonClass = isError ? 'bg-red-50 text-red-700' : 'bg-slate-50 text-slate-700';

                                        // --- 2. 社風スコア (A-E評価) ---
                                        const cultureRating = job.culture_rating || "N/A"; // ★
                                        const cultureReason = job.culture_reason || "分析エラー";
                                        let cultureDisplayHtml = '';
                                        let cultureScoreDisplay = ''; // ★

                                        let cultureReasonClass = 'bg-sky-50 text-sky-700'; // デフォルト (A, B)
                                        let ratingColorClass = 'text-sky-600'; // A, B
                                        
                                        // cultureRating の値に基づいて表示を決定
                                        if (cultureRating === 'A' || cultureRating === 'B') {
                                            // (デフォルトのまま)
                                            cultureScoreDisplay = `<span class="text-3xl font-bold ${ratingColorClass}">${cultureRating}</span>`;

                                        } else if (cultureRating === 'C') {
                                            cultureReasonClass = 'bg-gray-100 text-gray-600';
                                            ratingColorClass = 'text-gray-600';
                                            cultureScoreDisplay = `<span class="text-3xl font-bold ${ratingColorClass}">${cultureRating}</span>`;

                                        } else if (cultureRating === 'D' || cultureRating === 'E') {
                                            cultureReasonClass = 'bg-yellow-50 text-yellow-700';
                                            ratingColorClass = 'text-yellow-700';
                                            cultureScoreDisplay = `<span class="text-3xl font-bold ${ratingColorClass}">${cultureRating}</span>`;
                                        
                                        } else {
                                            // "N/A" または想定外の値の場合
                                            // cultureReason に基づいて表示を決定
                                            
                                            if (cultureReason.includes('未評価')) { // 50点未満
                                                cultureReasonClass = 'bg-gray-100 text-gray-500';
                                                ratingColorClass = 'text-gray-500';
                                                cultureScoreDisplay = `<span class="text-lg font-bold ${ratingColorClass}">未評価</span>`; // ★
                                            
                                            } else if (cultureReason.includes('企業情報なし')) { // company_infoなし
                                                cultureReasonClass = 'bg-yellow-50 text-yellow-700';
                                                ratingColorClass = 'text-yellow-700';
                                                // ★★★ 要望された表示 ★★★
                                                cultureScoreDisplay = `<span class="text-lg font-bold ${ratingColorClass}">企業情報なし</span>`; 
                                            
                                            } else { // (失敗/未実行など)
                                                cultureReasonClass = 'bg-red-50 text-red-700'; // APIエラー
                                                ratingColorClass = 'text-red-600';
                                                cultureScoreDisplay = `<span class="text-lg font-bold ${ratingColorClass}">エラー</span>`; // ★
                                            }
                                        }
                                        // ★★★ [ここまで修正] ★★★

                                        cultureDisplayHtml = `
                                            <div class="mt-3 pt-3 border-t border-slate-200">
                                                <div class="flex justify-between items-center">
                                                    <h5 class="font-semibold text-sm text-sky-700">社風・カルチャー分析</h5>
                                                    ${cultureScoreDisplay}
                                                </div>
                                                <p class="mt-1 text-sm ${cultureReasonClass} p-2 rounded">${cultureReason}</p>
                                            </div>
                                        `;

                                        // --- 3. チェックボックス (data属性を rating に変更) ---
                                        const checkboxHtml = `<input type="checkbox" name="selected_job" value="${job.job_id}" class="mt-1 h-4 w-4" 
                                                       ${isError ? 'disabled' : 'checked'}
                                                       data-reason="${encodeURIComponent(job.reason)}" 
                                                       data-score="${job.score || 0}"
                                                       data-culture-reason="${encodeURIComponent(cultureReason)}"
                                                       data-culture-rating="${cultureRating}">`; // ★

                                        // --- 4. 描画 ---
                                        return `<div class="p-4 border rounded-lg mb-3">
                                            <div class="flex items-start">
                                                ${checkboxHtml}
                                                <div class="ml-4 flex-1">
                                                    <div class="flex justify-between items-center">
                                                        <div>
                                                            <h4 class="font-bold">${job.title}</h4>
                                                            <p class="text-sm text-slate-600">${job.company}</p>
                                                            <p class="text-xs text-slate-400 mt-1">求人ID: ${jobIdDisplay}</p>
                                                        </div>
                                                        <div class="text-right">
                                                            <h5 class="font-semibold text-sm text-indigo-700">経験・スキルマッチ度</h5>
                                                            ${scoreDisplay}
                                                        </div>
                                                    </div>
                                                    <p class="mt-2 text-sm ${reasonClass} p-2 rounded">${job.reason || 'N/A'}</p>
                                                    
                                                    ${cultureDisplayHtml}
                                                </div>
                                            </div>
                                        </div>`;
                                    }).join('');
                                    // ★★★ ここまで置き換え ★★★

                                    scoredHtml += `</div></form>`;
                                    $('#modal-content').html(scoredHtml);

                                } catch (e) {
                                    $('#modal-content').html(`<p class="text-red-500">AIスコアリングに失敗: ${e}</p><div class="mt-4 text-right"><button type="button" id="ai-back-to-list-btn" class="font-bold py-2 px-4 rounded-lg bg-slate-500 text-white">戻る</button></div>`);
                                }
                            });

                            // ★ 10/23 追加: スコアリング画面から求人選択画面(第1段階)に戻る
                            $(document).on('click', '#ai-back-to-list-btn', async function() {
                                const userId = $(this).closest('form').data('user-id');
                                // ヘルパー関数を呼び出して第1段階のリストを再描画
                                await fetchAndRenderAiJobSelection(userId);
                            });


                            // ★ 10/23 変更: フォームセレクタを `#ai-save-form` に変更
                            // (旧 `#ai-recommend-form` submit)
                            // ★★★ ここから置き換え (11/15 修正) ★★★
                            $(document).on('submit', '#ai-save-form', async function(e) {
                                e.preventDefault();
                                const userId = $(this).data('user-id');
                                const jobs = [];
                                $(this).find('input:checked').each(function() {
                                    const el = $(this);
                                    
                                    const reason = decodeURIComponent(el.data('reason'));
                                    const score = el.data('score');
                                    const cultureReason = decodeURIComponent(el.data('culture-reason'));
                                    const cultureRating = el.data('culture-rating'); // ★

                                    // reason に 社風分析の結果も結合する
                                    let combinedReason = reason; // 現行の理由
                                    
                                    // 社風分析が実行された場合（未評価や評価不可でない場合）
                                    if (!cultureReason.includes('未評価') && !cultureReason.includes('評価不可') && !cultureReason.includes('失敗')) {
                                        combinedReason += ` | [社風分析: ${cultureRating}評価] ${cultureReason}`; // ★
                                    } else if (!cultureReason.includes('未評価')) {
                                        // 50点未満(未評価)以外の場合（＝評価不可、失敗）
                                        combinedReason += ` | [社風分析] ${cultureReason}`;
                                    }

                                    jobs.push({
                                        job_id: $(this).val(),
                                        reason: combinedReason, // 結合した理由
                                        score: score // スコアは現行スコアを採用
                                    });
                                });
                                if (jobs.length === 0) return ui.showAlert('選択エラー', '求人を1つ以上選択してください。');
                                try {
                                    // saveAIRecommendationsはメール送信しないようGAS側で修正済み
                                    await api.call('saveAIRecommendations', [userId, jobs]);
                                    ui.hideModal();
                                    ui.showAlert('保存完了', `${jobs.length}件のAI推薦を「おすすめ求人」に保存しました。`);
                                } catch (e) {
                                    ui.showAlert('保存エラー', `保存に失敗: ${e}`);
                                }
                            });
                            // ★★★ ここまで置き換え ★★★

                            // ★ 10/23 変更: 除外ボタンの動作 (モーダルを閉じずにリストを更新)
                             $(document).on('click', '#ai-exclude-btn', async function(e) {
                                e.preventDefault();
                                const form = $(this).closest('form');
                                const userId = form.data('user-id');
                                const jobIds = form.find('input[name="selected_job"]:checked').map(function() {
                                  return $(this).val();
                                }).get();

                                if (jobIds.length === 0) return ui.showAlert('選択エラー', '求人を1つ以上選択してください。');

                                if (jobIds.length > 10) {
                                  notifyInModal(`一度に除外できるのは10件までです。現在 ${jobIds.length} 件選択されています。`);
                                return;
                                }

                                try {
                                    await api.call('excludeAIRecommendations', [userId, jobIds]);

                                    // ★ モーダルを閉じずに、リストを更新
                                    $('#modal-content').html('<div class="text-center"><div class="spinner w-8 h-8 mx-auto"></div><p class="mt-2 text-slate-600">除外しました。リストを更新中...</p></div>');
                                    await fetchAndRenderAiJobSelection(userId); // 第1段階のリストを再描画

                                } catch (e) {
                                    ui.showAlert('保存エラー', `除外処理に失敗: ${e}`);
                                }
                            });

                        
            // --- Recommendation List Email Batch ---
                            function updateEmailButtonStatus() {
                                const checkedItems = $('.recommendation-check-item:checked');
                                const btn = $('#send-recommendation-email-btn');
                                
                                if (checkedItems.length === 0) {
                                    btn.prop('disabled', true);
                                    return;
                                }

                                // 異なるユーザーが選択されていないかチェック
                                let firstUserId = null;
                                let differentUsers = false;
                                checkedItems.each(function() {
                                    const currentUserId = $(this).data('user-id');
                                    if (firstUserId === null) {
                                        firstUserId = currentUserId;
                                    } else if (firstUserId !== currentUserId) {
                                        differentUsers = true;
                                        return false; // break loop
                                    }
                                });

                                // 異なるユーザーが選択されている場合はボタンを無効化
                                btn.prop('disabled', differentUsers);
                                if (differentUsers) {
                                    btn.attr('title', '異なる求職者の求人を同時に送信することはできません。');
                                } else {
                                    btn.removeAttr('title');
                                }
                            }

                            // ===== 可視行のチェックボックスを取得するヘルパ =====
                            function visibleCheckItems() {
                              // 「表示中の行」かつ「有効な」チェックボックスのみ対象
                              return $('#recommendations-table-body tr:visible .recommendation-check-item:not(:disabled)');
                            }

                            // ===== (REPLACE) ヘッダの状態と送信ボタンを同期 =====
                            function syncHeaderCheckbox() {
                              const items = visibleCheckItems();
                              const checkedItems = items.filter(':checked');
                              const checkedCount = checkedItems.length;

                              // 1. ヘッダチェックボックスの同期
                              const allChecked = items.length > 0 && checkedCount === items.length;
                              $('#recommendation-check-all').prop('checked', allChecked);

                              // 2. バッチボタンの制御
                              const batchLabel = $('#batch-action-label');
                              const batchWarning = $('#batch-action-warning');

                              // ★★★ 取得するボタンIDを変更 ★★★
                              const btnApply = $('#batch-apply-btn'); // ユーザー・管理者共通ID
                              const btnReject = $('#batch-reject-btn');
                              const btnEmail = $('#send-recommendation-email-btn');

                              if (checkedCount === 0) {
                                  // 0件選択時：すべて無効、ラベルをリセット
                                  batchLabel.text('チェックした求人を一括操作:');
                                  batchWarning.text('').addClass('hidden');
                                  btnApply.prop('disabled', true);
                                  btnReject.prop('disabled', true);
                                  btnEmail.prop('disabled', true); // 管理者用メールボタンも無効化
                                  return;
                              }

                              // 1件以上選択時：ユーザーが同一かチェック
                              let firstUserId = checkedItems.first().data('user-id');
                              let firstUserName = checkedItems.first().data('user-name');
                              let isSingleUserSelected = true;

                              checkedItems.each(function() {
                                  if ($(this).data('user-id') !== firstUserId) {
                                      isSingleUserSelected = false;
                                      return false; // break loop
                                  }
                              });

                              // 3. ラベルと警告の更新
                              if (isSingleUserSelected) {
                                  batchLabel.text(`対象: ${firstUserName} さん`);
                                  batchWarning.text('').addClass('hidden');
                              } else {
                                  batchLabel.text('チェックした求人を一括操作:');
                                  batchWarning.text('複数ユーザーの求人を一括操作できません。').removeClass('hidden');
                              }

                              // 4. ボタンの disabled 状態を更新
                              // ユーザー・管理者共通：見送りボタンと「応募」ボタン ★★★
                              btnReject.prop('disabled', !isSingleUserSelected);
                              btnApply.prop('disabled', !isSingleUserSelected); // ★★★ 応募ボタンも単一ユーザー選択時のみ有効

                              // 管理者の場合のみ：メール送信ボタン
                              if (CURRENT_USER && ['admin', 'coach'].includes(CURRENT_USER.role)) {
                                  btnEmail.prop('disabled', !isSingleUserSelected);
                              }
                            }

                            // ===== すべてチェック（ヘッダ） =====
                            $(document)
                              .off('change.recsAll')
                              .on('change.recsAll', '#recommendation-check-all', function () {
                                const items = visibleCheckItems();
                                items.prop('checked', this.checked);
                                syncHeaderCheckbox();
                              });

                            // ===== 各行のチェック =====
                            $(document)
                              .off('change.recsItem')
                              .on('change.recsItem', '.recommendation-check-item', function () {
                                syncHeaderCheckbox();
                              });


                            $(document).on('click', '#send-recommendation-email-btn', async function() {
                                const checkedItems = $('.recommendation-check-item:checked');
                                if (checkedItems.length === 0) {
                                    return ui.showAlert('エラー', '求人が選択されていません。');
                                }

                                let targetUserId = null;
                                const selectedJobs = [];
                                let userName = '求職者';

                                checkedItems.each(function() {
                                    const el = $(this);
                                    if (targetUserId === null) {
                                        targetUserId = el.data('user-id');
                                    }
                                    selectedJobs.push({
                                        job_id: el.data('job-id'),
                                        title: el.data('title'),
                                        company: el.data('company'),
                                        reason: decodeURIComponent(el.data('reason') || '担当者からのおすすめです。')
                                    });
                                });

                                if (!targetUserId) {
                                     return ui.showAlert('エラー', '対象ユーザーの特定に失敗しました。');
                                }

                                // ユーザー名を取得
                                try {
                                    // ALL_RECOMMENDATIONS はこのページを描画する際に取得済みのはず
                                    const rec = ALL_RECOMMENDATIONS.find(r => r.user_id === targetUserId);
                                    if (rec && rec.user_name) {
                                        userName = rec.user_name;
                                    } else if (ALL_USERS.length > 0) {
                                        // ユーザー管理ページを一度開いていればALL_USERSから取得
                                        const user = ALL_USERS.find(u => u.user_id === targetUserId);
                                        if (user) userName = user.name;
                                    }
                                } catch(e) {
                                     console.warn("User name lookup failed, using default.");
                                }

                                // モーダルで確認
                                let listHtml = selectedJobs.map((job, index) => {
                                    return `<li class="mb-4 border-b pb-2">
                                                <p><b>${job.title}</b> (${job.company})</p>
                                                <p class="text-sm text-slate-600 mt-1">${job.reason}</p>
                                            </li>`;
                                }).join('');

                                let content = `<form id="send-bulk-email-form">
                                                 <p class="mb-4"><b>${userName}さん</b>に、以下の <b>${selectedJobs.length}件</b> のおすすめ求人メールを送信します。よろしいですか？</p>
                                                 <ul class="max-h-60 overflow-y-auto bg-slate-50 p-4 rounded-md">${listHtml}</ul>
                                                 <div class="mt-6 text-right">
                                                     <button type="button" id="modal-cancel-btn" class="font-bold py-2 px-4 rounded-lg shadow-md bg-slate-500 text-white mr-2">キャンセル</button>
                                                     <button type="submit" class="font-bold py-2 px-4 rounded-lg shadow-md bg-green-600 text-white">送信する</button>
                                                 </div>
                                               </form>`;
                                
                                ui.showModal('おすすめ求人メール送信確認', content);
                                
                                // 送信データをフォームに一時保存
                                $('#send-bulk-email-form').data('userId', targetUserId);
                                $('#send-bulk-email-form').data('jobs', selectedJobs);
                            });

                            $(document).on('click', '#modal-cancel-btn', ui.hideModal);

                            $(document).on('submit', '#send-bulk-email-form', async function(e) {
                                e.preventDefault();
                                const userId = $(this).data('userId');
                                const jobs = $(this).data('jobs');
                                
                                if (!userId || !jobs || jobs.length === 0) {
                                    return ui.showAlert('エラー', '送信データの準備に失敗しました。');
                                }

                                try {
                                    // ★GAS側で 'sendBulkRecommendationEmail' を呼び出す
                                    await api.call('sendBulkRecommendationEmail', [userId, jobs]);
                                    ui.hideModal();
                                    ui.showAlert('送信完了', 'おすすめメールを送信しました。');
                                    // チェックを外す
                                    $('#recommendation-check-all').prop('checked', false);
                                    $('.recommendation-check-item').prop('checked', false);
                                    $('#send-recommendation-email-btn').prop('disabled', true);
                                } catch (e) {
                                    ui.showAlert('送信エラー', `メール送信に失敗しました: ${e}`);
                                }
                            });
                    
                            // ★ 追加(10/26 変更): AI推薦モーダル(第1段階)のテキスト絞り込み + ヘッダ同期
                            // ★ 10/26 追加(10/26 変更): AI推薦モーダル(第1段階)のテキスト絞り込み + ヘッダ同期
                            // ★ 11/15 変更: 「未経験OK」絞り込み機能を追加
                            $(document).on('input', '#ai-job-filter-input', function() {
                                const searchTerm = $(this).val().toLowerCase();
                                // ★ チェックボックスの状態を取得
                                const inexperiencedOnly = $('#ai-job-filter-inexperienced-ok').is(':checked');

                                $('#ai-job-list-container .ai-job-item').each(function() {
                                    const item = $(this);
                                    const keywords = item.data('keywords');
                                    const isOk = item.data('inexperienced-ok') === true;// data-inexperienced-ok="true" を判定

                                    // 1. テキストがマッチするか
                                    const textMatch = keywords.includes(searchTerm);
                                    
                                    // 2. 未経験OKがマッチするか
                                    // (チェックボックスがOFFなら常にtrue、ONならisOkがtrueの場合のみtrue)
                                    const experienceMatch = !inexperiencedOnly || isOk;

                                    if (textMatch && experienceMatch) {
                                        item.show();
                                    } else {
                                        item.hide();
                                    }
                                });
                                
                                // ★ ヘッダの「すべてチェック」の状態を更新
                                // syncAiJobSelectAll(); // (この関数は存在しないようなのでコメントアウトのまま)
                            });

                            // ★ 11/15 追加: 未経験OKチェックボックス変更時にも、inputイベントを発火させて絞り込みを実行
                            $(document).on('change', '#ai-job-filter-inexperienced-ok', function() {
                                $('#ai-job-filter-input').trigger('input');
                            });

                            // ★ 10/26 修正: スコアリング結果画面(第2段階)の「選択した求人を除外」ボタンのリスナーを追加
                            $(document).on('click', '#ai-exclude-scored-btn', async function(e) {
                                e.preventDefault();
                                const form = $(this).closest('form'); // This is '#ai-save-form'
                                const userId = form.data('user-id');
                                const jobIds = form.find('input[name="selected_job"]:checked').map(function() {
                                  return $(this).val();
                                }).get();

                                if (jobIds.length === 0) {
                                    notifyInModal('除外する求人を1つ以上選択してください。'); 
                                    return;
                                }

                                try {
                                    // 除外APIを呼び出す
                                    await api.call('excludeAIRecommendations', [userId, jobIds]);

                                    // 成功したら、ローディングを表示し、第1段階の求人選択リストを再描画する
                                    $('#modal-content').html('<div class="text-center"><div class="spinner w-8 h-8 mx-auto"></div><p class="mt-2 text-slate-600">除外しました。リストを更新中...</p></div>');
                                    await fetchAndRenderAiJobSelection(userId); // 第1段階のリストを再描画

                                } catch (e) {
                                    ui.showAlert('除外エラー', `除外処理に失敗: ${e}`);
                                }
                            });


// --- Recommendations List: Single Apply Button ---
                            $(document).on('click', '.recommendation-list-apply-btn', function() {
                                const jobId = $(this).data('job-id');
                                const recId = $(this).data('rec-id'); // Get the rec-id
                                // 既存の応募モーダルロジックを流用
                                const content = `<form id="apply-form" data-job-id="${jobId}" data-rec-id="${recId}">
                                        <div class="space-y-4">
                                            <div>
                                                <label class="block text-sm font-medium text-slate-700">志望度 <span class="text-red-500">*</span></label>
                                                <select id="aspiration-level" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                                                    <option value="">選択してください</option>
                                                    <option value="A">A: 第一志望群</option>
                                                    <option value="B">B: 第二志望群</option>
                                                    <option value="C">C: 第三志望群</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-slate-700">伝達事項</label>
                                                <textarea id="application-notes" rows="3" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm" placeholder="何か伝えておきたいことがあれば入力してください。"></textarea>
                                            </div>
                                            <hr class="my-4">
                                            <div>
                                                <p class="mb-2 text-sm font-medium text-slate-700">面接希望日時 (3つまで)</p>
                                                ${[1,2,3].map(i => `<div class="mb-2"><label class="block text-xs text-slate-600">希望日時 ${i}</label><input type="datetime-local" class="mt-1 block w-full rounded-md border-slate-300 interview-date"></div>`).join('')}
                                            </div>
                                        </div>
                                        <div class="mt-6 text-right"><button type="submit" class="font-bold py-2 px-4 rounded-lg bg-indigo-600 text-white">この内容で応募する</button></div>
                                    </form>`;
                                ui.showModal('応募内容の確認', content);
                            });

                            // --- Recommendations List: Batch Reject ---
                            $(document).on('click', '#batch-reject-btn', async function() {
                                const checkedItems = $('.recommendation-check-item:checked');
                                if (checkedItems.length === 0) return;
                                
                                if (!confirm(`${checkedItems.length}件の求人を一括で見送ります。よろしいですか？`)) return;

                                ui.showSpinner();
                                const recIds = checkedItems.map((i, el) => $(el).data('rec-id')).get();
                                
                                const promises = recIds.map(recId => api.call('updateRecommendationStatus', [recId, 'rejected']));
                                
                                try {
                                    await Promise.all(promises);
                                    ui.showAlert('処理完了', `${checkedItems.length}件の求人を見送りました。`);
                                    
                                    // Update UI for each row
                                    checkedItems.each(function() {
                                        const row = $(this).closest('tr');
                                        row.addClass('bg-slate-100 text-slate-500');
                                        row.find('.font-medium').removeClass('text-slate-800');
                                        row.find('.status-badge').html(`<span class="px-2 py-1 text-xs font-semibold rounded-full bg-slate-100 text-slate-600">見送り</span>`);
                                        row.find('.recommendation-list-reject-btn, .recommendation-list-apply-btn').remove();
                                        $(this).prop('checked', false).prop('disabled', true);
                                    });
                                    syncHeaderCheckbox(); // Update button states
                                } catch (e) {
                                    ui.showAlert('エラー', `一括見送り処理に失敗しました: ${e}`);
                                } finally {
                                    ui.hideSpinner();
                                }
                            });

                            // --- Recommendations List: Batch Apply (Show Modal) ---
                            $(document).on('click', '#batch-apply-btn', function() {
                                const checkedItems = $('.recommendation-check-item:checked');
                                if (checkedItems.length === 0) return;

                                let jobListHtml = '<ul class="space-y-2">';
                                const jobsToApply = [];
                                
                                checkedItems.each(function() {
                                    const el = $(this);
                                    const title = el.data('title');
                                    const company = el.data('company');
                                    const jobId = el.data('job-id');
                                    const recId = el.data('rec-id');
                                    
                                    jobListHtml += `<li class="text-sm font-medium text-slate-700">${title} <span class="text-xs text-slate-500">(${company})</span></li>`;
                                    jobsToApply.push({ jobId: jobId, recId: recId });
                                });
                                jobListHtml += '</ul>';

                                // Get the standard apply form content
                                const formContent = `
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-slate-700">志望度 <span class="text-red-500">*</span></label>
                                            <select id="aspiration-level" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                                                <option value="">選択してください</option>
                                                <option value="A">A: 第一志望群</option>
                                                <option value="B">B: 第二志望群</option>
                                                <option value="C">C: 第三志望群</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-slate-700">伝達事項</label>
                                            <textarea id="application-notes" rows="3" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm" placeholder="何か伝えておきたいことがあれば入力してください。"></textarea>
                                        </div>
                                        <hr class="my-4">
                                        <div>
                                            <p class="mb-2 text-sm font-medium text-slate-700">面接希望日時 (3つまで)</p>
                                            ${[1,2,3].map(i => `<div class="mb-2"><label class="block text-xs text-slate-600">希望日時 ${i}</label><input type="datetime-local" class="mt-1 block w-full rounded-md border-slate-300 interview-date"></div>`).join('')}
                                        </div>
                                    </div>
                                `;
                                
                                const finalContent = `
                                    <p class="mb-4">以下の ${jobsToApply.length} 件の求人について、応募内容を入力してください。</p>
                                    <div class="max-h-40 overflow-y-auto bg-slate-50 p-3 rounded-md mb-4">${jobListHtml}</div>
                                    <form id="batch-apply-form">
                                        ${formContent}
                                        <div class="mt-6 text-right"><button type="submit" class="font-bold py-2 px-4 rounded-lg bg-indigo-600 text-white">この内容で一括応募する</button></div>
                                    </form>
                                `;
                                
                                ui.showModal('一括応募の確認', finalContent, { size: 'max-w-2xl' });
                                // Store jobs data on the form
                                $('#batch-apply-form').data('jobs', jobsToApply);
                            });

                            // --- Recommendations List: Batch Apply (Submit) ---
                            $(document).on('submit', '#batch-apply-form', async function(e) {
                                e.preventDefault();
                                
                                const dates = $('.interview-date').map((i, el) => $(el).val()).get().filter(Boolean);
                                const notes = $('#application-notes').val();
                                const aspirationLevel = $('#aspiration-level').val();
                                const jobsToApply = $(this).data('jobs');

                                if (!aspirationLevel) {
                                    ui.showAlert('必須入力です', '志望度を選択してください。');
                                    return;
                                }
                                
                                ui.showSpinner();
                                ui.hideModal();

                                try {
                                    // 1. Apply for all jobs
                                    const applyPromises = jobsToApply.map(job => 
                                        api.call('applyForJob', [job.jobId, dates, notes, aspirationLevel])
                                    );
                                    await Promise.all(applyPromises);
                                    
                                    // 2. Update all recommendation statuses
                                    const updatePromises = jobsToApply.map(job => 
                                        api.call('updateRecommendationStatus', [job.recId, 'applied'])
                                    );
                                    await Promise.all(updatePromises);
                                    
                                    ui.showAlert('一括応募完了', `${jobsToApply.length}件の求人への応募を受け付けました。`);
                                    
                                    // 3. Update UI
                                    jobsToApply.forEach(job => {
                                        const row = $(`.recommendation-check-item[data-rec-id="${job.recId}"]`).closest('tr');
                                        row.addClass('bg-green-50');
                                        row.find('.status-badge').html(`<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-700">応募済み</span>`);
                                        row.find('.recommendation-list-reject-btn, .recommendation-list-apply-btn').remove();
                                        row.find('.recommendation-check-item').prop('checked', false).prop('disabled', true);
                                    });
                                    
                                    syncHeaderCheckbox(); // Update button states
                                    renderProgress(); // Refresh progress page data
                                    
                                } catch (e) {
                                    ui.showAlert('一括応募に失敗しました。', `処理中にエラーが発生しました: ${e}`);
                                } finally {
                                    ui.hideSpinner();
                                }
                            });


                            // --- Progress Page: Batch Status Update ---

                            // ===== (Progress) 可視行のチェックボックスを取得 =====
                            function visibleProgressCheckItems() {
                              return $('#progress-table-body tr:visible .progress-check-item:not(:disabled)');
                            }

                            // ===== (Progress) ヘッダと一括ボタンの状態を同期 =====
                            function syncProgressHeaderCheckbox() {
                              const items = visibleProgressCheckItems();
                              const checkedItems = items.filter(':checked');
                              const checkedCount = checkedItems.length;

                              // 1. ヘッダチェックボックス
                              const allChecked = items.length > 0 && checkedCount === items.length;
                              $('#progress-check-all').prop('checked', allChecked);

                              // 2. 一括ボタンと警告ラベル
                              const btnBatchUpdate = $('#batch-status-update-btn');
                              const batchLabel = $('#progress-batch-action-label');
                              const batchWarning = $('#progress-batch-action-warning');

                              if (checkedCount === 0) {
                                  batchLabel.text('チェックした応募を一括操作:');
                                  batchWarning.text('').addClass('hidden');
                                  btnBatchUpdate.prop('disabled', true);
                                  return;
                              }

                              // 選択されたユーザーが単一かチェック
                              let firstUserId = checkedItems.first().data('user-id');
                              let firstUserName = checkedItems.first().data('user-name');
                              let isSingleUserSelected = true;
                              checkedItems.each(function() {
                                  if ($(this).data('user-id') !== firstUserId) {
                                      isSingleUserSelected = false;
                                      return false; // loop break
                                  }
                              });

                              if (isSingleUserSelected) {
                                  batchLabel.text(`対象: ${firstUserName} さん`);
                                  batchWarning.text('').addClass('hidden');
                                  btnBatchUpdate.prop('disabled', false);
                              } else {
                                  batchLabel.text('チェックした応募を一括操作:');
                                  batchWarning.text('複数ユーザーの応募を同時に変更できません。').removeClass('hidden');
                                  btnBatchUpdate.prop('disabled', true);
                              }
                            }

                            // --- (Progress) チェックボックスイベント ---
                            $(document).on('change', '#progress-check-all', function () {
                                const items = visibleProgressCheckItems();
                                items.prop('checked', this.checked);
                                syncProgressHeaderCheckbox();
                            });
                            $(document).on('change', '.progress-check-item', function () {
                                syncProgressHeaderCheckbox();
                            });
                            // フィルタ変更時もチェック状態を同期
                            $(document).on('click', '#progress-page .filter-btn', function() {
                                syncProgressHeaderCheckbox();
                            });
                             $(document).on('input', '#progress-keyword-search', function() {
                                syncProgressHeaderCheckbox();
                             });


                            // --- (Progress) 一括変更ボタンクリック -> モーダル表示 ---
                            $(document).on('click', '#batch-status-update-btn', function() {
                                const checkedItems = $('.progress-check-item:checked');
                                if (checkedItems.length === 0) return;

                                const targetUserName = checkedItems.first().data('user-name');
                                const appCount = checkedItems.length;
                                const statusOptions = (MASTERS.application_status || []) // 保存しておいたマスタを使用
                                    .map(s => `<option value="${s}">${s}</option>`)
                                    .join('');

                                const content = `
                                    <form id="batch-update-status-form">
                                        <p class="mb-4"><b>${targetUserName}さん</b>の <b>${appCount}件</b> の応募ステータスを一括で変更します。</p>
                                        <div class="mb-4">
                                            <label for="batch-new-status" class="block text-sm font-medium text-slate-700">新しいステータス</label>
                                            <select id="batch-new-status" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm" required>
                                                <option value="">選択してください</option>
                                                ${statusOptions}
                                            </select>
                                        </div>
                                        <div class="mb-4">
                                             <label for="batch-new-memo" class="block text-sm font-medium">メモ (社内用)</label>
                                             <textarea id="batch-new-memo" class="mt-1 block w-full rounded-md border-slate-300" rows="3" placeholder="必要であれば共通のメモを入力"></textarea>
                                        </div>
                                        <div class="mb-6 border-t pt-4">
                                            <label class="flex items-center">
                                                <input type="checkbox" id="batch-send-notification" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                                <span class="ml-2 text-sm text-slate-700">応募者と関係者に変更通知メールを送信する</span>
                                            </label>
                                            <p class="text-xs text-slate-500 mt-1">※チェックしない場合、メール通知は送信されません。</p>
                                        </div>
                                        <div class="mt-6 text-right space-x-2">
                                            <button type="button" id="modal-cancel-btn" class="font-bold py-2 px-4 rounded-lg shadow-md bg-slate-500 text-white">キャンセル</button>
                                            <button type="submit" class="font-bold py-2 px-4 rounded-lg shadow-md bg-blue-600 text-white">変更を保存</button>
                                        </div>
                                    </form>
                                `;
                                ui.showModal('ステータス一括変更', content);
                            });

                            // --- (Progress) 一括変更モーダル -> 保存実行 ---
                            $(document).on('submit', '#batch-update-status-form', async function(e) {
                                e.preventDefault();
                                const checkedItems = $('.progress-check-item:checked');
                                const appIds = checkedItems.map((i, el) => $(el).data('app-id')).get();
                                const newStatus = $('#batch-new-status').val();
                                const newMemo = $('#batch-new-memo').val(); // メモを取得
                                const sendNotification = $('#batch-send-notification').is(':checked');

                                if (!newStatus) {
                                    ui.showAlert('エラー', '新しいステータスを選択してください。');
                                    return;
                                }

                                ui.hideModal();
                                ui.showSpinner();

                                try {
                                    // バックエンドの新しい関数を呼び出す
                                    await api.call('batchUpdateApplicationStatus', [appIds, newStatus, newMemo, sendNotification]); // メモも渡す
                                    ui.showAlert('成功', `${appIds.length}件のステータスを変更しました。`);
                                    // UIを更新するために再描画
                                    renderProgress();
                                } catch (err) {
                                    ui.showAlert('エラー', `一括更新に失敗しました: ${err}`);
                                } finally {
                                    ui.hideSpinner();
                                }
                            });

                            // --- Recommendations List: Manager Single Apply Button ---
                            $(document).on('click', '.manager-apply-single-btn', function() {
                                const jobId = $(this).data('job-id');
                                const recId = $(this).data('rec-id');
                                const targetUserId = $(this).data('user-id'); // ★ 代理応募対象のユーザーID
                                const targetUserName = $(this).data('user-name'); // ★ 代理応募対象のユーザー名

                                // ユーザー用の応募モーダルを流用
                                const content = `<form id="apply-form" data-job-id="${jobId}" data-rec-id="${recId}" data-target-user-id="${targetUserId}"> 
                                        <p class="mb-4 text-sm font-medium text-indigo-700">【代理応募】対象者: ${targetUserName || '不明'} さん</p> 
                                        <div class="space-y-4">
                                            <div>
                                                <label class="block text-sm font-medium text-slate-700">志望度 <span class="text-red-500">*</span></label>
                                                <select id="aspiration-level" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                                                    <option value="">選択してください</option>
                                                    <option value="A">A: 第一志望群</option>
                                                    <option value="B">B: 第二志望群</option>
                                                    <option value="C">C: 第三志望群</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-slate-700">伝達事項</label>
                                                <textarea id="application-notes" rows="3" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm" placeholder="何か伝えておきたいことがあれば入力してください。"></textarea>
                                            </div>
                                            <hr class="my-4">
                                            <div>
                                                <p class="mb-2 text-sm font-medium text-slate-700">面接希望日時 (3つまで)</p>
                                                ${[1,2,3].map(i => `<div class="mb-2"><label class="block text-xs text-slate-600">希望日時 ${i}</label><input type="datetime-local" class="mt-1 block w-full rounded-md border-slate-300 interview-date"></div>`).join('')}
                                            </div>
                                        </div>
                                        <div class="mt-6 text-right"><button type="submit" class="font-bold py-2 px-4 rounded-lg bg-indigo-600 text-white">この内容で代理応募する</button></div>
                                    </form>`;
                                ui.showModal('代理応募の内容確認', content);
                            });


                        } // end of initializeEvents()


                        // ========================
                        // Initializer
                        // ========================
                        function init() {
                            //marked.setOptions({
                                // sanitize: true
                            //});

                            // Hide all main containers to ensure a clean slate and prevent flickering
                            $('#auth-container').hide();
                            $('#app-container').hide();
                            $('#reset-password-container').addClass('hidden');

                            const urlParams = new URLSearchParams(window.location.search);
                            const resetToken = urlParams.get('resetToken');

                            if (resetToken) {
                                // If there's a reset token, show ONLY the password reset screen
                                $('#reset-password-container').removeClass('hidden');
                                $('#reset-token-input').val(resetToken);
                            } else {
                                // Otherwise, proceed with normal auth flow
                                const userData = sessionStorage.getItem('jobAppUser');
                                if (userData) {
                                    try {
                                        CURRENT_USER = JSON.parse(userData);
                                        main(); // main() will show #app-container
                                    } catch (e) {
                                        sessionStorage.removeItem('jobAppUser');
                                        $('#auth-container').show();
                                    }
                                } else {
                                    $('#auth-container').show();
                                }
                            }
                            initializeEvents();
                        }

                        $(document).ready(init);
                    })(jQuery);
                </script>
            </body>
</html>
