<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RightJob „Éû„ÉÉ„ÉÅ„É≥„Ç∞ - SupabaseÁâà</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Chart.js for Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap');

        :root {
            --sidebar-width: 250px;
            --header-height: 64px;
            --primary: #4f46e5;
            --primary-dark: #4338ca;
        }

        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f8f9fa;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .spinner {
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Sidebar & Layout */
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0);
            }

            .main-content {
                margin-left: var(--sidebar-width);
            }
        }

        /* Custom Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }

        input[type=range]:focus {
            outline: none;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.2);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #ddd;
            border-radius: 5px;
        }

        /* AI Result Tabs */
        .ai-result-tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 1.5rem;
        }

        .ai-result-tab {
            flex: 1;
            padding: 12px 16px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .ai-result-tab:hover {
            color: #4f46e5;
            background-color: #f8fafc;
        }

        .ai-result-tab.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
            background-color: #f8fafc;
        }

        .ai-result-content {
            display: none;
        }

        .ai-result-content.active {
            display: block;
        }

        /* Diagnosis Page Styles */
        .result-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .strength-ranking-header,
        .job-recommendation-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .strength-ranking-title,
        .job-recommendation-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .strength-ranking-subtitle,
        .job-recommendation-subtitle {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
            margin-top: 8px;
        }

        .result-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 40px;
        }

        .result-card-content {
            padding: 16px;
        }

        .rank-badge {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
            margin-right: 12px;
        }

        .rank-badge.gold {
            background-color: #ffd700;
        }

        .rank-badge.silver {
            background-color: #c0c0c0;
        }

        .rank-badge.bronze {
            background-color: #cd7f32;
        }

        /* Select2 custom styles for Tailwind */
        .select2-container--default .select2-selection--single {
            border: 1px solid #d1d5db !important;
            border-radius: 0.5rem !important;
            height: 42px !important;
            display: flex !important;
            align-items: center !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: #374151 !important;
            line-height: normal !important;
            padding-left: 0.75rem !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 40px !important;
        }

        .select2-dropdown {
            border: 1px solid #d1d5db !important;
            border-radius: 0.5rem !important;
            z-index: 10000 !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
        }

        .select2-results__option--highlighted[aria-selected] {
            background-color: #4f46e5 !important;
        }

        .rank-badge.blue {
            background-color: #4a90e2;
        }

        /* Job recommendation styles */
        .job-container {
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .job-container.job-engineer {
            border-color: #4a90e2;
        }

        .job-container.job-designer {
            border-color: #d0021b;
        }

        .job-container.job-marketer {
            border-color: #f5a623;
        }

        .job-rank-badge {
            text-align: center;
            padding: 4px 0;
            border-radius: 20px;
            color: white;
            font-size: 12px;
            margin: 0 auto 16px;
            max-width: 250px;
        }

        .job-rank-badge.badge-engineer {
            background: #4a90e2;
        }

        .job-rank-badge.badge-designer {
            background: #d0021b;
        }

        .job-rank-badge.badge-marketer {
            background: #f5a623;
        }

        .job-name {
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 24px;
        }

        .job-section {
            margin-top: 24px;
        }

        .job-section-title {
            font-weight: bold;
            margin-bottom: 8px;
            border-left: 4px solid #4a90e2;
            padding-left: 8px;
        }

        .job-skill-tag {
            background: #eef5ff;
            color: #4a90e2;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
        }

        /* Sidebar Styles (Mobile Optimized) */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: #1e1b4b;
            /* Indigo-950 */
            color: #e2e8f0;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 50;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            box-shadow: 10px 0 15px -3px rgba(0, 0, 0, 0.1);
        }

        .sidebar .nav-link {
            color: #94a3b8;
            margin-bottom: 4px;
        }

        .sidebar .nav-link:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .sidebar .nav-link.active {
            background: white !important;
            color: #4f46e5 !important;
            font-weight: 700;
        }

        .main-content {
            margin-left: 0;
            /* Default no margin */
            min-height: 100vh;
            transition: margin-left 0.3s;
        }

        /* Sidebar Overlay */
        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 45;
            display: none;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Desktop Override */
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0) !important;
            }

            .main-content {
                margin-left: var(--sidebar-width) !important;
            }

            .sidebar-overlay {
                display: none !important;
            }
        }

        /* Mobile UI Refinements */
        @media (max-width: 767px) {
            header {
                position: sticky;
                top: 0;
                z-index: 40;
                backdrop-filter: blur(8px);
                background-color: rgba(255, 255, 255, 0.9) !important;
            }
        }

        /* Open State (Mobile) */
        .sidebar.open {
            transform: translateX(0);
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .app-content {
            animation: fadeIn 0.3s ease-out;
        }

        /* Smooth transitions */
        button,
        a,
        .nav-link {
            transition: all 0.2s ease;
        }

        /* Card hover effects */
        .hover\:shadow-md {
            transition: box-shadow 0.3s ease;
        }

        /* AIÊé®Ëñ¶ÂØæË±°„Éè„Ç§„É©„Ç§„Éà */
        .job-card {
            position: relative;
            transition: all 0.3s ease;
        }

        .job-card-highlighted {
            border: 3px solid #6366f1 !important;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1) !important;
            background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%) !important;
        }

        .job-card-highlighted::before {
            content: "AIÁ¥π‰ªãÂØæË±°";
            position: absolute;
            top: -12px;
            right: 16px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
            z-index: 10;
        }

        /* AIÊé®Ëñ¶ÁµêÊûú„É¢„Éº„ÉÄ„É´Áî®„Çø„Éñ„Çπ„Çø„Ç§„É´ */
        .ai-result-tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 1.5rem;
        }

        .ai-result-tab {
            flex: 1;
            padding: 12px 16px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .ai-result-tab:hover {
            color: #4f46e5;
            background-color: #f8fafc;
        }

        .ai-result-tab.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
            background-color: #f8fafc;
        }

        .ai-result-content {
            display: none;
        }

        .ai-result-content.active {
            display: block;
        }

        .ai-result-item {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .ai-result-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .ai-result-item.excluded {
            background-color: #f8fafc;
            border-color: #cbd5e1;
        }

        /* ÂØæË±°„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥ */
        .target-user-dropdown {
            position: absolute;
            z-index: 50;
            width: 100%;
            margin-top: 4px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            max-height: 256px;
            overflow-y: auto;
        }

        .target-user-option {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: background-color 0.2s;
        }

        .target-user-option:hover {
            background-color: #eff6ff;
        }

        .target-user-option:last-child {
            border-bottom: none;
        }

        /* --- HIGH VISIBILITY SCROLLBAR --- */
        .custom-scrollbar {
            overflow-y: scroll !important;
            scrollbar-width: thin !important;
            scrollbar-color: #4f46e5 #f1f5f9 !important;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 12px !important;
            display: block !important;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9 !important;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #4f46e5 !important;
            border-radius: 6px !important;
            border: 2px solid #f1f5f9 !important;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #312e81 !important;
        }

        /* Modal Animation */
        .animate-fade-in-up {
            animation: fadeInUp 0.3s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Utility overrides */
        /* Candidate Detail Tabs */
        .candidate-tab-btn.active {
            border-bottom-color: #4f46e5 !important;
            color: #4f46e5 !important;
        }


        /* Print Styles */
        @media print {
            @page {
                margin: 5mm;
                /* ‰ΩôÁôΩ„Çí„Åï„Çâ„Å´Á∏ÆÂ∞è */
                size: landscape;
            }

            body {
                background-color: white;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                overflow: visible !important;
            }

            /* ÂÖ®„Å¶„ÅÆË¶ÅÁ¥†„Çí‰∏ÄÊó¶ÈùûË°®Á§∫„Å´ */
            body>* {
                display: none !important;
            }

            /* „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Ç≥„É≥„ÉÜ„Éä„ÅÆ„ÅøË°®Á§∫ */
            body>#app-page {
                display: block !important;
                position: static !important;
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
            }

            /* „Çµ„Ç§„Éâ„Éê„Éº„Å®„Éò„ÉÉ„ÉÄ„Éº„ÇíÈùûË°®Á§∫ */
            .sidebar,
            header,
            .no-print,
            #loading-overlay {
                display: none !important;
            }

            /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆË®≠ÂÆö */
            .main-content {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                position: static !important;
                display: block !important;
            }

            /* ÂÖ®„Å¶„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Éö„Éº„Ç∏„ÇíÈùûË°®Á§∫ */
            .app-content {
                display: none !important;
            }

            /* ÁèæÂú®„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™Ôºàhidden„ÇØ„É©„Çπ„Åå„Å™„ÅÑÔºâ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆ„ÅøË°®Á§∫„Åó„ÄÅÁµ∂ÂØæÈÖçÁΩÆ„Åß‰∏äÈÉ®„Å´Âõ∫ÂÆö */
            .app-content:not(.hidden) {
                display: block !important;
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* „Ç´„Éº„Éâ„ÅÆ„Çπ„Çø„Ç§„É´Ë™øÊï¥ */
            .shadow-sm,
            .shadow-md,
            .shadow-lg,
            .shadow {
                box-shadow: none !important;
                border: 1px solid #ccc !important;
            }

            /* „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„ÅÆË™øÊï¥ */
            textarea {
                height: auto !important;
                min-height: 50px;
                resize: none !important;
                border: 1px solid #ddd !important;
                page-break-inside: avoid;
            }

            /* Êîπ„Éö„Éº„Ç∏Âà∂Âæ° */
            .bg-white {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }

        /* --- PREMIUM SEARCH UI --- */
        .search-card {
            background: #ffffff;
            border-radius: 24px;
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.04), 0 8px 10px -6px rgba(0, 0, 0, 0.04);
            padding: 32px;
            border: 1px solid #f1f5f9;
            position: relative;
        }

        .filter-group-label {
            font-size: 0.875rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .admin-badge {
            background: #6366f1;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.625rem;
            font-weight: 700;
            display: inline-block;
            vertical-align: middle;
        }

        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
            min-height: 24px;
        }

        /* Mobile adjustments */
        @media (max-width: 640px) {
            .filter-group-label {
                font-size: 11px;
                margin-bottom: 6px;
                color: #64748b;
            }

            .premium-tag {
                font-size: 10px;
                padding: 2px 8px;
            }

            .search-card {
                padding: 1rem !important;
                border-radius: 16px !important;
            }

            .count-badge-premium {
                padding: 8px 16px !important;
                gap: 8px !important;
            }

            .count-number-premium {
                font-size: 1.5rem !important;
            }

            .premium-slider-container {
                padding: 4px 0;
            }

            /* Compact mobile styles */
            .h-14 {
                height: 3rem !important;
                /* From 3.5rem (56px) to 48px */
            }

            .px-12 {
                padding-left: 2.5rem !important;
                padding-right: 2.5rem !important;
            }

            .gap-6 {
                gap: 1rem !important;
            }

            .gap-8 {
                gap: 1.25rem !important;
            }

            .mb-8 {
                margin-bottom: 1.25rem !important;
            }

            .mt-8 {
                margin-top: 1.25rem !important;
            }

            .pt-6 {
                padding-top: 1rem !important;
            }

            .select2-container--default .select2-selection--single,
            .select2-container--default .select2-selection--multiple {
                min-height: 44px !important;
                font-size: 13px !important;
            }

            .search-keyword-input {
                font-size: 14px !important;
                height: 48px !important;
            }

            .sticky-search-footer {
                position: relative;
                background: white;
                margin: 0 -1rem -1rem -1rem;
                padding: 1rem;
                border-top: 1px solid #f1f5f9;
                border-bottom-left-radius: 16px;
                border-bottom-right-radius: 16px;
                z-index: 10;
            }
        }

        .premium-tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .tag-blue {
            background: #eff6ff !important;
            color: #2563eb !important;
            border: 1px solid #dbeafe !important;
        }

        .tag-blue:hover {
            background: #dbeafe !important;
        }

        .tag-amber {
            background: #fffbeb !important;
            color: #d97706 !important;
            border: 1px solid #fef3c7 !important;
        }

        .tag-indigo {
            background: #f5f3ff !important;
            color: #4f46e5 !important;
            border: 1px solid #ede9fe !important;
        }

        .tag-indigo:hover {
            background: #ede9fe !important;
        }

        .tag-remove {
            margin-left: 6px;
            cursor: pointer;
            opacity: 0.6;
        }

        .tag-remove:hover {
            opacity: 1;
        }

        /* Custom Slider */
        .premium-slider-container {
            padding: 10px 0;
        }

        .premium-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            outline: none;
        }

        .premium-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #6366f1;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .count-badge-premium {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .count-number-premium {
            font-size: 1.75rem;
            font-weight: 800;
            color: #4f46e5;
            font-family: 'Inter', sans-serif;
        }

        .ai-search-btn {
            background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
            color: white;
            padding: 8px 16px;
        }

        .filter-toggle-btn.active {
            background-color: #4f46e5 !important;
            color: white !important;
            border-color: #4f46e5 !important;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2) !important;
        }

        .filter-toggle-btn i {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .filter-toggle-btn.active i {
            transform: rotate(180deg);
        }

        /* AI Search Box Styles */
        .ai-search-box {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .ai-search-box.collapsed .ai-search-body {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .ai-search-box:not(.collapsed) .ai-search-body {
            max-height: 500px;
            opacity: 1;
            margin-top: 1.5rem;
        }

        .ai-search-box .ai-search-toggle-icon {
            transition: transform 0.3s ease;
        }

        .ai-search-box.collapsed .ai-search-toggle-icon {
            transform: rotate(-180deg);
        }

        .ai-search-box.disabled {
            filter: grayscale(1);
            opacity: 0.5;
            cursor: not-allowed !important;
        }

        .ai-search-box.disabled * {
            cursor: not-allowed !important;
        }

        .ai-search-box.disabled .ai-search-header {
            pointer-events: none;
        }

        .ai-search-box.disabled .ai-search-body {
            display: none !important;
        }

        .ai-search-box .disabled-message {
            display: none;
            font-size: 11px;
            color: #64748b;
            font-weight: 500;
        }

        /* Advanced Filters Styles */
        .advanced-filters-container {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .advanced-filters-container.collapsed {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
            pointer-events: none;
        }

        .advanced-filters-container:not(.collapsed) {
            max-height: 3000px;
            opacity: 1;
            margin-top: 1.5rem;
        }

        .filter-toggle-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s;
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
        }

        .filter-toggle-btn:hover {
            background: #e2e8f0;
            color: #1e293b;
        }

        .filter-toggle-btn.active {
            background: #eff6ff;
            color: #2563eb;
            border-color: #bfdbfe;
        }

        .filter-toggle-btn i {
            transition: transform 0.3s ease;
        }

        .filter-toggle-btn.active i {
            transform: rotate(180deg);
        }

        .ai-search-box.disabled .disabled-message {
            display: flex;
        }

        border-radius: 8px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .ai-search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.3);
        }

        .toggle-link {
            color: #6366f1;
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }

        .toggle-link:hover {
            text-decoration: underline;
        }

        /* Select2 Customization */
        .select2-container--default .select2-selection--single,
        .select2-container--default .select2-selection--multiple {
            border: 1px solid #e2e8f0 !important;
            border-radius: 12px !important;
            min-height: 56px !important;
            padding: 0 16px !important;
            display: flex !important;
            align-items: center !important;
            background-color: white !important;
        }

        .select2-container--default.select2-container--focus .select2-selection--single,
        .select2-container--default.select2-container--focus .select2-selection--multiple {
            border-color: #6366f1 !important;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1) !important;
        }

        .select2-selection__choice {
            background: #eff6ff !important;
            border: 1px solid #dbeafe !important;
            border-radius: 4px !important;
            color: #1d4ed8 !important;
            font-size: 0.75rem !important;
            font-weight: 500 !important;
            margin-top: 5px !important;
        }

        /* Checkbox styling */
        .candidate-select-checkbox:checked,
        .job-checkbox:checked {
            background-color: #2563eb !important;
            border-color: #2563eb !important;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e") !important;
        }

        /* Select2 Multi-selection Premium UI adjustments */
        .search-card .select2-selection__choice {
            display: none !important;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__rendered {
            display: flex !important;
            flex-wrap: wrap !important;
            align-items: center !important;
            width: 100% !important;
            padding: 0 !important;
            line-height: normal !important;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__placeholder {
            margin: 0 !important;
            line-height: normal !important;
            display: inline-block !important;
            color: #94a3b8 !important;
        }

        .search-card .select2-search--inline {
            display: flex !important;
            align-items: center !important;
            margin: 0 !important;
            width: 100% !important;
        }

        .search-card .select2-search__field {
            margin: 0 !important;
            line-height: normal !important;
            padding: 0 !important;
            height: auto !important;
            min-height: 32px !important;
            width: 100% !important;
        }

        /* Ensure dropdown is always on top */
        .select2-dropdown {
            z-index: 100000 !important;
        }

        /* Floating AI Agent Styles */
        #ai-search-agent-trigger {
            position: fixed !important;
            bottom: 30px !important;
            right: 30px !important;
            width: 64px !important;
            height: 64px !important;
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%) !important;
            border-radius: 50% !important;
            display: none !important;
            align-items: center !important;
            justify-content: center !important;
            color: white !important;
            font-size: 28px !important;
            cursor: pointer !important;
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4) !important;
            z-index: 999999 !important;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
            border: 4px solid white !important;
        }

        #ai-search-agent-trigger:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 12px 32px rgba(99, 102, 241, 0.5);
        }

        #ai-search-agent-trigger .notification-dot {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 14px;
            height: 14px;
            background: #ef4444;
            border-radius: 50%;
            border: 2px solid white;
        }

        #ai-search-agent-chat {
            position: fixed;
            bottom: 110px;
            right: 30px;
            width: 400px;
            height: 550px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #f1f5f9;
            animation: chatOpen 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes chatOpen {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .chat-header {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            padding: 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chat-bubble {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.5;
            position: relative;
        }

        .chat-bubble.ai {
            align-self: flex-start;
            background: white;
            color: #1e293b;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #f1f5f9;
        }

        .chat-bubble.user {
            align-self: flex-end;
            background: #6366f1;
            color: white;
            border-bottom-right-radius: 4px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }

        .chat-footer {
            padding: 16px;
            background: white;
            border-top: 1px solid #f1f5f9;
            display: flex;
            gap: 12px;
        }

        .chat-input {
            flex: 1;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 10px 16px;
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }

        .chat-input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .chat-send-btn {
            width: 40px;
            height: 40px;
            background: #6366f1;
            color: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-send-btn:hover {
            background: #4f46e5;
            transform: scale(1.05);
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 12px;
            background: white;
            border-radius: 12px;
            align-self: flex-start;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #cbd5e1;
            border-radius: 50%;
            animation: typing 1s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {

            0%,
            60%,
            100% {
                transform: translateY(0);
            }

            30% {
                transform: translateY(-4px);
            }
        }

        @media (max-width: 640px) {
            #ai-search-agent-chat {
                width: calc(100vw - 40px);
                height: 500px;
                right: 20px;
                bottom: 90px;
            }

            #ai-search-agent-trigger {
                bottom: 20px;
                right: 20px;
                width: 56px;
                height: 56px;
            }
        }

        /* AI Search Box Specific Styles */
        .ai-search-box.searching {
            border-color: #6366f1;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.2);
        }

        .ai-search-box.searching .ai-search-toggle-icon {
            animation: ai-bounce 1s infinite;
        }

        @keyframes ai-bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        .ai-loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(2px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 30;
            border-radius: inherit;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .ai-search-box.searching .ai-loading-overlay {
            opacity: 1;
            pointer-events: auto;
        }

        .ai-scanner-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(to right, transparent, #6366f1, transparent);
            box-shadow: 0 0 10px #6366f1;
            display: none;
            z-index: 20;
            pointer-events: none;
        }

        .ai-search-box.searching .ai-scanner-line {
            display: block;
            animation: ai-scan 2.5s linear infinite;
        }

        @keyframes ai-scan {
            0% {
                top: 0%;
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                top: 100%;
                opacity: 0;
            }
        }

        .ai-loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }

        .ai-loading-text {
            color: #4338ca;
            font-weight: 800;
            font-size: 0.875rem;
            letter-spacing: 0.05em;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>

</head>

<body>
    <!-- Floating AI Search Agent -->
    <div id="ai-search-agent-trigger" onclick="toggleAISearchChat()">
        <i class="fas fa-robot"></i>
        <div class="notification-dot"></div>
    </div>

    <div id="ai-search-agent-chat">
        <div class="chat-header">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                    <i class="fas fa-robot text-xl"></i>
                </div>
                <div>
                    <h3 class="font-bold">AI„Çµ„Éù„Éº„Éà„Ç¢„Ç∑„Çπ„Çø„É≥„Éà</h3>
                    <p class="text-[10px] opacity-80 uppercase tracking-tighter">Powered by Gemini 2.5 Flash-Lite</p>
                </div>
            </div>
            <button onclick="toggleAISearchChat()" class="text-white/80 hover:text-white transition">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div id="ai-chat-body" class="chat-body custom-scrollbar">
            <div class="chat-bubble ai">
                „Åì„Çì„Å´„Å°„ÅØÔºÅRightJob„Çµ„Éù„Éº„ÉàAI„Åß„Åô„ÄÇüòä<br>
                „Ç∑„Çπ„ÉÜ„É†„ÅÆÊìç‰ΩúÊñπÊ≥ï„ÇÑ„ÄÅFAQ„Å´„Å§„ÅÑ„Å¶„ÅäÁ≠î„Åà„Åó„Åæ„Åô„ÄÇ„Çè„Åã„Çâ„Å™„ÅÑ„Åì„Å®„Åå„ÅÇ„Çå„Å∞‰Ωï„Åß„ÇÇËÅû„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
            </div>

            <!-- Typing Indicator (Hidden by default) -->
            <div id="chat-typing" class="typing-indicator" style="display: none;">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>

        <div class="chat-footer">
            <input type="text" id="ai-chat-input" class="chat-input" placeholder="‰æã: „É≠„Ç∞„Ç§„É≥„Åß„Åç„Å™„ÅÑ„ÄÅÊ±Ç‰∫∫„ÅÆÂá∫„ÅóÊñπ„ÅØÔºü"
                onkeypress="if(event.key === 'Enter') sendAIChatMessage()">
            <button onclick="sendAIChatMessage()" class="chat-send-btn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    <!-- Loading Spinner -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
        style="z-index: 20000;">
        <div class="bg-white rounded-lg p-6 flex flex-col items-center">
            <div class="spinner border-4 border-gray-200 rounded-full w-16 h-16 mb-4"></div>
            <p id="loading-message" class="text-gray-700 font-medium">Ë™≠„ÅøËæº„Åø‰∏≠...</p>
        </div>
    </div>

    <!-- Organization Selection Modal -->
    <div id="org-select-modal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">ÊâÄÂ±ûÁµÑÁπî„ÇíÈÅ∏Êäû</h3>
                <div id="org-select-list" class="space-y-3 max-h-60 overflow-y-auto">
                    <!-- Org Buttons provided by JS -->
                </div>
                <div class="mt-4">
                    <button onclick="logout()" class="text-sm text-gray-500 hover:text-gray-700 underline">
                        „É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Å¶Êàª„Çã
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Organization Modal -->
    <div id="organization-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
        style="z-index: 100000;">
        <div class="bg-white rounded-lg w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900" id="org-modal-title">ÁµÑÁπîÁ∑®ÈõÜ</h3>
                <button onclick="closeOrganizationModal()"
                    class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="organization-form" class="space-y-4">
                <input type="hidden" id="org-id">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ÁµÑÁπîÂêç <span
                            class="text-red-500">*</span></label>
                    <input type="text" id="org-name-input" required
                        class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-50">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">„Éó„É©„É≥</label>
                        <select id="org-plan"
                            class="w-full border border-gray-300 rounded px-3 py-2 bg-white focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="free">Free</option>
                            <option value="standard">Standard</option>
                            <option value="premium">Premium</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                        <select id="org-status"
                            class="w-full border border-gray-300 rounded px-3 py-2 bg-white focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="active">ÊúâÂäπ</option>
                            <option value="suspended">ÂÅúÊ≠¢‰∏≠</option>
                            <option value="cancelled">Ëß£Á¥ÑÊ∏à</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÊúÄÂ§ß„É¶„Éº„Ç∂„ÉºÊï∞</label>
                        <input type="number" id="org-max-users" min="1"
                            class="w-full border border-gray-300 rounded px-3 py-2 bg-white focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÊúâÂäπÊúüÈôê</label>
                        <input type="date" id="org-valid-until"
                            class="w-full border border-gray-300 rounded px-3 py-2 bg-white focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <!-- ÂàùÊúüÁÆ°ÁêÜËÄÖË®≠ÂÆöÔºàÊñ∞Ë¶è‰ΩúÊàêÊôÇ„ÅÆ„ÅøË°®Á§∫Ôºâ -->
                <div id="org-initial-admin-fields" class="border-t pt-4 mt-4 hidden">
                    <h4 class="text-sm font-bold text-gray-700 mb-3">ÂàùÊúüÁÆ°ÁêÜËÄÖË®≠ÂÆö</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ÁÆ°ÁêÜËÄÖÂêç <span
                                    class="text-red-500">*</span></label>
                            <input type="text" id="org-admin-name"
                                class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ÁÆ°ÁêÜËÄÖ„É°„Éº„É´ <span
                                    class="text-red-500">*</span></label>
                            <input type="email" id="org-admin-email"
                                class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <p class="text-xs text-gray-500 mt-1">‚Äª„Åì„ÅÆ„Ç¢„Éâ„É¨„Çπ„Å´ÊãõÂæÖ„É°„Éº„É´„ÅåÈÄÅ‰ø°„Åï„Çå„Åæ„Åô</p>
                        </div>
                    </div>
                </div>
                <!-- ÁµÑÁπîË®≠ÂÆö -->
                <div class="border-t pt-4 mt-4">
                    <h4 class="text-sm font-bold text-gray-700 mb-2">ÁµÑÁπî„Éª„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë®≠ÂÆö</h4>
                    <div class="space-y-2 mb-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="org-setting-email-required"
                                class="form-checkbox h-4 w-4 text-indigo-600">
                            <span class="ml-2 text-sm text-gray-700">Ê±ÇËÅ∑ËÄÖ„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„ÇπÂÖ•Âäõ„ÇíÂøÖÈ†à„Å´„Åô„Çã</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="org-setting-password-required"
                                class="form-checkbox h-4 w-4 text-indigo-600">
                            <span class="ml-2 text-sm text-gray-700">Ê±ÇËÅ∑ËÄÖ„ÅÆ„Éë„Çπ„ÉØ„Éº„ÉâË®≠ÂÆö„ÇíÂøÖÈ†à„Å´„Åô„Çã</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="org-setting-limit-agent-view"
                                class="form-checkbox h-4 w-4 text-indigo-600">
                            <span class="ml-2 text-sm text-gray-700">„Ç®„Éº„Ç∏„Çß„É≥„ÉàÈñ≤Ë¶ßÂà∂Èôê(ÊãÖÂΩìÊ±ÇËÅ∑ËÄÖ„ÅÆ„ÅøË°®Á§∫)</span>
                        </label>
                    </div>

                    <h4 class="text-sm font-bold text-gray-700 mb-2">ÂΩπÂâ≤„ÅÆË°®Á§∫ÂêçÁß∞Ë®≠ÂÆö</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">ÁµÑÁπîÁÆ°ÁêÜËÄÖ</label>
                            <input type="text" id="org-role-label-org_admin" placeholder="ÁµÑÁπîÁÆ°ÁêÜËÄÖ"
                                class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">ÁÆ°ÁêÜËÄÖ</label>
                            <input type="text" id="org-role-label-admin" placeholder="ÁÆ°ÁêÜËÄÖ"
                                class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">CA„ÉªRA („Çπ„Çø„ÉÉ„Éï)</label>
                            <input type="text" id="org-role-label-coach" placeholder="CA„ÉªRA"
                                class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Ê±ÇËÅ∑ËÄÖ</label>
                            <input type="text" id="org-role-label-candidate" placeholder="Ê±ÇËÅ∑ËÄÖ"
                                class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">‚ÄªÊú™ÂÖ•Âäõ„ÅÆÂ†¥Âêà„ÅØ„Éá„Éï„Ç©„É´„ÉàÂêçÁß∞„Åå‰ΩøÁî®„Åï„Çå„Åæ„Åô</p>
                </div>

                <!-- „É°„Éº„É´ÈÄöÁü•Ë®≠ÂÆö -->
                <div class="border-t pt-4 mt-4">
                    <h4 class="text-sm font-bold text-indigo-700 mb-2 flex items-center">
                        <i class="fas fa-envelope-open-text mr-2"></i>„É°„Éº„É´ÈÄöÁü•Ë®≠ÂÆö
                    </h4>
                    <div class="space-y-4 bg-indigo-50/50 p-4 rounded-xl border border-indigo-100">
                        <label class="flex items-center cursor-pointer group">
                            <div class="relative inline-flex items-center">
                                <input type="checkbox" id="org-setting-email-all-off" class="sr-only peer"
                                    onchange="$('#email-detailed-settings-container').toggleClass('opacity-50 pointer-events-none', this.checked)">
                                <div
                                    class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-500">
                                </div>
                            </div>
                            <span
                                class="ml-3 text-sm font-bold text-gray-700 group-hover:text-red-600 transition-colors">Ê±ÇËÅ∑ËÄÖ„Å∏„ÅÆ„É°„Éº„É´ÈÄöÁü•„Çí„Åô„Åπ„Å¶ÂÅúÊ≠¢„Åô„Çã</span>
                        </label>

                        <div id="email-detailed-settings-container" class="pl-2 space-y-4 border-l-2 border-indigo-200">
                            <div class="grid grid-cols-2 gap-3">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="org-setting-email-application"
                                        class="form-checkbox h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500"
                                        checked>
                                    <span class="ml-2 text-sm text-gray-700">ÂøúÂãüÂÆå‰∫ÜÈÄöÁü•</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="org-setting-email-scout"
                                        class="form-checkbox h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500"
                                        checked>
                                    <span class="ml-2 text-sm text-gray-700">„Çπ„Ç´„Ç¶„ÉàÈÄöÁü•</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="org-setting-email-recommendation"
                                        class="form-checkbox h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500"
                                        checked>
                                    <span class="ml-2 text-sm text-gray-700">Ê°à‰ª∂Á¥π‰ªãÈÄöÁü•</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="org-setting-email-status-enabled"
                                        class="form-checkbox h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500"
                                        checked
                                        onchange="$('#email-status-filter-container').toggleClass('hidden', !this.checked)">
                                    <span class="ml-2 text-sm text-gray-700">ÈÅ∏ËÄÉ„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥ÈÄöÁü•</span>
                                </label>
                            </div>

                            <div id="email-status-filter-container"
                                class="mt-2 p-3 bg-white rounded-lg border border-indigo-100 shadow-sm">
                                <p
                                    class="text-[11px] font-bold text-gray-500 mb-2 uppercase tracking-wider flex items-center">
                                    <i class="fas fa-filter mr-1 text-indigo-400"></i>ÈÄöÁü•„Çí<span
                                        class="text-red-500 mx-1">Èô§Â§ñ„Åô„Çã</span>„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÈÅ∏Êäû
                                </p>
                                <div id="email-status-exclude-list"
                                    class="grid grid-cols-1 sm:grid-cols-2 gap-1 max-h-40 overflow-y-auto pr-1 custom-scrollbar">
                                    <!-- Dynamic statuses populated by JS -->
                                    <div class="text-xs text-gray-400 py-2 text-center col-span-2">„Çπ„ÉÜ„Éº„Çø„Çπ„Éû„Çπ„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...
                                    </div>
                                </div>
                                <p class="text-[10px] text-gray-400 mt-2">‚Äª„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÖ•„Çå„Åü„Çπ„ÉÜ„Éº„Çø„Çπ„Å´Êõ¥Êñ∞„Åï„Çå„ÅüÈöõ„ÅØ„ÄÅ„É°„Éº„É´ÈÄöÁü•„ÅåÈÄÅ‰ø°„Åï„Çå„Åæ„Åõ„Çì„ÄÇ</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Google Drive PDF Ëª¢ÈÄÅË®≠ÂÆö -->
                <div class="border-t pt-4 mt-4">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-sm font-bold text-gray-700">Google„Éâ„É©„Ç§„ÉñPDFËª¢ÈÄÅË®≠ÂÆö</h4>
                        <span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-[10px] rounded font-bold">BETA</span>
                    </div>
                    <div class="space-y-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="org-setting-drive-transfer-enabled"
                                class="form-checkbox h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500"
                                onchange="$('#drive-transfer-settings-container').toggleClass('hidden', !this.checked)">
                            <span class="ml-2 text-sm text-gray-700 font-medium">Ê±Ç‰∫∫PDF„Ç§„É≥„Éù„Éº„ÉàÊôÇ„Å´Google„Éâ„É©„Ç§„Éñ„Å∏‰øùÂ≠ò„Åô„Çã</span>
                        </label>

                        <div id="drive-transfer-settings-container"
                            class="pl-6 space-y-4 hidden border-l-2 border-indigo-100 py-1">
                            <div>
                                <label
                                    class="block text-[11px] font-bold text-gray-500 uppercase tracking-wider mb-1">Ëª¢ÈÄÅÁî®GAS
                                    Web„Ç¢„Éó„É™URL</label>
                                <input type="url" id="org-setting-drive-gas-url"
                                    placeholder="https://script.google.com/macros/s/.../exec"
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                                <p class="text-[10px] text-gray-400 mt-1">‚Äª„Éï„Ç°„Ç§„É´„Çí‰øùÂ≠ò„Åô„Çã„Åü„ÇÅ„ÅÆGoogle Apps Script
                                    Web„Ç¢„Éó„É™URL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                            </div>
                            <div>
                                <label
                                    class="block text-[11px] font-bold text-gray-500 uppercase tracking-wider mb-1">‰øùÂ≠òÂÖà„Ç´„É©„É†
                                    (jobs„ÉÜ„Éº„Éñ„É´)</label>
                                <input type="text" id="org-setting-drive-column" placeholder="pdf_url"
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                                <p class="text-[10px] text-gray-400 mt-1">‚ÄªDB„Å´‰∫ãÂâç„Å´„Ç´„É©„É†„ÇíËøΩÂä†„Åó„Å¶„Åä„ÅèÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„ÅôÔºà‰æã: pdf_urlÔºâ</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Google Drive PDF „Ç§„É≥„Éù„Éº„ÉàË®≠ÂÆö -->
                <div class="border-t pt-4 mt-4">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-sm font-bold text-gray-700">Google„Éâ„É©„Ç§„ÉñÊ±Ç‰∫∫PDF„Ç§„É≥„Éù„Éº„ÉàË®≠ÂÆö</h4>
                        <span class="px-2 py-0.5 bg-green-100 text-green-700 text-[10px] rounded font-bold">NEW</span>
                    </div>
                    <div class="space-y-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="org-setting-drive-import-enabled"
                                class="form-checkbox h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500"
                                onchange="$('#drive-import-settings-container').toggleClass('hidden', !this.checked)">
                            <span class="ml-2 text-sm text-gray-700 font-medium">Google„Éâ„É©„Ç§„Éñ„Åã„ÇâÊ±Ç‰∫∫PDF„Çí‰∏ÄÊã¨„Ç§„É≥„Éù„Éº„ÉàÂèØËÉΩ„Å´„Åô„Çã</span>
                        </label>

                        <div id="drive-import-settings-container"
                            class="pl-6 space-y-4 hidden border-l-2 border-green-100 py-1">
                            <div>
                                <label
                                    class="block text-[11px] font-bold text-gray-500 uppercase tracking-wider mb-1">„Ç§„É≥„Éù„Éº„ÉàÁî®GAS
                                    Web„Ç¢„Éó„É™URL</label>
                                <input type="url" id="org-setting-drive-import-gas-url"
                                    placeholder="https://script.google.com/macros/s/.../exec"
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                                <p class="text-[10px] text-gray-400 mt-1">‚ÄªÊ±Ç‰∫∫Á•®PDF„ÇíÂèñÂæó„ÉªËß£Êûê„Åô„Çã„Åü„ÇÅ„ÅÆGoogle Apps Script
                                    Web„Ç¢„Éó„É™URL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                            </div>
                            <div>
                                <label
                                    class="block text-[11px] font-bold text-gray-500 uppercase tracking-wider mb-1">Google„Éâ„É©„Ç§„ÉñURL‰øùÂ≠òÁî®„Ç´„É©„É†
                                    (jobs„ÉÜ„Éº„Éñ„É´)</label>
                                <input type="text" id="org-setting-drive-import-column" placeholder="pdf_url"
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                                <p class="text-[10px] text-gray-400 mt-1">‚Äª‰∏ÄÊã¨ÂêåÊúü„Åó„ÅüURL„ÅÆ‰øùÂ≠òÂÖà„ÇíÊåáÂÆö„Åó„Åæ„ÅôÔºà‰æã: pdf_url „Åæ„Åü„ÅØ urlÔºâ</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ê±Ç‰∫∫„Ç§„É≥„Éù„Éº„ÉàË®≠ÂÆö -->
                <div class="border-t pt-4 mt-4">
                    <h4 class="text-sm font-bold text-gray-700 mb-2">Ê±Ç‰∫∫„Ç§„É≥„Éù„Éº„ÉàË®≠ÂÆö</h4>
                    <div class="space-y-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="org-setting-bulk-duplicate-confirm"
                                class="form-checkbox h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                            <span class="ml-2 text-sm text-gray-700 font-medium">Ë§áÊï∞PDFÂèñ„ÇäËæº„ÅøÊôÇ„Å´ÈáçË§áÁñë„ÅÑ„ÇíÂæå„Åß‰∏ÄÊã¨Á¢∫Ë™ç„Åô„Çã</span>
                        </label>
                        <p class="text-[10px] text-gray-400 ml-6 mt-[-10px]">
                            ‚ÄªON„ÅÆÂ†¥Âêà„ÄÅÂá¶ÁêÜ‰∏≠„Å´‰∏Ä„Å§„Åö„Å§Á¢∫Ë™ç„Åõ„Åö„ÄÅÊúÄÂæå„Å´‰∏ÄË¶ß„Åß„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶ÁôªÈå≤„Åß„Åç„Åæ„Åô„ÄÇ
                        </p>
                    </div>
                </div>

                <div class="flex justify-end pt-4 gap-3">
                    <button type="button" onclick="closeOrganizationModal()"
                        class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded">„Ç≠„É£„É≥„Çª„É´</button>
                    <button type="submit"
                        class="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 shadow-sm">‰øùÂ≠ò„Åô„Çã</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Invitation URL Modal -->
    <div id="invitation-url-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
        style="z-index: 100010;">
        <div class="bg-white rounded-lg w-full max-w-md p-6">
            <div class="text-center mb-6">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                    <i class="fas fa-check text-green-600 text-xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900">ÊãõÂæÖURL„ÇíÁô∫Ë°å„Åó„Åæ„Åó„Åü</h3>
                <p class="text-sm text-gray-500 mt-2">
                    <span id="invite-org-name" class="font-bold"></span> „ÅÆÁÆ°ÁêÜËÄÖ„Å®„Åó„Å¶<br>
                    <span id="invite-admin-email" class="font-bold"></span> „ÇíÊãõÂæÖ„Åó„Åæ„Åó„Åü„ÄÇ
                </p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ÊãõÂæÖURL</label>
                    <div class="flex gap-2">
                        <input type="text" id="invitation-url-display" readonly
                            class="w-full bg-gray-50 border border-gray-300 rounded px-3 py-2 text-sm text-gray-600">
                        <button onclick="copyInvitationUrl()"
                            class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-700" title="„Ç≥„Éî„Éº">
                            <i class="far fa-copy"></i>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">‚Äª„É°„Éº„É´ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„ÅüÂ†¥Âêà„Å™„Å©„ÅØ„ÄÅ„Åì„ÅÆURL„ÇíÁõ¥Êé•ÁÆ°ÁêÜËÄÖ„Å´‰ºù„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                </div>

                <div class="flex flex-col gap-2 mt-6">
                    <button onclick="sendInvitationEmail()"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none sm:text-sm">
                        <i class="fas fa-paper-plane mr-2 pt-1"></i> „É°„Éº„É´„ÇíÂÜçÈÄÅ‰ø°
                    </button>
                    <button onclick="closeInvitationUrlModal()"
                        class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:text-sm">
                        Èñâ„Åò„Çã
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="page active">
        <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-100 to-purple-100 px-4">
            <div class="max-w-md w-full bg-white rounded-2xl shadow-xl p-8">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">RightJob „Éû„ÉÉ„ÉÅ„É≥„Ç∞</h1>
                    <p class="text-gray-600">„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                </div>

                <form id="login-form" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                        <input type="email" id="login-email" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                        <input type="password" id="login-password" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>

                    <div id="login-error" class="text-red-600 text-sm hidden"></div>

                    <button type="submit"
                        class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">
                        „É≠„Ç∞„Ç§„É≥
                    </button>
                </form>

                <div class="mt-6 text-center">
                    <a href="#" id="show-signup" class="text-indigo-600 hover:text-indigo-700 text-sm">
                        „Ç¢„Ç´„Ç¶„É≥„Éà„Çí„ÅäÊåÅ„Å°„Åß„Å™„ÅÑÊñπ„ÅØ„Åì„Å°„Çâ
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Signup Page -->
    <div id="signup-page" class="page">
        <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-100 to-purple-100 px-4">
            <div class="max-w-md w-full bg-white rounded-2xl shadow-xl p-8">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Êñ∞Ë¶èÁôªÈå≤</h1>
                    <p class="text-gray-600">ÁµÑÁπî„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶ÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                </div>

                <form id="signup-form" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÁµÑÁπî„Ç≥„Éº„Éâ <span
                                class="text-xs text-gray-500 font-normal">ÔºàÊãÖÂΩìËÄÖ„Åã„ÇâÈÖçÂ∏É„Åï„Çå„Åü„Ç≥„Éº„ÉâÔºâ</span></label>
                        <div class="flex gap-2">
                            <input type="text" id="signup-org-code" required placeholder="‰æã: A1B2C3D4"
                                class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent uppercase">
                            <button type="button" id="check-org-code"
                                class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition text-sm font-medium whitespace-nowrap">
                                Á¢∫Ë™ç
                            </button>
                        </div>
                        <p id="org-name-display" class="mt-2 text-sm text-green-600 font-bold hidden"></p>
                        <p id="org-code-error" class="mt-1 text-sm text-red-500 hidden"></p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">„ÅäÂêçÂâç</label>
                        <input type="text" id="signup-name" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">„Åµ„Çä„Åå„Å™</label>
                        <input type="text" id="signup-furigana"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                        <input type="email" id="signup-email" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                        <input type="password" id="signup-password" required minlength="6"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>

                    <input type="hidden" id="invitation-token">

                    <div id="signup-error" class="text-red-600 text-sm hidden"></div>

                    <button type="submit"
                        class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">
                        ÁôªÈå≤„Åô„Çã
                    </button>
                </form>

                <div class="mt-6 text-center">
                    <a href="#" id="show-login" class="text-indigo-600 hover:text-indigo-700 text-sm">
                        „É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏„Å´Êàª„Çã
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-page" class="page">
        <!-- Sidebar -->
        <aside class="sidebar flex flex-col">
            <div class="p-6 flex-shrink-0">
                <h2 class="text-2xl font-bold text-white">RightJob</h2>
                <div class="flex items-center gap-2 mt-1">
                    <div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>
                    <p id="org-name" class="text-sm text-indigo-300"></p>
                </div>
                <p id="org-code-display"
                    class="text-[10px] text-indigo-200 mt-2 font-mono bg-white/5 px-2 py-1 rounded inline-block border border-white/10 uppercase tracking-widest">
                </p>
            </div>

            <nav class="px-3 space-y-1 flex-1 overflow-y-auto custom-scrollbar">
                <a href="#" id="nav-dashboard" data-page="dashboard"
                    class="nav-link flex items-center px-4 py-3 rounded-lg transition active">
                    <i class="fas fa-home w-5"></i>
                    <span class="ml-3">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</span>
                </a>
                <a href="#" data-page="jobs" class="nav-link flex items-center px-4 py-3 rounded-lg transition">
                    <i class="fas fa-briefcase w-5"></i>
                    <span class="ml-3">Ê±Ç‰∫∫Ê§úÁ¥¢</span>
                </a>
                <a href="#" id="nav-candidate-search" data-page="candidate-search"
                    class="nav-link hidden flex items-center px-4 py-3 rounded-lg transition">
                    <i class="fas fa-users w-5"></i>
                    <span class="ml-3">Ê±ÇËÅ∑ËÄÖÊ§úÁ¥¢</span>
                </a>

                <a href="#" data-page="ai-scout" id="ai-scout-link"
                    class="nav-link hidden flex items-center px-4 py-3 rounded-lg transition">
                    <i class="fas fa-robot w-5"></i>
                    <span class="ml-3">AI„Çπ„Ç´„Ç¶„Éà</span>
                </a>

                <a href="#" data-page="applications" class="nav-link flex items-center px-4 py-3 rounded-lg transition">
                    <i class="fas fa-file-alt w-5"></i>
                    <span class="ml-3">ÂøúÂãü„ÉªÈÅ∏ËÄÉÁä∂Ê≥Å</span>
                </a>
                <a href="#" data-page="recommendations"
                    class="nav-link flex items-center px-4 py-3 rounded-lg transition">
                    <i class="fas fa-robot w-5"></i>
                    <span class="ml-3">„Åä„Åô„Åô„ÇÅÊ±Ç‰∫∫</span>
                </a>
                <a href="#" data-page="profile" class="nav-link flex items-center px-4 py-3 rounded-lg transition">
                    <i class="fas fa-user w-5"></i>
                    <span class="ml-3">„Éó„É≠„Éï„Ç£„Éº„É´</span>
                </a>

                <!-- Coach Menu (visible only for coach) -->
                <div id="coach-menu" class="hidden mt-6 pt-6 border-t border-white/10">
                    <p class="px-4 text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-3">CA„ÉªRA„É°„Éã„É•„Éº</p>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="coach-students">
                        <i class="fas fa-user-graduate w-5"></i>
                        <span class="ml-3">ÊãÖÂΩìÊ±ÇËÅ∑ËÄÖ</span>
                    </a>
                </div>

                <!-- Admin Menu (visible only for org_admin and admin) -->
                <div id="admin-menu" class="hidden mt-6 pt-6 border-t border-white/10">
                    <p class="px-4 text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-3">ÁÆ°ÁêÜËÄÖ„É°„Éã„É•„Éº</p>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-jobs">
                        <i class="fas fa-briefcase w-5"></i>
                        <span class="ml-3">Ê±Ç‰∫∫ÁÆ°ÁêÜ</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-companies">
                        <i class="fas fa-building w-5"></i>
                        <span class="ml-3">‰ºÅÊ•≠ÁÆ°ÁêÜ</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-applicants">
                        <i class="fas fa-users w-5"></i>
                        <span class="ml-3">ÂøúÂãüËÄÖÁÆ°ÁêÜ</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-candidates">
                        <i class="fas fa-user-graduate w-5"></i>
                        <span class="ml-3">Ê±ÇËÅ∑ËÄÖÁÆ°ÁêÜ</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-users">
                        <i class="fas fa-user-cog w-5"></i>
                        <span class="ml-3">„É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-csv">
                        <i class="fas fa-file-upload w-5"></i>
                        <span class="ml-3">CSV„Ç§„É≥„Éù„Éº„Éà</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-logs">
                        <i class="fas fa-history w-5"></i>
                        <span class="ml-3">Êìç‰Ωú„É≠„Ç∞</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-data-management">
                        <i class="fas fa-broom w-5"></i>
                        <span class="ml-3">ÈáçË§á„Éá„Éº„ÇøÁÆ°ÁêÜ</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="kpi-dashboard">
                        <i class="fas fa-chart-line w-5"></i>
                        <span class="ml-3">KPI„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-yomi-management">
                        <i class="fas fa-funnel-dollar w-5"></i>
                        <span class="ml-3">„É®„ÉüÁÆ°ÁêÜ (ÈÄ≤Êçó„ÉªÂÖ•Èáë)</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-templates">
                        <i class="fas fa-file-invoice w-5"></i>
                        <span class="ml-3">„ÉÜ„É≥„Éó„É¨„Éº„ÉàÁÆ°ÁêÜ</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-settings">
                        <i class="fas fa-cog w-5"></i>
                        <span class="ml-3">ÁµÑÁπî„ÉªÈÄöÁü•Ë®≠ÂÆö</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-faqs">
                        <i class="fas fa-question-circle w-5"></i>
                        <span class="ml-3">FAQ„Éª„Éû„Éã„É•„Ç¢„É´ÁÆ°ÁêÜ</span>
                    </a>
                    <a href="javascript:void(0)"
                        class="nav-link-custom flex items-center px-4 py-3 rounded-lg transition hover:bg-slate-50 text-slate-600 font-medium"
                        onclick="event.preventDefault(); openFAQModal();">
                        <i class="fas fa-life-ring w-5 text-indigo-400"></i>
                        <span class="ml-3">„Éò„É´„Éó„Éù„Éº„Çø„É´„ÇíË°®Á§∫</span>
                    </a>

                </div>

                <!-- Super Admin Menu (visible only for super_admin) -->
                <div id="super-admin-menu" class="hidden mt-6 pt-6 border-t border-gray-200">
                    <p class="px-4 text-xs font-semibold text-red-400 uppercase tracking-wider mb-3">„Çπ„Éº„Éë„ÉºÁÆ°ÁêÜËÄÖ</p>
                    <a href="#"
                        class="nav-link flex items-center px-4 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600 rounded-lg transition"
                        data-page="super-admin-organizations">
                        <i class="fas fa-building w-5"></i>
                        <span class="ml-3">ÁµÑÁπîÁÆ°ÁêÜ</span>
                    </a>
                    <a href="#"
                        class="nav-link flex items-center px-4 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600 rounded-lg transition"
                        data-page="admin-prompts">
                        <i class="fas fa-cog w-5"></i>
                        <span class="ml-3">„Éó„É≠„É≥„Éó„ÉàË®≠ÂÆö</span>
                    </a>
                    <a href="#"
                        class="nav-link flex items-center px-4 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600 rounded-lg transition"
                        data-page="admin-master">
                        <i class="fas fa-database w-5"></i>
                        <span class="ml-3">„Éû„Çπ„Çø„Éá„Éº„ÇøÁÆ°ÁêÜ</span>
                    </a>
                </div>
            </nav>

            <div class="p-4 border-t border-white/10 flex-shrink-0 bg-transparent">
                <div class="flex items-center mb-3">
                    <div class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-indigo-300"></i>
                    </div>
                    <div class="ml-3">
                        <p id="user-name" class="text-sm font-medium text-white"></p>
                        <p id="user-role" class="text-xs text-indigo-200 mb-1"></p>
                        <button onclick="showOrgSelectModalForSwitch()"
                            class="hidden text-[10px] text-indigo-300 hover:text-indigo-100 font-bold flex items-center gap-1">
                            <i class="fas fa-exchange-alt"></i> ÁµÑÁπî„ÇíÂàá„ÇäÊõø„Åà„Çã
                        </button>
                    </div>
                </div>
                <button id="logout-btn"
                    class="w-full px-4 py-2 text-sm text-red-400 hover:bg-red-400/10 rounded-lg transition">
                    <i class="fas fa-sign-out-alt mr-2"></i>„É≠„Ç∞„Ç¢„Ç¶„Éà
                </button>
            </div>
        </aside>
        <!-- Sidebar Overlay -->
        <div id="sidebar-overlay" class="sidebar-overlay"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="bg-white border-b border-gray-200 px-4 sm:px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <button id="mobile-menu-btn"
                            class="md:hidden w-10 h-10 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded-lg shadow-sm active:scale-95 transition">
                            <i class="fas fa-bars text-xl"></i>
                        </button>
                        <h1 id="page-title"
                            class="text-xl sm:text-2xl font-bold text-gray-900 truncate max-w-[150px] sm:max-w-none">
                            „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</h1>
                    </div>
                    <div class="flex items-center gap-2 sm:gap-4">
                        <!-- Organization Switcher (Super Admin only) -->
                        <div id="org-switcher-container" class="hidden">
                            <select id="org-switcher"
                                class="border border-red-300 rounded-md px-3 py-1 text-xs sm:text-sm focus:outline-none focus:ring-2 focus:ring-red-500 bg-red-50 text-red-900 font-medium max-w-[100px] sm:max-w-none">
                                <option value="">ÁµÑÁπî„ÇíÈÅ∏Êäû...</option>
                            </select>
                        </div>

                        <!-- Notification Bell -->
                        <div class="relative">
                            <button id="notification-btn"
                                class="relative p-2 text-gray-600 hover:text-gray-900 bg-gray-50 rounded-lg">
                                <i class="fas fa-bell text-lg sm:text-xl"></i>
                                <span id="notification-badge"
                                    class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[10px] rounded-full min-w-[18px] h-[18px] flex items-center justify-center px-1">0</span>
                            </button>
                            <!-- Notification Dropdown -->
                            <div id="notification-dropdown"
                                class="hidden absolute right-0 mt-2 w-72 sm:w-80 bg-white rounded-lg shadow-xl border z-50">
                                <div class="p-4 border-b">
                                    <h3 class="font-semibold text-sm sm:text-base">ÈÄöÁü•</h3>
                                </div>
                                <div id="notification-list" class="max-h-96 overflow-y-auto">
                                    <!-- Notifications will be rendered here -->
                                </div>
                            </div>
                        </div>

                        <!-- Help/FAQ Button -->
                        <div class="relative">
                            <button id="help-portal-btn" onclick="openFAQModal()"
                                class="p-2 text-indigo-600 hover:text-indigo-900 bg-indigo-50 rounded-lg flex items-center gap-1.5 transition-all hover:shadow-md">
                                <i class="fas fa-question-circle text-lg sm:text-xl"></i>
                                <span class="text-sm font-bold hidden sm:inline">„Éò„É´„Éó</span>
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Dashboard Page -->
            <div id="dashboard-content" class="app-content p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Stats Cards -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">ÂøúÂãü‰∏≠</p>
                                <p id="stat-applications" class="text-3xl font-bold text-indigo-600 mt-2">0</p>
                            </div>
                            <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-file-alt text-indigo-600 text-xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">AIÁ¥π‰ªã</p>
                                <p id="stat-recommendations" class="text-3xl font-bold text-purple-600 mt-2">0</p>
                            </div>
                            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-star text-purple-600 text-xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">Èñ≤Ë¶ß„Åó„ÅüÊ±Ç‰∫∫</p>
                                <p id="stat-views" class="text-3xl font-bold text-green-600 mt-2">0</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-eye text-green-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6 border-b">
                        <h2 class="text-lg font-semibold text-gray-900">ÊúÄËøë„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£</h2>
                    </div>
                    <div id="recent-activity" class="p-6">
                        <p class="text-gray-500 text-center py-8">„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                    </div>
                </div>
            </div>

            <!-- Jobs Page -->
            <div id="jobs-content" class="app-content p-6 hidden">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <div class="flex items-center gap-4">
                        <h2 class="text-2xl font-bold text-gray-900">Ê±Ç‰∫∫Ê§úÁ¥¢</h2>
                    </div>
                </div>

                <div class="search-card mb-8">
                    <!-- Admin/Coach: User Selection (Integrated) -->
                    <div id="admin-job-search-tools" class="mb-6 pb-6 border-b border-slate-100 hidden">
                        <div class="filter-group-label">
                            <i class="fas fa-user-circle text-indigo-500"></i> ÂØæË±°„É¶„Éº„Ç∂„Éº <span
                                class="admin-badge ml-2">ÁÆ°ÁêÜËÄÖÂ∞ÇÁî®</span>
                        </div>
                        <div class="relative">
                            <div id="target-user-input-wrapper">
                                <input type="text" id="target-user-search" placeholder="„É¶„Éº„Ç∂„ÉºÂêç„Åæ„Åü„ÅØ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅßÊ§úÁ¥¢..."
                                    class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all" />
                                <i class="fas fa-search absolute right-3 top-3 text-slate-400"></i>
                            </div>
                            <div id="target-user-dropdown"
                                class="hidden absolute w-full bg-white border border-slate-200 rounded-lg shadow-xl mt-1 z-50 max-h-60 overflow-y-auto">
                            </div>
                            <div id="selected-user-display"
                                class="hidden mt-2 p-3 bg-indigo-50 border border-indigo-100 rounded-lg flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold"
                                        id="selected-user-avatar">?</div>
                                    <div>
                                        <div class="font-bold text-slate-900" id="selected-user-name"></div>
                                        <div class="text-xs text-slate-500" id="selected-user-email"></div>
                                    </div>
                                </div>
                                <button id="clear-user-selection"
                                    class="text-slate-400 hover:text-red-500 transition-colors">
                                    <i class="fas fa-times-circle text-xl"></i>
                                </button>
                            </div>
                        </div>
                    </div>


                    <!-- Candidate: Preferred Search -->
                    <div id="candidate-preferred-search-box" class="mb-6 pb-6 border-b border-slate-100 hidden">
                        <div class="filter-group-label mb-3">
                            <i class="fas fa-magic text-indigo-500"></i> „Éó„É≠„Éï„Ç£„Éº„É´„Å´Âêà„Çè„Åõ„Å¶Êé¢„Åô
                        </div>
                        <button onclick="applyPreferredConditions()"
                            class="w-full sm:w-auto px-8 py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-2xl hover:from-indigo-700 hover:to-purple-700 font-bold transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-3 active:scale-95">
                            <i class="fas fa-user-check text-xl"></i>
                            <div class="text-left">
                                <div class="text-xs opacity-90 leading-none mb-1">„ÅÇ„Å™„Åü„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´Ë®≠ÂÆö„Å´Âü∫„Å•„Åç</div>
                                <div class="text-lg leading-none">Â∏åÊúõÊù°‰ª∂„ÇíËá™Âãï„Çª„ÉÉ„Éà</div>
                            </div>
                        </button>
                    </div>

                    <!-- Primary Search Row upgraded with more fields -->

                    <div class="flex flex-col gap-6 mb-4 mt-6">
                        <!-- Row 1: Search Box & Count -->
                        <div class="flex flex-col md:flex-row items-stretch gap-4">
                            <div class="flex-1">
                                <div class="space-y-3">
                                    <div class="relative group">
                                        <input type="text" id="search-keyword" placeholder="Ê±Ç‰∫∫„Çø„Ç§„Éà„É´„ÄÅ‰ºÅÊ•≠Âêç„ÄÅ„Çπ„Ç≠„É´„Å™„Å©..."
                                            class="w-full h-14 px-12 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 outline-none shadow-sm transition-all focus:border-indigo-500 text-base">
                                        <i
                                            class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                                    </div>

                                    <!-- Mode Switch (Always Visible below input) -->
                                    <div
                                        class="flex p-1 bg-slate-100/50 rounded-xl border border-slate-200 w-fit h-10 items-center">
                                        <label class="relative flex items-center cursor-pointer h-full">
                                            <input type="radio" name="search-keyword-mode" value="OR" checked
                                                class="sr-only peer">
                                            <div
                                                class="px-5 py-1.5 rounded-lg text-xs font-bold text-slate-500 peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm transition-all whitespace-nowrap">
                                                ORÊ§úÁ¥¢</div>
                                        </label>
                                        <label class="relative flex items-center cursor-pointer h-full">
                                            <input type="radio" name="search-keyword-mode" value="AND"
                                                class="sr-only peer">
                                            <div
                                                class="px-5 py-1.5 rounded-lg text-xs font-bold text-slate-500 peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm transition-all whitespace-nowrap">
                                                ANDÊ§úÁ¥¢</div>
                                        </label>
                                    </div>
                                </div>
                                <div id="tags-keyword" class="tag-container mt-2 px-1"></div>
                            </div>

                            <!-- Count Display -->
                            <div id="job-count-display-premium"
                                class="hidden flex items-center px-6 h-14 bg-white border-2 border-indigo-100/50 rounded-2xl shadow-sm">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-indigo-50 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-briefcase text-indigo-500"></i>
                                    </div>
                                    <div class="flex flex-col leading-none">
                                        <span
                                            class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-0.5">Matches</span>
                                        <div class="flex items-baseline gap-1">
                                            <span id="job-count-number"
                                                class="text-xl font-bold text-indigo-600 font-mono">0</span>
                                            <span class="text-xs text-slate-400 font-bold">‰ª∂</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Row 2: Location & Job Category (Moved to Primary) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <div class="relative">
                                    <select id="search-job-category" class="w-full select2" multiple="multiple"
                                        data-placeholder="ÂÖ®„Å¶„ÅÆËÅ∑Á®Æ"></select>
                                    <div id="tags-job" class="tag-container mt-1"></div>
                                </div>
                            </div>
                            <div>
                                <div class="relative">
                                    <select id="search-prefecture" class="w-full select2" multiple="multiple"
                                        data-placeholder="Âã§ÂãôÂú∞ÔºàÈÉΩÈÅìÂ∫úÁúåÔºâ"></select>
                                    <div id="tags-prefecture" class="tag-container mt-1"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Row 3: Saved Search, Mode & Actions -->
                        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                            <!-- Saved Search Controls -->
                            <div class="flex items-center gap-4">
                                <div
                                    class="flex items-center gap-2 bg-slate-50 px-4 py-2 rounded-xl border border-slate-100 shadow-sm transition-all hover:border-indigo-200">
                                    <i class="fas fa-bookmark text-indigo-500 text-sm"></i>
                                    <select id="saved-searches-select" onchange="loadSavedSearch(this.value)"
                                        class="text-sm bg-transparent outline-none focus:ring-0 min-w-[150px] font-medium text-slate-700">
                                        <option value="">‰øùÂ≠ò„Åó„ÅüÊ§úÁ¥¢Êù°‰ª∂</option>
                                    </select>
                                </div>
                                <button onclick="saveSearchConditions()"
                                    class="text-indigo-600 hover:text-indigo-800 text-sm font-bold flex items-center gap-1.5 px-2">
                                    <i class="fas fa-plus-circle text-base"></i> Êù°‰ª∂„Çí‰øùÂ≠ò
                                </button>
                            </div>

                            <div class="flex flex-wrap lg:flex-nowrap items-center gap-3">

                                <!-- Exclude Matched/Applied Checkboxes -->
                                <div id="exclude-filters-container" class="flex gap-2">
                                    <label id="exclude-matched-container"
                                        class="flex items-center gap-2 cursor-pointer group bg-purple-50 px-4 py-2 rounded-xl border border-purple-100 shadow-sm hover:border-purple-200 transition-all hidden">
                                        <input type="checkbox" id="search-exclude-matched"
                                            class="w-4 h-4 accent-purple-600 border-slate-300 rounded">
                                        <span
                                            class="text-xs text-purple-700 font-bold whitespace-nowrap">AI„Éû„ÉÉ„ÉÅÊ∏à„Åø„ÇíÈô§„Åè</span>
                                    </label>
                                    <label id="exclude-applied-container"
                                        class="flex items-center gap-2 cursor-pointer group bg-emerald-50 px-4 py-2 rounded-xl border border-emerald-100 shadow-sm hover:border-emerald-200 transition-all hidden">
                                        <input type="checkbox" id="search-exclude-applied"
                                            class="w-4 h-4 accent-emerald-600 border-slate-300 rounded">
                                        <span
                                            class="text-xs text-emerald-700 font-bold whitespace-nowrap">ÂøúÂãüÊ∏à„Åø„ÇíÈô§„Åè</span>
                                    </label>
                                </div>

                                <div class="flex gap-2 h-14">
                                    <button id="toggle-advanced-filters" onclick="toggleAdvancedFilters()"
                                        class="filter-toggle-btn px-6 bg-white border-2 border-indigo-100 text-indigo-600 rounded-2xl hover:bg-indigo-50 font-bold transition-all flex items-center gap-2 whitespace-nowrap shadow-sm">
                                        <i class="fas fa-sliders-h"></i> <span class="hidden sm:inline">Ë©≥Á¥∞Êù°‰ª∂</span>
                                    </button>
                                    <button onclick="clearSearch()"
                                        class="px-5 border-2 border-slate-100 text-slate-400 rounded-2xl hover:text-red-500 hover:bg-red-50 hover:border-red-100 transition shadow-sm"
                                        title="Ê§úÁ¥¢Êù°‰ª∂„Çí„ÇØ„É™„Ç¢">
                                        <i class="fas fa-rotate-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>



                    <!-- Advanced Filters Container (Collapsible) -->
                    <div id="advanced-filters-body"
                        class="advanced-filters-container collapsed pt-6 border-t border-slate-100">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 mb-8">
                            <!-- Col 1: Salary & remote -->
                            <div class="space-y-6">
                                <div>
                                    <label class="filter-group-label">Â∏åÊúõÂπ¥Âèé</label>
                                    <div class="premium-slider-container">
                                        <input type="range" id="search-salary-slider" min="0" max="2000" step="50"
                                            value="0" class="premium-slider"
                                            oninput="$('#salary-display').text(this.value === '0' ? 'ÊåáÂÆö„Å™„Åó' : this.value + ' ‰∏áÂÜÜ‰ª•‰∏ä')">
                                        <div class="flex justify-between mt-2">
                                            <span class="text-[10px] text-slate-400">0</span>
                                            <span id="salary-display"
                                                class="text-sm font-bold text-indigo-600 font-mono">ÊåáÂÆö„Å™„Åó</span>
                                            <span class="text-[10px] text-slate-400">2000‰∏á</span>
                                        </div>
                                        <input type="hidden" id="search-salary-min" value="0">
                                    </div>
                                </div>
                                <div>
                                    <label class="filter-group-label">Ë°®Á§∫Ë®≠ÂÆö</label>
                                    <div class="flex flex-col gap-3 mt-2">

                                        <label class="flex items-center gap-2 cursor-pointer group">
                                            <input type="checkbox" id="search-favorites-only"
                                                class="w-5 h-5 accent-pink-500 border-slate-300 rounded">
                                            <span
                                                class="text-sm text-pink-600 font-medium group-hover:text-pink-900">„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅÆ„Åø</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Col 2: Industry -->
                            <div class="space-y-6">
                                <div>
                                    <label class="filter-group-label">Ê•≠Á®Æ</label>
                                    <select id="search-industry-category" class="w-full select2"
                                        multiple="multiple"></select>
                                    <div id="tags-industry" class="tag-container mt-1"></div>
                                </div>
                                <div>
                                    <label class="filter-group-label">ËøΩÂä†Êù°‰ª∂</label>
                                    <div class="flex flex-col gap-3 mt-2">
                                        <label class="flex items-center gap-2 cursor-pointer group">
                                            <input type="checkbox" id="search-job-experience-ok"
                                                class="w-5 h-5 accent-indigo-600 border-slate-300 rounded">
                                            <span
                                                class="text-sm text-slate-600 group-hover:text-slate-900">ËÅ∑Á®ÆÊú™ÁµåÈ®ìOK</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer group">
                                            <input type="checkbox" id="search-industry-experience-ok"
                                                class="w-5 h-5 accent-indigo-600 border-slate-300 rounded">
                                            <span
                                                class="text-sm text-slate-600 group-hover:text-slate-900">Ê•≠ÁïåÊú™ÁµåÈ®ìOK</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Col 3: Employment & Free word -->
                            <div class="space-y-6">
                                <div>
                                    <label class="filter-group-label">ÈõáÁî®ÂΩ¢ÊÖã</label>
                                    <select id="search-employment-type" class="w-full select2"
                                        multiple="multiple"></select>
                                    <div id="tags-employment" class="tag-container mt-1"></div>
                                </div>
                                <div>
                                    <label class="filter-group-label">„Ç®„É™„Ç¢Ë©≥Á¥∞(ÈßÖÂêç„ÉªÂú∞Âêç)</label>
                                    <div class="relative">
                                        <input type="text" id="search-location" placeholder="ÁâπÂÆö„ÅÆÂú∞Âêç„ÄÅÈßÖÂêç„Å™„Å©..."
                                            class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                                        <i class="fas fa-map-marked-alt absolute right-3 top-3 text-slate-400"></i>
                                    </div>
                                    <div id="tags-freeword" class="tag-container mt-1"></div>
                                </div>
                            </div>
                        </div>

                        <!-- AI Search Prompt -->
                        <div id="job-ai-search-box"
                            class="ai-search-box bg-white disabled collapsed mt-8 p-6 bg-gradient-to-r from-indigo-50/50 to-purple-50/50 rounded-2xl border border-indigo-100 shadow-sm relative overflow-hidden group">
                            <!-- AI Loading UI -->
                            <div class="ai-scanner-line"></div>
                            <div class="ai-loading-overlay">
                                <div class="ai-loading-spinner"></div>
                                <div class="ai-loading-text">AI„ÅåÁ¥π‰ªãÊñá„Å®Ê±Ç‰∫∫„ÇíÁ≤æÊüª‰∏≠...</div>
                            </div>
                            <div
                                class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                <i class="fas fa-robot text-6xl text-indigo-600"></i>
                            </div>
                            <div class="relative">
                                <div class="ai-search-header flex justify-between items-center cursor-pointer select-none"
                                    onclick="toggleAISearch('job')">
                                    <div class="flex items-center gap-3">
                                        <label class="flex items-center gap-2 m-0">
                                            <span class="bg-white p-2 rounded-lg shadow-sm text-indigo-600">
                                                <i class="fas fa-magic"></i>
                                            </span>
                                            <span class="text-sm font-bold text-indigo-900">AIÊåáÁ§∫„Éª„Éó„É≠„É≥„Éó„ÉàËß£Êûê</span>
                                            <span
                                                class="ml-2 px-2 py-0.5 bg-indigo-600 text-white text-[10px] rounded-full font-bold uppercase tracking-wider">PREMIUM</span>
                                        </label>
                                        <div class="disabled-message items-center gap-1">
                                            <i class="fas fa-lock text-xs"></i>
                                            <span>ÁµêÊûú„Çí500‰ª∂Êú™Ê∫Ä„Å´Áµû„ÇäËæº„ÇÄ„Å®Âà©Áî®ÂèØËÉΩ„Åß„Åô</span>
                                        </div>
                                    </div>
                                    <div class="ai-search-toggle-icon text-indigo-400">
                                        <i class="fas fa-chevron-up"></i>
                                    </div>
                                </div>

                                <div class="ai-search-body transition-all duration-300">
                                    <div class="relative mt-4">
                                        <textarea id="search-ai-prompt"
                                            placeholder="‰æã: ÊÄ•ÊàêÈï∑‰∏≠„ÅÆ„Çπ„Çø„Éº„Éà„Ç¢„ÉÉ„Éó„Åß„Éû„Éç„Ç∏„É°„É≥„ÉàÁµåÈ®ì„Åå„ÅÇ„Çä„ÄÅJava„Å´Âº∑„ÅÑÊñπ„ÇíÂÑ™ÂÖà„Åó„Å¶..."
                                            class="w-full bg-white border border-indigo-100 rounded-xl p-4 text-sm focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all shadow-inner hover:border-indigo-300 min-h-[80px]"
                                            rows="2"></textarea>
                                        <div class="mt-2 flex items-center gap-4 text-[10px] text-slate-500">
                                            <span class="flex items-center gap-1">
                                                <i class="fas fa-info-circle"></i>
                                                ÈÄöÂ∏∏„ÅÆ„Éï„Ç£„É´„ÇøÊù°‰ª∂„Å´Âä†„Åà„Å¶„ÄÅAI„ÅåÊåáÁ§∫ÂÜÖÂÆπ„Å´Âü∫„Å•„ÅçÈ†Ü‰Ωç‰ªò„Åë„Å®ÂàÜÊûê„ÇíË°å„ÅÑ„Åæ„Åô„ÄÇ
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div> <!-- Closes advanced-filters-body -->

                    <!-- Search Action Footer (Always Visible) -->
                    <div
                        class="sticky-search-footer mt-8 pt-6 border-t border-slate-100 flex flex-col md:flex-row justify-between items-center gap-6">
                        <div class="flex items-center gap-4">
                            <button onclick="selectTop30Jobs()" id="select-top-30-btn"
                                class="px-5 py-2.5 bg-purple-50 text-purple-700 rounded-xl hover:bg-purple-100 border border-purple-100 font-bold text-sm hidden transition-all flex items-center gap-2">
                                <i class="fas fa-check-double text-base"></i> ‰∏ä‰Ωç30‰ª∂„Çí‰∏ÄÊã¨ÈÅ∏Êäû
                            </button>
                        </div>

                        <button onclick="searchJobsImmediate()"
                            class="w-full md:w-auto px-16 py-4 bg-indigo-600 text-white rounded-2xl hover:bg-indigo-700 font-bold transition-all shadow-xl hover:shadow-2xl hover:-translate-y-1 flex items-center justify-center gap-3 text-lg">
                            <i class="fas fa-search"></i> „Åì„ÅÆÊù°‰ª∂„ÅßÊ§úÁ¥¢„Åô„Çã
                        </button>
                    </div>

                    <!-- ‰∏ÄÊã¨Êé®Ëñ¶/AI„Éû„ÉÉ„ÉÅ„É≥„Ç∞Ë®∫Êñ≠„Éê„Éº -->
                    <!-- ‰∏ÄÊã¨Êé®Ëñ¶/AI„Éû„ÉÉ„ÉÅ„É≥„Ç∞Ë®∫Êñ≠„Éê„Éº -->
                    <div id="bulk-recommend-bar"
                        class="fixed bottom-10 left-1/2 md:left-[calc(50%+125px)] transform -translate-x-1/2 z-50 bg-white border border-indigo-100 rounded-full shadow-2xl px-4 sm:px-8 py-3 sm:py-4 hidden flex items-center justify-between gap-3 sm:gap-8 transition-all duration-300 w-[92vw] sm:w-auto max-w-[600px]">
                        <div class="flex items-center">
                            <div
                                class="bg-indigo-100 text-indigo-600 rounded-full w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center mr-2 sm:mr-3 shrink-0">
                                <i class="fas fa-check text-xs sm:text-base"></i>
                            </div>
                            <div class="leading-tight">
                                <span class="bar-title font-bold text-gray-800 block text-[10px] sm:text-sm">ÈÅ∏ÊäûÁä∂Ê≥Å</span>
                                <span class="text-indigo-600 font-bold"><span id="selected-jobs-count"
                                        class="text-base sm:text-xl">0</span> <span
                                        class="text-[10px] sm:text-sm text-gray-500">‰ª∂</span></span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 sm:gap-3">
                            <button onclick="clearAllSelectedJobs()"
                                class="bg-gray-100 text-gray-600 px-3 sm:px-4 py-2 sm:py-3 rounded-full hover:bg-gray-200 font-bold shadow hover:shadow-md transition flex items-center text-xs sm:text-sm">
                                <i class="fas fa-times sm:mr-2"></i><span class="hidden sm:inline">ÂÖ®Ëß£Èô§</span>
                            </button>
                            <button onclick="openBulkRecommendModal()"
                                class="bar-button bg-indigo-600 text-white px-4 sm:px-8 py-2 sm:py-3 rounded-full hover:bg-indigo-700 font-bold shadow-lg hover:shadow-xl transition flex items-center transform hover:-translate-y-0.5 text-xs sm:text-sm">
                                <i class="fas fa-paper-plane mr-1 sm:mr-2"></i>AI„Éû„ÉÉ„ÉÅ<span
                                    class="hidden sm:inline">„ÇíÂÆüË°å</span>
                            </button>
                        </div>
                    </div>
                </div> <!-- Closes search-card -->

                <div id="jobs-container">
                    <!-- Jobs will be rendered here -->
                </div>
            </div> <!-- Closes jobs-content -->

            <!-- Applications Page -->
            <!-- Ê±ÇËÅ∑ËÄÖÊ§úÁ¥¢„Éö„Éº„Ç∏ÔºàÊñ∞Ë¶èËøΩÂä†Ôºâ -->
            <div id="candidate-search-content" class="app-content p-6 hidden">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <div class="flex items-center gap-4">
                        <h2 class="text-2xl font-bold text-gray-900">Ê±ÇËÅ∑ËÄÖÊ§úÁ¥¢</h2>
                    </div>
                </div>

                <div class="search-card mb-8">
                    <!-- Target Job Selection (AI Matching) -->
                    <div id="admin-candidate-search-tools" class="mb-6 pb-6 border-b border-slate-100">
                        <div class="filter-group-label">
                            <i class="fas fa-briefcase text-indigo-500"></i> ÂØæË±°Ê±Ç‰∫∫„ÇíÈÅ∏Êäû <span
                                class="admin-badge ml-2">AI„Éû„ÉÉ„ÉÅ„É≥„Ç∞Áî®</span>
                        </div>
                        <div class="relative">
                            <div id="target-job-input-wrapper">
                                <input type="text" id="target-job-search" placeholder="Ê±Ç‰∫∫„Çø„Ç§„Éà„É´„Åæ„Åü„ÅØ‰ºÅÊ•≠Âêç„ÅßÊ§úÁ¥¢..."
                                    class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all" />
                                <i class="fas fa-search absolute right-3 top-3 text-slate-400"></i>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
                                <select id="t-job-category" class="w-full select2" multiple="multiple"></select>
                                <select id="t-industry" class="w-full select2" multiple="multiple"></select>
                                <select id="t-location" class="w-full select2" multiple="multiple"></select>
                            </div>

                            <!-- Ê§úÁ¥¢ÁµêÊûú„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥ -->
                            <div id="target-job-dropdown"
                                class="hidden absolute w-full bg-white border border-slate-200 rounded-lg shadow-xl mt-1 z-50 max-h-60 overflow-y-auto">
                            </div>

                            <!-- ÈÅ∏ÊäûÊ∏à„ÅøÊ±Ç‰∫∫Ë°®Á§∫ -->
                            <div id="selected-job-display"
                                class="hidden mt-3 p-3 bg-indigo-50 border border-indigo-100 rounded-lg flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold"
                                        id="selected-job-avatar"><i class="fas fa-building"></i></div>
                                    <div>
                                        <div class="font-bold text-slate-900" id="selected-job-title"></div>
                                        <div class="text-xs text-slate-500" id="selected-job-company"></div>
                                    </div>
                                </div>
                                <button id="clear-job-selection"
                                    class="text-slate-400 hover:text-red-500 transition-colors">
                                    <i class="fas fa-times-circle text-xl"></i>
                                </button>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button onclick="runJobToCandidateMatching()" id="job-ai-match-btn"
                                class="bg-indigo-600 text-white px-8 py-2 rounded-lg hover:bg-white hover:text-indigo-600 border border-transparent hover:border-indigo-600 font-bold transition shadow-md flex items-center"
                                disabled>
                                <i class="fas fa-robot mr-2"></i>AI„Éû„ÉÉ„ÉÅ„É≥„Ç∞„ÇíÂÆüË°å
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <!-- Col 1: Keyword & Salary -->
                        <div class="space-y-4">
                            <div>
                                <label class="filter-group-label">„Ç≠„Éº„ÉØ„Éº„Éâ</label>
                                <div class="space-y-3">
                                    <div class="relative group">
                                        <input type="text" id="c-search-keyword" placeholder="„Çπ„Ç≠„É´„ÄÅÁµåÊ≠¥„ÄÅË≥áÊ†º„Å™„Å©..."
                                            class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                                        <i
                                            class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                    </div>

                                    <!-- Mode Switch (Always Visible below input) -->
                                    <div
                                        class="flex p-1 bg-slate-100/50 rounded-lg border border-slate-200 w-fit h-9 items-center">
                                        <label class="relative flex items-center cursor-pointer h-full">
                                            <input type="radio" name="c-search-keyword-mode" value="OR" checked
                                                class="sr-only peer">
                                            <div
                                                class="px-3 py-1 rounded text-[10px] font-bold text-slate-500 peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm transition-all whitespace-nowrap">
                                                ORÊ§úÁ¥¢</div>
                                        </label>
                                        <label class="relative flex items-center cursor-pointer h-full">
                                            <input type="radio" name="c-search-keyword-mode" value="AND"
                                                class="sr-only peer">
                                            <div
                                                class="px-3 py-1 rounded text-[10px] font-bold text-slate-500 peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm transition-all whitespace-nowrap">
                                                ANDÊ§úÁ¥¢</div>
                                        </label>
                                    </div>
                                </div>
                                <div id="c-tags-keyword" class="tag-container mt-2"></div>
                            </div>
                            <div>
                                <label class="filter-group-label">Â∏åÊúõÊúÄ‰ΩéÂπ¥Âèé</label>
                                <div class="premium-slider-container">
                                    <input type="range" id="c-search-salary-slider" min="0" max="2000" step="50"
                                        value="0" class="premium-slider"
                                        oninput="$('#c-salary-display').text(this.value === '0' ? 'ÊåáÂÆö„Å™„Åó' : this.value + ' ‰∏áÂÜÜ‰ª•‰∏ä')">
                                    <div class="flex justify-between mt-2">
                                        <span class="text-[10px] text-slate-400">0</span>
                                        <span id="c-salary-display"
                                            class="text-sm font-bold text-indigo-600">ÊåáÂÆö„Å™„Åó</span>
                                        <span class="text-[10px] text-slate-400">2000‰∏á</span>
                                    </div>
                                    <input type="hidden" id="c-search-salary-min" value="0">
                                </div>
                            </div>
                        </div>

                        <!-- Col 2: Job Category & Employment Type -->
                        <div class="space-y-4">
                            <div>
                                <label class="filter-group-label">Â∏åÊúõËÅ∑Á®Æ</label>
                                <select id="c-search-job-category" class="w-full select2" multiple="multiple"></select>
                                <div id="c-tags-job" class="tag-container mt-1"></div>
                            </div>
                            <div>
                                <label class="filter-group-label">Â∏åÊúõÈõáÁî®ÂΩ¢ÊÖã</label>
                                <select id="c-search-employment-type" class="w-full select2"
                                    multiple="multiple"></select>
                                <div id="c-tags-employment" class="tag-container mt-1"></div>
                            </div>
                        </div>

                        <!-- Col 3: Industry & Status -->
                        <div class="space-y-4">
                            <div>
                                <label class="filter-group-label">Â∏åÊúõÊ•≠Áïå</label>
                                <select id="c-search-industry-category" class="w-full select2"
                                    multiple="multiple"></select>
                                <div id="c-tags-industry" class="tag-container mt-1"></div>
                            </div>
                            <div>
                                <label class="filter-group-label">ÁÆ°ÁêÜ„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                                <select id="c-search-management-status"
                                    class="w-full px-4 py-2 border border-slate-200 rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="all">„Åô„Åπ„Å¶</option>
                                    <option value="active" selected>Ê¥ªÂãï‰∏≠</option>
                                    <option value="inactive">Ê¥ªÂãïÁµÇ‰∫Ü</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Details (Always Visible) -->
                    <div
                        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8 pt-6 border-t border-slate-50">
                        <div>
                            <label class="filter-group-label">Â∏åÊúõÂã§ÂãôÂú∞</label>
                            <select id="c-search-prefecture" class="w-full select2" multiple="multiple"></select>
                            <div id="c-tags-prefecture" class="tag-container mt-1"></div>
                        </div>
                        <div>
                            <label class="filter-group-label">Âã§ÂãôÂú∞„Éï„É™„Éº„ÉØ„Éº„Éâ(ÈßÖÂêç„ÄÅÂú∞Âêç„Å™„Å©)</label>
                            <div class="relative">
                                <input type="text" id="c-search-location" placeholder="Ê®™Êµú„ÄÅÂ§ßÈò™„ÄÅ„É™„É¢„Éº„Éà„Å™„Å©..."
                                    class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                                <i class="fas fa-map-marked-alt absolute right-3 top-3 text-slate-400"></i>
                            </div>
                            <div id="c-tags-location" class="tag-container mt-1"></div>
                        </div>
                    </div>

                    <!-- AI Search Prompt -->
                    <div id="candidate-ai-search-box"
                        class="ai-search-box bg-white disabled collapsed mb-8 p-6 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-2xl border border-indigo-100 shadow-sm relative overflow-hidden group">
                        <!-- AI Loading UI -->
                        <div class="ai-scanner-line"></div>
                        <div class="ai-loading-overlay">
                            <div class="ai-loading-spinner"></div>
                            <div class="ai-loading-text">AI„ÅåÊù°‰ª∂„Å´Âêà„Çè„Åõ„Å¶ÂàÜÊûê‰∏≠...</div>
                        </div>
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i class="fas fa-robot text-6xl text-indigo-600"></i>
                        </div>
                        <div class="relative">
                            <div class="ai-search-header flex justify-between items-center cursor-pointer select-none"
                                onclick="toggleAISearch('candidate')">
                                <div class="flex items-center gap-3">
                                    <label class="flex items-center gap-2 m-0">
                                        <span class="bg-white p-2 rounded-lg shadow-sm text-indigo-600">
                                            <i class="fas fa-magic"></i>
                                        </span>
                                        <span class="text-sm font-bold text-indigo-900">AI Search Assistant
                                            („Éó„É≠„É≥„Éó„ÉàÊåáÁ§∫)</span>
                                        <span
                                            class="ml-2 px-2 py-0.5 bg-indigo-600 text-white text-[10px] rounded-full font-bold uppercase tracking-wider">PREMIUM</span>
                                    </label>
                                    <div class="disabled-message items-center gap-1">
                                        <i class="fas fa-lock text-xs"></i>
                                        <span>ÁµêÊûú„Çí500‰ª∂Êú™Ê∫Ä„Å´Áµû„ÇäËæº„ÇÄ„Å®Âà©Áî®ÂèØËÉΩ„Åß„Åô</span>
                                    </div>
                                </div>
                                <div class="ai-search-toggle-icon text-indigo-400">
                                    <i class="fas fa-chevron-up"></i>
                                </div>
                            </div>

                            <div class="ai-search-body transition-all duration-300">
                                <div class="relative">
                                    <textarea id="c-search-ai-prompt"
                                        placeholder="‰æã: Â§ßÊâãSIerÂá∫Ë∫´„Åß„ÄÅPMÁµåÈ®ì„ÅåË±äÂØå„ÄÅ„Ç≥„Éü„É•„Éã„Ç±„Éº„Ç∑„Éß„É≥ËÉΩÂäõ„ÅåÈ´ò„Åù„ÅÜ„Å™Êñπ„ÇíÂÑ™ÂÖà„Åó„Å¶..."
                                        class="w-full bg-white border border-indigo-100 rounded-xl p-4 text-sm focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all shadow-inner hover:border-indigo-300 min-h-[80px]"
                                        rows="2"></textarea>
                                    <div class="mt-2 flex items-center gap-4 text-[10px] text-slate-500">
                                        <span class="flex items-center gap-1">
                                            <i class="fas fa-info-circle"></i>
                                            ÈÄöÂ∏∏„ÅÆ„Éï„Ç£„É´„ÇøÊù°‰ª∂„Å´Âä†„Åà„Å¶„ÄÅAI„ÅåÊåáÁ§∫ÂÜÖÂÆπ„Å´Âü∫„Å•„ÅçÈ†Ü‰Ωç‰ªò„Åë„Å®ÂàÜÊûê„ÇíË°å„ÅÑ„Åæ„Åô„ÄÇ
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div
                        class="sticky-search-footer mt-8 pt-6 border-t border-slate-100 flex flex-wrap gap-6 justify-between items-center">
                        <div class="flex gap-4 items-center">
                            <button onclick="searchCandidatesImmediate()"
                                class="bg-indigo-600 text-white px-10 py-2.5 rounded-lg hover:bg-white hover:text-indigo-600 border border-transparent hover:border-indigo-600 font-bold transition shadow-md flex items-center">
                                <i class="fas fa-search mr-2"></i>Ê±ÇËÅ∑ËÄÖÊ§úÁ¥¢
                            </button>
                            <button onclick="clearCandidateSearch()"
                                class="px-8 py-2.5 border border-slate-200 text-slate-600 rounded-lg hover:bg-slate-50 font-medium transition">
                                „ÇØ„É™„Ç¢
                            </button>

                            <div id="candidate-count-display-premium" class="hidden count-badge-premium ml-4">
                                <i class="fas fa-user text-indigo-400 text-xl"></i>
                                <div class="flex flex-col leading-none">
                                    <span
                                        class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Candidates
                                        Found</span>
                                    <div class="flex items-baseline gap-1">
                                        <span id="candidate-count-number" class="count-number-premium">0</span>
                                        <span class="text-xs text-slate-500 font-bold">Âêç</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <select id="c-search-sort"
                                class="px-4 py-2 border border-slate-200 rounded-lg text-sm bg-slate-50 hover:bg-white transition cursor-pointer">
                                <option value="created_at-desc">ÁôªÈå≤Êó•ÔºàÊñ∞„Åó„ÅÑÈ†ÜÔºâ</option>
                                <option value="age-asc">Âπ¥ÈΩ¢ÔºàËã•„ÅÑÈ†ÜÔºâ</option>
                                <option value="age-desc">Âπ¥ÈΩ¢ÔºàÈ´ò„ÅÑÈ†ÜÔºâ</option>
                                <option value="salary-desc">Â∏åÊúõÂπ¥Âèé„ÅåÈ´ò„ÅÑÈ†Ü</option>
                                <option value="salary-asc">Â∏åÊúõÂπ¥Âèé„Åå‰Ωé„ÅÑÈ†Ü</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ÁµêÊûú‰∏ÄË¶ß -->
                <div id="candidate-results-container" class="space-y-4">
                    <!-- Candidates will be rendered here -->
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-search text-4xl mb-3"></i>
                        <p>Êù°‰ª∂„ÇíÊåáÂÆö„Åó„Å¶Ê§úÁ¥¢„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                    </div>
                </div>
                <div id="load-more-candidates-container" class="text-center mt-8 hidden">
                    <button onclick="loadMoreCandidates()"
                        class="bg-white border border-gray-300 text-gray-700 px-6 py-3 rounded-xl hover:bg-gray-50 transition">
                        „ÇÇ„Å£„Å®Ë¶ã„Çã
                    </button>
                </div>
            </div>

            <div id="applications-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6 flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-semibold mb-2">ÂøúÂãü„ÉªÈÅ∏ËÄÉÂ±•Ê≠¥</h2>
                        <p class="text-gray-600">ÂøúÂãü„ÉªÈÅ∏ËÄÉ‰∏≠„ÅÆÊ±Ç‰∫∫„ÅÆ‰∏ÄË¶ß„Åß„Åô„ÄÇ</p>
                    </div>
                    <button onclick="exportApplicationsCsv()" id="export-applications-btn"
                        class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 hidden">
                        <i class="fas fa-download mr-2"></i>CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà
                    </button>
                </div>

                <!-- Candidate Search/Filter -->
                <div class="bg-white rounded-xl shadow-sm border p-4 mb-6">
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex-1 relative">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="application-search-input" placeholder="ÂÄôË£úËÄÖÂêç„ÄÅ‰ºÅÊ•≠Âêç„ÄÅËÅ∑Á®Æ„ÅßÊ§úÁ¥¢..."
                                class="w-full pl-9 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                                onkeyup="filterCandidateApplications()">
                        </div>
                        <div class="flex items-center gap-2 overflow-x-auto pb-1 md:pb-0 no-scrollbar">
                            <button onclick="setCandidateApplicationStatusFilter('all')"
                                class="candidate-status-filter active whitespace-nowrap px-4 py-2 rounded-lg text-sm font-bold bg-indigo-600 text-white border border-indigo-600"
                                data-status="all">„Åô„Åπ„Å¶</button>
                            <button onclick="setCandidateApplicationStatusFilter('ongoing')"
                                class="candidate-status-filter whitespace-nowrap px-4 py-2 rounded-lg text-sm font-bold bg-white text-gray-600 border border-gray-200 hover:bg-gray-50"
                                data-status="ongoing">ÈÅ∏ËÄÉ‰∏≠</button>
                            <button onclick="setCandidateApplicationStatusFilter('offered')"
                                class="candidate-status-filter whitespace-nowrap px-4 py-2 rounded-lg text-sm font-bold bg-white text-gray-600 border border-gray-200 hover:bg-gray-50"
                                data-status="offered">ÂÜÖÂÆö</button>
                            <button onclick="setCandidateApplicationStatusFilter('closed')"
                                class="candidate-status-filter whitespace-nowrap px-4 py-2 rounded-lg text-sm font-bold bg-white text-gray-600 border border-gray-200 hover:bg-gray-50"
                                data-status="closed">ÁµÇ‰∫Ü</button>
                        </div>
                    </div>
                </div>
                <div id="applications-container">
                    <!-- Applications will be rendered here -->
                </div>
            </div>

            <!-- Recommendations Page -->
            <div id="recommendations-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-2">„Åä„Åô„Åô„ÇÅÊ±Ç‰∫∫</h2>
                    <p class="text-gray-600">„ÅÇ„Å™„Åü„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´„Å´Âü∫„Å•„ÅÑ„Å¶„ÄÅAI„ÅåÊúÄÈÅ©„Å™Ê±Ç‰∫∫„ÇíÊèêÊ°à„Åó„Åæ„Åô„ÄÇ</p>
                </div>

                <!-- Recommendations Display User Banner -->
                <!-- Omitted as per user request -->

                <!-- Ê§úÁ¥¢„Éª„Éï„Ç£„É´„Çø„Éº„Ç®„É™„Ç¢ -->
                <div class="bg-white rounded-lg shadow p-4 mb-6">
                    <div class="flex flex-col lg:flex-row gap-4">
                        <!-- Ê±Ç‰∫∫Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ -->
                        <div class="flex-grow">
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" id="rec-search-keyword"
                                    onkeyup="if(event.key === 'Enter') renderRecommendations()"
                                    class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md bg-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 sm:text-sm transition-all"
                                    placeholder="‰ºÅÊ•≠Âêç„ÄÅ„Éù„Ç∏„Ç∑„Éß„É≥Âêç„ÄÅ„Ç≠„Éº„ÉØ„Éº„Éâ„ÅßÊ§úÁ¥¢...">
                            </div>
                        </div>
                        <!-- Ê±ÇËÅ∑ËÄÖÂêçÊ§úÁ¥¢ -->
                        <div class="w-full lg:w-64">
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                                    <i class="fas fa-user-circle"></i>
                                </span>
                                <input type="text" id="rec-search-candidate-name"
                                    onkeyup="if(event.key === 'Enter') renderRecommendations()"
                                    class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md bg-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 sm:text-sm transition-all"
                                    placeholder="Ê±ÇËÅ∑ËÄÖÂêç„ÅßÁµû„ÇäËæº„Åø...">
                            </div>
                        </div>
                        <button onclick="renderRecommendations()"
                            class="bg-indigo-600 text-white px-8 py-2 rounded-md hover:bg-indigo-700 transition font-bold shadow-sm flex items-center justify-center gap-2">
                            <i class="fas fa-search"></i>Ê§úÁ¥¢
                        </button>
                    </div>
                </div>

                <!-- „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
                <div class="bg-white rounded-lg shadow mb-6">
                    <div class="border-b border-gray-200">
                        <nav class="flex -mb-px">
                            <button onclick="switchRecommendationTab('matches')" id="rec-tab-matches"
                                class="rec-tab px-6 py-3 text-sm font-medium border-b-2 border-indigo-600 text-indigo-600">
                                <i class="fas fa-check-circle mr-2"></i>ÊèêÊ°à (50%‰ª•‰∏ä)
                            </button>
                            <button onclick="switchRecommendationTab('unmatches')" id="rec-tab-unmatches"
                                class="rec-tab px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                <i class="fas fa-times-circle mr-2"></i>„Ç¢„É≥„Éû„ÉÉ„ÉÅ (49%‰ª•‰∏ã)
                            </button>
                        </nav>
                    </div>
                </div>

                <div id="recommendations-container">
                    <!-- Recommendations will be rendered here -->
                </div>

                <!-- Êé®Ëñ¶„É°„ÉÉ„Çª„Éº„Ç∏‰ΩúÊàê„É¢„Éº„ÉÄ„É´ -->
                <div id="recommendation-message-modal"
                    class="fixed inset-0 bg-black bg-opacity-50 z-[100] hidden flex items-center justify-center p-4">
                    <div
                        class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                        <div class="p-6 border-b flex justify-between items-center bg-indigo-50">
                            <div>
                                <h3 class="text-xl font-bold text-indigo-900"><i class="fas fa-magic mr-2"></i>Êé®Ëñ¶„É°„ÉÉ„Çª„Éº„Ç∏ÁîüÊàê
                                </h3>
                                <p class="text-xs text-indigo-600 mt-1">ÈÅ∏Êäû„Åó„ÅüÊ±Ç‰∫∫„ÅÆÂÜÖÂÆπ„ÇíÂÖÉ„Å´„ÄÅ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíËá™ÂãïÊßãÊàê„Åó„Åæ„Åô</p>
                            </div>
                            <button onclick="closeRecommendationMessageModal()"
                                class="text-gray-400 hover:text-gray-600 transition-colors">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-6 space-y-6">
                            <!-- „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû</label>
                                    <select id="message-template-select" onchange="applyMessageTemplate(this.value)"
                                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <!-- Loaded dynamically -->
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button onclick="generateRecommendationMessage()"
                                        class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 font-bold transition flex items-center justify-center gap-2">
                                        <i class="fas fa-sync-alt"></i> „É°„ÉÉ„Çª„Éº„Ç∏„ÇíÁîüÊàê/Êõ¥Êñ∞
                                    </button>
                                </div>
                            </div>

                            <!-- „É°„ÉÉ„Çª„Éº„Ç∏Êú¨Êñá -->
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">
                                    „É°„ÉÉ„Çª„Éº„Ç∏Êú¨Êñá
                                    <span class="text-xs font-normal text-gray-500 ml-2">(ÂøÖË¶Å„Å´Âøú„Åò„Å¶ÊâãÂãï„ÅßË™øÊï¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ)</span>
                                </label>
                                <textarea id="recommendation-message-body" rows="15"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm font-mono focus:ring-2 focus:ring-indigo-500 bg-gray-50"></textarea>
                            </div>
                        </div>
                        <div class="p-6 border-t bg-gray-50 flex justify-between items-center">
                            <div class="flex gap-2">
                                <button onclick="copyRecommendationMessage()"
                                    class="px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium transition flex items-center gap-2">
                                    <i class="fas fa-copy"></i> „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
                                </button>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="closeRecommendationMessageModal()"
                                    class="px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium transition">
                                    „Ç≠„É£„É≥„Çª„É´
                                </button>
                                <button id="send-recommendation-email-btn" onclick="sendRecommendationEmail()"
                                    class="px-8 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold shadow-lg transition flex items-center gap-2">
                                    <i class="fas fa-paper-plane"></i> ÂÄôË£úËÄÖ„Å∏„É°„Éº„É´ÈÄÅ‰ø°
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profile-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 max-w-2xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold">„Éó„É≠„Éï„Ç£„Éº„É´Á∑®ÈõÜ</h2>
                        <div class="relative">
                            <input type="file" id="resume-upload" accept=".pdf" multiple class="hidden"
                                onchange="handleResumeUpload(this)">
                            <button onclick="$('#resume-upload').click()"
                                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm flex items-center">
                                <i class="fas fa-file-pdf mr-2"></i>PDF„Åã„ÇâËá™ÂãïÂÖ•Âäõ
                            </button>
                        </div>
                    </div>
                    <form id="profile-form" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">„ÅäÂêçÂâç</label>
                            <input type="text" id="profile-name" class="w-full px-4 py-2 border rounded-lg bg-gray-50"
                                readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">„Åµ„Çä„Åå„Å™</label>
                            <input type="text" id="profile-furigana"
                                class="w-full px-4 py-2 border rounded-lg bg-gray-50">
                            <p class="text-xs text-gray-500 mt-1">‚Äª„ÅäÂêçÂâç„ÅØÁÆ°ÁêÜËÄÖ„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                                <input type="email" id="profile-email" class="w-full px-4 py-2 border rounded-lg"
                                    required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÈõªË©±Áï™Âè∑</label>
                                <input type="tel" id="profile-phone" class="w-full px-4 py-2 border rounded-lg"
                                    placeholder="‰æã: 090-0000-0000">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÁîüÂπ¥ÊúàÊó•</label>
                                <input type="date" id="profile-birth-date" class="w-full px-4 py-2 border rounded-lg"
                                    onchange="calculateAge(this.value, '#profile-age')">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Âπ¥ÈΩ¢</label>
                                <input type="number" id="profile-age" class="w-full px-4 py-2 border rounded-lg"
                                    min="0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÊÄßÂà•</label>
                                <select id="profile-gender" class="w-full px-4 py-2 border rounded-lg">
                                    <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                    <option value="Áî∑ÊÄß">Áî∑ÊÄß</option>
                                    <option value="Â•≥ÊÄß">Â•≥ÊÄß</option>
                                    <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Áèæ‰ΩèÊâÄÔºàÈÉΩÈÅìÂ∫úÁúåÔºâ</label>
                            <select id="profile-current-location"
                                class="w-full px-4 py-2 border rounded-lg select2-prefecture">
                                <option value="">ÈÉΩÈÅìÂ∫úÁúå„ÇíÈÅ∏Êäû</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Â∏åÊúõËÅ∑Á®Æ</label>
                                <select id="profile-job-type" class="w-full px-4 py-2 border rounded-lg select2"
                                    multiple style="width: 100%">
                                    <!-- Options will be loaded dynamically -->
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Â∏åÊúõÊ•≠Áïå</label>
                                <select id="profile-industry" class="w-full px-4 py-2 border rounded-lg select2"
                                    multiple style="width: 100%">
                                    <!-- Options will be loaded dynamically -->
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Â∏åÊúõÂã§ÂãôÂú∞</label>
                                <div class="flex gap-2">
                                    <select id="profile-prefecture" class="w-1/3 px-2 py-2 border rounded-lg select2"
                                        multiple="multiple">
                                        style="width: 40%">
                                        <option value="">ÈÉΩÈÅìÂ∫úÁúå</option>
                                    </select>
                                    <input type="text" id="profile-city" placeholder="Â∏ÇÂå∫Áî∫ÊùëÔºà‰æã: Ê∏ãË∞∑Âå∫Ôºâ"
                                        class="w-2/3 px-4 py-2 border rounded-lg" style="width: 60%">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Â∏åÊúõÈõáÁî®ÂΩ¢ÊÖã</label>
                                <select id="profile-employment-type" class="w-full px-4 py-2 border rounded-lg select2"
                                    multiple style="width: 100%">
                                    <!-- Options will be loaded dynamically -->
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Â∏åÊúõÊúÄ‰ΩéÂπ¥ÂèéÔºà‰∏áÂÜÜÔºâ</label>
                                <input type="number" id="profile-salary" placeholder="‰æã: 400" min="0"
                                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Â∏åÊúõÊù°‰ª∂„Éï„É™„Éº„ÉØ„Éº„Éâ / AND„ÉªOR</label>
                                <div class="flex items-center gap-2">
                                    <div class="flex-1">
                                        <input type="text" id="profile-freewords" placeholder="‰æã: „É™„É¢„Éº„Éà, „Éï„É¨„ÉÉ„ÇØ„Çπ"
                                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <div id="profile-freewords-tags" class="tag-container mt-2"></div>
                                    </div>
                                    <div
                                        class="flex shrink-0 items-center justify-around gap-2 bg-gray-50 px-2 py-1.5 border rounded-lg w-[115px]">
                                        <label class="flex items-center gap-1 cursor-pointer">
                                            <input type="radio" name="profile-freewords-condition" value="and" checked
                                                class="w-4 h-4 text-indigo-600">
                                            <span class="text-[10px] font-black text-gray-600">AND</span>
                                        </label>
                                        <label class="flex items-center gap-1 cursor-pointer">
                                            <input type="radio" name="profile-freewords-condition" value="or"
                                                class="w-4 h-4 text-indigo-600">
                                            <span class="text-[10px] font-black text-gray-600">OR</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p class="text-[10px] text-gray-400 mt-1 mb-4">‚Äª„Ç´„É≥„Éû(,)Âå∫Âàá„Çä„ÅßË§áÊï∞ÊåáÂÆö„ÄÇAND„ÅØ„Åô„Åπ„Å¶Âê´„ÇÄ„ÄÅOR„ÅØ„ÅÑ„Åö„Çå„Åã„ÇíÂê´„ÇÄÊ±Ç‰∫∫„ÇíÂÑ™ÂÖàË°®Á§∫„Åó„Åæ„Åô„ÄÇ
                        </p>

                        <div class="flex flex-wrap gap-6 p-4 bg-indigo-50 rounded-lg">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="profile-job-experience-ok"
                                    class="w-4 h-4 text-indigo-600 rounded">
                                <span class="text-sm text-gray-700">ËÅ∑Á®ÆÊú™ÁµåÈ®ìÂèØ</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="profile-industry-experience-ok"
                                    class="w-4 h-4 text-indigo-600 rounded">
                                <span class="text-sm text-gray-700">Ê•≠ÁïåÊú™ÁµåÈ®ìÂèØ</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer ml-auto">
                                <input type="checkbox" id="profile-enable-auto-recommendations"
                                    class="w-4 h-4 text-green-600 rounded">
                                <span class="text-sm text-gray-900 font-bold">AIËá™Âãï„Åä„Åô„Åô„ÇÅÊ±Ç‰∫∫„ÇíÂèó„ÅëÂèñ„Çã</span>
                            </label>
                        </div>

                        <!-- „Åä„Åô„Åô„ÇÅÂØæË±°Â§ñ‰ºÅÊ•≠ (New) -->
                        <div class="mt-2 p-4 bg-red-50 rounded-lg border border-red-100">
                            <label class="block text-sm font-bold text-red-900 mb-2">
                                <i class="fas fa-ban mr-1"></i> „Åä„Åô„Åô„ÇÅÂØæË±°Â§ñ‰ºÅÊ•≠„ÅÆË®≠ÂÆö
                            </label>
                            <p class="text-[11px] text-red-700 mb-3 leading-tight">
                                „Åì„Åì„Å´ÁôªÈå≤„Åï„Çå„Åü‰ºÅÊ•≠„ÅØ„ÄÅAI„Å´„Çà„ÇãËá™Âãï„Éû„ÉÉ„ÉÅ„É≥„Ç∞„ÇÑ„Åä„Åô„Åô„ÇÅÊ±Ç‰∫∫„ÅÆÂØæË±°„Åã„ÇâÈô§Â§ñ„Åï„Çå„Åæ„Åô„ÄÇ<br>
                                ÂâçËÅ∑„ÇÑÂèñÂºïÂÖà„Å™„Å©„ÄÅÊ±Ç‰∫∫Á¥π‰ªã„ÇíÂ∏åÊúõ„Åó„Å™„ÅÑ‰ºÅÊ•≠„ÇíÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                            </p>

                            <div class="relative mb-3">
                                <div class="flex gap-2">
                                    <div class="relative flex-1">
                                        <div
                                            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-search text-gray-400 text-xs"></i>
                                        </div>
                                        <input type="text" id="excluded-company-search-input" placeholder="‰ºÅÊ•≠Âêç„ÅßÊ§úÁ¥¢..."
                                            class="w-full pl-9 pr-4 py-2 border border-red-200 rounded-lg text-sm focus:ring-2 focus:ring-red-500 focus:border-red-500 bg-white"
                                            onkeyup="handleExcludedCompanySearch(this.value)">
                                    </div>
                                </div>
                                <!-- Ê§úÁ¥¢ÁµêÊûú„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥ -->
                                <div id="excluded-company-results"
                                    class="absolute z-10 w-full bg-white border border-gray-200 rounded-lg shadow-xl mt-1 hidden max-h-60 overflow-y-auto">
                                </div>
                            </div>

                            <div id="excluded-companies-tags" class="flex flex-wrap gap-2">
                                <!-- ÁôªÈå≤Ê∏à„Åø‰ºÅÊ•≠„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">„Çπ„Ç≠„É´</label>
                            <input type="text" id="profile-skills" placeholder="‰æã: React, TypeScript, Figma"
                                class="w-full px-4 py-2 border rounded-lg">
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÁèæÂú®„ÅÆÂπ¥ÂèéÔºà‰∏áÂÜÜÔºâ</label>
                                <input type="number" id="profile-current-salary" placeholder="‰æã: 400" min="0"
                                    class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÊúÄÁµÇÂ≠¶Ê≠¥</label>
                                <input type="text" id="profile-academic" placeholder="‰æã: „Äá„ÄáÂ§ßÂ≠¶ ÁµåÊ∏àÂ≠¶ÈÉ® Âçí"
                                    class="w-full px-4 py-2 border rounded-lg">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Ë™ûÂ≠¶Âäõ</label>
                                <input type="text" id="profile-languages" placeholder="‰æã: TOEIC 800ÁÇπ, Êó•Â∏∏‰ºöË©±„É¨„Éô„É´„ÅÆËã±Ë™û"
                                    class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Ë≥áÊ†º</label>
                                <input type="text" id="profile-certifications" placeholder="‰æã: Âü∫Êú¨ÊÉÖÂ†±ÊäÄË°ìËÄÖ, AWS SAA"
                                    class="w-full px-4 py-2 border rounded-lg">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Âã§ÂãôÈñãÂßãÂèØËÉΩÊó•</label>
                            <input type="date" id="profile-start-date" class="w-full px-4 py-2 border rounded-lg">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ËÅ∑Ê≠¥„ÉªËá™Â∑±PRÔºàÊ¶ÇË¶ÅÔºâ</label>
                            <textarea id="profile-history" rows="6" placeholder="„Åì„Çå„Åæ„Åß„ÅÆÁµåÈ®ì„ÇÑÂæóÊÑè„Å™„Åì„Å®„ÇíË©≥„Åó„ÅèÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ"
                                class="w-full px-4 py-2 border rounded-lg"></textarea>
                        </div>

                        <!-- ÊßãÈÄ†Âåñ„Åï„Çå„ÅüËÅ∑Ê≠¥ (New) -->
                        <div class="mb-6 border-t border-gray-200 pt-6">
                            <div class="flex justify-between items-center mb-4">
                                <label class="block text-sm font-bold text-gray-700">Ë©≥Á¥∞ËÅ∑Ê≠¥ (ÊúÄÂ§ß10Á§æ)</label>
                                <button type="button"
                                    onclick="addWorkHistoryItemToContainer('#profile-work-history-list')"
                                    class="text-sm text-indigo-600 hover:text-indigo-800 flex items-center font-medium">
                                    <i class="fas fa-plus-circle mr-1"></i>ËÅ∑Ê≠¥„ÇíËøΩÂä†
                                </button>
                            </div>
                            <div id="profile-work-history-list" class="space-y-4 mb-2">
                                <!-- JS„ÅßÂãïÁöÑ„Å´ËøΩÂä† -->
                            </div>

                            <div class="flex items-center gap-4 mt-2 mb-4">
                                <label class="text-xs text-gray-500">ÁµåÈ®ìÁ§æÊï∞ (Ëá™ÂãïË®àÁÆó):</label>
                                <input type="number" id="profile-job-change-count"
                                    class="w-20 px-2 py-1 border rounded bg-gray-50 text-center text-sm" readonly>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ËÅ∑ÂãôÁµåÊ≠¥
                                (Ë©≥Á¥∞„ÉÜ„Ç≠„Çπ„Éà)</label>
                            <textarea id="profile-work-history-detail" rows="10"
                                class="w-full px-4 py-2 border rounded-lg text-sm font-mono bg-gray-50 focus:bg-white transition"
                                placeholder="ËÅ∑ÂãôÁµåÊ≠¥„ÅÆË©≥Á¥∞„ÉÜ„Ç≠„Çπ„Éà„Çí„Åì„Å°„Çâ„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Â±•Ê≠¥ÊÉÖÂ†±</label>
                            <textarea id="profile-history-info" rows="6"
                                class="w-full px-4 py-2 border rounded-lg text-sm bg-gray-50 focus:bg-white transition"
                                placeholder="Â±•Ê≠¥ÊÉÖÂ†±„ÅÆË£úË∂≥„ÇÑË©≥Á¥∞„Çí„Åì„Å°„Çâ„Å´ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"></textarea>
                        </div>

                        <!-- Á§æÂÜÖÁî®ÊÉÖÂ†± (ÁÆ°ÁêÜËÄÖ„Éª„Ç≥„Éº„ÉÅ„ÅÆ„ÅøË°®Á§∫) -->
                        <div id="internal-profile-info"
                            class="hidden border-t-2 border-dashed border-indigo-200 pt-6 mt-8 space-y-6">
                            <h3 class="text-lg font-bold text-indigo-900 flex items-center">
                                <i class="fas fa-lock mr-2"></i>Á§æÂÜÖÁî®ÊÉÖÂ†±ÔºàÊ±ÇËÅ∑ËÄÖ„Å´„ÅØÈùûË°®Á§∫Ôºâ
                            </h3>

                            <div class="grid grid-cols-1 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Google Drive
                                        URL</label>
                                    <input type="url" id="profile-drive-url" class="w-full px-4 py-2 border rounded-lg"
                                        placeholder="https://drive.google.com/...">
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">NotebookLM
                                            URL</label>
                                        <input type="url" id="profile-notebooklm-url"
                                            class="w-full px-4 py-2 border rounded-lg"
                                            placeholder="https://notebooklm.google.com/...">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">LINE
                                            URL</label>
                                        <input type="url" id="profile-line-url"
                                            class="w-full px-4 py-2 border rounded-lg"
                                            placeholder="https://line.me/...">
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Á§æÂÜÖ„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÊÉÖÂ†±</label>
                                <textarea id="profile-resume-detail" rows="10"
                                    class="w-full px-4 py-2 border rounded-lg text-sm font-mono bg-gray-50 focus:bg-white transition"
                                    placeholder="Á§æÂÜÖ„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÊÉÖÂ†±Ôºà„Çπ„Ç≠„É´„ÄÅÁµåÈ®ì„ÄÅÂ∏åÊúõ„ÅÆË£úË∂≥„Å™„Å©Ôºâ"></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Á§æÂÜÖ„É°„É¢„ÉªÂÖ±Êúâ‰∫ãÈ†Ö</label>
                                <textarea id="profile-notes" rows="6"
                                    class="w-full px-4 py-2 border rounded-lg text-sm bg-gray-50 focus:bg-white transition"
                                    placeholder="Á§æÂÜÖ„É°„É¢„ÄÅÈù¢Ë´áË®òÈå≤„ÄÅÂÖ±Êúâ‰∫ãÈ†Ö„Å™„Å©"></textarea>
                            </div>
                        </div>

                        <div class="flex justify-end pt-4">
                            <button type="submit"
                                class="bg-indigo-600 text-white px-8 py-2 rounded-lg hover:bg-indigo-700 transition font-medium">
                                ‰øùÂ≠ò„Åô„Çã
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- AI„Çπ„Ç´„Ç¶„Éà„Éö„Éº„Ç∏ -->
            <!-- AI„Çπ„Ç´„Ç¶„Éà„Éö„Éº„Ç∏ -->
            <div id="ai-scout-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg w-full p-6 shadow min-h-[600px]">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-900">
                            <i class="fas fa-robot text-indigo-600 mr-2"></i>AI„Çπ„Ç´„Ç¶„Éà
                        </h3>
                    </div>

                    <!-- „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
                    <div class="border-b border-gray-200 mb-4">
                        <nav class="flex space-x-8">
                            <button onclick="switchProfileAnalysisTab('new')" id="profile-tab-new"
                                class="profile-analysis-tab py-3 px-1 border-b-2 border-indigo-600 font-medium text-sm text-indigo-600">
                                Êñ∞Ë¶èËß£Êûê
                            </button>
                            <button onclick="switchProfileAnalysisTab('history')" id="profile-tab-history"
                                class="profile-analysis-tab py-3 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                Ëß£ÊûêÂ±•Ê≠¥
                            </button>
                            <button onclick="switchProfileAnalysisTab('scout_management')"
                                id="profile-tab-scout_management"
                                class="profile-analysis-tab py-3 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                „Çπ„Ç´„Ç¶„ÉàÁÆ°ÁêÜ
                            </button>
                            <button onclick="switchProfileAnalysisTab('analytics')" id="profile-tab-analytics"
                                class="profile-analysis-tab py-3 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                ÂäπÊûúÊ∏¨ÂÆö
                            </button>
                        </nav>
                    </div>

                    <!-- Êñ∞Ë¶èËß£Êûê„Çø„Éñ -->
                    <div id="profile-new-tab-content" class="flex-1 overflow-y-auto flex gap-6">
                        <!-- Â∑¶ÂÅ¥: ÂÖ•Âäõ„Ç®„É™„Ç¢ -->
                        <!-- Â∑¶ÂÅ¥: ÂÖ•Âäõ„Ç®„É™„Ç¢ -->
                        <div class="w-1/3 flex flex-col gap-6">

                            <!-- STEP 1: Basic Information -->
                            <div
                                class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm transition hover:shadow-md">
                                <!-- 1. Candidate Info Header -->
                                <div class="flex items-center justify-between mb-4">
                                    <h5 class="font-bold text-gray-700 flex items-center">
                                        <span
                                            class="bg-indigo-100 text-indigo-600 rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2">1</span>
                                        ÂÄôË£úËÄÖÊÉÖÂ†±„ÅÆÂÖ•Âäõ
                                        <div class="group relative inline-block ml-2 align-middle">
                                            <i
                                                class="fas fa-question-circle text-gray-400 hover:text-indigo-500 cursor-help transition-colors"></i>
                                            <div
                                                class="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none z-50 leading-relaxed text-left font-normal">
                                                <div
                                                    class="absolute top-[-6px] left-1/2 transform -translate-x-1/2 w-3 h-3 bg-gray-800 rotate-45">
                                                </div>
                                                ÂÄôË£úËÄÖ„ÅÆÊ∞èÂêç„ÇÑID„ÇíÂÖ•Âäõ„Åó„Åæ„Åô„ÄÇ„Åì„Çå„ÅØÂ±•Ê≠¥ÁÆ°ÁêÜ„ÅÆ„Åü„ÇÅ„Å´‰ΩøÁî®„Åï„Çå„ÄÅAI„ÅÆËß£ÊûêÁµêÊûú„Å´„ÅØÂΩ±Èüø„Åó„Åæ„Åõ„Çì„ÄÇ
                                            </div>
                                        </div>
                                    </h5>
                                    <button onclick="openScoutSettingsModal()"
                                        class="text-xs text-indigo-600 hover:text-indigo-800 flex items-center transition-colors">
                                        <i class="fas fa-cog mr-1"></i>Ë®≠ÂÆö
                                        <div class="group relative inline-block ml-1 align-middle">
                                            <div
                                                class="absolute right-0 bottom-full mb-2 w-48 p-2 bg-gray-800 text-white text-xs rounded shadow opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-50 text-center font-normal">
                                                Êñá‰Ωì„ÇÑ„Çπ„Çø„Ç§„É´„Çí„Ç´„Çπ„Çø„Éû„Ç§„Ç∫
                                            </div>
                                        </div>
                                    </button>
                                </div>

                                <div class="mb-4">
                                    <label class="block text-xs font-bold text-gray-700 mb-1.5">
                                        ÂÄôË£úËÄÖÂêç / ÁÆ°ÁêÜID <span class="font-normal text-gray-400 ml-1">(‰ªªÊÑè)</span>
                                    </label>
                                    <input type="text" id="candidate-title-input"
                                        class="w-full border border-gray-200 bg-gray-50 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all"
                                        placeholder="‰æã: BizReach 123456">
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-gray-700 mb-1.5 flex items-center">
                                        „ÉÜ„Ç≠„Çπ„ÉàÊÉÖÂ†±ÂÖ•Âäõ <span class="font-normal text-gray-400 ml-1">(Ë£úË∂≥ÊÉÖÂ†±„Å™„Å©)</span>
                                        <div class="group relative inline-block ml-2 align-middle">
                                            <i
                                                class="fas fa-question-circle text-gray-400 hover:text-indigo-500 cursor-help transition-colors"></i>
                                            <div
                                                class="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 w-72 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none z-50 leading-relaxed font-normal">
                                                <div
                                                    class="absolute top-[-6px] left-1/2 transform -translate-x-1/2 w-3 h-3 bg-gray-800 rotate-45">
                                                </div>
                                                ËÅ∑ÂãôÁµåÊ≠¥Êõ∏„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÇíÁõ¥Êé•Ë≤º„Çä‰ªò„Åë„Çã„Åã„ÄÅ„ÄåÂπ¥Âèé„Äá„Äá‰∏áÂÜÜ‰ª•‰∏äÂ∏åÊúõ„Äç„Äå„Éï„É´„É™„É¢„Éº„ÉàÂ∏åÊúõ„Äç„Å™„Å©„ÅÆË£úË∂≥Êù°‰ª∂„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇAI„Åå„Åì„Çå„ÇíËÄÉÊÖÆ„Åó„Å¶„Éû„ÉÉ„ÉÅ„É≥„Ç∞„Åó„Åæ„Åô„ÄÇ
                                            </div>
                                        </div>
                                    </label>
                                    <textarea id="profile-text-input" rows="4"
                                        class="w-full border border-gray-200 bg-gray-50 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all resize-none"
                                        placeholder="ÂÄôË£úËÄÖ„ÅÆÁµåÊ≠¥„ÄÅ„Çπ„Ç≠„É´„ÄÅÂ∏åÊúõÊù°‰ª∂„Å™„Å©„ÇíÂÖ•Âäõ..."></textarea>
                                </div>
                            </div>

                            <!-- STEP 2: File Upload -->
                            <div
                                class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm transition hover:shadow-md relative">
                                <div class="mb-3">
                                    <h5 class="font-bold text-gray-700 flex items-center">
                                        <span
                                            class="bg-indigo-100 text-indigo-600 rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2">2</span>
                                        Ë≥áÊñô„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
                                        <div class="group relative inline-block ml-2 align-middle">
                                            <i
                                                class="fas fa-question-circle text-gray-400 hover:text-indigo-500 cursor-help transition-colors"></i>
                                            <div
                                                class="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none z-50 leading-relaxed font-normal">
                                                <div
                                                    class="absolute top-[-6px] left-1/2 transform -translate-x-1/2 w-3 h-3 bg-gray-800 rotate-45">
                                                </div>
                                                Â±•Ê≠¥Êõ∏„ÉªËÅ∑ÂãôÁµåÊ≠¥Êõ∏„ÅÆPDF„ÇÑÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂåøÂêçÂÖ¨Èñã„Åï„Çå„Å¶„ÅÑ„Çã„Éó„É≠„Éï„Ç£„Éº„É´„ÅÆ„Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„Éà„ÇÇËß£ÊûêÂèØËÉΩ„Åß„Åô„ÄÇ
                                            </div>
                                        </div>
                                    </h5>
                                </div>

                                <div id="file-drop-area"
                                    class="border-2 border-dashed border-indigo-300 bg-indigo-50 rounded-xl p-8 text-center hover:bg-indigo-100 transition-colors cursor-pointer relative">

                                    <div class="mb-3 transform group-hover:scale-110 transition-transform duration-300">
                                        <div
                                            class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center mx-auto text-indigo-500">
                                            <i class="fas fa-cloud-upload-alt text-xl"></i>
                                        </div>
                                    </div>

                                    <p class="text-sm font-bold text-gray-700 mb-1">„ÇØ„É™„ÉÉ„ÇØ„Åæ„Åü„ÅØ„Éâ„É©„ÉÉ„Ç∞</p>
                                    <p class="text-xs text-gray-500">PDF, ÁîªÂÉè (Â±•Ê≠¥Êõ∏/ËÅ∑ÂãôÁµåÊ≠¥Êõ∏)</p>
                                    <input type="file" id="profile-file-input" class="hidden"
                                        accept="image/*,application/pdf" multiple>
                                </div>
                                <div id="file-list" class="mt-3 space-y-1"></div>
                            </div>

                            <!-- Action -->
                            <div class="relative group">
                                <button id="analyze-profile-btn" onclick="analyzeProfile()"
                                    class="w-full bg-gradient-to-r from-indigo-600 to-violet-600 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:shadow-xl hover:from-indigo-700 hover:to-violet-700 transform hover:-translate-y-0.5 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                                    <i class="fas fa-magic mr-2"></i>AIËß£Êûê„ÇíÂÆüË°å
                                </button>
                                <div
                                    class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-max px-3 py-1 bg-gray-800 text-white text-xs rounded shadow opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all pointer-events-none">
                                    Á¥Ñ30„Äú60Áßí„ÅßËß£Êûê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åô
                                </div>
                            </div>

                            <div class="text-center">
                                <button onclick="resetProfileAnalysis()"
                                    class="text-xs text-gray-400 hover:text-gray-600 underline">
                                    ÂÖ•ÂäõÂÜÖÂÆπ„Çí„É™„Çª„ÉÉ„Éà
                                </button>
                            </div>

                            <!-- „Çπ„Ç´„Ç¶„Éà‰øÆÊ≠£ÊåáÁ§∫„Ç®„É™„Ç¢ (Hidden) -->
                            <div id="scout-instruction-container"
                                class="hidden mt-2 bg-yellow-50 p-4 rounded-xl border border-yellow-100">
                                <label class="block text-xs font-bold text-yellow-800 mb-2">
                                    <i class="fas fa-pen-fancy mr-1"></i>‰øÆÊ≠£ÊåáÁ§∫„ÉªÂÜçÁîüÊàê
                                </label>
                                <textarea id="scout-instruction-text" rows="3"
                                    class="w-full border border-yellow-200 bg-white rounded-lg px-3 py-2 text-sm focus:ring-yellow-500 mb-2"
                                    placeholder="‰æã: ÊñáÈù¢„Çí„ÇÇ„Å£„Å®„Ç´„Ç∏„É•„Ç¢„É´„Å´..."></textarea>
                                <button id="regenerate-scout-btn" onclick="regenerateScoutsWithInstruction()"
                                    class="w-full bg-white text-yellow-700 border border-yellow-300 py-2 rounded-lg font-bold text-sm hover:bg-yellow-50 transition">
                                    <i class="fas fa-sync-alt mr-2"></i>ÊåáÁ§∫„ÇíÂèçÊò†„Åó„Å¶ÂÜçÁîüÊàê
                                </button>
                            </div>
                        </div>

                        <!-- Âè≥ÂÅ¥: Ëß£ÊûêÁµêÊûú„Ç®„É™„Ç¢ -->
                        <div
                            class="w-2/3 bg-gray-50/50 rounded-xl p-6 overflow-y-auto border border-gray-200/60 shadow-inner min-h-[500px] flex flex-col relative">
                            <div id="analysis-placeholder" class="text-center m-auto max-w-sm">
                                <div
                                    class="w-20 h-20 bg-white rounded-full shadow-md flex items-center justify-center mx-auto mb-6">
                                    <i class="fas fa-magic text-3xl text-indigo-500 animate-pulse-slow"></i>
                                </div>
                                <h4 class="text-lg font-bold text-gray-800 mb-2">AI„Çπ„Ç´„Ç¶„Éà„ÇíÈñãÂßã</h4>
                                <p class="text-sm text-gray-500 leading-relaxed mb-6">
                                    Â∑¶ÂÅ¥„ÅÆ„Éï„Ç©„Éº„É†„Åã„ÇâÂ±•Ê≠¥Êõ∏„ÉªËÅ∑ÂãôÁµåÊ≠¥Êõ∏„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ<br>
                                    AI„ÅåÁµåÈ®ì„Éª„Çπ„Ç≠„É´„ÇíËß£Êûê„Åó„ÄÅÊúÄÈÅ©„Å™Ê±Ç‰∫∫ÊèêÊ°à„Å®„Çπ„Ç´„Ç¶„ÉàÊñáÈù¢„ÇíËá™ÂãïÁîüÊàê„Åó„Åæ„Åô„ÄÇ
                                </p>
                                <div class="flex justify-center gap-4 text-xs text-gray-400">
                                    <span class="flex items-center"><i class="fas fa-check mr-1"></i>PDFÂØæÂøú</span>
                                    <span class="flex items-center"><i class="fas fa-check mr-1"></i>ÁîªÂÉèÂØæÂøú</span>
                                </div>
                            </div>

                            <div id="analysis-loading" class="hidden text-center py-20">
                                <div
                                    class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4">
                                </div>
                                <p class="text-indigo-600 font-bold">AI„ÅåÁîªÂÉè„ÇíËß£Êûê‰∏≠...</p>
                                <p class="text-sm text-gray-500 mt-2">ÁµåÊ≠¥„ÅÆÊäΩÂá∫„Å®Ê±Ç‰∫∫„Éû„ÉÉ„ÉÅ„É≥„Ç∞„ÇíË°å„Å£„Å¶„ÅÑ„Åæ„Åô</p>
                            </div>

                            <div id="analysis-results" class="hidden space-y-6">
                                <!-- ÂÄôË£úËÄÖ„Çµ„Éû„É™„Éº -->
                                <div class="bg-white p-4 rounded-lg shadow-sm border border-indigo-100">
                                    <h4 class="font-bold text-indigo-900 mb-2"><i
                                            class="fas fa-user-circle mr-2"></i>ÂÄôË£úËÄÖ„Éó„É≠„Éï„Ç£„Éº„É´Ë¶ÅÁ¥Ñ</h4>
                                    <p id="candidate-summary-text" class="text-gray-700 text-sm leading-relaxed">
                                    </p>
                                </div>

                                <h4 class="font-bold text-gray-900 border-b pb-2">ÊèêÊ°àÊ±Ç‰∫∫ & „Çπ„Ç´„Ç¶„ÉàÊñáÈù¢</h4>
                                <div id="suggested-jobs-container" class="space-y-6">
                                    <!-- „Åì„Åì„Å´ÁµêÊûú„ÅåÊåøÂÖ•„Åï„Çå„Çã -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ëß£ÊûêÂ±•Ê≠¥„Çø„Éñ -->
                    <div id="profile-history-tab-content" class="hidden flex-1 overflow-y-auto">
                        <div class="mb-4 flex justify-between items-center">
                            <h4 class="text-lg font-semibold text-gray-900">ÈÅéÂéª„ÅÆËß£ÊûêÂ±•Ê≠¥</h4>
                            <button onclick="loadProfileAnalysisHistory()"
                                class="text-sm text-indigo-600 hover:text-indigo-800">
                                <i class="fas fa-sync-alt mr-1"></i>Êõ¥Êñ∞
                            </button>
                        </div>
                        <div id="history-list" class="space-y-4">
                            <div class="text-center py-12 text-gray-500">
                                <i class="fas fa-history text-4xl mb-3"></i>
                                <p>Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...</p>
                            </div>
                        </div>
                    </div>

                    <!-- „Çπ„Ç´„Ç¶„ÉàÁÆ°ÁêÜ„Çø„Éñ -->
                    <div id="profile-scout_management-tab-content" class="hidden flex-1 overflow-y-auto">
                        <div class="mb-4 flex justify-between items-center">
                            <h4 class="text-lg font-semibold text-gray-900">„Çπ„Ç´„Ç¶„ÉàÈÄÅ‰ø°„ÉªËøî‰ø°Áä∂Ê≥Å</h4>
                            <button onclick="loadScoutManagement()"
                                class="text-sm text-indigo-600 hover:text-indigo-800">
                                <i class="fas fa-sync-alt mr-1"></i>Êõ¥Êñ∞
                            </button>
                        </div>
                        <div id="scout-management-list" class="space-y-4">
                            <div class="text-center py-12 text-gray-500">
                                <i class="fas fa-inbox text-4xl mb-3"></i>
                                <p>„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Tab 4: Analytics -->
                    <div id="profile-analytics-tab-content" class="flex-1 overflow-y-auto hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 mt-4">
                            <!-- User Stats -->
                            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                                <h4 class="font-bold text-lg text-gray-900 mb-4 flex items-center">
                                    <i class="fas fa-user mr-2 text-indigo-600"></i>ÂÄã‰∫∫„ÅÆÊàêÁ∏æ
                                </h4>
                                <div id="analytics-user-stats" class="grid grid-cols-2 gap-4">
                                    <!-- Stats injected here -->
                                    <div class="text-center p-4 bg-gray-50 rounded">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                                </div>
                            </div>

                            <!-- Organization Stats -->
                            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                                <h4 class="font-bold text-lg text-gray-900 mb-4 flex items-center">
                                    <i class="fas fa-building mr-2 text-indigo-600"></i>ÁµÑÁπîÂÖ®‰Ωì„ÅÆÊàêÁ∏æ
                                </h4>
                                <div id="analytics-org-stats" class="grid grid-cols-2 gap-4">
                                    <!-- Stats injected here -->
                                    <div class="text-center p-4 bg-gray-50 rounded">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm mb-4">
                            <h4 class="font-bold text-lg text-gray-900 mb-4">„Çπ„ÉÜ„Éº„Çø„ÇπË©≥Á¥∞Êé®Áßª</h4>
                            <p class="text-sm text-gray-500 mb-4">‚Äª ÈÄÅ‰ø°Ê∏à„Åø„Çπ„Ç´„Ç¶„Éà„ÇíÊØçÊï∞„Å®„Åó„ÅüÂêÑ„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆÂÜÖË®≥„Åß„Åô„ÄÇ</p>
                            <div id="analytics-details-container">
                                <div class="text-center p-4 bg-gray-50 rounded">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÂÄãÂà•Ê±Ç‰∫∫Êé®Ëñ¶„É¢„Éº„ÉÄ„É´ -->
            <div id="recommend-job-modal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
                style="z-index: 10002;">
                <div class="bg-white rounded-lg w-full max-w-2xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-900">
                            <i class="fas fa-star text-yellow-500 mr-2"></i>Ê±Ç‰∫∫„ÇíÁ¥π‰ªã
                        </h3>
                        <button onclick="closeRecommendJobModal()"
                            class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>

                    <div class="space-y-4">
                        <!-- Ê±Ç‰∫∫ÊÉÖÂ†± -->
                        <div class="bg-gray-50 p-4 rounded border">
                            <p class="text-sm text-gray-600 mb-1">Á¥π‰ªã„Åô„ÇãÊ±Ç‰∫∫:</p>
                            <p id="recommend-job-title" class="font-bold text-gray-900"></p>
                        </div>

                        <!-- Á¥π‰ªãÂÖà -->
                        <div class="bg-gray-50 p-4 rounded border">
                            <p class="text-sm text-gray-600 mb-1">Á¥π‰ªãÂÖà:</p>
                            <p id="recommend-target-user" class="font-bold text-gray-900"></p>
                        </div>

                        <!-- „Åä„Åô„Åô„ÇÅÁêÜÁî± -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-medium text-gray-700">„Åä„Åô„Åô„ÇÅÁêÜÁî±</label>
                                <div class="flex items-center gap-2">
                                    <select id="generate-reason-type"
                                        class="text-xs border border-gray-300 rounded px-2 py-1">
                                        <option value="reason">Á¥π‰ªãÁêÜÁî±</option>
                                        <option value="scout">„Çπ„Ç´„Ç¶„ÉàÊñá</option>
                                    </select>
                                    <button onclick="generateRecommendReason()"
                                        class="text-xs text-indigo-600 hover:text-indigo-800 flex items-center">
                                        <i class="fas fa-magic mr-1"></i>AI„ÅßÁîüÊàê
                                    </button>
                                </div>
                            </div>
                            <textarea id="recommend-reason" rows="6"
                                class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500"
                                placeholder="„Åì„ÅÆÊ±Ç‰∫∫„Çí„Åä„Åô„Åô„ÇÅ„Åô„ÇãÁêÜÁî±„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."></textarea>
                        </div>

                        <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥ -->
                        <div class="flex justify-end gap-3 pt-4 border-t">
                            <button onclick="closeRecommendJobModal()"
                                class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded">„Ç≠„É£„É≥„Çª„É´</button>
                            <button onclick="submitRecommendation()"
                                class="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                                <i class="fas fa-check mr-2"></i>Á¥π‰ªã„Åô„Çã
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AIË©≥Á¥∞ÂàÜÊûê„É¢„Éº„ÉÄ„É´ -->
            <div id="ai-detail-modal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
                style="z-index: 10010;">
                <div class="bg-white rounded-lg w-full max-w-2xl p-6 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-900">
                            <i class="fas fa-chart-bar text-indigo-600 mr-2"></i>AIË©≥Á¥∞ÂàÜÊûê
                        </h3>
                        <button onclick="closeAIDetailModal()"
                            class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    <div id="ai-detail-modal-content">
                        <!-- Content will be injected here -->
                    </div>
                    <div class="mt-6 text-right">
                        <button onclick="closeAIDetailModal()"
                            class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                            Èñâ„Åò„Çã
                        </button>
                    </div>
                </div>
            </div>

            <!-- ‰∏ÄÊã¨Êé®Ëñ¶„É¢„Éº„ÉÄ„É´ -->
            <div id="bulk-recommend-modal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
                style="z-index: 10002;">
                <div class="bg-white rounded-lg w-full max-w-3xl p-6 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="bulk-recommend-modal-title" class="text-xl font-bold text-gray-900">
                            <i class="fas fa-star text-yellow-500 mr-2"></i>Ë§áÊï∞Ê±Ç‰∫∫„Çí‰∏ÄÊã¨Á¥π‰ªã
                        </h3>
                        <button onclick="closeBulkRecommendModal()"
                            class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>

                    <div class="space-y-4">
                        <!-- Á¥π‰ªãÂÖà -->
                        <div class="bg-gray-50 p-4 rounded border">
                            <p class="text-sm text-gray-600 mb-1">Á¥π‰ªãÂÖà:</p>
                            <p id="bulk-recommend-target-user" class="font-bold text-gray-900"></p>
                        </div>

                        <!-- ÈÅ∏Êäû„Åó„ÅüÊ±Ç‰∫∫„É™„Çπ„Éà -->
                        <div>
                            <p class="text-sm font-medium text-gray-700 mb-2">ÈÅ∏Êäû„Åó„ÅüÊ±Ç‰∫∫ (<span
                                    id="bulk-job-count">0</span>‰ª∂)</p>
                            <div id="bulk-jobs-list"
                                class="space-y-2 max-h-60 overflow-y-auto border rounded p-3 bg-gray-50">
                                <!-- Ê±Ç‰∫∫„É™„Çπ„Éà„ÅåË°®Á§∫„Åï„Çå„Çã -->
                            </div>
                        </div>

                        <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥ -->
                        <div class="flex justify-end gap-3 pt-4 border-t">
                            <button onclick="closeBulkRecommendModal()"
                                class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded">„Ç≠„É£„É≥„Çª„É´</button>
                            <button onclick="submitBulkRecommendation()"
                                class="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                                <i class="fas fa-check mr-2"></i>AI„Éû„ÉÉ„ÉÅ„É≥„Ç∞„Åô„Çã
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ê±Ç‰∫∫ÂøúÂãü„É¢„Éº„ÉÄ„É´ -->
            <div id="job-application-modal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
                style="z-index: 10005;">
                <div class="bg-white rounded-lg w-full max-w-2xl p-6 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-900">
                            <i class="fas fa-paper-plane text-indigo-600 mr-2"></i>Ê±Ç‰∫∫„Å´ÂøúÂãü
                        </h3>
                        <button onclick="closeApplyJobModal()"
                            class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>

                    <div class="space-y-6">
                        <!-- Ê±Ç‰∫∫ÊÉÖÂ†± -->
                        <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                            <p class="text-xs text-indigo-600 font-bold mb-1 uppercase tracking-wider">ÂøúÂãü„Åô„ÇãÊ±Ç‰∫∫</p>
                            <h4 id="apply-job-title" class="font-bold text-gray-900 text-lg"></h4>
                            <p id="apply-company-name" class="text-sm text-gray-600"></p>
                        </div>

                        <div id="apply-proxy-info"
                            class="hidden bg-amber-50 p-3 rounded border border-amber-200 text-sm">
                            <i class="fas fa-user-shield text-amber-600 mr-2"></i>
                            <span class="font-bold text-amber-800" id="apply-proxy-user-name"></span> „Åï„Çì„ÅÆ‰ª£ÁêÜ„Å®„Åó„Å¶ÂøúÂãü„Åó„Åæ„Åô
                        </div>

                        <!-- ÂøóÊúõÂ∫¶ -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">ÂøóÊúõÂ∫¶ <span
                                    class="text-red-500">*</span></label>
                            <div class="flex gap-4">
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="apply-will-level" value="A" class="hidden peer" checked>
                                    <div
                                        class="text-center p-3 border-2 rounded-lg peer-checked:border-red-500 peer-checked:bg-red-50 hover:bg-gray-50 transition-all font-bold text-gray-600 peer-checked:text-red-700">
                                        <div class="text-lg">A</div>
                                        <div class="text-[10px]">Á¨¨‰∏ÄÂøóÊúõÁæ§</div>
                                    </div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="apply-will-level" value="B" class="hidden peer">
                                    <div
                                        class="text-center p-3 border-2 rounded-lg peer-checked:border-orange-500 peer-checked:bg-orange-50 hover:bg-gray-50 transition-all font-bold text-gray-600 peer-checked:text-orange-700">
                                        <div class="text-lg">B</div>
                                        <div class="text-[10px]">ÂâçÂêë„Åç„Å´Ê§úË®é</div>
                                    </div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="apply-will-level" value="C" class="hidden peer">
                                    <div
                                        class="text-center p-3 border-2 rounded-lg peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:bg-gray-50 transition-all font-bold text-gray-600 peer-checked:text-blue-700">
                                        <div class="text-lg">C</div>
                                        <div class="text-[10px]">„Åæ„Åö„ÅØË©±„ÇíËÅû„Åç„Åü„ÅÑ</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Èù¢Êé•Â∏åÊúõÊó•ÊôÇ -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Èù¢Êé•Â∏åÊúõÊó•ÊôÇ (ÂÄôË£ú3„Å§„Åª„Å©)</label>
                            <div class="space-y-2">
                                <div class="relative">
                                    <span class="absolute left-3 top-2.5 text-gray-400 text-xs">ÂÄôË£ú1</span>
                                    <input type="text" id="apply-interview-date-1" placeholder="‰æã: 10/20(Êúà) 14:00„Äú16:00"
                                        class="w-full pl-14 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                                </div>
                                <div class="relative">
                                    <span class="absolute left-3 top-2.5 text-gray-400 text-xs">ÂÄôË£ú2</span>
                                    <input type="text" id="apply-interview-date-2" placeholder="‰æã: 10/21(ÁÅ´) 10:00„Äú12:00"
                                        class="w-full pl-14 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                                </div>
                                <div class="relative">
                                    <span class="absolute left-3 top-2.5 text-gray-400 text-xs">ÂÄôË£ú3</span>
                                    <input type="text" id="apply-interview-date-3" placeholder="‰æã: Âπ≥Êó•Â§ïÊñπ‰ª•Èôç"
                                        class="w-full pl-14 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                                </div>
                            </div>
                        </div>

                        <!-- ‰ºùÈÅî‰∫ãÈ†Ö -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">‰ºùÈÅî‰∫ãÈ†Ö„Éª„É°„ÉÉ„Çª„Éº„Ç∏</label>
                            <textarea id="apply-notes" rows="4"
                                class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder="ÁèæÂú®„ÅÆÂ∞±Ê•≠Áä∂Ê≥Å„ÇÑ„ÄÅÁâπ„Å´„Ç¢„Éî„Éº„É´„Åó„Åü„ÅÑÁÇπ„ÄÅÊá∏ÂøµÁÇπ„Å™„Å©„ÅÇ„Çå„Å∞ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."></textarea>
                        </div>

                        <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥ -->
                        <div class="flex justify-end gap-3 pt-4 border-t">
                            <button onclick="closeApplyJobModal()"
                                class="px-6 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg font-bold transition-colors">„Ç≠„É£„É≥„Çª„É´</button>
                            <button onclick="submitJobApplication()"
                                class="px-8 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold shadow-lg shadow-indigo-100 transition-all flex items-center gap-2">
                                <i class="fas fa-check"></i>
                                „Åì„ÅÆÂÜÖÂÆπ„ÅßÂøúÂãü„Åô„Çã
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ê±ÇËÅ∑ËÄÖÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ÔºàÂÄãÂà•Á¥π‰ªãÁî®Ôºâ -->
            <div id="candidate-selection-modal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
                style="z-index: 10005;">
                <div class="bg-white rounded-lg w-full max-w-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-900">Á¥π‰ªãÂÖà„É¶„Éº„Ç∂„Éº„ÇíÈÅ∏Êäû</h3>
                        <button onclick="closeCandidateSelectionModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="mb-4">
                        <div class="relative">
                            <input type="text" id="modal-candidate-search" placeholder="„É¶„Éº„Ç∂„ÉºÂêç„ÅßÁµû„ÇäËæº„Åø..."
                                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                        </div>
                    </div>
                    <div id="modal-candidate-list"
                        class="space-y-2 max-h-80 overflow-y-auto border rounded p-2 bg-gray-50">
                        <!-- „Åì„Åì„Å´Ê±ÇËÅ∑ËÄÖ„É™„Çπ„Éà„ÅåË°®Á§∫„Åï„Çå„Çã -->
                    </div>
                    <div class="mt-6 text-right">
                        <button onclick="closeCandidateSelectionModal()"
                            class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded">Èñâ„Åò„Çã</button>
                    </div>
                </div>
            </div>



            <!-- Super Admin: Master Data Page -->
            <div id="admin-master-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-xl font-semibold mb-2">„Éû„Çπ„Çø„Éá„Éº„ÇøÁÆ°ÁêÜ</h2>
                            <p class="text-gray-600">„Ç∑„Çπ„ÉÜ„É†ÂÖ®‰Ωì„ÅÆÈÅ∏ÊäûËÇ¢ÔºàÈõáÁî®ÂΩ¢ÊÖã„ÄÅËÅ∑Á®Æ„Å™„Å©Ôºâ„ÇíÁÆ°ÁêÜ„Åó„Åæ„Åô</p>
                        </div>
                        <button onclick="showMasterForm()"
                            class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">
                            <i class="fas fa-plus mr-2"></i>Êñ∞Ë¶è‰ΩúÊàê
                        </button>
                        <button onclick="updateJobCategoriesMaster()"
                            class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 ml-2">
                            <i class="fas fa-sync mr-2"></i>ËÅ∑Á®Æ„Éû„Çπ„ÇøÂàùÊúüÂåñ
                        </button>
                        <button onclick="updateIndustryCategoriesMaster()"
                            class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 ml-2">
                            <i class="fas fa-sync mr-2"></i>Ê•≠Á®Æ„Éû„Çπ„ÇøÂàùÊúüÂåñ
                        </button>
                        <button onclick="updateSelectionStatusMaster()"
                            class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 ml-2">
                            <i class="fas fa-sync mr-2"></i>ÈÄ≤Êçó„Çπ„ÉÜ„Éº„Çø„ÇπÂàùÊúüÂåñ
                        </button>
                        <button onclick="updatePromptMaster()"
                            class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 ml-2">
                            <i class="fas fa-sync mr-2"></i>„Éó„É≠„É≥„Éó„ÉàÂàùÊúüÂåñ
                        </button>
                    </div>
                    <div id="master-org-filter-container" class="mb-4 hidden">
                        <select id="master-filter-org" onchange="loadMasterData()"
                            class="w-full md:w-1/3 px-3 py-2 border rounded-lg text-sm bg-gray-50">
                            <option value="">ÂÖ®„Å¶„ÅÆÁµÑÁπî„ÇíË°®Á§∫</option>
                        </select>
                    </div>
                    <div class="border-b border-gray-200 mb-4">
                        <nav class="-mb-px flex space-x-8" id="master-tabs">
                            <button onclick="switchMasterTab('')"
                                class="master-tab border-indigo-500 text-indigo-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                ÂÖ®„Å¶„ÅÆÁ®ÆÂà•
                            </button>
                            <button onclick="switchMasterTab('employment_type')"
                                class="master-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                ÈõáÁî®ÂΩ¢ÊÖã
                            </button>
                            <button onclick="switchMasterTab('job_category')"
                                class="master-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                ËÅ∑Á®Æ„Ç´„ÉÜ„Ç¥„É™
                            </button>
                            <button onclick="switchMasterTab('industry_category')"
                                class="master-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                Ê•≠Á®Æ„Ç´„ÉÜ„Ç¥„É™
                            </button>
                            <button onclick="switchMasterTab('selection_status')"
                                class="master-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                ÈÄ≤Êçó„Çπ„ÉÜ„Éº„Çø„Çπ
                            </button>
                        </nav>
                        <input type="hidden" id="master-filter-type" value="">
                    </div>
                </div>
                <div id="master-data-container"></div>
            </div>

            <!-- Admin: Job Management Page -->
            <div id="admin-jobs-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-600 mb-2">Ê±Ç‰∫∫„ÅÆ‰ΩúÊàê„ÉªÁ∑®ÈõÜ„ÉªÂâäÈô§„Åå„Åß„Åç„Åæ„Åô„ÄÇ</p>
                        </div>
                        <div class="flex gap-2 flex-wrap">
                            <button id="admin-job-drive-import-btn" onclick="openDriveImportModal()"
                                class="hidden bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                                <i class="fab fa-google-drive"></i> Google„Éâ„É©„Ç§„ÉñÂèñÂæó
                                <span class="text-[10px] bg-white/20 px-1 rounded">GAS</span>
                            </button>
                            <button id="admin-job-drive-sync-btn" onclick="syncDriveFileUrls()"
                                class="hidden bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition flex items-center gap-2">
                                <i class="fas fa-sync-alt"></i> URLÂêåÊúü
                            </button>
                            <button id="admin-job-csv-import-btn" onclick="showJobCsvImportModal()"
                                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition flex items-center gap-2">
                                <i class="fas fa-file-csv"></i> CSV„Ç§„É≥„Éù„Éº„Éà
                            </button>
                            <button onclick="exportJobsCsv()"
                                class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                                <i class="fas fa-download mr-2"></i>CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà
                            </button>
                            <button onclick="showJobForm()"
                                class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition font-medium">
                                <i class="fas fa-plus mr-2"></i>Êñ∞Ë¶è‰ΩúÊàê
                            </button>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 mb-6">
                    <input type="text" id="admin-job-search" placeholder="Ê±Ç‰∫∫„Çø„Ç§„Éà„É´„ÄÅ‰ºöÁ§æÂêç„ÅßÊ§úÁ¥¢..."
                        class="w-full px-4 py-2 border rounded-lg" onkeyup="filterAdminJobs()">
                </div>
                <div id="admin-jobs-container">
                    <!-- Jobs will be rendered here -->
                </div>
            </div>

            <!-- Admin: Applicant Management Page -->
            <div id="admin-applicants-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <p class="text-gray-600 mb-2">ÂøúÂãüËÄÖ„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÁÆ°ÁêÜ„Åß„Åç„Åæ„Åô„ÄÇ</p>
                </div>

                <!-- Admin: User Selection for Applicants -->
                <div id="admin-applicant-user-tools" class="mb-6 pb-6 border-b border-slate-100 hidden">
                    <div class="filter-group-label font-bold text-gray-700 mb-2">
                        <i class="fas fa-user-circle text-indigo-500 mr-2"></i>ÁâπÂÆö„ÅÆÊ±ÇËÅ∑ËÄÖ„ÅßÁµû„ÇäËæº„ÇÄ
                    </div>
                    <div class="relative">
                        <div class="applicant-user-input-wrapper relative">
                            <input type="text" id="applicant-target-user-search" placeholder="Ê±ÇËÅ∑ËÄÖÂêç„Åæ„Åü„ÅØ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅßÊ§úÁ¥¢..."
                                class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all" />
                            <i class="fas fa-search absolute right-3 top-3 text-slate-400"></i>
                        </div>
                        <div id="applicant-target-user-dropdown"
                            class="hidden absolute w-full bg-white border border-slate-200 rounded-lg shadow-xl mt-1 z-50 max-h-60 overflow-y-auto">
                        </div>
                        <div id="applicant-selected-user-display"
                            class="hidden mt-2 p-3 bg-indigo-50 border border-indigo-100 rounded-lg flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold"
                                    id="applicant-selected-user-avatar">?</div>
                                <div>
                                    <div class="font-bold text-slate-900" id="applicant-selected-user-name"></div>
                                    <div class="text-xs text-slate-500" id="applicant-selected-user-email"></div>
                                </div>
                            </div>
                            <button id="applicant-clear-user-selection"
                                class="text-slate-400 hover:text-red-500 transition-colors">
                                <i class="fas fa-times-circle text-xl"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                    <div class="flex flex-col md:flex-row gap-6">
                        <!-- Keyword Search -->
                        <div class="flex-1">
                            <label class="block text-sm font-bold text-gray-700 mb-2">„Ç≠„Éº„ÉØ„Éº„ÉâÊ§úÁ¥¢</label>
                            <input type="text" id="admin-applicant-search" placeholder="Ê±ÇËÅ∑ËÄÖÂêç„ÄÅ‰ºÅÊ•≠Âêç„ÄÅÊ±Ç‰∫∫Âêç..."
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all"
                                onkeyup="filterAdminApplicants()">
                        </div>

                        <!-- Status Filter -->
                        <div class="md:w-auto">
                            <label class="block text-sm font-bold text-gray-700 mb-2">„Çπ„ÉÜ„Éº„Çø„Çπ„ÅßÁµû„ÇäËæº„ÇÄ</label>
                            <div class="flex flex-wrap gap-2" id="admin-applicant-status-filters">
                                <button onclick="setAdminApplicantStatusFilter('ongoing')"
                                    class="status-filter-btn active px-4 py-2 rounded-lg text-sm font-bold border transition-all bg-indigo-600 text-white border-indigo-600"
                                    data-status="ongoing">ÈÅ∏ËÄÉ‰∏≠</button>
                                <button onclick="setAdminApplicantStatusFilter('offered')"
                                    class="status-filter-btn px-4 py-2 rounded-lg text-sm font-bold border transition-all bg-white text-gray-600 border-gray-300 hover:bg-gray-50"
                                    data-status="offered">ÂÜÖÂÆö</button>
                                <button onclick="setAdminApplicantStatusFilter('contracted')"
                                    class="status-filter-btn px-4 py-2 rounded-lg text-sm font-bold border transition-all bg-white text-gray-600 border-gray-300 hover:bg-gray-50"
                                    data-status="contracted">ÂÖ•Á§æÊ±∫ÂÆö</button>
                                <button onclick="setAdminApplicantStatusFilter('closed')"
                                    class="status-filter-btn px-4 py-2 rounded-lg text-sm font-bold border transition-all bg-white text-gray-600 border-gray-300 hover:bg-gray-50"
                                    data-status="closed">ÁµÇ‰∫Ü</button>
                                <button onclick="setAdminApplicantStatusFilter('all')"
                                    class="status-filter-btn px-4 py-2 rounded-lg text-sm font-bold border transition-all bg-white text-gray-600 border-gray-300 hover:bg-gray-50"
                                    data-status="all">„Åô„Åπ„Å¶</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bulk Actions Row -->
                <div
                    class="bg-indigo-50/50 border border-indigo-100 rounded-lg p-4 mb-6 flex flex-wrap justify-between items-center gap-4">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="admin-applicant-select-all"
                            class="w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer"
                            onchange="toggleAllAdminApplicants(this.checked)">
                        <span class="text-sm font-bold text-indigo-900"
                            id="admin-applicant-selection-count">0‰ª∂ÈÅ∏Êäû‰∏≠</span>
                    </div>
                    <button id="admin-bulk-status-btn" onclick="openBulkStatusUpdateModal()" disabled
                        class="bg-white text-indigo-300 border border-indigo-100 px-4 py-2 rounded-lg text-sm font-bold shadow-sm cursor-not-allowed transition-all flex items-center gap-2">
                        <i class="fas fa-edit"></i> „Çπ„ÉÜ„Éº„Çø„Çπ„Çí‰∏ÄÊã¨Â§âÊõ¥
                    </button>
                </div>
                <div id="admin-applicants-container">
                    <!-- Applicants will be rendered here -->
                </div>
            </div>


            <!-- Admin: Candidate Management Page -->
            <div id="admin-candidates-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6 flex justify-between items-center">
                    <div>
                        <p class="text-gray-600 mb-2">ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„ÇãÊ±ÇËÅ∑ËÄÖ„ÅÆÊÉÖÂ†±„ÇíÁÆ°ÁêÜ„Åß„Åç„Åæ„Åô„ÄÇ</p>
                    </div>
                    <button onclick="showUserRegistrationModal('candidate')"
                        class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                        <i class="fas fa-plus mr-2"></i>Êñ∞Ë¶èÁôªÈå≤
                    </button>
                </div>
                <div class="bg-white rounded-lg shadow p-4 mb-6">
                    <input type="text" id="admin-candidate-search" placeholder="ÂêçÂâç„ÄÅ„É°„Éº„É´„ÄÅÂ∏åÊúõËÅ∑Á®Æ„ÅßÊ§úÁ¥¢..."
                        class="w-full px-4 py-2 border rounded-lg" onkeyup="filterAdminCandidates()">
                </div>
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ÂêçÂâç / „É°„Éº„É´</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Â∏åÊúõÊù°‰ª∂</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    „Çπ„ÉÜ„Éº„Çø„Çπ</th>
                                <th
                                    class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="admin-candidates-container" class="bg-white divide-y divide-gray-200">
                            <!-- Candidates will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Admin: User Management Page -->
            <div id="admin-users-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6 flex justify-between items-center">
                    <div>
                        <p class="text-gray-600 mb-2">„Ç∑„Çπ„ÉÜ„É†Âà©Áî®ËÄÖ„ÅÆ„Ç¢„Ç´„Ç¶„É≥„Éà„Å®Ê®©Èôê„ÇíÁÆ°ÁêÜ„Åß„Åç„Åæ„Åô„ÄÇ</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="showUserCsvImportModal()"
                            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                            <i class="fas fa-file-csv mr-2"></i>CSV„Ç§„É≥„Éù„Éº„Éà
                        </button>
                        <button onclick="exportUsersCsv()"
                            class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                            <i class="fas fa-download mr-2"></i>CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà
                        </button>
                        <button onclick="showUserRegistrationModal('admin')"
                            class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                            <i class="fas fa-plus mr-2"></i>Êñ∞Ë¶èÁôªÈå≤
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 mb-6">
                    <input type="text" id="admin-user-search" placeholder="ÂêçÂâç„ÄÅ„É°„Éº„É´„ÅßÊ§úÁ¥¢..."
                        class="w-full px-4 py-2 border rounded-lg" onkeyup="filterAdminUsers()">
                </div>
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ÂêçÂâç / „É°„Éº„É´</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    „É≠„Éº„É´</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ÁôªÈå≤Êó•</th>
                                <th
                                    class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="admin-users-container" class="bg-white divide-y divide-gray-200">
                            <!-- Users will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Admin: CSV Import Page -->
            <div id="admin-csv-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <!-- Title removed -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Ê±Ç‰∫∫„Ç§„É≥„Éù„Éº„Éà -->
                        <div class="border rounded-lg p-6">
                            <h3 class="font-semibold mb-3 flex items-center">
                                <i class="fas fa-briefcase mr-2 text-indigo-600"></i>Ê±Ç‰∫∫„Éá„Éº„Çø
                            </h3>
                            <div class="mb-3">
                                <label class="text-xs text-gray-500 block mb-1">ÊñáÂ≠ó„Ç≥„Éº„Éâ</label>
                                <select id="csv-jobs-encoding" class="w-full text-sm border rounded p-1 mb-2">
                                    <option value="UTF-8">UTF-8 (Ê®ôÊ∫ñ)</option>
                                    <option value="Shift_JIS">Shift-JIS (ExcelÁî®)</option>
                                </select>
                                <input type="file" id="csv-jobs-file" accept=".csv" class="mb-3 w-full">
                            </div>
                            <button onclick="importJobsCSV()"
                                class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 w-full">
                                <i class="fas fa-upload mr-2"></i>„Ç§„É≥„Éù„Éº„Éà
                            </button>
                            <p class="text-xs text-gray-500 mt-2">
                                ÂΩ¢Âºè: title, company, location, employment_type, salary_min, salary_max,
                                description
                            </p>
                        </div>

                        <!-- Ê±ÇËÅ∑ËÄÖ„Ç§„É≥„Éù„Éº„Éà -->
                        <div class="border rounded-lg p-6 bg-white shadow-sm">
                            <h3 class="font-bold text-lg mb-4 flex items-center text-gray-800">
                                <i class="fas fa-user-tie mr-2 text-green-600"></i>Ê±ÇËÅ∑ËÄÖCSV„Ç§„É≥„Éù„Éº„Éà
                            </h3>

                            <div class="bg-blue-50 p-4 rounded-xl text-sm text-blue-800 mb-5 border border-blue-100">
                                <p class="font-bold mb-2 flex items-center">
                                    <i class="fas fa-info-circle mr-2"></i>CSV„Éï„Ç©„Éº„Éû„ÉÉ„Éà„Å´„Å§„ÅÑ„Å¶
                                </p>
                                <p class="text-xs leading-relaxed">‰ª•‰∏ã„ÅÆ„Ç´„É©„É†„ÇíÊåÅ„Å§CSV„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö</p>
                                <ul class="list-disc list-inside ml-2 mt-2 space-y-1 text-xs">
                                    <li><span class="font-bold text-red-600">name (ÂøÖÈ†à)</span>: Ê∞èÂêç</li>
                                    <li><span class="font-bold text-red-600">email (ÂøÖÈ†à*)</span>: „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</li>
                                    <li><span class="font-bold">user_code (‰ªªÊÑè)</span>: Ê±ÇËÅ∑ËÄÖID (ÂêçÂØÑ„Åõ„Å´Âà©Áî®)</li>
                                    <li><span class="font-bold">age (‰ªªÊÑè)</span>: Âπ¥ÈΩ¢</li>
                                    <li><span class="font-bold">desired_job_type (‰ªªÊÑè)</span>: Â∏åÊúõËÅ∑Á®Æ</li>
                                    <li><span class="font-bold">desired_location (‰ªªÊÑè)</span>: Â∏åÊúõÂã§ÂãôÂú∞</li>
                                </ul>
                                <p class="mt-2 text-[10px] text-blue-600">‚Äª„É≠„Éº„É´„ÅØËá™ÂãïÁöÑ„Å´„ÄåÊ±ÇËÅ∑ËÄÖ„Äç„Å´Ë®≠ÂÆö„Åï„Çå„Åæ„Åô</p>
                                <div class="mt-4 pt-3 border-t border-blue-200">
                                    <a href="#" onclick="downloadCandidateCsvTemplate(event)"
                                        class="text-blue-700 hover:text-blue-900 flex items-center font-bold transition-colors">
                                        <i class="fas fa-file-download mr-2 text-lg"></i>
                                        <span>„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</span>
                                    </a>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <div>
                                    <label
                                        class="text-xs font-bold text-gray-500 uppercase tracking-wider block mb-1.5">ÊñáÂ≠ó„Ç≥„Éº„Éâ</label>
                                    <select id="csv-users-encoding"
                                        class="w-full text-sm border border-gray-300 rounded-lg p-2 bg-gray-50 focus:ring-2 focus:ring-green-500 outline-none transition-all">
                                        <option value="UTF-8">UTF-8 (Ê®ôÊ∫ñ)</option>
                                        <option value="Shift_JIS">Shift-JIS (ExcelÁî®)</option>
                                    </select>
                                </div>
                                <div>
                                    <label
                                        class="text-xs font-bold text-gray-500 uppercase tracking-wider block mb-1.5">„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</label>
                                    <input type="file" id="csv-users-file" accept=".csv" class="block w-full text-sm text-gray-500
                                                  file:mr-4 file:py-2 file:px-4
                                                  file:rounded-full file:border-0
                                                  file:text-sm file:font-semibold
                                                  file:bg-green-50 file:text-green-700
                                                  hover:file:bg-green-100 transition-all cursor-pointer">
                                </div>
                                <button onclick="importUsersCSV()"
                                    class="w-full bg-green-600 text-white px-6 py-3 rounded-xl hover:bg-green-700 transition-all shadow-md hover:shadow-lg flex items-center justify-center font-bold group">
                                    <i
                                        class="fas fa-file-import mr-3 group-hover:translate-x-1 transition-transform text-lg"></i>
                                    „Ç§„É≥„Éù„Éº„Éà„ÇíÂÆüË°å
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- „Ç§„É≥„Éù„Éº„ÉàÂ±•Ê≠¥ -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="font-semibold mb-4">„Ç§„É≥„Éù„Éº„ÉàÂ±•Ê≠¥</h3>
                    <div id="csv-history-container"></div>
                </div>
            </div>

            <!-- Admin: Audit Logs Page -->
            <div id="admin-logs-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <!-- Title removed -->
                    <div class="flex gap-4 mb-4">
                        <select id="log-filter-action" class="px-4 py-2 border rounded-lg">
                            <option value="">ÂÖ®„Å¶„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥</option>
                            <option value="create">‰ΩúÊàê</option>
                            <option value="update">Êõ¥Êñ∞</option>
                            <option value="delete">ÂâäÈô§</option>
                            <option value="login">„É≠„Ç∞„Ç§„É≥</option>
                            <option value="csv_upload">CSV„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</option>
                        </select>
                        <button onclick="loadAuditLogs()"
                            class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">
                            <i class="fas fa-search mr-2"></i>Ê§úÁ¥¢
                        </button>
                    </div>
                </div>
                <div id="audit-logs-container"></div>
            </div>

            <!-- Admin: Data Management Page -->
            <div id="admin-data-management-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4">ÈáçË§á„Éá„Éº„ÇøÁÆ°ÁêÜ</h2>
                    <p class="text-gray-600 mb-6">
                        ÈáçË§á„Åó„Å¶„ÅÑ„ÇãÂèØËÉΩÊÄß„ÅÆ„ÅÇ„Çã‰ºÅÊ•≠„ÇÑÊ±Ç‰∫∫„ÇíÊ§úÂá∫„Åó„ÄÅÊÉÖÂ†±„ÇíÁµ±ÂêàÔºà„Éû„Éº„Ç∏Ôºâ„Åó„Åæ„Åô„ÄÇ
                    </p>

                    <div class="border-b border-gray-200 mb-6">
                        <nav class="-mb-px flex space-x-8">
                            <button onclick="switchDataManagementTab('companies')" id="data-mgmt-tab-companies"
                                class="data-mgmt-tab border-indigo-500 text-indigo-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                <i class="fas fa-building mr-2"></i>‰ºÅÊ•≠„ÅÆÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
                            </button>
                            <button onclick="switchDataManagementTab('jobs')" id="data-mgmt-tab-jobs"
                                class="data-mgmt-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                <i class="fas fa-briefcase mr-2"></i>Ê±Ç‰∫∫„ÅÆÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
                            </button>
                        </nav>
                    </div>

                    <!-- Settings Section -->
                    <div id="data-mgmt-settings-container" class="bg-gray-50 p-6 rounded-lg mb-8">
                        <h3 class="font-bold text-gray-800 mb-4 flex justify-between items-center">
                            <span>„ÉÅ„Çß„ÉÉ„ÇØÈ†ÖÁõÆ„ÅÆË®≠ÂÆö</span>
                            <button onclick="saveDataCleanupSettings()"
                                class="bg-white border border-indigo-600 text-indigo-600 px-4 py-1.5 rounded-lg text-sm font-medium hover:bg-indigo-50 transition">
                                <i class="fas fa-save mr-2"></i>Ë®≠ÂÆö„Çí‰øùÂ≠ò
                            </button>
                        </h3>

                        <div id="data-mgmt-criteria-companies" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <label
                                class="flex items-center space-x-2 cursor-pointer p-3 bg-white rounded border border-gray-200 hover:border-indigo-300">
                                <input type="checkbox" id="criteria-company-name" checked>
                                <span class="text-sm">‰ºöÁ§æÂêç„ÅÆ‰∏ÄËá¥</span>
                            </label>
                            <label
                                class="flex items-center space-x-2 cursor-pointer p-3 bg-white rounded border border-gray-200 hover:border-indigo-300">
                                <input type="checkbox" id="criteria-company-phone">
                                <span class="text-sm">ÈõªË©±Áï™Âè∑„ÅÆ‰∏ÄËá¥</span>
                            </label>
                            <label
                                class="flex items-center space-x-2 cursor-pointer p-3 bg-white rounded border border-gray-200 hover:border-indigo-300">
                                <input type="checkbox" id="criteria-company-domain">
                                <span class="text-sm">„Éâ„É°„Ç§„É≥/URL„ÅÆ‰∏ÄËá¥</span>
                            </label>
                            <label
                                class="flex items-center space-x-2 cursor-pointer p-3 bg-white rounded border border-gray-200 hover:border-indigo-300">
                                <input type="checkbox" id="criteria-company-address">
                                <span class="text-sm">‰ΩèÊâÄÔºàÂ∏ÇÂå∫Áî∫Êùë„Åæ„ÅßÔºâ„ÅÆ‰∏ÄËá¥</span>
                            </label>
                        </div>

                        <div id="data-mgmt-criteria-jobs" class="hidden grid grid-cols-1 md:grid-cols-3 gap-4">
                            <label
                                class="flex items-center space-x-2 cursor-pointer p-3 bg-white rounded border border-gray-200 hover:border-indigo-300">
                                <input type="checkbox" id="criteria-job-title" checked>
                                <span class="text-sm">Ê±Ç‰∫∫„Çø„Ç§„Éà„É´„ÅÆ‰∏ÄËá¥</span>
                            </label>
                            <label
                                class="flex items-center space-x-2 cursor-pointer p-3 bg-white rounded border border-gray-200 hover:border-indigo-300">
                                <input type="checkbox" id="criteria-job-company" checked>
                                <span class="text-sm">Âêå‰∏Ä‰ºÅÊ•≠„ÅÆÊ±Ç‰∫∫</span>
                            </label>
                            <label
                                class="flex items-center space-x-2 cursor-pointer p-3 bg-white rounded border border-gray-200 hover:border-indigo-300">
                                <input type="checkbox" id="criteria-job-location">
                                <span class="text-sm">Âã§ÂãôÂú∞„ÅÆ‰∏ÄËá¥</span>
                            </label>
                            <label
                                class="flex items-center space-x-2 cursor-pointer p-3 bg-white rounded border border-gray-200 hover:border-indigo-300">
                                <input type="checkbox" id="criteria-job-salary">
                                <span class="text-sm">Âπ¥Âèé„ÅÆ‰∏ÄËá¥</span>
                            </label>
                            <label
                                class="flex items-center space-x-2 cursor-pointer p-3 bg-white rounded border border-gray-200 hover:border-indigo-300">
                                <input type="checkbox" id="criteria-job-category">
                                <span class="text-sm">ËÅ∑Á®Æ„Ç´„ÉÜ„Ç¥„É™„ÅÆ‰∏ÄËá¥</span>
                            </label>
                            <label
                                class="flex items-center space-x-2 cursor-pointer p-3 bg-white rounded border border-gray-200 hover:border-indigo-300">
                                <input type="checkbox" id="criteria-job-employment">
                                <span class="text-sm">Âã§ÂãôÂΩ¢ÊÖã„ÅÆ‰∏ÄËá¥</span>
                            </label>
                        </div>

                        <div class="mt-6 pt-4 border-t border-gray-200 text-right">
                            <button onclick="detectDuplicates()"
                                class="bg-indigo-600 text-white px-8 py-2.5 rounded-lg font-bold hover:bg-indigo-700 transition shadow-md">
                                <i class="fas fa-search mr-2"></i>ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÈñãÂßã
                            </button>
                        </div>
                    </div>

                    <!-- Results Section -->
                    <div id="data-mgmt-results">
                        <div class="text-center py-12 text-gray-500 border-2 border-dashed border-gray-200 rounded-lg">
                            <i class="fas fa-broom text-4xl mb-4"></i>
                            <p>Ë®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„ÄÅ„ÄåÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÈñãÂßã„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin: Yomi Management (Progress & Forecasting) Page -->
            <div id="admin-yomi-management-content" class="app-content p-6 hidden">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">„É®„ÉüÁÆ°ÁêÜ„ÉªÈÄ≤Êçó„É¢„Éã„Çø„É™„É≥„Ç∞</h2>
                        <p class="text-gray-500 text-sm">„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™Ê±ÇËÅ∑ËÄÖ„ÅÆÈÄ≤Êçó„Å®Â£≤‰∏ä‰∫àÊ∏¨„Çí‰∏ÄÊã¨ÁÆ°ÁêÜ„Åó„Åæ„Åô„ÄÇ</p>
                    </div>
                    <div class="flex items-center bg-gray-100 p-1 rounded-lg">
                        <button onclick="switchYomiView('board')" id="yomi-view-board-btn"
                            class="yomi-view-btn px-4 py-2 text-sm font-bold rounded-md transition-all bg-white shadow-sm text-indigo-600">
                            <i class="fas fa-columns mr-2"></i>„Ç´„É≥„Éê„É≥
                        </button>
                        <button onclick="switchYomiView('list')" id="yomi-view-list-btn"
                            class="yomi-view-btn px-4 py-2 text-sm font-bold rounded-md transition-all text-gray-600 hover:text-gray-900">
                            <i class="fas fa-list mr-2"></i>„É™„Çπ„Éà
                        </button>
                        <button onclick="switchYomiView('forecast')" id="yomi-view-forecast-btn"
                            class="yomi-view-btn px-4 py-2 text-sm font-bold rounded-md transition-all text-gray-600 hover:text-gray-900">
                            <i class="fas fa-chart-line mr-2"></i>ÂÖ•Èáë‰∫àÊ∏¨
                        </button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm mb-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                        <div class="lg:col-span-1">
                            <label
                                class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">ÁµÑÁπî„Éª„ÉÅ„Éº„É†</label>
                            <select id="yomi-filter-team"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="">ÂÖ®„Å¶„ÅÆ„ÉÅ„Éº„É†</option>
                            </select>
                        </div>
                        <div class="lg:col-span-1">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">ÊãÖÂΩìËÄÖ
                                (CA/RA)</label>
                            <select id="yomi-filter-coach"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="">ÂÖ®Âì°</option>
                            </select>
                        </div>
                        <div class="lg:col-span-1">
                            <label
                                class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">ÊúüÈñì</label>
                            <select id="yomi-filter-period"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="this_month">‰ªäÊúà</option>
                                <option value="next_month">Êù•Êúà</option>
                                <option value="this_quarter" selected>‰ªäÂõõÂçäÊúü</option>
                                <option value="all">ÂÖ®ÊúüÈñì</option>
                            </select>
                        </div>
                        <div class="lg:col-span-1">
                            <label
                                class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">„É®„ÉüÂÆöÁæ©</label>
                            <select id="yomi-filter-probability"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="">ÂÖ®„Å¶„ÅÆ„É®„Éü</option>
                                <option value="80">A„É®„Éü (80%‚Üë)</option>
                                <option value="60">B„É®„Éü (60%‚Üë)</option>
                                <option value="40">C„É®„Éü (40%‚Üë)</option>
                            </select>
                        </div>
                        <div class="lg:col-span-1 flex gap-2">
                            <button onclick="loadYomiData()"
                                class="flex-1 bg-indigo-600 text-white rounded-lg px-4 py-2 font-bold hover:bg-indigo-700 transition shadow-sm">
                                <i class="fas fa-search mr-2"></i>ÈÅ©Áî®
                            </button>
                            <button onclick="exportYomiData()"
                                class="bg-gray-100 text-gray-600 rounded-lg px-3 py-2 hover:bg-gray-200 transition"
                                title="„Ç®„ÇØ„Çπ„Éù„Éº„Éà">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Stats Summary Row -->
                <div id="yomi-stats-summary" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                        <p class="text-[10px] font-bold text-gray-400 uppercase">Â£≤‰∏äË¶ãËæº„ÅøÂêàË®à</p>
                        <p class="text-xl font-bold text-gray-800" id="yomi-stat-total-revenue">¬•0</p>
                    </div>
                    <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 shadow-sm">
                        <p class="text-[10px] font-bold text-indigo-400 uppercase">„É®„ÉüÊèõÁÆóÂêàË®à (Âà©Áõä‰∫àÊ∏¨)</p>
                        <p class="text-xl font-bold text-indigo-600" id="yomi-stat-weighted-revenue">¬•0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                        <p class="text-[10px] font-bold text-gray-400 uppercase">„Ç¢„ÇØ„ÉÜ„Ç£„Éñ‰ª∂Êï∞</p>
                        <p class="text-xl font-bold text-gray-800" id="yomi-stat-active-count">0‰ª∂</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                        <p class="text-[10px] font-bold text-gray-400 uppercase">ÊàêÁ¥ÑÁ¢∫Â∫¶ (AVG)</p>
                        <p class="text-xl font-bold text-gray-800" id="yomi-stat-avg-probability">0%</p>
                    </div>
                </div>

                <!-- Board View (Kanban) -->
                <div id="yomi-board-view" class="yomi-view-content hidden">
                    <div id="yomi-kanban-container"
                        class="flex gap-4 overflow-x-auto pb-4 custom-scrollbar min-h-[600px]">
                        <!-- Columns will be rendered here -->
                    </div>
                </div>

                <!-- List View (Table) -->
                <div id="yomi-list-view" class="yomi-view-content hidden">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                        ÂÄôË£úËÄÖ / ÊãÖÂΩìËÄÖ</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                        Ê±Ç‰∫∫ / ‰ºÅÊ•≠</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                        „Éï„Çß„Éº„Ç∫</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                        Ë¶ãËæº„ÅøÈáëÈ°ç</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                        Ê±∫ÂÆö„É®„Éü</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                        ÂÖ•Á§æ‰∫àÂÆöÊó•</th>
                                    <th
                                        class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">
                                        Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody id="yomi-list-container" class="bg-white divide-y divide-gray-200">
                                <!-- List items populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Forecast View (Report) -->
                <div id="yomi-forecast-view" class="yomi-view-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm h-full">
                                <h3 class="font-bold text-gray-800 mb-6 flex items-center">
                                    <i class="fas fa-chart-area mr-2 text-indigo-500"></i>ÊúàÂà•ÂÖ•Èáë‰∫àÊ∏¨Êé®Áßª
                                </h3>
                                <div class="h-64">
                                    <canvas id="yomi-forecast-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="lg:col-span-1">
                            <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm h-full">
                                <h3 class="font-bold text-gray-800 mb-6 flex items-center">
                                    <i class="fas fa-percentage mr-2 text-purple-500"></i>„É®„ÉüÂà•ÂÜÖË®≥
                                </h3>
                                <div class="h-64">
                                    <canvas id="yomi-distribution-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </div>
    </div>

    <!-- KPI Dashboard Content -->
    <div id="kpi-dashboard-content" class="app-content p-6 hidden">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 md:px-8 py-6">
            <h1 class="text-2xl font-semibold text-gray-900">KPI„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</h1>
            <p class="text-gray-500 text-sm mb-6">ÁµÑÁπîÂÖ®‰Ωì„ÅÆÈÄ≤ÊçóÁä∂Ê≥Å„ÄÅÊ≠©Áïô„Åæ„Çä„ÄÅÂ£≤‰∏ä‰∫àÊ∏¨„ÇíÂèØË¶ñÂåñ„Åó„Åæ„Åô„ÄÇ</p>

            <!-- Filter Bar -->
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-6 flex flex-wrap gap-4 items-end">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ÊúüÈñì</label>
                    <select id="kpi-filter-period" class="border border-gray-300 rounded px-3 py-1.5 text-sm">
                        <option value="this_month">‰ªäÊúà</option>
                        <option value="last_month">ÂÖàÊúà</option>
                        <option value="this_quarter" selected>‰ªäÂõõÂçäÊúü</option>
                        <option value="this_year">‰ªäÂπ¥Â∫¶</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ÊãÖÂΩìËÄÖ</label>
                    <select id="kpi-filter-user" class="border border-gray-300 rounded px-3 py-1.5 text-sm w-40">
                        <option value="">ÂÖ®Âì°</option>
                    </select>
                </div>
                <div>
                    <button onclick="loadKPIDashboard()"
                        class="bg-indigo-600 text-white px-4 py-1.5 rounded text-sm font-bold hover:bg-indigo-700">
                        <i class="fas fa-sync-alt mr-1"></i>Êõ¥Êñ∞
                    </button>
                </div>
            </div>

            <!-- KPI Cards (Feature B & D) -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-sm p-5 border border-gray-200">
                    <p class="text-xs font-bold text-gray-400 uppercase">Â£≤‰∏ä‰∫àÊ∏¨ („É®„Éü)</p>
                    <h3 class="text-2xl font-bold text-gray-800 mt-1" id="kpi-metric-revenue">¬•0
                    </h3>
                    <p class="text-xs text-green-600 mt-1"><i class="fas fa-arrow-up mr-1"></i>ÂâçÊúàÊØî
                        --%</p>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-5 border border-gray-200">
                    <p class="text-xs font-bold text-gray-400 uppercase">ÊúâÂäπÊ±Ç‰∫∫Êï∞</p>
                    <h3 class="text-2xl font-bold text-gray-800 mt-1" id="kpi-metric-jobs">0</h3>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-5 border border-gray-200">
                    <p class="text-xs font-bold text-gray-400 uppercase">ÈÅ∏ËÄÉ‰∏≠ÂÄôË£úËÄÖ</p>
                    <h3 class="text-2xl font-bold text-gray-800 mt-1" id="kpi-metric-candidates">0
                    </h3>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-5 border border-gray-200">
                    <p class="text-xs font-bold text-gray-400 uppercase">ÊàêÁ¥ÑÊï∞</p>
                    <h3 class="text-2xl font-bold text-gray-800 mt-1" id="kpi-metric-success">0</h3>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Feature A: Funnel Analysis -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h4 class="font-bold text-gray-800 mb-4">ÈÅ∏ËÄÉÊ≠©Áïô„Åæ„Çä („Éï„Ç°„Éç„É´)</h4>
                    <div class="relative h-64">
                        <canvas id="kpi-funnel-chart"></canvas>
                    </div>
                </div>

                <!-- Feature D: Activity Analysis -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h4 class="font-bold text-gray-800 mb-4">ÊãÖÂΩìËÄÖÂà•„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£</h4>
                    <div class="relative h-64">
                        <canvas id="kpi-activity-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Feature C: Stagnant Cases -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                    <h4 class="font-bold text-gray-800"><i
                            class="fas fa-exclamation-circle text-amber-500 mr-2"></i>ÂÅúÊªûÊ°à‰ª∂„Ç¢„É©„Éº„Éà
                        (5Êó•‰ª•‰∏äÂ§âÂãï„Å™„Åó)</h4>
                    <span class="bg-amber-100 text-amber-800 text-xs font-bold px-2 py-1 rounded-full"
                        id="stagnant-cases-count">0‰ª∂</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ÂÄôË£úËÄÖ</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Ê±Ç‰∫∫</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ÁèæÂú®„ÅÆ„Éï„Çß„Éº„Ç∫</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ÊúÄÁµÇÊõ¥Êñ∞Êó•</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ÊãÖÂΩìËÄÖ</th>
                                <th
                                    class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    „Ç¢„ÇØ„Ç∑„Éß„É≥</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="kpi-stagnant-table-body">
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
                                    „Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin: Organization Settings Page -->
    <div id="admin-settings-content" class="app-content p-6 hidden">
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h3 class="text-xl font-bold mb-4">ÁµÑÁπî„ÉªÈÄöÁü•Ë®≠ÂÆö</h3>
            <p class="text-gray-600 mb-6">ÁµÑÁπîÂÖ®‰Ωì„ÅÆÂãï‰ΩúÁí∞Â¢É„ÇÑ„ÄÅ„É°„Éº„É´ÈÄöÁü•„Å´Èñ¢„Åô„ÇãË®≠ÂÆö„ÇíÁÆ°ÁêÜ„Åó„Åæ„Åô„ÄÇ</p>

            <div class="space-y-6">
                <!-- Ëß£ÊûêÂ±•Ê≠¥„ÅÆÂÖ¨ÈñãÁØÑÂõ≤Ë®≠ÂÆö -->
                <div class="border-b border-gray-200 pb-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">Â§ñÈÉ®„Éó„É≠„Éï„Ç£„Éº„É´Ëß£ÊûêÂ±•Ê≠¥„ÅÆÂÖ¨ÈñãÁØÑÂõ≤</h4>
                    <p class="text-sm text-gray-500 mb-4">
                        „ÄåÂ§ñÈÉ®„Éó„É≠„Éï„Ç£„Éº„É´Ëß£Êûê„Äç„Åß‰ΩúÊàê„Åï„Çå„ÅüÂ±•Ê≠¥„Çí„ÄÅÁµÑÁπîÂÜÖ„ÅÆ‰ªñ„ÅÆ„É¶„Éº„Ç∂„Éº„ÅåÈñ≤Ë¶ß„Åß„Åç„Çã„Åã„Å©„ÅÜ„Åã„ÇíÂà∂Âæ°„Åó„Åæ„Åô„ÄÇ
                    </p>

                    <div class="bg-gray-50 p-4 rounded-lg">
                        <label class="flex items-start mb-3 cursor-pointer">
                            <input type="radio" name="setting-history-visibility" value="all"
                                class="mt-1 mr-3 h-4 w-4 text-indigo-600">
                            <div>
                                <div class="font-bold text-gray-900">ÂÖ®Âì°„Å´ÂÖ¨Èñã (Ê®ôÊ∫ñ)</div>
                                <div class="text-sm text-gray-600">
                                    ÁµÑÁπîÂÜÖ„ÅÆ„Åô„Åπ„Å¶„ÅÆ„É¶„Éº„Ç∂„Éº„Åå„ÄÅ‰ªñ„ÅÆ„É¶„Éº„Ç∂„Éº„Åå‰ΩúÊàê„Åó„ÅüËß£ÊûêÂ±•Ê≠¥„ÉªÊ±Ç‰∫∫ÊèêÊ°àÂÜÖÂÆπ„ÇíÈñ≤Ë¶ß„Åß„Åç„Åæ„Åô„ÄÇÂÖ±ÊúâÁü•„Å®„Åó„Å¶„ÅÆÊ¥ªÁî®„Å´ÈÅ©„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ
                                </div>
                            </div>
                        </label>

                        <label class="flex items-start cursor-pointer">
                            <input type="radio" name="setting-history-visibility" value="personal"
                                class="mt-1 mr-3 h-4 w-4 text-indigo-600">
                            <div>
                                <div class="font-bold text-gray-900">‰ΩúÊàêËÄÖ„ÅÆ„ÅøÈñ≤Ë¶ß („Éó„É©„Ç§„Éô„Éº„Éà)</div>
                                <div class="text-sm text-gray-600">
                                    „É¶„Éº„Ç∂„Éº„ÅØËá™ÂàÜ„ÅåÂÆüË°å„Åó„ÅüËß£ÊûêÂ±•Ê≠¥„ÅÆ„ÅøÈñ≤Ë¶ß„Åß„Åç„Åæ„Åô„ÄÇ„Åü„Å†„Åó„ÄÅÁµÑÁπîÂÖ®‰Ωì„ÅÆÈõÜË®àÊï∞ÂÄ§„Å™„Å©„ÅØË°®Á§∫„Åï„Çå„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- „Çπ„Ç´„Ç¶„ÉàÂ±•Ê≠¥„ÅÆÂÖ¨ÈñãÁØÑÂõ≤Ë®≠ÂÆö -->
                <div class="border-b border-gray-200 pb-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">„Çπ„Ç´„Ç¶„ÉàÂ±•Ê≠¥„ÅÆÂÖ¨ÈñãÁØÑÂõ≤</h4>
                    <p class="text-sm text-gray-500 mb-4">
                        „Äå„Çπ„Ç´„Ç¶„ÉàÁÆ°ÁêÜ„Äç„ÅßË°®Á§∫„Åï„Çå„ÇãÂÄôË£úËÄÖ„Åä„Çà„Å≥ÈÄÅ‰ø°Â±•Ê≠¥„Çí„ÄÅÁµÑÁπîÂÜÖ„ÅÆ‰ªñ„ÅÆ„É¶„Éº„Ç∂„Éº„ÅåÈñ≤Ë¶ß„Åß„Åç„Çã„Åã„Å©„ÅÜ„Åã„ÇíÂà∂Âæ°„Åó„Åæ„Åô„ÄÇ
                    </p>

                    <div class="bg-gray-50 p-4 rounded-lg">
                        <label class="flex items-start mb-3 cursor-pointer">
                            <input type="radio" name="setting-scout-visibility" value="all"
                                class="mt-1 mr-3 h-4 w-4 text-indigo-600">
                            <div>
                                <div class="font-bold text-gray-900">ÂÖ®Âì°„Å´ÂÖ¨Èñã (Ê®ôÊ∫ñ)</div>
                                <div class="text-sm text-gray-600">
                                    ÁµÑÁπîÂÜÖ„ÅÆ„Åô„Åπ„Å¶„ÅÆ„É¶„Éº„Ç∂„Éº„Åå„ÄÅ‰ªñ„ÅÆ„É¶„Éº„Ç∂„Éº„ÅåÈÄÅ‰ø°„Åó„Åü„Çπ„Ç´„Ç¶„ÉàÂ±•Ê≠¥„ÉªÂÄôË£úËÄÖ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÈñ≤Ë¶ß„Åß„Åç„Åæ„Åô„ÄÇÈáçË§á„Çπ„Ç´„Ç¶„Éà„ÅÆÈò≤Ê≠¢„Å´ÈÅ©„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ
                                </div>
                            </div>
                        </label>

                        <label class="flex items-start cursor-pointer">
                            <input type="radio" name="setting-scout-visibility" value="personal"
                                class="mt-1 mr-3 h-4 w-4 text-indigo-600">
                            <div>
                                <div class="font-bold text-gray-900">‰ΩúÊàêËÄÖ„ÅÆ„ÅøÈñ≤Ë¶ß („Éó„É©„Ç§„Éô„Éº„Éà)</div>
                                <div class="text-sm text-gray-600">
                                    „É¶„Éº„Ç∂„Éº„ÅØËá™ÂàÜ„Åå„Çπ„Ç´„Ç¶„Éà„ÇíÈÄÅ„Å£„ÅüÂÄôË£úËÄÖ„Åä„Çà„Å≥„Åù„ÅÆÂ±•Ê≠¥„ÅÆ„ÅøÈñ≤Ë¶ß„Åß„Åç„Åæ„Åô„ÄÇ</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- „É°„Éº„É´ÈÄöÁü•Ë®≠ÂÆö -->
                <div class="border-b border-gray-200 pb-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">„É°„Éº„É´ÈÄöÁü•Ë®≠ÂÆö</h4>
                    <p class="text-sm text-gray-500 mb-4">
                        Ê±ÇËÅ∑ËÄÖ„Å∏Ëá™ÂãïÈÄÅ‰ø°„Åï„Çå„Çã„É°„Éº„É´ÈÄöÁü•„ÅÆÊúâÂäπ/ÁÑ°Âäπ„ÇíÁÆ°ÁêÜ„Åó„Åæ„Åô„ÄÇ
                    </p>

                    <div class="space-y-4 bg-indigo-50/50 p-6 rounded-xl border border-indigo-100">
                        <label class="flex items-center cursor-pointer group">
                            <div class="relative inline-flex items-center">
                                <input type="checkbox" id="admin-setting-email-all-off" class="sr-only peer"
                                    onchange="$('#admin-email-detailed-settings-container').toggleClass('opacity-50 pointer-events-none', this.checked)">
                                <div
                                    class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-500">
                                </div>
                            </div>
                            <span
                                class="ml-3 text-sm font-bold text-gray-700 group-hover:text-red-600 transition-colors">Ê±ÇËÅ∑ËÄÖ„Å∏„ÅÆ„É°„Éº„É´ÈÄöÁü•„Çí„Åô„Åπ„Å¶ÂÅúÊ≠¢„Åô„Çã</span>
                        </label>

                        <div id="admin-email-detailed-settings-container"
                            class="pl-4 space-y-6 border-l-2 border-indigo-200">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label
                                    class="flex items-center cursor-pointer p-2 hover:bg-white/50 rounded transition">
                                    <input type="checkbox" id="admin-setting-email-application"
                                        class="form-checkbox h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500"
                                        checked>
                                    <div class="ml-3">
                                        <p class="text-sm font-medium text-gray-700">ÂøúÂãüÂÆå‰∫ÜÈÄöÁü•</p>
                                        <p class="text-[10px] text-gray-400">Ê±ÇËÅ∑ËÄÖ„ÅåËá™Ë∫´„ÄÅ„Åæ„Åü„ÅØ‰ª£ÁêÜ„ÅßÂøúÂãü„Åó„ÅüÈöõ„Å´ÈÄÅ‰ø°„Åï„Çå„Åæ„Åô</p>
                                    </div>
                                </label>
                                <label
                                    class="flex items-center cursor-pointer p-2 hover:bg-white/50 rounded transition">
                                    <input type="checkbox" id="admin-setting-email-scout"
                                        class="form-checkbox h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500"
                                        checked>
                                    <div class="ml-3">
                                        <p class="text-sm font-medium text-gray-700">„Çπ„Ç´„Ç¶„ÉàÈÄöÁü•</p>
                                        <p class="text-[10px] text-gray-400">‰ΩúÊàê„Åó„Åü„Çπ„Ç´„Ç¶„Éà„É°„ÉÉ„Çª„Éº„Ç∏„ÅåÈÄÅ‰ø°„Åï„Çå„ÅüÈöõ„Å´ÈÄöÁü•„Åï„Çå„Åæ„Åô</p>
                                    </div>
                                </label>
                                <label
                                    class="flex items-center cursor-pointer p-2 hover:bg-white/50 rounded transition">
                                    <input type="checkbox" id="admin-setting-email-recommendation"
                                        class="form-checkbox h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500"
                                        checked>
                                    <div class="ml-3">
                                        <p class="text-sm font-medium text-gray-700">Ê°à‰ª∂Á¥π‰ªãÈÄöÁü•</p>
                                        <p class="text-[10px] text-gray-400">„Åä„Åô„Åô„ÇÅ„ÅÆÊ°à‰ª∂„ÇíÁ¥π‰ªãÔºàÊé®Ëñ¶Ôºâ„Åó„ÅüÈöõ„Å´ÈÄöÁü•„Åï„Çå„Åæ„Åô</p>
                                    </div>
                                </label>
                                <label
                                    class="flex items-center cursor-pointer p-2 hover:bg-white/50 rounded transition">
                                    <input type="checkbox" id="admin-setting-email-status-enabled"
                                        class="form-checkbox h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500"
                                        checked
                                        onchange="$('#admin-email-status-filter-container').toggleClass('hidden', !this.checked)">
                                    <div class="ml-3">
                                        <p class="text-sm font-medium text-gray-700">ÈÅ∏ËÄÉ„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥ÈÄöÁü•</p>
                                        <p class="text-[10px] text-gray-400">ÈÅ∏ËÄÉÁä∂Ê≥Å„ÅåÊõ¥Êñ∞„Åï„Çå„ÅüÈöõ„Å´ÈÄöÁü•„Åï„Çå„Åæ„Åô</p>
                                    </div>
                                </label>
                            </div>

                            <div id="admin-email-status-filter-container"
                                class="mt-2 p-4 bg-white rounded-lg border border-indigo-100 shadow-sm transition-all">
                                <p
                                    class="text-[11px] font-bold text-gray-500 mb-3 uppercase tracking-wider flex items-center">
                                    <i class="fas fa-filter mr-1 text-indigo-400"></i>ÈÄöÁü•„Çí<span
                                        class="text-red-500 mx-1">Èô§Â§ñ„Åô„Çã</span>„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÈÅ∏Êäû
                                </p>
                                <div id="admin-email-status-exclude-list"
                                    class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                                    <!-- Dynamic statuses populated by JS -->
                                    <div class="text-xs text-gray-400 py-2 text-center col-span-full">„Çπ„ÉÜ„Éº„Çø„Çπ„Éû„Çπ„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...
                                    </div>
                                </div>
                                <p class="text-[10px] text-gray-400 mt-3 bg-gray-50 p-2 rounded">
                                    ‚Äª„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÖ•„Çå„Åü„Çπ„ÉÜ„Éº„Çø„Çπ„Å´Êõ¥Êñ∞„Åï„Çå„ÅüÈöõ„ÅØ„ÄÅÊ±ÇËÅ∑ËÄÖ„Å∏„É°„Éº„É´ÈÄöÁü•„ÅåÈÄÅ‰ø°„Åï„Çå„Åæ„Åõ„Çì„ÄÇ</p>
                            </div>
                        </div>

                        <!-- Ê±Ç‰∫∫„Ç§„É≥„Éù„Éº„ÉàË®≠ÂÆö -->
                        <div class="border-b border-gray-200 pb-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-2">Ê±Ç‰∫∫„Ç§„É≥„Éù„Éº„ÉàË®≠ÂÆö</h4>
                            <p class="text-sm text-gray-500 mb-4">
                                Ê±Ç‰∫∫„ÅÆ‰∏ÄÊã¨„Ç§„É≥„Éù„Éº„ÉàÊôÇ„ÅÆÊåôÂãï„ÇíÁÆ°ÁêÜ„Åó„Åæ„Åô„ÄÇ
                            </p>
                            <div class="bg-indigo-50/50 p-4 rounded-xl border border-indigo-100">
                                <label class="flex items-center cursor-pointer group">
                                    <input type="checkbox" id="admin-setting-bulk-duplicate-confirm"
                                        class="form-checkbox h-5 w-5 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 transition-all">
                                    <div class="ml-3">
                                        <p class="text-sm font-bold text-gray-700">Ë§áÊï∞PDFÂèñ„ÇäËæº„ÅøÊôÇ„Å´ÈáçË§áÁñë„ÅÑ„ÇíÂæå„Åß‰∏ÄÊã¨Á¢∫Ë™ç„Åô„Çã</p>
                                        <p class="text-[11px] text-gray-500 mt-0.5">
                                            ‚ÄªON„ÅÆÂ†¥Âêà„ÄÅÂá¶ÁêÜ‰∏≠„Å´‰∏Ä„Å§„Åö„Å§Á¢∫Ë™ç„Åõ„Åö„ÄÅÊúÄÂæå„Å´‰∏ÄË¶ß„Åß„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶ÁôªÈå≤„Åß„Åç„Åæ„Åô„ÄÇ</p>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- ÂÖ±ÈÄöÈÄöÁü•ÂÖàË®≠ÂÆö -->
                        <div class="mt-8 pt-6 border-t border-indigo-100">
                            <h5 class="text-sm font-bold text-gray-700 mb-2 flex items-center">
                                <i class="fas fa-users-cog mr-2 text-indigo-500"></i>ÂÖ±ÈÄöÈÄöÁü•ÂÖàË®≠ÂÆö (Á§æÂÜÖÊãÖÂΩìËÄÖÁî®)
                            </h5>
                            <p class="text-[10px] text-gray-400 mb-3">
                                ÊãÖÂΩìCA„ÉªRA„Å∏„ÅÆÈÄöÁü•ÔºàÂøúÂãüÊôÇ„ÇÑ„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥ÊôÇÔºâ„Çí„ÄÅÂÖ±ÈÄö„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Åß„ÇÇÂèó‰ø°„Åó„Åü„ÅÑÂ†¥Âêà„Å´Ë®≠ÂÆö„Åó„Åæ„Åô„ÄÇ<br>
                                ÊîπË°å„ÄÅ„Åæ„Åü„ÅØ„Ç´„É≥„ÉûÂå∫Âàá„Çä„ÅßË§áÊï∞„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•ÂäõÂèØËÉΩ„Åß„Åô„ÄÇ
                            </p>
                            <textarea id="admin-setting-email-common" rows="2"
                                class="w-full px-4 py-2 border border-indigo-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 bg-white"
                                placeholder="‰æã: admin@example.com, info@example.com"></textarea>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end pt-4">
                    <button onclick="saveAdminSettings()"
                        class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition shadow-sm">
                        <i class="fas fa-save mr-2"></i>Ë®≠ÂÆö„Çí‰øùÂ≠ò
                    </button>
                </div>
            </div>
        </div>

        <!-- „ÉÜ„É≥„Éó„É¨„Éº„ÉàÁÆ°ÁêÜ Page -->
        <div id="admin-templates-content" class="app-content p-6 hidden">
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-xl font-bold">Êé®Ëñ¶„É°„Éº„É´„Éª„É°„ÉÉ„Çª„Éº„Ç∏„ÉÜ„É≥„Éó„É¨„Éº„Éà</h2>
                        <p class="text-gray-600 mt-1">ÂÄôË£úËÄÖ„Å∏ÈÄÅ„ÇãÊé®Ëñ¶„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂÆöÂûãÊñá„ÇíÁÆ°ÁêÜ„Åó„Åæ„Åô„ÄÇ</p>
                    </div>
                    <button onclick="openEmailTemplateModal()"
                        class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition flex items-center gap-2">
                        <i class="fas fa-plus"></i> Êñ∞Ë¶è‰ΩúÊàê
                    </button>
                </div>

                <div id="email-templates-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Templates will be rendered here -->
                    <div class="animate-pulse bg-gray-100 h-32 rounded-lg"></div>
                </div>
            </div>

            <!-- „É°„Éº„É´„ÉÜ„É≥„Éó„É¨„Éº„ÉàÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
            <div id="email-template-modal"
                class="fixed inset-0 bg-black bg-opacity-50 z-[110] hidden flex items-center justify-center p-4">
                <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="p-6 border-b bg-indigo-50 flex justify-between items-center">
                        <h3 class="text-xl font-bold text-indigo-900" id="template-modal-title">
                            „ÉÜ„É≥„Éó„É¨„Éº„ÉàÁ∑®ÈõÜ</h3>
                        <button onclick="closeEmailTemplateModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-6 space-y-4">
                        <input type="hidden" id="template-id">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂêç</label>
                            <input type="text" id="template-name"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"
                                placeholder="‰æã: Ê®ôÊ∫ñÊé®Ëñ¶„É°„Éº„É´, LinkedInÁî®„Å™„Å©">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">„É°„Éº„É´‰ª∂Âêç
                                (‰ªªÊÑè)</label>
                            <input type="text" id="template-subject"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"
                                placeholder="ÂÄôË£úËÄÖ„Å∏ÈÄÅ‰ø°„Åô„ÇãÈöõ„ÅÆÊ®ôÊ∫ñ‰ª∂Âêç">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Êú¨Êñá„ÉÜ„É≥„Éó„É¨„Éº„Éà</label>
                            <div class="bg-blue-50 p-3 rounded text-xs text-blue-700 mb-2 leading-relaxed">
                                <i class="fas fa-info-circle mr-1"></i>‰ª•‰∏ã„ÅÆÂ§âÊï∞„Çí‰ΩøÁî®„Åß„Åç„Åæ„ÅôÔºö<br>
                                <code>{{userName}}</code>ÔºöÂÄôË£úËÄÖÂêç„ÄÅ
                                <code>{{agentName}}</code>ÔºöÊãÖÂΩì„Ç®„Éº„Ç∏„Çß„É≥„ÉàÂêç„ÄÅ
                                <code>{{jobDetails}}</code>ÔºöÊ±Ç‰∫∫ÊÉÖÂ†±„ÅÆË©≥Á¥∞„É™„Çπ„ÉàÔºà„Åä„Åô„Åô„ÇÅÁêÜÁî±Âê´„ÇÄÔºâ„ÄÅ
                                <code>{{recommendationReason}}</code>Ôºö1‰ª∂ÁõÆ„ÅÆ„Åä„Åô„Åô„ÇÅÁêÜÁî±
                            </div>
                            <textarea id="template-body" rows="12"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm font-mono focus:ring-2 focus:ring-indigo-500"></textarea>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="template-is-default" class="w-4 h-4 text-indigo-600 rounded">
                            <label for="template-is-default" class="ml-2 text-sm text-gray-700">„Éá„Éï„Ç©„É´„Éà„Å´Ë®≠ÂÆö„Åô„Çã</label>
                        </div>
                    </div>
                    <div class="p-6 border-t bg-gray-50 flex justify-end gap-3">
                        <button onclick="closeEmailTemplateModal()"
                            class="px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition font-medium">
                            „Ç≠„É£„É≥„Çª„É´
                        </button>
                        <button onclick="saveEmailTemplate()"
                            class="px-8 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold shadow-lg transition">
                            ‰øùÂ≠ò„Åô„Çã
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Super Admin: Prompt Settings Page -->
        <!-- Super Admin: Organization Management Page -->
        <div id="super-admin-organizations-content" class="app-content p-6 hidden">
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-gray-600 mb-2">Âà©Áî®ÁµÑÁπîÔºà„ÉÜ„Éä„É≥„ÉàÔºâ„ÅÆÂ•ëÁ¥Ñ„Éó„É©„É≥„ÇÑ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÁÆ°ÁêÜ„Åó„Åæ„Åô„ÄÇ</p>
                    </div>
                    <button onclick="showOrganizationModal()"
                        class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">
                        <i class="fas fa-plus mr-2"></i>Êñ∞Ë¶èÁµÑÁπî‰ΩúÊàê
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ÁµÑÁπîÂêç
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                „Éó„É©„É≥
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                „Çπ„ÉÜ„Éº„Çø„Çπ
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                „É¶„Éº„Ç∂„ÉºÊï∞
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ÊúâÂäπÊúüÈôê
                            </th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Êìç‰Ωú
                            </th>
                        </tr>
                    </thead>
                    <tbody id="super-admin-organizations-container" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
                                „Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Admin: User Edit Modal -->
        <div id="admin-user-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
            style="z-index: 30000;">
            <div class="bg-white rounded-lg w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold" id="admin-user-modal-title">„É¶„Éº„Ç∂„ÉºÁ∑®ÈõÜ</h3>
                    <button onclick="closeAdminUserModal()"
                        class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <form id="admin-user-form">
                    <!-- PDF Parsing Area -->
                    <div class="mb-6 p-4 bg-indigo-50 border border-dashed border-indigo-300 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="text-sm font-bold text-indigo-900 mb-1">
                                    <i class="fas fa-file-pdf mr-2"></i>Â±•Ê≠¥Êõ∏/ËÅ∑ÂãôÁµåÊ≠¥Êõ∏„Åã„ÇâËá™ÂãïÂÖ•Âäõ
                                </h4>
                                <p class="text-xs text-indigo-700">
                                    PDF„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åô„Çã„Å®„ÄÅAI„ÅåÊ∞èÂêç„Éª„Çπ„Ç≠„É´„ÉªÁµåÊ≠¥„Å™„Å©„ÇíËß£Êûê„Åó„Å¶„Éï„Ç©„Éº„É†„Å´ÂÖ•Âäõ„Åó„Åæ„Åô„ÄÇ
                                </p>
                            </div>
                            <div>
                                <label for="admin-user-pdf-upload"
                                    class="cursor-pointer bg-white text-indigo-600 border border-indigo-600 px-3 py-1.5 rounded text-sm font-medium hover:bg-indigo-50 transition shadow-sm">
                                    <i class="fas fa-upload mr-1"></i>PDF„ÇíÈÅ∏Êäû
                                </label>
                                <input type="file" id="admin-user-pdf-upload" accept="application/pdf" class="hidden"
                                    onchange="handleAdminUserPdfUpload(this)">
                            </div>
                        </div>
                    </div>

                    <input type="hidden" id="admin-user-id">

                    <!-- Âü∫Êú¨ÊÉÖÂ†± -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÂêçÂâç *</label>
                        <input type="text" id="admin-user-name" required class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">„Åµ„Çä„Åå„Å™</label>
                        <input type="text" id="admin-user-furigana" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ
                            *</label>
                        <input type="email" id="admin-user-email" required class="w-full px-4 py-2 border rounded-lg">
                    </div>

                    <!-- „Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥ÔºàÊñ∞Ë¶èËøΩÂä†Ôºâ -->
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <label class="block text-sm font-medium text-gray-700 mb-1">„Éë„Çπ„ÉØ„Éº„Éâ„ÅÆÂ§âÊõ¥</label>
                        <div class="flex gap-2">
                            <input type="password" id="admin-user-new-password" placeholder="Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ"
                                class="flex-1 px-4 py-2 border rounded-lg text-sm">
                            <button type="button" onclick="updateUserPassword()"
                                class="bg-gray-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-gray-700 transition shadow-sm whitespace-nowrap">
                                „Éë„Çπ„ÉØ„Éº„ÉâÊõ¥Êñ∞
                            </button>
                        </div>
                        <p class="text-[10px] text-gray-500 mt-1">‚Äª
                            „Éë„Çπ„ÉØ„Éº„Éâ„Çí‰∏äÊõ∏„Åç„Åó„Åæ„Åô„ÄÇÁ©∫„ÅÆ„Åæ„Åæ„ÄåÊõ¥Êñ∞„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„ÇÇÂ§âÊõ¥„Åï„Çå„Åæ„Åõ„Çì„ÄÇ</p>
                    </div>

                    <!-- Ê®©ÈôêÔºàÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÂ§âÊõ¥ÂèØÔºâ -->
                    <div id="admin-user-role-container">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ê®©Èôê</label>
                        <select id="admin-user-role" class="w-full px-4 py-2 border rounded-lg">
                            <option value="org_admin">ÁµÑÁπîÁÆ°ÁêÜËÄÖ</option>
                            <option value="admin">ÁÆ°ÁêÜËÄÖ</option>
                            <option value="coach">CA„ÉªRA</option>
                            <option value="candidate">Ê±ÇËÅ∑ËÄÖ</option>
                        </select>
                    </div>

                    <!-- „Çπ„ÉÜ„Éº„Çø„Çπ -->
                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Âà©Áî®„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                            <select id="admin-user-status" class="w-full px-4 py-2 border rounded-lg">
                                <option value="active">Âà©Áî®‰∏≠</option>
                                <option value="suspended">ÂÅúÊ≠¢</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ÁÆ°ÁêÜ„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                            <select id="admin-user-management-status" class="w-full px-4 py-2 border rounded-lg">
                                <option value="active">Ê¥ªÂãï‰∏≠</option>
                                <option value="inactive">Ê¥ªÂãïÁµÇ‰∫Ü</option>
                            </select>
                        </div>
                    </div>

                    <!-- Ê±ÇËÅ∑ËÄÖÁî®„Éï„Ç£„Éº„É´„Éâ -->
                    <div id="admin-candidate-fields" class="hidden space-y-4 border-t pt-4 mt-4">
                        <h4 class="font-medium text-gray-900">Ê±ÇËÅ∑ËÄÖÊÉÖÂ†±</h4>

                        <!-- ÊãÖÂΩì„Ç≥„Éº„ÉÅÔºàÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÂ§âÊõ¥ÂèØÔºâ -->
                        <div id="admin-user-coach-container">
                            <label class="block text-sm font-medium text-gray-700 mb-1">ÊãÖÂΩìCA„ÉªRA</label>
                            <select id="admin-user-coach" class="w-full px-4 py-2 border rounded-lg">
                                <option value="">Êú™Ë®≠ÂÆö</option>
                                <!-- „Ç≥„Éº„ÉÅ‰∏ÄË¶ß„ÇíJS„ÅßÊåøÂÖ• -->
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ÊâÄÂ±û„ÉÅ„Éº„É†</label>
                            <select id="admin-user-team" class="w-full px-4 py-2 border rounded-lg">
                                <option value="">Êú™Ë®≠ÂÆö</option>
                                <!-- „ÉÅ„Éº„É†‰∏ÄË¶ß„ÇíJS„ÅßÊåøÂÖ• -->
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Â∏åÊúõËÅ∑Á®Æ</label>
                            <select id="admin-user-job-type" class="w-full px-4 py-2 border rounded-lg select2" multiple
                                style="width: 100%">
                                <!-- Options will be loaded dynamically -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Â∏åÊúõÊ•≠Áïå</label>
                            <select id="admin-user-industry" class="w-full px-4 py-2 border rounded-lg select2" multiple
                                style="width: 100%">
                                <!-- Options will be loaded dynamically -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Â∏åÊúõÂã§ÂãôÂú∞</label>
                            <div class="flex gap-2">
                                <select id="admin-user-prefecture" class="w-1/3 px-2 py-2 border rounded-lg select2"
                                    multiple="multiple" style="width: 40%">
                                </select>
                                <input type="text" id="admin-user-city" placeholder="Â∏ÇÂå∫Áî∫Êùë"
                                    class="w-2/3 px-4 py-2 border rounded-lg" style="width: 60%">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Â∏åÊúõÈõáÁî®ÂΩ¢ÊÖã</label>
                            <select id="admin-user-employment-type" class="w-full px-4 py-2 border rounded-lg select2"
                                multiple style="width: 100%">
                                <!-- Options will be loaded dynamically -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Â∏åÊúõÂπ¥Âèé
                                (‰∏áÂÜÜ)</label>
                            <input type="number" id="admin-user-salary" class="w-full px-4 py-2 border rounded-lg"
                                min="0">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÁîüÂπ¥ÊúàÊó•</label>
                                <input type="date" id="admin-user-birth-date"
                                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 transition-all"
                                    onchange="calculateAge(this.value, '#admin-user-age')">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Âπ¥ÈΩ¢</label>
                                <input type="number" id="admin-user-age"
                                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 transition-all font-mono"
                                    min="0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÊÄßÂà•</label>
                                <select id="admin-user-gender" class="w-full px-4 py-2 border rounded-lg">
                                    <option value="">ÈÅ∏Êäû</option>
                                    <option value="Áî∑ÊÄß">Áî∑ÊÄß</option>
                                    <option value="Â•≥ÊÄß">Â•≥ÊÄß</option>
                                    <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Áèæ‰ΩèÊâÄÔºàÂ±Ö‰ΩèÂú∞Ôºâ</label>
                            <select id="admin-user-current-location" class="w-full px-4 py-2 border rounded-lg">
                                <option value="">ÈÉΩÈÅìÂ∫úÁúå„ÇíÈÅ∏Êäû</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Â≠¶Ê≠¥</label>
                            <textarea id="admin-user-education" rows="2" class="w-full px-4 py-2 border rounded-lg"
                                placeholder="‰æã: „Äá„ÄáÂ§ßÂ≠¶ „Äá„ÄáÂ≠¶ÈÉ® ÂçíÊ•≠"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">„Çπ„Ç≠„É´</label>
                            <textarea id="admin-user-skills" rows="3"
                                class="w-full px-4 py-2 border rounded-lg"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ËÅ∑Ê≠¥Ê¶ÇË¶Å</label>
                            <textarea id="admin-user-history" rows="3"
                                class="w-full px-4 py-2 border rounded-lg"></textarea>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÈõªË©±Áï™Âè∑</label>
                                <input type="tel" id="admin-user-phone" class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-indigo-700 font-bold mb-1">Â∏åÊúõ„Éï„É™„Éº„ÉØ„Éº„Éâ /
                                    AND„ÉªOR</label>
                                <div class="flex items-center gap-2">
                                    <div class="flex-1">
                                        <input type="text" id="admin-user-freewords" placeholder="‰æã: „É™„É¢„Éº„Éà, Ëã±Ë™û"
                                            class="w-full px-4 py-2 border border-indigo-200 bg-indigo-50/30 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <div id="admin-user-freewords-tags" class="tag-container mt-2"></div>
                                    </div>
                                    <div
                                        class="flex shrink-0 items-center justify-around gap-2 bg-indigo-50 px-2 py-1.5 border border-indigo-100 rounded-lg w-[115px]">
                                        <label class="flex items-center gap-1 cursor-pointer">
                                            <input type="radio" name="admin-user-freewords-condition" value="and"
                                                checked class="w-4 h-4 text-indigo-600">
                                            <span class="text-[10px] font-black text-indigo-800">AND</span>
                                        </label>
                                        <label class="flex items-center gap-1 cursor-pointer">
                                            <input type="radio" name="admin-user-freewords-condition" value="or"
                                                class="w-4 h-4 text-indigo-600">
                                            <span class="text-[10px] font-black text-indigo-800">OR</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-wrap gap-4 py-3 px-4 bg-gray-50 rounded-lg border border-gray-100">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="admin-user-job-exp-ok"
                                    class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 mr-2">
                                <span class="text-sm text-gray-700">ËÅ∑Á®ÆÊú™ÁµåÈ®ìÂèØ</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="admin-user-industry-exp-ok"
                                    class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 mr-2">
                                <span class="text-sm text-gray-700">Ê•≠ÁïåÊú™ÁµåÈ®ìÂèØ</span>
                            </label>
                            <label class="flex items-center cursor-pointer ml-auto border-l pl-4 border-gray-200">
                                <input type="checkbox" id="admin-user-enable-auto-reco"
                                    class="w-4 h-4 text-green-600 rounded border-gray-300 focus:ring-green-500 mr-2">
                                <span class="text-sm text-gray-900 font-bold">Ëá™Âãï„Åä„Åô„Åô„ÇÅÊ±Ç‰∫∫</span>
                            </label>
                        </div>

                        <!-- „Åä„Åô„Åô„ÇÅÂØæË±°Â§ñ‰ºÅÊ•≠ (New) -->
                        <div class="mt-2 p-4 bg-red-50 rounded-lg border border-red-100">
                            <label class="block text-sm font-bold text-red-900 mb-2">
                                <i class="fas fa-ban mr-1"></i> „Åä„Åô„Åô„ÇÅÂØæË±°Â§ñ‰ºÅÊ•≠„ÅÆË®≠ÂÆö
                            </label>
                            <p class="text-[11px] text-red-700 mb-3 leading-tight">
                                „Åì„Åì„Å´ÁôªÈå≤„Åï„Çå„Åü‰ºÅÊ•≠„ÅØ„ÄÅAI„Å´„Çà„ÇãËá™Âãï„Éû„ÉÉ„ÉÅ„É≥„Ç∞„ÇÑ„Åä„Åô„Åô„ÇÅÊ±Ç‰∫∫„ÅÆÂØæË±°„Åã„ÇâÈô§Â§ñ„Åï„Çå„Åæ„Åô„ÄÇ
                            </p>

                            <div class="relative mb-3">
                                <div class="flex gap-2">
                                    <div class="relative flex-1">
                                        <div
                                            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-search text-gray-400 text-xs"></i>
                                        </div>
                                        <input type="text" id="admin-excluded-company-search-input"
                                            placeholder="‰ºÅÊ•≠Âêç„ÅßÊ§úÁ¥¢..."
                                            class="w-full pl-9 pr-4 py-2 border border-red-200 rounded-lg text-sm focus:ring-2 focus:ring-red-500 focus:border-red-500 bg-white"
                                            onkeyup="handleAdminExcludedCompanySearch(this.value)">
                                    </div>
                                </div>
                                <!-- Ê§úÁ¥¢ÁµêÊûú„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥ -->
                                <div id="admin-excluded-company-results"
                                    class="absolute z-10 w-full bg-white border border-gray-200 rounded-lg shadow-xl mt-1 hidden max-h-60 overflow-y-auto">
                                </div>
                            </div>

                            <div id="admin-excluded-companies-tags" class="flex flex-wrap gap-2">
                                <!-- ÁôªÈå≤Ê∏à„Åø‰ºÅÊ•≠„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                            </div>
                        </div>

                        <!-- ÊßãÈÄ†Âåñ„Åï„Çå„ÅüËÅ∑Ê≠¥ (New) -->
                        <div class="mb-6 border-t border-gray-200 pt-4">
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-medium text-gray-700">Ë©≥Á¥∞ËÅ∑Ê≠¥
                                    (ÊúÄÂ§ß10Á§æ)</label>
                                <button type="button" onclick="addWorkHistoryItem()"
                                    class="text-sm text-indigo-600 hover:text-indigo-800 flex items-center font-medium">
                                    <i class="fas fa-plus-circle mr-1"></i>ËÅ∑Ê≠¥„ÇíËøΩÂä†
                                </button>
                            </div>
                            <div id="work-history-list" class="space-y-4 mb-2">
                                <!-- JS„ÅßÂãïÁöÑ„Å´ËøΩÂä† -->
                            </div>

                            <div class="flex items-center gap-4 mt-2 mb-4">
                                <label class="text-xs text-gray-500">ÁµåÈ®ìÁ§æÊï∞ (Ëá™ÂãïË®àÁÆó):</label>
                                <input type="number" id="admin-user-job-change-count"
                                    class="w-20 px-2 py-1 border rounded bg-gray-50 text-center text-sm" readonly>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ËÅ∑ÂãôÁµåÊ≠¥Êõ∏
                                (Ë©≥Á¥∞„ÉÜ„Ç≠„Çπ„Éà)</label>
                            <textarea id="admin-user-work-history-detail" rows="10"
                                class="w-full px-4 py-2 border rounded-lg text-sm font-mono bg-gray-50 focus:bg-white transition"
                                placeholder="ËÅ∑ÂãôÁµåÊ≠¥„ÅÆË©≥Á¥∞„ÉÜ„Ç≠„Çπ„Éà"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Â±•Ê≠¥ÊÉÖÂ†±</label>
                            <textarea id="admin-user-history-info" rows="6"
                                class="w-full px-4 py-2 border rounded-lg text-sm bg-gray-50 focus:bg-white transition"
                                placeholder="Â±•Ê≠¥ÊÉÖÂ†±„ÅÆË£úË∂≥„Å™„Å©"></textarea>
                        </div>

                        <!-- Â§ñÈÉ®ÈÄ£Êê∫URL -->
                        <div class="border-t border-gray-200 pt-4 mt-4">
                            <h5 class="text-sm font-bold text-gray-700 mb-3">Â§ñÈÉ®ÈÄ£Êê∫URL</h5>
                            <div class="grid grid-cols-1 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Google
                                        Drive
                                        URL</label>
                                    <input type="url" id="admin-user-drive-url"
                                        class="w-full px-4 py-2 border rounded-lg"
                                        placeholder="https://drive.google.com/...">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">NotebookLM
                                        URL</label>
                                    <input type="url" id="admin-user-notebooklm-url"
                                        class="w-full px-4 py-2 border rounded-lg"
                                        placeholder="https://notebooklm.google.com/...">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">LINE
                                        URL</label>
                                    <input type="url" id="admin-user-line-url"
                                        class="w-full px-4 py-2 border rounded-lg" placeholder="https://line.me/...">
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Á§æÂÜÖ„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÊÉÖÂ†±</label>
                            <textarea id="admin-user-resume-detail" rows="6"
                                class="w-full px-4 py-2 border rounded-lg text-sm font-mono bg-gray-50 focus:bg-white transition"
                                placeholder="Á§æÂÜÖ„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÊÉÖÂ†±Ôºà„Çπ„Ç≠„É´„ÄÅÁµåÈ®ì„ÄÅÂ∏åÊúõ„ÅÆË£úË∂≥„Å™„Å©Ôºâ"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Á§æÂÜÖ„É°„É¢„ÉªÂÖ±Êúâ‰∫ãÈ†Ö</label>
                            <textarea id="admin-user-notes" rows="6"
                                class="w-full px-4 py-2 border rounded-lg text-sm bg-gray-50 focus:bg-white transition"
                                placeholder="Á§æÂÜÖ„É°„É¢„ÄÅÈù¢Ë´áË®òÈå≤„ÄÅÂÖ±Êúâ‰∫ãÈ†Ö„Å™„Å©"></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 pt-4 border-t">
                        <button type="button" onclick="closeAdminUserModal()"
                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            „Ç≠„É£„É≥„Çª„É´
                        </button>
                        <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                            ‰øùÂ≠ò
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Admin: Data Merge Modal -->
        <div id="data-merge-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
            style="z-index: 40000;">
            <div class="bg-white rounded-lg w-full max-w-4xl p-6 max-h-[90vh] overflow-hidden flex flex-col">
                <div class="flex justify-between items-center mb-4 pb-4 border-b">
                    <div>
                        <h3 class="text-xl font-bold text-gray-900">„Éá„Éº„Çø„ÅÆÁµ±Âêà („Éû„Éº„Ç∏)</h3>
                        <p class="text-xs text-gray-500 mt-1">
                            Áµ±Âêà„Åô„Çã„Å®„ÄÅÈÅ∏Êäû„Åï„Çå„Å™„Åã„Å£„ÅüÊñπ„ÅÆ„É¨„Ç≥„Éº„Éâ„ÅØÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇÈñ¢ÈÄ£„Åô„Çã„Éá„Éº„ÇøÔºàÊ±Ç‰∫∫„ÄÅÂøúÂãü„Å™„Å©Ôºâ„ÅØÁµ±ÂêàÂÖà„Å´Âºï„ÅçÁ∂ô„Åå„Çå„Åæ„Åô„ÄÇ</p>
                    </div>
                    <button onclick="closeDataMergeModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto px-1">
                    <table class="min-w-full border-collapse">
                        <thead class="sticky top-0 bg-gray-50 z-10">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase border-b">
                                    È†ÖÁõÆ</th>
                                <th
                                    class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase border-b w-[40%]">
                                    <div class="flex items-center justify-between">
                                        <span>„É¨„Ç≥„Éº„Éâ A (Áµ±ÂêàÂÖà)</span>
                                        <button onclick="selectAllMerge('A')"
                                            class="text-[10px] text-indigo-600 hover:underline">ÂÖ®ÈÅ∏Êäû</button>
                                    </div>
                                </th>
                                <th
                                    class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase border-b w-[40%]">
                                    <div class="flex items-center justify-between">
                                        <span>„É¨„Ç≥„Éº„Éâ B (Áµ±ÂêàÂÖÉ: ÂâäÈô§ÂØæË±°)</span>
                                        <button onclick="selectAllMerge('B')"
                                            class="text-[10px] text-indigo-600 hover:underline">ÂÖ®ÈÅ∏Êäû</button>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="merge-fields-container" class="divide-y divide-gray-100">
                            <!-- Fields injected by JS -->
                        </tbody>
                    </table>
                </div>

                <div class="mt-6 pt-4 border-t flex justify-between items-center bg-gray-50 p-4 rounded-lg">
                    <div class="text-sm text-amber-700">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        Áµ±ÂêàÂÆüË°åÂæå„ÄÅB„ÅÆ„É¨„Ç≥„Éº„Éâ„ÅØ<strong>ÂÆåÂÖ®„Å´ÂâäÈô§</strong>„Åï„Çå„Åæ„Åô„ÄÇ
                    </div>
                    <div class="flex gap-3">
                        <button onclick="closeDataMergeModal()"
                            class="px-4 py-2 border rounded-lg hover:bg-white transition">„Ç≠„É£„É≥„Çª„É´</button>
                        <button onclick="executeMerge()"
                            class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 shadow-lg">
                            <i class="fas fa-compress-alt mr-2"></i>Áµ±Âêà„ÇíÂÆüË°å„Åô„Çã
                        </button>
                    </div>
                </div>
            </div>
        </div>



        <!-- Admin: Job CSV Import Modal -->
        <div id="admin-job-csv-modal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
            style="z-index: 100000;">
            <div class="bg-white rounded-lg w-full max-w-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Ê±Ç‰∫∫CSV„Ç§„É≥„Éù„Éº„Éà</h3>
                    <button onclick="closeJobCsvImportModal()"
                        class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg text-sm text-blue-800">
                        <p class="font-bold mb-2">CSV„Éï„Ç©„Éº„Éû„ÉÉ„Éà„Å´„Å§„ÅÑ„Å¶</p>
                        <p>‰ª•‰∏ã„ÅÆ„Ç´„É©„É†„ÇíÊåÅ„Å§CSV„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö</p>
                        <ul class="list-disc list-inside ml-2 mt-1">
                            <li>title (ÂøÖÈ†à): Ê±Ç‰∫∫„Çø„Ç§„Éà„É´</li>
                            <li>company (ÂøÖÈ†à): ‰ºöÁ§æÂêç</li>
                            <li>salary_min (ÂøÖÈ†à): ÊúÄ‰ΩéÂπ¥Âèé(Êï∞ÂÄ§)</li>
                            <li>salary_max (ÂøÖÈ†à): ÊúÄÈ´òÂπ¥Âèé(Êï∞ÂÄ§)</li>
                            <li>location (ÂøÖÈ†à): Âã§ÂãôÂú∞</li>
                            <li>description: ‰ªï‰∫ãÂÜÖÂÆπ</li>
                        </ul>
                        <div class="mt-3">
                            <a href="#" onclick="downloadJobCsvTemplate(event)" class="text-blue-600 hover:underline">
                                <i class="fas fa-download mr-1"></i>„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                            </a>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">CSV„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</label>
                        <input type="file" id="job-csv-file" accept=".csv" class="w-full border rounded-lg p-2">
                    </div>

                    <div id="job-csv-preview" class="hidden max-h-40 overflow-y-auto border rounded p-2 text-xs">
                        <!-- „Éó„É¨„Éì„É•„ÉºË°®Á§∫„Ç®„É™„Ç¢ -->
                    </div>

                    <div class="flex justify-end gap-3 pt-4 border-t">
                        <button onclick="closeJobCsvImportModal()"
                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            „Ç≠„É£„É≥„Çª„É´
                        </button>
                        <button onclick="processJobCsvImport()"
                            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                            „Ç§„É≥„Éù„Éº„ÉàÂÆüË°å
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin: Company CSV Import Modal -->
        <div id="admin-company-csv-modal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
            style="z-index: 100000;">
            <div class="bg-white rounded-lg w-full max-w-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">‰ºÅÊ•≠CSV„Ç§„É≥„Éù„Éº„Éà</h3>
                    <button onclick="closeCompanyCsvImportModal()"
                        class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg text-sm text-blue-800">
                        <p class="font-bold mb-2">CSV„Éï„Ç©„Éº„Éû„ÉÉ„Éà„Å´„Å§„ÅÑ„Å¶</p>
                        <p>‰ª•‰∏ã„ÅÆ„Ç´„É©„É†„ÇíÊåÅ„Å§CSV„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö</p>
                        <ul class="list-disc list-inside ml-2 mt-1">
                            <li>name (ÂøÖÈ†à): ‰ºÅÊ•≠Âêç</li>
                            <li>industry (‰ªªÊÑè): Ê•≠Áïå</li>
                            <li>location (‰ªªÊÑè): ÊâÄÂú®Âú∞</li>
                            <li>website (‰ªªÊÑè): Web„Çµ„Ç§„ÉàURL</li>
                            <li>description (‰ªªÊÑè): ‰ºÅÊ•≠Ë™¨Êòé</li>
                        </ul>
                        <div class="mt-3">
                            <a href="#" onclick="downloadCompanyCsvTemplate(event)"
                                class="text-blue-600 hover:underline">
                                <i class="fas fa-download mr-1"></i>„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                            </a>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">CSV„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</label>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">ÊñáÂ≠ó„Ç≥„Éº„Éâ</label>
                            <select id="company-csv-encoding" class="w-full border rounded-lg p-2 mb-2">
                                <option value="UTF-8">UTF-8 (Ê®ôÊ∫ñ)</option>
                                <option value="Shift_JIS">Shift-JIS (ExcelÁî®)</option>
                            </select>
                            <input type="file" id="company-csv-file" accept=".csv" class="w-full border rounded-lg p-2">
                        </div>
                    </div>

                    <div id="company-csv-preview" class="hidden max-h-40 overflow-y-auto border rounded p-2 text-xs">
                        <!-- „Éó„É¨„Éì„É•„ÉºË°®Á§∫„Ç®„É™„Ç¢ -->
                    </div>

                    <div class="flex justify-end gap-3 pt-4 border-t">
                        <button onclick="closeCompanyCsvImportModal()"
                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            „Ç≠„É£„É≥„Çª„É´
                        </button>
                        <button onclick="processCompanyCsvImport()"
                            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                            „Ç§„É≥„Éù„Éº„ÉàÂÆüË°å
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin: Drive Import Modal -->
        <div id="drive-import-modal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
            style="z-index: 100000;">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] flex flex-col">
                <div class="p-6 border-b flex justify-between items-center bg-blue-600 text-white rounded-t-lg">
                    <h3 class="text-xl font-bold flex items-center gap-2">
                        <i class="fab fa-google-drive"></i> Google„Éâ„É©„Ç§„ÉñÊ±Ç‰∫∫ÂèñÂæó
                    </h3>
                    <button onclick="closeDriveImportModal()" class="text-white hover:text-blue-100">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <div class="p-6 overflow-y-auto flex-1 bg-gray-50">
                    <!-- Filters -->
                    <div class="bg-white p-4 rounded-lg shadow-sm mb-4 border border-gray-200">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">„Ç≠„Éº„ÉØ„Éº„ÉâÊ§úÁ¥¢</label>
                                <div class="relative">
                                    <input type="text" id="drive-filter-search" placeholder="„Éï„Ç°„Ç§„É´Âêç„ÅßÊ§úÁ¥¢..."
                                        class="w-full pl-9 pr-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                                        oninput="applyDriveFileFilters()">
                                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Êõ¥Êñ∞Êó•Ôºà„Åã„ÇâÔºâ</label>
                                <input type="date" id="drive-filter-date-from"
                                    class="w-full px-3 py-2 border rounded-lg text-sm outline-none"
                                    onchange="applyDriveFileFilters()">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">‰∏¶„Å≥Êõø„Åà</label>
                                <select id="drive-filter-sort"
                                    class="w-full px-3 py-2 border rounded-lg text-sm outline-none bg-white"
                                    onchange="applyDriveFileFilters()">
                                    <option value="newest">Êõ¥Êñ∞Êó•„ÅåÊñ∞„Åó„ÅÑÈ†Ü</option>
                                    <option value="oldest">Êõ¥Êñ∞Êó•„ÅåÂè§„ÅÑÈ†Ü</option>
                                    <option value="name">ÂêçÂâçÈ†Ü</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="drive-import-status"
                        class="mb-4 p-4 bg-blue-50 text-blue-700 rounded-lg flex items-center gap-3 border border-blue-100">
                        <i class="fas fa-info-circle"></i>
                        <p class="text-sm">Google„Éâ„É©„Ç§„Éñ„Åã„ÇâÊúÄÊñ∞„ÅÆPDF„Éï„Ç°„Ç§„É´„ÇíÂèñÂæó„Åó„Å¶„ÅÑ„Åæ„Åô...</p>
                    </div>

                    <!-- Select All & Count -->
                    <div class="flex justify-between items-center mb-3 px-1">
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <input type="checkbox" id="drive-file-select-all"
                                class="h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500 transition"
                                onchange="toggleDriveAllCheckboxes(this.checked)">
                            <span class="text-sm font-bold text-gray-700 group-hover:text-blue-600 transition">„Åô„Åπ„Å¶ÈÅ∏Êäû
                                / Ëß£Èô§</span>
                        </label>
                        <div id="drive-file-list-count"
                            class="text-xs font-bold text-gray-400 uppercase tracking-wider">
                            0‰ª∂„ÅÆ„Éï„Ç°„Ç§„É´
                        </div>
                    </div>

                    <div id="drive-file-list" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <!-- File list will be rendered here -->
                    </div>
                </div>

                <div class="p-4 border-t bg-white flex justify-between items-center rounded-b-lg">
                    <div id="drive-import-count"
                        class="text-sm font-bold text-gray-600 bg-gray-100 px-3 py-1 rounded-full">
                        0‰ª∂ÈÅ∏Êäû
                    </div>
                    <div class="flex gap-3">
                        <button onclick="closeDriveImportModal()"
                            class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium">„Ç≠„É£„É≥„Çª„É´</button>
                        <button id="execute-drive-import-btn" onclick="executeDriveImport()" disabled
                            class="bg-blue-600 text-white px-8 py-2 rounded-lg font-bold hover:bg-blue-700 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 transition-all active:scale-95">
                            <i class="fas fa-download"></i> „Ç§„É≥„Éù„Éº„Éà„ÇíÈñãÂßã
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Coach: My Students Page -->
        <div id="coach-students-content" class="app-content p-6 hidden">
            <div class="flex justify-between items-center mb-6">
                <!-- Title removed -->
            </div>

            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    „É¶„Éº„Ç∂„Éº</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ÁôªÈå≤Êó•</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ÈÄ≤ÊçóÁä∂Ê≥Å</th>
                                <th
                                    class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="coach-students-container" class="bg-white divide-y divide-gray-200">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


        <!-- ÂÄôË£úËÄÖ„Éó„É¨„Éì„É•„Éº„É¢„Éº„ÉÄ„É´ -->
        <div id="candidate-preview-modal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
            style="z-index: 30000;">
            <div
                class="bg-white rounded-2xl w-full max-w-7xl mx-4 h-[92vh] flex flex-col shadow-2xl overflow-hidden animate-fade-in">
                <!-- „Éò„ÉÉ„ÉÄ„Éº (Âõ∫ÂÆö) -->
                <div class="flex-none flex justify-between items-center px-8 py-5 border-b bg-white">
                    <div class="flex items-center gap-4">
                        <div id="candidate-avatar-header"
                            class="w-12 h-12 bg-indigo-600 rounded-full flex items-center justify-center text-white text-xl font-bold shadow-inner">
                            ?
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-gray-900 leading-tight flex items-center gap-3">
                                <span id="candidate-detail-title">ÂÄôË£úËÄÖË©≥Á¥∞</span>
                                <span id="candidate-header-meta"
                                    class="text-sm font-normal text-gray-500 bg-gray-100 px-3 py-1 rounded-full"></span>
                            </h3>
                            <p id="candidate-email-header" class="text-sm text-gray-500"></p>
                        </div>
                        <div id="candidate-status-badge-header" class="ml-4">
                            <!-- Status badge will be injected here -->
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="showAdminUserModal($('#interview-candidate-id').val())"
                            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 text-sm font-bold flex items-center transition-all">
                            <i class="fas fa-edit mr-2 text-gray-400"></i>ÊÉÖÂ†±„ÇíÁ∑®ÈõÜ
                        </button>
                        <button onclick="closeCandidatePreview()"
                            class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-500 transition-all">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>

                <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ (ÈõÜÁ¥ÑÁîªÈù¢) -->
                <div class="flex-1 min-h-0 bg-gray-50 flex flex-col lg:flex-row overflow-hidden">

                    <!-- Â∑¶„Ç´„É©„É†: „Éó„É≠„Éï„Ç£„Éº„É´Ë©≥Á¥∞ („Çπ„ÇØ„É≠„Éº„É´ÂèØ) -->
                    <div id="candidate-preview-content"
                        class="w-full lg:w-[42%] h-full bg-white border-r overflow-y-scroll custom-scrollbar p-8 space-y-8 pb-32">
                        <!-- Profile details will be loaded here -->
                    </div>

                    <!-- Âè≥„Ç´„É©„É†: ÁÆ°ÁêÜÊÉÖÂ†± („Çπ„ÇØ„É≠„Éº„É´ÂèØ) -->
                    <div
                        class="w-full lg:w-[58%] h-full bg-gray-50 overflow-y-scroll custom-scrollbar p-8 space-y-8 pb-32">
                        <!-- ÈÅ∏ËÄÉÈÄ≤Êçó„Çª„ÇØ„Ç∑„Éß„É≥ -->
                        <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm">
                            <div class="flex justify-between items-center mb-6">
                                <h4 class="font-bold text-lg text-gray-900 flex items-center">
                                    <i class="fas fa-tasks mr-2 text-indigo-600 bg-indigo-50 p-2 rounded-lg"></i>
                                    „Ç®„É≥„Éà„É™„Éº‰∏≠„ÅÆÊ°à‰ª∂ / ÈÅ∏ËÄÉÁä∂Ê≥Å
                                </h4>
                            </div>
                            <div id="selection-progress-container" class="space-y-4">
                                <!-- Selection list will be rendered here -->
                            </div>
                        </div>

                        <!-- Èù¢Ë´áÂ±•Ê≠¥„Çª„ÇØ„Ç∑„Éß„É≥ -->
                        <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm flex flex-col">
                            <div class="flex justify-between items-center mb-6">
                                <h4 class="font-bold text-lg text-gray-900 flex items-center">
                                    <i class="fas fa-comments mr-2 text-blue-600 bg-blue-50 p-2 rounded-lg"></i>
                                    Èù¢Ë´áÂ±•Ê≠¥„ÉªÂØæÂøú„É°„É¢
                                </h4>
                                <button onclick="openInterviewRecordModal()"
                                    class="bg-indigo-600 text-white px-5 py-2.5 rounded-xl hover:bg-indigo-700 text-sm font-bold flex items-center transition-all shadow-md transform hover:-translate-y-0.5">
                                    <i class="fas fa-plus mr-2"></i>Â±•Ê≠¥„ÇíË®òÈå≤
                                </button>
                            </div>
                            <div id="interview-list-container" class="space-y-4">
                                <!-- Interviews will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Èù¢Ë´áÂ±•Ê≠¥Ë®òÈå≤„É¢„Éº„ÉÄ„É´ -->
        <div id="interview-record-modal"
            class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden"
            style="z-index: 31000;">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 animate-fade-in-up">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h3 class="text-xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-clipboard-list text-indigo-600 mr-2"></i>Èù¢Ë´áÂ±•Ê≠¥„Çí‰øùÂ≠ò
                    </h3>
                    <button onclick="closeInterviewRecordModal()"
                        class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <form id="interview-record-form" class="space-y-5">
                    <input type="hidden" id="interview-candidate-id">
                    <input type="hidden" id="interview-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">ÂÆüÊñΩÊó•</label>
                            <input type="date" id="interview-date"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 transition-all"
                                required>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Èù¢Ë´áÁ®ÆÂà•</label>
                            <select id="interview-type"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 transition-all">
                                <option value="ÂàùÂõûÈù¢Ë´á">ÂàùÂõûÈù¢Ë´á</option>
                                <option value="„Éï„Ç©„É≠„ÉºÈù¢Ë´á">„Éï„Ç©„É≠„ÉºÈù¢Ë´á</option>
                                <option value="„Ç´„Ç∏„É•„Ç¢„É´Èù¢Ë´á">„Ç´„Ç∏„É•„Ç¢„É´Èù¢Ë´á</option>
                                <option value="Ê®°Êì¨Èù¢Êé•">Ê®°Êì¨Èù¢Êé•</option>
                                <option value="ÈõªË©±ÈÄ£Áµ°">ÈõªË©±ÈÄ£Áµ°</option>
                                <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">ÂÜÖÂÆπ„Éª„É°„É¢</label>
                        <textarea id="interview-content" rows="8"
                            class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 transition-all text-sm leading-relaxed"
                            placeholder="Ë©±„Åó„ÅüÂÜÖÂÆπ„ÄÅÂç∞Ë±°„ÄÅÊá∏ÂøµÁÇπ„Å™„Å©„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" required></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">„Éç„ÇØ„Çπ„Éà„Ç¢„ÇØ„Ç∑„Éß„É≥</label>
                        <input type="text" id="interview-next-action"
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 transition-all text-sm"
                            placeholder="‰æã: „Äá„ÄáÁ§æ„ÅÆÊ±Ç‰∫∫„ÇíÊ°àÂÜÖ„Åô„Çã„ÄÅÊù•ÈÄ±ÊúàÊõúÊó•„Å´ÈÄ≤ÊçóÁ¢∫Ë™ç„Å™„Å©">
                    </div>
                    <div class="flex justify-end gap-3 pt-4 border-t">
                        <button type="button" onclick="closeInterviewRecordModal()"
                            class="px-6 py-2 border rounded-lg hover:bg-gray-50 transition-all text-sm font-bold text-gray-600">
                            „Ç≠„É£„É≥„Çª„É´
                        </button>
                        <button type="submit"
                            class="bg-indigo-600 text-white px-8 py-2 rounded-lg hover:bg-indigo-700 transition-all text-sm font-bold shadow-md transform hover:-translate-y-0.5">
                            Â±•Ê≠¥„Çí‰øùÂ≠ò„Åô„Çã
                        </button>
                    </div>
                </form>
            </div>
        </div>


    </div>
    </div>

    <!-- Ê±Ç‰∫∫ÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ -->
    <div id="job-selection-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
        style="z-index: 11000;">
        <div class="bg-white rounded-lg w-full max-w-2xl p-6 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-search-plus text-indigo-600 mr-2"></i>„Çπ„Ç´„Ç¶„ÉàÊ±Ç‰∫∫„ÇíÈÅ∏Êäû
                </h3>
                <button onclick="closeJobSelectorForScout()"
                    class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-4 space-y-3">
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">‰ºÅÊ•≠Âêç</label>
                    <input type="text" id="selector-search-company"
                        class="w-full border border-gray-300 rounded px-3 py-2 text-sm" placeholder="‰ºÅÊ•≠Âêç„ÅßÊ§úÁ¥¢...">
                </div>
                <div class="flex gap-4">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-600 mb-1">Âã§ÂãôÂú∞ÔºàÈÉΩÈÅìÂ∫úÁúåÔºâ</label>
                        <select id="selector-search-prefecture"
                            class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
                            <option value="">ÊåáÂÆö„Å™„Åó</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-600 mb-1">ËÅ∑ÂãôÂÜÖÂÆπ„ÉªËÅ∑Á®Æ</label>
                        <input type="text" id="selector-search-keyword"
                            class="w-full border border-gray-300 rounded px-3 py-2 text-sm" placeholder="„Ç≠„Éº„ÉØ„Éº„Éâ...">
                    </div>
                </div>
                <div class="text-right">
                    <button onclick="searchJobsForScout()"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded shadow transition">
                        <i class="fas fa-search mr-2"></i>Ê§úÁ¥¢
                    </button>
                </div>
            </div>

            <div id="selector-job-results" class="flex-1 overflow-y-auto space-y-2 border-t pt-4">
                <div class="text-center py-8 text-gray-400">
                    Ê§úÁ¥¢Êù°‰ª∂„ÇíÂÖ•Âäõ„Åó„Å¶Ê§úÁ¥¢„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                </div>
            </div>
        </div>
    </div>

    <!-- Â§ñÈÉ®„Éó„É≠„Éï„Ç£„Éº„É´Ëß£Êûê„É¢„Éº„ÉÄ„É´ -->
    <!-- Admin: AI Prompts -->
    <div id="admin-prompts-content" class="app-content p-2 hidden">
        <div class="max-w-full mx-auto">
            <div class="flex justify-between items-center mb-2 px-2">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">AI„Éó„É≠„É≥„Éó„ÉàË®≠ÂÆö</h2>
                </div>
                <button onclick="savePrompts()"
                    class="bg-indigo-600 text-white px-4 py-1.5 rounded hover:bg-indigo-700 shadow-sm transition-all flex items-center text-sm font-medium">
                    <i class="fas fa-save mr-1.5"></i>‰øùÂ≠ò
                </button>
            </div>

            <!-- ‚ë† „Çπ„Ç≥„Ç¢„É™„É≥„Ç∞ -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 mb-3">
                <div class="mb-2 border-b border-gray-100 pb-2 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span
                            class="bg-indigo-50 text-indigo-700 px-2 py-0.5 rounded text-xs font-bold border border-indigo-100">ÂàÜÊûê</span>
                        <h3 class="text-base font-bold text-gray-800">„Éû„ÉÉ„ÉÅ„É≥„Ç∞„Çπ„Ç≥„Ç¢„É™„É≥„Ç∞</h3>
                        <span class="text-xs text-gray-500">„Éû„ÉÉ„ÉÅ„É≥„Ç∞Ë©≥Á¥∞ÂàÜÊûê„Éª„Çπ„Ç≥„Ç¢ÁÆóÂá∫Áî®</span>
                    </div>
                </div>
                <textarea id="prompt-scoring"
                    class="w-full h-64 px-3 py-2 bg-gray-50 border border-gray-200 rounded font-mono text-xs text-gray-800 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all leading-relaxed resize-y"
                    placeholder="„Éó„É≠„É≥„Éó„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."></textarea>
            </div>

            <!-- ‚ë° Á¥π‰ªãÁêÜÁî± -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 mb-3">
                <div class="mb-2 border-b border-gray-100 pb-2 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span
                            class="bg-green-50 text-green-700 px-2 py-0.5 rounded text-xs font-bold border border-green-100">ÁîüÊàê</span>
                        <h3 class="text-base font-bold text-gray-800">Á¥π‰ªãÁêÜÁî±„Ç≥„É°„É≥„Éà</h3>
                        <span class="text-xs text-gray-500">Ê±ÇËÅ∑ËÄÖÂêë„ÅëÁ¥π‰ªãÁêÜÁî±Ôºà100ÊñáÂ≠óÁ®ãÂ∫¶ÔºâÁî®</span>
                    </div>
                </div>
                <textarea id="prompt-reason"
                    class="w-full h-32 px-3 py-2 bg-gray-50 border border-gray-200 rounded font-mono text-xs text-gray-800 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all leading-relaxed resize-y"
                    placeholder="„Éó„É≠„É≥„Éó„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."></textarea>
            </div>

            <!-- ‚ë¢ Êé®Ëñ¶Êñá -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 mb-3">
                <div class="mb-2 border-b border-gray-100 pb-2 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span
                            class="bg-blue-50 text-blue-700 px-2 py-0.5 rounded text-xs font-bold border border-blue-100">Êõ∏È°û</span>
                        <h3 class="text-base font-bold text-gray-800">Êé®Ëñ¶ÊñáÔºàÁ¥π‰ªãÁä∂Ôºâ</h3>
                        <span class="text-xs text-gray-500">Ê±ÇËÅ∑ËÄÖ„Å∏„ÅÆÊé®Ëñ¶ÊñáÁîüÊàêÁî®</span>
                    </div>
                </div>
                <textarea id="prompt-recommendation-letter"
                    class="w-full h-48 px-3 py-2 bg-gray-50 border border-gray-200 rounded font-mono text-xs text-gray-800 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all leading-relaxed resize-y"
                    placeholder="„Éó„É≠„É≥„Éó„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."></textarea>
            </div>

            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 mb-3">
                <div class="mb-2 border-b border-gray-100 pb-2 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span
                            class="bg-orange-50 text-orange-700 px-2 py-0.5 rounded text-xs font-bold border border-orange-100">ÈÄÅ‰ø°</span>
                        <h3 class="text-base font-bold text-gray-800">„Çπ„Ç´„Ç¶„Éà„É°„ÉÉ„Çª„Éº„Ç∏</h3>
                        <span class="text-xs text-gray-500">‰ºÅÊ•≠„Åã„ÇâÊ±ÇËÅ∑ËÄÖ„Å∏„ÅÆ„Çπ„Ç´„Ç¶„ÉàÊñáÁîüÊàêÁî®</span>
                    </div>
                </div>
                <textarea id="prompt-scout-message"
                    class="w-full h-48 px-3 py-2 bg-gray-50 border border-gray-200 rounded font-mono text-xs text-gray-800 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all leading-relaxed resize-y"
                    placeholder="„Éó„É≠„É≥„Éó„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."></textarea>
            </div>

            <!-- ‚ë§ Ê±Ç‰∫∫Ëß£Êûê (System Prompt) -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 mb-3">
                <div class="mb-2 border-b border-gray-100 pb-2 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span
                            class="bg-purple-50 text-purple-700 px-2 py-0.5 rounded text-xs font-bold border border-purple-100">Ëß£Êûê</span>
                        <h3 class="text-base font-bold text-gray-800">Ê±Ç‰∫∫Ëß£Êûê (System)</h3>
                        <span class="text-xs text-gray-500">CSV„Ç§„É≥„Éù„Éº„ÉàÊôÇ„ÅÆÊ±Ç‰∫∫ÊÉÖÂ†±Ëß£ÊûêÁî®</span>
                    </div>
                </div>
                <textarea id="prompt-job-description"
                    class="w-full h-64 px-3 py-2 bg-gray-50 border border-gray-200 rounded font-mono text-xs text-gray-800 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all leading-relaxed resize-y"
                    placeholder="Ëß£Êûê„É≠„Ç∏„ÉÉ„ÇØÔºàJSONÂÆöÁæ©„Å™„Å©Ôºâ..."></textarea>
            </div>

            <!-- ‚ë• CSV„Éû„ÉÉ„Éî„É≥„Ç∞ (System Prompt) -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 mb-3">
                <div class="mb-2 border-b border-gray-100 pb-2 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span
                            class="bg-purple-50 text-purple-700 px-2 py-0.5 rounded text-xs font-bold border border-purple-100">Ëß£Êûê</span>
                        <h3 class="text-base font-bold text-gray-800">CSV„Éû„ÉÉ„Éî„É≥„Ç∞ (System)</h3>
                        <span class="text-xs text-gray-500">CSV„Éò„ÉÉ„ÉÄ„Éº„ÅÆËá™Âãï„Éû„ÉÉ„ÉóÁî®</span>
                    </div>
                </div>
                <textarea id="prompt-csv-mapping"
                    class="w-full h-48 px-3 py-2 bg-gray-50 border border-gray-200 rounded font-mono text-xs text-gray-800 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all leading-relaxed resize-y"
                    placeholder="„Éû„ÉÉ„Éî„É≥„Ç∞„É≠„Ç∏„ÉÉ„ÇØ..."></textarea>
            </div>

            <!-- ‚ë¶ Â§ñÈÉ®„Éó„É≠„Éï„Ç£„Éº„É´Ëß£Êûê (System Prompt) -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 mb-3">
                <div class="mb-2 border-b border-gray-100 pb-2 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span
                            class="bg-purple-50 text-purple-700 px-2 py-0.5 rounded text-xs font-bold border border-purple-100">Ëß£Êûê</span>
                        <h3 class="text-base font-bold text-gray-800">Â§ñÈÉ®„Éó„É≠„Éï„Ç£„Éº„É´Ëß£Êûê (System)</h3>
                        <span class="text-xs text-gray-500">PDF/ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊôÇ„ÅÆËß£ÊûêÁî®</span>
                    </div>
                </div>
                <textarea id="prompt-external-profile-analysis"
                    class="w-full h-80 px-3 py-2 bg-gray-50 border border-gray-200 rounded font-mono text-xs text-gray-800 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all leading-relaxed resize-y"
                    placeholder="Ëß£Êûê„Éó„É≠„É≥„Éó„Éà..."></textarea>
            </div>
        </div>
    </div>

    <!-- Admin: FAQ & Inquiry Management -->
    <div id="admin-faqs-content" class="app-content p-6 hidden">
        <div class="max-w-6xl mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h2 class="text-3xl font-extrabold text-slate-800 tracking-tight">FAQ„Éª„Éû„Éã„É•„Ç¢„É´ÁÆ°ÁêÜ</h2>
                    <p class="text-slate-500 mt-1">„Éò„É´„Éó„Çª„É≥„Çø„Éº„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑÁÆ°ÁêÜ„Å®Âïè„ÅÑÂêà„Çè„ÅõÂØæÂøú</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="showFAQForm()"
                        class="bg-indigo-600 text-white px-6 py-2.5 rounded-xl hover:bg-indigo-700 transition-all flex items-center gap-2 text-sm font-bold shadow-lg shadow-indigo-100">
                        <i class="fas fa-plus"></i> Êñ∞Ë¶èFAQ‰ΩúÊàê
                    </button>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-slate-200 mb-8 overflow-x-auto no-scrollbar">
                <button onclick="switchAdminFAQTab('list')" id="admin-faq-tab-list"
                    class="admin-faq-tab px-6 py-3 border-b-2 border-indigo-600 text-indigo-600 font-bold text-sm whitespace-nowrap">
                    FAQ„É™„Çπ„Éà
                </button>
                <button onclick="switchAdminFAQTab('logs')" id="admin-faq-tab-logs"
                    class="admin-faq-tab px-6 py-3 border-b-2 border-transparent text-slate-500 font-bold text-sm hover:text-slate-700 whitespace-nowrap">
                    Âïè„ÅÑÂêà„Çè„Åõ„É≠„Ç∞
                    <span id="unread-inquiry-count"
                        class="hidden ml-2 bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full">0</span>
                </button>
            </div>

            <!-- FAQ List View -->
            <div id="admin-faq-list-view" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="md:col-span-3 h-12 relative">
                        <input type="text" id="admin-faq-search" onkeyup="filterAdminFAQTable()"
                            placeholder="Ë≥™ÂïèÂÜÖÂÆπ„ÇÑ„Ç≠„Éº„ÉØ„Éº„Éâ„ÅßÊ§úÁ¥¢..."
                            class="w-full h-full pl-12 pr-4 bg-white border border-slate-200 rounded-xl focus:ring-4 focus:ring-indigo-50 leading-none outline-none transition-all">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    </div>
                    <select id="admin-faq-filter-category" onchange="filterAdminFAQTable()"
                        class="h-12 px-4 bg-white border border-slate-200 rounded-xl focus:ring-4 focus:ring-indigo-50 outline-none transition-all font-bold text-slate-600">
                        <option value="all">„Åô„Åπ„Å¶„ÅÆ„Ç´„ÉÜ„Ç¥„É™</option>
                        <option value="start">Â∞éÂÖ•„ÉªÂü∫Êú¨Ë®≠ÂÆö</option>
                        <option value="ai">AI„Éû„ÉÉ„ÉÅ„É≥„Ç∞</option>
                        <option value="manage">Ê±Ç‰∫∫„ÉªÈÄ≤ÊçóÁÆ°ÁêÜ</option>
                        <option value="trouble">„Éà„É©„Éñ„É´Ëß£Ê±∫</option>
                    </select>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th
                                    class="px-6 py-4 text-left text-[11px] font-bold text-slate-400 uppercase tracking-wider">
                                    „Ç´„ÉÜ„Ç¥„É™</th>
                                <th
                                    class="px-6 py-4 text-left text-[11px] font-bold text-slate-400 uppercase tracking-wider">
                                    Ë≥™Âïè / ÂõûÁ≠îÊ¶ÇË¶Å</th>
                                <th
                                    class="px-6 py-4 text-center text-[11px] font-bold text-slate-400 uppercase tracking-wider">
                                    Ë°®Á§∫Ë®≠ÂÆö</th>
                                <th
                                    class="px-6 py-4 text-right text-[11px] font-bold text-slate-400 uppercase tracking-wider">
                                    Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="admin-faq-table-body" class="divide-y divide-slate-100">
                            <!-- Loading State -->
                            <tr>
                                <td colspan="4" class="px-6 py-12 text-center">
                                    <div class="flex flex-col items-center gap-3">
                                        <div
                                            class="w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin">
                                        </div>
                                        <p class="text-sm text-slate-400 font-medium">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Inquiry Logs View -->
            <div id="admin-inquiry-logs-view" class="hidden">
                <div class="bg-indigo-50 p-6 rounded-2xl border border-indigo-100 mb-8">
                    <h3 class="text-indigo-900 font-bold mb-2 flex items-center gap-2">
                        <i class="fas fa-lightbulb text-indigo-500"></i> „Éä„É¨„ÉÉ„Ç∏ËìÑÁ©ç„ÅÆ„Éí„É≥„Éà
                    </h3>
                    <p class="text-indigo-700 text-sm leading-relaxed">
                        „É¶„Éº„Ç∂„Éº„ÅåAI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Å´Â∞ã„Å≠„ÅüË≥™Âïè„Åå„Åì„Åì„Å´ËìÑÁ©ç„Åï„Çå„Åæ„Åô„ÄÇ
                        AI„ÅßËß£Ê±∫„Åó„Åç„Çå„Å™„Åã„Å£„ÅüË≥™Âïè„ÇÑ„ÄÅÈ†ªÂá∫„Åô„ÇãË≥™Âïè„Çí„ÄåFAQ„Å´ËøΩÂä†„Äç„Éú„Çø„É≥„ÅßÁ∞°Âçò„Å´„Éä„É¨„ÉÉ„Ç∏Âåñ„Åß„Åç„Åæ„Åô„ÄÇ„Åì„Çå„Å´„Çà„Çä„ÄÅÊ¨°Âõû„ÅÆAIÂõûÁ≠îÁ≤æÂ∫¶„ÅåÂêë‰∏ä„Åó„Åæ„Åô„ÄÇ
                    </p>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th
                                    class="px-6 py-4 text-left text-[11px] font-bold text-slate-400 uppercase tracking-wider">
                                    Êó•ÊôÇ</th>
                                <th
                                    class="px-6 py-4 text-left text-[11px] font-bold text-slate-400 uppercase tracking-wider">
                                    „É¶„Éº„Ç∂„Éº</th>
                                <th
                                    class="px-6 py-4 text-left text-[11px] font-bold text-slate-400 uppercase tracking-wider">
                                    Áõ∏Ë´áÂÜÖÂÆπ</th>
                                <th
                                    class="px-6 py-4 text-center text-[11px] font-bold text-slate-400 uppercase tracking-wider">
                                    Áä∂ÊÖã</th>
                                <th
                                    class="px-6 py-4 text-right text-[11px] font-bold text-slate-400 uppercase tracking-wider">
                                    „Éä„É¨„ÉÉ„Ç∏Âåñ</th>
                            </tr>
                        </thead>
                        <tbody id="admin-inquiry-table-body" class="divide-y divide-slate-100">
                            <!-- Will be populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin: Company Management Page -->
    <div id="admin-companies-content" class="app-content p-6 hidden">
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">‰ºÅÊ•≠ÁÆ°ÁêÜ</h2>
                    <p class="text-gray-600 text-sm mt-1">ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Çã‰ºÅÊ•≠„ÅÆ‰∏ÄË¶ß„Å®ÁÆ°ÁêÜ</p>
                </div>
                <div class="flex gap-2">
                    <button id="bulk-delete-companies" onclick="bulkDeleteCompanies()"
                        class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 hidden">
                        <i class="fas fa-trash-alt mr-2"></i>‰∏ÄÊã¨ÂâäÈô§ (<span id="selected-companies-count">0</span>)
                    </button>
                    <button onclick="showCompanyCsvImportModal()"
                        class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                        <i class="fas fa-file-csv mr-2"></i>CSV„Ç§„É≥„Éù„Éº„Éà
                    </button>
                    <button onclick="showCompanyForm()"
                        class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                        <i class="fas fa-plus mr-2"></i>Êñ∞Ë¶è‰ºÅÊ•≠ÁôªÈå≤
                    </button>
                </div>
            </div>
            <div class="mb-4">
                <input type="text" id="company-search" placeholder="‰ºÅÊ•≠Âêç„ÄÅÊ•≠Áïå„ÄÅÊâÄÂú®Âú∞„ÅßÊ§úÁ¥¢..."
                    class="w-full px-4 py-2 border rounded-lg" onkeyup="filterCompanies()">
            </div>
        </div>
        <div class="bg-white rounded-lg shadow overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200" id="companies-table">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left w-10">
                            <input type="checkbox" id="select-all-companies" onchange="toggleAllCompanies(this)"
                                class="rounded text-indigo-600 focus:ring-indigo-500">
                        </th>
                        <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[200px]">
                            ‰ºÅÊ•≠Âêç</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Ê•≠Áïå</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            ÊâÄÂú®Âú∞</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Web„Çµ„Ç§„Éà</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Êìç‰Ωú</th>
                    </tr>
                </thead>
                <tbody id="companies-container" class="bg-white divide-y divide-gray-200">
                    <!-- Companies will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
    </main>
    </div>

    <!-- Company Form Modal -->
    <div id="company-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 id="company-modal-title" class="text-xl font-bold">‰ºÅÊ•≠ÁôªÈå≤</h2>
                <button onclick="closeCompanyModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <form id="company-form" onsubmit="handleCompanySubmit(event)">
                    <input type="hidden" id="company-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">‰ºöÁ§æÂêç <span
                                    class="text-red-500">*</span></label>
                            <input type="text" id="company-name" required class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ê•≠Áïå</label>
                            <select id="company-industry" class="w-full border rounded-lg px-3 py-2">
                                <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÊâÄÂú®Âú∞</label>
                            <input type="text" id="company-location" class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Web„Çµ„Ç§„ÉàURL</label>
                            <input type="url" id="company-website" class="w-full border rounded-lg px-3 py-2"
                                placeholder="https://...">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">‰ºöÁ§æÊ¶ÇË¶Å</label>
                            <textarea id="company-description" rows="4"
                                class="w-full border rounded-lg px-3 py-2"></textarea>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="closeCompanyModal()"
                            class="px-4 py-2 border rounded-lg hover:bg-gray-50">„Ç≠„É£„É≥„Çª„É´</button>
                        <button type="submit"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">‰øùÂ≠ò</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Master Data Modal -->
    <div id="master-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 id="master-modal-title" class="text-xl font-bold">„Éû„Çπ„Çø„Éá„Éº„Çø‰ΩúÊàê</h2>
                <button onclick="closeMasterModal()"
                    class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="master-form" class="p-6 space-y-4">
                <input type="hidden" id="master-id">
                <input type="hidden" id="master-organization-id">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Á®ÆÂà• *</label>
                    <select id="master-type" required class="w-full px-4 py-2 border rounded-lg">
                        <option value="employment_type">ÈõáÁî®ÂΩ¢ÊÖã</option>
                        <option value="job_category">ËÅ∑Á®Æ„Ç´„ÉÜ„Ç¥„É™</option>
                        <option value="industry_category">Ê•≠Á®Æ„Ç´„ÉÜ„Ç¥„É™</option>
                        <option value="selection_status">ÈÄ≤Êçó„Çπ„ÉÜ„Éº„Çø„Çπ</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ë°®Á§∫Âêç (Label) *</label>
                    <input type="text" id="master-label" required class="w-full px-4 py-2 border rounded-lg">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‰øùÂ≠òÂÄ§ (Value) *</label>
                    <input type="text" id="master-value" required class="w-full px-4 py-2 border rounded-lg">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ë°®Á§∫È†Ü</label>
                    <input type="number" id="master-sort" value="0" class="w-full px-4 py-2 border rounded-lg">
                </div>

                <div class="flex items-center gap-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="master-is-active" class="w-4 h-4 text-indigo-600 rounded" checked>
                        <span class="text-sm text-gray-700">ÊúâÂäπ„Å´„Åô„Çã</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer" id="master-is-global-container">
                        <input type="checkbox" id="master-is-global" class="w-4 h-4 text-indigo-600 rounded">
                        <span class="text-sm text-gray-700">„Ç∞„É≠„Éº„Éê„É´Ë®≠ÂÆö</span>
                    </label>
                </div>

                <div class="flex justify-end gap-3 pt-4 border-t">
                    <button type="button" onclick="closeMasterModal()"
                        class="px-6 py-2 border rounded-lg hover:bg-gray-50">
                        „Ç≠„É£„É≥„Çª„É´
                    </button>
                    <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">
                        ‰øùÂ≠ò
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Status Update Modal -->
    <div id="bulk-status-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] hidden">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 overflow-hidden">
            <div class="p-4 border-b bg-indigo-50 flex justify-between items-center">
                <h3 class="font-bold text-indigo-900">„Çπ„ÉÜ„Éº„Çø„Çπ‰∏ÄÊã¨Â§âÊõ¥</h3>
                <button onclick="closeBulkStatusModal()" class="text-gray-400 hover:text-gray-600"><i
                        class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <p class="text-sm text-gray-600 mb-4 font-bold" id="bulk-status-target-count">0‰ª∂„ÅÆÂøúÂãü„ÇíÈÅ∏Êäû‰∏≠</p>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">‰∏ÄÊã¨ÈÅ©Áî®„Åô„Çã„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                        <select id="bulk-new-status"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg font-bold focus:ring-2 focus:ring-indigo-500 outline-none">
                            <!-- Options populated JS -->
                        </select>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-end gap-3">
                <button onclick="closeBulkStatusModal()"
                    class="px-4 py-2 text-sm font-bold text-gray-600 border border-gray-300 rounded-lg hover:bg-white transition-all">„Ç≠„É£„É≥„Çª„É´</button>
                <button onclick="submitBulkStatusUpdate()"
                    class="px-6 py-2 text-sm font-bold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 shadow-md transition-all">‰∏ÄÊã¨Êõ¥Êñ∞„ÇíÂÆüË°å</button>
            </div>
        </div>
    </div>

    <!-- Progress Management Modal -->
    <div id="progress-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold">ÈÄ≤ÊçóÁÆ°ÁêÜ</h2>
                <button onclick="closeProgressModal()"
                    class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="p-6">
                <input type="hidden" id="progress-application-id">

                <!-- Application Info -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="font-semibold text-lg" id="progress-job-title"></h3>
                            <p class="text-gray-600 text-sm" id="progress-company-name"></p>
                        </div>
                        <div class="text-right">
                            <span id="progress-will-level-display"
                                class="hidden text-xs font-bold px-2 py-1 rounded bg-indigo-100 text-indigo-700"></span>
                        </div>
                    </div>
                    <p class="text-gray-600 text-sm" id="progress-user-name"></p>

                    <div id="progress-apply-details" class="mt-4 pt-4 border-t border-gray-200">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <span
                                    class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Èù¢Êé•Â∏åÊúõÊó•ÊôÇ</span>
                                <div id="progress-interview-dates"
                                    class="text-sm text-gray-700 whitespace-pre-wrap bg-white/50 p-2 rounded border border-gray-100 min-h-[40px] leading-relaxed">
                                </div>
                            </div>
                            <div>
                                <span
                                    class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">‰ºùÈÅî‰∫ãÈ†Ö</span>
                                <div id="progress-notes"
                                    class="text-sm text-gray-700 whitespace-pre-wrap bg-white/50 p-2 rounded border border-gray-100 min-h-[40px] leading-relaxed">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Update Form -->
                <div class="bg-white border rounded-lg p-4 mb-6">
                    <h4 class="font-semibold mb-3">„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞</h4>
                    <form id="progress-update-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÁèæÂú®„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                                <input type="text" id="progress-current-status" readonly
                                    class="w-full px-4 py-2 border rounded-lg bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Êñ∞„Åó„ÅÑ„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                                <select id="progress-new-status" class="w-full px-4 py-2 border rounded-lg">
                                    <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                </select>
                            </div>
                        </div>

                        <!-- Yomi/Revenue Forecasting -->
                        <div class="bg-indigo-50/50 p-4 rounded-lg border border-indigo-100 space-y-4">
                            <h5 class="text-xs font-bold text-indigo-800 uppercase tracking-wider">Â£≤‰∏ä„Éª„É®„Éü‰∫àÊ∏¨</h5>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-500 mb-1">Ë¶ãËæº„ÅøÂ£≤‰∏ä (ÂÜÜ)</label>
                                    <input type="number" id="progress-expected-revenue"
                                        class="w-full px-4 py-2 border rounded-lg text-sm" placeholder="‰æã: 1000000">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-500 mb-1">ÊàêÁ¥ÑÁ¢∫Â∫¶ (%)</label>
                                    <select id="progress-probability-rate"
                                        class="w-full px-4 py-2 border rounded-lg text-sm">
                                        <option value="0">0% (C„É®„Éü)</option>
                                        <option value="20">20% (C„É®„Éü)</option>
                                        <option value="40">40% (C„É®„Éü)</option>
                                        <option value="60">60% (B„É®„Éü)</option>
                                        <option value="80">80% (A„É®„Éü)</option>
                                        <option value="100">100% (Á¢∫ÂÆö)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-500 mb-1">ÂÖ•Á§æ‰∫àÂÆöÊó•</label>
                                    <input type="date" id="progress-expected-start-date"
                                        class="w-full px-4 py-2 border rounded-lg text-sm">
                                </div>
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 mb-1">„É®„ÉüË©≥Á¥∞„É°„É¢ (ÁâπË®ò‰∫ãÈ†Ö)</label>
                                <textarea id="progress-yomi-notes" rows="2"
                                    class="w-full px-4 py-2 border rounded-lg text-sm"
                                    placeholder="Á¢∫Â∫¶„ÅÆÊ†πÊã†„ÇÑÊá∏ÂøµÁÇπ„Å™„Å©"></textarea>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ÈÄ≤Êçó„É°„É¢„Éª„Ç≥„É°„É≥„ÉàÔºàÁ§æÂÜÖÁî®Ôºâ</label>
                            <textarea id="progress-notes" rows="3" class="w-full px-4 py-2 border rounded-lg"
                                placeholder="„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥„ÅÆÁêÜÁî±„ÇÑË©≥Á¥∞„ÇíË®òÂÖ•„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"></textarea>
                        </div>

                        <div id="progress-interview-scheduled-section"
                            class="bg-orange-50 p-4 rounded-lg border border-orange-100 mb-4">
                            <label class="block text-sm font-medium text-orange-800 mb-1">
                                <i class="far fa-calendar-check mr-1"></i> Èù¢Êé•‰∫àÂÆöÊó•ÊôÇ (Á¢∫ÂÆö)
                            </label>
                            <input type="datetime-local" id="progress-interview-scheduled-at"
                                class="w-full px-4 py-2 border border-orange-200 rounded-lg text-sm focus:ring-orange-500">
                            <p class="text-[10px] text-orange-600 mt-1">‚ÄªÈù¢Êé•„ÅåÁ¢∫ÂÆö„Åó„ÅüÈöõ„Å´ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-indigo-700 mb-1">
                                <i class="fas fa-info-circle mr-1"></i>ÈÅ∏ËÄÉÊÉÖÂ†±ÔºàÊ±ÇËÅ∑ËÄÖ„Å´ÂÖ±Êúâ„Åï„Çå„Åæ„ÅôÔºâ
                            </label>
                            <textarea id="progress-selection-info" rows="4"
                                class="w-full px-4 py-2 border border-indigo-200 rounded-lg bg-indigo-50/30"
                                placeholder="Á¢∫ÂÆö„Åó„ÅüÈù¢Êé•Êó•Á®ã„ÇÑÈÅ∏ËÄÉ„ÅÆË©≥Á¥∞„Å™„Å©„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊ±ÇËÅ∑ËÄÖ„ÅÆ„Éû„Ç§„Éö„Éº„Ç∏„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ"></textarea>
                        </div>
                        <div class="flex justify-end">
                            <button type="submit"
                                class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">
                                <i class="fas fa-save mr-2"></i>‰øùÂ≠ò„Åó„Å¶Êõ¥Êñ∞
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Progress Timeline -->
                <div class="bg-white border rounded-lg p-4">
                    <h4 class="font-semibold mb-4">ÈÄ≤ÊçóÂ±•Ê≠¥</h4>
                    <div id="progress-timeline" class="space-y-4">
                        <!-- Timeline will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Job Form Modal -->
    <div id="job-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 id="job-modal-title" class="text-xl font-bold">Ê±Ç‰∫∫‰ΩúÊàê</h2>
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <input type="file" id="job-pdf-upload" accept=".pdf" multiple class="hidden"
                            onchange="handleJobPdfUpload(this)">
                        <button onclick="$('#job-pdf-upload').click()"
                            class="bg-green-600 text-white px-3 py-1.5 rounded hover:bg-green-700 text-xs flex items-center">
                            <i class="fas fa-file-pdf mr-1"></i>PDFË™≠Ëæº
                        </button>
                    </div>
                    <button onclick="closeJobModal()"
                        class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
            </div>
            <form id="job-form" class="p-6 space-y-4">
                <input type="hidden" id="job-id">
                <input type="hidden" id="job-drive-pdf-url">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ê±Ç‰∫∫„Çø„Ç§„Éà„É´ *</label>
                        <input type="text" id="job-title" required class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ê±Ç‰∫∫ÁÆ°ÁêÜID (‰ªªÊÑè)</label>
                        <input type="text" id="job-code" class="w-full px-4 py-2 border rounded-lg"
                            placeholder="‰æã: JOB-001">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">„Éï„Ç°„Ç§„É´Âêç (PDFÁ≠â)</label>
                    <input type="text" id="job-pdf-filename" class="w-full px-4 py-2 border rounded-lg bg-gray-50"
                        placeholder="PDFÂèñËæºÊôÇ„Å´Ëá™ÂãïÂÖ•Âäõ„Åï„Çå„Åæ„Åô">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‰ºöÁ§æÂêç *</label>
                    <div class="flex gap-2">
                        <select id="job-company-select"
                            class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">‰ºÅÊ•≠„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            <option value="new">+ Êñ∞Ë¶è‰ºÅÊ•≠„Çí‰ΩúÊàê</option>
                        </select>
                        <input type="hidden" id="job-company-id">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Âã§ÂãôÂú∞ *</label>
                        <input type="text" id="job-location" required class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÈõáÁî®ÂΩ¢ÊÖã *</label>
                        <select id="job-employment-type" required class="w-full px-4 py-2 border rounded-lg">
                            <option value="Ê≠£Á§æÂì°">Ê≠£Á§æÂì°</option>
                            <option value="Â•ëÁ¥ÑÁ§æÂì°">Â•ëÁ¥ÑÁ§æÂì°</option>
                            <option value="Ê¥æÈÅ£Á§æÂì°">Ê¥æÈÅ£Á§æÂì°</option>
                            <option value="Ê•≠ÂãôÂßîË®ó">Ê•≠ÂãôÂßîË®ó</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÊúÄ‰ΩéÂπ¥ÂèéÔºà‰∏áÂÜÜÔºâ</label>
                        <input type="number" id="job-salary-min" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÊúÄÈ´òÂπ¥ÂèéÔºà‰∏áÂÜÜÔºâ</label>
                        <input type="number" id="job-salary-max" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ËÅ∑Á®Æ„Ç´„ÉÜ„Ç¥„É™</label>
                        <select id="job-category" class="w-full px-4 py-2 border rounded-lg">
                            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ê•≠Áïå„Ç´„ÉÜ„Ç¥„É™</label>
                        <select id="job-industry-category" class="w-full px-4 py-2 border rounded-lg">
                            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                        </select>
                    </div>
                </div>

                <div class="flex gap-6">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="job-experience-ok" class="w-4 h-4 text-indigo-600 rounded">
                        <span class="text-sm text-gray-700">ËÅ∑Á®ÆÊú™ÁµåÈ®ìÂèØ</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="job-industry-experience-ok" class="w-4 h-4 text-indigo-600 rounded">
                        <span class="text-sm text-gray-700">Ê•≠ÁïåÊú™ÁµåÈ®ìÂèØ</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="job-is-remote" class="w-4 h-4 text-indigo-600 rounded">
                        <span class="text-sm text-gray-700">„É™„É¢„Éº„Éà„ÉØ„Éº„ÇØÂèØ</span>
                    </label>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Âã§ÂãôÊôÇÈñì</label>
                        <input type="text" id="job-work-hours" placeholder="‰æã: 9:00 - 18:00"
                            class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‰ºëÊó•‰ºëÊöá</label>
                        <input type="text" id="job-holidays" placeholder="‰æã: ÂÆåÂÖ®ÈÄ±‰ºë2Êó•Âà∂ÔºàÂúüÊó•Á•ùÔºâ"
                            class="w-full px-4 py-2 border rounded-lg">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Á¶èÂà©ÂéöÁîü</label>
                    <textarea id="job-benefits" rows="3" placeholder="‰æã: Á§æ‰ºö‰øùÈô∫ÂÆåÂÇô„ÄÅ‰∫§ÈÄöË≤ªÊîØÁµ¶"
                        class="w-full px-4 py-2 border rounded-lg"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ÈÅ∏ËÄÉ„Éï„É≠„Éº</label>
                    <textarea id="job-interview-process" rows="3" placeholder="‰æã: Êõ∏È°ûÈÅ∏ËÄÉ ‚Üí ‰∏ÄÊ¨°Èù¢Êé• ‚Üí ÊúÄÁµÇÈù¢Êé•"
                        class="w-full px-4 py-2 border rounded-lg"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ê±Ç‰∫∫URL</label>
                    <input type="url" id="job-url" placeholder="https://example.com/job/..."
                        class="w-full px-4 py-2 border rounded-lg">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÊãÖÂΩìËÄÖ1</label>
                        <select id="job-pic-user-1" class="w-full px-4 py-2 border rounded-lg">
                            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÊãÖÂΩìËÄÖ2</label>
                        <select id="job-pic-user-2" class="w-full px-4 py-2 border rounded-lg">
                            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ê±Ç‰∫∫Ë©≥Á¥∞ *</label>
                    <textarea id="job-description" required rows="6" placeholder="‰ªï‰∫ãÂÜÖÂÆπ„ÄÅÊ•≠Âãô„ÅÆË©≥Á¥∞„Å™„Å©"
                        class="w-full px-4 py-2 border rounded-lg"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ÂøÖÈ†àË¶Å‰ª∂</label>
                    <textarea id="job-requirements" rows="4" placeholder="ÂøÖÈ†à„Çπ„Ç≠„É´„ÄÅÁµåÈ®ìÂπ¥Êï∞„ÄÅË≥áÊ†º„Å™„Å©"
                        class="w-full px-4 py-2 border rounded-lg"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Â∞öÂèØË¶Å‰ª∂ÔºàÊ≠ìËøé„Çπ„Ç≠„É´Ôºâ</label>
                    <textarea id="job-welcome-requirements" rows="4" placeholder="„ÅÇ„Çã„Å®Êúõ„Åæ„Åó„ÅÑ„Çπ„Ç≠„É´„ÄÅÁµåÈ®ì„Å™„Å©"
                        class="w-full px-4 py-2 border rounded-lg"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                    <select id="job-status" class="w-full px-4 py-2 border rounded-lg">
                        <option value="active">ÂÖ¨Èñã‰∏≠</option>
                        <option value="draft">‰∏ãÊõ∏„Åç</option>
                        <option value="closed">ÂãüÈõÜÁµÇ‰∫Ü</option>
                    </select>
                </div>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeJobModal()"
                        class="px-6 py-2 border rounded-lg hover:bg-gray-50">
                        „Ç≠„É£„É≥„Çª„É´
                    </button>
                    <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">
                        ‰øùÂ≠ò
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Job Bulk Confirm Modal -->
    <div id="job-bulk-confirm-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center bg-indigo-50">
                <div>
                    <h2 class="text-xl font-bold text-indigo-900">ÈáçË§á„ÅÆÂèØËÉΩÊÄß„Åå„ÅÇ„ÇãÊ±Ç‰∫∫„ÅÆÁ¢∫Ë™ç</h2>
                    <p class="text-sm text-indigo-600 mt-1">‰ª•‰∏ã„ÅÆÊ±Ç‰∫∫„ÅØÊó¢„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÁôªÈå≤„Åô„Çã„ÇÇ„ÅÆ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                </div>
                <button onclick="closeJobBulkConfirmModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <div class="mb-4 flex justify-between items-center">
                    <label class="flex items-center cursor-pointer text-sm font-medium text-gray-700">
                        <input type="checkbox" id="job-bulk-select-all"
                            class="form-checkbox h-4 w-4 text-indigo-600 rounded mr-2"
                            onchange="toggleAllBulkJobs(this.checked)">
                        „Åô„Åπ„Å¶ÈÅ∏Êäû
                    </label>
                    <span id="job-bulk-count" class="text-sm text-gray-500">0‰ª∂ÈÅ∏Êäû‰∏≠</span>
                </div>
                <div id="job-bulk-list" class="space-y-4">
                    <!-- Dynamic List Items -->
                </div>
            </div>
            <div class="p-6 border-t bg-gray-50 flex justify-end gap-3">
                <button onclick="closeJobBulkConfirmModal()"
                    class="px-6 py-2 border rounded-lg hover:bg-gray-100 transition">
                    „Ç≠„É£„É≥„Çª„É´
                </button>
                <button onclick="executeBulkJobImport()" id="execute-bulk-import-btn"
                    class="bg-indigo-600 text-white px-8 py-2 rounded-lg hover:bg-indigo-700 transition font-bold shadow-md">
                    ÈÅ∏Êäû„Åó„ÅüÊ±Ç‰∫∫„ÇíÁôªÈå≤
                </button>
            </div>
        </div>
    </div>

    <!-- Import Result Modal -->
    <div id="import-result-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50">
                <h2 class="text-xl font-bold text-gray-800">„Ç§„É≥„Éù„Éº„ÉàÂá¶ÁêÜÁµêÊûú</h2>
                <button onclick="$('#import-result-modal').addClass('hidden')"
                    class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <div id="import-result-summary" class="mb-6">
                    <!-- Summary info like "Success: X, Failed: Y" -->
                </div>
                <div class="space-y-6">
                    <div id="import-result-success-section" class="hidden">
                        <h3 class="text-sm font-bold text-green-700 mb-2 flex items-center gap-2">
                            <i class="fas fa-check-circle"></i> ÊàêÂäü„Åó„Åü„Éï„Ç°„Ç§„É´
                        </h3>
                        <ul id="import-result-success-list"
                            class="text-sm text-gray-600 list-disc list-inside bg-green-50 p-3 rounded-lg border border-green-100 space-y-1">
                        </ul>
                    </div>
                    <div id="import-result-error-section" class="hidden">
                        <h3 class="text-sm font-bold text-red-700 mb-2 flex items-center gap-2">
                            <i class="fas fa-exclamation-circle"></i> „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åü„Éï„Ç°„Ç§„É´
                        </h3>
                        <ul id="import-result-error-list"
                            class="text-sm text-gray-600 list-disc list-inside bg-red-50 p-3 rounded-lg border border-red-100 space-y-1">
                        </ul>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-end">
                <button onclick="$('#import-result-modal').addClass('hidden')"
                    class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-bold">
                    Èñâ„Åò„Çã
                </button>
            </div>
        </div>
    </div>

    <!-- Import Progress Modal -->
    <div id="import-progress-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[200] hidden">
        <div
            class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-8 overflow-hidden relative border border-slate-100">
            <!-- Decoration -->
            <div class="absolute top-0 right-0 p-4 opacity-10">
                <i class="fas fa-rocket text-8xl text-indigo-600"></i>
            </div>

            <div class="relative">
                <h3 class="text-xl font-bold text-gray-900 mb-2" id="import-progress-title">Âá¶ÁêÜ„ÇíÂÆüË°å‰∏≠...</h3>
                <p class="text-sm text-gray-500 mb-6" id="import-progress-subtitle">„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÇíÈñâ„Åò„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ</p>

                <!-- Progress Bar -->
                <div class="mb-6">
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-sm font-bold text-indigo-600" id="import-progress-percent">0%</span>
                        <span class="text-xs text-slate-400 font-medium" id="import-progress-eta">ÊÆã„ÇäÁ¥Ñ -- ÂàÜ</span>
                    </div>
                    <div
                        class="w-full bg-slate-100 rounded-full h-3 overflow-hidden border border-slate-200 shadow-inner">
                        <div id="import-progress-bar"
                            class="bg-gradient-to-r from-indigo-500 to-purple-500 h-full transition-all duration-300 ease-out"
                            style="width: 0%"></div>
                    </div>
                </div>

                <!-- Steps List -->
                <div class="space-y-4" id="import-progress-steps">
                    <!-- Steps will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <div id="prompt-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 id="prompt-modal-title" class="text-xl font-bold">„Éó„É≠„É≥„Éó„ÉàÁ∑®ÈõÜ</h2>
                <button onclick="closePromptModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="prompt-form" class="p-6 space-y-4">
                <input type="hidden" id="prompt-id">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">„Éó„É≠„É≥„Éó„ÉàÂêç *</label>
                    <input type="text" id="prompt-name" required class="w-full px-4 py-2 border rounded-lg"
                        placeholder="‰æã: „Ç®„É≥„Ç∏„Éã„Ç¢Âêë„ÅëÊé®Ëñ¶„Éó„É≠„É≥„Éó„Éà">
                </div>

                <div class="flex items-center gap-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="prompt-is-active" class="w-4 h-4 text-indigo-600 rounded">
                        <span class="text-sm text-gray-700">ÊúâÂäπ„Å´„Åô„Çã</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="prompt-is-global" class="w-4 h-4 text-indigo-600 rounded">
                        <span class="text-sm text-gray-700">„Ç∞„É≠„Éº„Éê„É´Ë®≠ÂÆöÔºàÂÖ®ÁµÑÁπî„Å´ÈÅ©Áî®Ôºâ</span>
                    </label>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">„Éó„É≠„É≥„Éó„Éà„ÉÜ„É≥„Éó„É¨„Éº„Éà *</label>
                    <p class="text-xs text-gray-500 mb-2">
                        Âà©Áî®ÂèØËÉΩ„Å™Â§âÊï∞: {user_profile}, {jobs}<br>
                        ‚ÄªJSONÂΩ¢Âºè„Åß„ÅÆÂá∫Âäõ„ÇíÁ∂≠ÊåÅ„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                    </p>
                    <textarea id="prompt-template" required rows="15"
                        class="w-full px-4 py-2 border rounded-lg font-mono text-sm bg-gray-50"></textarea>
                </div>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closePromptModal()"
                        class="px-6 py-2 border rounded-lg hover:bg-gray-50">
                        „Ç≠„É£„É≥„Çª„É´
                    </button>
                    <button type="submit" id="prompt-submit-btn"
                        class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">
                        ‰øùÂ≠ò
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Suspected Duplicates Modal -->
    <div id="suspected-duplicates-modal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-[60]">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-5xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">ÈáçË§áÁñë„ÅÑ„ÅÆ„ÅÇ„ÇãÊ±Ç‰∫∫„ÅÆÁ¢∫Ë™ç</h3>
                <button onclick="closeSuspectedDuplicatesModal()" class="text-gray-400 hover:text-gray-500">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="mb-4">
                <div class="bg-amber-50 border-l-4 border-amber-400 p-4 mb-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-amber-400"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-amber-700">
                                ‰ª•‰∏ã„ÅÆÊ±Ç‰∫∫„ÅØ„ÄÅÊó¢„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„ÇãÊ±Ç‰∫∫„Å®ÈáçË§á„Åó„Å¶„ÅÑ„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„ÅôÔºà‰ºÅÊ•≠Âêç„ÉªÊ±Ç‰∫∫„Çø„Ç§„Éà„É´„ÉªÂã§ÂãôÂú∞„Åå‰∏ÄËá¥Ôºâ„ÄÇ
                                <br>
                                „Ç§„É≥„Éù„Éº„ÉàÂØæË±°„Å®„Åô„ÇãÊ±Ç‰∫∫„Å´„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÖ•„Çå„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto mb-6 border rounded-lg max-h-96 overflow-y-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">
                            <input type="checkbox" id="duplicate-check-all" onchange="toggleDuplicateCheckAll(this)"
                                class="rounded text-indigo-600">
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">
                            CSVË°å</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            ÁôªÈå≤„Éá„Éº„Çø„Å®Êó¢Â≠ò„Éá„Éº„Çø„ÅÆÊØîËºÉ</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">
                            Âá¶ÁêÜÊñπÊ≥ï</th>
                    </thead>
                    <tbody id="suspected-duplicates-tbody" class="bg-white divide-y divide-gray-200 text-sm">
                        <!-- JS„ÅßÂãïÁöÑ„Å´ËøΩÂä† -->
                    </tbody>
                </table>
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="closeSuspectedDuplicatesModal()"
                    class="px-6 py-2.5 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium transition-colors">
                    Âèñ„ÇäËæº„Åø„Çí„Ç≠„É£„É≥„Çª„É´
                </button>
                <button onclick="importSelectedDuplicates()"
                    class="px-6 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium transition-colors shadow-sm">
                    ÈÅ∏Êäû„Åó„ÅüÊ±Ç‰∫∫„Çí„Ç§„É≥„Éù„Éº„ÉàÂÆüË°å
                </button>
            </div>
        </div>
    </div>



    <!-- Job Smart Import Modal (Text/Image) -->



    <!-- CSV Mapping Modal -->
    <div id="csv-mapping-modal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-5xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">CSV„Ç§„É≥„Éù„Éº„ÉàË®≠ÂÆö</h3>
                <button onclick="closeCSVMappingModal()" class="text-gray-400 hover:text-gray-500">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-2">CSV„Éï„Ç°„Ç§„É´„ÅÆÂàó„Å®„Ç∑„Çπ„ÉÜ„É†„ÅÆÈ†ÖÁõÆ„ÇíÂØæÂøú‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>

                <!-- Ë®≠ÂÆö‰øùÂ≠ò„ÉªË™≠„ÅøËæº„Åø„Ç®„É™„Ç¢ -->
                <div class="bg-gray-50 p-4 rounded-lg mb-4 border border-gray-200">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="flex-1">
                            <label
                                class="block text-xs font-bold text-gray-700 mb-1 uppercase tracking-wide">‰øùÂ≠òÊ∏à„ÅøË®≠ÂÆö„ÇíÈÅ©Áî®</label>
                            <div class="flex gap-2">
                                <select id="saved-mapping-select" onchange="applySavedMapping(this.value)"
                                    class="flex-1 border-gray-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="">-- Ë®≠ÂÆö„ÇíÈÅ∏Êäû --</option>
                                </select>
                                <button onclick="deleteSavedMapping()"
                                    class="px-2 py-1 text-red-500 hover:text-red-700 border border-transparent hover:border-red-200 rounded"
                                    title="ÈÅ∏Êäû„Åó„ÅüË®≠ÂÆö„ÇíÂâäÈô§">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex-1">
                            <label
                                class="block text-xs font-bold text-gray-700 mb-1 uppercase tracking-wide">ÁèæÂú®„ÅÆË®≠ÂÆö„Çí‰øùÂ≠ò</label>
                            <div class="flex gap-2">
                                <input type="text" id="new-mapping-name" placeholder="Ë®≠ÂÆöÂêç„ÇíÂÖ•Âäõ (‰æã: Ê±Ç‰∫∫„Çµ„Ç§„ÉàA)"
                                    class="flex-1 border-gray-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <button onclick="saveCurrentMapping()"
                                    class="px-3 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-100 text-sm font-medium shadow-sm">
                                    ‰øùÂ≠ò
                                </button>
                            </div>
                        </div>
                    </div>
                </div>



                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700">
                                ÊúÄÂàù„ÅÆ5Ë°å„Çí„Éó„É¨„Éì„É•„Éº„Å®„Åó„Å¶Ë°®Á§∫„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ<br>
                                ÂøÖÈ†àÈ†ÖÁõÆ„Åå„Éû„ÉÉ„Éî„É≥„Ç∞„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÄÅ„Ç§„É≥„Éù„Éº„Éà„Åß„Åç„Åæ„Åõ„Çì„ÄÇ
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-4 flex justify-end">
                <button onclick="autoMapWithAI(event)"
                    class="px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg hover:from-purple-700 hover:to-indigo-700 shadow-sm text-sm font-medium flex items-center transition-all duration-200 mr-2">
                    <i class="fas fa-magic mr-2"></i>AI„ÅßËá™Âãï„Éû„ÉÉ„Éî„É≥„Ç∞
                </button>
                <button onclick="previewAIAnalysis(event)"
                    class="px-4 py-2 bg-white border border-purple-200 text-purple-700 rounded-lg hover:bg-purple-50 shadow-sm text-sm font-medium flex items-center transition-all duration-200">
                    <i class="fas fa-eye mr-2"></i>1‰ª∂ÁõÆ„ÇíAIËß£Êûê„Éó„É¨„Éì„É•„Éº
                </button>
            </div>

            <!-- Upsert Mode Settings -->
            <div class="bg-indigo-50 p-4 rounded-lg mb-4 border border-indigo-200">
                <h4 class="text-sm font-bold text-indigo-900 mb-2">Êõ¥Êñ∞Ë®≠ÂÆö</h4>
                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="csv-upsert-mode" onchange="toggleUpsertKey()"
                            class="rounded text-indigo-600 focus:ring-indigo-500 mr-2">
                        <span class="text-sm text-gray-700">ÈáçË§á„É¨„Ç≥„Éº„Éâ„ÇíÊõ¥Êñ∞„Åô„ÇãÔºà„Ç¢„ÉÉ„Éó„Çµ„Éº„ÉàÔºâ</span>
                    </label>
                    <div id="csv-upsert-key-container" class="hidden flex items-center gap-2">
                        <span class="text-sm text-gray-600 font-medium">Êõ¥Êñ∞„Ç≠„Éº:</span>
                        <select id="csv-upsert-key"
                            class="text-sm border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 min-w-[150px]">
                            <!-- JS„ÅßÂãïÁöÑ„Å´ËøΩÂä† -->
                        </select>
                    </div>
                </div>
                <p class="text-[10px] text-indigo-500 mt-2">
                    ‚Äª Êõ¥Êñ∞„Ç≠„Éº„Åå‰∏ÄËá¥„Åô„ÇãÊó¢Â≠ò„É¨„Ç≥„Éº„Éâ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÄÅ„Åù„ÅÆÊÉÖÂ†±„ÇíÊõ¥Êñ∞Ôºà‰∏äÊõ∏„ÅçÔºâ„Åó„Åæ„Åô„ÄÇ‰∏ÄËá¥„Åó„Å™„ÅÑÂ†¥Âêà„ÅØÊñ∞Ë¶èÁôªÈå≤„Åó„Åæ„Åô„ÄÇ
                    <br>
                    ‚Äª „Ç∑„Çπ„ÉÜ„É†È†ÖÁõÆ„Å´„Éû„ÉÉ„Éî„É≥„Ç∞„Åó„ÅüÈ†ÖÁõÆ„Åã„Çâ„ÅÆ„Åø„Ç≠„Éº„ÇíÈÅ∏Êäû„Åß„Åç„Åæ„Åô„ÄÇ
                </p>
            </div>

            <!-- Salary Unit Settings -->
            <div class="bg-blue-50 p-4 rounded-lg mb-6 border border-blue-200">
                <h4 class="text-sm font-bold text-blue-900 mb-2">Âπ¥Âèé„Éá„Éº„Çø„ÅÆÂçò‰ΩçË®≠ÂÆö</h4>
                <div class="flex flex-wrap gap-x-6 gap-y-2">
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="csv-salary-unit" value="auto" checked
                            class="text-blue-600 focus:ring-blue-500 mr-2">
                        <span class="text-sm text-gray-700">Ëá™ÂãïÂà§ÂÆö (1‰∏áÊú™Ê∫Ä„Å™„Çâ‰∏áÂÜÜÂçò‰Ωç„Å®„Åø„Å™„Åô)</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="csv-salary-unit" value="man"
                            class="text-blue-600 focus:ring-blue-500 mr-2">
                        <span class="text-sm text-gray-700">Â∏∏„Å´‰∏áÂÜÜÂçò‰Ωç (‰æã: 500)</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="csv-salary-unit" value="yen"
                            class="text-blue-600 focus:ring-blue-500 mr-2">
                        <span class="text-sm text-gray-700">Â∏∏„Å´ÂÜÜÂçò‰Ωç (‰æã: 5000000)</span>
                    </label>
                </div>
                <p class="text-[10px] text-blue-500 mt-2">
                    ‚Äª „Ç§„É≥„Éù„Éº„ÉàÂæå„ÅÆ„Éá„Éº„Çø„ÅØ„Ç∑„Çπ„ÉÜ„É†ÂÜÖ„Åß„Äå‚óè‚óè‰∏áÂÜÜ„Äç„Å®„Åó„Å¶Áµ±‰∏Ä„Åó„Å¶Êâ±„Çè„Çå„Åæ„Åô„ÄÇ
                </p>
            </div>

            <!-- AIËá™ÂãïË£úÂÆå„Ç™„Éó„Ç∑„Éß„É≥ -->
            <div class="mb-6 bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                <label class="flex items-start gap-3 cursor-pointer">
                    <input type="checkbox" id="csv-ai-augment" class="w-5 h-5 text-indigo-600 rounded mt-0.5" checked>
                    <div>
                        <span class="font-bold text-indigo-900">AI„Å´„Çà„ÇãÈ†ÖÁõÆË£úÂÆå„ÉªÂà§ÂÆö„ÇíË°å„ÅÜ</span>
                        <p class="text-xs text-indigo-700 mt-1 leading-relaxed">
                            CSV„Å´ÂÄ§„ÅåÂÖ•„Å£„Å¶„ÅÑ„Å™„ÅÑÈ†ÖÁõÆ„Çí„ÄÅ‰ªñ„ÅÆ„ÉÜ„Ç≠„Çπ„ÉàÊÉÖÂ†±„Åã„ÇâAI„ÅåËá™ÂãïÁöÑ„Å´Êé®Ê∏¨„Åó„Å¶Ë£úÂÆå„Åó„Åæ„Åô„ÄÇ<br>
                            <span class="font-semibold text-indigo-800">„ÄêÊ±Ç‰∫∫„Äë</span> ËÅ∑Á®Æ„ÉªÊ•≠Áïå„Ç´„ÉÜ„Ç¥„É™„ÄÅ„É™„É¢„Éº„Éà„ÉØ„Éº„ÇØ„ÄÅÂãüÈõÜËÉåÊôØ„Å™„Å©<br>
                            <span class="font-semibold text-indigo-800">„ÄêÊ±ÇËÅ∑ËÄÖ„Äë</span> Â∏åÊúõËÅ∑Á®Æ„ÉªÂã§ÂãôÂú∞„ÄÅ„Çπ„Ç≠„É´„ÄÅÁµåÊ≠¥ÊÉÖÂ†±„ÅÆÊßãÈÄ†Âåñ„Å™„Å©<br>
                            <span class="text-red-500 font-medium">‚ÄªAIËß£Êûê„ÇíÊúâÂäπ„Å´„Åô„Çã„Å®„ÄÅ„Ç§„É≥„Éù„Éº„Éà„Å´ÊôÇÈñì„Åå„Åã„Åã„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„ÅôÔºàÊï∞ÂàÜÁ®ãÂ∫¶Ôºâ„ÄÇ</span>
                        </p>
                    </div>
                </label>
            </div>

            <div class="overflow-x-auto mb-6">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                style="width: 20%;">
                                „Ç∑„Çπ„ÉÜ„É†È†ÖÁõÆ
                            </th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                style="width: 40%; min-width: 250px; resize: horizontal; overflow: auto;">
                                CSVÂàó„ÅÆÈÅ∏Êäû
                            </th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                style="width: 40%;">
                                „Éó„É¨„Éì„É•„Éº (1Ë°åÁõÆ)
                            </th>
                        </tr>
                    </thead>
                    <tbody id="csv-mapping-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Mapping rows will be inserted here -->
                    </tbody>
                </table>
            </div>

            <div class="flex justify-end gap-3">
                <button onclick="closeCSVMappingModal()"
                    class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                    „Ç≠„É£„É≥„Çª„É´
                </button>
                <button onclick="executeCSVImport()"
                    class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow-md">
                    „Ç§„É≥„Éù„Éº„ÉàÂÆüË°å
                </button>
            </div>
        </div>
    </div>

    <!-- User Registration Modal -->
    <div id="user-registration-modal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900" id="user-reg-title">Êñ∞Ë¶è„É¶„Éº„Ç∂„ÉºÁôªÈå≤</h3>
                <button onclick="closeUserRegistrationModal()"
                    class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="user-registration-form" onsubmit="handleUserRegistration(event)">
                <input type="hidden" id="reg-role">

                <!-- Basic Info -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÂêçÂâç *</label>
                        <input type="text" id="reg-name" required class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">„Åµ„Çä„Åå„Å™</label>
                        <input type="text" id="reg-furigana" placeholder="‰æã: „ÇÑ„Åæ„Å† „Åü„Çç„ÅÜ"
                            class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ê±ÇËÅ∑ËÄÖID (‰ªªÊÑè)</label>
                        <input type="text" id="reg-user-code" placeholder="‰æã: C001"
                            class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ *</label>
                        <input type="email" id="reg-email" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">„Éë„Çπ„ÉØ„Éº„Éâ *</label>
                    <input type="password" id="reg-password" minlength="6" class="w-full px-4 py-2 border rounded-lg">
                </div>

                <!-- Role Selection (for User Management) -->
                <div id="reg-role-section" class="mb-4 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">„É≠„Éº„É´ *</label>
                    <select id="reg-role-select" class="w-full px-4 py-2 border rounded-lg">
                        <option value="admin">ÁÆ°ÁêÜËÄÖ</option>
                        <option value="coach">CA„ÉªRA</option>
                        <option value="candidate">Ê±ÇËÅ∑ËÄÖ</option>
                    </select>
                </div>

                <!-- Candidate Specific Fields -->
                <div id="reg-candidate-fields" class="hidden border-t pt-4 mt-4">
                    <h4 class="text-md font-medium text-gray-900 mb-3">„Éó„É≠„Éï„Ç£„Éº„É´ÊÉÖÂ†±</h4>

                    <!-- PDF Upload -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Â±•Ê≠¥Êõ∏/ËÅ∑ÂãôÁµåÊ≠¥Êõ∏PDF„Åã„ÇâËá™ÂãïÂÖ•Âäõ</label>
                        <div class="flex gap-2">
                            <input type="file" accept=".pdf" multiple class="hidden" id="reg-resume-upload"
                                onchange="handleRegResumeUpload(this)">
                            <button type="button" onclick="$('#reg-resume-upload').click()"
                                class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition">
                                <i class="fas fa-file-upload mr-2"></i>PDF„ÇíÈÅ∏Êäû
                            </button>
                            <span id="reg-resume-filename" class="text-sm text-gray-500 flex items-center"></span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Â∏åÊúõËÅ∑Á®Æ</label>
                            <select id="reg-job-type" class="w-full px-4 py-2 border rounded-lg select2" multiple
                                style="width: 100%">
                                <!-- Options will be loaded dynamically -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Â∏åÊúõÊ•≠Áïå</label>
                            <select id="reg-industry" class="w-full px-4 py-2 border rounded-lg select2" multiple
                                style="width: 100%">
                                <!-- Options will be loaded dynamically -->
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Â∏åÊúõÂã§ÂãôÂú∞</label>
                            <div class="flex gap-2">
                                <select id="reg-prefecture" class="w-1/3 px-2 py-2 border rounded-lg select2" multiple
                                    style="width: 40%">
                                </select>
                                <input type="text" id="reg-city" placeholder="Â∏ÇÂå∫Áî∫Êùë"
                                    class="w-2/3 px-4 py-2 border rounded-lg" style="width: 60%">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Â∏åÊúõÈõáÁî®ÂΩ¢ÊÖã</label>
                                <select id="reg-employment-type" class="w-full px-4 py-2 border rounded-lg select2"
                                    multiple style="width: 100%">
                                    <!-- Options will be loaded dynamically -->
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Â∏åÊúõÂπ¥ÂèéÔºà‰∏áÂÜÜÔºâ</label>
                                <input type="number" id="reg-salary" class="w-full px-4 py-2 border rounded-lg">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">„Çπ„Ç≠„É´</label>
                            <textarea id="reg-skills" rows="3" class="w-full px-4 py-2 border rounded-lg"></textarea>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">ËÅ∑Ê≠¥„ÉªËá™Â∑±PR</label>
                            <textarea id="reg-history" rows="4" class="w-full px-4 py-2 border rounded-lg"></textarea>
                        </div>

                        <!-- ÊßãÈÄ†Âåñ„Åï„Çå„ÅüËÅ∑Ê≠¥ -->
                        <div class="mb-4 border-t border-gray-200 pt-4">
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-medium text-gray-700">Ë©≥Á¥∞ËÅ∑Ê≠¥</label>
                                <button type="button" onclick="addRegWorkHistoryItem()"
                                    class="text-sm text-indigo-600 hover:text-indigo-800 flex items-center">
                                    <i class="fas fa-plus-circle mr-1"></i>ËøΩÂä†
                                </button>
                            </div>
                            <div id="reg-work-history-list" class="space-y-4 mb-2"></div>
                            <div class="flex items-center gap-4 mt-2">
                                <label class="text-xs text-gray-500">ÁµåÈ®ìÁ§æÊï∞ (Ëá™ÂãïË®àÁÆó):</label>
                                <input type="number" id="reg-job-change-count"
                                    class="w-20 px-2 py-1 border rounded bg-gray-50 text-center text-sm" readonly
                                    value="0">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">ËÅ∑ÂãôÁµåÊ≠¥Êõ∏ (Ë©≥Á¥∞„ÉÜ„Ç≠„Çπ„Éà)</label>
                            <textarea id="reg-work-history-detail" rows="10"
                                class="w-full px-4 py-2 border rounded-lg text-sm font-mono bg-gray-50 focus:bg-white transition"
                                placeholder="ËÅ∑ÂãôÁµåÊ≠¥„ÅÆË©≥Á¥∞„ÉÜ„Ç≠„Çπ„Éà"></textarea>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Á§æÂÜÖ„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÊÉÖÂ†±</label>
                            <textarea id="reg-resume-detail" rows="6"
                                class="w-full px-4 py-2 border rounded-lg text-sm font-mono bg-gray-50 focus:bg-white transition"
                                placeholder="Á§æÂÜÖ„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÊÉÖÂ†±Ôºà„Çπ„Ç≠„É´„ÄÅÁµåÈ®ì„ÄÅÂ∏åÊúõ„ÅÆË£úË∂≥„Å™„Å©Ôºâ"></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" onclick="closeUserRegistrationModal()"
                            class="px-4 py-2 border rounded-lg hover:bg-gray-50">„Ç≠„É£„É≥„Çª„É´</button>
                        <button type="submit"
                            class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">ÁôªÈå≤</button>
                    </div>
            </form>
        </div>
    </div>

    <script type="module">
        // ========================
        // Supabase Configuration
        // ========================
        // Áí∞Â¢ÉÂà§ÂÆö„Å®SupabaseË®≠ÂÆö
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.hostname === '';

        // Êú¨Áï™Áí∞Â¢É (Production)
        const PROD_CONFIG = {
            url: 'https://npjsmoxxzlqkpopzjyyz.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5wanNtb3h4emxxa3BvcHpqeXl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzOTQ5MzYsImV4cCI6MjA3Njk3MDkzNn0.SInkweULu_GTr33JV7RCVtj4HBUfNFfK0_yrZghd38o' // (Êó¢Â≠ò„ÅÆ„Ç≠„Éº)
        };

        // ÈñãÁô∫Áí∞Â¢É (Development)
        const DEV_CONFIG = {
            url: 'https://sgkhqtqdnyiliqpksiej.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNna2hxdHFkbnlpbGlxcGtzaWVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5NjU1MjIsImV4cCI6MjA4MDU0MTUyMn0.gx_E7OWW0mFwb4gCXh1NrU7pp0d-5vlL3PPSXUe-ZWE'
        };

        // ÁèæÂú®„ÅÆÁí∞Â¢É„Å´Âêà„Çè„Åõ„Å¶Ë®≠ÂÆö„ÇíÈÅ∏Êäû
        // ÁèæÂú®„ÅÆÁí∞Â¢É„Å´Âêà„Çè„Åõ„Å¶Ë®≠ÂÆö„ÇíÈÅ∏Êäû
        const config = isLocal ? DEV_CONFIG : PROD_CONFIG;

        // Supabase„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅÆÂàùÊúüÂåñ
        const { createClient } = supabase
        const supabaseClient = createClient(config.url, config.key)

        // ÈñãÁô∫Áí∞Â¢É„ÅÆÂ†¥Âêà„ÅØ„Ç≥„É≥„ÇΩ„Éº„É´„Å´Ë°®Á§∫Ôºà„Çè„Åã„Çä„ÇÑ„Åô„Åè„Åô„Çã„Åü„ÇÅÔºâ
        if (isLocal) {
            console.log('%c[Dev Mode] Connected to Development Supabase', 'color: #4f46e5; font-weight: bold; background: #e0e7ff; padding: 4px 8px; border-radius: 4px;');
        }

        // „Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨Èñã
        window.supabase = supabaseClient

        // currentUser„Çí„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å®„Åó„Å¶ÂÆöÁæ©
        let isInitialLoad = true;
        let currentUser = null;
        let isModalLoading = false;
        let isAImatchingResultView = false;
        let aiResultCache = {}; // userId_jobId -> details
        let pendingBulkJobs = []; // Ê±Ç‰∫∫‰∏ÄÊã¨Âèñ„ÇäËæº„ÅøÊôÇ„ÅÆÁ¢∫Ë™çÂæÖ„Å°„É™„Çπ„Éà
        let importResultSuccessFiles = []; // „Ç§„É≥„Éù„Éº„ÉàÊàêÂäü„Éï„Ç°„Ç§„É´„É™„Çπ„Éà
        let importResultErrorFiles = [];   // „Ç§„É≥„Éù„Éº„Éà„Ç®„É©„Éº„Éï„Ç°„Ç§„É´„É™„Çπ„Éà

        window.showImportResult = function (successFiles, errorFiles) {
            const $modal = $('#import-result-modal');
            const $summary = $('#import-result-summary');
            const $successSection = $('#import-result-success-section');
            const $successList = $('#import-result-success-list');
            const $errorSection = $('#import-result-error-section');
            const $errorList = $('#import-result-error-list');

            $successList.empty();
            $errorList.empty();

            $summary.html(`
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-green-50 p-4 rounded-lg border border-green-100 text-center">
                        <div class="text-2xl font-bold text-green-600">${successFiles.length}</div>
                        <div class="text-xs text-green-700 font-bold">ÁôªÈå≤ÊàêÂäü</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg border border-red-100 text-center">
                        <div class="text-2xl font-bold text-red-600">${errorFiles.length}</div>
                        <div class="text-xs text-red-700 font-bold">„Ç®„É©„Éº</div>
                    </div>
                </div>
            `);

            if (successFiles.length > 0) {
                successFiles.forEach(f => $successList.append(`<li>${f}</li>`));
                $successSection.removeClass('hidden');
            } else {
                $successSection.addClass('hidden');
            }

            if (errorFiles.length > 0) {
                errorFiles.forEach(item => {
                    const name = typeof item === 'string' ? item : item.name;
                    const msg = typeof item === 'string' ? '' : ` (${item.message})`;
                    $errorList.append(`<li>${name}${msg}</li>`);
                });
                $errorSection.removeClass('hidden');
            } else {
                $errorSection.addClass('hidden');
            }

            $modal.removeClass('hidden');
        }
        window.prefectures = [
            "ÂåóÊµ∑ÈÅì", "ÈùíÊ£ÆÁúå", "Â≤©ÊâãÁúå", "ÂÆÆÂüéÁúå", "ÁßãÁî∞Áúå", "Â±±ÂΩ¢Áúå", "Á¶èÂ≥∂Áúå",
            "Ëå®ÂüéÁúå", "Ê†ÉÊú®Áúå", "Áæ§È¶¨Áúå", "ÂüºÁéâÁúå", "ÂçÉËëâÁúå", "Êù±‰∫¨ÈÉΩ", "Á•ûÂ•àÂ∑ùÁúå",
            "Êñ∞ÊΩüÁúå", "ÂØåÂ±±Áúå", "Áü≥Â∑ùÁúå", "Á¶è‰∫ïÁúå", "Â±±Ê¢®Áúå", "Èï∑ÈáéÁúå", "Â≤êÈòúÁúå",
            "ÈùôÂ≤°Áúå", "ÊÑõÁü•Áúå", "‰∏âÈáçÁúå", "ÊªãË≥ÄÁúå", "‰∫¨ÈÉΩÂ∫ú", "Â§ßÈò™Â∫ú", "ÂÖµÂ∫´Áúå",
            "Â•àËâØÁúå", "ÂíåÊ≠åÂ±±Áúå", "È≥•ÂèñÁúå", "Â≥∂Ê†πÁúå", "Â≤°Â±±Áúå", "Â∫ÉÂ≥∂Áúå", "Â±±Âè£Áúå",
            "Âæ≥Â≥∂Áúå", "È¶ôÂ∑ùÁúå", "ÊÑõÂ™õÁúå", "È´òÁü•Áúå", "Á¶èÂ≤°Áúå", "‰ΩêË≥ÄÁúå", "Èï∑Â¥éÁúå",
            "ÁÜäÊú¨Áúå", "Â§ßÂàÜÁúå", "ÂÆÆÂ¥éÁúå", "ÈπøÂÖêÂ≥∂Áúå", "Ê≤ñÁ∏ÑÁúå"
        ];

        // AIÊé®Ëñ¶ÂØæË±°„É¶„Éº„Ç∂„ÉºÈñ¢ÈÄ£
        let selectedTargetUserId = null;
        let selectedTargetUserName = null;
        let selectedTargetUserEmail = null;
        let allCandidateUsers = []; // ÂÄôË£ú„É¶„Éº„Ç∂„Éº„É™„Çπ„ÉàÔºàÁÆ°ÁêÜËÄÖ„Éª„Ç≥„Éº„ÉÅÁî®Ôºâ
        let shouldReloadCandidates = false; // „Ç≠„É£„ÉÉ„Ç∑„É•Êõ¥Êñ∞„Éï„É©„Ç∞


        // ========================
        // Master Data Logic with Caching
        // ========================
        let masterIndustries = [];
        let masterJobCategories = [];
        let masterSelectionStatuses = [];

        // „Éû„Çπ„Çø„Éº„Éá„Éº„Çø„Ç≠„É£„ÉÉ„Ç∑„É•
        const masterDataCache = {
            employmentTypes: null,
            industries: null,
            jobCategories: null,
            selectionStatuses: null,
            lastUpdated: null,
            cacheDuration: 30 * 60 * 1000, // 30ÂàÜ

            // „Ç≠„É£„ÉÉ„Ç∑„É•„ÅåÊúâÂäπ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            isValid() {
                if (!this.lastUpdated) return false;
                const now = Date.now();
                return (now - this.lastUpdated) < this.cacheDuration;
            },

            // „Ç≠„É£„ÉÉ„Ç∑„É•„Çí„ÇØ„É™„Ç¢
            clear() {
                this.employmentTypes = null;
                this.industries = null;
                this.jobCategories = null;
                this.selectionStatuses = null;
                this.lastUpdated = null;
                console.log('Master data cache cleared');
            },

            // „Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÊõ¥Êñ∞
            update(data) {
                this.employmentTypes = data.employmentTypes;
                this.industries = data.industries;
                this.jobCategories = data.jobCategories;
                this.selectionStatuses = data.selectionStatuses;
                this.lastUpdated = Date.now();
                console.log('Master data cache updated');
            }
        };

        async function initMasterDataDropdowns() {
            if (!currentUser) {
                console.warn('initMasterDataDropdowns called but currentUser is null');
                return;
            }

            try {
                // „Ç≠„É£„ÉÉ„Ç∑„É•„ÅåÊúâÂäπ„Å™Â†¥Âêà„ÅØÂÜçÂà©Áî®
                if (masterDataCache.isValid()) {
                    console.log('Using cached master data');
                    masterIndustries = masterDataCache.industries;
                    masterJobCategories = masterDataCache.jobCategories;
                    masterSelectionStatuses = masterDataCache.selectionStatuses;
                } else {
                    console.log('Fetching master data from database');

                    // master_data „ÉÜ„Éº„Éñ„É´„Åã„ÇâÊ•≠Áïå„Å®ËÅ∑Á®Æ„ÇíÂèñÂæó
                    const { data: masters, error } = await supabase
                        .from('master_data')
                        .select('type, label, value, organization_id, sort_order') // ÂøÖË¶Å„Å™„Ç´„É©„É†„ÅÆ„ÅøÂèñÂæó
                        .in('type', ['industry_category', 'job_category', 'selection_status'])
                        .eq('is_active', true)
                        .order('sort_order');

                    if (error) throw error;

                    // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞Ôºà„Ç∞„É≠„Éº„Éê„É´ „Åæ„Åü„ÅØ Ëá™Á§æÁî®Ôºâ
                    const validMasters = masters.filter(m =>
                        m.organization_id === null || m.organization_id === currentUser.organization_id
                    );

                    // Ê•≠Áïå„Éû„Çπ„Çø
                    masterIndustries = [...new Set(validMasters
                        .filter(m => m.type === 'industry_category')
                        .map(m => m.label))];

                    // ËÅ∑Á®Æ„Éû„Çπ„Çø
                    masterJobCategories = [...new Set(validMasters
                        .filter(m => m.type === 'job_category')
                        .map(m => m.label))];

                    // ÈÄ≤Êçó„Çπ„ÉÜ„Éº„Çø„Çπ„Éû„Çπ„Çø
                    masterSelectionStatuses = validMasters
                        .filter(m => m.type === 'selection_status');

                    // „Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÊõ¥Êñ∞
                    masterDataCache.update({
                        industries: masterIndustries,
                        jobCategories: masterJobCategories,
                        selectionStatuses: masterSelectionStatuses
                    });
                }

                // ÂêÑ„Éó„É´„ÉÄ„Ç¶„É≥„ÅÆÂàùÊúüÂåñÔºàÊ§úÁ¥¢ÁîªÈù¢„Å™„Å©„ÄÅÂ∏∏„Å´Ë°®Á§∫„Åï„Çå„Å¶„ÅÑ„Çã„ÇÇ„ÅÆÔºâ
                populateSelectOptions('search-industry-category', masterIndustries);
                populateSelectOptions('search-job-category', masterJobCategories);

                // „Éó„É≠„Éï„Ç£„Éº„É´ÁîªÈù¢„Å™„Å©„ÅÆ„Éó„É´„ÉÄ„Ç¶„É≥„ÇÇÂàùÊúüÂåñÔºàÂ≠òÂú®„Åô„Çå„Å∞Ôºâ
                populateSelectOptions('profile-industry', masterIndustries);
                populateSelectOptions('profile-job-type', masterJobCategories);
                populateSelectOptions('company-industry', masterIndustries);
                populateSelectOptions('job-industry-category', masterIndustries);
                populateSelectOptions('job-category', masterJobCategories);

                // ÁÆ°ÁêÜËÄÖÁî®„É¢„Éº„ÉÄ„É´„ÅÆ„Éó„É´„ÉÄ„Ç¶„É≥„ÇÇÊõ¥Êñ∞
                populateSelectOptions('admin-user-industry', masterIndustries);
                populateSelectOptions('admin-user-job-type', masterJobCategories);

                // Select2„ÅÆÈÅ©Áî®„ÉªÂÜçÈÅ©Áî®ÔºàÊ§úÁ¥¢„Éï„Ç©„Éº„É†Áî®Ôºâ
                // closeOnSelect: false „Å´„Çà„Çä„ÄÅË§áÊï∞ÈÅ∏ÊäûÊôÇ„Å´Èñâ„Åò„Å™„Åè„Åô„Çã
                const searchSelects = $('#search-job-category, #search-industry-category, #search-employment-type, #search-prefecture');
                searchSelects.each(function () {
                    if ($(this).hasClass("select2-hidden-accessible")) {
                        $(this).select2('destroy');
                    }
                });
                searchSelects.select2({
                    closeOnSelect: false,
                    width: '100%',
                    allowClear: true,
                    placeholder: 'ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'
                });

                // ËÅ∑Ê≠¥ÂÖ•ÂäõÁî®„ÅÆdatalist„ÇíÊõ¥Êñ∞
                updateWorkHistoryDatalists();

            } catch (error) {
                console.error('Error loading master data:', error);
            }
        }

        // ËÅ∑Á®Æ„Éû„Çπ„Çø‰∏ÄÊã¨Êõ¥Êñ∞Áî®Èñ¢Êï∞
        window.updateJobCategoriesMaster = async function () {
            if (!currentUser || !currentUser.organization_id) {
                alert('ÁµÑÁπîÊÉÖÂ†±„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ');
                return;
            }
            if (currentUser.role !== 'super_admin') {
                alert('„Åì„ÅÆÊìç‰Ωú„ÅØ„Çπ„Éº„Éë„ÉºÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÂèØËÉΩ„Åß„Åô„ÄÇ');
                return;
            }
            if (!confirm('Ëá™ÁµÑÁπî„ÅÆËÅ∑Á®Æ„Éû„Çπ„Çø„ÇíÂàùÊúüÂåñ„Åó„Å¶„ÄÅÊñ∞„Åó„ÅÑ„É™„Çπ„Éà„ÅßÊõ¥Êñ∞„Åó„Åæ„Åô„ÅãÔºü\nÊó¢Â≠ò„ÅÆËÅ∑Á®Æ„Ç´„ÉÜ„Ç¥„É™„ÅØÂÖ®„Å¶ÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ')) return;

            const newJobCategories = [
                "„Åù„ÅÆ‰ªñÂñ∂Ê•≠Á≥ª",
                "Ê≥ï‰∫∫Âñ∂Ê•≠ (BtoB)",
                "ÂÄã‰∫∫Âñ∂Ê•≠ (BtoC)",
                "Êµ∑Â§ñÂñ∂Ê•≠",
                "‰ª£ÁêÜÂ∫óÂñ∂Ê•≠",
                "MR (ÂåªËñ¨ÊÉÖÂ†±ÊãÖÂΩìËÄÖ)",
                "Âñ∂Ê•≠‰ºÅÁîª„ÉªÂñ∂Ê•≠„Ç¢„Ç∑„Çπ„Çø„É≥„Éà",
                "„Åù„ÅÆ‰ªñ‰ºÅÁîª„Éª„Éû„Éº„Ç±„ÉÜ„Ç£„É≥„Ç∞Á≥ª",
                "ÁµåÂñ∂‰ºÅÁîª„Éª‰∫ãÊ•≠‰ºÅÁîª",
                "ÂïÜÂìÅ‰ºÅÁîª„Éª„Çµ„Éº„Éì„Çπ‰ºÅÁîª",
                "„Éû„Éº„Ç±„ÉÜ„Ç£„É≥„Ç∞„ÉªË≤©‰øÉ",
                "Â∫ÉÂ†±„ÉªPR„ÉªIR",
                "Web„Éû„Éº„Ç±„ÉÜ„Ç£„É≥„Ç∞„Éª„Éá„Ç∏„Çø„É´„Éû„Éº„Ç±„ÉÜ„Ç£„É≥„Ç∞",
                "„Åù„ÅÆ‰ªñ‰∫ãÂãô„ÉªÁÆ°ÁêÜÁ≥ª",
                "‰∫∫‰∫ã„ÉªÂä¥Âãô",
                "ÁµåÁêÜ„ÉªË≤°Âãô„Éª‰ºöË®à",
                "Ê≥ïÂãô„Éª„Ç≥„É≥„Éó„É©„Ç§„Ç¢„É≥„Çπ",
                "Á∑èÂãô",
                "ÁßòÊõ∏„ÉªÂèó‰ªò",
                "‰∏ÄËà¨‰∫ãÂãô„ÉªÂñ∂Ê•≠‰∫ãÂãô",
                "„Åù„ÅÆ‰ªñIT„Ç®„É≥„Ç∏„Éã„Ç¢Á≥ª",
                "„Ç∑„Çπ„ÉÜ„É†„Ç®„É≥„Ç∏„Éã„Ç¢ (SE)",
                "„Éó„É≠„Ç∞„É©„Éû„Éº (PG)",
                "Web„Ç®„É≥„Ç∏„Éã„Ç¢Ôºà„Éï„É≠„É≥„Éà„Ç®„É≥„Éâ/„Éê„ÉÉ„ÇØ„Ç®„É≥„ÉâÔºâ",
                "„Ç§„É≥„Éï„É©„Ç®„É≥„Ç∏„Éã„Ç¢Ôºà„Çµ„Éº„Éê„Éº/„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÔºâ",
                "Á§æÂÜÖSE",
                "„Éá„Éº„Çø„Çµ„Ç§„Ç®„É≥„ÉÜ„Ç£„Çπ„Éà„Éª„Ç¢„Éä„É™„Çπ„Éà",
                "„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éû„Éç„Éº„Ç∏„É£„Éº (PM)",
                "IT„Ç≥„É≥„Çµ„É´„Çø„É≥„Éà",
                "ÂìÅË≥™ÁÆ°ÁêÜ„Éª„ÉÜ„Çπ„Éà„Ç®„É≥„Ç∏„Éã„Ç¢",
                "„Åù„ÅÆ‰ªñ„ÇØ„É™„Ç®„Ç§„ÉÜ„Ç£„ÉñÁ≥ª",
                "Web„Éá„Ç∂„Ç§„Éä„Éº„ÉªUI/UX„Éá„Ç∂„Ç§„Éä„Éº",
                "„Ç∞„É©„Éï„Ç£„ÉÉ„ÇØ„Éá„Ç∂„Ç§„Éä„Éº",
                "Web„Éá„Ç£„É¨„ÇØ„Çø„Éº„Éª„Éó„É≠„Éá„É•„Éº„Çµ„Éº",
                "Á∑®ÈõÜ„Éª„É©„Ç§„Çø„Éº„Éª„Ç≥„Éî„Éº„É©„Ç§„Çø„Éº",
                "„Ç≤„Éº„É†„ÇØ„É™„Ç®„Ç§„Çø„ÉºÔºà„Éó„É©„É≥„Éä„Éº/„Éá„Ç∂„Ç§„Éä„Éº/„Ç∑„Éä„É™„Ç™„É©„Ç§„Çø„ÉºÔºâ",
                "Êò†ÂÉè„ÉªÈü≥Èüø„ÇØ„É™„Ç®„Ç§„Çø„Éº",
                "„Åù„ÅÆ‰ªñÊäÄË°ì„ÉªË£ΩÈÄ†Á≥ª",
                "Á†îÁ©∂„ÉªÈñãÁô∫ (R&D)",
                "Ë®≠Ë®à„ÉªÈñãÁô∫ÔºàÊ©üÊ¢∞/ÈõªÊ∞ó/ÈõªÂ≠êÔºâ",
                "ÁîüÁî£ÊäÄË°ì„ÉªË£ΩÈÄ†ÊäÄË°ì",
                "ÂìÅË≥™ÁÆ°ÁêÜ„ÉªÂìÅË≥™‰øùË®º",
                "ÁîüÁî£ÁÆ°ÁêÜ„ÉªÂ∑•Á®ãÁÆ°ÁêÜ",
                "Ë≥ºË≤∑„ÉªË™øÈÅî",
                "„Åù„ÅÆ‰ªñË≤©Â£≤„Éª„Çµ„Éº„Éì„ÇπÁ≥ª",
                "Ë≤©Â£≤„ÉªÊé•ÂÆ¢„Çπ„Çø„ÉÉ„Éï",
                "Â∫óÈï∑„Éª„Ç®„É™„Ç¢„Éû„Éç„Éº„Ç∏„É£„Éº",
                "„Çπ„Éº„Éë„Éº„Éê„Ç§„Ç∂„Éº (SV)",
                "„Ç´„Çπ„Çø„Éû„Éº„Çµ„Éù„Éº„Éà„Éª„Ç≥„Éº„É´„Çª„É≥„Çø„Éº",
                "„Éõ„ÉÜ„É´„ÉªÊóÖË°åÈñ¢ÈÄ£„Çπ„Çø„ÉÉ„Éï",
                "È£≤È£üÂ∫ó„Çπ„Çø„ÉÉ„Éï",
                "„Åù„ÅÆ‰ªñ„Ç≥„É≥„Çµ„É´„Çø„É≥„Éà„ÉªÂ∞ÇÈñÄËÅ∑Á≥ª",
                "Êà¶Áï•„Ç≥„É≥„Çµ„É´„Çø„É≥„Éà",
                "IT„Ç≥„É≥„Çµ„É´„Çø„É≥„Éà",
                "Ë≤°Âãô„Éª‰ºöË®à„Ç≥„É≥„Çµ„É´„Çø„É≥„Éà",
                "‰∫∫‰∫ã„Ç≥„É≥„Çµ„É´„Çø„É≥„Éà",
                "ÈáëËûçÂ∞ÇÈñÄËÅ∑Ôºà„Ç¢„Éä„É™„Çπ„Éà„ÄÅ„Éï„Ç°„É≥„Éâ„Éû„Éç„Éº„Ç∏„É£„ÉºÁ≠âÔºâ",
                "Â£´Ê•≠ÔºàÂºÅË≠∑Â£´„ÄÅ‰ºöË®àÂ£´„ÄÅÁ®éÁêÜÂ£´„ÄÅÂºÅÁêÜÂ£´„Å™„Å©Ôºâ",
                "„Åù„ÅÆ‰ªñÂåªÁôÇ„ÉªÁ¶èÁ•â„ÉªÊïôËÇ≤Á≥ª",
                "ÂåªÂ∏´„ÉªÁúãË≠∑Â∏´„ÉªËñ¨Ââ§Â∏´",
                "ÂåªÁôÇÊäÄË°ìËÄÖÔºàËá®Â∫äÊ§úÊüªÊäÄÂ∏´„Å™„Å©Ôºâ",
                "‰ªãË≠∑Á¶èÁ•âÂ£´„Éª„Ç±„Ç¢„Éû„Éç„Éº„Ç∏„É£„Éº",
                "ÊïôÂ∏´„ÉªË¨õÂ∏´„Éª„Ç§„É≥„Çπ„Éà„É©„ÇØ„Çø„Éº",
                "„Ç≠„É£„É™„Ç¢„Ç¢„Éâ„Éê„Ç§„Ç∂„Éº",
                "„Ç≠„É£„É™„Ç¢„Ç≥„Éº„Éá„Ç£„Éç„Éº„Çø„Éº",
                "‰∫∫ÊùêÁ≥ªÂñ∂Ê•≠",
                "„Ç≠„É£„É™„Ç¢„Ç≥„Éº„ÉÅ",
                "„Åù„ÅÆ‰ªñ"
            ];

            try {
                // 1. Êó¢Â≠ò„ÅÆËÅ∑Á®Æ„Ç´„ÉÜ„Ç¥„É™„ÇíÂâäÈô§ (Ëá™ÁµÑÁπî„ÅÆ„ÅøÂØæË±°)
                const { error: deleteError } = await supabase
                    .from('master_data')
                    .delete()
                    .eq('type', 'job_category')
                    .eq('organization_id', currentUser.organization_id);

                if (deleteError) throw deleteError;

                // 2. Êñ∞„Åó„ÅÑËÅ∑Á®Æ„Ç´„ÉÜ„Ç¥„É™„ÇíËøΩÂä†
                const insertData = newJobCategories.map((label, index) => ({
                    type: 'job_category',
                    label: label,
                    value: label,
                    sort_order: (index + 1) * 10,
                    is_active: true,
                    organization_id: currentUser.organization_id
                }));

                const { error: insertError } = await supabase
                    .from('master_data')
                    .insert(insertData);

                if (insertError) throw insertError;

                alert('ËÅ∑Á®Æ„Éû„Çπ„Çø„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü„ÄÇÁîªÈù¢„Çí„É™„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                location.reload();

            } catch (error) {
                console.error('Error updating job categories:', error);
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }

        // ÈÄ≤Êçó„Çπ„ÉÜ„Éº„Çø„Çπ„Éû„Çπ„Çø‰∏ÄÊã¨Êõ¥Êñ∞Áî®Èñ¢Êï∞
        window.updateSelectionStatusMaster = async function () {
            if (!currentUser || !currentUser.organization_id) {
                alert('ÁµÑÁπîÊÉÖÂ†±„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ');
                return;
            }
            if (currentUser.role !== 'super_admin') {
                alert('„Åì„ÅÆÊìç‰Ωú„ÅØ„Çπ„Éº„Éë„ÉºÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÂèØËÉΩ„Åß„Åô„ÄÇ');
                return;
            }
            if (!confirm('Ëá™ÁµÑÁπî„ÅÆÈÄ≤Êçó„Çπ„ÉÜ„Éº„Çø„Çπ„Éû„Çπ„Çø„ÇíÂàùÊúüÂåñ„Åó„Å¶„ÄÅ„Éá„Éï„Ç©„É´„ÉàÂÄ§„ÅßÊõ¥Êñ∞„Åó„Åæ„Åô„ÅãÔºü\nÊó¢Â≠ò„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπË®≠ÂÆö„ÅØÂÖ®„Å¶ÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ')) return;

            // „Éá„Éï„Ç©„É´„Éà„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπÂÆöÁæ©
            const defaultStatuses = [
                { value: 'pending', label: 'Êõ∏È°ûÈÅ∏ËÄÉ‰∏≠', sort_order: 10 },
                { value: 'screening', label: 'Êõ∏È°ûÈÅ∏ËÄÉ‰∏≠(ÂØ©Êüª‰∏≠)', sort_order: 20 },
                { value: 'interview', label: 'Èù¢Êé•‰∫àÂÆö', sort_order: 30 },
                { value: 'offered', label: 'ÂÜÖÂÆö', sort_order: 40 },
                { value: 'rejected', label: '‰∏çÂêàÊ†º', sort_order: 50 },
                { value: 'withdrawn', label: 'ËæûÈÄÄ', sort_order: 60 }
            ];

            try {
                // 1. Êó¢Â≠ò„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂâäÈô§ (Ëá™ÁµÑÁπî„ÅÆ„ÅøÂØæË±°)
                const { error: deleteError } = await supabase
                    .from('master_data')
                    .delete()
                    .eq('type', 'selection_status')
                    .eq('organization_id', currentUser.organization_id);

                if (deleteError) throw deleteError;

                // 2. Êñ∞„Åó„ÅÑ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíËøΩÂä†
                const insertData = defaultStatuses.map(status => ({
                    type: 'selection_status',
                    label: status.label,
                    value: status.value,
                    sort_order: status.sort_order,
                    is_active: true,
                    organization_id: currentUser.organization_id
                }));

                const { error: insertError } = await supabase
                    .from('master_data')
                    .insert(insertData);

                if (insertError) throw insertError;

                alert('ÈÄ≤Êçó„Çπ„ÉÜ„Éº„Çø„Çπ„Éû„Çπ„Çø„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü„ÄÇÁîªÈù¢„Çí„É™„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                location.reload();

            } catch (error) {
                console.error('Error updating selection statuses:', error);
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }

        // „Éó„É≠„É≥„Éó„Éà„Éû„Çπ„Çø‰∏ÄÊã¨Êõ¥Êñ∞Áî®Èñ¢Êï∞
        window.updatePromptMaster = async function () {
            if (!currentUser || !currentUser.organization_id) {
                alert('ÁµÑÁπîÊÉÖÂ†±„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ');
                return;
            }
            if (currentUser.role !== 'super_admin') {
                alert('„Åì„ÅÆÊìç‰Ωú„ÅØ„Çπ„Éº„Éë„ÉºÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÂèØËÉΩ„Åß„Åô„ÄÇ');
                return;
            }
            if (!confirm('Ëá™ÁµÑÁπî„ÅÆ„Éó„É≠„É≥„Éó„Éà„Éû„Çπ„Çø„ÇíÂàùÊúüÂåñ„Åó„Å¶„ÄÅ„Éá„Éï„Ç©„É´„ÉàÂÄ§„ÅßÊõ¥Êñ∞„Åó„Åæ„Åô„ÅãÔºü\nÊó¢Â≠ò„ÅÆ„Éó„É≠„É≥„Éó„ÉàË®≠ÂÆö„ÅØÂÖ®„Å¶ÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ')) return;

            // „Éá„Éï„Ç©„É´„Éà„ÅÆ„Éó„É≠„É≥„Éó„ÉàÂÆöÁæ©ÔºàloadPrompts„Åã„Çâ„Ç≥„Éî„ÉºÔºâ
            const defaultScoring = `
„ÅÇ„Å™„Åü„ÅØÊ∏©„Åã„Åø„ÅÆ„ÅÇ„ÇãËª¢ËÅ∑ÊîØÊè¥„ÅÆ„Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´„Åß„ÅÇ„Çä„ÄÅ‰ºÅÊ•≠ÊñáÂåñ„Å®‰∫∫Êùê„ÅÆ„Éï„Ç£„ÉÉ„ÉàÂàÜÊûê„ÅÆÂ∞ÇÈñÄÂÆ∂„Åß„Åô„ÄÇ
‰ª•‰∏ã„ÅÆÊ±Ç‰∫∫„Å®Ê±ÇËÅ∑ËÄÖÊÉÖÂ†±„Åã„Çâ„ÄÅ„Éû„ÉÉ„ÉÅÂ∫¶„ÇíÂàÜÊûê„Åó„ÄÅ**ÊåáÂÆö„Åï„Çå„Åü„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÅÆ„Åø**„ÅßÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
ÂàÜÊûê„ÅÆË©≥Á¥∞„Éó„É≠„Çª„ÇπÔºà„Äå1.ËÅ∑ÂãôÁµåÊ≠¥„ÅÆ„Éû„ÉÉ„ÉÅÂ∫¶„Äç„Å™„Å©Ôºâ„ÅØ‰∏ÄÂàáÂá∫Âäõ„Åõ„Åö„ÄÅÁµêÊûú„ÅÆ„Åø„ÇíË®òËø∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

„ÄêÊ±ÇËÅ∑ËÄÖÊÉÖÂ†±„Äë
- Âü∫Êú¨ÊÉÖÂ†±: Âπ¥ÈΩ¢ \${userData.age} / Â∏åÊúõÂπ¥Âèé \${userData.desired_salary}
- Â∏åÊúõÊù°‰ª∂: \${userData.desired_industry} / \${userData.desired_job_type} / \${userData.desired_location}
- Êú™ÁµåÈ®ìOK„ÅÆÂ∏åÊúõ: ËÅ∑Á®Æ[\${userProfile.desired_job_experience_ok ? '„ÅØ„ÅÑ' : '„ÅÑ„ÅÑ„Åà'}] / Ê•≠Á®Æ[\${userProfile.desired_industry_experience_ok ? '„ÅØ„ÅÑ' : '„ÅÑ„ÅÑ„Åà'}]
- „Çπ„Ç≠„É´„ÉªPR„ÉªÂÇôËÄÉ: \${userData.notes}
- Â±•Ê≠¥Êõ∏/ÁµåÊ≠¥Êõ∏: \${userData.resume}
- ËÅ∑ÂãôÁµåÊ≠¥Ë©≥Á¥∞: \${userData.work_history}
- Á§æÂÜÖ„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÊÉÖÂ†±: \${userData.matching_info}
- Á§æÂÜÖ„É°„É¢„ÉªÂÖ±Êúâ‰∫ãÈ†Ö: \${userData.internal_info}
- „Åù„ÅÆ‰ªñË£úË∂≥: \${userData.other_info}

„ÄêÊ±Ç‰∫∫ÊÉÖÂ†±„Äë
- ‰ºÅÊ•≠Âêç: \${jobDetails.company}
- ËÅ∑Á®Æ: \${jobDetails.title}
- Ê•≠Á®Æ: \${jobDetails.industrycategory}
- ËÅ∑Á®Æ„Ç´„ÉÜ„Ç¥„É™: \${jobDetails.jobcategory}
- Áµ¶‰∏é: \${jobDetails.salary}
- Âã§ÂãôÂú∞: \${jobDetails.location}
- ÈõáÁî®ÂΩ¢ÊÖã: \${jobDetails.employment_type}
- Ê•≠ÂãôÂÜÖÂÆπ: \${jobDetails.description}
- ÂøÖÈ†à„Çπ„Ç≠„É´: \${jobDetails.qualifications}
- ‰ºÅÊ•≠ÊñáÂåñ„ÉªÁâπÂæ¥: \${jobDetails.company_info}

„ÄêÈáçË¶ÅÔºö‰ºÅÊ•≠ÊñáÂåñ„ÅÆÂàÜÊûê„Å´„Å§„ÅÑ„Å¶„Äë
„Éª‰ºÅÊ•≠ÊÉÖÂ†±„ÅÆ‰∏çË∂≥„ÇÑÊ∑±„ÅÑÂàÜÊûê„ÅåÂøÖË¶Å„Å™Â†¥Âêà„ÅØ„ÄÅ‰ºÅÊ•≠ÂêçÔºà\${jobDetails.company}Ôºâ„Å´Âü∫„Å•„Åç„ÄÅWebÊ§úÁ¥¢Ê©üËÉΩ„ÇíÊ¥ªÁî®„Åó„Å¶ÂÆüÈöõ„ÅÆ„ÇØ„ÉÅ„Ç≥„Éü„ÇÑÁµåÂñ∂ÁêÜÂøµ„ÇíË£úÂÆå„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

---
„ÄêÂá∫Âäõ„Å´„Åä„Åë„ÇãÁµ∂ÂØæÈÅµÂÆà„ÅÆÂà∂Á¥Ñ„Äë
1. ÂàÜÊûê„ÅÆË©≥Á¥∞„Éó„É≠„Çª„ÇπÔºà„Äå1.ËÅ∑ÂãôÁµåÊ≠¥„ÅÆ„Éû„ÉÉ„ÉÅÂ∫¶„Äç„Å™„Å©„ÅÆÂå∫ÂàÜ„Åë„ÇÑË™¨ÊòéÔºâ„ÅØÁµ∂ÂØæ„Å´Êõ∏„ÅçÂá∫„Åï„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ
2. ÊåáÂÆö„Åï„Çå„Åü„É©„Éô„É´Ôºà„ÄåË©ï‰æ°: „Äç„ÄåÁêÜÁî±: „ÄçÁ≠âÔºâ‰ª•Â§ñ„ÅßÂßã„Åæ„ÇãÊñáÁ´†„ÇíÂá∫Âäõ„Åó„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ
3. MarkdownË®òÂè∑Ôºà#„ÄÅ*„ÄÅ**„ÄÅ> Á≠âÔºâ„ÅØ‰ΩøÁî®Á¶ÅÊ≠¢„Åß„Åô„ÄÇ
4. ÂêÑÈ†ÖÁõÆ„ÅÆÊñáÂ≠óÊï∞Âà∂Èôê„Çí1ÊñáÂ≠ó„Åß„ÇÇË∂Ö„Åà„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ
5. ÁêÜÁî±„Å®„Ç¢„Éâ„Éê„Ç§„Çπ„ÅØÊîπË°å„Åõ„Åö„ÄÅ„Åù„Çå„Åû„Çå1ÊñáÔºà80ÊñáÂ≠ó‰ª•ÂÜÖ/60ÊñáÂ≠ó‰ª•ÂÜÖÔºâ„ÅßË®òËø∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

ÂõûÁ≠îÂΩ¢ÂºèÔºö

Ë©ï‰æ°: [„É©„É≥„ÇØA-E„Çí1ÊñáÂ≠ó]
ÁêÜÁî±: [80ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßÁ∞°ÊΩî„Å´„ÄÇÊîπË°å„Åõ„Åö1Êñá„ÅßË®òËø∞]

Á∑èÂêàË©ï‰æ°: [Êï∞ÂÄ§]ÁÇπ

„Éû„ÉÉ„ÉÅ„Åô„ÇãÁÇπ
„Éª[Ë¶ÅÁÇπ„ÄÇ30ÊñáÂ≠ó‰ª•ÂÜÖ]
„Éª[Ë¶ÅÁÇπ„ÄÇ30ÊñáÂ≠ó‰ª•ÂÜÖ]

‰ªäÂæå„ÅÆ„Åï„Çâ„Å™„ÇãÊàêÈï∑„ÉªÊåëÊà¶„ÅåÊúüÂæÖ„Åï„Çå„ÇãÁÇπ
„Éª[Ë¶ÅÁÇπ„ÄÇ30ÊñáÂ≠ó‰ª•ÂÜÖ]
„Éª[Ë¶ÅÁÇπ„ÄÇ30ÊñáÂ≠ó‰ª•ÂÜÖ]

„Ç¢„Éâ„Éê„Ç§„Çπ
[60ÊñáÂ≠ó‰ª•ÂÜÖ„ÄÇÊîπË°å„Åõ„Åö1Êñá„ÅßË®òËø∞]
`;

            const defaultReason = `
„ÅÇ„Å™„Åü„ÅØÊ∏©„Åã„Åø„ÅÆ„ÅÇ„Çã„Ç≠„É£„É™„Ç¢„Ç¢„Éâ„Éê„Ç§„Ç∂„Éº„Åß„Åô„ÄÇ
‰ª•‰∏ã„ÅÆÊ±ÇËÅ∑ËÄÖ„Å´ÂØæ„Åó„Å¶„ÄÅ„Åì„ÅÆÊ±Ç‰∫∫„ÇíÁ¥π‰ªã„Åô„ÇãÁêÜÁî±„Çí300ÊñáÂ≠óÁ®ãÂ∫¶„Åß‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
Ê±ÇËÅ∑ËÄÖ„ÅÆ„Åì„Çå„Åæ„Åß„ÅÆÁµåÈ®ì„ÇÑÂº∑„Åø„ÇíÂ∞äÈáç„Åó„ÄÅ„Åù„Çå„Çâ„ÅåÊ±Ç‰∫∫„ÅÆÁâπÂæ¥„ÇÑ‰ºÅÊ•≠„ÅÆÈ≠ÖÂäõ„Å®„Å©„ÅÆ„Çà„ÅÜ„Å´Áµê„Å≥„Å§„Åè„Åã„Çí„ÄÅ„Éù„Ç∏„ÉÜ„Ç£„Éñ„Åã„Å§È≠ÖÂäõÁöÑ„Å´‰ºù„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

„ÄêÊ±ÇËÅ∑ËÄÖÊÉÖÂ†±„Äë
- Âü∫Êú¨ÊÉÖÂ†±: Âπ¥ÈΩ¢ \${userData.age} / Â∏åÊúõÂπ¥Âèé \${userData.desired_salary}
- Â∏åÊúõÊù°‰ª∂: \${userData.desired_industry} / \${userData.desired_job_type}
- „Çπ„Ç≠„É´„ÉªPR: \${userData.notes}
- Â±•Ê≠¥Êõ∏/ÁµåÊ≠¥Êõ∏: \${userData.resume}
- ËÅ∑ÂãôÁµåÊ≠¥Ë©≥Á¥∞: \${userData.work_history}
- Á§æÂÜÖ„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÊÉÖÂ†±: \${userData.matching_info}

„ÄêÊ±Ç‰∫∫ÊÉÖÂ†±„Äë
- ‰ºÅÊ•≠Âêç: \${jobDetails.company}
- ËÅ∑Á®Æ: \${jobDetails.title}
- È≠ÖÂäõ„ÉªÊ•≠ÂãôÂÜÖÂÆπ: \${jobDetails.description}

ÊßãÊàê:
1. Êå®Êã∂„Å®Á¥π‰ªã„ÅÆÊÑèÂõ≥
2. Ê±ÇËÅ∑ËÄÖ„ÅÆÂº∑„Åø„Å®Ê±Ç‰∫∫„ÅÆÊé•ÁÇπ
3. „Åì„ÅÆÊ±Ç‰∫∫„Å´ÊåëÊà¶„Åô„Çã„É°„É™„ÉÉ„Éà„ÉªÊàêÈï∑ÂèØËÉΩÊÄß
4. Ê∏©„Åã„ÅÑÂøúÊè¥„É°„ÉÉ„Çª„Éº„Ç∏
`;

            const defaultRecommendationLetter = `
„ÅÇ„Å™„Åü„ÅØ‰∫∫ÊùêÁ¥π‰ªã‰ºöÁ§æ„ÅÆ„Ç®„Éº„Ç∏„Çß„É≥„Éà„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆÊ±ÇËÅ∑ËÄÖ„Çí‰ºÅÊ•≠„Å´Êé®Ëñ¶„Åô„Çã„Åü„ÇÅ„ÅÆÊé®Ëñ¶Êñá„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
400-600ÊñáÂ≠óÁ®ãÂ∫¶„Åß„ÄÅ‰ª•‰∏ã„ÅÆÊßãÊàê„Åß‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

„ÄêÊ±ÇËÅ∑ËÄÖÊÉÖÂ†±„Äë
- Ê∞èÂêç: \${userData.name}
- Âπ¥ÈΩ¢: \${userData.age}
- ÁèæËÅ∑: \${userData.current_position || 'N/A'}
- „Çπ„Ç≠„É´„ÉªÁµåÈ®ì: \${userData.notes}
- „Ç¢„Éî„Éº„É´„Éù„Ç§„É≥„Éà: \${userData.self_pr || 'N/A'}

„ÄêÂøúÂãüÂÖà‰ºÅÊ•≠„ÉªÊ±Ç‰∫∫„Äë
- ‰ºÅÊ•≠Âêç: \${jobDetails.company}
- ËÅ∑Á®Æ: \${jobDetails.title}

ÊßãÊàê:
1. ÂÜíÈ†≠„ÅÆÊå®Êã∂
2. Ê±ÇËÅ∑ËÄÖ„ÅÆÂº∑„Åø„Å®ÂÆüÁ∏æ
3. Ê±Ç‰∫∫„Å®„ÅÆ„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÁêÜÁî±
4. Êé®Ëñ¶„ÅÆÁµê„Å≥
`;

            const defaultScoutMessage = `
„ÅÇ„Å™„Åü„ÅØ‰ºÅÊ•≠„ÅÆÊé°Áî®ÊãÖÂΩìËÄÖ„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆÊ±ÇËÅ∑ËÄÖ„Å´ÂØæ„Åó„Å¶„ÄÅÈ≠ÖÂäõÁöÑ„Å™„Çπ„Ç´„Ç¶„Éà„É°„ÉÉ„Çª„Éº„Ç∏„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

„ÄêÊ±ÇËÅ∑ËÄÖÊÉÖÂ†±„Äë
- Ê∞èÂêç: \${candidateName}
- ÁèæËÅ∑: \${currentPosition}
- „Çπ„Ç≠„É´„ÉªÁµåÈ®ì: \${skills}
- Â∏åÊúõÊù°‰ª∂: \${desiredConditions}

„ÄêËá™Á§æ„ÉªÊ±Ç‰∫∫ÊÉÖÂ†±„Äë
- ‰ºÅÊ•≠Âêç: \${companyName}
- ËÅ∑Á®Æ: \${jobTitle}
- Ê•≠ÂãôÂÜÖÂÆπ: \${jobDescription}
- È≠ÖÂäõ: \${companyStrengths}
- ÂæÖÈÅá: \${benefits}

‰ª•‰∏ã„ÅÆÊßãÊàê„Åß„ÄÅ300-500ÊñáÂ≠óÁ®ãÂ∫¶„ÅÆ„Çπ„Ç´„Ç¶„Éà„É°„ÉÉ„Çª„Éº„Ç∏„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö

1. Ê±ÇËÅ∑ËÄÖ„Å∏„ÅÆÊï¨ÊÑè„Å®Èñ¢ÂøÉ„ÅÆË°®Êòé
2. Ëá™Á§æ„ÉªÊ±Ç‰∫∫„ÅÆÈ≠ÖÂäõ
3. Ê±ÇËÅ∑ËÄÖ„ÅÆ„Çπ„Ç≠„É´„Å®„ÅÆ„Éû„ÉÉ„ÉÅ„É≥„Ç∞
4. Èù¢Ë´á„ÉªÂøúÂãü„Å∏„ÅÆË™òÂ∞é
`;

            const prompts = [
                { key: 'ai_matching_scoring', label: defaultScoring.trim() },
                { key: 'ai_recommendation_reason', label: defaultReason.trim() },
                { key: 'recommendation_letter', label: defaultRecommendationLetter.trim() },
                { key: 'scout_message', label: defaultScoutMessage.trim() }
            ];

            try {
                // 1. Êó¢Â≠ò„ÅÆ„Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„Éà„ÇíÂèñÂæóÔºà„ÅÇ„Çå„Å∞‰∏äÊõ∏„ÅçÔºâ
                const { data: systemPrompts } = await supabase
                    .from('system_prompts')
                    .select('*')
                    .in('key', prompts.map(p => p.key));

                if (systemPrompts && systemPrompts.length > 0) {
                    systemPrompts.forEach(sp => {
                        const target = prompts.find(p => p.key === sp.key);
                        if (target) {
                            target.label = sp.content; // system_prompts„ÅÆÂÜÖÂÆπ„ÇíÂÑ™ÂÖà
                        }
                    });
                }

                // 2. Êó¢Â≠ò„ÅÆ„Éó„É≠„É≥„Éó„Éà„Éû„Çπ„Çø„ÇíÂâäÈô§ (Ëá™ÁµÑÁπî„ÅÆ„ÅøÂØæË±°)
                const { error: deleteError } = await supabase
                    .from('master_data')
                    .delete()
                    .eq('type', 'prompt')
                    .eq('organization_id', currentUser.organization_id);

                if (deleteError) throw deleteError;

                // 3. Êñ∞„Åó„ÅÑ„Éó„É≠„É≥„Éó„Éà„ÇíËøΩÂä†
                const insertData = prompts.map((p, index) => ({
                    type: 'prompt',
                    label: p.label, // „Éó„É≠„É≥„Éó„ÉàÊú¨Êñá
                    value: p.key,   // „Éó„É≠„É≥„Éó„Éà„Ç≠„Éº
                    sort_order: (index + 1) * 10,
                    is_active: true,
                    organization_id: currentUser.organization_id
                }));

                const { error: insertError } = await supabase
                    .from('master_data')
                    .insert(insertData);

                if (insertError) throw insertError;

                alert('„Éó„É≠„É≥„Éó„Éà„Éû„Çπ„Çø„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü„ÄÇÁîªÈù¢„Çí„É™„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                location.reload();

            } catch (error) {
                console.error('Error updating prompts:', error);
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }

        // AI Search Assistant UI Control
        window.toggleAISearch = function (type) {
            const boxId = type === 'job' ? '#job-ai-search-box' : '#candidate-ai-search-box';
            const $box = $(boxId);

            if ($box.hasClass('disabled')) return;

            $box.toggleClass('collapsed');
        }

        window.updateAISearchState = function (type, count) {
            const boxId = type === 'job' ? '#job-ai-search-box' : '#candidate-ai-search-box';
            const promptId = type === 'job' ? '#search-ai-prompt' : '#c-search-ai-prompt';
            const $box = $(boxId);

            console.log(`Updating AI search state for ${type}: count=${count}`);

            if (count > 0 && count < 500) {
                $box.removeClass('disabled');
            } else {
                $box.addClass('disabled');
                $box.addClass('collapsed');
            }
        }

        window.toggleAdvancedFilters = function () {
            const $container = $('#advanced-filters-body');
            const $btn = $('#toggle-advanced-filters');
            const isCollapsed = $container.hasClass('collapsed');

            if (isCollapsed) {
                $container.removeClass('collapsed');
                $btn.addClass('active');
                $btn.find('span').text('Èñâ„Åò„Çã');
                localStorage.setItem('search_filters_expanded', 'true');
            } else {
                $container.addClass('collapsed');
                $btn.removeClass('active');
                $btn.find('span').text('Ë©≥Á¥∞Êù°‰ª∂');
                localStorage.setItem('search_filters_expanded', 'false');
            }
        }

        // Initialize filter state from localStorage
        $(document).ready(function () {
            const expanded = localStorage.getItem('search_filters_expanded');
            if (expanded === 'true') {
                $('#advanced-filters-body').removeClass('collapsed');
                $('#toggle-advanced-filters').addClass('active').find('span').text('Èñâ„Åò„Çã');
            }
        });




        function populateSelectOptions(elementId, options, selectedValue = null) {
            const select = document.getElementById(elementId);
            if (!select) return;

            const currentVal = selectedValue || select.value;

            // Êó¢Â≠ò„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥ÔºàÊúÄÂàù„ÅÆ1„Å§ÁõÆÔºù„Éá„Éï„Ç©„É´„ÉàÈÅ∏ÊäûËÇ¢„Å™„Å©Ôºâ„Çí‰øùÊåÅ„Åô„Çã„Åã„ÄÅ
            // „ÅÇ„Çã„ÅÑ„ÅØ data-default-text Â±ûÊÄß„Å™„Å©„ÅßÁÆ°ÁêÜ„Åô„Çã„Åã„ÄÇ
            // „Åì„Åì„Åß„ÅØ„Ç∑„É≥„Éó„É´„Å´„ÄÅÊúÄÂàù„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥Ôºàvalue=""„ÅÆ„ÇÇ„ÅÆÔºâ„Å†„ÅëÊÆã„Åó„Å¶‰ªñ„ÇíÂâäÈô§„Åô„Çã
            const defaultOption = select.querySelector('option[value=""]');
            select.innerHTML = '';
            if (defaultOption) {
                select.appendChild(defaultOption);
            } else {
                // „Éá„Éï„Ç©„É´„Éà„Åå„Å™„ÅÑÂ†¥Âêà„ÅØËøΩÂä†„Åó„Å¶„Åä„Åè
                const opt = document.createElement('option');
                opt.value = "";
                opt.text = "ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
                select.appendChild(opt);
            }

            // „Éû„Çπ„Çø„Éá„Éº„Çø„ÅÆËøΩÂä†
            options.forEach(optVal => {
                const opt = document.createElement('option');
                opt.value = optVal;
                opt.text = optVal;
                select.appendChild(opt);
            });

            // ÈÅ∏ÊäûÂÄ§„ÅÆ„Çª„ÉÉ„Éà
            if (currentVal) {
                // „Éû„Çπ„Çø„Å´„Å™„ÅÑÂÄ§„ÅÆÂ†¥Âêà„ÄÅ‰∏ÄÊôÇÁöÑ„Å´ËøΩÂä†„Åô„Çã
                if (!options.includes(currentVal)) {
                    const opt = document.createElement('option');
                    opt.value = currentVal;
                    opt.text = currentVal; // (Êú™ÁôªÈå≤) „Å™„Å©„Çí„Å§„Åë„Å¶„ÇÇ„ÅÑ„ÅÑ„Åå„ÄÅ„Åù„ÅÆ„Åæ„ÅæË°®Á§∫
                    select.appendChild(opt);
                }
                select.value = currentVal;
            }
        }

        // ËÅ∑Ê≠¥ÂÖ•ÂäõÁî®„ÅÆdatalist„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
        function updateWorkHistoryDatalists() {
            // Ê•≠Áïå„É™„Çπ„Éà
            let industryDatalist = $('#master-industry-list');
            if (industryDatalist.length === 0) {
                if ($('body').length > 0) {
                    $('body').append('<datalist id="master-industry-list"></datalist>');
                } else {
                    return; // Body not ready
                }
                industryDatalist = $('#master-industry-list');
            }
            industryDatalist.empty();
            if (typeof masterIndustries !== 'undefined' && Array.isArray(masterIndustries)) {
                masterIndustries.forEach(item => {
                    industryDatalist.append(`<option value="${item}">`);
                });
            }

            // ËÅ∑Á®Æ„É™„Çπ„Éà
            let jobDatalist = $('#master-job-category-list');
            if (jobDatalist.length === 0) {
                if ($('body').length > 0) {
                    $('body').append('<datalist id="master-job-category-list"></datalist>');
                } else {
                    return;
                }
                jobDatalist = $('#master-job-category-list');
            }
            jobDatalist.empty();
            if (typeof masterJobCategories !== 'undefined' && Array.isArray(masterJobCategories)) {
                masterJobCategories.forEach(item => {
                    jobDatalist.append(`<option value="${item}">`);
                });
            }
        }

        // Select2ÂàùÊúüÂåñÁÆ°ÁêÜ
        const select2InitializedElements = new Set();

        function initializeSelect2(selector, options = {}) {
            const $element = $(selector);
            if ($element.length === 0) return;

            const elementId = $element.attr('id') || selector;

            // Êó¢„Å´ÂàùÊúüÂåñÊ∏à„Åø„ÅÆÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
            if (select2InitializedElements.has(elementId)) {
                return;
            }

            const defaultOptions = {
                language: "ja",
                width: 'resolve',
                ...options
            };

            $element.select2(defaultOptions);
            select2InitializedElements.add(elementId);
        }

        function destroySelect2(selector) {
            const $element = $(selector);
            if ($element.length === 0) return;

            const elementId = $element.attr('id') || selector;

            if (select2InitializedElements.has(elementId)) {
                $element.select2('destroy');
                select2InitializedElements.delete(elementId);
            }
        }

        function reinitializeSelect2(selector, options = {}) {
            destroySelect2(selector);
            initializeSelect2(selector, options);
        }

        function showLoading(message = 'Ë™≠„ÅøËæº„Åø‰∏≠...') {
            $('#loading-screen').removeClass('hidden').find('p').text(message)
        }
        window.showLoading = showLoading;

        // --- Import Progress Helpers ---
        let importStartTime = 0;
        function showImportProgress(title, subtitle) {
            importStartTime = Date.now();
            $('#import-progress-title').text(title);
            $('#import-progress-subtitle').text(subtitle || '„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÇíÈñâ„Åò„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ');
            $('#import-progress-modal').removeClass('hidden');
            $('#import-progress-bar').css('width', '0%');
            $('#import-progress-percent').text('0%');
            $('#import-progress-eta').text('ÊÆã„ÇäÁ¥Ñ -- ÂàÜ');
            $('#import-progress-steps').empty();
        }

        function updateImportProgress(percent, processedCount, totalCount) {
            const safePercent = Math.min(Math.round(percent), 100);
            $('#import-progress-bar').css('width', safePercent + '%');
            $('#import-progress-percent').text(safePercent + '%');

            if (processedCount > 0 && totalCount > 0) {
                const elapsed = Date.now() - importStartTime;
                const avgPerItem = elapsed / processedCount;
                const remaining = totalCount - processedCount;
                const etaMs = avgPerItem * remaining;
                const etaMin = Math.ceil(etaMs / 1000 / 60);
                const etaSec = Math.ceil((etaMs / 1000) % 60);

                if (etaMin > 1) {
                    $('#import-progress-eta').text(`ÊÆã„ÇäÁ¥Ñ ${etaMin} ÂàÜ`);
                } else {
                    $('#import-progress-eta').text(`ÊÆã„ÇäÁ¥Ñ ${etaSec} Áßí`);
                }
            }
        }

        function addImportStep(id, label, icon = 'fa-circle') {
            const stepHtml = `
                <div id="step-${id}" class="flex items-center gap-4 text-slate-300 transition-colors duration-300">
                    <div class="w-6 h-6 rounded-full border-2 border-current flex items-center justify-center text-[10px] shrink-0">
                        <i class="fas ${icon}"></i>
                    </div>
                    <span class="text-sm font-bold text-current">${label}</span>
                </div>
            `;
            $('#import-progress-steps').append(stepHtml);
        }

        function setImportStepStatus(id, status) {
            const $step = $(`#step-${id}`);
            if (status === 'active') {
                $step.removeClass('text-slate-200 text-green-500').addClass('text-indigo-600');
                $step.find('i').removeClass('fa-check fa-circle').addClass('fa-circle-notch fa-spin');
            } else if (status === 'done') {
                $step.removeClass('text-slate-200 text-indigo-600').addClass('text-green-500');
                $step.find('i').removeClass('fa-circle-notch fa-spin fa-circle').addClass('fa-check');
            } else if (status === 'pending') {
                $step.removeClass('text-indigo-600 text-green-500').addClass('text-slate-200');
                $step.find('i').removeClass('fa-check fa-circle-notch fa-spin').addClass('fa-circle');
            }
        }

        function hideImportProgress() {
            $('#import-progress-modal').addClass('hidden');
        }

        function hideLoading() {
            $('#loading-overlay').addClass('hidden')
        }
        window.hideLoading = hideLoading;

        function showError(elementId, message) {
            $(`#${elementId}`).text(message).removeClass('hidden')
        }

        function hideError(elementId) {
            $(`#${elementId}`).addClass('hidden')
        }

        // ========================
        // Lazy Loading Management
        // ========================
        const loadedPages = new Set();

        // ÁîªÂÉè„ÅÆLazy Loading
        function initImageLazyLoading() {
            // Intersection Observer „Çí‰ΩøÁî®„Åó„ÅüÁîªÂÉè„ÅÆÈÅÖÂª∂Ë™≠„ÅøËæº„Åø
            if ('IntersectionObserver' in window) {
                const imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            const src = img.getAttribute('data-src');
                            if (src) {
                                img.src = src;
                                img.removeAttribute('data-src');
                                observer.unobserve(img);
                            }
                        }
                    });
                });

                // data-srcÂ±ûÊÄß„ÇíÊåÅ„Å§„Åô„Åπ„Å¶„ÅÆÁîªÂÉè„ÇíÁõ£Ë¶ñ
                document.querySelectorAll('img[data-src]').forEach(img => {
                    imageObserver.observe(img);
                });
            } else {
                // Intersection Observer ÈùûÂØæÂøú„ÅÆÂ†¥Âêà„ÅØÂç≥Â∫ß„Å´Ë™≠„ÅøËæº„Åø
                document.querySelectorAll('img[data-src]').forEach(img => {
                    const src = img.getAttribute('data-src');
                    if (src) {
                        img.src = src;
                        img.removeAttribute('data-src');
                    }
                });
            }
        }

        function showPage(pageId) {
            $('.page').removeClass('active')
            $(`#${pageId}`).addClass('active')
        }

        let isChangingContent = false;
        async function showAppContent(contentId) {
            if (isChangingContent) return;
            isChangingContent = true;

            try {
                $('.app-content').addClass('hidden')
                const $target = $(`#${contentId}`);
                $target.removeClass('hidden')

                // ÁîªÈù¢ÈÅ∑ÁßªÊôÇ„Å´Ê§úÁ¥¢Êù°‰ª∂„Çí„É™„Çª„ÉÉ„ÉàÔºàÊÑèÂõ≥„Åó„Å™„ÅÑAIÂÆüË°å„ÇíÈò≤„ÅêÔºâ
                try {
                    if (contentId === 'jobs-content') {
                        if (typeof window.clearSearch === 'function') window.clearSearch();
                    } else if (contentId === 'candidates-content') {
                        if (typeof window.clearCandidateSearch === 'function') window.clearCandidateSearch();
                    }
                } catch (e) {
                    console.error('Clear filters error during transition:', e);
                }

                // ÁÆ°ÁêÜËÄÖÁ≥ª„Éö„Éº„Ç∏Ôºà„Éò„ÉÉ„ÉÄ„ÉºÈáçË§á„Éª‰ΩôÁôΩÂØæÁ≠ñ„ÅåÂøÖË¶Å„Å™„Éö„Éº„Ç∏Ôºâ„ÅÆ„É™„Çπ„Éà
                const adminPages = [
                    'admin-prompts-content',
                    'admin-jobs-content',
                    'admin-companies-content',
                    'admin-applicants-content',
                    'admin-candidates-content',
                    'admin-users-content',
                    'admin-csv-content',
                    'admin-log-content',
                    'admin-master-content',
                    'admin-settings-content',
                    'admin-data-management-content',
                    'kpi-dashboard-content',
                    'admin-yomi-management-content',
                    'admin-templates-content',
                    'admin-faqs-content',
                    'super-admin-organizations-content',
                    'coach-students-content'
                ];

                // ÁÆ°ÁêÜËÄÖÁ≥ª„Éö„Éº„Ç∏„ÅÆÂ†¥Âêà„ÅØ„Éò„ÉÉ„ÉÄ„Éº„ÇíÈö†„Åó„ÄÅË¶ÅÁ¥†„ÇíÊúÄ‰∏äÈÉ®„Å´ÁßªÂãï
                if (adminPages.includes(contentId)) {
                    $('header').addClass('hidden');
                    // Âº∑Âà∂ÁöÑ„Å´main-content„ÅÆÂÖàÈ†≠„Å´ÁßªÂãïÔºàË¶ã„Åà„Å™„ÅÑË¶ÅÁ¥†„Å´„Çà„Çã‰ΩôÁôΩÊéíÈô§Ôºâ
                    $('.main-content').prepend($target);
                } else {
                    $('header').removeClass('hidden');
                }

                // „Éö„Éº„Ç∏ÈÅ∑ÁßªÊôÇ„Å´„Éï„É≠„Éº„Éà„Éê„Éº„ÇíÈùûË°®Á§∫„Å´„Åó„ÄÅ‰ΩôÁôΩ„Çí„É™„Çª„ÉÉ„Éà
                $('#bulk-recommend-bar, #candidate-float-bar').addClass('hidden translate-y-full').removeClass('translate-y-0');
                $('#jobs-container, #candidate-results-container').css('padding-bottom', '0');

                // Ê±Ç‰∫∫Ê§úÁ¥¢„Éö„Éº„Ç∏„ÅåË°®Á§∫„Åï„Çå„ÅüÂ†¥Âêà„ÄÅ‰øùÂ≠ò„Åï„Çå„ÅüÊ§úÁ¥¢Êù°‰ª∂„ÇíÈÅ©Áî®
                if (contentId === 'jobs-content') {
                    // loadSearchFiltersÈñ¢Êï∞„ÅåÂÆöÁæ©„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™çÔºàÂàùÊúüÂåñÂâçÂØæÁ≠ñÔºâ
                    if (typeof loadSearchFilters === 'function' && typeof applySearchFilters === 'function') {
                        // „Éû„Çπ„Çø„Éá„Éº„Çø„Åå„É≠„Éº„ÉâÊ∏à„Åø„ÅÆÂ†¥Âêà„ÅÆ„ÅøÈÅ©Áî®ÔºàÊú™„É≠„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØloadJobsÂÜÖ„ÅßÈÅ©Áî®„Åï„Çå„ÇãÔºâ
                        if (isSearchMasterLoaded) {
                            const savedFilters = loadSearchFilters();
                            if (savedFilters) {
                                console.log('Auto-applying saved filters for jobs page (Master loaded)');
                                applySearchFilters(savedFilters);
                            }
                        }
                    }
                }

                if (contentId === 'admin-data-management-content') {
                    if (typeof loadDataCleanupSettings === 'function') {
                        loadDataCleanupSettings();
                    }
                }

                // ÈÅÖÂª∂„É≠„Éº„Éâ: ÂàùÂõû„Ç¢„ÇØ„Çª„ÇπÊôÇ„ÅÆ„Åø„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„ÇÄ
                if (!loadedPages.has(contentId)) {
                    console.log(`Lazy loading data for: ${contentId}`);

                    try {
                        switch (contentId) {
                            case 'recommendations-content':
                                // Êé®Ëñ¶‰∏ÄË¶ß„ÅØÂàùÂõû„ÅÆ„Åø„É≠„Éº„Éâ
                                if (typeof loadRecommendations === 'function') {
                                    await loadRecommendations();
                                }
                                break;

                            case 'admin-users-content':
                                // „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ„ÅØÂàùÂõû„ÅÆ„Åø„É≠„Éº„Éâ
                                if (typeof loadUsers === 'function') {
                                    await loadUsers();
                                }
                                break;

                            case 'admin-companies-content':
                                // ‰ºÅÊ•≠ÁÆ°ÁêÜ„ÅØÂàùÂõû„ÅÆ„Åø„É≠„Éº„Éâ
                                if (typeof loadCompanies === 'function') {
                                    await loadCompanies();
                                }
                                break;

                            case 'coach-students-content':
                                if (typeof loadCoachStudents === 'function') {
                                    await loadCoachStudents();
                                }
                                break;

                            // ‰ªñ„ÅÆ„Éö„Éº„Ç∏„ÇÇÂøÖË¶Å„Å´Âøú„Åò„Å¶ËøΩÂä†
                        }

                        loadedPages.add(contentId);
                    } catch (error) {
                        console.error(`Error lazy loading ${contentId}:`, error);
                    }
                } else {
                    console.log(`Using cached data for: ${contentId}`);
                }
            } finally {
                isChangingContent = false;
            }
        }

        // ========================
        // Audit Log Helper
        // ========================
        /**
         * Êìç‰Ωú„É≠„Ç∞„ÇíË®òÈå≤„Åô„Çã
         * @param {string} action - Êìç‰Ωú„ÅÆÁ®ÆÈ°û
         * @param {string} targetType - ÂØæË±°„ÅÆ„Çø„Ç§„Éó
         * @param {string} targetId - ÂØæË±°„ÅÆID
         * @param {object} details - Ë©≥Á¥∞ÊÉÖÂ†±
         * @param {object} user - ÂÆüË°å„É¶„Éº„Ç∂„ÉºÔºàÁúÅÁï•ÊôÇ„ÅØwindow.currentUser„Çí‰ΩøÁî®Ôºâ
         */
        async function logAuditAction(action, targetType, targetId, details = {}, user = null) {
            try {
                const actor = user || window.currentUser;

                if (!actor) {
                    console.warn('Cannot log action: user is null');
                    return;
                }

                const logEntry = {
                    user_id: actor.id,
                    organization_id: actor.organization_id,
                    action: action,
                    resource_type: targetType, // Ê≠£„Åó„ÅÑ„Ç´„É©„É†Âêç: resource_type
                    resource_id: targetId,     // Ê≠£„Åó„ÅÑ„Ç´„É©„É†Âêç: resource_id (Êé®Ê∏¨)
                    // details: details,       // „Ç´„É©„É†„ÅåÂ≠òÂú®„Åó„Å™„ÅÑ„Åü„ÇÅÈô§Â§ñ
                    ip_address: null,
                    user_agent: navigator.userAgent,
                    created_at: new Date().toISOString()
                };

                // ÈùûÂêåÊúü„Åß„É≠„Ç∞„ÇíË®òÈå≤
                const { error } = await supabase
                    .from('audit_logs')
                    .insert(logEntry);

                if (error) {
                    console.error('Audit log insert error:', error);
                }

            } catch (error) {
                console.error('Failed to log audit action:', error);
            }
        }

        // „Çà„Åè‰Ωø„ÅÜÊìç‰Ωú„ÅÆ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„ÉàÈñ¢Êï∞
        const auditLog = {
            // „É¶„Éº„Ç∂„ÉºÈñ¢ÈÄ£
            userCreated: (userId, details) => logAuditAction('create', 'user', userId, details),
            userUpdated: (userId, details) => logAuditAction('update', 'user', userId, details),
            userDeleted: (userId, details) => logAuditAction('delete', 'user', userId, details),

            // Ê±Ç‰∫∫Èñ¢ÈÄ£
            jobCreated: (jobId, details) => logAuditAction('create', 'job', jobId, details),
            jobUpdated: (jobId, details) => logAuditAction('update', 'job', jobId, details),
            jobDeleted: (jobId, details) => logAuditAction('delete', 'job', jobId, details),

            // ÂøúÂãüÈñ¢ÈÄ£
            applicationSubmitted: (applicationId, details) => logAuditAction('apply', 'application', applicationId, details),

            // AIÊé®Ëñ¶Èñ¢ÈÄ£
            recommendationCreated: (recommendationId, details) => logAuditAction('recommend', 'recommendation', recommendationId, details),
            bulkRecommendationExecuted: (count, details) => logAuditAction('bulk_recommend', 'recommendation', null, { count, ...details }),

            // Ë™çË®ºÈñ¢ÈÄ£Ôºà„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÊòéÁ§∫ÁöÑ„Å´Ê∏°„ÅôÔºâ
            userLoggedIn: (user) => logAuditAction('login', 'auth', user?.id || 'unknown', { email: user?.email }, user),
            userLoggedOut: () => logAuditAction('logout', 'auth', window.currentUser?.id || 'unknown', { email: window.currentUser?.email }),

            // ‰ºÅÊ•≠Èñ¢ÈÄ£
            companyCreated: (companyId, details) => logAuditAction('create', 'company', companyId, details),
            companyUpdated: (companyId, details) => logAuditAction('update', 'company', companyId, details),
            companyDeleted: (companyId, details) => logAuditAction('delete', 'company', companyId, details),

            // CSVÈñ¢ÈÄ£
            csvImported: (type, count, details) => logAuditAction('csv_import', type, null, { count, ...details }),

            // „Éó„É≠„É≥„Éó„ÉàÈñ¢ÈÄ£
            promptUpdated: (promptKey, details) => logAuditAction('update', 'prompt', promptKey, details)
        };


        // ========================
        // Authentication
        // ========================
        async function login(email, password) {
            showLoading()
            hideError('login-error')

            try {
                // Supabase Auth „Åß„É≠„Ç∞„Ç§„É≥
                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                    email,
                    password
                })

                if (authError) throw authError

                const userId = authData.user.id;

                // ---------------------------------------------------------
                // ÁµÑÁπîÊâÄÂ±ûÊÉÖÂ†±„ÅÆÁ¢∫Ë™ç (Multi-tenant check)
                // ---------------------------------------------------------
                const { data: memberships, error: memError } = await supabase
                    .from('organization_members')
                    .select('organization_id, organizations(name, code, status, settings)')
                    .eq('user_id', userId);

                console.log('Login Debug: User ID', userId);
                console.log('Login Debug: Memberships found', memberships);
                if (memError) console.error('Login Debug: Membership Error', memError);

                if (memError) {
                    console.error('Membership fetch error:', memError);
                    throw new Error('ÊâÄÂ±ûÁµÑÁπîÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }

                if (!memberships || memberships.length === 0) {
                    // ÊâÄÂ±û„Åå„Å™„ÅÑÂ†¥Âêà (ÈÄöÂ∏∏„ÅÇ„Çä„Åà„Å™„ÅÑ„Åå„ÄÅ‰∏çÊï¥ÂêàÂØæÁ≠ñ)
                    throw new Error('ÊâÄÂ±û„Åô„ÇãÁµÑÁπî„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                }

                // „É¶„Éº„Ç∂„Éº„Éó„É≠„Éï„Ç°„Ç§„É´„ÇíÂèñÂæó (Base Profile)
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', userId)
                    .maybeSingle();

                if (userError || !userData) {
                    throw new Error('„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }

                let targetOrgId = userData.organization_id; // Default to current setting
                let targetOrgName = '';

                // Ë§áÊï∞ÁµÑÁπî„Å´ÊâÄÂ±û„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅ„Åæ„Åü„ÅØÁèæÂú®„ÅÆË®≠ÂÆö„ÅåÁÑ°Âäπ„Å™Â†¥Âêà
                if (memberships.length > 1) {
                    // ÈÅ∏Êäû„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫„Åó„Å¶„É¶„Éº„Ç∂„Éº„Å´ÈÅ∏„Å∞„Åõ„Çã
                    // „Åì„Åì„Åß‰∏ÄÊó¶Âá¶ÁêÜ„Çí‰∏≠Êñ≠„Åó„ÄÅ„É¶„Éº„Ç∂„ÉºÂÖ•Âäõ„ÇíÂæÖ„Å§ÂøÖË¶Å„Åå„ÅÇ„Çã„Åü„ÇÅ„ÄÅPromise„Åß„É©„ÉÉ„Éó„Åô„ÇãÂÆüË£Ö„Å´„Åô„Çã„Åã„ÄÅ
                    // „ÅÇ„Çã„ÅÑ„ÅØ„Ç∑„É≥„Éó„É´„Å™UIË°®Á§∫Âàá„ÇäÊõø„Åà„ÅßÂÆüË£Ö„Åô„Çã„ÄÇ
                    // „Åì„Åì„Åß„ÅØ„Äå„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫„Åó„ÄÅÈÅ∏Êäû„Åï„Çå„Åü„ÇâÂæåÁ∂öÂá¶ÁêÜ„ÇíÂÆüË°å„Åô„Çã„ÄçÈñ¢Êï∞„Å´Âàá„ÇäÂàÜ„Åë„Çã„ÅÆ„ÅåÈÅ©Âàá„Å†„Åå„ÄÅ
                    // loginÈñ¢Êï∞ÂÜÖ„ÅßÂÆåÁµê„Åï„Åõ„Çã„Åü„ÇÅ„ÄÅ‰∏ÄÊôÇÁöÑ„Å´UI„ÇíË°®Á§∫„Åó„Å¶„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ„ÇíÂæÖ„Å§ÂΩ¢„Çí„Å®„Çã„ÄÇ

                    hideLoading(); // „É≠„Éº„Éá„Ç£„É≥„Ç∞‰∏ÄÊó¶Ëß£Èô§

                    // ÁµÑÁπîÈÅ∏Êäû„É≠„Ç∏„ÉÉ„ÇØ (Promise wrapper)
                    const selectedOrg = await new Promise((resolve) => {
                        const modal = $('#org-select-modal');
                        const list = $('#org-select-list');
                        list.empty();

                        memberships.forEach(m => {
                            const org = m.organizations;
                            // ÂÅúÊ≠¢‰∏≠„ÅÆÁµÑÁπî„ÅØÈô§Â§ñ„Åô„Çã„Å™„Å©ÂèØËÉΩ„Å†„Åå„ÄÅ‰∏ÄÊó¶„Åô„Åπ„Å¶Ë°®Á§∫
                            const btn = $(`
                                <button class="w-full text-left px-4 py-3 bg-indigo-50 hover:bg-indigo-100 border border-indigo-200 rounded-lg transition items-center flex justify-between group">
                                    <div>
                                        <div class="font-bold text-indigo-900">${org.name}</div>
                                        <div class="text-xs text-indigo-500">${org.code || ''}</div>
                                    </div>
                                    <i class="fas fa-chevron-right text-indigo-300 group-hover:text-indigo-600"></i>
                                </button>
                            `);
                            btn.on('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                modal.addClass('hidden');
                                resolve({ id: m.organization_id, name: org.name });
                            });

                            list.append(btn);
                        });

                        modal.removeClass('hidden');
                    });

                    showLoading('„É≠„Ç∞„Ç§„É≥Âá¶ÁêÜ‰∏≠...'); // „É≠„Éº„Éá„Ç£„É≥„Ç∞ÂÜçÈñã

                    targetOrgId = selectedOrg.id;
                    targetOrgName = selectedOrg.name;

                    // „É¶„Éº„Ç∂„Éº„ÅÆ„Éá„Éï„Ç©„É´„ÉàÁµÑÁπî„ÇíÊõ¥Êñ∞„Åó„Å¶„Åä„ÅèÔºàÊ¨°Âõû„É≠„Ç∞„Ç§„É≥ÊôÇ„ÅÆÂÑ™ÂÖàÂÄôË£ú„Å®„Åó„Å¶Ôºâ
                    // ‚Äª RLS„Ç®„É©„Éº„Å´„Å™„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çã„Åü„ÇÅ„ÄÅÂ§±Êïó„Åó„Å¶„ÇÇÁÑ°Ë¶ñ„Åô„Çã
                    await supabase.from('users').update({ organization_id: targetOrgId }).eq('id', userId);

                } else {
                    // 1„Å§„Å†„Åë„ÅÆÂ†¥Âêà„ÄÅ„Åù„Çå„ÇíÁ¢∫ÂÆö
                    targetOrgId = memberships[0].organization_id;
                    // targetOrgName = memberships[0].organizations.name; // select„ÅÆÊßãÈÄ†„Å´„Çà„Çã
                }

                // currentUser„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíÊßãÁØâ
                // userData„Å´„ÅØÂè§„ÅÑ organization_id „ÅåÂÖ•„Å£„Å¶„ÅÑ„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çã„Åü„ÇÅ‰∏äÊõ∏„Åç
                const selectedMembership = memberships.find(m => m.organization_id === targetOrgId);
                currentUser = {
                    ...userData,
                    organization_id: targetOrgId,
                    organizations: {
                        name: targetOrgName || selectedMembership?.organizations?.name,
                        settings: selectedMembership?.organizations?.settings || {}
                    }
                };
                window.currentUser = currentUser;

                // „Çπ„ÉÜ„Éº„Çø„Çπ„ÉÅ„Çß„ÉÉ„ÇØ (Âà©Áî®ÂÅúÊ≠¢‰∏≠„ÅÆÂ†¥Âêà„ÅØ„É≠„Ç∞„Ç¢„Ç¶„Éà)
                if (userData.status === 'suspended') {
                    await supabase.auth.signOut();
                    currentUser = null;
                    window.currentUser = null;
                    throw new Error('„Åì„ÅÆ„Ç¢„Ç´„Ç¶„É≥„Éà„ÅØÂà©Áî®„ÅåÂÅúÊ≠¢„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇÁÆ°ÁêÜËÄÖ„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ');
                }

                // „É≠„Ç∞„Ç§„É≥Â±•Ê≠¥„ÇíË®òÈå≤
                await supabase
                    .from('login_history')
                    .insert({
                        organization_id: currentUser.organization_id,
                        user_id: currentUser.id,
                        name: currentUser.name,
                        email: currentUser.email,
                        user_agent: navigator.userAgent
                    })

                // ÁÆ°ÁêÜËÄÖ„É°„Éã„É•„Éº„ÅÆË°®Á§∫Âà∂Âæ°
                if (userData.role === 'org_admin' || userData.role === 'admin' || userData.role === 'super_admin') {
                    $('#admin-menu').removeClass('hidden')
                } else {
                    $('#admin-menu').addClass('hidden')
                }

                // „Çπ„Éº„Éë„ÉºÁÆ°ÁêÜËÄÖ„É°„Éã„É•„Éº„ÅÆË°®Á§∫Âà∂Âæ°
                if (userData.role === 'super_admin') {
                    $('#super-admin-menu').removeClass('hidden')
                } else {
                    $('#super-admin-menu').addClass('hidden')
                }

                // „Ç≥„Éº„ÉÅ„É°„Éã„É•„Éº„ÅÆË°®Á§∫Âà∂Âæ°
                if (userData.role === 'coach') {
                    $('#coach-menu').removeClass('hidden')
                } else {
                    $('#coach-menu').addClass('hidden')
                }

                // Â§ñÈÉ®„Éó„É≠„Éï„Ç£„Éº„É´Ëß£Êûê„É°„Éã„É•„Éº„ÅÆË°®Á§∫Âà∂Âæ°
                if (['org_admin', 'admin', 'super_admin', 'coach'].includes(userData.role)) {
                    $('#ai-scout-link').removeClass('hidden')
                } else {
                    $('#ai-scout-link').addClass('hidden')
                }

                // „Çµ„Ç§„Éâ„Éê„Éº„ÅÆ„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÊõ¥Êñ∞
                $('#user-name').text(currentUser.name)
                $('#user-role').text(getRoleLabel(currentUser.role))
                $('#org-name').text(currentUser.organizations?.name || '')
                $('#org-code-display').text(currentUser.organizations?.code ? `„Ç≥„Éº„Éâ: ${currentUser.organizations.code}` : '')

                // „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„É°„Éã„É•„Éº„ÅÆË°®Á§∫Âà∂Âæ°ÔºàÊ±ÇËÅ∑ËÄÖ„ÅØÈùûË°®Á§∫Ôºâ
                if (userData.role === 'candidate') {
                    $('#nav-dashboard').addClass('hidden')
                } else {
                    $('#nav-dashboard').removeClass('hidden')
                }

                // „É≠„Ç∞„Ç§„É≥Âæå„ÅÆÂàùÊúüÁîªÈù¢„ÇíË®≠ÂÆö
                if (userData.role === 'candidate') {
                    // Ê±ÇËÅ∑ËÄÖ„ÅÆÂ†¥Âêà„ÅØÊ±Ç‰∫∫Ê§úÁ¥¢ÁîªÈù¢„ÇíË°®Á§∫
                    await loadJobs()
                    showAppContent('jobs-content')
                    $('.nav-link[data-page="jobs"]').addClass('bg-indigo-50 text-indigo-600')
                } else {
                    // „Åù„ÅÆ‰ªñ„ÅÆ„É¶„Éº„Ç∂„Éº„ÅØ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„ÇíË°®Á§∫
                    await loadDashboard()
                    $('.nav-link[data-page="dashboard"]').addClass('bg-indigo-50 text-indigo-600')
                }

                loadNotifications()
                showPage('app-page')
                isInitialLoad = false;
                // $('#ai-search-agent-trigger').attr('style', 'display: flex !important'); // Temporarily OFF

                // „É≠„Ç∞„Ç§„É≥Êìç‰Ωú„ÇíË®òÈå≤Ôºà„É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„ÇíÊ∏°„ÅôÔºâ
                await auditLog.userLoggedIn(currentUser);



            } catch (error) {
                console.error('Login error:', error)
                showError('login-error', error.message || '„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü')
            } finally {
                hideLoading()
            }
        }

        async function signup(name, furigana, email, password, invitationToken, orgCode) {
            showLoading()
            hideError('signup-error')

            try {
                let organizationId = null;
                let role = 'candidate'; // Default role for public signup is Candidate
                let invitationId = null;

                // 1. ÊãõÂæÖ„Éà„Éº„ÇØ„É≥„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆÊ§úË®º
                if (invitationToken) {
                    const { data: invitation, error: invError } = await supabase
                        .rpc('get_invitation_by_token', { token_input: invitationToken })
                        .single()

                    if (invError || !invitation) {
                        throw new Error('ÁÑ°Âäπ„Å™ÊãõÂæÖ„É™„É≥„ÇØ„Åß„Åô')
                    }
                    if (new Date(invitation.expires_at) < new Date()) {
                        throw new Error('ÊãõÂæÖ„É™„É≥„ÇØ„ÅÆÊúâÂäπÊúüÈôê„ÅåÂàá„Çå„Å¶„ÅÑ„Åæ„Åô')
                    }
                    if (invitation.accepted_at) {
                        throw new Error('„Åì„ÅÆÊãõÂæÖ„É™„É≥„ÇØ„ÅØÊó¢„Å´‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„Åæ„Åô')
                    }
                    organizationId = invitation.organization_id;
                    role = invitation.role;
                    invitationId = invitation.id;
                }
                // 2. ÁµÑÁπî„Ç≥„Éº„Éâ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆÊ§úË®º
                else if (orgCode) {
                    const { data: orgData, error: orgError } = await supabase
                        .rpc('get_organization_name_by_code', { org_code: orgCode })

                    if (orgError || !orgData || orgData.length === 0) {
                        throw new Error('ÁÑ°Âäπ„Å™ÁµÑÁπî„Ç≥„Éº„Éâ„Åß„Åô');
                    }
                    organizationId = orgData[0].id;
                    // role „ÅØ„Éá„Éï„Ç©„É´„Éà„Åß 'user'
                } else {
                    throw new Error('ÊãõÂæÖ„É™„É≥„ÇØ„Åæ„Åü„ÅØÁµÑÁπî„Ç≥„Éº„Éâ„ÅåÂøÖË¶Å„Åß„Åô');
                }

                console.log('Attempting signup with:', { email, name, organizationId, role })

                // 3. Supabase Auth„Åß„Çµ„Ç§„É≥„Ç¢„ÉÉ„Éó
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        emailRedirectTo: 'https://rightjob2025.github.io/matching/index-supabase.html',
                        data: {
                            name: name,
                            organization_id: organizationId
                        }
                    }
                });

                if (authError) {
                    // „Åô„Åß„Å´ÁôªÈå≤Ê∏à„Åø„ÅÆ„É¶„Éº„Ç∂„Éº„ÅÆÂ†¥Âêà
                    if (authError.message.includes("already registered")) {
                        if (invitationToken) {
                            console.log('User already exists, attempting to link via invitation token...');
                            // Êó¢Â≠ò„É¶„Éº„Ç∂„Éº„ÇíÁµÑÁπî„Å´Á¥ê‰ªò„Åë„ÇãRPC„ÇíÂëº„Å≥Âá∫„Åó
                            const { data: rpcRes, error: rpcError } = await supabase.rpc('join_organization_by_invite', {
                                target_email: email,
                                invite_token: invitationToken
                            });

                            if (rpcError) throw rpcError;

                            if (rpcRes && rpcRes.success) {
                                alert('„Åô„Åß„Å´„Ç¢„Ç´„Ç¶„É≥„Éà„Çí„ÅäÊåÅ„Å°„ÅÆ„Åü„ÇÅ„ÄÅ„Åì„ÅÆÁµÑÁπî„Å∏„ÅÆÁôªÈå≤„ÇíÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                                showPage('login-page');
                                return;
                            } else {
                                throw new Error(rpcRes?.message || 'ÁµÑÁπî„Å∏„ÅÆÂèÇÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                            }
                        } else {
                            throw new Error('„Åì„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅØÊó¢„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„É≠„Ç∞„Ç§„É≥„Åô„Çã„Åã„ÄÅÊãõÂæÖ„É™„É≥„ÇØ„Åã„ÇâÂÜçÂ∫¶ÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        }
                    }
                    throw authError;
                }

                if (authData.user) {
                    console.log('Auth user created:', authData.user.id);

                    // 4. Users„ÉÜ„Éº„Éñ„É´„Å´„É¨„Ç≥„Éº„Éâ‰ΩúÊàê
                    // NOTE: RLS„Å´„Çà„Çä„ÄÅËá™ÂàÜËá™Ë∫´„ÅÆID„Åß„ÅÆ„ÅøINSERTÂèØËÉΩ
                    const { error: insertError } = await supabase
                        .from('users')
                        .insert({
                            id: authData.user.id,
                            email: email,
                            name: name,
                            furigana: furigana,
                            role: role,
                            organization_id: organizationId, // „É¨„Ç¨„Ç∑„Éº‰∫íÊèõ
                            is_active: true
                        });

                    if (insertError) {
                        // Êó¢„Å´„É¶„Éº„Ç∂„Éº„É¨„Ç≥„Éº„Éâ„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥ÂêàÔºà„É°„Éº„É´„Ç¢„Éâ„É¨„ÇπÈáçË§á„Å™„Å©Ôºâ
                        if (insertError.code === '23505') {
                            console.log('User already exists in DB. Resolving ID and linking to this org...');

                            const { data: finalUserId, error: rpcError } = await supabase
                                .rpc('get_user_id_by_email', { target_email: email });

                            if (rpcError || !finalUserId) {
                                console.error('Failed to resolve existing user via RPC:', rpcError);
                                throw new Error('Êó¢Â≠ò„ÅÆ„Ç¢„Ç´„Ç¶„É≥„ÉàÊÉÖÂ†±„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ');
                            }

                            console.log('Target User ID resolved:', finalUserId);

                            const { error: memberError } = await supabase
                                .from('organization_members')
                                .insert({
                                    organization_id: organizationId,
                                    user_id: finalUserId,
                                    role: role
                                });

                            if (memberError) {
                                if (memberError.code === '23505') {
                                    console.log('User is already a member of this organization.');
                                } else {
                                    console.error('Failed to add existing user to members:', memberError);
                                    throw new Error('ÁµÑÁπî„Å∏„ÅÆÂä†ÂÖ•„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + memberError.message);
                                }
                            } else {
                                console.log('Successfully added existing user to organization_members.');
                            }
                        } else {
                            console.error('Unexpected DB insert error:', insertError);
                            throw new Error('„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÅÆ‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + insertError.message);
                        }
                    }
                    else {
                        // Êñ∞„Åó„Åè„É¶„Éº„Ç∂„Éº„É¨„Ç≥„Éº„Éâ„Åå‰ΩúÊàê„Åï„Çå„ÅüÂ†¥Âêà„ÄÅ„Éà„É™„Ç¨„Éº„ÅåËá™ÂãïÁöÑ„Å´ members „Å´ÂÖ•„Çå„Çã„Åã„ÄÅ
                        // „Åæ„Åü„ÅØÊâãÂãï„ÅßÔºà„Éà„É™„Ç¨„Éº„Åå„Å™„ÅÑÁí∞Â¢É„ÅÆÂ†¥ÂêàÔºâËøΩÂä†„ÇíÁ¢∫Ë™ç
                        console.log('New user record created successfully.');
                    }

                    // 5. ÊãõÂæÖ„Ç≥„Éº„Éâ„Çí‰ΩøÁî®„Åó„ÅüÂ†¥Âêà„ÅØ‰ΩøÁî®Ê∏à„Åø„Å´Êõ¥Êñ∞
                    if (invitationId) {
                        await supabase
                            .from('invitations')
                            .update({ accepted_at: new Date().toISOString() })
                            .eq('id', invitationId);
                    }

                    alert('ÁôªÈå≤„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ„ÅîÁôªÈå≤„ÅÑ„Åü„Å†„ÅÑ„Åü„Ç¢„Éâ„É¨„Çπ„Å´Ë™çË®º„É°„Éº„É´„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ„É°„Éº„É´ÂÜÖ„ÅÆ„É™„É≥„ÇØ„ÇíÁ¢∫Ë™ç„Åó„Å¶„ÄÅÁôªÈå≤„ÇíÂÆå‰∫Ü„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    showPage('login-page');
                } else {
                    // „É°„Éº„É´Á¢∫Ë™çÂæÖ„Å°Á≠â„ÅÆ„Ç±„Éº„Çπ
                    alert('Á¢∫Ë™ç„É°„Éº„É´„ÅåÈÄÅ‰ø°„Åï„Çå„Åæ„Åó„Åü„ÄÇ„É°„Éº„É´ÂÜÖ„ÅÆ„É™„É≥„ÇØ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÁôªÈå≤„ÇíÂÆå‰∫Ü„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                }
            } catch (error) {

                console.error('Signup error:', error)
                showError('signup-error', error.message || 'ÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü')
            } finally {
                hideLoading()
            }
        }


        async function logout() {
            showLoading()
            try {
                // Ê§úÁ¥¢Êù°‰ª∂„Çí„ÇØ„É™„Ç¢
                if (typeof window.clearSearch === 'function') window.clearSearch();
                if (typeof window.clearCandidateSearch === 'function') window.clearCandidateSearch();

                // „É≠„Ç∞„Ç¢„Ç¶„ÉàÊìç‰Ωú„ÇíË®òÈå≤
                await auditLog.userLoggedOut();

                await supabase.auth.signOut()
                currentUser = null
                window.currentUser = null;
                showPage('login-page')
                $('#ai-search-agent-trigger').attr('style', 'display: none !important');
                $('#ai-search-agent-chat').attr('style', 'display: none !important');
            } catch (error) {
                console.error('Logout error:', error)
                alert('„É≠„Ç∞„Ç¢„Ç¶„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü')
            } finally {
                hideLoading()
            }
        }

        // ========================
        // Jobs & Applications
        // ========================
        // „Çø„Éº„Ç≤„ÉÉ„Éà„É¶„Éº„Ç∂„Éº„ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•
        let targetUsersCache = []
        // ÈÅ∏Êäû„Åï„Çå„ÅüÊ±Ç‰∫∫ID„Çí‰øùÊåÅ„Åô„ÇãSet
        const selectedJobIds = new Set()
        // „Éû„Çπ„Çø„Éá„Éº„Çø„É≠„Éº„ÉâÊ∏à„Åø„Éï„É©„Ç∞
        let isSearchMasterLoaded = false
        // „ÅäÊ∞ó„Å´ÂÖ•„ÇäÊ±Ç‰∫∫ID
        let favoriteJobIds = new Set()
        // ‰øùÂ≠ò„Åï„Çå„ÅüÊ§úÁ¥¢Êù°‰ª∂
        let savedSearches = []

        async function loadMasterDataForSearch() {
            if (isSearchMasterLoaded) return;
            if (!currentUser || !currentUser.organization_id) {
                console.warn('loadMasterDataForSearch: currentUser or organization_id is missing');
                return;
            }

            try {
                console.log('Loading master data for search...');

                // ÈÉΩÈÅìÂ∫úÁúå
                const prefSelect = $('#search-prefecture');
                if (prefSelect.hasClass("select2-hidden-accessible")) {
                    prefSelect.select2('destroy');
                }
                prefSelect.empty();
                window.prefectures.forEach(pref => {
                    prefSelect.append(`<option value="${pref}">${pref}</option>`);
                });
                prefSelect.select2({
                    placeholder: "Âã§ÂãôÂú∞ÔºàÈÉΩÈÅìÂ∫úÁúåÔºâ",
                    allowClear: true,
                    width: '100%',
                    closeOnSelect: true
                });

                // ÈõáÁî®ÂΩ¢ÊÖã„ÄÅËÅ∑Á®Æ„Ç´„ÉÜ„Ç¥„É™„ÄÅÊ•≠Áïå„Ç´„ÉÜ„Ç¥„É™„ÇíÂèñÂæó
                const { data: masters, error } = await supabase
                    .from('master_data')
                    .select('*')
                    .in('type', ['employment_type', 'job_category', 'industry_category'])
                    .eq('is_active', true)
                    .order('sort_order');

                if (error) {
                    console.error('Supabase master_data fetch error:', error);
                    throw error;
                }

                // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞Ôºà„Ç∞„É≠„Éº„Éê„É´ „Åæ„Åü„ÅØ Ëá™Á§æÁî®Ôºâ
                const validMasters = masters.filter(m =>
                    m.organization_id === null || m.organization_id === currentUser.organization_id
                );

                if (validMasters.length === 0) {
                    console.warn('No valid master data found for organization:', currentUser.organization_id);
                }

                // ÈõáÁî®ÂΩ¢ÊÖã
                const empSelect = $('#search-employment-type');
                if (empSelect.hasClass("select2-hidden-accessible")) {
                    empSelect.select2('destroy');
                }
                empSelect.empty();
                const uniqueEmps = [...new Set(validMasters.filter(m => m.type === 'employment_type').map(m => m.label))];
                uniqueEmps.forEach(label => {
                    empSelect.append(`<option value="${label}">${label}</option>`);
                });
                empSelect.select2({
                    placeholder: "ÈõáÁî®ÂΩ¢ÊÖãÔºàÂÖ®„Å¶Ôºâ",
                    allowClear: true,
                    width: '100%',
                    closeOnSelect: true
                });

                // ËÅ∑Á®Æ„Ç´„ÉÜ„Ç¥„É™
                const catSelect = $('#search-job-category');
                if (catSelect.hasClass("select2-hidden-accessible")) {
                    catSelect.select2('destroy');
                }
                catSelect.empty();
                const uniqueCats = [...new Set(validMasters.filter(m => m.type === 'job_category').map(m => m.label))];
                uniqueCats.forEach(label => {
                    catSelect.append(`<option value="${label}">${label}</option>`);
                });
                catSelect.select2({
                    placeholder: "ËÅ∑Á®Æ„Ç´„ÉÜ„Ç¥„É™ÔºàÂÖ®„Å¶Ôºâ",
                    allowClear: true,
                    width: '100%',
                    closeOnSelect: true
                });

                // Ê•≠Áïå„Ç´„ÉÜ„Ç¥„É™
                const indSelect = $('#search-industry-category');
                if (indSelect.hasClass("select2-hidden-accessible")) {
                    indSelect.select2('destroy');
                }
                indSelect.empty();
                const uniqueInds = [...new Set(validMasters.filter(m => m.type === 'industry_category').map(m => m.label))];
                uniqueInds.forEach(label => {
                    indSelect.append(`<option value="${label}">${label}</option>`);
                });
                indSelect.select2({
                    placeholder: "Ê•≠Áïå„Ç´„ÉÜ„Ç¥„É™ÔºàÂÖ®„Å¶Ôºâ",
                    allowClear: true,
                    width: '100%',
                    closeOnSelect: true
                });

                // --- Sync Tags (re-apply after destroy/re-init) ---
                if (typeof setupPremiumSearchUI === 'function') {
                    setupPremiumSearchUI();
                }

                isSearchMasterLoaded = true
            } catch (error) {
                console.error('Load search master error:', error)
            }
        }

        // ========================
        // AI Matching Features
        // ========================

        async function loadTargetUsers() {
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                    .eq('organization_id', currentUser.organization_id)
                    .neq('role', 'super_admin') // „Çπ„Éº„Éë„ÉºÁÆ°ÁêÜËÄÖ„ÅØÈô§Â§ñ
                    .order('name', { ascending: true })

                if (error) throw error

                targetUsersCache = (users || []).map(u => {
                    const profile = Array.isArray(u.candidate_profiles) ? u.candidate_profiles[0] : u.candidate_profiles;
                    return { ...u, ...profile };
                });
                const select = $('#target-user-select');
                select.html('<option value="">„É¶„Éº„Ç∂„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>');

                targetUsersCache.forEach(user => {
                    select.append(`<option value="${user.id}">${user.name} (${user.email})</option>`);
                });

            } catch (error) {
                console.error('Load target users error:', error);
            }
        }

        window.onTargetUserChange = async function () {
            const userId = $('#target-user-select').val();
            updateBatchAiButton();

            if (!userId) return;

            showLoading();
            try {
                // „Éá„Éº„Çø„Éô„Éº„Çπ„Åã„ÇâÊúÄÊñ∞„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´ÊÉÖÂ†±„ÇíÂèñÂæó
                const { data: userData, error } = await supabase
                    .from('users')
                    .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                    .eq('id', userId)
                    .single();

                if (error || !userData) throw error || new Error('User not found');

                const profile = Array.isArray(userData.candidate_profiles) ? userData.candidate_profiles[0] : userData.candidate_profiles;
                const user = { ...userData, ...profile };

                console.log('Reflecting target user to search form:', user);

                // --- 1. „Éï„Ç©„Éº„É†„ÅÆ„É™„Çª„ÉÉ„Éà ---
                $('#search-keyword').val('');
                $('#search-location').val('');
                $('#search-prefecture').val([]).trigger('change');
                $('#search-employment-type').val([]).trigger('change');
                $('#search-job-category').val([]).trigger('change');
                $('#search-industry-category').val([]).trigger('change');
                $('#search-salary-min').val('');
                $('#search-job-experience-ok').prop('checked', false);
                $('#search-industry-experience-ok').prop('checked', false);
                $('#search-is-remote').prop('checked', false);
                $('#search-exclude-matched').prop('checked', false);
                $('#search-favorites-only').prop('checked', false);
                // „Ç≠„Éº„ÉØ„Éº„Éâ„Çø„Ç∞(„Éó„É¨„Éü„Ç¢„É†UI)„ÇÇ„ÇØ„É™„Ç¢
                $('#tags-keyword').empty();

                // --- 2. „É¶„Éº„Ç∂„Éº„ÅÆÂ∏åÊúõÊù°‰ª∂„Çí„Çª„ÉÉ„Éà ---

                // „Éï„É™„Éº„ÉØ„Éº„ÉâÔºà„Ç≠„Éº„ÉØ„Éº„ÉâÔºâ„Çí„Çø„Ç∞„Å®„Åó„Å¶Â±ïÈñã
                if (user.desired_freewords) {
                    const words = user.desired_freewords.split(/[,„ÄÅ\s]+/).map(s => s.trim()).filter(s => s.length > 0);
                    words.forEach(word => {
                        if (window.addKeywordTag) {
                            window.addKeywordTag(word);
                        }
                    });
                    $('#search-keyword').val(''); // ÂÖ•ÂäõÊ¨Ñ„ÅØÁ©∫„Å´„Åô„Çã
                }

                // AND/ORÊ§úÁ¥¢„É¢„Éº„Éâ
                if (user.desired_freewords_condition) {
                    const cond = user.desired_freewords_condition.toUpperCase(); // 'AND' or 'OR'
                    const $radio = $(`input[name="search-keyword-mode"][value="${cond}"]`);
                    if ($radio.length) {
                        $radio.prop('checked', true).trigger('change');
                        // „É©„Ç∏„Ç™„Éú„Çø„É≥„ÇíÂõ≤„ÇÄ„É©„Éô„É´Á≠â„ÅÆUIÊõ¥Êñ∞„Çí‰øÉ„Åô„Åü„ÇÅ„ÄÅ„ÇØ„É™„ÉÉ„ÇØ„Çí„Ç∑„Éü„É•„É¨„Éº„Éà
                        $radio.closest('label').click();
                    }
                }

                // „Åù„ÅÆ‰ªñ„ÅÆÊù°‰ª∂
                // ËÅ∑Á®ÆÔºà„ÅÇ„ÅÑ„Åæ„ÅÑ‰∏ÄËá¥ÂØæÂøúÔºâ
                if (user.desired_job_type) {
                    const rawVals = window.safeParseList(user.desired_job_type);
                    const matchedVals = rawVals.map(v => typeof findClosestMasterValue === 'function' ? findClosestMasterValue(v, masterJobCategories) : null).filter(Boolean);
                    $('#search-job-category').val(matchedVals.length > 0 ? matchedVals : rawVals).trigger('change');
                }

                // Ê•≠ÁïåÔºà„ÅÇ„ÅÑ„Åæ„ÅÑ‰∏ÄËá¥ÂØæÂøúÔºâ
                if (user.desired_industry) {
                    const rawVals = window.safeParseList(user.desired_industry);
                    const matchedVals = rawVals.map(v => typeof findClosestMasterValue === 'function' ? findClosestMasterValue(v, masterIndustries) : null).filter(Boolean);
                    $('#search-industry-category').val(matchedVals.length > 0 ? matchedVals : rawVals).trigger('change');
                }

                // Âã§ÂãôÂú∞ÔºàÈÉΩÈÅìÂ∫úÁúå„Éû„Çπ„ÇøÁÖßÂêàÔºâ
                if (user.desired_location) {
                    const locs = window.safeParseList(user.desired_location);
                    const foundPrefs = [];
                    locs.forEach(loc => {
                        const pref = (window.prefectures || []).find(p => loc.includes(p) || p.includes(loc.replace(/[ÈÉΩÂ∫úÁúå]$/, '')));
                        if (pref) foundPrefs.push(pref);
                    });
                    if (foundPrefs.length > 0) {
                        $('#search-prefecture').val([...new Set(foundPrefs)]).trigger('change');
                    }
                }

                // ÈõáÁî®ÂΩ¢ÊÖã
                if (user.desired_employment_type) {
                    const vals = window.safeParseList(user.desired_employment_type);
                    $('#search-employment-type').val(vals).trigger('change');
                }

                // ÊúÄ‰ΩéÂπ¥Âèé
                if (user.desired_salary) $('#search-salary-min').val(Math.floor(user.desired_salary / 10000));

                $('#search-job-experience-ok').prop('checked', !!user.desired_job_experience_ok);
                $('#search-industry-experience-ok').prop('checked', !!user.desired_industry_experience_ok);

                // Â∞ë„ÅóÂæÖÊ©ü„Åó„Å¶„Åã„ÇâÊ§úÁ¥¢ÂÆüË°åÔºàSelect2„Å™„Å©„ÅÆÈùûÂêåÊúüÂèçÊò†„ÇíÂæÖ„Å§Ôºâ
                setTimeout(() => {
                    executeSearch();
                }, 100);

            } catch (err) {
                console.error('Error onTargetUserChange:', err);
            } finally {
                hideLoading();
            }
        }

        window.toggleJobSelection = function (jobId) {
            if (selectedJobIds.has(jobId)) {
                selectedJobIds.delete(jobId);
            } else {
                selectedJobIds.add(jobId);
            }
            updateBatchAiButton();
            updateCandidateAiButton();
        }

        function updateBatchAiButton() {
            const btn = $('#batch-ai-btn');
            const count = selectedJobIds.size;
            const userId = $('#target-user-select').val();

            if (count > 0 && userId) {
                btn.prop('disabled', false).removeClass('opacity-50 cursor-not-allowed');
                btn.html(`<i class="fas fa-magic mr-2"></i>ÈÅ∏Êäû„Åó„ÅüÊ±Ç‰∫∫(${count}‰ª∂)„ÅßAIÁ¥π‰ªã„ÇíÂÆüË°å`);
            } else {
                btn.prop('disabled', true).addClass('opacity-50 cursor-not-allowed');
                btn.html(`<i class="fas fa-magic mr-2"></i>ÈÅ∏Êäû„Åó„ÅüÊ±Ç‰∫∫„ÅßAIÁ¥π‰ªã„ÇíÂÆüË°å`);
            }
        }

        // ========================
        // AIÊé®Ëñ¶Áî®„ÅÆÂåøÂêçÂåñÂá¶ÁêÜ
        // ========================

        /**
         * „ÉÜ„Ç≠„Çπ„Éà„Åã„ÇâÂÄã‰∫∫ÊÉÖÂ†±„ÇíÈô§Âéª„ÉªÂåøÂêçÂåñ
         * @param {string} text - ÂÖÉ„ÅÆ„ÉÜ„Ç≠„Çπ„Éà
         * @returns {string} - ÂåøÂêçÂåñ„Åï„Çå„Åü„ÉÜ„Ç≠„Çπ„Éà
         */
        function anonymizeText(text) {
            if (!text) return '';

            let anonymized = text;

            // ÂåøÂêçÂåñ„É≠„Ç∏„ÉÉ„ÇØ„Çí‰∏ÄÊôÇÁöÑ„Å´ÁÑ°ÂäπÂåñÔºàÊÉÖÂ†±‰∏çË∂≥Âà§ÂÆö„ÅÆÂéüÂõ†Ë™øÊüª„ÅÆ„Åü„ÇÅÔºâ
            // ÂøÖË¶Å„Å™ÊÉÖÂ†±„Åæ„ÅßÁΩÆÊèõ„Åï„Çå„Å¶„Åó„Åæ„Å£„Å¶„ÅÑ„ÇãÂèØËÉΩÊÄß„ÇíÊéíÈô§
            return text;

            // ÂÖ∑‰ΩìÁöÑ„Å™ÈÉ®ÁΩ≤Âêç„ÇÑÂΩπËÅ∑„Çí‰∏ÄËà¨ÂåñÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
            // anonymized = anonymized
            //     .replace(/Á¨¨[0-9‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠‰∏ÉÂÖ´‰πùÂçÅ]+[Âñ∂Ê•≠ÈñãÁô∫Ë£ΩÈÄ†]ÈÉ®/g, 'ÊâÄÂ±ûÈÉ®ÁΩ≤');

            return anonymized;
        }

        /**
         * „É¶„Éº„Ç∂„Éº„Éó„É≠„Éï„Ç£„Éº„É´„ÇíÂåøÂêçÂåñ„Åó„Å¶AIÁî®„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÇíÁîüÊàê
         * @param {object} user - „É¶„Éº„Ç∂„Éº„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
         * @returns {string} - ÂåøÂêçÂåñ„Åï„Çå„Åü„Éó„É≠„Éï„Ç£„Éº„É´„ÉÜ„Ç≠„Çπ„Éà
         */
        function createAnonymizedUserProfile(user) {
            const safeString = (val) => {
                if (!val) return 'Êú™Ë®≠ÂÆö';
                if (typeof val === 'object') {
                    try { return JSON.stringify(val, null, 2); } catch (e) { return String(val); }
                }
                return String(val);
            };

            return `
                Â∏åÊúõËÅ∑Á®Æ: ${safeString(user.desired_job_type)}
                Â∏åÊúõÂã§ÂãôÂú∞: ${safeString(user.desired_location)}
                „Çπ„Ç≠„É´: ${safeString(user.skills)}
                ËÅ∑Ê≠¥„ÉªËá™Â∑±PR: ${safeString(user.work_history)}
                Â∏åÊúõÂπ¥Âèé: ${user.desired_salary ? user.desired_salary + 'ÂÜÜ' : 'Êú™Ë®≠ÂÆö'}
                Â≠¶Ê≠¥: ${safeString(user.academic_background)}
                Ë®ÄË™û„Çπ„Ç≠„É´: ${safeString(user.languages)}
                Ë≥áÊ†º: ${safeString(user.certifications)}
            `.trim();
        }

        window.runBatchAIRecommendation = async function () {
            // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ selectedTargetUserId „ÇíÂÑ™ÂÖà„ÄÅ„Å™„Åë„Çå„Å∞ÂæìÊù•„ÅÆselectÂÄ§
            let userId = typeof selectedTargetUserId !== 'undefined' ? selectedTargetUserId : $('#target-user-select').val();

            if (!userId) {
                alert('ÂØæË±°„É¶„Éº„Ç∂„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            if (selectedJobIds.size === 0) {
                alert('Ê±Ç‰∫∫„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            showLoading();
            try {
                // 1. ÊúÄÊñ∞„ÅÆ„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÁõ¥Êé•ÂèñÂæó („Ç≠„É£„ÉÉ„Ç∑„É•ÂõûÈÅø)
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                    .eq('id', userId)
                    .single();

                if (userError || !userData) {
                    console.error('User fetch error:', userError);
                    throw new Error('„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }

                // „Éó„É≠„Éï„Ç£„Éº„É´„Éá„Éº„Çø„ÅÆ„Éï„É©„ÉÉ„ÉàÂåñ
                const profile = Array.isArray(userData.candidate_profiles) ? userData.candidate_profiles[0] : userData.candidate_profiles;
                const user = { ...userData, ...profile }; // users„Å®profiles„ÇíÁµêÂêà

                console.log('Fresh User Data fetched:', user);

                // „Éá„Éê„ÉÉ„Ç∞Áî®„Ç¢„É©„Éº„Éà
                alert('„ÄêÁ¢∫Ë™çÁî®„ÄëAI„Å∏ÈÄÅ‰ø°„Åô„Çã„Éá„Éº„Çø(ÂÜíÈ†≠):\n' + userProfile.substring(0, 500));

                // 2. ÈÅ∏Êäû„Åï„Çå„ÅüÊ±Ç‰∫∫„Éá„Éº„Çø„ÇíÂèñÂæó
                const { data: selectedJobs, error: jobsError } = await supabase
                    .from('jobs')
                    .select('*')
                    .in('id', Array.from(selectedJobIds));

                if (jobsError) throw jobsError;

                // „É¶„Éº„Ç∂„Éº„Éó„É≠„Éï„Ç£„Éº„É´ÊÉÖÂ†±„ÇíÂåøÂêçÂåñ„Åó„Å¶ÊßãÁØâ
                const userProfile = createAnonymizedUserProfile(user);
                console.log('User Data for AI:', user);
                console.log('Anonymized Profile Text:', userProfile);

                // Edge Function Âëº„Å≥Âá∫„Åó
                const { data: recommendations, error: functionError } = await supabase.functions.invoke('score-ai-recommendations', {
                    body: {
                        userProfile,
                        jobs: selectedJobs.map(j => ({ id: j.id, title: j.title, description: j.description }))
                    }
                });

                if (functionError) throw functionError;

                if (!recommendations || recommendations.length === 0) {
                    throw new Error('AI„Åã„Çâ„ÅÆÂøúÁ≠î„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
                }

                // ÁµêÊûú„Çí‰øùÂ≠ò
                for (const rec of recommendations) {
                    // Êó¢Â≠ò„ÅÆ„É¨„Ç≥„É°„É≥„Éá„Éº„Ç∑„Éß„É≥„Åå„ÅÇ„Çå„Å∞ÂâäÈô§„Åó„Å¶„Åã„ÇâÊåøÂÖ•
                    await supabase.from('recommendations')
                        .delete()
                        .eq('user_id', userId)
                        .eq('job_id', rec.job_id);

                    await supabase.from('recommendations').insert({
                        organization_id: currentUser.organization_id,
                        user_id: userId,
                        job_id: rec.job_id,
                        score: rec.score,
                        reason: rec.reason
                    });
                }

                alert(`${recommendations.length}‰ª∂„ÅÆ„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÂàÜÊûê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ\n„ÄåAIÁ¥π‰ªã„Äç„É°„Éã„É•„Éº„Åã„ÇâÁµêÊûú„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ`);
                selectedJobIds.clear();
                updateBatchAiButton();
                // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
                $('input[type="checkbox"][onchange^="toggleJobSelection"]').prop('checked', false);
                // Ê±Ç‰∫∫„É™„Çπ„Éà„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶AIÊé®Ëñ¶Ê∏à„Åø„Éê„ÉÉ„Ç∏„ÇíË°®Á§∫
                searchJobs();

            } catch (error) {
                console.error('Batch AI error:', error);
                alert('AIÂàÜÊûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Ê±ÇËÅ∑ËÄÖÁî®„Çª„É´„ÉïAI„Éû„ÉÉ„ÉÅ„É≥„Ç∞
        window.runCandidateSelfAIMatching = async function () {
            if (!currentUser || currentUser.role !== 'candidate') {
                alert('„Åì„ÅÆÊ©üËÉΩ„ÅØÊ±ÇËÅ∑ËÄÖ„ÅÆ„ÅøÂà©Áî®„Åß„Åç„Åæ„Åô');
                return;
            }
            if (selectedJobIds.size === 0) {
                alert('Ê±Ç‰∫∫„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Å´„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÖ•„Çå„Å¶„Åè„Å†„Åï„ÅÑÔºâ');
                return;
            }

            showLoading();
            try {
                // ÈÅ∏Êäû„Åï„Çå„ÅüÊ±Ç‰∫∫„Éá„Éº„Çø„ÇíÂèñÂæó
                const { data: selectedJobs, error: jobsError } = await supabase
                    .from('jobs')
                    .select('*')
                    .in('id', Array.from(selectedJobIds));

                if (jobsError) throw jobsError;

                // Ëá™ÂàÜ„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´ÊÉÖÂ†±„ÇíÂåøÂêçÂåñ„Åó„Å¶ÊßãÁØâ
                const userProfile = createAnonymizedUserProfile(currentUser);

                // Edge Function Âëº„Å≥Âá∫„Åó
                const { data: recommendations, error: functionError } = await supabase.functions.invoke('score-ai-recommendations', {
                    body: {
                        userProfile,
                        jobs: selectedJobs.map(j => ({ id: j.id, title: j.title, description: j.description }))
                    }
                });

                if (functionError) throw functionError;

                if (!recommendations || recommendations.length === 0) {
                    throw new Error('AI„Åã„Çâ„ÅÆÂøúÁ≠î„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
                }

                // ÁµêÊûú„Çí‰øùÂ≠ò
                for (const rec of recommendations) {
                    // Êó¢Â≠ò„ÅÆ„É¨„Ç≥„É°„É≥„Éá„Éº„Ç∑„Éß„É≥„Åå„ÅÇ„Çå„Å∞ÂâäÈô§„Åó„Å¶„Åã„ÇâÊåøÂÖ•
                    await supabase.from('recommendations')
                        .delete()
                        .eq('user_id', currentUser.id)
                        .eq('job_id', rec.job_id);

                    await supabase.from('recommendations').insert({
                        organization_id: currentUser.organization_id,
                        user_id: currentUser.id,
                        job_id: rec.job_id,
                        score: rec.score,
                        reason: rec.reason
                    });
                }

                alert(`${recommendations.length}‰ª∂„ÅÆ„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÂàÜÊûê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ\n„ÄåAIÊé®Ëñ¶„Äç„É°„Éã„É•„Éº„Åã„ÇâÁµêÊûú„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ`);
                selectedJobIds.clear();
                updateCandidateAiButton();
                // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
                $('input[type="checkbox"][onchange^="toggleJobSelection"]').prop('checked', false);
                // Ê±Ç‰∫∫„É™„Çπ„Éà„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶AIÊé®Ëñ¶Ê∏à„Åø„Éê„ÉÉ„Ç∏„ÇíË°®Á§∫
                searchJobs();

            } catch (error) {
                console.error('Candidate AI matching error:', error);
                alert('AIÂàÜÊûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Ê±ÇËÅ∑ËÄÖÁî®AI„Éú„Çø„É≥„ÅÆÊúâÂäπ/ÁÑ°Âäπ„ÇíÊõ¥Êñ∞
        function updateCandidateAiButton() {
            const btn = $('#candidate-ai-btn');
            if (selectedJobIds.size > 0) {
                btn.prop('disabled', false);
            } else {
                btn.prop('disabled', true);
            }
        }

        // ========================
        // Job Detail Modal
        // ========================
        window.showJobDetailModal = async function (jobId) {
            if (isModalLoading) return;
            console.log('--- showJobDetailModal Triggered ---', jobId);

            if (!jobId) {
                console.error('Error: jobId is undefined or null');
                return;
            }

            console.log('Step 1: check client');
            const client = window.supabase;
            console.log('Step 2: check user');
            const user = window.currentUser;
            console.log('Step 3: show loading');
            showLoading();
            isModalLoading = true;
            console.log('Step 4: entering try');
            try {
                console.log('Fetching job details for:', jobId);
                let { data: job, error } = await client
                    .from('jobs')
                    .select(`
                        *,
                        companies (
                            name,
                            industry,
                            website,
                            location,
                            description
                        ),
                        pic1:users!pic_user_id_1(name),
                        pic2:users!pic_user_id_2(name)
                    `)
                    .eq('id', jobId)
                    .single();

                if (error) {
                    console.log('Fetch error, trying fallback:', error);
                    const fallback = await client.from('jobs').select('*').eq('id', jobId).single();
                    job = fallback.data;
                    error = fallback.error;
                }

                if (error || !job) {
                    console.log('Final fetch error or no job:', error, job);
                    alert('Ê±Ç‰∫∫ÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åü„Åã„ÄÅË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
                    return;
                }

                console.log('Job details fetched:', job.title);
                $('#job-detail-title').html(`
                    <div class="flex flex-col">
                        <span class="text-xs text-gray-500 font-normal mb-1">${job.job_code ? `Ê±Ç‰∫∫ID: ${job.job_code}` : ''}</span>
                        <span>${job.title}</span>
                    </div>
                `);

                if (user && (user.role === 'candidate' || user.role === 'user')) {
                    $('#job-tab-candidates').addClass('hidden');
                } else {
                    $('#job-tab-candidates').removeClass('hidden');
                }

                const companyName = job.companies ? job.companies.name : (job.company || '‰∏çÊòé');
                const companyIndustry = job.companies?.industry || job.industry_category || 'Êú™Ë®≠ÂÆö';
                const companyWebsite = job.companies?.website || '';
                const companyLocation = job.companies?.location || '';
                const companyDescription = job.companies?.description || '';

                const pic1Name = job.pic1?.name || (job.pic_user_id_1 ? '‰∏çÊòé' : '');
                const pic2Name = job.pic2?.name || (job.pic_user_id_2 ? '‰∏çÊòé' : '');
                const isAgent = user && ['org_admin', 'admin', 'coach', 'ca', 'super_admin'].includes(user.role);
                const canEditJob = user && ['super_admin', 'org_admin'].includes(user.role);

                const content = `
                    <!-- ‰ºÅÊ•≠ÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥ -->
                    <div class="bg-gray-50 rounded-xl p-5 mb-6 border border-gray-100 shadow-sm transition hover:shadow-md">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-building mr-2 text-indigo-600"></i>‰ºÅÊ•≠ÊÉÖÂ†±
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-3">
                                <div>
                                    <p class="text-xs text-gray-500 uppercase tracking-wider font-semibold">‰ºÅÊ•≠Âêç</p>
                                    <p class="text-gray-900 font-medium">${companyName}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500 uppercase tracking-wider font-semibold">Ê•≠Áïå</p>
                                    <p class="text-gray-900">${companyIndustry}</p>
                                </div>
                                ${companyLocation ? `
                                <div>
                                    <p class="text-xs text-gray-500 uppercase tracking-wider font-semibold">Êú¨Á§æÊâÄÂú®Âú∞</p>
                                    <p class="text-gray-900">${companyLocation}</p>
                                </div>
                                ` : ''}
                                ${companyWebsite ? `
                                <div>
                                    <p class="text-xs text-gray-500 uppercase tracking-wider font-semibold">Web„Çµ„Ç§„Éà</p>
                                    <a href="${companyWebsite}" target="_blank" class="text-indigo-600 hover:text-indigo-800 transition flex items-center gap-1 group">
                                        <span class="truncate">${companyWebsite}</span>
                                        <i class="fas fa-external-link-alt text-[10px] group-hover:translate-x-0.5 group-hover:-translate-y-0.5 transition-transform"></i>
                                    </a>
                                </div>
                                ` : ''}
                            </div>
                            ${companyDescription ? `
                            <div class="md:border-l md:pl-6 border-gray-200">
                                <p class="text-xs text-gray-500 uppercase tracking-wider font-semibold mb-1">‰ºÅÊ•≠Ê¶ÇË¶Å</p>
                                <p class="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">${companyDescription}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Âü∫Êú¨ÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥ -->
                    <div class="mb-8">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-info-circle mr-2 text-indigo-600"></i>Âü∫Êú¨ÊÉÖÂ†±
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <p class="text-xs text-gray-500 font-semibold mb-1">ËÅ∑Á®Æ„Ç´„ÉÜ„Ç¥„É™</p>
                                <p class="font-medium text-gray-900">${job.job_category || 'Êú™Ë®≠ÂÆö'}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 font-semibold mb-1">Ê•≠Áïå„Ç´„ÉÜ„Ç¥„É™</p>
                                <p class="font-medium text-gray-900">${job.industry_category || 'Êú™Ë®≠ÂÆö'}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 font-semibold mb-1">ÈõáÁî®ÂΩ¢ÊÖã</p>
                                <p class="font-medium text-gray-900">
                                    <span class="px-2 py-0.5 bg-indigo-50 text-indigo-700 border border-indigo-100 rounded text-xs">
                                        ${job.employment_type || 'Êú™Ë®≠ÂÆö'}
                                    </span>
                                </p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 font-semibold mb-1">Âã§ÂãôÂú∞</p>
                                <p class="font-medium text-gray-900">
                                    <i class="fas fa-map-marker-alt mr-1 text-gray-400"></i>${job.location || 'Êú™Ë®≠ÂÆö'}
                                </p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 font-semibold mb-1">ÊÉ≥ÂÆöÂπ¥Âèé</p>
                                <p class="font-bold text-indigo-600 text-lg">
                                    ${job.salary_min && job.salary_max ? `¬•${(job.salary_min / 10000).toLocaleString()}‰∏á - ${(job.salary_max / 10000).toLocaleString()}‰∏á` : 'ÂøúÁõ∏Ë´á'}
                                </p>
                            </div>
                            <div class="md:col-span-1">
                                <p class="text-xs text-gray-500 font-semibold mb-1">„É™„É¢„Éº„Éà„ÉØ„Éº„ÇØ</p>
                                <p class="font-medium text-gray-900">
                                    <i class="fas ${job.is_remote ? 'fa-check text-green-500' : 'fa-times text-gray-400'} mr-1"></i>
                                    ${job.is_remote ? 'ÂèØËÉΩ' : 'Âü∫Êú¨ÁöÑ„Å´ÁÑ°„Åó'}
                                </p>
                            </div>
                            ${job.pdf_filename ? `
                            <div class="md:col-span-1">
                                <p class="text-xs text-gray-500 font-semibold mb-1">Âèñ„ÇäËæº„Åø„Éï„Ç°„Ç§„É´Âêç</p>
                                <p class="text-xs font-medium text-gray-600 truncate" title="${job.pdf_filename}">
                                    <i class="fas fa-file-pdf mr-1 text-red-500"></i>${job.pdf_filename}
                                </p>
                            </div>
                            ` : ''}
                            <div class="md:col-span-3 bg-slate-50 p-3 rounded-lg border border-slate-100">
                                <p class="text-xs text-gray-500 font-semibold mb-1">Ê±Ç‰∫∫URL / ÂèÇÁÖß„Éï„Ç°„Ç§„É´</p>
                                ${job.pdf_url ? `
                                <a href="${job.pdf_url}" target="_blank" class="text-indigo-600 hover:underline flex items-center gap-1 group text-sm truncate">
                                    <i class="fas fa-file-pdf text-red-500 text-xs group-hover:rotate-45 transition-transform"></i>
                                    <span>${job.pdf_url}</span>
                                </a>
                                ` : '<span class="text-gray-400 text-sm italic">ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</span>'}
                            </div>
                        </div>
                    </div>

                    <!-- ËÅ∑ÂãôÂÜÖÂÆπ -->
                    <div class="mb-8">
                        <h4 class="font-bold text-lg mb-3 text-gray-900 flex items-center">
                            <i class="fas fa-clipboard-list mr-2 text-indigo-600"></i>ËÅ∑ÂãôÂÜÖÂÆπ
                        </h4>
                        <div class="bg-white border border-gray-200 rounded-xl p-5 shadow-sm">
                            <p class="text-gray-800 whitespace-pre-wrap leading-relaxed">${job.description || 'Ë©≥Á¥∞„ÅØ‰ºÅÊ•≠„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ'}</p>
                        </div>
                    </div>

                    <!-- ÂøúÂãüË¶Å‰ª∂ -->
                    <div class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-bold text-lg mb-3 text-gray-900 flex items-center">
                                <i class="fas fa-check-circle mr-2 text-indigo-600"></i>ÂøÖÈ†àË¶Å‰ª∂
                            </h4>
                            <div class="bg-white border border-gray-200 rounded-xl p-5 shadow-sm h-full">
                                <p class="text-gray-800 whitespace-pre-wrap text-sm leading-relaxed">${job.requirements || 'Áâπ„Å´„Å™„Åó'}</p>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-bold text-lg mb-3 text-gray-900 flex items-center">
                                <i class="fas fa-star mr-2 text-indigo-600"></i>Ê≠ìËøéË¶Å‰ª∂
                            </h4>
                            <div class="bg-white border border-gray-200 rounded-xl p-5 shadow-sm h-full">
                                <p class="text-gray-800 whitespace-pre-wrap text-sm leading-relaxed">${job.welcome_requirements || 'Áâπ„Å´„Å™„Åó'}</p>
                            </div>
                        </div>
                    </div>

                    <!-- ÁµåÈ®ì„ÉªÂØæË±° -->
                    <div class="mb-8 bg-blue-50/50 rounded-xl p-5 border border-blue-100">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-user-check mr-2 text-indigo-600"></i>ÁµåÈ®ì„Éª„Çø„Éº„Ç≤„ÉÉ„Éà
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="flex items-center p-3 bg-white rounded-lg shadow-sm border border-blue-100">
                                <i class="fas ${job.job_experience_ok === 'ÂèØ' ? 'fa-check-circle text-green-600' : 'fa-times-circle text-red-500'} text-xl mr-3"></i>
                                <div>
                                    <p class="text-[10px] text-gray-500 font-bold uppercase">ËÅ∑Á®ÆÊú™ÁµåÈ®ì</p>
                                    <p class="font-bold ${job.job_experience_ok === 'ÂèØ' ? 'text-green-700' : 'text-gray-700'}">${job.job_experience_ok === 'ÂèØ' ? 'Ê≠ìËøé' : '‰∏çÂèØ'}</p>
                                </div>
                            </div>
                            <div class="flex items-center p-3 bg-white rounded-lg shadow-sm border border-blue-100">
                                <i class="fas ${job.industry_experience_ok === 'ÂèØ' ? 'fa-check-circle text-green-600' : 'fa-times-circle text-red-500'} text-xl mr-3"></i>
                                <div>
                                    <p class="text-[10px] text-gray-500 font-bold uppercase">Ê•≠ÁïåÊú™ÁµåÈ®ì</p>
                                    <p class="font-bold ${job.industry_experience_ok === 'ÂèØ' ? 'text-green-700' : 'text-gray-700'}">${job.industry_experience_ok === 'ÂèØ' ? 'Ê≠ìËøé' : '‰∏çÂèØ'}</p>
                                </div>
                            </div>
                            ${job.experience_level ? `
                            <div class="flex items-center p-3 bg-white rounded-lg shadow-sm border border-blue-100">
                                <i class="fas fa-chart-line text-xl text-indigo-500 mr-3"></i>
                                <div>
                                    <p class="text-[10px] text-gray-500 font-bold uppercase">ÊÉ≥ÂÆöÁµåÈ®ì„É¨„Éô„É´</p>
                                    <p class="font-bold text-gray-700">${job.experience_level}</p>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Âã§ÂãôÊù°‰ª∂ -->
                    <div class="mb-8">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-calendar-alt mr-2 text-indigo-600"></i>Âã§ÂãôÊù°‰ª∂
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-gray-50 rounded-xl p-5 border border-gray-100">
                                <p class="text-xs text-gray-500 font-bold uppercase mb-3 flex items-center">
                                    <i class="fas fa-clock mr-1 text-gray-400"></i>Âã§ÂãôÊôÇÈñì
                                </p>
                                <p class="text-sm text-gray-800 whitespace-pre-wrap">${job.work_hours || 'Êú™Ë®≠ÂÆö'}</p>
                            </div>
                            <div class="bg-gray-50 rounded-xl p-5 border border-gray-100">
                                <p class="text-xs text-gray-500 font-bold uppercase mb-3 flex items-center">
                                    <i class="fas fa-umbrella-beach mr-1 text-gray-400"></i>‰ºëÊó•„Éª‰ºëÊöá
                                </p>
                                <p class="text-sm text-gray-800 whitespace-pre-wrap">${job.holidays || 'Êú™Ë®≠ÂÆö'}</p>
                            </div>
                            <div class="md:col-span-2 bg-gray-50 rounded-xl p-5 border border-gray-100">
                                <p class="text-xs text-gray-500 font-bold uppercase mb-3 flex items-center">
                                    <i class="fas fa-gift mr-1 text-gray-400"></i>Á¶èÂà©ÂéöÁîü„ÉªÂæÖÈÅá
                                </p>
                                <p class="text-sm text-gray-800 whitespace-pre-wrap">${job.benefits || 'Êú™Ë®≠ÂÆö'}</p>
                            </div>
                        </div>
                    </div>

                    <!-- ÈÅ∏ËÄÉ„Éó„É≠„Çª„Çπ -->
                    ${job.interview_process ? `
                    <div class="mb-8">
                        <h4 class="font-bold text-lg mb-3 text-gray-900 flex items-center">
                            <i class="fas fa-tasks mr-2 text-indigo-600"></i>ÈÅ∏ËÄÉ„Éó„É≠„Çª„Çπ
                        </h4>
                        <div class="bg-white border border-gray-200 rounded-xl p-5 shadow-sm">
                            <p class="text-gray-800 whitespace-pre-wrap leading-relaxed">${job.interview_process}</p>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Á§æÂÜÖÊãÖÂΩìËÄÖ („Ç®„Éº„Ç∏„Çß„É≥„Éà„ÅÆ„ÅøË°®Á§∫) -->
                    ${isAgent && (pic1Name || pic2Name) ? `
                    <div class="mb-8 bg-slate-100 rounded-xl p-5 border border-slate-200">
                        <h4 class="font-bold text-base mb-3 text-slate-800 flex items-center">
                            <i class="fas fa-user-tie mr-2 text-slate-500"></i>Á§æÂÜÖÊãÖÂΩìËÄÖ
                        </h4>
                        <div class="flex gap-6">
                            ${pic1Name ? `
                            <div>
                                <p class="text-[10px] text-slate-500 font-bold uppercase">„É°„Ç§„É≥ÊãÖÂΩì</p>
                                <p class="text-sm font-bold text-slate-900">${pic1Name}</p>
                            </div>
                            ` : ''}
                            ${pic2Name ? `
                            <div>
                                <p class="text-[10px] text-slate-500 font-bold uppercase">„Çµ„ÉñÊãÖÂΩì</p>
                                <p class="text-sm font-bold text-slate-900">${pic2Name}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}

                    <!-- ÁôªÈå≤„ÉªÊõ¥Êñ∞Êó•ÊôÇ -->
                    <div class="flex justify-end text-[10px] text-gray-400 mt-2 mb-6">
                        <span class="mr-4">ÁôªÈå≤Êó•: ${new Date(job.created_at).toLocaleDateString()}</span>
                        <span>ÊúÄÁµÇÊõ¥Êñ∞Êó•: ${new Date(job.updated_at).toLocaleDateString()}</span>
                    </div>

                    <div class="flex gap-3 pt-6 mt-6 border-t">
                        <button id="modal-fav-btn-${job.id}" onclick="toggleFavorite('${job.id}')" class="flex-1 px-6 py-3 border-2 ${typeof favoriteJobIds !== 'undefined' && favoriteJobIds.has(job.id) ? 'border-pink-500 text-pink-600' : 'border-gray-300 text-gray-700'} rounded-lg hover:bg-gray-50 font-medium transition shadow-sm flex items-center justify-center gap-2">
                            <i class="fas fa-heart ${typeof favoriteJobIds !== 'undefined' && favoriteJobIds.has(job.id) ? 'text-pink-500' : ''}"></i>
                            ${typeof favoriteJobIds !== 'undefined' && favoriteJobIds.has(job.id) ? '„ÅäÊ∞ó„Å´ÂÖ•„ÇäÁôªÈå≤Ê∏à„Åø' : '„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†'}
                        </button>
                        ${user && (user.role === 'candidate' || user.role === 'user') ? `
                        <button onclick="applyForJob('${job.id}')" class="flex-1 bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 font-medium transition shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                            <i class="fas fa-paper-plane"></i>ÂøúÂãü„Åô„Çã
                        </button>
                        ` : ''}
                        ${canEditJob ? `
                        <button onclick="closeJobDetailModal(); showJobForm('${job.id}')" class="flex-1 bg-amber-600 text-white px-6 py-3 rounded-lg hover:bg-amber-700 font-medium transition shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                            <i class="fas fa-edit"></i>Ê±Ç‰∫∫„ÇíÁ∑®ÈõÜ
                        </button>
                        ` : ''}
                    </div>
                `;

                console.log('Final step: Rendering to modal and forcing visibility.');
                $('#job-detail-tab-content').html(content);
                window.currentJobId = jobId;

                const modal = $('#job-detail-modal');
                if (modal.length === 0) {
                    console.error('CRITICAL: #job-detail-modal not found in DOM!');
                    alert('„Ç®„É©„Éº: „É¢„Éº„ÉÄ„É´Ë¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
                    return;
                }

                // Move to body root to avoid parent clipping/z-index issues
                $('body').append(modal);

                console.log('Updating modal visibility...');
                modal.removeClass('hidden').attr('style', 'display: flex !important; z-index: 99999 !important; visibility: visible !important; opacity: 1 !important;');

                switchJobDetailTab('details');
                console.log('Modal show process complete - z-index 99999 applied');

            } catch (error) {
                console.error('Load job detail error:', error);
                alert('Ê±Ç‰∫∫Ë©≥Á¥∞„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            } finally {
                isModalLoading = false;
                hideLoading();
            }
        }

        window.closeJobDetailModal = function () {
            console.log('--- closeJobDetailModal Triggered ---');
            $('#job-detail-modal').addClass('hidden').attr('style', 'display: none !important;');
        }

        // ============================================
        // Ê±Ç‰∫∫Êé®Ëñ¶Ê©üËÉΩÔºà„Ç®„Éº„Ç∏„Çß„É≥„ÉàÁî®Ôºâ
        // ============================================

        let currentRecommendJobId = null;
        let currentRecommendTargetUserId = null;

        // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„ÇπÈÅ∏ÊäûÊôÇ„ÅÆÂá¶ÁêÜ„ÇíÊõ¥Êñ∞
        window.toggleJobSelection = function (jobId) {
            const checkbox = $(`input[type="checkbox"][onclick*="toggleJobSelection('${jobId}')"]`);
            const card = checkbox.closest('.job-card');

            if (selectedJobIds.has(jobId)) {
                selectedJobIds.delete(jobId);
                if (card.length) card.removeClass('job-card-highlighted');
            } else {
                selectedJobIds.add(jobId);
                if (card.length) card.addClass('job-card-highlighted');
            }
            updateBulkRecommendBar();
        }

        // ‰∏ä‰Ωç30‰ª∂„Çí‰∏ÄÊã¨ÈÅ∏Êäû
        window.selectTop30Jobs = function () {
            const checkboxes = $('.job-card input[type="checkbox"]:not(:disabled)').slice(0, 30);

            checkboxes.each(function () {
                const jobId = $(this).attr('onchange').match(/'([^']+)'/)[1];
                if (!selectedJobIds.has(jobId)) {
                    $(this).prop('checked', true);
                    selectedJobIds.add(jobId);
                    $(this).closest('.job-card').addClass('job-card-highlighted');
                }
            });

            updateBulkRecommendBar();

            // ÈÄöÁü•
            const count = checkboxes.length;
            if (count > 0) {
                // Á∞°ÊòìÁöÑ„Å™ÈÄöÁü•Ôºà„Éà„Éº„Çπ„Éà„Åå„ÅÇ„Çå„Å∞„Åù„Çå„ÅåËâØ„ÅÑ„Åå„ÄÅ„Å™„Åë„Çå„Å∞„Ç¢„É©„Éº„ÉàÁ≠â„ÅØÈÅø„Åë„ÇãÔºâ
                console.log(`${count} ‰ª∂„ÅÆÊ±Ç‰∫∫„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü`);
            }
        }

        window.clearAllSelectedJobs = function () {
            selectedJobIds.clear();
            $('.job-checkbox').prop('checked', false);
            $('.job-card').removeClass('job-card-highlighted');
            updateBulkRecommendBar();
        }

        function updateBulkRecommendBar() {
            const count = selectedJobIds.size;
            $('#selected-jobs-count').text(count);

            const isAgent = currentUser && ['org_admin', 'admin', 'coach', 'ca', 'super_admin'].includes(currentUser.role);
            const isCandidate = currentUser && currentUser.role === 'candidate';
            const targetUserId = selectedTargetUserId;

            const bar = $('#bulk-recommend-bar');
            if (count > 0) {
                if (isAgent && targetUserId) {
                    bar.removeClass('hidden').removeClass('translate-y-full').addClass('translate-y-0');
                    bar.find('.bar-title').text('AI„Éû„ÉÉ„ÉÅ');
                    bar.find('.bar-button').text('AI„Éû„ÉÉ„ÉÅ„ÇíÂÆüË°å');
                    $('#jobs-container').css('padding-bottom', '120px');
                } else if (isCandidate) {
                    bar.removeClass('hidden').removeClass('translate-y-full').addClass('translate-y-0');
                    bar.find('.bar-title').text('AI„Éû„ÉÉ„ÉÅ„É≥„Ç∞Ë®∫Êñ≠');
                    bar.find('.bar-button').text('AI„Éû„ÉÉ„ÉÅ„É≥„Ç∞„Åô„Çã');
                    $('#jobs-container').css('padding-bottom', '120px');
                } else {
                    bar.addClass('translate-y-full');
                    setTimeout(() => { if (selectedJobIds.size === 0) bar.addClass('hidden'); }, 300);
                    $('#jobs-container').css('padding-bottom', '0');
                }
            } else {
                bar.addClass('translate-y-full');
                setTimeout(() => { if (selectedJobIds.size === 0) bar.addClass('hidden'); }, 300);
                $('#jobs-container').css('padding-bottom', '0');
            }

            // Êõ¥Êñ∞: ‰∏äÈÉ®„ÅÆ„Éú„Çø„É≥Âà∂Âæ°
            const batchAiBtn = $('#batch-ai-btn');
            if (count > 0 && (isCandidate || (isAgent && targetUserId))) {
                batchAiBtn.prop('disabled', false).removeClass('opacity-50 cursor-not-allowed');
            } else {
                batchAiBtn.prop('disabled', true).addClass('opacity-50 cursor-not-allowed');
            }
        }

        window.openRecommendJobModal = async function (jobId) {
            currentRecommendJobId = jobId;

            if (!selectedTargetUserId) {
                // „É¶„Éº„Ç∂„Éº„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÈÅ∏Êäû„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
                openCandidateSelectionModal();
                return;
            }

            const targetUserId = selectedTargetUserId;
            currentRecommendTargetUserId = targetUserId;

            // Ê±Ç‰∫∫ÊÉÖÂ†±„ÇíÂèñÂæó
            try {
                const { data: job, error } = await supabase
                    .from('jobs')
                    .select('*, companies(name)')
                    .eq('id', jobId)
                    .single();

                if (error) throw error;

                $('#recommend-job-title').text(job.title);

                // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÂèñÂæó
                const { data: user, error: userError } = await supabase
                    .from('users')
                    .select('name, email')
                    .eq('id', targetUserId)
                    .single();

                if (userError) throw userError;

                $('#recommend-target-user').text(`${user.name} (${user.email})`);
                $('#recommend-reason').val('');

                $('#recommend-job-modal').removeClass('hidden');

            } catch (error) {
                console.error('Failed to load job/user:', error);
                alert('Ê±Ç‰∫∫ÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        window.closeRecommendJobModal = function () {
            $('#recommend-job-modal').addClass('hidden');
            currentRecommendJobId = null;
            currentRecommendTargetUserId = null;
        }

        // AIËá™ÂãïÁîüÊàê
        window.generateRecommendReason = async function () {
            if (!currentRecommendJobId || !currentRecommendTargetUserId) return;

            const btn = event.target.closest('button');
            const originalHtml = $(btn).html();
            $(btn).html('<i class="fas fa-spinner fa-spin mr-1"></i>ÁîüÊàê‰∏≠...').prop('disabled', true);

            const type = $('#generate-reason-type').val() || 'recommendation';

            try {
                // Edge Function„ÇíÂëº„Å≥Âá∫„Åó„Å¶Êé®Ëñ¶Êñá„ÇíÁîüÊàê
                const { data, error } = await supabase.functions.invoke('generate-recommendation-letter', {
                    body: {
                        jobId: currentRecommendJobId,
                        candidateId: currentRecommendTargetUserId,
                        type: type
                    }
                });

                if (error) throw error;

                if (data && data.success) {
                    $('#recommend-reason').val(data.text);
                } else {
                    throw new Error(data?.error || 'ÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }

            } catch (error) {
                console.error('Failed to generate reason:', error);

                // Â§±ÊïóÊôÇ„ÅØÁ∞°Êòì„É≠„Ç∏„ÉÉ„ÇØ„Å´„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„ÄÅ„Åæ„Åü„ÅØ„Ç®„É©„ÉºË°®Á§∫
                // „Åì„Åì„Åß„ÅØÁ∞°Êòì„É≠„Ç∏„ÉÉ„ÇØ„ÇíË©¶„Åø„Çã
                try {
                    const { data: job } = await supabase.from('jobs').select('*').eq('id', currentRecommendJobId).single();
                    const { data: user } = await supabase.from('users').select('*').eq('id', currentRecommendTargetUserId).single();
                    const reason = generateSimpleReason(job, user);
                    $('#recommend-reason').val(reason);
                    alert('AIÁîüÊàê„Å´Â§±Êïó„Åó„Åü„Åü„ÇÅ„ÄÅÁ∞°Êòì„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰ΩøÁî®„Åó„Åæ„Åó„Åü');
                } catch (e) {
                    alert('„Åä„Åô„Åô„ÇÅÁêÜÁî±„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } finally {
                $(btn).html(originalHtml).prop('disabled', false);
            }
        }

        function generateSimpleReason(job, user) {
            const reasons = [];

            if (user.desired_job_category && job.job_category === user.desired_job_category) {
                reasons.push(`„ÅîÂ∏åÊúõ„ÅÆËÅ∑Á®Æ„Äå${job.job_category}„Äç„Å´ÂêàËá¥„Åó„Å¶„ÅÑ„Åæ„Åô`);
            }

            if (user.desired_location && job.location.includes(user.desired_location)) {
                reasons.push(`„ÅîÂ∏åÊúõ„ÅÆÂã§ÂãôÂú∞„Äå${user.desired_location}„Äç„Å´Ë©≤ÂΩì„Åó„Åæ„Åô`);
            }

            if (user.desired_salary_min && job.salary_max >= user.desired_salary_min) {
                reasons.push(`„ÅîÂ∏åÊúõÂπ¥Âèé${user.desired_salary_min / 10000} ‰∏áÂÜÜ‰ª•‰∏ä„ÅÆÊù°‰ª∂„ÇíÊ∫Ä„Åü„Åó„Å¶„ÅÑ„Åæ„Åô`);
            }

            if (job.is_remote && user.desired_remote) {
                reasons.push('„É™„É¢„Éº„Éà„ÉØ„Éº„ÇØÂèØËÉΩ„Å™Ê±Ç‰∫∫„Åß„Åô');
            }

            if (reasons.length === 0) {
                return `${user.name} Êßò„ÅÆ„ÅîÁµåÈ®ì„ÇÑ„Çπ„Ç≠„É´„ÇíÊ¥ª„Åã„Åõ„ÇãÊ±Ç‰∫∫„Å®„Åó„Å¶„ÅîÁ¥π‰ªã„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ${job.title} „ÅÆ„Éù„Ç∏„Ç∑„Éß„É≥„ÅØ„ÄÅ„Ç≠„É£„É™„Ç¢„Ç¢„ÉÉ„Éó„ÅÆËâØ„ÅÑÊ©ü‰ºö„Å®„Å™„Çã„Å®ËÄÉ„Åà„Å¶„Åä„Çä„Åæ„Åô„ÄÇ`;
            }

            return reasons.join('„ÄÇ') + '„ÄÇ„Åú„Å≤„ÅîÊ§úË®é„Åè„Å†„Åï„ÅÑ„ÄÇ';
        }

        // Êé®Ëñ¶„ÇíÈÄÅ‰ø°
        window.submitRecommendation = async function () {
            const reason = $('#recommend-reason').val().trim();

            if (!reason) {
                alert('„Åä„Åô„Åô„ÇÅÁêÜÁî±„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            try {
                console.log('Submitting recommendation:', {
                    organization_id: currentUser.organization_id,
                    user_id: currentRecommendTargetUserId,
                    job_id: currentRecommendJobId,
                    reason: reason,
                    score: 85,
                    recommended_by: currentUser.id
                });

                const { data, error } = await supabase
                    .from('recommendations')
                    .insert({
                        organization_id: currentUser.organization_id,
                        user_id: currentRecommendTargetUserId,
                        job_id: currentRecommendJobId,
                        reason: reason,
                        score: 85,
                        recommended_by: currentUser.id,
                        match_type: 'manual'
                    })
                    .select('*, jobs(title, company)')
                    .single();

                if (error) {
                    console.error('Supabase error details:', error);
                    throw error;
                }

                // ÈÄöÁü•‰ΩúÊàê (ÂÄôË£úËÄÖ„Å∏)
                try {
                    await supabase.from('notifications').insert({
                        user_id: currentRecommendTargetUserId,
                        title: 'Êñ∞„Åó„ÅÑ„Åä„Åô„Åô„ÇÅÊ±Ç‰∫∫„Åå„ÅÇ„Çä„Åæ„Åô',
                        message: `${currentUser.name} „Åï„Çì„Åã„Çâ„Äå${data.jobs.company} / ${data.jobs.title}„Äç„ÅÆ„Åä„Åô„Åô„ÇÅ„ÅåÂ±ä„Åç„Åæ„Åó„Åü„ÄÇ`,
                        read: false,
                        metadata: {
                            page: 'recommendations',
                            recommendation_id: data.id
                        },
                        created_at: new Date().toISOString()
                    });
                } catch (notifyError) {
                    console.error('Candidate recommendation notification error:', notifyError);
                }

                alert('Ê±Ç‰∫∫„ÇíÁ¥π‰ªã„Åó„Åæ„Åó„Åü');
                closeRecommendJobModal();
                searchJobs(); // Ê±Ç‰∫∫„É™„Çπ„Éà„ÇíÊõ¥Êñ∞

            } catch (error) {
                console.error('Failed to submit recommendation:', error);
                alert(`Êé®Ëñ¶„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message || JSON.stringify(error)} `);
            }
        }

        // ‰∏ÄÊã¨Êé®Ëñ¶/AI„Éû„ÉÉ„ÉÅ„É≥„Ç∞Ë®∫Êñ≠„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        window.openBulkRecommendModal = async function () {
            // Ê±ÇËÅ∑ËÄÖ„ÅÆÂ†¥Âêà„ÄÅËá™ÂãïÁöÑ„Å´Ëá™ÂàÜ„ÇíÂØæË±°„É¶„Éº„Ç∂„Éº„Å´„Çª„ÉÉ„Éà
            if (currentUser && currentUser.role === 'candidate') {
                selectedTargetUserId = currentUser.id;
            }
            const isAgent = currentUser && ['org_admin', 'admin', 'coach', 'ca', 'super_admin'].includes(currentUser.role);
            const isCandidate = currentUser && currentUser.role === 'candidate';

            if (selectedJobIds.size === 0) {
                alert('Ê±Ç‰∫∫„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // „Ç®„Éº„Ç∏„Çß„É≥„Éà„ÅÆÂ†¥Âêà: ÂØæË±°„É¶„Éº„Ç∂„Éº„ÅåÂøÖË¶Å
            // Ê±ÇËÅ∑ËÄÖ„ÅÆÂ†¥Âêà: Ëá™ÂàÜËá™Ë∫´„ÅåÂØæË±°
            let targetUserId;
            if (isAgent) {
                targetUserId = selectedTargetUserId;
                if (!targetUserId) {
                    alert('Êé®Ëñ¶ÂÖà„ÅÆ„É¶„Éº„Ç∂„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
            } else if (isCandidate) {
                targetUserId = currentUser.id;
            } else {
                alert('„Åì„ÅÆÊ©üËÉΩ„ÇíÂà©Áî®„Åô„ÇãÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            currentRecommendTargetUserId = targetUserId;

            try {
                // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÂèñÂæó
                const { data: user, error: userError } = await supabase
                    .from('users')
                    .select('name, email')
                    .eq('id', targetUserId)
                    .single();

                if (userError) throw userError;

                // „É¢„Éº„ÉÄ„É´„ÅÆ„Çø„Ç§„Éà„É´„Å®„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË®≠ÂÆö
                if (isCandidate) {
                    $('#bulk-recommend-modal-title').text('AI„Éû„ÉÉ„ÉÅ„É≥„Ç∞Ë®∫Êñ≠');
                    $('#bulk-recommend-target-user').text(`„ÅÇ„Å™„Åü(${user.name})`);
                } else {
                    $('#bulk-recommend-modal-title').text('AI„Éû„ÉÉ„ÉÅ');
                    $('#bulk-recommend-target-user').text(`${user.name} (${user.email})`);
                }

                $('#bulk-job-count').text(selectedJobIds.size);

                // ÈÅ∏Êäû„Åó„ÅüÊ±Ç‰∫∫„É™„Çπ„Éà„ÇíË°®Á§∫
                const jobIds = Array.from(selectedJobIds);
                const { data: jobs, error: jobsError } = await supabase
                    .from('jobs')
                    .select('id, title, companies(name)')
                    .in('id', jobIds);

                if (jobsError) throw jobsError;

                const jobsHtml = jobs.map(job => `
                    <div class="flex items-center justify-between p-2 bg-white rounded border">
                        <span class="text-sm text-gray-900">${job.title}</span>
                        <span class="text-xs text-gray-500">${job.companies?.name || ''}</span>
                    </div>
                `).join('');

                $('#bulk-jobs-list').html(jobsHtml);
                $('#bulk-recommend-modal').removeClass('hidden');

            } catch (error) {
                console.error('Failed to load data:', error);
                alert('„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        window.closeBulkRecommendModal = function () {
            $('#bulk-recommend-modal').addClass('hidden');
        }

        // AIÊé®Ëñ¶ÁµêÊûú„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
        function showAIResultModal(recommended, excluded, targetUserName) {
            const modalHtml = `
                <div class="ai-result-tabs">
                    <div class="ai-result-tab active" data-tab="recommended">
                        Á¥π‰ªã (${recommended.length}‰ª∂)
                    </div>
                    <div class="ai-result-tab" data-tab="excluded">
                        ÂØæË±°Â§ñ (${excluded.length}‰ª∂)
                    </div>
                </div>

                <div class="ai-result-content active" data-content="recommended">
                    ${recommended.length === 0 ? '<p class="text-gray-500 text-center py-8">Á¥π‰ªã„Åô„ÇãÊ±Ç‰∫∫„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>' : ''}
                    ${recommended.map(r => renderAIResultItem(r, false)).join('')}
                </div>

                <div class="ai-result-content" data-content="excluded">
                    ${excluded.length === 0 ? '<p class="text-gray-500 text-center py-8">ÂØæË±°Â§ñ„ÅÆÊ±Ç‰∫∫„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>' : ''}
                    ${excluded.map(r => renderAIResultItem(r, true)).join('')}
                </div>
        `;

            // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫ÔºàÊó¢Â≠ò„ÅÆ„É¢„Éº„ÉÄ„É´Ë°®Á§∫„É≠„Ç∏„ÉÉ„ÇØ„Çí‰ΩøÁî®Ôºâ
            // „Åì„Åì„Åß„ÅØÁ∞°ÊòìÁöÑ„Å´Êó¢Â≠ò„ÅÆbulk-recommend-modal„ÅÆ‰∏≠Ë∫´„ÇíÊõ∏„ÅçÊèõ„Åà„Å¶ÂÜçÂà©Áî®„Åô„Çã„Åã„ÄÅÊñ∞„Åó„ÅÑ„É¢„Éº„ÉÄ„É´„Çí‰Ωú„Çã
            // Êó¢Â≠ò„ÅÆ„É¢„Éº„ÉÄ„É´ÊßãÈÄ†„ÇíÂà©Áî®„Åó„Å¶‰∏≠Ë∫´„ÇíÂ∑Æ„ÅóÊõø„Åà„Çã
            $('#bulk-recommend-modal h3').text(`${targetUserName} „Åï„Çì„Å∏„ÅÆAIÁ¥π‰ªãÁµêÊûú`);
            $('#bulk-recommend-modal .modal-body').html(modalHtml); // .modal-body„ÇØ„É©„Çπ„ÅåÂøÖË¶Å

            // „ÇÇ„Åó.modal-body„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅÈÅ©Âàá„Å™„Çª„É¨„ÇØ„Çø„ÇíÊé¢„ÅôÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô„Åå„ÄÅ
            // „Åì„Åì„Åß„ÅØ‰∏ÄÊó¶„ÄÅbulk-recommend-modal„ÅÆ‰∏≠Ë∫´„ÇíÁõ¥Êé•Êõ∏„ÅçÊèõ„Åà„Çã„Ç¢„Éó„É≠„Éº„ÉÅ„Çí„Å®„Çä„Åæ„Åô„ÄÇ
            // „Åü„Å†„Åó„ÄÅÈñâ„Åò„Çã„Éú„Çø„É≥„Å™„Å©„ÅÆÊ©üËÉΩ„ÅØÁ∂≠ÊåÅ„Åó„Åü„ÅÑ„ÅÆ„Åß„ÄÅ„É¢„Éº„ÉÄ„É´„ÅÆ‰∏≠Ë∫´„ÇíÂãïÁöÑ„Å´ÁîüÊàê„Åô„ÇãÊñπ„ÅåÂÆâÂÖ®„Åß„Åô„ÄÇ

            // Êñ∞„Åó„ÅÑ„É¢„Éº„ÉÄ„É´HTML„Çíbody„Å´ËøΩÂä†Ôºà„Åæ„Å†Â≠òÂú®„Åó„Å™„ÅÑÂ†¥ÂêàÔºâ
            if ($('#ai-result-modal').length === 0) {
                $('body').append(`
                    <div id="ai-result-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" style="z-index: 10003;">
                        <div class="bg-white rounded-lg w-full max-w-3xl p-6 max-h-[90vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-gray-900">AIÁ¥π‰ªãÁµêÊûú</h3>
                                <button onclick="$('#ai-result-modal').addClass('hidden')" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div id="ai-result-modal-content"></div>
                            <div class="flex justify-end mt-4 pt-4 border-t">
                                <button onclick="$('#ai-result-modal').addClass('hidden')" class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700">Èñâ„Åò„Çã</button>
                            </div>
                        </div>
                    </div>
                `);
            }

            // AIË©≥Á¥∞ÂàÜÊûê„É¢„Éº„ÉÄ„É´„ÇíËøΩÂä†Ôºà„Åæ„Å†Â≠òÂú®„Åó„Å™„ÅÑÂ†¥ÂêàÔºâ
            if ($('#ai-detail-modal').length === 0) {
                $('body').append(`
                    <div id="ai-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" style="z-index: 10010;">
                        <div class="bg-white rounded-lg w-full max-w-4xl p-6 max-h-[90vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-gray-900">üìä AIË©≥Á¥∞ÂàÜÊûê</h3>
                                <button onclick="closeAIDetailModal()" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div id="ai-detail-modal-content"></div>
                            <div class="flex justify-end mt-4 pt-4 border-t">
                                <button onclick="closeAIDetailModal()" class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700">Èñâ„Åò„Çã</button>
                            </div>
                        </div>
                    </div>
                `);
            }

            $('#ai-result-modal h3').text(`${targetUserName} „Åï„Çì„Å∏„ÅÆAIÊé®Ëñ¶ÁµêÊûú`);
            $('#ai-result-modal-content').html(modalHtml);
            $('#ai-result-modal').removeClass('hidden');

            $('.ai-result-tab').off('click').on('click', function () {
                const tab = $(this).data('tab');
                $('.ai-result-tab').removeClass('active');
                $(this).addClass('active');
                $('.ai-result-content').removeClass('active');
                $(`.ai-result-content[data-content="${tab}"]`).addClass('active');
            });
        }

        function renderAIResultItem(result, isExcluded) {
            const itemClass = isExcluded ? 'ai-result-item excluded' : 'ai-result-item';
            const hasDetails = result.details && result.details.trim().length > 0;

            // ‰∏ÄÊÑè„ÅÆID„ÇíÁîüÊàê
            const itemId = `ai-result-${result.job_id}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

            // details„Çí„Ç∞„É≠„Éº„Éê„É´„Å´‰øùÂ≠òÔºàÂæå„Åß„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Çã„Çà„ÅÜ„Å´Ôºâ
            if (hasDetails) {
                if (!window.aiResultDetails) window.aiResultDetails = {};
                window.aiResultDetails[itemId] = {
                    jobId: result.job_id,
                    jobTitle: result.job_title,
                    company: result.company,
                    score: result.score,
                    details: result.details
                };
            }

            return `
            <div class="${itemClass}">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-gray-900">${result.job_title}</h4>
                        <span class="text-sm font-bold ${isExcluded ? 'text-gray-600' : 'text-indigo-600'}">
                            „Éû„ÉÉ„ÉÅÂ∫¶: ${result.score}%
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">${result.company}</p>
                    <p class="text-sm text-gray-700 mb-3">${result.reason}</p>
                    <div class="flex gap-3 items-center">
                        <button 
                            class="text-xs text-blue-600 hover:text-blue-800 underline font-medium"
                            onclick="event.stopPropagation(); window.showJobDetailModal('${result.job_id}')"
                        >
                            <i class="fas fa-file-alt mr-1"></i>Ê±Ç‰∫∫Ë©≥Á¥∞„ÇíË¶ã„Çã
                        </button>
                        ${hasDetails ? `
                            <button 
                                class="ai-detail-btn text-xs text-indigo-600 hover:text-indigo-800 underline"
                                data-item-id="${itemId}"
                                onclick="event.stopPropagation(); window.openAIDetail('${itemId}')"
                           >
                                üìä Ë©≥Á¥∞ÂàÜÊûê„ÇíË¶ã„Çã
                            </button>
                        ` : ''
                }
                    </div>
                </div>
            `;
        }

        // Ë©≥Á¥∞„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©
        window.openAIDetail = function (itemId) {
            console.log('openAIDetail called with itemId:', itemId);
            console.log('Current aiResultDetails:', window.aiResultDetails);

            const data = window.aiResultDetails ? window.aiResultDetails[itemId] : null;
            if (data) {
                console.log('Found detail data:', data);
                showAIDetailModal(data.jobId, data.jobTitle, data.company, data.score, data.details);
            } else {
                console.error('AI detail data not found for itemId:', itemId);
                alert('Ë©≥Á¥∞„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            }
        };

        // AIË©≥Á¥∞ÂàÜÊûê„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
        window.showAIDetailModal = function (jobId, jobTitle, company, score, details) {
            const modalHtml = `
            <div class="mb-4">
                    <h4 class="text-lg font-bold text-gray-900 mb-1">${jobTitle}</h4>
                    <p class="text-sm text-gray-600 mb-2">${company}</p>
                    <div class="inline-block bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-bold">
                        „Éû„ÉÉ„ÉÅÂ∫¶: ${score}%
                    </div>
                </div>
            <div class="bg-gray-50 p-4 rounded-lg">
                <pre class="whitespace-pre-wrap text-sm text-gray-800 font-sans">${details}</pre>
            </div>
        `;

            $('#ai-detail-modal-content').html(modalHtml);
            $('#ai-detail-modal').removeClass('hidden');
        }

        window.closeAIDetailModal = function () {
            $('#ai-detail-modal').addClass('hidden');
        }

        // ‰∏ÄÊã¨Êé®Ëñ¶/AI„Éû„ÉÉ„ÉÅ„É≥„Ç∞Ë®∫Êñ≠„ÇíÈÄÅ‰ø°
        // ‰∏ÄÊã¨Êé®Ëñ¶/AI„Éû„ÉÉ„ÉÅ„É≥„Ç∞Ë®∫Êñ≠„ÇíÈÄÅ‰ø°
        window.submitBulkRecommendation = async function () {
            const btn = event.target.closest('button');
            const originalHtml = $(btn).html();
            $(btn).html('<i class="fas fa-spinner fa-spin mr-2"></i>Âá¶ÁêÜ‰∏≠...').prop('disabled', true);

            const isCandidate = currentUser && currentUser.role === 'candidate';

            // ÂØæË±°„É¶„Éº„Ç∂„ÉºID„ÅÆÊ±∫ÂÆö
            let targetUserId;
            let targetUserName;

            if (isCandidate) {
                targetUserId = currentUser.id;
                targetUserName = currentUser.name;
            } else {
                // ÁÆ°ÁêÜËÄÖ„Éª„Ç≥„Éº„ÉÅ„ÅÆÂ†¥Âêà
                if (!selectedTargetUserId) {
                    alert('AIÁ¥π‰ªãÂØæË±°„É¶„Éº„Ç∂„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    $(btn).html(originalHtml).prop('disabled', false);
                    return;
                }
                targetUserId = selectedTargetUserId;
                targetUserName = selectedTargetUserName;
            }

            try {
                // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÂèñÂæó
                const { data: userData, error: userFetchError } = await supabase
                    .from('users')
                    .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                    .eq('id', targetUserId)
                    .single();

                if (userFetchError) throw userFetchError;

                // „Éó„É≠„Éï„Ç£„Éº„É´„Éá„Éº„Çø„ÅÆ„Éï„É©„ÉÉ„ÉàÂåñ (AI-MatchingÈñ¢Êï∞„Å∏Ê∏°„Åô„Åü„ÇÅ)
                const profile = Array.isArray(userData.candidate_profiles) ? userData.candidate_profiles[0] : userData.candidate_profiles;
                const user = { ...userData, ...profile };

                // „Éï„É™„Éº„ÉØ„Éº„ÉâÊù°‰ª∂„ÇíÊòéÁ§∫ÁöÑ„Å´„Çª„ÉÉ„Éà („ÇÇ„Åó„Éï„É©„ÉÉ„ÉàÂåñ„ÅßÊºè„Çå„Å¶„ÇÇÁ¢∫ÂÆü„Å´Ê∏°„Çã„Çà„ÅÜ„Å´)
                if (profile) {
                    user.desired_freewords = profile.desired_freewords;
                    user.desired_freewords_condition = profile.desired_freewords_condition || 'and';
                }

                console.log('Sending User to AI-Matching:', user);

                // ÂêÑÊ±Ç‰∫∫„Å´ÂØæ„Åó„Å¶Êé®Ëñ¶„Çí‰ΩúÊàê
                const jobIds = Array.from(selectedJobIds);
                const { data: jobs } = await supabase
                    .from('jobs')
                    .select('*, companies(*)')
                    .in('id', jobIds);

                // AIÂàÜÊûêAPI„ÇíÂëº„Å≥Âá∫„Åô
                let recommendations = [];
                try {
                    const { data: aiResults, error: aiError } = await supabase.functions.invoke('ai-matching', {
                        body: { user, jobs }
                    });

                    if (aiError) throw aiError;

                    recommendations = aiResults.map(result => {
                        const job = jobs.find(j => j.id === result.job_id);
                        const ruleBased = calculateClientSideMatchScores(job, user);
                        return {
                            organization_id: currentUser.organization_id,
                            user_id: targetUserId,
                            job_id: result.job_id,
                            reason: result.recommendation_reason || result.reason || 'AI„Éû„ÉÉ„ÉÅ„É≥„Ç∞',
                            score: result.ineligible ? 10 : (result.match_score || ruleBased.match_score || 0),
                            recommended_by: currentUser.id,
                            job_title: job ? job.title : '',
                            company: job ? (job.companies?.name || job.company) : '',
                            details: result.details, // Ë©≥Á¥∞ÂàÜÊûêÁµêÊûú
                            culture_score: result.culture_match_score || ruleBased.culture_match_score || 0
                        };
                    });
                } catch (e) {
                    console.warn('AI Matching Function failed, falling back to dummy logic:', e);
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºà„ÉÄ„Éü„Éº„É≠„Ç∏„ÉÉ„ÇØÔºâ
                    recommendations = jobs.map(job => {
                        const score = Math.floor(Math.random() * 65) + 30;
                        return {
                            organization_id: currentUser.organization_id,
                            user_id: targetUserId,
                            job_id: job.id,
                            reason: generateSimpleReason(job, user),
                            score: score,
                            recommended_by: currentUser.id,
                            job_title: job.title,
                            company: job.company
                        };
                    });
                }

                // DB„Å´‰øùÂ≠òÔºàdetails„Å®culture_score„ÇÇÂê´„ÇÅ„ÇãÔºâ
                const dbRecommendations = recommendations.map(r => {
                    const { job_title, company, ...dbRecord } = r;
                    return dbRecord;
                });

                const { error } = await supabase
                    .from('recommendations')
                    .insert(dbRecommendations);

                if (error) throw error;

                // „É≠„Ç∞Ë®òÈå≤
                await auditLog.bulkRecommendationExecuted(recommendations.length, {
                    target_user_id: targetUserId,
                    job_ids: Array.from(selectedJobIds)
                });

                // ÁµêÊûú„ÇíÂàÜÈ°û
                const recommended = recommendations.filter(r => r.score >= 50);
                const excluded = recommendations.filter(r => r.score < 50);

                // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
                closeBulkRecommendModal();

                // ÁµêÊûú„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
                showAIResultModal(recommended, excluded, targetUserName);

                selectedJobIds.clear();
                updateBulkRecommendBar();
                searchJobs(); // Ê±Ç‰∫∫„É™„Çπ„Éà„ÇíÊõ¥Êñ∞

            } catch (error) {
                console.error('Failed to submit bulk recommendations:', error);
                alert('‰∏ÄÊã¨Êé®Ëñ¶„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            } finally {
                $(btn).html(originalHtml).prop('disabled', false);
            }
        }

        // ============================================
        // Ê±Ç‰∫∫Ëµ∑ÁÇπ„Éû„ÉÉ„ÉÅ„É≥„Ç∞Ê©üËÉΩ
        // ============================================

        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        window.currentJobId = null;
        window.jobMatchesCache = [];

        // „Çø„ÉñÂàá„ÇäÊõø„ÅàÊ©üËÉΩ
        window.switchJobDetailTab = function (tab) {
            // „Çø„Éñ„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´Êõ¥Êñ∞
            $('.job-detail-tab').each(function () {
                $(this).removeClass('border-indigo-600 text-indigo-600');
                $(this).addClass('border-transparent text-gray-500');
            });

            if (tab === 'details') {
                $('#job-tab-details').removeClass('border-transparent text-gray-500');
                $('#job-tab-details').addClass('border-indigo-600 text-indigo-600');
                $('#job-detail-tab-content').removeClass('hidden');
                $('#job-candidates-tab-content').addClass('hidden');
            } else if (tab === 'candidates') {
                $('#job-tab-candidates').removeClass('border-transparent text-gray-500');
                $('#job-tab-candidates').addClass('border-indigo-600 text-indigo-600');
                $('#job-detail-tab-content').addClass('hidden');
                $('#job-candidates-tab-content').removeClass('hidden');

                // ÂÄôË£úËÄÖ„Çø„Éñ„ÇíÈñã„ÅÑ„Åü„Å®„Åç„Å´„ÄÅ„Åæ„Å†„Éû„ÉÉ„ÉÅ„É≥„Ç∞„ÇíÂÆüË°å„Åó„Å¶„ÅÑ„Å™„Åë„Çå„Å∞Êó¢Â≠ò„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
                if (jobMatchesCache.length === 0) {
                    loadJobMatches();
                }
            }
        }

        // „Éû„ÉÉ„ÉÅ„É≥„Ç∞ÂÆüË°å
        // „Éû„ÉÉ„ÉÅ„É≥„Ç∞ÂÆüË°å („ÇØ„É©„Ç§„Ç¢„É≥„Éà„Çµ„Ç§„Éâ‰∫àÂÇôÂÆüË£Ö)
        window.runJobMatching = async function () {
            if (!window.currentJobId || !currentUser) {
                alert('Ê±Ç‰∫∫ÊÉÖÂ†±„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì');
                return;
            }

            const btn = $('#run-matching-btn');
            const originalHtml = btn.html();

            try {
                // „Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
                btn.prop('disabled', true);
                btn.html('<i class="fas fa-spinner fa-spin mr-2"></i>„Éû„ÉÉ„ÉÅ„É≥„Ç∞‰∏≠...');

                console.log('Running job matching (Client-Side) for job:', window.currentJobId);

                // 1. Ê±Ç‰∫∫ÊÉÖÂ†±„ÇíÂèñÂæó
                const { data: job, error: jobError } = await window.supabase
                    .from('jobs')
                    .select('*')
                    .eq('id', window.currentJobId)
                    .single();

                if (jobError) throw jobError;

                // 2. ÂÄôË£úËÄÖ„ÇíÂèñÂæóÔºà„Éó„É≠„Éï„Ç£„Éº„É´ÁµêÂêàÔºâ
                const { data: candidates, error: candError } = await window.supabase
                    .from('users')
                    .select('*, candidate_profiles(*)')
                    .eq('organization_id', currentUser.organization_id)
                    .eq('role', 'candidate');

                if (candError) throw candError;

                console.log(`Found ${candidates.length} candidates`);

                // 3. „Éû„ÉÉ„ÉÅ„É≥„Ç∞„Çπ„Ç≥„Ç¢Ë®àÁÆó
                const matches = candidates.map(user => {
                    // „Éó„É≠„Éï„Ç£„Éº„É´„Éá„Éº„Çø„ÅÆÁµêÂêà
                    const profile = Array.isArray(user.candidate_profiles) ? (user.candidate_profiles[0] || {}) : (user.candidate_profiles || {});
                    const candidate = { ...user, ...profile };

                    // „Çπ„Ç≥„Ç¢Ë®àÁÆó
                    const scores = calculateClientSideMatchScores(job, candidate);

                    return {
                        job_id: window.currentJobId,
                        candidate_id: user.id,
                        organization_id: currentUser.organization_id,
                        candidate: candidate, // Ensure candidate object is passed for rendering
                        ...scores,
                        recommendation_reason: generateClientSideRecommendationReason(job, candidate, scores),
                        recommendation_details: {
                            job_requirements: extractClientSideJobRequirements(job),
                            candidate_strengths: extractClientSideCandidateStrengths(candidate),
                            match_points: identifyClientSideMatchPoints(job, candidate, scores)
                        },
                        matched_at: new Date().toISOString()
                    };
                });

                // 4. „Çπ„Ç≥„Ç¢„Åß„ÇΩ„Éº„Éà & „Éï„Ç£„É´„Çø„É™„É≥„Ç∞
                matches.sort((a, b) => b.match_score - a.match_score);
                const limit = 30;
                const topMatches = matches.filter(m => m.match_score >= 20).slice(0, limit); // Â∞ë„ÅóÁ∑©„ÇÅ„Å´20ÁÇπ‰ª•‰∏ä

                console.log(`Top ${topMatches.length} matches calculated`);

                // 5. „Éá„Éº„Çø„Éô„Éº„Çπ„Å´‰øùÂ≠ò
                // DB„Å´Â≠òÂú®„Åó„Å™„ÅÑ„Ç´„É©„É† (candidate„Å™„Å©) „ÇíÈô§Â§ñ„Åó„Å¶‰øùÂ≠òÁî®„Éá„Éº„Çø„Çí‰ΩúÊàê
                const upsertData = topMatches.map(({ candidate, ...rest }) => rest);

                const { error: insertError } = await window.supabase
                    .from('job_candidate_matches')
                    .upsert(upsertData, {
                        onConflict: 'job_id,candidate_id',
                        ignoreDuplicates: false
                    });

                if (insertError) throw insertError;

                // 4. ÁµêÊûúË°®Á§∫ÔºàÂÖ±ÈÄöÈñ¢Êï∞„Çí‰ΩøÁî®Ôºâ
                renderMatchingResults(matches, '#job-candidates-list');

                alert(`${matches.length} ‰ª∂„ÅÆÂÄôË£úËÄÖ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„ÅüÔºà„Éû„ÉÉ„ÉÅ: ${matches.filter(m => m.match_score > 49).length} ‰ª∂Ôºâ`);

            } catch (error) {
                console.error('Job matching error:', error);
                alert('„Éû„ÉÉ„ÉÅ„É≥„Ç∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (error.message || '‰∏çÊòé„Å™„Ç®„É©„Éº'));
            } finally {
                // „Éú„Çø„É≥„ÇíÂÖÉ„Å´Êàª„Åô
                btn.prop('disabled', false);
                btn.html(originalHtml);
            }
        }

        // ============================================
        // „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Çµ„Ç§„Éâ„Éû„ÉÉ„ÉÅ„É≥„Ç∞„É≠„Ç∏„ÉÉ„ÇØ
        // ============================================

        const CRITICAL_KEYWORDS = [
            'Á®éÂãô', 'Ê≥ïÂãô', 'ÁµåÁêÜ', 'Ë≤°Âãô', '‰ºöË®à', '‰∫∫‰∫ã', 'Âä¥Âãô', 'Êé°Áî®',
            '„Ç®„É≥„Ç∏„Éã„Ç¢', '„Éó„É≠„Ç∞„É©„Éû„Éº', 'SE', 'ÈñãÁô∫', '„Ç§„É≥„Éï„É©', '„Éï„É≠„É≥„Éà„Ç®„É≥„Éâ', '„Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ', ,
            'ÂåªÂ∏´', 'ÁúãË≠∑Â∏´', 'Ëñ¨Ââ§Â∏´', 'ÂºÅË≠∑Â£´', '‰ºöË®àÂ£´', 'Á®éÁêÜÂ£´',
            'Âñ∂Ê•≠', '„Çª„Éº„É´„Çπ', '„Éû„Éº„Ç±„ÉÜ„Ç£„É≥„Ç∞', 'Â∫ÉÂ†±'
        ];
        const WELCOME_KEYWORDS = ['Êú™ÁµåÈ®ì', '„Éù„ÉÜ„É≥„Ç∑„É£„É´', '‰∏çÂïè', 'ÊåëÊà¶', 'ÂàùÂøÉËÄÖ', 'Á¨¨‰∫åÊñ∞Âçí'];

        function calculateClientSideMatchScores(job, candidate) {
            let skillScore = 50;
            let experienceScore = 50;
            let locationScore = 50;
            let salaryScore = 50;
            let cultureScore = 50;

            const jobReqs = extractClientSideSkills(job.requirements);
            const candSkills = extractClientSideSkills(candidate.skills);

            // Skill
            if (jobReqs.length > 0) {
                const matchCount = jobReqs.filter(js => candSkills.some(cs => cs.includes(js) || js.includes(cs))).length;
                skillScore = Math.min(100, (matchCount / jobReqs.length) * 100 + 20);
            } else {
                skillScore = candSkills.length > 0 ? 60 : 40;
            }

            // Experience (Title match)
            const jobTitle = (job.title || '').toLowerCase();
            const workHistory = (candidate.work_history || '').toLowerCase();
            if (workHistory.includes(jobTitle) || jobTitle.includes(candidate.desired_job_type || '#####')) {
                experienceScore = 80;
            } else if (workHistory.length > 10) {
                experienceScore = 60;
            }

            // Salary
            // Salary
            if (candidate.desired_salary) {
                // If candidate wants more than Job Max (and Max is set), it's a mismatch
                if (job.salary_max && candidate.desired_salary > job.salary_max) {
                    salaryScore = 20;
                } else if (job.salary_min) {
                    // If candidate matches Min or is reasonably within range
                    if (candidate.desired_salary <= job.salary_min * 1.2) salaryScore = 80;
                    else if (candidate.desired_salary <= job.salary_min * 1.5) salaryScore = 60;
                    else salaryScore = 40;
                }
            }

            // Keyword Count for Penalty
            const requirementsText = (job.requirements || '').toLowerCase();
            const candidateText = JSON.stringify(candidate).toLowerCase();
            const isUnskilledWelcome = WELCOME_KEYWORDS.some(w => (job.title + requirementsText).includes(w));

            let match_score = (skillScore * 0.4 + experienceScore * 0.3 + salaryScore * 0.3);

            // Simple Penalty
            if (!isUnskilledWelcome && match_score < 40) match_score *= 0.8;

            return {
                match_score: Math.round(match_score),
                skill_match_score: Math.round(skillScore),
                experience_match_score: Math.round(experienceScore),
                location_match_score: Math.round(locationScore),
                salary_match_score: Math.round(salaryScore),
                culture_match_score: Math.round(cultureScore)
            };
        }

        function extractClientSideSkills(text) {
            if (!text) return [];
            return text.split(/[,„ÄÅ\n\s]/).map(s => s.trim().toLowerCase()).filter(s => s.length > 1);
        }

        function generateClientSideRecommendationReason(job, candidate, scores) {
            if (scores.match_score >= 60) return 'Êù°‰ª∂„ÅåÊ¶Ç„Å≠‰∏ÄËá¥„Åó„Å¶„Åä„Çä„ÄÅÊúâÂäõ„Å™ÂÄôË£ú„Åß„Åô„ÄÇ';
            if (scores.skill_match_score >= 70) return '„Çπ„Ç≠„É´„Çª„ÉÉ„Éà„Åå„Éû„ÉÉ„ÉÅ„Åó„Å¶„ÅÑ„Åæ„Åô„Åå„ÄÅ‰ªñ„ÅÆÊù°‰ª∂„ÅßË™øÊï¥„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ';
            return '‰∏ÄÈÉ®Ë¶Å‰ª∂„ÇíÊ∫Ä„Åü„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„Åå„ÄÅ„Éù„ÉÜ„É≥„Ç∑„É£„É´Êé°Áî®„Å®„Åó„Å¶Ê§úË®éÂèØËÉΩ„Åß„Åô„ÄÇ'
        }

        function extractClientSideJobRequirements(job) {
            return { title: job.title, skills: extractClientSideSkills(job.requirements || '') };
        }
        function extractClientSideCandidateStrengths(candidate) {
            return { name: candidate.name, skills: extractClientSideSkills(candidate.skills || '') };
        }
        function identifyClientSideMatchPoints(job, candidate, scores) {
            const pts = [];
            if (scores.skill_match_score >= 60) pts.push('„Çπ„Ç≠„É´');
            if (scores.experience_match_score >= 60) pts.push('ÁµåÈ®ì');
            return pts;
        }

        // Êó¢Â≠ò„ÅÆ„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÁµêÊûú„ÇíË™≠„ÅøËæº„Åø
        async function loadJobMatches() {
            if (!window.currentJobId || !currentUser) return;

            try {
                const { data, error } = await window.supabase
                    .from('job_candidate_matches')
                    .select('*, users(*)')
                    .eq('job_id', window.currentJobId)
                    .eq('organization_id', currentUser.organization_id)
                    .gte('match_score', 50)
                    .order('match_score', { ascending: false })
                    .limit(30);

                if (error) throw error;

                jobMatchesCache = data || [];

                // ÂÄôË£úËÄÖÊï∞„ÇíË°®Á§∫
                $('#job-candidates-count').text(jobMatchesCache.length);

                if (jobMatchesCache.length > 0) {
                    renderJobCandidates(jobMatchesCache);
                }

            } catch (error) {
                console.error('Load matches error:', error);
            }
        }

        // ÂÖ±ÈÄö„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÁµêÊûú„É¨„É≥„ÉÄ„É™„É≥„Ç∞Èñ¢Êï∞
        function renderMatchingResults(matches, containerSelector) {
            const container = $(containerSelector);
            container.empty();

            if (!matches || matches.length === 0) {
                container.html(`
            <div class="text-center py-12 text-gray-500 shadow-sm border rounded-lg bg-white">
                        <i class="fas fa-search text-4xl mb-3"></i>
                        <p>„Éû„ÉÉ„ÉÅ„Åô„ÇãÂÄôË£úËÄÖ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</p>
                    </div>
            `);
                return;
            }

            const okMatches = matches.filter(m => m.match_score > 49);
            const ngMatches = matches.filter(m => m.match_score <= 49);

            const containerId = containerSelector.replace('#', '');

            const headerHtml = `
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden mb-6">
                <div class="flex border-b border-gray-100 items-center">
                    <button onclick="switchMatchTab('${containerSelector}', 'ok')"
                        id="${containerId}-tab-ok"
                        class="flex-1 py-4 px-6 text-sm font-bold border-b-2 border-green-500 text-green-600 transition-all hover:bg-green-50">
                        <i class="fas fa-check-circle mr-2"></i>„Éû„ÉÉ„ÉÅ: ${okMatches.length}‰ª∂
                    </button>
                    <button onclick="switchMatchTab('${containerSelector}', 'ng')"
                        id="${containerId}-tab-ng"
                        class="flex-1 py-4 px-6 text-sm font-bold border-b-2 border-transparent text-gray-400 transition-all hover:bg-gray-50">
                        <i class="fas fa-times-circle mr-2"></i>NG: ${ngMatches.length}‰ª∂
                    </button>
                    <div class="px-4 border-l border-gray-100">
                        <button onclick="$('${containerSelector}').html('<div class=\\'text-center py-12 text-gray-500 rounded-lg border bg-white shadow-sm\\'><i class=\\'fas fa-search text-4xl mb-3\\'></i><p>Êù°‰ª∂„ÇíÊåáÂÆö„Åó„Å¶Ê§úÁ¥¢„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p></div>')"
                            class="text-xs text-gray-400 hover:text-red-500 flex flex-col items-center gap-1 transition-colors">
                            <i class="fas fa-trash-alt"></i>
                            <span>„ÇØ„É™„Ç¢</span>
                        </button>
                    </div>
                </div>
                </div>

                <div id="${containerId}-pane-ok" class="space-y-4">
                    ${okMatches.length > 0 ? okMatches.map(m => renderCandidateCard(m)).join('') : `
                        <div class="text-center py-16 bg-white border border-dashed border-gray-300 rounded-lg text-gray-400">
                            <i class="fas fa-info-circle mb-2 text-2xl"></i>
                            <p>„Éû„ÉÉ„ÉÅ„Åô„ÇãÂÄôË£úËÄÖ„ÅØË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</p>
                        </div>
                    `}
                </div>
                <div id="${containerId}-pane-ng" class="space-y-4 hidden">
                    ${ngMatches.length > 0 ? ngMatches.map(m => renderCandidateCard(m)).join('') : `
                        <div class="text-center py-16 bg-white border border-dashed border-gray-300 rounded-lg text-gray-400">
                            <i class="fas fa-info-circle mb-2 text-2xl"></i>
                            <p>NGÂÄôË£úËÄÖ„ÅØ„ÅÑ„Åæ„Åõ„Çì</p>
                        </div>
                    `}
                </div>
        `;

            container.html(headerHtml);
        }

        window.switchMatchTab = function (containerSelector, tab) {
            const containerId = containerSelector.replace('#', '');
            const tabOk = $(`#${containerId}-tab-ok`);
            const tabNg = $(`#${containerId}-tab-ng`);
            const paneOk = $(`#${containerId}-pane-ok`);
            const paneNg = $(`#${containerId}-pane-ng`);

            if (tab === 'ok') {
                tabOk.addClass('border-green-500 text-green-600').removeClass('border-transparent text-gray-400');
                tabNg.addClass('border-transparent text-gray-400').removeClass('border-red-500 text-red-600'); // red-500 if we want NG to be red, but image shows gray
                // Applying gray style for non-active as default in HTML, so here just toggle
                tabNg.addClass('border-transparent text-gray-400').removeClass('border-gray-600 text-gray-800');

                paneOk.removeClass('hidden');
                paneNg.addClass('hidden');
            } else {
                tabNg.addClass('border-gray-600 text-gray-800').removeClass('border-transparent text-gray-400');
                tabOk.addClass('border-transparent text-gray-400').removeClass('border-green-500 text-green-600');

                paneNg.removeClass('hidden');
                paneOk.addClass('hidden');
            }
        }

        // ÂÄôË£úËÄÖ„É™„Çπ„Éà„ÇíË°®Á§∫ (Deprecated: use renderMatchingResults)
        function renderJobCandidates(matches) {
            renderMatchingResults(matches, '#job-candidates-list');
        }

        // ÂÄôË£úËÄÖ„Ç´„Éº„Éâ„ÇíÁîüÊàê
        function renderCandidateCard(match) {
            const candidate = match.users || match.candidate || {};
            const matchScore = match.match_score || 0;
            const skillScore = match.skill_match_score || 0;
            const expScore = match.experience_match_score || 0;
            const locScore = match.location_match_score || 0;
            const salScore = match.salary_match_score || 0;
            const culScore = match.culture_match_score || 0;

            // „Çπ„Ç≥„Ç¢„Å´Âøú„Åò„ÅüËâ≤
            // „Çπ„Ç≥„Ç¢„Å´Âøú„Åò„ÅüËâ≤
            const getScoreColor = (score) => {
                if (score >= 80) return 'text-green-600 bg-green-50';
                if (score >= 60) return 'text-blue-600 bg-blue-50';
                if (score >= 50) return 'text-yellow-600 bg-yellow-50';
                return 'text-gray-500 bg-gray-100 border border-gray-200'; // NG (<= 49)
            };

            const getScoreBarColor = (score) => {
                if (score >= 80) return 'bg-green-500';
                if (score >= 60) return 'bg-blue-500';
                if (score >= 50) return 'bg-yellow-500';
                return 'bg-gray-300';
            };

            const renderScoreBar = (label, score, colorClass) => {
                return `
            <div class="text-center">
                        <div class="text-xs text-gray-500 mb-1">${label}</div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mb-1">
                            <div class="${colorClass} h-2 rounded-full transition-all" style="width: ${score}%"></div>
                        </div>
                        <div class="text-xs font-semibold text-gray-700">${score.toFixed(0)}%</div>
                    </div>
            `;
            };

            return `
            <div class="border rounded-lg p-6 hover:shadow-lg transition bg-white">
                <div class="flex justify-between items-start gap-4">
                    <div class="mr-2 pt-1 flex flex-col items-center">
                        <input type="checkbox"
                            class="candidate-select-checkbox h-5 w-5 rounded border-gray-300 focus:ring-indigo-500 cursor-pointer ${candidate.status === 'suspended' ? 'text-gray-400 bg-gray-100 cursor-not-allowed opacity-50' : 'text-indigo-600'}"
                            value="${candidate.id}"
                            ${candidate.status === 'suspended' ? 'disabled' : ''}>
                            ${candidate.status === 'suspended' ? '<span class="text-[10px] text-red-500 font-bold mt-1 nowrap">ÂÅúÊ≠¢‰∏≠</span>' : ''}
                    </div>
                    <div class="flex-1">
                        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
                        <div class="flex items-center gap-3 mb-3">
                            <h4 class="font-semibold text-lg text-gray-900">${candidate.name || 'ÂêçÂâçÊú™Ë®≠ÂÆö'}</h4>
                            <span class="px-3 py-1 ${getScoreColor(matchScore)} rounded-full text-sm font-medium">
                                „Éû„ÉÉ„ÉÅÂ∫¶: ${matchScore.toFixed(1)}%
                            </span>
                            <span class="px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full ${candidate.management_status === 'inactive' ? 'bg-gray-200 text-gray-700' : 'bg-blue-100 text-blue-800'}">
                                ${candidate.management_status === 'inactive' ? 'Ê¥ªÂãïÁµÇ‰∫Ü' : 'Ê¥ªÂãï‰∏≠'}
                            </span>
                        </div>

                        <!-- Âü∫Êú¨ÊÉÖÂ†± -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-4 text-sm text-gray-600">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-briefcase text-gray-400"></i>
                                <span>${window.formatArrayValue(candidate.desired_job_type)}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-map-marker-alt text-gray-400"></i>
                                <span>${window.formatArrayValue(candidate.desired_location)}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-yen-sign text-gray-400"></i>
                                <span>${window.formatSalaryValue(candidate.desired_salary)}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-envelope text-gray-400"></i>
                                <span class="text-xs">${candidate.email || ''}</span>
                            </div>
                        </div>

                        <!-- „Éû„ÉÉ„ÉÅ„É≥„Ç∞Ë©≥Á¥∞„Çπ„Ç≥„Ç¢ -->
                        <div class="mb-4">
                            <div class="text-xs text-gray-500 mb-2">Ë©≥Á¥∞„Çπ„Ç≥„Ç¢</div>
                            <div class="grid grid-cols-5 gap-2">
                                ${renderScoreBar('„Çπ„Ç≠„É´', skillScore, getScoreBarColor(skillScore))}
                                ${renderScoreBar('ÁµåÈ®ì', expScore, getScoreBarColor(expScore))}
                                ${renderScoreBar('Âã§ÂãôÂú∞', locScore, getScoreBarColor(locScore))}
                                ${renderScoreBar('Âπ¥Âèé', salScore, getScoreBarColor(salScore))}
                                ${renderScoreBar('ÊñáÂåñ', culScore, getScoreBarColor(culScore))}
                            </div>
                        </div>

                        <!-- AIË©ï‰æ°ÁêÜÁî± -->
                        ${match.recommendation_reason ? `
                            <div class="${matchScore >= 50 ? 'bg-blue-50 border-blue-400' : 'bg-gray-50 border-gray-400'} border-l-4 p-3 mb-3">
                                <div class="flex items-start gap-2">
                                    <i class="fas ${matchScore >= 50 ? 'fa-lightbulb text-blue-600' : 'fa-clipboard-list text-gray-500'} mt-1"></i>
                                    <div class="flex-1">
                                        <p class="text-sm ${matchScore >= 50 ? 'text-blue-800' : 'text-gray-700'} font-medium">AIË©ï‰æ°ÁêÜÁî±</p>
                                        <p class="text-sm ${matchScore >= 50 ? 'text-blue-700' : 'text-gray-600'}">${match.recommendation_reason}</p>
                                    </div>
                                </div>
                            </div>
                            ` : ''}

                        <!-- „Çπ„Ç≠„É´ -->
                        ${candidate.skills ? `
                            <div class="text-sm">
                                <span class="text-gray-600">„Çπ„Ç≠„É´:</span>
                                <span class="text-gray-800">${window.formatArrayValue(candidate.skills)}</span>
                            </div>
                            ` : ''}
                    </div>

                    <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ -->
                    <div class="flex flex-col gap-2">
                        <button onclick="viewCandidateProfile('${candidate.id}')" class="px-4 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 text-sm whitespace-nowrap">
                            <i class="fas fa-user mr-1"></i>Ë©≥Á¥∞
                        </button>
                        <button onclick="showAdminUserModal('${candidate.id}')" class="px-4 py-2 bg-amber-50 text-amber-700 border border-amber-200 rounded hover:bg-amber-100 text-sm whitespace-nowrap">
                            <i class="fas fa-edit mr-1"></i>„É¶„Éº„Ç∂„ÉºÁ∑®ÈõÜ
                        </button>
                        <button onclick="openScoutModal('${match.id || ''}', '${candidate.id}')" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm whitespace-nowrap shadow-sm">
                            <i class="fas fa-magic mr-1"></i>„Çπ„Ç´„Ç¶„Éà‰ΩúÊàê
                        </button>
                        <button onclick="updateMatchStatus('${match.id || ''}', 'not_interested', '${candidate.id}')"
                            class="px-4 py-2 bg-red-100 text-red-700 rounded hover:bg-red-200 text-sm whitespace-nowrap">
                            <i class="fas fa-times mr-1"></i>ÂØæË±°Â§ñ
                        </button>
                    </div>
                </div>
                </div>
            `;
        }

        // „Çπ„Ç´„Ç¶„Éà„É¢„Éº„ÉÄ„É´Èñ¢ÈÄ£„ÅÆÂ§âÊï∞
        let currentScoutMatchId = null;
        let currentScoutCandidateId = null;

        // „Çπ„Ç´„Ç¶„Éà„É¢„Éº„ÉÄ„É´„ÇíÈñã„ÅèÔºàAIÁîüÊàêÂÆüË°åÔºâ
        window.openScoutModal = async function (matchId, candidateId) {
            console.log('openScoutModal called:', { matchId, candidateId });

            let actualJobId = window.selectedTargetJobId || window.currentJobId;
            if (!actualJobId) {
                alert('ÂØæË±°„ÅÆÊ±Ç‰∫∫„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            let targetMatchId = (matchId && matchId !== 'undefined') ? matchId : null;

            // „Éû„ÉÉ„ÉÅ„É¨„Ç≥„Éº„Éâ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ‰ΩúÊàê„ÇíË©¶„Åø„Çã
            if (!targetMatchId) {
                showLoading('Ê∫ñÂÇô‰∏≠...');
                try {
                    // Êó¢Â≠ò„ÅÆ„Éû„ÉÉ„ÉÅ„É¨„Ç≥„Éº„Éâ„ÇíÁ¢∫Ë™ç
                    const { data: existing, error: checkError } = await window.supabase
                        .from('job_candidate_matches')
                        .select('id')
                        .eq('job_id', actualJobId)
                        .eq('candidate_id', candidateId)
                        .maybeSingle();

                    if (checkError) throw checkError;

                    if (existing) {
                        targetMatchId = existing.id;
                    } else {
                        // Êñ∞Ë¶è‰ΩúÊàê
                        const { data, error } = await window.supabase
                            .from('job_candidate_matches')
                            .insert({
                                job_id: actualJobId,
                                candidate_id: candidateId,
                                status: 'draft',
                                organization_id: currentUser.organization_id
                            })
                            .select('id')
                            .single();

                        if (error) throw error;
                        targetMatchId = data.id;
                    }
                } catch (e) {
                    console.error('Failed to create match for scout:', e);
                    alert('Ê∫ñÂÇô„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + e.message);
                    hideLoading();
                    return;
                } finally {
                    hideLoading();
                }
            }

            console.log('Match ID obtained:', targetMatchId);
            currentScoutMatchId = targetMatchId;
            currentScoutCandidateId = candidateId;

            // ÂÄôË£úËÄÖÂêç„ÇíË°®Á§∫
            let candidateName = 'ÂÄôË£úËÄÖ';
            // „Ç≠„É£„ÉÉ„Ç∑„É•„Åã„ÇâÊé¢„Åô
            if (typeof jobMatchesCache !== 'undefined') {
                const m = jobMatchesCache.find(m => m.id === targetMatchId || (m.candidate && m.candidate.id === candidateId) || (m.users && m.id === targetMatchId));
                if (m) candidateName = (m.users ? m.users.name : (m.candidate ? m.candidate.name : 'ÂÄôË£úËÄÖ'));
            }
            if (candidateName === 'ÂÄôË£úËÄÖ') {
                // „Åï„Çâ„Å´Ë©≥Á¥∞„Éú„Çø„É≥Á≠â„Åã„ÇâÂèñÂæó„ÇíË©¶„Åø„Çã
                candidateName = $(`button[onclick *= "'${candidateId}'"]`).closest('.border').find('h3, .text-lg.font-bold').first().text().trim() || 'ÂÄôË£úËÄÖ';
            }

            console.log('Candidate name:', candidateName);
            $('#scout-candidate-name').text(candidateName);

            // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫Ôºà„É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖãÔºâ
            console.log('Opening scout modal...');
            $('#scout-subject').val('ÁîüÊàê‰∏≠...');
            $('#scout-body').val('AI„Åå„Çπ„Ç´„Ç¶„ÉàÊñáÈù¢„ÇíÁîüÊàê„Åó„Å¶„ÅÑ„Åæ„Åô...\nÂ∞ë„ÄÖ„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ');

            // „Çπ„ÇØ„É≠„Éº„É´„ÇíÊúÄ‰∏äÈÉ®„Å´ÁßªÂãï
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // „É¢„Éº„ÉÄ„É´„Çíbody„ÅÆÁõ¥‰∏ã„Å´ÁßªÂãïÔºàË¶™Ë¶ÅÁ¥†„ÅÆhidden„ÇØ„É©„Çπ„ÅÆÂΩ±Èüø„ÇíÂèó„Åë„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„ÇãÔºâ
            const modal = document.getElementById('scout-modal');
            if (modal && modal.parentElement.id !== 'body') {
                document.body.appendChild(modal);
            }

            // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
            $('#scout-modal').removeClass('hidden').css('display', 'flex');

            // „É¢„Éº„ÉÄ„É´„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
            const isVisible = !$('#scout-modal').hasClass('hidden');
            const displayStyle = $('#scout-modal').css('display');
            console.log('Modal visibility after opening:', isVisible);
            console.log('Modal display style:', displayStyle);
            console.log('Modal element:', $('#scout-modal')[0]);

            // „É¢„Éº„ÉÄ„É´„Å´„Éï„Ç©„Éº„Ç´„Çπ„ÇíÂΩì„Å¶„Çã
            $('#scout-modal').focus();

            console.log('Calling generateScoutMessage...');
            await generateScoutMessage(actualJobId, currentScoutCandidateId, currentScoutMatchId);
            console.log('generateScoutMessage completed');

            // „É¢„Éº„ÉÄ„É´„Åå„Åæ„Å†Ë°®Á§∫„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
            setTimeout(() => {
                const stillVisible = !$('#scout-modal').hasClass('hidden');
                console.log('Modal still visible after 100ms:', stillVisible);
                if (!stillVisible) {
                    console.error('Modal was closed unexpectedly!');
                }
            }, 100);
        }

        // „Çπ„Ç´„Ç¶„ÉàÊñáÈù¢ÁîüÊàêÔºàÂÜçÁîüÊàêÔºâ
        window.regenerateScoutMessage = async function () {
            if (!currentScoutMatchId) return;
            const actualJobId = window.selectedTargetJobId || window.currentJobId;

            $('#scout-body').val('AI„Åå„Çπ„Ç´„Ç¶„ÉàÊñáÈù¢„ÇíÂÜçÁîüÊàê„Åó„Å¶„ÅÑ„Åæ„Åô...');
            await generateScoutMessage(actualJobId, currentScoutCandidateId, currentScoutMatchId);
        }

        // Edge Function„ÇíÂëº„Å≥Âá∫„Åó„Å¶ÊñáÈù¢ÁîüÊàê
        async function generateScoutMessage(jobId, candidateId, matchId) {
            console.log('generateScoutMessage called with:', { jobId, candidateId, matchId });

            if (!jobId || !candidateId) {
                console.error('generateScoutMessage: Missing jobId or candidateId', { jobId, candidateId });
                throw new Error('job_id and candidate_id are required');
            }
            try {
                console.log('Calling Edge Function: generate-scout-message');
                const { data, error } = await window.supabase.functions.invoke('generate-scout-message', {
                    body: {
                        job_id: jobId,
                        candidate_id: candidateId,
                        match_id: matchId
                    }
                });

                console.log('Edge Function response:', { data, error });

                if (error) throw error;

                if (data.success) {
                    console.log('Scout message generated successfully');
                    $('#scout-subject').val(data.subject);
                    // „Ç®„Çπ„Ç±„Éº„Éó„Åï„Çå„ÅüÊîπË°åÊñáÂ≠ó„ÇíÂÆüÈöõ„ÅÆÊîπË°å„Å´Â§âÊèõ
                    const bodyWithNewlines = data.body.replace(/\\n/g, '\n');
                    $('#scout-body').val(bodyWithNewlines);
                } else {
                    throw new Error(data.error || 'ÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }

            } catch (error) {
                console.error('Scout generation error:', error);
                alert('„Çπ„Ç´„Ç¶„ÉàÊñáÈù¢„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                $('#scout-body').val('ÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÊâãÂãï„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        }

        // „Çπ„Ç´„Ç¶„Éà„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        window.closeScoutModal = function () {
            console.log('closeScoutModal called');
            console.trace('Stack trace:');
            $('#scout-modal').addClass('hidden').css('display', 'none');
            currentScoutMatchId = null;
            currentScoutCandidateId = null;
        }

        // „Çπ„Ç´„Ç¶„ÉàÈÄÅ‰ø°Âá¶ÁêÜ
        window.sendScoutMessage = async function () {
            if (!currentScoutMatchId) return;

            const subject = $('#scout-subject').val();
            const body = $('#scout-body').val();

            if (!subject || !body) {
                alert('‰ª∂Âêç„Å®Êú¨Êñá„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            if (!confirm('„Åì„ÅÆÂÜÖÂÆπ„Åß„Çπ„Ç´„Ç¶„Éà„ÇíÈÄÅ‰ø°„Åó„Åæ„Åô„ÅãÔºü')) {
                return;
            }

            try {
                showLoading('„Çπ„Ç´„Ç¶„ÉàÈÄÅ‰ø°‰∏≠...');

                // 1. „Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞
                await updateMatchStatus(currentScoutMatchId, 'contacted');

                // 2. ÂÄôË£úËÄÖ„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂèñÂæó
                const { data: candidate, error: userError } = await supabase
                    .from('users')
                    .select('email, name')
                    .eq('id', currentScoutCandidateId)
                    .single();

                if (userError || !candidate) {
                    console.warn('ÂÄôË£úËÄÖÊÉÖÂ†±„ÅÆÂèñÂæóÂ§±Êïó:', userError);
                    alert('„Çπ„ÉÜ„Éº„Çø„Çπ„ÅØÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü„Åå„ÄÅÂÄôË£úËÄÖ„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅåÂèñÂæó„Åß„Åç„Å™„Åã„Å£„Åü„Åü„ÇÅ„É°„Éº„É´„ÅØÈÄÅ‰ø°„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ');
                } else if (!candidate.email) {
                    alert('„Çπ„ÉÜ„Éº„Çø„Çπ„ÅØÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü„Åå„ÄÅÂÄôË£úËÄÖ„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅåÊú™ÁôªÈå≤„ÅÆ„Åü„ÇÅ„É°„Éº„É´„ÅØÈÄÅ‰ø°„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ');
                } else {
                    // 3. „É°„Éº„É´ÈÄÅ‰ø°FunctionÂëº„Å≥Âá∫„Åó (Resend)
                    const { data: emailData, error: emailError } = await supabase.functions.invoke('send-email', {
                        body: {
                            type: 'scout',
                            to: candidate.email,
                            data: {
                                userName: candidate.name || 'Ê±ÇËÅ∑ËÄÖ',
                                subject: subject,
                                body: body,
                                scoutUrl: 'https://rightjob2025.github.io/matching/index-supabase.html' // Áµ±‰∏Ä„É™„ÉÄ„Ç§„É¨„ÇØ„ÉàURL
                            }
                        }
                    });

                    if (emailError) {
                        console.error('Email sending failed:', emailError);
                        alert('„Çπ„ÉÜ„Éº„Çø„Çπ„ÅØÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü„Åå„ÄÅ„É°„Éº„É´ÈÄÅ‰ø°API„ÅÆÂëº„Å≥Âá∫„Åó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\n(Resend API Key„ÅÆË®≠ÂÆöÁ≠â„Çí„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ)');
                    } else {
                        console.log('Email sent successfully:', emailData);
                        alert('„Çπ„Ç´„Ç¶„Éà„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„ÅüÔºÅ\n(ÂÄôË£úËÄÖ„Å∏„É°„Éº„É´ÈÄöÁü•„ÇíË°å„ÅÑ„Åæ„Åó„Åü)');
                    }
                }

                closeScoutModal();

            } catch (error) {
                console.error('Send scout error:', error);
                alert('ÈÄÅ‰ø°Âá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // „Éû„ÉÉ„ÉÅ„É≥„Ç∞„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
        window.updateMatchStatus = async function (matchId, status, candidateId) {
            let targetMatchId = (matchId && matchId !== 'undefined' && matchId !== '') ? matchId : null;
            let jobId = (typeof selectedTargetJobId !== 'undefined' ? selectedTargetJobId : null) || window.selectedTargetJobId || window.currentJobId;

            try {
                if (!targetMatchId) {
                    if (!jobId || !candidateId) {
                        alert('ÂØæË±°„ÅÆÊ±Ç‰∫∫„Åæ„Åü„ÅØÂÄôË£úËÄÖ„ÇíÁâπÂÆö„Åß„Åç„Åæ„Åõ„Çì');
                        return;
                    }

                    const { data, error } = await window.supabase
                        .from('job_candidate_matches')
                        .upsert({
                            job_id: jobId,
                            candidate_id: candidateId,
                            status: status,
                            organization_id: currentUser.organization_id
                        }, { onConflict: 'job_id, candidate_id' })
                        .select('id')
                        .single();

                    if (error) throw error;
                    targetMatchId = data.id;
                } else {
                    const { error } = await window.supabase
                        .from('job_candidate_matches')
                        .update({ status: status })
                        .eq('id', targetMatchId);

                    if (error) throw error;
                }

                // ÁîªÈù¢‰∏ä„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
                if (status === 'not_interested') {
                    // ÂØæË±°Â§ñ„ÅÆÂ†¥Âêà„ÅØ„Ç´„Éº„Éâ„Çí„Ç∞„É¨„Éº„Ç¢„Ç¶„Éà„Åó„Å¶„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
                    // „Çª„É¨„ÇØ„Çø„ÇíÊüîËªü„Å´ÔºàID„Åå„ÅÇ„ÇãÂ†¥Âêà„Å®„Å™„ÅÑÂ†¥Âêà‰∏°ÊñπÂØæÂøúÔºâ
                    let selector = `button[onclick *= "'${targetMatchId}', 'not_interested'"]`;
                    if (candidateId) selector += `, button[onclick *= "'${candidateId}')"]`;

                    const card = $(selector).closest('.border');
                    card.addClass('opacity-50 bg-gray-100');
                    card.find('button').prop('disabled', true);
                    card.find('.status-badge').remove();
                    card.find('.flex.justify-between').append('<span class="status-badge px-2 py-1 bg-red-100 text-red-800 text-xs rounded">ÂØæË±°Â§ñ</span>');
                }

            } catch (error) {
                console.error('Update match status error:', error);
                alert('„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                throw error;
            }
        }
        // „Éò„É´„Éë„ÉºÈñ¢Êï∞: JSONÈÖçÂàóÊñáÂ≠óÂàó„Åã„ÇÇ„Åó„Çå„Å™„ÅÑÂÄ§„Çí„Éë„Éº„Çπ„Åó„Å¶ÈÖçÂàó„Åæ„Åü„ÅØÊñáÂ≠óÂàó„Å®„Åó„Å¶Ëøî„Åô
        window.safeParseList = function (val) {
            if (!val) return [];
            if (Array.isArray(val)) return val.filter(Boolean);
            if (typeof val === 'string') {
                val = val.trim();
                if (!val) return [];

                // JSON ÂΩ¢Âºè„ÅÆÂ†¥Âêà
                if (val.startsWith('[') && val.endsWith(']')) {
                    try {
                        const parsed = JSON.parse(val);
                        return Array.isArray(parsed) ? parsed.filter(Boolean) : [parsed].filter(Boolean);
                    } catch (e) {
                        try {
                            const parsed = JSON.parse(val.replace(/'/g, '"'));
                            return Array.isArray(parsed) ? parsed.filter(Boolean) : [parsed].filter(Boolean);
                        } catch (e2) {
                            // JSON„Éë„Éº„ÇπÂ§±ÊïóÊôÇ„ÅØÁ∂öË°å
                        }
                    }
                }

                // „Ç´„É≥„Éû„ÄÅË™≠ÁÇπ„ÄÅÂÖ®Ëßí„Ç´„É≥„Éû„Å™„Å©„ÅßÂå∫Âàá„Çã
                // „Çπ„Éö„Éº„Çπ„ÅØ„ÄåÊ≥ï‰∫∫Âñ∂Ê•≠ (BtoB)„Äç„ÅÆ„Çà„ÅÜ„Å´È†ÖÁõÆÂêç„Å´Âê´„Åæ„Çå„ÇãÂ†¥Âêà„Åå„ÅÇ„Çã„Åü„ÇÅ„ÄÅ
                // ‰ªñ„Å´Âå∫Âàá„ÇäÊñáÂ≠ó„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Çπ„Éö„Éº„Çπ„ÅßÂàÜÂâ≤„Åó„Å™„ÅÑ„ÄÇ
                if (val.includes(',') || val.includes('„ÄÅ') || val.includes('\uff0c')) {
                    return val.split(/[,„ÄÅ\uff0c]+/).map(s => s.trim()).filter(Boolean);
                }

                // Âå∫Âàá„ÇäÊñáÂ≠ó„Åå„Å™„ÅÑ„Åå„Çπ„Éö„Éº„Çπ„ÅåÂê´„Åæ„Çå„ÇãÂ†¥ÂêàÔºàÂøµ„ÅÆ„Åü„ÇÅ„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
                if (val.includes(' ') || val.includes('„ÄÄ')) {
                    // „Åü„Å†„Åó„ÄÅ„Åì„Çå„Åæ„Åß„ÅÆ„Äå„Çπ„Éö„Éº„Çπ„ÇíÂê´„ÇÄÂçò‰∏ÄÈ†ÖÁõÆ„Äç„ÇíÂ£ä„Åï„Å™„ÅÑ„Çà„ÅÜÊ≥®ÊÑè„ÅåÂøÖË¶Å
                    // „Åì„Åì„Åß„ÅØÊó¢Â≠ò„ÅÆ„É≠„Ç∏„ÉÉ„ÇØ„Å®„ÅÆ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÂàÜÂâ≤„Åô„Çã„Åå„ÄÅ‰∏äË®ò„Åß„Ç´„É≥„ÉûÂå∫Âàá„Çä„ÇíÂÑ™ÂÖà„Åô„Çã„Åì„Å®„Åß
                    // „ÄåÊ≥ï‰∫∫Âñ∂Ê•≠ (BtoB), „Ç≠„É£„É™„Ç¢„Äç„ÅÆ„Çà„ÅÜ„Å™„Ç±„Éº„Çπ„ÅØÂÆà„Çâ„Çå„Çã„ÄÇ
                    return val.split(/\s+/).map(s => s.trim()).filter(Boolean);
                }

                return [val];
            }
            return [val];
        }

        // „Éò„É´„Éë„ÉºÈñ¢Êï∞: ÈÖçÂàó„Åæ„Åü„ÅØÊñáÂ≠óÂàó„ÇíË°®Á§∫Áî®„Å´„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        window.formatArrayValue = function (val) {
            const parsed = window.safeParseList(val);
            if (Array.isArray(parsed)) {
                return parsed.join(' / ');
            }
            return parsed || '-';
        }

        // „Éò„É´„Éë„ÉºÈñ¢Êï∞: Âπ¥Âèé„ÇíË°®Á§∫Áî®„Å´„Éï„Ç©„Éº„Éû„ÉÉ„Éà (‰∏áÂÜÜÂçò‰Ωç)
        window.formatSalaryValue = function (val) {
            if (!val) return '-';
            // Êï∞ÂÄ§‰ª•Â§ñ„ÇíÈô§Âéª
            const strVal = String(val).replace(/[^0-9]/g, '');
            if (!strVal) return val; // Êï∞ÂÄ§„ÅåÂê´„Åæ„Çå„Å™„ÅÑÂ†¥Âêà„ÅØ„Åù„ÅÆ„Åæ„ÅæËøî„Åô

            let num = parseInt(strVal);
            if (isNaN(num)) return val;

            // 10‰∏áÂÜÜ‰ª•‰∏ä„ÅÆÂ†¥Âêà„ÅØÂÜÜÂçò‰Ωç„Å®„Åø„Å™„Åó„Å¶10000„ÅßÂâ≤„Çã
            if (num >= 100000) {
                num = Math.round(num / 10000);
            }
            return num.toLocaleString() + '‰∏áÂÜÜ';
        }

        // ÂÄôË£úËÄÖ„Éó„É≠„Éï„Ç£„Éº„É´Ë°®Á§∫Ôºà„Éó„É¨„Éì„É•„ÉºÂ∞ÇÁî®Ôºâ
        window.viewCandidateProfile = async function (candidateId) {
            if (!candidateId) {
                alert('ÂÄôË£úËÄÖID„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì');
                return;
            }

            $('#interview-candidate-id').val(candidateId);
            showLoading();

            showLoading();
            try {
                // ÂÄôË£úËÄÖÊÉÖÂ†±„ÇíÂèñÂæó
                const { data: userData, error } = await window.supabase
                    .from('users')
                    .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                    .eq('id', candidateId)
                    .single();

                if (error) throw error;
                if (!userData) {
                    alert('ÂÄôË£úËÄÖÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
                    return;
                }

                // „Éó„É≠„Éï„Ç£„Éº„É´„Éá„Éº„Çø„ÇíÁµêÂêàÔºà„Éï„É©„ÉÉ„ÉàÂåñÔºâ
                const profile = Array.isArray(userData.candidate_profiles) ? userData.candidate_profiles[0] : (userData.candidate_profiles || {});
                const candidate = { ...userData, ...profile };

                $('#candidate-detail-title').text(candidate.name || 'ÂêçÂâçÊú™Ë®≠ÂÆö');
                $('#candidate-email-header').text(candidate.email || '');
                $('#candidate-avatar-header').text(candidate.name ? candidate.name.charAt(0) : '?');

                // „Éò„ÉÉ„ÉÄ„Éº„É°„ÇøÊÉÖÂ†± (Âπ¥ÈΩ¢„ÄÅÊÄßÂà•„ÄÅÂ±Ö‰ΩèÂú∞)
                const metaParts = [];
                if (candidate.age) metaParts.push(`${candidate.age}Ê≠≥`);
                if (candidate.gender) metaParts.push(candidate.gender);
                if (candidate.current_location) metaParts.push(candidate.current_location);

                if (metaParts.length > 0) {
                    $('#candidate-header-meta').text(metaParts.join(' / ')).show();
                } else {
                    $('#candidate-header-meta').hide();
                }

                // „Éó„É¨„Éì„É•„Éº„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÁîüÊàê („Éò„ÉÉ„ÉÄ„ÉºÊÉÖÂ†±„ÇíÈô§„ÅÑ„ÅüË©≥Á¥∞)
                const content = `
                    <!-- 1. Â∏åÊúõÊù°‰ª∂ -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-star mr-2 text-yellow-500"></i>Â∏åÊúõÊù°‰ª∂
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600 mb-1">Â∏åÊúõËÅ∑Á®Æ</p>
                                <p class="font-medium text-gray-900">${window.formatArrayValue(candidate.desired_job_type)}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-1">Â∏åÊúõÂã§ÂãôÂú∞</p>
                                <p class="font-medium text-gray-900">${window.formatArrayValue(candidate.desired_location)}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-1">Â∏åÊúõÂπ¥Âèé</p>
                                <p class="font-medium text-gray-900 text-lg text-indigo-600">
                                    ${window.formatSalaryValue(candidate.desired_salary)}
                                </p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-1">ÈõáÁî®ÂΩ¢ÊÖã</p>
                                <p class="font-medium text-gray-900">${window.formatArrayValue(candidate.desired_employment_type)}</p>
                            </div>
                            <div class="col-span-1 md:col-span-2">
                                <p class="text-sm text-gray-600 mb-2">„Åì„Å†„Çè„ÇäÊù°‰ª∂</p>
                                <div class="flex flex-wrap gap-2">
                                    ${candidate.desired_job_experience_ok ? '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">ËÅ∑Á®ÆÊú™ÁµåÈ®ìOK</span>' : ''}
                                    ${candidate.desired_industry_experience_ok ? '<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">Ê•≠ÁïåÊú™ÁµåÈ®ìOK</span>' : ''}
                                    ${!candidate.desired_job_experience_ok && !candidate.desired_industry_experience_ok ? '<span class="text-gray-400 text-sm">-</span>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. „Çπ„Ç≠„É´ -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-code mr-2 text-blue-500"></i>„Çπ„Ç≠„É´
                        </h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-gray-800 whitespace-pre-wrap text-sm leading-relaxed">${candidate.skills || '-'}</p>
                        </div>
                    </div>

                    <!-- 3. ËÅ∑Ê≠¥Ê¶ÇË¶Å -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-briefcase mr-2 text-green-500"></i>ËÅ∑Ê≠¥Ê¶ÇË¶Å
                        </h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-gray-800 whitespace-pre-wrap text-sm leading-relaxed">${candidate.work_history || '-'}</p>
                        </div>
                    </div>

                    <!-- 3.5 Ë©≥Á¥∞ËÅ∑Ê≠¥ (ÊßãÈÄ†Âåñ„Éá„Éº„Çø) -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-list-ul mr-2 text-indigo-500"></i>ÁµåÊ≠¥Ë©≥Á¥∞
                        </h4>
                        <div class="space-y-4">
                            ${candidate.work_history_structured && Array.isArray(candidate.work_history_structured) && candidate.work_history_structured.length > 0
                        ? candidate.work_history_structured.map((wh, idx) => `
                                    <div class="border-l-4 border-indigo-200 pl-4 py-1">
                                        <div class="flex justify-between items-start mb-1">
                                            <h5 class="font-bold text-gray-900">${wh.company_name || 'ÂêçÁß∞Êú™Ë®≠ÂÆö'}</h5>
                                            <span class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-0.5 rounded">${wh.period || '-'}</span>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-1 mb-2">
                                            ${wh.industry ? `
                                                <div class="flex items-start text-xs text-gray-600">
                                                    <span class="font-semibold mr-1 w-16 flex-shrink-0 text-gray-400">Ê•≠Á®Æ:</span>
                                                    <span>${wh.industry}</span>
                                                </div>
                                            ` : ''}
                                            ${wh.job_category ? `
                                                <div class="flex items-start text-xs text-gray-600">
                                                    <span class="font-semibold mr-1 w-16 flex-shrink-0 text-gray-400">ËÅ∑Á®Æ:</span>
                                                    <span>${wh.job_category}</span>
                                                </div>
                                            ` : ''}
                                            ${wh.role ? `
                                                <div class="flex items-start text-xs text-gray-600">
                                                    <span class="font-semibold mr-1 w-16 flex-shrink-0 text-gray-400">ÂΩπËÅ∑:</span>
                                                    <span>${wh.role}</span>
                                                </div>
                                            ` : ''}
                                        </div>
                                        ${wh.description ? `
                                            <div class="text-sm text-gray-700 whitespace-pre-wrap leading-relaxed bg-white p-2 border border-gray-100 rounded">${wh.description}</div>
                                        ` : ''}
                                    </div>
                                `).join('')
                        : '<p class="text-gray-400 text-sm text-center py-4 italic">ÊßãÈÄ†Âåñ„Åï„Çå„ÅüËÅ∑Ê≠¥„Éá„Éº„Çø„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>'
                    }
                        </div>
                    </div>

                    <!-- „Åä„Åô„Åô„ÇÅÂØæË±°Â§ñ‰ºÅÊ•≠ (Read-only for detail view) -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-ban mr-2 text-red-500"></i>„Åä„Åô„Åô„ÇÅÂØæË±°Â§ñ‰ºÅÊ•≠
                        </h4>
                        <div id="candidate-detail-excluded-companies" class="flex flex-wrap gap-2">
                            <p class="text-gray-400 text-sm italic">Ë™≠„ÅøËæº„Åø‰∏≠...</p>
                        </div>
                    </div>

                    <!-- 4. Â±•Ê≠¥ÊÉÖÂ†± -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-history mr-2 text-indigo-500"></i>Â±•Ê≠¥ÊÉÖÂ†±
                        </h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-gray-800 whitespace-pre-wrap text-sm leading-relaxed">${candidate.history_info || '-'}</p>
                        </div>
                    </div>

                    <!-- 5. Á§æÂÜÖ„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÊÉÖÂ†± -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-file-alt mr-2 text-gray-500"></i>Á§æÂÜÖ„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÊÉÖÂ†±
                        </h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-gray-800 whitespace-pre-wrap text-sm leading-relaxed">${candidate.resume || '-'}</p>
                        </div>
                    </div>

                    <!-- 6. Á§æÂÜÖ„É°„É¢„ÉªÂÖ±Êúâ‰∫ãÈ†Ö -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-user-circle mr-2 text-pink-500"></i>Á§æÂÜÖ„É°„É¢„ÉªÂÖ±Êúâ‰∫ãÈ†Ö
                        </h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-gray-800 whitespace-pre-wrap text-sm leading-relaxed">${candidate.notes || candidate.self_pr || '-'}</p>
                        </div>
                    </div>

                    <!-- „Åù„ÅÆ‰ªñÂü∫Êú¨ÊÉÖÂ†± (ÂøÖË¶ÅÊúÄ‰ΩéÈôê) -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-info-circle mr-2 text-gray-500"></i>Âü∫Êú¨ÊÉÖÂ†±
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600 mb-1">Âπ¥ÈΩ¢</p>
                                <p class="font-medium text-gray-900">${candidate.age ? candidate.age + 'Ê≠≥' : '-'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-1">Â≠¶Ê≠¥</p>
                                <p class="font-medium text-gray-900">${candidate.education || '-'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-1">ÈõªË©±Áï™Âè∑</p>
                                <p class="font-medium text-gray-900">${candidate.phone || '-'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-1">ÁôªÈå≤Êó•</p>
                                <p class="font-medium text-gray-900">${new Date(candidate.created_at).toLocaleDateString('ja-JP')}</p>
                            </div>
                        </div>
                    </div>
                `;

                console.log('Final step: Rendering to candidate preview and forcing visibility.');
                $('#candidate-preview-content').html(content);

                const modal = $('#candidate-preview-modal');
                if (modal.length === 0) {
                    console.error('CRITICAL: #candidate-preview-modal not found!');
                    return;
                }
                // Move to body to avoid parent clipping/z-index issues
                $('body').append(modal);

                console.log('Updating candidate preview visibility...');
                modal.removeClass('hidden').attr('style', 'display: flex !important; z-index: 40000 !important; visibility: visible !important; opacity: 1 !important;');

                // ÈõÜÁ¥ÑÁîªÈù¢Áî®„ÅÆ„Éá„Éº„Çø„É≠„Éº„Éâ
                console.log('Fetching excluded companies for detail view...');
                const { data: excludedCos, error: ecError } = await window.supabase
                    .from('excluded_companies')
                    .select('companies(name)')
                    .eq('user_id', candidateId);

                const $ecContainer = $('#candidate-detail-excluded-companies');
                if (!ecError && excludedCos && excludedCos.length > 0) {
                    $ecContainer.empty();
                    excludedCos.forEach(ec => {
                        $ecContainer.append(`
                            <span class="px-2 py-1 bg-red-50 text-red-700 text-xs rounded-full border border-red-100">
                                ${ec.companies?.name || '‰∏çÊòé„Å™‰ºÅÊ•≠'}
                            </span>
                        `);
                    });
                } else {
                    $ecContainer.html('<p class="text-gray-400 text-sm">-</p>');
                }

                // Êé®Ëñ¶„ÉªÂøúÂãüÂ±•Ê≠¥„ÅÆ„É≠„Éº„Éâ
                loadInterviewHistory(candidateId);
                loadSelectionProgress(candidateId);

                console.log('viewCandidateProfile process complete');

            } catch (error) {
                console.error('Load candidate error:', error);
                alert('ÂÄôË£úËÄÖÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            } finally {
                hideLoading();
            }
        }

        // ÂÄôË£úËÄÖ„Éó„É¨„Éì„É•„Éº„ÇíÈñâ„Åò„Çã
        window.closeCandidatePreview = function () {
            console.log('--- closeCandidatePreview Triggered ---');
            $('#candidate-preview-modal').addClass('hidden').attr('style', 'display: none !important;');
        }

        // --- ÂÄôË£úËÄÖË©≥Á¥∞„Çø„ÉñÂàá„ÇäÊõø„Åà ---
        window.switchCandidateDetailTab = function (tab) {
            $('.candidate-tab-content').addClass('hidden');
            $('.candidate-tab-btn').removeClass('active border-indigo-500 text-indigo-600').addClass('border-transparent text-gray-500');

            $(`#tab-content-${tab}`).removeClass('hidden');
            $(`#btn-tab-${tab}`).addClass('active border-indigo-500 text-indigo-600').removeClass('border-transparent text-gray-500');

            const candidateId = $('#interview-candidate-id').val();
            if (candidateId) {
                if (tab === 'interviews') loadInterviewHistory(candidateId);
                if (tab === 'progress') loadSelectionProgress(candidateId);
            }
        }

        // --- Èù¢Ë´áÂ±•Ê≠¥Ê©üËÉΩ ---
        window.openInterviewRecordModal = function () {
            const candidateId = $('#interview-candidate-id').val() || $('#admin-user-id').val();
            console.log('Opening interview record modal for candidate:', candidateId);
            if (!candidateId) {
                alert('ÂÄôË£úËÄÖ„ÅåÁâπÂÆö„Åß„Åç„Åæ„Åõ„Çì');
                return;
            }

            const modal = $('#interview-record-modal');
            $('body').append(modal); // Ensure it's at body level

            $('#interview-id').val('');
            $('#interview-candidate-id').val(candidateId);
            $('#interview-date').val(new Date().toISOString().split('T')[0]);
            $('#interview-content').val('');
            $('#interview-next-action').val('');

            modal.removeClass('hidden').attr('style', 'display: flex !important; z-index: 50000 !important;');
        }

        window.closeInterviewRecordModal = function () {
            console.log('Closing interview record modal');
            const modal = $('#interview-record-modal');
            modal.addClass('hidden').attr('style', 'display: none !important;');

            // Áä∂ÊÖã„É™„Çª„ÉÉ„Éà
            $('#interview-id').val('');
            $('#interview-content').val('');
            $('#interview-next-action').val('');
        }

        window.editInterviewRecord = async function (interviewId) {
            showLoading();
            try {
                const { data, error } = await supabase
                    .from('candidate_interviews')
                    .select('*')
                    .eq('id', interviewId)
                    .single();

                if (error) throw error;

                const modal = $('#interview-record-modal');
                $('body').append(modal);

                $('#interview-id').val(data.id);
                $('#interview-candidate-id').val(data.candidate_id);
                $('#interview-date').val(data.interview_date);
                $('#interview-type').val(data.interview_type);
                $('#interview-content').val(data.content);
                $('#interview-next-action').val(data.next_action);

                modal.removeClass('hidden').attr('style', 'display: flex !important; z-index: 50000 !important;');
            } catch (err) {
                console.error('Edit interview error:', err);
                alert('Èù¢Ë´áË©≥Á¥∞„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            } finally {
                hideLoading();
            }
        }

        // Èù¢Ë´áÂ±•Ê≠¥‰øùÂ≠ò (ÂßîË≠≤„Çí‰ΩøÁî®„Åó„Å¶„Ç§„Éô„É≥„Éà„ÇíÁ¢∫ÂÆü„Å´„Åô„Çã)
        $(document).off('submit', '#interview-record-form').on('submit', '#interview-record-form', async function (e) {
            e.preventDefault();
            console.log('Submitting interview record form');

            const candidateId = $('#interview-candidate-id').val();
            const interviewId = $('#interview-id').val();
            const date = $('#interview-date').val();
            const type = $('#interview-type').val();
            const content = $('#interview-content').val();
            const nextAction = $('#interview-next-action').val();

            if (!currentUser) {
                alert('„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„ÄÇÂÜçÂ∫¶„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }
            if (!candidateId) {
                alert('ÂÄôË£úËÄÖÊÉÖÂ†±„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì');
                return;
            }

            showLoading('‰øùÂ≠ò‰∏≠...');
            try {
                const interviewData = {
                    organization_id: currentUser.organization_id,
                    candidate_id: candidateId,
                    interviewer_id: currentUser.id,
                    interview_date: date,
                    interview_type: type,
                    content: content,
                    next_action: nextAction
                };

                let result;
                if (interviewId) {
                    result = await supabase
                        .from('candidate_interviews')
                        .update(interviewData)
                        .eq('id', interviewId);
                } else {
                    result = await supabase
                        .from('candidate_interviews')
                        .insert(interviewData);
                }

                if (result.error) throw result.error;

                alert('Èù¢Ë´áÂ±•Ê≠¥„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
                closeInterviewRecordModal();
                loadInterviewHistory(candidateId);
            } catch (err) {
                console.error('Save interview history error:', err);
                alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + err.message);
            } finally {
                hideLoading();
            }
        });

        // Èù¢Ë´áÂ±•Ê≠¥„É≠„Éº„Éâ
        async function loadInterviewHistory(candidateId) {
            const container = $('#interview-list-container');
            container.html('<div class="text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Ë™≠„ÅøËæº„Åø‰∏≠...</div>');

            try {
                const { data, error } = await supabase
                    .from('candidate_interviews')
                    .select('*, users!interviewer_id(name)')
                    .eq('candidate_id', candidateId)
                    .order('interview_date', { ascending: false });

                if (error) throw error;

                if (!data || data.length === 0) {
                    container.html('<div class="text-center py-8 text-gray-500"><i class="fas fa-comments text-3xl mb-2 block"></i><p>Èù¢Ë´áÂ±•Ê≠¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p></div>');
                    return;
                }

                const html = data.map(item => `
                    <div class="bg-white border border-gray-200 rounded-lg p-5 shadow-sm hover:shadow-md transition-shadow group">
                        <div class="flex justify-between items-start mb-3">
                            <span class="px-3 py-1 bg-indigo-50 text-indigo-700 text-xs font-bold rounded-full">${item.interview_type}</span>
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-500 font-medium">${new Date(item.interview_date).toLocaleDateString('ja-JP')}</span>
                                <button onclick="editInterviewRecord('${item.id}')" class="text-gray-400 hover:text-indigo-600 transition-colors opacity-0 group-hover:opacity-100">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                        <div class="text-sm text-gray-800 whitespace-pre-wrap leading-relaxed mb-4">${item.content}</div>
                        ${item.next_action ? `
                        <div class="bg-amber-50 border-l-4 border-amber-400 p-3 text-sm">
                            <p class="font-bold text-amber-800 mb-1"><i class="fas fa-bolt mr-2"></i>„Éç„ÇØ„Çπ„Éà„Ç¢„ÇØ„Ç∑„Éß„É≥</p>
                            <p class="text-amber-700">${item.next_action}</p>
                        </div>
                        ` : ''}
                        <div class="mt-4 pt-3 border-t flex justify-end">
                            <span class="text-xs text-gray-400">ÊãÖÂΩì: ${item.users?.name || '‰∏çÊòé'}</span>
                        </div>
                    </div>
                `).join('');

                container.html(html);
            } catch (err) {
                console.error('Load interview history error:', err);
                container.html('<div class="text-center py-8 text-red-500">Â±•Ê≠¥„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>');
            }
        }

        // --- ÈÅ∏ËÄÉÈÄ≤ÊçóÊ©üËÉΩ ---
        async function loadSelectionProgress(candidateId) {
            const container = $('#selection-progress-container');
            container.html('<div class="text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Ë™≠„ÅøËæº„Åø‰∏≠...</div>');

            try {
                const { data, error } = await supabase
                    .from('applications')
                    .select('*, jobs(*, companies(name))')
                    .eq('user_id', candidateId)
                    .order('updated_at', { ascending: false });

                if (error) throw error;

                // „Çπ„ÉÜ„Éº„Çø„Çπ„Éû„Çπ„Çø„ÇíÂèñÂæó
                const { data: statusMasters } = await supabase
                    .from('master_data')
                    .select('label, value')
                    .eq('type', 'application_status')
                    .order('sort_order');

                const statuses = statusMasters && statusMasters.length > 0
                    ? statusMasters.map(m => m.label)
                    : ['Êõ∏È°ûÈÅ∏ËÄÉ‰∏≠', 'Êõ∏È°ûÈÅ∏ËÄÉÈÄöÈÅé', '‰∏ÄÊ¨°Èù¢Êé•‰∫àÂÆö', '‰∏ÄÊ¨°Èù¢Êé•ÂÆå‰∫Ü', '‰∫åÊ¨°Èù¢Êé•‰∫àÂÆö', '‰∫åÊ¨°Èù¢Êé•ÂÆå‰∫Ü', 'ÊúÄÁµÇÈù¢Êé•‰∫àÂÆö', 'ÊúÄÁµÇÈù¢Êé•ÂÆå‰∫Ü', 'ÂÜÖÂÆö', 'ÂÜÖÂÆöÊâøË´æ', 'ÂÖ•Á§æÁ¢∫Ë™çÊ∏à', 'ÈÅ∏ËÄÉÁµÇ‰∫ÜÔºàÊõ∏È°ûÔºâ', 'ÈÅ∏ËÄÉÁµÇ‰∫ÜÔºàÈù¢Êé•Ôºâ', 'ÈÅ∏ËÄÉÁµÇ‰∫ÜÔºàÂÜÖÂÆöËæûÈÄÄÔºâ', 'ÈÅ∏ËÄÉÁµÇ‰∫ÜÔºàÂÖÖË∂≥„ÇØ„É≠„Éº„Ç∫Ôºâ', 'ÈÅ∏ËÄÉÁµÇ‰∫ÜÔºà„Åù„ÅÆ‰ªñÔºâ'];

                if (!data || data.length === 0) {
                    container.html('<div class="text-center py-8 text-gray-500"><i class="fas fa-tasks text-3xl mb-2 block"></i><p>ÈÄ≤Ë°å‰∏≠„ÅÆÈÅ∏ËÄÉ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p></div>');
                    return;
                }

                const html = data.map(app => {
                    const job = app.jobs;
                    const companyName = job?.companies?.name || job?.company || '‰∏çÊòé';

                    return `
                    <div class="bg-white border rounded-lg p-5 shadow-sm">
                        <div class="flex justify-between items-start gap-4 mb-4">
                            <div>
                                <h5 class="font-bold text-lg text-gray-900">${job?.title || '‰∏çÊòé„Å™Ê±Ç‰∫∫'}</h5>
                                <p class="text-sm text-gray-600">${companyName}</p>
                            </div>
                            <div class="bg-indigo-50 text-indigo-700 px-4 py-2 rounded-lg font-bold">
                                ${app.status}
                            </div>
                        </div>
                        
                        <div class="pt-4 border-t space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wider">ÈÅ∏ËÄÉ„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆÂ§âÊõ¥</label>
                                <div class="flex gap-2">
                                    <select onchange="updateCandidateSelectionStatus('${app.id}', this.value, '${candidateId}')" 
                                        class="flex-1 px-4 py-2 border rounded-lg text-sm bg-indigo-50 border-indigo-200 focus:ring-2 focus:ring-indigo-500">
                                        <option value="">„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂ§âÊõ¥...</option>
                                        ${statuses.map(s => `<option value="${s}" ${app.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                }).join('');

                container.html(html);
            } catch (err) {
                console.error('Load selection progress error:', err);
                container.html('<div class="text-center py-8 text-red-500">ÈÄ≤ÊçóÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>');
            }
        }

        // ÈÅ∏ËÄÉ„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
        window.updateCandidateSelectionStatus = async function (applicationId, newStatus, candidateId) {
            if (!newStatus) return;

            showLoading('Êõ¥Êñ∞‰∏≠...');
            try {
                // ÁèæÂú®„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂèñÂæóÔºàÂ±•Ê≠¥Áî®Ôºâ
                const { data: currentApp } = await supabase
                    .from('applications')
                    .select('status')
                    .eq('id', applicationId)
                    .single();

                const oldStatus = currentApp?.status;

                // „Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
                const { error } = await supabase
                    .from('applications')
                    .update({ status: newStatus, updated_at: new Date().toISOString() })
                    .eq('id', applicationId);

                if (error) throw error;

                // Â±•Ê≠¥„Å´ËøΩÂä† (progress_history„ÉÜ„Éº„Éñ„É´„Åå„ÅÇ„Çå„Å∞)
                try {
                    await supabase.from('progress_history').insert({
                        organization_id: currentUser.organization_id,
                        application_id: applicationId,
                        user_id: candidateId,
                        old_status: oldStatus,
                        new_status: newStatus,
                        changed_by: currentUser.id,
                        changed_by_name: currentUser.name
                    });
                } catch (histErr) {
                    console.warn('Failed to record progress history:', histErr);
                }

                // ÈÄöÁü•„Å®„É°„Éº„É´ÈÄÅ‰ø°
                try {
                    const { data: appData } = await supabase
                        .from('applications')
                        .select('*, jobs(title, company), users!user_id(name, email, coach_id)')
                        .eq('id', applicationId)
                        .single();

                    if (appData) {
                        const statusLabel = getSelectionStatusLabel(newStatus);

                        // Ê±ÇËÅ∑ËÄÖ„Å∏ÈÄöÁü•„É¨„Ç≥„Éº„Éâ
                        await supabase.from('notifications').insert({
                            user_id: candidateId,
                            title: 'ÈÅ∏ËÄÉ„Çπ„ÉÜ„Éº„Çø„Çπ„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü',
                            message: `„Äå${appData.jobs.company} / ${appData.jobs.title}„Äç„ÅÆÈÅ∏ËÄÉÁä∂Ê≥Å„Åå„Äå${statusLabel}„Äç„Å´Êõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü„ÄÇ`,
                            read: false,
                            metadata: { page: 'applications', application_id: applicationId },
                            created_at: new Date().toISOString()
                        });

                        // Ê±ÇËÅ∑ËÄÖ„Å∏„É°„Éº„É´
                        if (appData.users && appData.users.email) {
                            await sendEmail('status_changed', appData.users.email, {
                                userName: appData.users.name,
                                jobTitle: appData.jobs.title,
                                companyName: appData.jobs.company,
                                newStatus: statusLabel,
                                status: newStatus
                            });
                        }

                        // ÊãÖÂΩì„Ç≥„Éº„ÉÅ„Å∏„É°„Éº„É´
                        if (appData.users.coach_id) {
                            const { data: coachData } = await supabase
                                .from('users')
                                .select('name, email')
                                .eq('id', appData.users.coach_id)
                                .single();

                            if (coachData && coachData.email) {
                                await sendEmail('ca_notification', coachData.email, {
                                    userName: coachData.name,
                                    candidateName: appData.users.name,
                                    jobTitle: appData.jobs.title,
                                    companyName: appData.jobs.company,
                                    body: `ÊãÖÂΩìÊ±ÇËÅ∑ËÄÖ„ÅÆ ${appData.users.name} Êßò„ÅÆÈÅ∏ËÄÉ„Çπ„ÉÜ„Éº„Çø„Çπ„Åå„Äå${statusLabel}„Äç„Å´Êõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü„ÄÇ`
                                });
                            }
                        }
                    }
                } catch (notifyErr) {
                    console.error('Update notification failed:', notifyErr);
                }

                alert('ÈÅ∏ËÄÉ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
                loadSelectionProgress(candidateId);
            } catch (err) {
                console.error('Update selection status error:', err);
                alert('Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + err.message);
            } finally {
                hideLoading();
            }
        }

        // ============================================
        // Â§ñÈÉ®„Éó„É≠„Éï„Ç£„Éº„É´Ëß£ÊûêÊ©üËÉΩ
        // ============================================

        let uploadedFiles = [];
        let currentAnalysisHistoryId = null; // Store history ID for feedback

        window.openProfileAnalysisModal = function () {
            $('#profile-scout_management-tab-content').addClass('hidden');
            $('.profile-analysis-tab').removeClass('border-indigo-600 text-indigo-600').addClass('border-transparent text-gray-500');
            $('#profile-tab-new').removeClass('border-transparent text-gray-500').addClass('border-indigo-600 text-indigo-600');

            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
            setTimeout(() => {
                setupFileUploadHandlers();
            }, 100);
        }

        window.closeProfileAnalysisModal = function () {
            $('#profile-analysis-modal').addClass('hidden');
        }

        // ============================================
        // Scout Settings Modal Logic
        // ============================================

        window.openScoutSettingsModal = async function () {
            console.log('openScoutSettingsModal called');
            if (!currentUser) return;

            const modal = $('#scout-settings-modal');
            // Ensure modal is strict child of body for z-index to work
            if (modal.parent().get(0) !== document.body) {
                $('body').append(modal);
            }

            modal.removeClass('hidden').css('z-index', 10001);

            // Load current settings
            try {
                const { data, error } = await supabase
                    .from('user_scout_settings')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                if (data) {
                    $('#scout-style-active').prop('checked', data.is_active);
                    $('#scout-style-prompt').val(data.style_prompt || '');
                } else {
                    // No settings yet, reset to default
                    $('#scout-style-active').prop('checked', false);
                    $('#scout-style-prompt').val('');
                }
            } catch (e) {
                console.error('Error loading scout settings:', e);
            }
        }

        // „Çø„ÉñÂàá„ÇäÊõø„Åà
        window.switchProfileAnalysisTab = function (tab) {
            // „Çø„Éñ„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´Êõ¥Êñ∞
            $('.profile-analysis-tab').removeClass('border-indigo-600 text-indigo-600').addClass('border-transparent text-gray-500');
            $(`#profile-tab-${tab}`).removeClass('border-transparent text-gray-500').addClass('border-indigo-600 text-indigo-600');

            // „Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆË°®Á§∫Âàá„ÇäÊõø„Åà
            $('#profile-new-tab-content').addClass('hidden');
            $('#profile-history-tab-content').addClass('hidden');
            $('#profile-scout_management-tab-content').addClass('hidden');
            $('#profile-analytics-tab-content').addClass('hidden');

            if (tab === 'new') {
                $('#profile-new-tab-content').removeClass('hidden');
                setTimeout(() => {
                    setupFileUploadHandlers();
                }, 0);
            } else if (tab === 'history') {
                $('#profile-history-tab-content').removeClass('hidden');
                loadProfileAnalysisHistory();
            } else if (tab === 'scout_management') {
                $('#profile-scout_management-tab-content').removeClass('hidden');
                loadScoutManagement();
            } else if (tab === 'analytics') {
                $('#profile-analytics-tab-content').removeClass('hidden');
                loadScoutAnalytics();
            }
        }

        // Â±•Ê≠¥Ë™≠„ÅøËæº„Åø
        window.loadProfileAnalysisHistory = async function () {
            if (!currentUser) return;

            $('#history-list').html(`
            <div class="text-center py-12 text-gray-500">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                    <p>Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...</p>
                </div>
            `);

            try {
                // 1. ÁµÑÁπîË®≠ÂÆö„ÅÆÂèñÂæó
                const { data: orgData, error: orgError } = await window.supabase
                    .from('organizations')
                    .select('settings')
                    .eq('id', currentUser.organization_id)
                    .single();

                if (orgError) console.error('Org settings fetch error:', orgError); // Non-blocking

                const visibility = orgData?.settings?.analysis_history_visibility || 'all'; // Default to 'all'

                // 2. Áµ±Ë®à„Éá„Éº„Çø„ÅÆÂèñÂæó (ÂÄã‰∫∫ & ÂÖ®‰Ωì)
                // Note: RLS„ÅåOpen„Å™Áä∂ÊÖãÂâçÊèê„ÄÇStrict„Å™RLS„ÅÆÂ†¥Âêà„ÅØÂà•ÈÄîRPC„ÅåÂøÖË¶Å„Å´„Å™„Çã„Åå„ÄÅÁèæÂú®„ÅØOpenMode„Å®ÊÉ≥ÂÆö„ÄÇ
                const { count: myCount, error: myCountError } = await window.supabase
                    .from('profile_analysis_history')
                    .select('*', { count: 'exact', head: true })
                    .eq('organization_id', currentUser.organization_id)
                    .eq('analyzed_by', currentUser.id);

                const { count: orgCount, error: orgCountError } = await window.supabase
                    .from('profile_analysis_history')
                    .select('*', { count: 'exact', head: true })
                    .eq('organization_id', currentUser.organization_id);

                // 3. „É™„Çπ„Éà„Éá„Éº„Çø„ÅÆÂèñÂæó
                let query = window.supabase
                    .from('profile_analysis_history')
                    .select('*')
                    .eq('organization_id', currentUser.organization_id)
                    .order('created_at', { ascending: false })
                    .limit(50);

                // VisibilityÂà∂Âæ°: 'personal'„Å™„ÇâËá™ÂàÜ„ÅÆ„Éá„Éº„Çø„ÅÆ„Åø„Å´Áµû„Çã
                if (visibility === 'personal') {
                    query = query.eq('analyzed_by', currentUser.id);
                }

                const { data, error } = await query;

                if (error) throw error;

                // --- UI Rendering ---

                // Áµ±Ë®àË°®Á§∫„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
                const statsHtml = `
            <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-indigo-50 rounded-lg p-4 text-center border border-indigo-100">
                            <p class="text-xs text-gray-500 font-bold mb-1">Ëá™ÂàÜ„ÅÆËß£ÊûêÊï∞</p>
                            <p class="text-2xl font-bold text-indigo-700">${myCount || 0}<span class="text-sm font-normal text-gray-500 ml-1">‰ª∂</span></p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 text-center border border-gray-200">
                            <p class="text-xs text-gray-500 font-bold mb-1">ÁµÑÁπîÂÖ®‰Ωì„ÅÆËß£ÊûêÊï∞</p>
                            <p class="text-2xl font-bold text-gray-700">${orgCount || 0}<span class="text-sm font-normal text-gray-500 ml-1">‰ª∂</span></p>
                        </div>
                    </div>
            `;

                if (!data || data.length === 0) {
                    $('#history-list').html(statsHtml + `
            <div class="text-center py-12 text-gray-500 border-t border-gray-100 mt-4">
                            <i class="fas fa-inbox text-4xl mb-3"></i>
                            <p>Ë°®Á§∫„Åß„Åç„ÇãËß£ÊûêÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                        </div>
            `);
                    return;
                }

                // „É™„Çπ„ÉàË°®Á§∫
                $('#history-list').html(statsHtml + '<div class="space-y-4">' + renderHistoryListHtml(data) + '</div>');

            } catch (error) {
                console.error('Load history error:', error);
                $('#history-list').html(`
            <div class="text-center py-12 text-red-500">
                        <i class="fas fa-exclamation-triangle text-4xl mb-3"></i>
                        <p>Â±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>
                    </div>
            `);
            }
        }

        // „Éò„É´„Éë„ÉºÈñ¢Êï∞: HTMLÁîüÊàêÈÉ®ÂàÜ„ÇíÂàÜÈõ¢
        function renderHistoryListHtml(historyData) {
            return historyData.map(item => {
                const date = new Date(item.created_at).toLocaleString('ja-JP');
                let matches = item.matches;
                if (typeof matches === 'string') {
                    try { matches = JSON.parse(matches); } catch (e) { }
                }

                let matchCount = 0;
                if (matches && !Array.isArray(matches) && typeof matches === 'object') {
                    matchCount = (matches.skill?.length || 0) + (matches.industry?.length || 0) + (matches.mindset?.length || 0);
                } else if (Array.isArray(matches)) {
                    matchCount = matches.length;
                } else if (item.analysis_results) {
                    let ar = item.analysis_results;
                    if (typeof ar === 'string') { try { ar = JSON.parse(ar); } catch (e) { } }
                    matchCount = (ar.matches_skill?.length || 0) + (ar.matches_industry?.length || 0) + (ar.matches_mindset?.length || 0) + (ar.matches?.length || 0);
                }

                return `
            <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition cursor-pointer" onclick="viewHistoryDetail('${item.id}')">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1">
                        <p class="font-bold text-gray-900">${(item.title || item.candidate_summary || 'ÂÄôË£úËÄÖÊÉÖÂ†±').substring(0, 60)}...</p>
                        <p class="text-xs text-gray-500 mt-1">
                            <i class="far fa-clock mr-1"></i>${date}
                        </p>
                    </div>
                    <span class="px-2 py-1 bg-indigo-50 text-indigo-600 text-xs font-semibold rounded">
                        ${matchCount}‰ª∂„ÅÆÊ±Ç‰∫∫ÊèêÊ°à
                    </span>
                </div>
                </div>
            `;
            }).join('');
        }




        window.viewHistoryDetail = async function (historyId) {
            try {
                const { data, error } = await window.supabase
                    .from('profile_analysis_history')
                    .select('*')
                    .eq('id', historyId)
                    .single();

                if (error) throw error;

                // Êñ∞Ë¶èËß£Êûê„Çø„Éñ„Å´Âàá„ÇäÊõø„Åà„Å¶ÁµêÊûú„ÇíË°®Á§∫
                switchProfileAnalysisTab('new');

                // „Éá„Éº„Çø„ÅÆÊ≠£Ë¶èÂåñ
                let matches = data.matches;
                if (typeof matches === 'string') {
                    try { matches = JSON.parse(matches); } catch (e) { }
                }

                let renderData = {
                    candidate_summary: data.candidate_summary,
                    title: data.title, // ËøΩÂä†
                    history_id: data.id,
                    success: true
                };

                // matches„Éá„Éº„Çø„ÅÆÂΩ¢Áä∂„Å´Âêà„Çè„Åõ„Å¶Â§âÊèõ
                if (matches && !Array.isArray(matches) && typeof matches === 'object') {
                    // Êñ∞ÂΩ¢Âºè { skill: [], ... } -> { matches_skill: [], ... }
                    renderData.matches_skill = matches.skill;
                    renderData.matches_industry = matches.industry;
                    renderData.matches_mindset = matches.mindset;
                } else if (Array.isArray(matches)) {
                    // ÊóßÂΩ¢Âºè
                    renderData.matches = matches;
                } else if (data.analysis_results) {
                    // ‰∫àÂÇô„Åß analysis_results „ÇÇË¶ã„Çã
                    let ar = data.analysis_results;
                    if (typeof ar === 'string') { try { ar = JSON.parse(ar); } catch (e) { } }
                    Object.assign(renderData, ar);
                }

                renderAnalysisResults(renderData);

            } catch (error) {
                console.error('View history detail error:', error);
                alert('Â±•Ê≠¥„ÅÆË©≥Á¥∞Ë°®Á§∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        function setupFileUploadHandlers() {
            // Êó¢Â≠ò„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíÂâäÈô§
            $('#file-drop-area').off('click dragover dragleave drop');
            $('#profile-file-input').off('change');

            // „Éï„Ç°„Ç§„É´ÈÅ∏Êäû„ÅÆ„Éè„É≥„Éâ„É™„É≥„Ç∞
            $('#file-drop-area').on('click', function (e) {
                // inputË¶ÅÁ¥†Ëá™‰Ωì„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„ÅØÁÑ°Ë¶ñ
                if ($(e.target).is('#profile-file-input')) {
                    return;
                }
                e.preventDefault();
                e.stopPropagation();
                $('#profile-file-input')[0].click(); // DOMË¶ÅÁ¥†„Å®„Åó„Å¶Áõ¥Êé•„ÇØ„É™„ÉÉ„ÇØ
            });

            $('#profile-file-input').on('change', function (e) {
                e.stopPropagation(); // „Ç§„Éô„É≥„Éà‰ºùÊí≠„ÇíÂÅúÊ≠¢
                if (e.target.files && e.target.files.length > 0) {
                    handleFileUpload(Array.from(e.target.files));
                }
            });

            // „Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó„ÅÆ„Éè„É≥„Éâ„É™„É≥„Ç∞
            $('#file-drop-area').on('dragover', function (e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).addClass('bg-indigo-50');
            });

            $('#file-drop-area').on('dragleave', function (e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).removeClass('bg-indigo-50');
            });

            $('#file-drop-area').on('drop', function (e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).removeClass('bg-indigo-50');
                if (e.originalEvent.dataTransfer.files.length > 0) {
                    handleFileUpload(Array.from(e.originalEvent.dataTransfer.files));
                }
            });

            // Paste event handling
            $(document).on('paste', function (e) {
                const items = (e.originalEvent.clipboardData || e.clipboardData).items;
                const files = [];
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        const file = items[i].getAsFile();
                        if (file) {
                            // Create a dummy name if not present (often 'image.png' from clipboard)
                            if (!file.name || file.name === 'image.png') {
                                const ext = items[i].type.split('/')[1];
                                const timestamp = new Date().getTime();
                                // Create a new File object with a custom name
                                const newFile = new File([file], `pasted_image_${timestamp}.${ext}`, { type: file.type });
                                files.push(newFile);
                            } else {
                                files.push(file);
                            }
                        }
                    }
                }
                if (files.length > 0) {
                    handleFileUpload(files);
                    // Optional: Provide visual feedback that a paste occurred
                    $('#file-drop-area').addClass('bg-indigo-50');
                    setTimeout(() => $('#file-drop-area').removeClass('bg-indigo-50'), 200);
                }
            });
        }

        function handleFileUpload(files) {
            uploadedFiles = files;
            const fileListHtml = files.map((file, index) => `
            <div class="flex items-center justify-between bg-gray-100 px-2 py-1 rounded">
                    <span class="text-gray-700 truncate flex-1">
                        <i class="fas ${file.type.includes('pdf') ? 'fa-file-pdf text-red-500' : 'fa-image text-blue-500'} mr-1"></i>
                        ${file.name}
                    </span>
                    <span class="text-gray-500 text-xs ml-2">${(file.size / 1024).toFixed(1)}KB</span>
                </div>
            `).join('');
            $('#file-list').html(fileListHtml);
        }

        window.resetProfileAnalysis = function () {
            uploadedFiles = [];
            $('#profile-file-input').val('');
            $('#file-list').empty();
            $('#profile-text-input').val('');
            $('#scout-instruction-text').val(''); // ËøΩÂä†: ÊåáÁ§∫„ÉÜ„Ç≠„Çπ„Éà„ÇÇ„ÇØ„É™„Ç¢
            $('#scout-instruction-container').addClass('hidden'); // ËøΩÂä†: ÊåáÁ§∫„Ç®„É™„Ç¢„ÇíÈö†„Åô
            $('#analysis-placeholder').removeClass('hidden');
            $('#analysis-loading').addClass('hidden');
            $('#analysis-results').addClass('hidden');
            $('#suggested-jobs-container').empty();
        }

        window.analyzeProfile = async function (instruction = null, targetJobId = null) {
            if (!currentUser) return;

            // ÂàùÂõûËß£ÊûêÔºàÊåáÁ§∫„Åå„Å™„ÅÑÂ†¥ÂêàÔºâ„ÅØÊñ∞Ë¶èÊâ±„ÅÑ„Å®„Åó„Å¶ID„Å®„Çø„Ç§„Éà„É´„Çí„É™„Çª„ÉÉ„Éà
            if (!instruction) {
                window.currentExternalCandidateId = null;
                // $('#candidate-title-input').val(''); // ÂâäÈô§: ÂÖ•Âäõ„Åï„Çå„Åü„Çø„Ç§„Éà„É´„ÇíÁ∂≠ÊåÅ„Åô„Çã
            }

            const textInput = $('#profile-text-input').val().trim();

            if (uploadedFiles.length === 0 && !textInput) {
                alert('„Éï„Ç°„Ç§„É´„Åæ„Åü„ÅØ„ÉÜ„Ç≠„Çπ„ÉàÊÉÖÂ†±„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // UIÊõ¥Êñ∞
            $('#analyze-profile-btn').prop('disabled', true);
            $('#regenerate-scout-btn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>ÂÜçÁîüÊàê‰∏≠...'); // ÂÜçÁîüÊàê„Éú„Çø„É≥„ÅÆÁä∂ÊÖãÊõ¥Êñ∞

            // ÂàùÂõûËß£ÊûêÊôÇ„ÅØ„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÇíÈö†„Åó„Å¶„É≠„Éº„Éá„Ç£„É≥„Ç∞„ÇíË°®Á§∫
            if (!instruction) {
                $('#analysis-placeholder').addClass('hidden');
                // $('#analysis-loading').removeClass('hidden'); // ÂÖ®ÁîªÈù¢„É≠„Éº„Éá„Ç£„É≥„Ç∞„Çí‰ΩøÁî®„Åô„Çã„Åü„ÇÅ„Ç≥„É°„É≥„Éà„Ç¢„Ç¶„Éà
                showLoading('„Éó„É≠„Éï„Ç£„Éº„É´„ÇíËß£Êûê‰∏≠...');
                $('#analysis-results').addClass('hidden');
            } else {
                // ÂÜçÁîüÊàêÊôÇ„ÅØÁµêÊûú„Ç®„É™„Ç¢„ÇíÂçäÈÄèÊòé„Å´„Åô„Çã„Å™„Å©„ÅÆ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„Åå„ÅÇ„Çã„Å®ËâØ„ÅÑ„Åå„ÄÅ‰ªäÂõû„ÅØ„É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫„Å´Âàá„ÇäÊõø„Åà„Çã
                $('#analysis-results').addClass('opacity-50');
                showLoading('ÊåáÁ§∫„Å´Âü∫„Å•„ÅÑ„Å¶ÂÜçÁîüÊàê‰∏≠...');
            }

            try {
                // ÊúÄÂàù„ÅÆ„Éï„Ç°„Ç§„É´„ÇíBase64„Å´Â§âÊèõÔºàÁîªÂÉè„Åæ„Åü„ÅØPDFÔºâ
                let base64Image = null;
                let mimeType = null;
                if (uploadedFiles.length > 0) {
                    const file = uploadedFiles[0];
                    if (file.type.startsWith('image/')) {
                        base64Image = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result);
                            reader.readAsDataURL(file);
                        });
                        mimeType = file.type;
                    } else if (file.type === 'application/pdf') {
                        // PDF„ÇíÁîªÂÉè(JPEG)„Å´Â§âÊèõ
                        try {

                            const arrayBuffer = await file.arrayBuffer();
                            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                            const page = await pdf.getPage(1); // 1„Éö„Éº„Ç∏ÁõÆ„ÅÆ„Åø
                            const viewport = page.getViewport({ scale: 2.0 });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;

                            await page.render({ canvasContext: context, viewport: viewport }).promise;
                            base64Image = canvas.toDataURL('image/jpeg');
                            mimeType = 'image/jpeg';
                        } catch (e) {
                            console.error('PDF conversion error:', e);
                            alert('PDF„ÅÆÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÁîªÂÉè„Éï„Ç°„Ç§„É´„Çí‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                            throw e;
                        }
                    }
                }

                // Edge FunctionÂëº„Å≥Âá∫„Åó
                // Base64„Éò„ÉÉ„ÉÄ„Éº„ÇíÈô§Âéª„Åó„Å¶ÈÄÅ‰ø°
                const cleanBase64 = base64Image ? base64Image.replace(/^data:(.*);base64,/, '') : null;

                const { data, error } = await window.supabase.functions.invoke('analyze-external-profile', {
                    body: {
                        image: cleanBase64,
                        mime_type: mimeType || 'image/jpeg', // MIME„Çø„Ç§„Éó„ÇÇÊòéÁ§∫ÁöÑ„Å´ÈÄÅ‰ø°
                        text_input: textInput || null,
                        title: $('#candidate-title-input').val().trim() || null, // ËøΩÂä†: „Çø„Ç§„Éà„É´„ÇíÈÄÅ‰ø°
                        organization_id: currentUser.organization_id,
                        user_id: currentUser.id,
                        instruction: instruction, // ËøΩÂä†: ‰øÆÊ≠£ÊåáÁ§∫
                        target_job_id: targetJobId
                    }
                });

                if (error) throw error;
                console.log('Analysis response data:', data); // Debug log

                if (data && data.success) {
                    renderAnalysisResults(data);

                    // Save result here (only on analysis, not on view)
                    // Removed to prevent auto-save: User must explicitly save via Scout or Register button
                    // if (window.saveExternalCandidateProfile) {
                    //     saveExternalCandidateProfile(data);
                    // }
                } else {
                    throw new Error(data.error || 'Ëß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }

            } catch (error) {
                console.error('Analysis error:', error);
                alert('Ëß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                if (!instruction) {
                    $('#analysis-loading').addClass('hidden');
                    $('#analysis-placeholder').removeClass('hidden');
                }
            } finally {
                $('#analyze-profile-btn').prop('disabled', false);
                $('#regenerate-scout-btn').prop('disabled', false).html('<i class="fas fa-sync-alt mr-2"></i>ÊåáÁ§∫„ÇíÂèçÊò†„Åó„Å¶ÂÜçÁîüÊàê');
                $('#analysis-results').removeClass('opacity-50');
                hideLoading();
            }
        }

        // ÂÜçÁîüÊàê„Éú„Çø„É≥„ÅÆ„Éè„É≥„Éâ„É©
        window.regenerateScoutsWithInstruction = function () {
            const instruction = $('#scout-instruction-text').val().trim();
            if (!instruction) {
                alert('‰øÆÊ≠£ÊåáÁ§∫„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            analyzeProfile(instruction);
        }

        let currentAnalysisMatches = [];
        let currentAnalysisOffset = 0;
        let analysisResultsData = null; // ÂÖ®„Éá„Éº„Çø„Çí‰øùÊåÅ
        const ANALYSIS_BATCH_SIZE = 3;

        window.renderAnalysisResults = function (data) {
            $('#analysis-loading').addClass('hidden');
            $('#analysis-results').removeClass('hidden');
            $('#scout-instruction-container').removeClass('hidden');

            // „Çø„Ç§„Éà„É´„ÇíÂèçÊò†ÔºàÊó¢Â≠ò„ÅÆÂÖ•Âäõ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ‰∏äÊõ∏„Åç„Åõ„Åö„ÄÅÁ©∫„ÅÆÂ†¥Âêà„ÇÑÂ±•Ê≠¥Ë°®Á§∫„ÅÆÂ†¥Âêà„ÅÆ„ÅøÂèçÊò†„Åï„Åõ„Åü„ÅÑ„Åå„ÄÅ
            // Â±•Ê≠¥Ë°®Á§∫ÊôÇ„ÅØdata.title„Å´ÂÄ§„ÅåÂÖ•„Å£„Å¶„ÅÑ„Çã„ÅØ„Åö„ÄÇËß£ÊûêÁõ¥Âæå„ÇÇdata.title„Å´ÂèçÊò†„Åô„Çã„Çà„ÅÜ„Å´„Åô„Çã„Å®‰∏ÄË≤´ÊÄß„ÅåÂá∫„Çã„ÄÇ
            if (data.title !== undefined) {
                $('#candidate-title-input').val(data.title || '');
            }

            window.currentAnalysisHistoryId = data.history_id || null;

            // Auto Save to External Candidates (New Feature)
            // Auto Save Removed from here to prevent duplicate on view
            // if (window.saveExternalCandidateProfile) {
            //     saveExternalCandidateProfile(data);
            // }
            currentAnalysisHistoryId = window.currentAnalysisHistoryId;

            if (!window.currentAnalysisHistoryId && data.save_error) {
                console.error('History ID is missing. Save error:', data.save_error);
                const errorDetail = typeof data.save_error === 'object' ? JSON.stringify(data.save_error, null, 2) : String(data.save_error);
                alert('„Äê„Ç®„É©„Éº„ÄëÂ±•Ê≠¥„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\nË©≥Á¥∞: ' + errorDetail);
            } else if (!window.currentAnalysisHistoryId) {
                console.warn('History ID is missing but no save error reported.');
            } else {
                console.log('Set GLOBAL history ID:', window.currentAnalysisHistoryId);
            }

            // Persist in DOM to be absolutely sure
            if ($('#current-analysis-history-id').length === 0) {
                $('#analysis-results').append('<input type="hidden" id="current-analysis-history-id">');
            }
            $('#current-analysis-history-id').val(window.currentAnalysisHistoryId || '');

            // „Çµ„Éû„É™„ÉºË°®Á§∫
            $('#candidate-summary-text').text(data.candidate_summary || 'Ëß£ÊûêÁµêÊûú„Å™„Åó');

            const container = $('#suggested-jobs-container');
            container.empty();

            // ‰ªªÊÑè„ÅÆÊ±Ç‰∫∫ÈÅ∏Êäû„Éú„Çø„É≥„ÇíËøΩÂä†
            container.append(`
            <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4 mb-6 flex items-center justify-between">
                    <div>
                        <h5 class="font-bold text-indigo-900">
                            <i class="fas fa-search-plus mr-2"></i>„Åù„ÅÆ‰ªñ„ÅÆÊ±Ç‰∫∫„Åß„Çπ„Ç´„Ç¶„Éà„Çí‰ΩúÊàê
                        </h5>
                        <p class="text-sm text-indigo-700">„Åä„Åô„Åô„ÇÅÊ±Ç‰∫∫‰ª•Â§ñ„ÅÆÊ±Ç‰∫∫„ÇíÊåáÂÆö„Åó„Å¶„Çπ„Ç´„Ç¶„ÉàÊñáÈù¢„Çí‰ΩúÊàê„Åß„Åç„Åæ„Åô„ÄÇ</p>
                    </div>
                    <button onclick="openJobSelectorForScout()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded shadow transition">
                        Ê±Ç‰∫∫„ÇíÈÅ∏Êäû
                    </button>
                </div>
            `);

            // Debug log removed: console.log('Analysis results:', data);

            analysisResultsData = data; // „Éá„Éº„Çø‰øùÂ≠ò
            window.analysisResultsData = data; // „Ç∞„É≠„Éº„Éê„É´„Ç¢„ÇØ„Çª„ÇπÁî®„Å´ÂÖ¨Èñã

            // Debug log removed: console.log('Data keys:', Object.keys(data));
            // Debug log removed: console.log('Matches lengths:', {
            //     skill: data.matches_skill ? data.matches_skill.length : 'undefined',
            //     industry: data.matches_industry ? data.matches_industry.length : 'undefined',
            //     mindset: data.matches_mindset ? data.matches_mindset.length : 'undefined',
            //     legacy: data.matches ? data.matches.length : 'undefined'
            // });

            // ÊßãÈÄ†Âåñ„Éá„Éº„ÇøÔºàmatches_skillÁ≠âÔºâ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„ÄÅ„Åù„Çå„ÇíÂÑ™ÂÖà„Åó„Å¶Áµ±Âêà„Éª‰ΩøÁî®„Åô„Çã
            const hasStructuredMatches = (Array.isArray(data.matches_skill) && data.matches_skill.length > 0) ||
                (Array.isArray(data.matches_industry) && data.matches_industry.length > 0) ||
                (Array.isArray(data.matches_mindset) && data.matches_mindset.length > 0);

            // Debug log removed: console.log('Has structured matches:', hasStructuredMatches);

            if (hasStructuredMatches) {
                // Êñ∞ÂΩ¢Âºè„É¨„Çπ„Éù„É≥„ÇπÂØæÂøú: matches_skill, matches_industry, matches_mindset „ÇíÁµ±Âêà
                data.matches = [
                    ...(data.matches_skill || []).map(m => ({ ...m, category: 'skill' })),
                    ...(data.matches_industry || []).map(m => ({ ...m, category: 'industry' })),
                    ...(data.matches_mindset || []).map(m => ({ ...m, category: 'mindset' }))
                ];
                // Update global data reference
                analysisResultsData = data;
                // Debug log removed: console.log('Merged matches from structured data:', data.matches);
            }

            // „Ç´„ÉÜ„Ç¥„É™ÊÉÖÂ†±„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ („Éá„Éº„Çø„Åå„ÅÇ„Çå„Å∞Âº∑Âà∂ÁöÑ„Å´„Ç´„ÉÜ„Ç¥„É™„ÅÇ„Çä„Å®„Åø„Å™„Åô)
            const hasCategories = hasStructuredMatches || (data.matches && data.matches.length > 0 && data.matches.some(m => m.category));

            if (hasCategories) {
                // „Çø„ÉñUI„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞
                const tabsHtml = `
            <div class="flex border-b border-gray-200 mb-4">
                        <button onclick="switchAnalysisTab('skill')" id="tab-skill" class="ai-result-tab flex-1 py-3 px-2 text-center text-sm font-bold border-b-2 transition-colors duration-200 text-indigo-600 border-indigo-600">
                            <i class="fas fa-tools mr-1"></i>„Çπ„Ç≠„É´„ÉªÁµåÈ®ì
                            <span class="group relative inline-block ml-1 text-left font-normal" onclick="event.stopPropagation()">
                                <i class="fas fa-question-circle text-gray-400 hover:text-indigo-500 cursor-help transition-colors"></i>
                                <div class="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none z-50 leading-relaxed font-normal">
                                    <div class="absolute top-[-6px] left-1/2 transform -translate-x-1/2 w-3 h-3 bg-gray-800 rotate-45"></div>
                                    ÂÖ∑‰ΩìÁöÑ„Å™„Çπ„Ç≠„É´„Çª„ÉÉ„Éà„ÇÑÂÆüÂãôÁµåÈ®ì„Å™„Å©„ÄÅ„ÄåÂç≥Êà¶Âäõ„Äç„Å®„Åó„Å¶„ÅÆÈÅ©ÂêàÂ∫¶„ÅåÈ´ò„ÅÑÊ±Ç‰∫∫„Åß„Åô„ÄÇ
                                </div>
                            </span>
                        </button>
                        <button onclick="switchAnalysisTab('industry')" id="tab-industry" class="ai-result-tab flex-1 py-3 px-2 text-center text-sm font-bold border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            <i class="fas fa-building mr-1"></i>Ê•≠Áïå„Éª„Éâ„É°„Ç§„É≥
                            <span class="group relative inline-block ml-1 text-left font-normal" onclick="event.stopPropagation()">
                                <i class="fas fa-question-circle text-gray-400 hover:text-indigo-500 cursor-help transition-colors"></i>
                                <div class="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none z-50 leading-relaxed font-normal">
                                    <div class="absolute top-[-6px] left-1/2 transform -translate-x-1/2 w-3 h-3 bg-gray-800 rotate-45"></div>
                                    Ê•≠ÁïåÁü•Ë≠ò„ÇÑÂïÜÊµÅ„ÅÆÁêÜËß£„Å™„Å©„ÄÅ„Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„ÅÆÁµåÈ®ì„ÅåÊ¥ª„Åã„Åõ„ÇãÊ±Ç‰∫∫„Åß„Åô„ÄÇ
                                </div>
                            </span>
                        </button>
                        <button onclick="switchAnalysisTab('mindset')" id="tab-mindset" class="ai-result-tab flex-1 py-3 px-2 text-center text-sm font-bold border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            <i class="fas fa-heart mr-1"></i>ÂøóÂêëÊÄß
                            <span class="group relative inline-block ml-1 text-left font-normal" onclick="event.stopPropagation()">
                                <i class="fas fa-question-circle text-gray-400 hover:text-indigo-500 cursor-help transition-colors"></i>
                                <div class="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none z-50 leading-relaxed font-normal">
                                    <div class="absolute top-[-6px] left-1/2 transform -translate-x-1/2 w-3 h-3 bg-gray-800 rotate-45"></div>
                                    ÂÄôË£úËÄÖ„ÅÆ„Ç≠„É£„É™„Ç¢ÂøóÂêë„ÇÑ‰∫∫ÊüÑ„ÄÅ‰ºÅÊ•≠ÊñáÂåñÔºà„Ç´„É´„ÉÅ„É£„ÉºÔºâ„Å®„ÅÆÁõ∏ÊÄß„ÅåËâØ„ÅÑÊ±Ç‰∫∫„Åß„Åô„ÄÇ
                                </div>
                            </span>
                        </button>
                    </div>
            <div id="analysis-tab-content"></div>
        `;
                container.append(tabsHtml);

                // „Éá„Éº„Çø„ÅåÂ≠òÂú®„Åô„ÇãÊúÄÂàù„ÅÆ„Çø„Éñ„ÇíÈñã„Åè
                if (data.matches_skill && data.matches_skill.length > 0) {
                    switchAnalysisTab('skill');
                } else if (data.matches_industry && data.matches_industry.length > 0) {
                    switchAnalysisTab('industry');
                } else if (data.matches_mindset && data.matches_mindset.length > 0) {
                    switchAnalysisTab('mindset');
                } else {
                    switchAnalysisTab('skill'); // „Éá„Éï„Ç©„É´„Éà
                }

            } else {
                // ÂæìÊù•Ë°®Á§∫ („Éï„É©„ÉÉ„Éà„É™„Çπ„Éà)
                if (!data.matches || data.matches.length === 0) {
                    container.html('<p class="text-gray-500 text-center">„Éû„ÉÉ„ÉÅ„Åô„ÇãÊ±Ç‰∫∫„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</p>');
                    $('#load-more-analysis-container').addClass('hidden');
                    return;
                }
                currentAnalysisMatches = data.matches;
                currentAnalysisOffset = 0;
                loadMoreAnalysisMatches();
            }

            // Load More„Éú„Çø„É≥„ÅÆ„Ç≥„É≥„ÉÜ„Éä (ÂÖ±ÈÄö)
            if ($('#load-more-analysis-container').length === 0) {
                container.after(`
            <div id="load-more-analysis-container" class="text-center mt-4 hidden">
                <button id="load-more-analysis-btn" onclick="loadMoreAnalysisMatches()"
                    class="px-6 py-2 bg-white border border-gray-300 rounded-full text-sm font-medium text-gray-700 hover:bg-gray-50 shadow-sm transition">
                    „ÇÇ„Å£„Å®Ë¶ã„Çã
                </button>
                    </div>
            `);
            }
        }

        window.switchAnalysisTab = function (tab) {
            // „Çπ„Çø„Ç§„É´Êõ¥Êñ∞
            ['skill', 'industry', 'mindset'].forEach(t => {
                const btn = $(`#tab - ${t} `);
                if (t === tab) {
                    btn.removeClass('border-transparent text-gray-500 hover:text-gray-700')
                        .addClass('text-indigo-600 border-indigo-600');
                } else {
                    btn.removeClass('text-indigo-600 border-indigo-600')
                        .addClass('border-transparent text-gray-500 hover:text-gray-700');
                }
            });

            // „Éá„Éº„ÇøÂàá„ÇäÊõø„Åà (category„Éó„É≠„Éë„ÉÜ„Ç£„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞)
            if (analysisResultsData && analysisResultsData.matches) {
                currentAnalysisMatches = analysisResultsData.matches.filter(m => m.category === tab);
            } else {
                currentAnalysisMatches = [];
            }

            currentAnalysisOffset = 0;
            $('#analysis-tab-content').empty();
            $('#load-more-analysis-container').addClass('hidden');

            // „Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆË°®Á§∫
            if (currentAnalysisMatches.length === 0) {
                $('#analysis-tab-content').html('<p class="text-gray-400 text-center py-4">„Åì„ÅÆË¶≥ÁÇπ„Åß„ÅÆ„Éû„ÉÉ„ÉÅ„É≥„Ç∞Ê±Ç‰∫∫„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>');
                return;
            }

            loadMoreAnalysisMatches();
        }

        window.loadMoreAnalysisMatches = function () {
            // „Çø„ÉñÂÜÖ„Åã„É°„Ç§„É≥„Ç≥„É≥„ÉÜ„Éä„Åã„ÇíÂà§ÂÆö
            let container = $('#analysis-tab-content');
            if (container.length === 0) {
                container = $('#suggested-jobs-container');
            }
            const nextMatches = currentAnalysisMatches.slice(currentAnalysisOffset, currentAnalysisOffset + ANALYSIS_BATCH_SIZE);

            // Store ID for feedback use (Moved from pagination loop)

            nextMatches.forEach(match => {
                const html = `
            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm hover:shadow-md transition mb-4">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <h5 class="text-lg font-bold text-gray-900">${match.job_title}</h5>
                                ${match.match_score ? `<span class="px-2 py-0.5 bg-indigo-100 text-indigo-800 text-xs font-bold rounded-full">„Éû„ÉÉ„ÉÅÂ∫¶ ${match.match_score}%</span>` : ''}
                                <a href="#" onclick="showJobDetailModal('${match.job_id}'); return false;" 
                                    class="text-xs text-indigo-600 hover:text-indigo-800 underline ml-2">
                                    Ë©≥Á¥∞„ÇíË¶ã„Çã
                                </a>
                            </div>
                            <p class="text-sm text-gray-600 mb-1">
                                <i class="fas fa-building text-gray-400 mr-1"></i>${match.company_name}
                            </p>
                            ${match.job_description ? `
                            <p class="text-xs text-gray-500 line-clamp-2 mt-2">${match.job_description.substring(0, 100)}...</p>
                            ` : ''}
                        </div>
                        <!-- Copy Button with Tooltip -->
                        <div class="relative group ml-4 inline-block">
                            <button onclick="copyToClipboard(this)" class="text-gray-400 hover:text-indigo-600 focus:outline-none">
                                <i class="far fa-copy text-xl"></i>
                            </button>
                            <div class="absolute bottom-full right-0 mb-2 w-40 p-2 bg-gray-800 text-white text-xs rounded shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none z-50 text-center font-normal">
                                <div class="absolute bottom-[-6px] right-3 w-3 h-3 bg-gray-800 rotate-45"></div>
                                ÊñáÈù¢„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
                            </div>
                        </div>

                        <!-- Save Button with Tooltip -->
                        <div class="relative group ml-2 inline-block">
                            <button onclick="saveScoutMessage(this, '${match.job_id}')" class="text-gray-400 hover:text-green-600 focus:outline-none">
                                <i class="fas fa-save text-xl"></i>
                            </button>
                            <div class="absolute bottom-full right-0 mb-2 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none z-50 leading-relaxed font-normal text-left">
                                <div class="absolute bottom-[-6px] right-3 w-3 h-3 bg-gray-800 rotate-45"></div>
                                <strong>„Çπ„Ç´„Ç¶„Éà„Çí‰øùÂ≠ò</strong><br>
                                „Åì„ÅÆÂÄôË£úËÄÖ„Å®ÊñáÈù¢„Çí„Äå„Çπ„Ç´„Ç¶„ÉàÁÆ°ÁêÜ„Äç„Å´ÁôªÈå≤„Åó„Åæ„Åô„ÄÇ‰øùÂ≠ò„Åô„Çã„Åì„Å®„Åß„ÄÅÈÄÅ‰ø°„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆÁÆ°ÁêÜ„ÇÑÂÄôË£úËÄÖ„ÅÆËøΩË∑°„ÅåÂèØËÉΩ„Å´„Å™„Çä„Åæ„Åô„ÄÇ
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 p-3 rounded mb-4">
                        <p class="text-xs font-bold text-yellow-800 mb-1">
                            <i class="fas fa-lightbulb mr-1"></i>„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÁêÜÁî±
                        </p>
                        <p class="text-sm text-gray-700">${match.match_reason}</p>
                    </div>

                    <div class="border-t pt-4">
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-xs text-gray-500 font-bold">ÁîüÊàê„Åï„Çå„Åü„Çπ„Ç´„Ç¶„ÉàÊñáÈù¢ (Á∑®ÈõÜÂèØ)</p>
                            <span class="text-[10px] bg-indigo-100 text-indigo-600 px-1.5 py-0.5 rounded italic">„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Áõ¥Êé•Á∑®ÈõÜ„Åß„Åç„Åæ„Åô</span>
                        </div>
                        <div class="bg-gray-50 p-4 rounded border border-gray-200 focus-within:border-indigo-300 focus-within:ring-1 focus-within:ring-indigo-100 transition-all">
                            <div class="flex items-center mb-2 border-b border-gray-200 pb-2">
                                <span class="text-sm font-bold text-gray-400 mr-2 flex-shrink-0">‰ª∂Âêç:</span>
                                <input type="text" class="scout-subject-input w-full font-bold text-gray-900 border-none bg-transparent focus:ring-0 text-sm p-0" value="${match.scout_subject}">
                            </div>
                            <textarea class="scout-body-textarea w-full text-gray-700 text-sm bg-transparent border-none focus:ring-0 p-0 resize-none overflow-hidden leading-relaxed" 
                                      oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'">${(match.scout_body || '').replace(/\\n/g, '\n')}</textarea>
                        </div>
                        
                        <!-- Feedback UI -->
                        <div class="flex justify-end items-center mt-2 space-x-2 feedback-container" data-job-id="${match.job_id}" data-history-id="${window.currentAnalysisHistoryId || ''}">
                            <span class="text-xs text-gray-400">„Åì„ÅÆÊñáÈù¢„ÅÆË©ï‰æ°:</span>
                            <button onclick="submitFeedback(this, 'good')" class="text-gray-400 hover:text-yellow-500 transition tooltip" data-tip="Good">
                                <i class="far fa-laugh text-lg"></i>
                            </button>
                            <button onclick="submitFeedback(this, 'soso')" class="text-gray-400 hover:text-yellow-500 transition tooltip" data-tip="So-so">
                                <i class="far fa-meh text-lg"></i>
                            </button>
                            <button onclick="submitFeedback(this, 'bad')" class="text-gray-400 hover:text-yellow-500 transition tooltip" data-tip="Bad">
                                <i class="far fa-frown text-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
                container.append(html);
            });

            currentAnalysisOffset += nextMatches.length;

            // Textarea„ÅÆÂàùÊúüÈ´ò„Åï„ÇíË™øÊï¥
            setTimeout(() => {
                $('.scout-body-textarea').trigger('input');
            }, 100);

            if (currentAnalysisOffset < currentAnalysisMatches.length) {
                $('#load-more-analysis-container').removeClass('hidden');
            } else {
                $('#load-more-analysis-container').addClass('hidden');
            }
        }

        /* =========================================
           Scout Style Personalization Logic
           ========================================= */



        window.analyzeScoutExamples = async function () {
            const examples = [];
            $('.scout-example-input').each(function () {
                const val = $(this).val().trim();
                if (val) examples.push(val);
            });

            if (examples.length === 0) {
                alert('‰æãÊñá„ÇíÂ∞ë„Å™„Åè„Å®„ÇÇ1„Å§ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const btn = $('#analyze-examples-btn');
            const originalText = btn.text();
            btn.text('ÂàÜÊûê‰∏≠...').prop('disabled', true);

            try {
                const { data, error } = await supabase.functions.invoke('analyze-scout-style', {
                    body: { examples }
                });

                if (error) throw error;
                if (!data.success) throw new Error(data.error);

                $('#scout-style-prompt').val(data.style_prompt);
                alert('Êñá‰Ωì„ÅÆÂàÜÊûê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ„ÄåË®≠ÂÆö„Çí‰øùÂ≠ò„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶ÈÅ©Áî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');

            } catch (e) {
                console.error(e);
                alert('ÂàÜÊûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + e.message);
            } finally {
                btn.text(originalText).prop('disabled', false);
            }
        }

        window.closeScoutSettingsModal = function () {
            $('#scout-settings-modal').addClass('hidden');
        }

        window.saveScoutSettings = async function () {
            const isActive = $('#scout-style-active').is(':checked');
            const prompt = $('#scout-style-prompt').val();

            try {
                const { error } = await supabase
                    .from('user_scout_settings')
                    .upsert({
                        user_id: currentUser.id,
                        style_prompt: prompt,
                        is_active: isActive,
                        updated_at: new Date().toISOString()
                    });

                if (error) throw error;
                alert('Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
                closeScoutSettingsModal();
            } catch (e) {
                console.error(e);
                alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        window.submitFeedback = async function (btn, rating) {
            const container = $(btn).closest('.feedback-container');
            // Try to get history ID from DOM (hidden input is most reliable), then data-attr, then global
            const historyId = $('#current-analysis-history-id').val() || container.data('history-id') || window.currentAnalysisHistoryId;

            if (!historyId) {
                console.warn('No history ID found for feedback');
                return;
            }

            const jobId = container.data('job-id');
            // Find scout content nearby
            const scoutContent = $(btn).closest('.border-t').find('.scout-body-textarea').val() || $(btn).closest('.border-t').find('.scout-body-text').text();

            // Visual feedback
            container.find('button').addClass('text-gray-200').removeClass('text-yellow-500');
            $(btn).removeClass('text-gray-200').addClass('text-yellow-500');

            try {
                const { error } = await supabase
                    .from('scout_feedbacks')
                    .insert({
                        user_id: currentUser.id,
                        history_id: historyId,
                        job_id: jobId,
                        rating: rating,
                        scout_content: scoutContent
                    });

                if (error) throw error;
                console.log('Feedback submitted:', rating);
                // alert('Ë©ï‰æ°„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ'); // Optional: show distinct feedback
            } catch (e) {
                console.error('Feedback error:', e);
            }
        }

        /* =========================================
           Candidate Search & Matching Logic
           ========================================= */

        let isCandidateSearchInitialized = false;
        window.selectedTargetJobId = null;
        let allCandidateSearchJobs = [];

        async function loadCandidateSearch() {
            if (!currentUser) return;
            showLoading();
            try {
                await loadMasterDataForCandidateSearch();
                await loadAllJobsforSearch();

                // ÂàùÂõûÊ§úÁ¥¢Ôºà„Éï„Ç£„É´„Çø„Å™„ÅóÔºâ
                await searchCandidates();

            } catch (e) {
                console.error(e);
            } finally {
                hideLoading();
            }
        }

        async function loadMasterDataForCandidateSearch() {
            if (isCandidateSearchInitialized) return;

            // ÈÉΩÈÅìÂ∫úÁúå
            const prefSelect = $('#c-search-prefecture');
            if (prefSelect.hasClass("select2-hidden-accessible")) {
                prefSelect.select2('destroy');
            }
            prefSelect.empty();
            window.prefectures.forEach(pref => {
                prefSelect.append(`<option value="${pref}">${pref}</option>`);
            });
            prefSelect.select2({ placeholder: "Âã§ÂãôÂú∞ÔºàÈÉΩÈÅìÂ∫úÁúåÔºâ", allowClear: true, width: '100%' });

            // „Éû„Çπ„Çø„Éá„Éº„ÇøÂèñÂæó
            const { data: masters } = await supabase
                .from('master_data')
                .select('*')
                .eq('is_active', true)
                .order('sort_order');

            const validMasters = masters.filter(m => m.organization_id === null || m.organization_id === currentUser.organization_id);

            // ----------------------------------------------------------------
            // 1. Ê±ÇËÅ∑ËÄÖÊ§úÁ¥¢„Éï„Ç©„Éº„É†Áî® Select2
            // ----------------------------------------------------------------

            // ÈõáÁî®ÂΩ¢ÊÖã
            const empSelect = $('#c-search-employment-type');
            if (empSelect.hasClass("select2-hidden-accessible")) {
                empSelect.select2('destroy');
            }
            empSelect.empty();
            const uniqueEmps = [...new Set(validMasters.filter(m => m.type === 'employment_type').map(m => m.label))];
            uniqueEmps.forEach(label => {
                empSelect.append(`<option value="${label}">${label}</option>`);
            });
            empSelect.select2({ placeholder: "ÈõáÁî®ÂΩ¢ÊÖã", allowClear: true, width: '100%' });

            // ËÅ∑Á®Æ
            const catSelect = $('#c-search-job-category');
            if (catSelect.hasClass("select2-hidden-accessible")) {
                catSelect.select2('destroy');
            }
            catSelect.empty();
            const uniqueCats = [...new Set(validMasters.filter(m => m.type === 'job_category').map(m => m.label))];
            uniqueCats.forEach(label => {
                catSelect.append(`<option value="${label}">${label}</option>`);
            });
            catSelect.select2({ placeholder: "ËÅ∑Á®Æ„Ç´„ÉÜ„Ç¥„É™", allowClear: true, width: '100%' });

            // Ê•≠Áïå
            const indSelect = $('#c-search-industry-category');
            if (indSelect.hasClass("select2-hidden-accessible")) {
                indSelect.select2('destroy');
            }
            indSelect.empty();
            const uniqueInds = [...new Set(validMasters.filter(m => m.type === 'industry_category').map(m => m.label))];
            uniqueInds.forEach(label => {
                indSelect.append(`<option value="${label}">${label}</option>`);
            });
            indSelect.select2({ placeholder: "Ê•≠Áïå„Ç´„ÉÜ„Ç¥„É™", allowClear: true, width: '100%' });

            // ----------------------------------------------------------------
            // 2. ÂØæË±°Ê±Ç‰∫∫Ê§úÁ¥¢Áî® Select2 (ËøΩÂä†)
            // ----------------------------------------------------------------

            // ËÅ∑Á®Æ (t-job-category)
            const tjCatSelect = $('#t-job-category');
            if (tjCatSelect.hasClass("select2-hidden-accessible")) {
                tjCatSelect.select2('destroy');
            }
            tjCatSelect.empty();
            const uniqueTjCats = [...new Set(validMasters.filter(m => m.type === 'job_category').map(m => m.label))];
            uniqueTjCats.forEach(label => {
                tjCatSelect.append(`<option value="${label}">${label}</option>`);
            });
            tjCatSelect.select2({ placeholder: "ËÅ∑Á®Æ„ÅßÁµû„ÇäËæº„Åø", allowClear: true, width: '100%' });

            // Ê•≠Áïå (t-industry)
            const tjIndSelect = $('#t-industry');
            if (tjIndSelect.hasClass("select2-hidden-accessible")) {
                tjIndSelect.select2('destroy');
            }
            tjIndSelect.empty();
            const uniqueTjInds = [...new Set(validMasters.filter(m => m.type === 'industry_category').map(m => m.label))];
            uniqueTjInds.forEach(label => {
                tjIndSelect.append(`<option value="${label}">${label}</option>`);
            });
            tjIndSelect.select2({ placeholder: "Ê•≠Áïå„ÅßÁµû„ÇäËæº„Åø", allowClear: true, width: '100%' });

            // Âã§ÂãôÂú∞ (t-location) - ÈÉΩÈÅìÂ∫úÁúå
            const tjLocSelect = $('#t-location');
            if (tjLocSelect.hasClass("select2-hidden-accessible")) {
                tjLocSelect.select2('destroy');
            }
            tjLocSelect.empty();
            window.prefectures.forEach(pref => {
                tjLocSelect.append(`<option value="${pref}">${pref}</option>`);
            });
            tjLocSelect.select2({ placeholder: "Âã§ÂãôÂú∞„ÅßÁµû„ÇäËæº„Åø", allowClear: true, width: '100%' });

            // Event Listeners for Target Job Search
            const onTargetJobFilterChange = () => {
                const term = $('#target-job-search').val().toLowerCase();
                // Call filter even if term is empty (to filter by dropdowns)
                // But wait, existing logic hid dropdown if term was empty.
                // Now we want to show it if dropdowns are selected?
                // Or just filter in background?
                // Current UI expects "Search Input" to trigger.
                // Let's modify filterAndShowTargetJobs to handle empty term if filters are present.
                filterAndShowTargetJobs(term);
            };

            $('#target-job-search').on('input', onTargetJobFilterChange);
            $('#t-job-category, #t-industry, #t-location').on('change', onTargetJobFilterChange);

            $('#clear-job-selection').on('click', function () {
                clearTargetJobSelection();
            });

            // Float Action Bar Setup
            const floatBar = $(`
            <div id="candidate-float-bar" class="fixed bottom-10 left-1/2 md:left-[calc(50%+125px)] transform -translate-x-1/2 z-50 bg-white border border-indigo-100 rounded-full shadow-2xl px-4 sm:px-8 py-3 sm:py-4 hidden flex items-center justify-between gap-3 sm:gap-8 transition-all duration-300 w-[92vw] sm:w-auto max-w-[700px]">
                    <div class="flex items-center">
                        <div class="bg-indigo-100 text-indigo-600 rounded-full w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center mr-2 sm:mr-3 shrink-0">
                            <i class="fas fa-users text-xs sm:text-base"></i>
                        </div>
                        <div class="leading-tight">
                            <span class="font-bold text-gray-800 block text-[10px] sm:text-sm">ÈÅ∏Êäû‰∏≠„ÅÆÂÄôË£úËÄÖ</span>
                            <span class="text-indigo-600 font-bold"><span id="c-selected-count" class="text-base sm:text-xl">0</span> <span class="text-[10px] sm:text-sm text-gray-500">Âêç</span></span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 sm:gap-3">
                        <button onclick="clearAllSelectedCandidates()" class="bg-gray-100 text-gray-600 px-3 sm:px-4 py-2 sm:py-3 rounded-full hover:bg-gray-200 font-bold shadow hover:shadow-md transition flex items-center text-xs sm:text-sm">
                            <i class="fas fa-times sm:mr-2"></i><span class="hidden sm:inline">ÂÖ®Ëß£Èô§</span>
                        </button>
                        <button id="btn-save-recommendations" onclick="saveCandidatesToRecommendations()" class="bg-indigo-600 text-white px-4 sm:px-8 py-2 sm:py-3 rounded-full hover:bg-indigo-700 font-bold shadow-lg hover:shadow-xl transition flex items-center transform hover:-translate-y-0.5 text-xs sm:text-sm">
                            <i class="fas fa-star mr-1 sm:mr-2"></i>„Åä„Åô„Åô„ÇÅ<span class="hidden sm:inline">Ê±Ç‰∫∫„Å´‰øùÂ≠ò</span>
                        </button>
                    </div>
                </div>
            `);
            // body„Å´append„Åó„Å¶z-index„ÇíÂäπ„Åã„Åõ„Çã („Åæ„Åü„ÅØcontentÂÜÖ„Åß„ÇÇ„Çà„ÅÑ„Ååfixed„Å™„ÅÆ„ÅßbodyÊé®Â•®)
            // „Åü„Å†„ÅóSidebar„Å®„ÅÆÂÖº„Å≠Âêà„ÅÑ„Åß left „ÇíË™øÊï¥„Åó„Åü„ÅÑ„Åå„ÄÅTailwind„ÅÆ md:pl-64 (16rem=256px) „Çí‰Ωø„ÅÜ
            // style="left: 0; width: 100%;" „Å® class="md:pl-64" „Çí‰ΩµÁî®

            $('body').append(floatBar);

            // Handler
            $(document).on('change', '.candidate-select-checkbox', function () {
                const count = $('.candidate-select-checkbox:checked').length;
                $('#c-selected-count').text(count);

                const bar = $('#candidate-float-bar');

                // AIÁµêÊûúË°®Á§∫‰∏≠„ÅÆ„Åø„Éê„Éº„ÇíË°®Á§∫„Åô„Çã (Ê±ÇËÅ∑ËÄÖÊ§úÁ¥¢„É™„Çπ„Éà„Åß„ÅÆAI„Éû„ÉÉ„ÉÅ„É≥„Ç∞„Éê„Éº„ÅØ‰∏çË¶Å„Å®„ÅÆË¶ÅÊúõ)
                if (count > 0 && isAImatchingResultView) {
                    bar.removeClass('hidden').removeClass('translate-y-full').addClass('translate-y-0');
                    $('#candidate-results-container').css('padding-bottom', '100px');
                } else {
                    bar.addClass('translate-y-full');
                    setTimeout(() => {
                        if ($('.candidate-select-checkbox:checked').length === 0 || !isAImatchingResultView) bar.addClass('hidden');
                    }, 300);
                    $('#candidate-results-container').css('padding-bottom', '0');
                }
            });

            isCandidateSearchInitialized = true;
        }

        window.clearAllSelectedCandidates = function () {
            $('.candidate-select-checkbox').prop('checked', false);
            const bar = $('#candidate-float-bar');
            bar.addClass('translate-y-full');
            setTimeout(() => {
                bar.addClass('hidden');
            }, 300);
            $('#c-selected-count').text('0');
            $('#candidate-results-container').css('padding-bottom', '0');
        };

        async function loadAllJobsforSearch() {
            let query = supabase.from('jobs')
                .select('id, title, companies(name), requirements, salary_min, salary_max, job_category, industry_category, location, employment_type')
                .eq('status', 'active');

            if (currentUser && currentUser.organization_id) {
                query = query.eq('organization_id', currentUser.organization_id);
            }

            const { data } = await query;
            allCandidateSearchJobs = data || [];
        }

        window.filterAndShowTargetJobs = function (term) {
            const cats = $('#t-job-category').val() || [];
            const inds = $('#t-industry').val() || [];
            const locs = $('#t-location').val() || [];

            // If no input and no filters, hide
            if (!term && cats.length === 0 && inds.length === 0 && locs.length === 0) {
                $('#target-job-dropdown').addClass('hidden');
                return;
            }

            const filtered = allCandidateSearchJobs.filter(job => {
                const title = (job.title || '').toLowerCase();
                const comp = (job.companies?.name || '').toLowerCase();
                let match = true;

                // Text Match
                if (term) {
                    if (!title.includes(term) && !comp.includes(term)) match = false;
                }

                // Category Match
                if (match && cats.length > 0) {
                    // job.job_category is string or array
                    const jCats = Array.isArray(job.job_category) ? job.job_category : (job.job_category || '').split(',');
                    // Check intersection
                    const hasCat = cats.some(c => jCats.some(jc => jc.includes(c) || c.includes(jc)));
                    if (!hasCat) match = false;
                }

                // Industry Match
                if (match && inds.length > 0) {
                    const jInds = Array.isArray(job.industry_category) ? job.industry_category : (job.industry_category || '').split(',');
                    const hasInd = inds.some(i => jInds.some(ji => ji.includes(i) || i.includes(ji)));
                    if (!hasInd) match = false;
                }

                // Location Match
                if (match && locs.length > 0) {
                    const jLocs = Array.isArray(job.location) ? job.location : (job.location || '').split(',');
                    const hasLoc = locs.some(l => jLocs.some(jl => jl.includes(l) || l.includes(jl)));
                    if (!hasLoc) match = false;
                }

                return match;
            });

            const dropdown = $('#target-job-dropdown');
            if (filtered.length === 0) {
                dropdown.html('<div class="p-3 text-gray-500 text-sm">Ë©≤ÂΩì„Åô„ÇãÊ±Ç‰∫∫„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>').removeClass('hidden');
                return;
            }

            const html = filtered.slice(0, 10).map(job => `
            <div class="p-2 hover:bg-indigo-50 cursor-pointer flex justify-between items-center border-b"
        onclick="window.selectTargetJob('${job.id}')">
            <div>
                <div class="font-medium text-gray-800">${job.title}</div>
                <div class="text-xs text-gray-500">${job.companies?.name || ''}</div>
            </div>
                </div>
            `).join('');

            dropdown.html(html).removeClass('hidden');
        }

        window.selectTargetJob = function (jobId) {
            console.log('selectTargetJob called', jobId);
            const job = allCandidateSearchJobs.find(j => j.id === jobId);
            if (!job) {
                console.error('Job not found in cache', jobId);
                return;
            }

            selectedTargetJobId = jobId;

            // Ë©≥Á¥∞„Éú„Çø„É≥ËøΩÂä†
            $('#selected-job-title').html(`
                ${job.title}
        <button onclick="event.stopPropagation(); showJobDetailModal('${job.id}')" class="ml-2 text-indigo-600 hover:text-indigo-800 text-xs bg-indigo-50 px-2 py-1 rounded border border-indigo-200 transition-colors">
            <i class="fas fa-info-circle mr-1"></i>Ë©≥Á¥∞
        </button>
        `);
            $('#selected-job-company').text(job.companies?.name || '-');

            $('#selected-job-display').removeClass('hidden');
            $('#target-job-input-wrapper').addClass('hidden');
            $('#target-job-dropdown').addClass('hidden');
            $('#job-ai-match-btn').prop('disabled', false);

            // Ê§úÁ¥¢Êù°‰ª∂„Çí„Çª„ÉÉ„Éà
            // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà
            $('#c-search-keyword').val('');
            $('#c-search-location').val('');
            $('#c-search-prefecture').val(null).trigger('change');
            $('#c-search-job-category').val(null).trigger('change');
            $('#c-search-industry-category').val(null).trigger('change');
            $('#c-search-employment-type').val(null).trigger('change');
            $('#c-search-salary-min').val('');

            // „Éò„É´„Éë„Éº: ÈÖçÂàó„Åã„Ç´„É≥„ÉûÂå∫Âàá„ÇäÊñáÂ≠óÂàó„ÇíÈÖçÂàó„Å´Ê≠£Ë¶èÂåñ
            const normalizeToArray = (val) => {
                if (!val) return [];
                if (Array.isArray(val)) return val;
                return val.split(',').map(s => s.trim());
            };

            // ËÅ∑Á®Æ
            if (job.job_category) {
                const vals = normalizeToArray(job.job_category);
                $('#c-search-job-category').val(vals).trigger('change');
            }

            // Ê•≠Áïå
            if (job.industry_category) {
                const vals = normalizeToArray(job.industry_category);
                $('#c-search-industry-category').val(vals).trigger('change');
            }

            // ÈõáÁî®ÂΩ¢ÊÖã
            if (job.employment_type) {
                const vals = normalizeToArray(job.employment_type);
                $('#c-search-employment-type').val(vals).trigger('change');
            }

            // Âã§ÂãôÂú∞ (ÈÉΩÈÅìÂ∫úÁúåÊäΩÂá∫)
            if (job.location) {
                const locs = normalizeToArray(job.location);
                // Ë©≥Á¥∞„ÉÜ„Ç≠„Çπ„Éà„Éú„ÉÉ„ÇØ„Çπ„Å´„ÅØÁµêÂêà„Åó„Å¶„Çª„ÉÉ„Éà
                $('#c-search-location').val(locs.join(', '));

                // ÈÉΩÈÅìÂ∫úÁúå„Çí„Çª„ÉÉ„Éà
                const foundPrefs = [];
                locs.forEach(loc => {
                    const pref = window.prefectures.find(p => loc.startsWith(p));
                    if (pref) foundPrefs.push(pref);
                });

                if (foundPrefs.length > 0) {
                    $('#c-search-prefecture').val(foundPrefs).trigger('change');
                }
            }

            // Áµ¶‰∏é (ÊúÄ‰ΩéÂπ¥Âèé) - Ê±Ç‰∫∫„ÅÆÊúÄ‰ΩéÂπ¥Âèé‰ª•‰∏ä„ÅÆÂ∏åÊúõ„ÇíÊåÅ„Å§‰∫∫„ÇíÊ§úÁ¥¢Ôºü 
            // „ÅÑ„ÇÑ„ÄÅÊ±ÇËÅ∑ËÄÖÊ§úÁ¥¢„Å™„ÅÆ„Åß„ÄåÊ±Ç‰∫∫„ÅÆÊù°‰ª∂„Äç„Å´Âêà„ÅÜ‰∫∫„ÇíÊé¢„Åô„ÄÇ
            // Ê±ÇËÅ∑ËÄÖ„ÅÆÂ∏åÊúõÂπ¥Âèé <= Ê±Ç‰∫∫„ÅÆ‰∏äÈôêÔºü
            // „Åì„Åì„Åß„ÅØ„Ç∑„É≥„Éó„É´„Å´„Çª„ÉÉ„Éà„Åó„Å™„ÅÑ„ÄÅ„Åæ„Åü„ÅØÊ±Ç‰∫∫„ÅÆMin„ÇíÂÖ•„Çå„Çã„ÄÇ
            // „É¶„Éº„Ç∂„ÉºË¶ÅÊúõ„ÅØ„ÄåÊù°‰ª∂„Çª„ÉÉ„Éà„Äç„ÄÇÊ±Ç‰∫∫„ÅÆÂ±ûÊÄß„Çí„Çª„ÉÉ„Éà„Åô„Çã„ÅÆ„ÅåËá™ÁÑ∂„ÄÇ
            // Ê±Ç‰∫∫„Åå„ÄåÂπ¥Âèé500‰∏á„Äú„Äç„Å™„Çâ„ÄÅÂ∏åÊúõÂπ¥Âèé500‰∏á„Åè„Çâ„ÅÑ„ÅÆ‰∫∫„ÇíÊé¢„Åô„ÅÆ„ÅåÁ≠ãÔºü
            // „ÅÑ„Å£„Åü„Çì„Çπ„Ç≠„ÉÉ„ÉóÔºà„É¶„Éº„Ç∂„ÉºÂà§Êñ≠„Å´‰ªª„Åõ„ÇãÔºâ„Åã„ÄÅMin„ÇíÂÖ•„Çå„Çã„ÄÇ
            // if (job.salary_min) $('#c-search-salary-min').val(job.salary_min / 10000);

            // Ê§úÁ¥¢Ëá™ÂãïÂÆüË°å
            searchCandidates();
        }

        window.clearTargetJobSelection = function () {
            selectedTargetJobId = null;
            $('#selected-job-display').addClass('hidden');
            $('#target-job-input-wrapper').removeClass('hidden');
            $('#target-job-search').val('');
            $('#job-ai-match-btn').prop('disabled', true);
        }

        window.searchCandidatesImmediate = function () {
            searchCandidates();
        }

        window.clearCandidateSearch = function () {
            $('#c-search-keyword').val('');
            $('#c-tags-keyword').empty();
            $('input[name="c-search-keyword-mode"][value="OR"]').prop('checked', true);
            $('#c-search-location').val('');
            $('#c-tags-location').empty();

            // Slider reset
            $('#c-search-salary-slider').val(0);
            $('#c-search-salary-min').val(0);
            $('#c-salary-display').text('ÊåáÂÆö„Å™„Åó');

            $('#c-search-prefecture').val(null).trigger('change');
            $('#c-search-job-category').val(null).trigger('change');
            $('#c-search-industry-category').val(null).trigger('change');
            $('#c-search-employment-type').val(null).trigger('change');
            $('#c-search-sort').val('created_at-desc');
            $('#c-search-management-status').val('active');
            $('#c-search-ai-prompt').val('');
            searchCandidates();
        }

        // ========================
        // Candidate Pagination Variables
        // ========================
        const CANDIDATES_PER_PAGE = 20;
        let currentCandidatePage = 1;
        let totalCandidatePages = 1;
        let currentCandidateFilters = {};
        let allCandidatesCache = []; // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞Âæå„ÅÆÂÖ®ÂÄôË£úËÄÖ

        window.searchCandidates = async function searchCandidates(filters = {}, page = 1) {
            showLoading();
            $('#candidate-results-container').empty();

            // Build Query
            // „Ç≠„Éº„ÉØ„Éº„Éâ„Çø„Ç∞
            const kTags = [];
            $('#c-tags-keyword .premium-tag').each(function () {
                kTags.push($(this).text().trim().toLowerCase());
            });
            let keyword = $('#c-search-keyword').val().toLowerCase().trim();
            if (kTags.length > 0) {
                keyword = (keyword + ' ' + kTags.join(' ')).trim();
            }

            // „Éï„É™„Éº„ÉØ„Éº„Éâ„Çø„Ç∞ÔºàÂã§ÂãôÂú∞Ôºâ
            const fTags = [];
            $('#c-tags-location .premium-tag').each(function () {
                fTags.push($(this).text().trim());
            });
            let location = $('#c-search-location').val().trim();
            if (fTags.length > 0) {
                location = (location + ' ' + fTags.join(' ')).trim();
            }

            const pref = $('#c-search-prefecture').val(); // array
            const jobCat = $('#c-search-job-category').val(); // array
            const indCat = $('#c-search-industry-category').val(); // array
            const empType = $('#c-search-employment-type').val(); // array
            const minSal = $('#c-search-salary-min').val();
            const sort = $('#c-search-sort').val();
            const managementStatus = $('#c-search-management-status').val();
            const aiPrompt = $('#c-search-ai-prompt').val();

            try {
                let query = supabase.from('users')
                    .select('*, candidate_profiles(*)')
                    .eq('role', 'candidate')
                    .eq('organization_id', currentUser.organization_id);

                // ... (Auth Logic) ...
                const isAdmin = ['org_admin', 'admin', 'super_admin'].includes(currentUser.role);
                const isStaff = ['coach', 'ca', 'ra'].includes(currentUser.role);
                const limitView = currentUser.organizations && currentUser.organizations.settings && (currentUser.organizations.settings.limit_agent_view === true || currentUser.organizations.settings.limit_agent_view === 'true');

                if (!isAdmin && isStaff && limitView) {
                    query = query.eq('coach_id', currentUser.id);
                }

                const { data: users, error } = await query;
                if (error) throw error;

                // Client-side Filtering
                let results = users.map(u => {
                    const p = Array.isArray(u.candidate_profiles) ? u.candidate_profiles[0] : u.candidate_profiles;
                    return { ...u, ...p, id: u.id };
                });

                results = results.filter(u => u.status !== 'suspended');

                if (managementStatus && managementStatus !== 'all') {
                    results = results.filter(u => u.management_status === managementStatus || (managementStatus === 'active' && !u.management_status));
                }

                if (keyword) {
                    const keywords = keyword.split(/[\s„ÄÄ]+/).filter(k => k);
                    const mode = $('input[name="c-search-keyword-mode"]:checked').val() || 'OR';

                    if (keywords.length > 0) {
                        results = results.filter(u => {
                            if (mode === 'OR') {
                                // „ÅÑ„Åö„Çå„Åã„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Çå„Å∞OK
                                return keywords.some(k =>
                                    (u.name && u.name.toLowerCase().includes(k)) ||
                                    (u.skills && u.skills.toLowerCase().includes(k)) ||
                                    (u.work_history && u.work_history.toLowerCase().includes(k))
                                );
                            } else {
                                // ÂÖ®„Å¶„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Å™„Åë„Çå„Å∞„Å™„Çâ„Å™„ÅÑ
                                return keywords.every(k =>
                                    (u.name && u.name.toLowerCase().includes(k)) ||
                                    (u.skills && u.skills.toLowerCase().includes(k)) ||
                                    (u.work_history && u.work_history.toLowerCase().includes(k))
                                );
                            }
                        });
                    }
                }

                if (location) {
                    results = results.filter(u =>
                        (u.desired_location && (Array.isArray(u.desired_location) ? u.desired_location.join(' ') : u.desired_location).toLowerCase().includes(location.toLowerCase()))
                    );
                }

                if (pref && pref.length > 0) {
                    results = results.filter(u => {
                        if (!u.desired_location) return false;
                        const uLocs = Array.isArray(u.desired_location) ? u.desired_location : u.desired_location.split(',');
                        return uLocs.some(ul => pref.some(p => ul.includes(p)));
                    });
                }

                if (jobCat && jobCat.length > 0) {
                    results = results.filter(u => {
                        if (!u.desired_job_type) return false;
                        const uVals = Array.isArray(u.desired_job_type) ? u.desired_job_type : u.desired_job_type.split(',');
                        return uVals.some(v => jobCat.some(c => v.includes(c)));
                    });
                }

                if (minSal) {
                    results = results.filter(u => (u.desired_salary || 0) / 10000 >= minSal);
                }

                // Sort
                if (sort === 'created_at-desc') results.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                else if (sort === 'age-asc') results.sort((a, b) => (a.age || 999) - (b.age || 999));
                else if (sort === 'age-desc') results.sort((a, b) => (b.age || 0) - (a.age || 0));
                else if (sort === 'salary-desc') results.sort((a, b) => (b.desired_salary || 0) - (a.desired_salary || 0));

                // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥Âá¶ÁêÜ
                currentCandidatePage = page;
                currentCandidateFilters = { ...filters, aiPrompt };
                allCandidatesCache = results;

                const totalCount = results.length;
                totalCandidatePages = Math.ceil(totalCount / CANDIDATES_PER_PAGE);

                // AIÊ§úÁ¥¢„Éú„ÉÉ„ÇØ„Çπ„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
                updateAISearchState('candidate', totalCount);

                // AI Ranking if prompt exists and not initial load and box is active
                const isAiBoxDisabled = $('#candidate-ai-search-box').hasClass('disabled');
                console.log('AI Prompt Trigger Check (Candidates):', { isInitialLoad, isAiBoxDisabled, prompt: aiPrompt, resultCount: totalCount });

                if (!isInitialLoad && !isAiBoxDisabled && aiPrompt && aiPrompt.trim().length > 0 && results.length > 0) {
                    $('#candidate-ai-search-box').addClass('searching');
                    // showLoading('AI„ÅåÊåáÁ§∫ÂÜÖÂÆπ„Å´Âü∫„Å•„ÅçÁ≤æÊüª‰∏≠...');
                    try {
                        const topResults = results.slice(0, 50); // „Éó„É≠„É≥„Éó„ÉàË©ï‰æ°„ÅØ‰∏ä‰Ωç50‰ª∂„Å´Âà∂Èôê
                        const { data: aiRanked, error: aiError } = await supabase.functions.invoke('score-ai-recommendations', {
                            body: {
                                type: 'candidate',
                                customInstruction: aiPrompt,
                                candidates: topResults
                            }
                        });

                        if (!aiError && aiRanked) {
                            console.log('AI Match Results (Candidates):', aiRanked);
                            // „Çπ„Ç≥„Ç¢„Çí„Éû„ÉÉ„Éî„É≥„Ç∞
                            results.forEach(u => {
                                const rank = aiRanked.find(r => r.id === u.id || r.user_id === u.id);
                                if (rank) {
                                    u.ai_score = rank.score;
                                    u.ai_reason = rank.reason;
                                }
                            });
                            // „Çπ„Ç≥„Ç¢È†Ü„Å´„ÇΩ„Éº„ÉàÔºà‰∏ä‰Ωç50‰ª∂„ÅÆ„Åø„Éó„É≠„É≥„Éó„ÉàÈ†Ü„ÄÅÊÆã„Çä„ÅØÂÖÉ„ÅÆÈ†ÜÂ∫èÔºâ
                            results.sort((a, b) => (b.ai_score || 0) - (a.ai_score || 0));
                        } else if (aiError) {
                            console.error('AI Ranking Edge Function error (Candidates):', aiError);
                            alert('AI„Å´„Çà„ÇãÁ≤æÊüª„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
                        }
                    } catch (err) {
                        console.error('AI Ranking error (Candidates):', err);
                        alert('AI„Å∏„ÅÆ„É™„ÇØ„Ç®„Çπ„Éà‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
                    } finally {
                        $('#candidate-ai-search-box').removeClass('searching');
                    }
                    // hideLoading();
                }

                const from = (page - 1) * CANDIDATES_PER_PAGE;
                const to = from + CANDIDATES_PER_PAGE;
                const paginatedResults = results.slice(from, to);

                console.log(`Loaded candidate page ${page}/${totalCandidatePages}, showing ${paginatedResults.length} candidates (total: ${totalCount})`);

                renderCandidateResults(paginatedResults, totalCount);

                renderCandidatePagination();

            } catch (e) {
                console.error(e);
            } finally {
                hideLoading();
            }
        }

        // ÂÄôË£úËÄÖ„Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥UI„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        function renderCandidatePagination() {
            const container = $('#candidate-pagination-container');
            if (!container.length) {
                // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥„Ç≥„É≥„ÉÜ„Éä„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ‰ΩúÊàê
                $('#candidate-results-container').after('<div id="candidate-pagination-container" class="mt-6"></div>');
            }

            if (totalCandidatePages <= 1) {
                $('#candidate-pagination-container').html('');
                return;
            }

            const maxButtons = 5;
            let startPage = Math.max(1, currentCandidatePage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalCandidatePages, startPage + maxButtons - 1);

            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            let html = '<div class="flex justify-center items-center gap-2">';

            // Ââç„Å∏„Éú„Çø„É≥
            if (currentCandidatePage > 1) {
                html += `<button onclick="searchCandidates(currentCandidateFilters, ${currentCandidatePage - 1})" 
                    class="px-4 py-2 border rounded-lg hover:bg-gray-50 transition">
                    <i class="fas fa-chevron-left"></i> Ââç„Å∏
                </button>`;
            }

            // „Éö„Éº„Ç∏Áï™Âè∑„Éú„Çø„É≥
            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === currentCandidatePage;
                html += `<button onclick="searchCandidates(currentCandidateFilters, ${i})" 
                    class="px-4 py-2 border rounded-lg transition ${isActive ? 'bg-indigo-600 text-white' : 'hover:bg-gray-50'}">
                    ${i}
                </button>`;
            }

            // Ê¨°„Å∏„Éú„Çø„É≥
            if (currentCandidatePage < totalCandidatePages) {
                html += `<button onclick="searchCandidates(currentCandidateFilters, ${currentCandidatePage + 1})" 
                    class="px-4 py-2 border rounded-lg hover:bg-gray-50 transition">
                    Ê¨°„Å∏ <i class="fas fa-chevron-right"></i>
                </button>`;
            }

            html += '</div>';
            html += `<div class="text-center mt-2 text-sm text-gray-600">
                „Éö„Éº„Ç∏ ${currentCandidatePage} / ${totalCandidatePages}
            </div>`;

            $('#candidate-pagination-container').html(html);
        }

        // AI„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÂÆüË°å (Ê±Ç‰∫∫ -> Ê±ÇËÅ∑ËÄÖ)
        // AI„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÂÆüË°å (2ÊÆµÈöé: „É´„Éº„É´„Éô„Éº„ÇπÈÅ∏Êäú -> AIË©≥Á¥∞Ë©ï‰æ°)
        window.runJobToCandidateMatching = async function () {
            if (!selectedTargetJobId) {
                alert('ÂØæË±°Ê±Ç‰∫∫„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // „ÉÅ„Çß„ÉÉ„ÇØ„Åï„Çå„ÅüÂÄôË£úËÄÖ„ÇíÂèñÂæó
            const checkedIds = $('.candidate-select-checkbox:checked').map((_, el) => $(el).val()).get();
            const isSubset = checkedIds.length > 0;

            console.log('Running Matching. Selected:', checkedIds.length);
            showLoading('ÂÄôË£úËÄÖ„ÇíÊäΩÂá∫‰∏≠...');

            try {
                const job = allCandidateSearchJobs.find(j => j.id === selectedTargetJobId);
                if (!job) throw new Error("Selected Job Not Found");

                let candidates = [];

                // ÂÄôË£úËÄÖÂèñÂæó
                if (isSubset) {
                    const { data: users } = await supabase.from('users')
                        .select('*, candidate_profiles(*)')
                        .in('id', checkedIds);
                    if (users) candidates = users;
                } else {
                    const { data: users } = await supabase.from('users')
                        .select('*, candidate_profiles(*)')
                        .eq('role', 'candidate')
                        .eq('organization_id', currentUser.organization_id);
                    if (users) candidates = users;
                }

                // Normalization
                candidates = candidates.map(u => {
                    const p = Array.isArray(u.candidate_profiles) ? u.candidate_profiles[0] : u.candidate_profiles;
                    return { ...u, ...p, id: u.id };
                });

                // ÂÅúÊ≠¢‰∏≠„É¶„Éº„Ç∂„Éº„Åä„Çà„Å≥Ê¥ªÂãïÁµÇ‰∫Ü„É¶„Éº„Ç∂„Éº„ÅÆÈô§Â§ñ
                candidates = candidates.filter(u => u.status !== 'suspended' && u.management_status !== 'inactive');

                // 1. „É´„Éº„É´„Éô„Éº„Çπ„Çπ„Ç≥„Ç¢„É™„É≥„Ç∞
                const scored = candidates.map(c => {
                    const scores = calculateClientSideMatchScores(job, c);
                    return {
                        candidate: c,
                        ...scores,
                        recommendation_reason: generateClientSideRecommendationReason(job, c, scores)
                    };
                });

                // „Çπ„Ç≥„Ç¢È†Ü„Å´„ÇΩ„Éº„Éà („É´„Éº„É´„Éô„Éº„Çπ)
                scored.sort((a, b) => b.match_score - a.match_score);

                // 2. Áµû„ÇäËæº„Åø (‰∏ä‰Ωç5Âêç„Åã„Å§„Çπ„Ç≥„Ç¢40ÁÇπ‰ª•‰∏ä)
                const AI_EVAL_LIMIT = 30;
                const AI_EVAL_THRESHOLD = 40;

                const candidatesForAI = scored.filter(s => s.match_score >= AI_EVAL_THRESHOLD).slice(0, AI_EVAL_LIMIT);

                hideLoading();

                if (candidatesForAI.length === 0) {
                    alert('AIË©ï‰æ°„ÇíË°å„ÅÜÂü∫Ê∫ñÔºà„Çπ„Ç≥„Ç¢40ÁÇπ‰ª•‰∏äÔºâ„ÇíÊ∫Ä„Åü„ÅôÂÄôË£úËÄÖ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ');
                    renderCandidateResults([]);
                    return;
                }

                // Á¢∫Ë™ç
                const confirmMsg = `„É´„Éº„É´„Éô„Éº„ÇπË©ï‰æ°„Å´„Çà„Çä„ÄÅ‰∏ä‰Ωç${candidatesForAI.length} Âêç„ÅÆÂÄôË£úËÄÖ„ÇíÊäΩÂá∫„Åó„Åæ„Åó„Åü„ÄÇ\nÔºàÈñæÂÄ§: 40ÁÇπ‰ª•‰∏ä / ÊúÄÂ§ß30ÂêçÔºâ\n\n„Åì„Çå„Çâ„ÅÆÂÄôË£úËÄÖ„Å´ÂØæ„Åó„Å¶„ÄÅÁîüÊàêAI„Å´„Çà„ÇãË©≥Á¥∞Ë©ï‰æ°„ÇíÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü\nÔºà„Éó„É≠„É≥„Éó„Éà„ÇíÁî®„ÅÑ„ÅüË©≥Á¥∞ÂàÜÊûê„ÇíË°å„ÅÑ„Åæ„Åô„ÄÇÈáè„ÅåÂ§ö„ÅÑÂ†¥Âêà„ÅØÂ∞ë„ÅóÊôÇÈñì„Åå„Åã„Åã„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÔºâ`;

                if (!confirm(confirmMsg)) {
                    // „Ç≠„É£„É≥„Çª„É´„Åó„ÅüÂ†¥Âêà„ÅØ„É´„Éº„É´„Éô„Éº„Çπ„ÅÆÁµêÊûú„ÇíË°®Á§∫
                    renderMatchingResults(scored, '#candidate-results-container');
                    alert(`AIË©ï‰æ°„Çí„Ç≠„É£„É≥„Çª„É´„Åó„Åæ„Åó„Åü„ÄÇ\n„É´„Éº„É´„Éô„Éº„ÇπË©ï‰æ°„ÅÆÁµêÊûúÔºàÂÖ®${scored.length} ‰ª∂Ôºâ„ÇíË°®Á§∫„Åó„Åæ„Åô„ÄÇ`);
                    return;
                }

                // 3. AIË©ï‰æ°ÂÆüË°å
                showLoading(`AI„ÅåÊäΩÂá∫„Åï„Çå„Åü${candidatesForAI.length}Âêç„ÅÆÂÄôË£úËÄÖ„ÇíË©≥Á¥∞Ë©ï‰æ°‰∏≠...\n„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ`);

                // „Éê„ÉÉ„ÉÅÂá¶ÁêÜ„ÅßEdge Function„ÇíÂëº„Å≥Âá∫„Åô (ÂêåÊôÇ‰∏¶ÂàóÊï∞„ÇíÂà∂Èôê„Åó„Å¶503„Ç®„É©„Éº„ÇíÈò≤„Åê)
                const aiResults = [];
                const BATCH_SIZE = 2; // 2‰ª∂„Åö„Å§‰∏¶ÂàóÂá¶ÁêÜ

                for (let i = 0; i < candidatesForAI.length; i += BATCH_SIZE) {
                    const batch = candidatesForAI.slice(i, i + BATCH_SIZE);
                    const batchPromises = batch.map(async (item) => {
                        try {
                            const { data, error } = await supabase.functions.invoke('ai-matching', {
                                body: {
                                    user: item.candidate,
                                    jobs: [job]
                                }
                            });

                            if (error) throw error;
                            if (!data || data.length === 0) throw new Error("No Data");

                            const result = data[0];

                            // „Éû„Éº„Ç∏
                            return {
                                ...item,
                                match_score: result.match_score || item.match_score,
                                recommendation_reason: result.recommendation_reason || result.reason,

                                // Ë©≥Á¥∞„Çπ„Ç≥„Ç¢„ÅÆ‰∏äÊõ∏„Åç (AIÁµêÊûú„Å´„ÅÇ„Çå„Å∞ÂÑ™ÂÖà)
                                skill_match_score: result.skill_match_score ?? item.skill_match_score,
                                experience_match_score: result.experience_match_score ?? item.experience_match_score,
                                location_match_score: result.location_match_score ?? item.location_match_score,
                                salary_match_score: result.salary_match_score ?? item.salary_match_score,
                                culture_match_score: result.culture_match_score ?? item.culture_match_score,

                                ai_details: result.details,
                                is_ai_evaluated: true
                            };

                        } catch (e) {
                            console.error('AI Error for', item.candidate.name, e);
                            return { ...item, recommendation_reason: item.recommendation_reason + ' (AIË©ï‰æ°„Ç®„É©„Éº)' };
                        }
                    });

                    const batchResults = await Promise.all(batchPromises);
                    aiResults.push(...batchResults);

                    // ÈÄ≤Ë°åÁä∂Ê≥Å„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞„Åó„Åü„ÅÑÂ†¥Âêà„ÅØ„Åì„Åì„ÅßUIÊõ¥Êñ∞„ÇíÂÖ•„Çå„Çã„Åì„Å®„ÇÇÂèØËÉΩ
                    showLoading(`AI„ÅåÂÄôË£úËÄÖ„ÇíË©≥Á¥∞Ë©ï‰æ°‰∏≠... (${Math.min(i + BATCH_SIZE, candidatesForAI.length)} / ${candidatesForAI.length})`);
                }

                // ÂÜç„ÇΩ„Éº„ÉàÔºàAI„Çπ„Ç≥„Ç¢„ÅßÈ†Ü‰Ωç„ÅåÂ§â„Çè„ÇãÂèØËÉΩÊÄß„ÅÇ„ÇäÔºâ
                aiResults.sort((a, b) => b.match_score - a.match_score);

                // Ë°®Á§∫ (AIË©ï‰æ°„Åï„Çå„Åü„ÇÇ„ÅÆ„Å†„Åë„ÇíË°®Á§∫)
                isAImatchingResultView = true;

                // „Ç≠„É£„ÉÉ„Ç∑„É•„Å´‰øùÂ≠ò
                aiResults.forEach(r => {
                    const key = `${r.candidate.id}_${selectedTargetJobId}`;
                    aiResultCache[key] = r.ai_details;
                });

                renderMatchingResults(aiResults, '#candidate-results-container');

                // „Éê„Éº„ÅÆÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„ÉàÔºàÊ¨°„ÅØ„Äå‰øùÂ≠ò„Äç„Éú„Çø„É≥„ÅåÂá∫„Çã„Çà„ÅÜ„Å´„Åô„Çã„Åü„ÇÅÔºâ
                clearAllSelectedCandidates();

                alert(`AIË©≥Á¥∞Ë©ï‰æ°„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ\n${aiResults.length} Âêç„ÅÆÂÄôË£úËÄÖ„ÇíË°®Á§∫„Åó„Åæ„Åô„ÄÇ`);

            } catch (e) {
                console.error(e);
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + e.message);
            } finally {
                hideLoading();
            }
        }

        window.saveCandidatesToRecommendations = async function () {
            const checkedIds = $('.candidate-select-checkbox:checked').map((_, el) => $(el).val()).get();
            if (checkedIds.length === 0) return;
            if (!selectedTargetJobId) {
                alert('ÂØæË±°„ÅÆÊ±Ç‰∫∫„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            showLoading('„Åä„Åô„Åô„ÇÅ„Å´‰øùÂ≠ò‰∏≠...');
            try {
                const recs = checkedIds.map(userId => {
                    const key = `${userId}_${selectedTargetJobId}`;
                    const details = aiResultCache[key];

                    const card = $(`.candidate-select-checkbox[value="${userId}"]`).closest('.border');
                    const scoreText = card.find('span:contains("„Éû„ÉÉ„ÉÅÂ∫¶:")').text();
                    const score = parseFloat(scoreText.replace('„Éû„ÉÉ„ÉÅÂ∫¶:', '').replace('%', '')) || 0;

                    return {
                        organization_id: currentUser.organization_id,
                        user_id: userId,
                        job_id: selectedTargetJobId,
                        score: score,
                        reason: card.find('.bg-blue-50 p, .bg-gray-50 p').first().text().trim() || 'AI„Éû„ÉÉ„ÉÅ„É≥„Ç∞Ë©ï‰æ°Ê∏à„Åø',
                        recommended_by: currentUser.id,
                        details: details || null
                    };
                });

                console.log('Saving recommendations:', recs);

                // Êó¢Â≠ò„É¨„Ç≥„Éº„Éâ„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶„ÄÅinsert/update„ÇíÂÄãÂà•„Å´ÂÆüË°å
                for (const rec of recs) {
                    // Êó¢Â≠ò„É¨„Ç≥„Éº„Éâ„ÇíÁ¢∫Ë™ç
                    const { data: existing, error: checkError } = await supabase
                        .from('recommendations')
                        .select('id')
                        .eq('user_id', rec.user_id)
                        .eq('job_id', rec.job_id)
                        .maybeSingle();

                    if (checkError) {
                        console.error('Check error:', checkError);
                        throw checkError;
                    }

                    if (existing) {
                        // Êó¢Â≠ò„É¨„Ç≥„Éº„Éâ„ÇíÊõ¥Êñ∞
                        const { error: updateError } = await supabase
                            .from('recommendations')
                            .update({
                                score: rec.score,
                                reason: rec.reason,
                                recommended_by: rec.recommended_by,
                                details: rec.details
                            })
                            .eq('id', existing.id);

                        if (updateError) throw updateError;
                    } else {
                        // Êñ∞Ë¶è„É¨„Ç≥„Éº„Éâ„ÇíÊåøÂÖ•
                        const { error: insertError } = await supabase
                            .from('recommendations')
                            .insert(rec);

                        if (insertError) throw insertError;
                    }
                }

                alert(`${recs.length} Âêç„Çí„Äå„Åä„Åô„Åô„ÇÅÊ±Ç‰∫∫„Äç„Å´‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ`);
                clearAllSelectedCandidates();
            } catch (e) {
                console.error('Failed to save recommendations:', e);
                alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + e.message);
            } finally {
                hideLoading();
            }
        };

        window.clearMatchResults = function () {
            $('#candidate-results-container').empty();
            $('#candidate-results-container').html(`
            <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-search text-4xl mb-3"></i>
                        <p>Êù°‰ª∂„ÇíÊåáÂÆö„Åó„Å¶Ê§úÁ¥¢„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                    </div>
            `);
            // Also restore checkboxes? They are gone.
            // Reset Floating Bar
            $('#c-selected-count').text('0');
            $('#candidate-float-bar').addClass('translate-y-full').addClass('hidden');
            $('#candidate-results-container').css('padding-bottom', '0');
        }

        function renderCandidateResults(candidates, totalCount = null) {
            isAImatchingResultView = false;
            // „Éê„Éº„ÇíÈö†„Åô
            $('#candidate-float-bar').addClass('translate-y-full').addClass('hidden');

            const container = $('#candidate-results-container');
            if (candidates.length === 0) {
                container.html('<div class="text-center p-8 text-gray-500">Êù°‰ª∂„Å´‰∏ÄËá¥„Åô„ÇãÊ±ÇËÅ∑ËÄÖ„ÅØË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</div>');
                animateCandidateCount(0);
                return;
            }

            // ‰ª∂Êï∞Ë°®Á§∫„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            animateCandidateCount(totalCount);

            if (totalCount !== null) {
                const resultInfo = `<div class="mb-4 text-sm text-gray-600">
                    Ê§úÁ¥¢ÁµêÊûú: ${totalCount}Âêç (${currentCandidatePage}„Éö„Éº„Ç∏ÁõÆ„ÇíË°®Á§∫‰∏≠)
                </div>`;
                container.append(resultInfo);
            }

            const html = candidates.map(c => {
                return renderCandidateCard({
                    candidate: c,
                    // „Éû„ÉÉ„ÉÅÂ∫¶„Å™„Å©„ÅØ‰∏ÄÊó¶0„Åæ„Åü„ÅØÊ§úÁ¥¢ÁµêÊûú„Åã„Çâ (Ê§úÁ¥¢„É≠„Ç∏„ÉÉ„ÇØ„Å´„Çà„Å£„Å¶„ÅØ„Çπ„Ç≥„Ç¢„ÅåÂÖ•„Çã)
                    match_score: c.ai_score || c.match_score || 0,
                    skill_match_score: c.skill_match_score || 0,
                    experience_match_score: c.experience_match_score || 0,
                    location_match_score: c.location_match_score || 0,
                    salary_match_score: c.salary_match_score || 0,
                    culture_match_score: c.culture_match_score || 0,
                    recommendation_reason: c.ai_reason || ''
                });
            }).join('');
            container.html(html);
        }

        window.copyToClipboard = function (btn) {
            const card = $(btn).closest('.bg-white');
            const subject = (card.find('.scout-subject-input').val() || card.find('p:contains("‰ª∂Âêç:")').text().replace('‰ª∂Âêç: ', '') || '').trim();
            const body = (card.find('.scout-body-textarea').val() || card.find('.scout-body-text').text() || '').trim();

            const textToCopy = `‰ª∂Âêç: ${subject} \n\n${body} `;

            navigator.clipboard.writeText(textToCopy).then(() => {
                const originalHtml = $(btn).html();
                $(btn).html('<i class="fas fa-check text-green-500 text-xl"></i>');
                setTimeout(() => {
                    $(btn).html(originalHtml);
                }, 2000);
            });
        }


        // ========================
        // Pagination Variables
        // ========================
        // Pagination Variables
        // ========================
        const ITEMS_PER_PAGE = 20;
        let currentJobPage = 1;
        let totalJobPages = 1;
        let currentJobFilters = {};
        let allJobsCache = []; // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥Áî®„ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•

        async function loadJobs(filters = {}, page = 1) {
            if (!currentUser || !currentUser.organization_id) {
                console.warn('loadJobs: currentUser is not fully loaded');
                return;
            }

            showLoading()
            try {
                // „Éû„Çπ„Çø„Éá„Éº„Çø„ÅÆ„É≠„Éº„Éâ
                await loadMasterDataForSearch()

                // ÁÆ°ÁêÜËÄÖ„Éª„Ç≥„Éº„ÉÅ„ÉªCA„ÉªRA„Éª„Çπ„Éº„Éë„ÉºÁÆ°ÁêÜËÄÖÁî®„ÉÑ„Éº„É´„ÅÆË°®Á§∫Âà∂Âæ°
                if (['org_admin', 'admin', 'coach', 'ca', 'ra', 'super_admin'].includes(currentUser.role)) {
                    $('#admin-job-search-tools').removeClass('hidden');
                    $('#global-target-user-nav').hide(); // „Ç∏„Éß„ÉñÊ§úÁ¥¢„Åß„ÅØÂæìÊù•„ÅÆ„Éú„ÉÉ„ÇØ„Çπ„Çí‰Ωø„ÅÜ„Åü„ÇÅ„Ç∞„É≠„Éº„Éê„É´„ÅØÈö†„Åô
                    // Èô§Â§ñ„Éï„Ç£„É´„Çø„ÇíË°®Á§∫
                    $('#exclude-matched-container').removeClass('hidden');
                    $('#exclude-applied-container').removeClass('hidden');
                    $('#exclude-filters-container').removeClass('hidden');
                } else {
                    $('#admin-job-search-tools').addClass('hidden');
                    $('#global-target-user-nav').hide();

                    // Ê±ÇËÅ∑ËÄÖ„ÅÆÂ†¥Âêà„ÅØÂ∏åÊúõÊù°‰ª∂„Éú„Çø„É≥„ÇíË°®Á§∫
                    if (currentUser.role === 'candidate') {
                        $('#candidate-preferred-search-box').removeClass('hidden')
                    } else {
                        $('#candidate-preferred-search-box').addClass('hidden')
                    }

                    $('#exclude-matched-container').addClass('hidden');
                    $('#exclude-applied-container').addClass('hidden');
                    $('#exclude-filters-container').addClass('hidden');
                }

                // „ÅäÊ∞ó„Å´ÂÖ•„Çä„Å®‰øùÂ≠ò„Åï„Çå„ÅüÊ§úÁ¥¢Êù°‰ª∂„Çí„É≠„Éº„Éâ
                await Promise.all([loadFavorites(), loadSavedSearchesList()])

                // „Éû„Çπ„Çø„É≠„Éº„ÉâÂÆå‰∫ÜÂæå„Å´„Éï„Ç£„É´„Çø„ÇíÈÅ©Áî®ÔºàÂàùÂõû„É≠„Éº„ÉâÔºùÂºïÊï∞filters„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅÆ„ÅøÔºâ
                // executeSearch„Åã„Çâ„ÅÆÂëº„Å≥Âá∫„ÅóÔºàfilters„Åå„ÅÇ„ÇãÂ†¥ÂêàÔºâ„ÅØÂÜçÈÅ©Áî®„Åó„Å™„ÅÑ„Åì„Å®„ÅßÁÑ°Èôê„É´„Éº„Éó„ÇíÈò≤„Åê
                if (Object.keys(filters).length === 0) {
                    const savedFilters = loadSearchFilters();
                    if (savedFilters) {
                        console.log('Applying saved filters after master load');
                        applySearchFilters(savedFilters);
                    }
                }


                let query = window.supabase
                    .from('jobs')
                    .select('*, companies(name)', { count: 'exact' })
                    .eq('organization_id', currentUser.organization_id)
                    .is('deleted_at', null) // Ë´ñÁêÜÂâäÈô§„Åï„Çå„ÅüÊ±Ç‰∫∫„ÇíÈô§Â§ñ
                // .eq('status', 'active') // ‰∏ÄÊôÇÁöÑ„Å´„Çπ„ÉÜ„Éº„Çø„Çπ„Éï„Ç£„É´„Çø„ÇíËß£Èô§Ôºà„Ç§„É≥„Éù„Éº„Éà„Éá„Éº„Çø„ÅåË°®Á§∫„Åï„Çå„Å™„ÅÑÂïèÈ°åÂØæÂøúÔºâ

                // „ÇΩ„Éº„ÉàÈ†Ü„ÅÆÈÅ©Áî®„ÅØÊúÄÂæå„Å´ÁßªÂãï„Åó„Åæ„Åó„Åü

                // „Ç≠„Éº„ÉØ„Éº„ÉâÊ§úÁ¥¢ (AND/OR)
                if (filters.keyword) {
                    const keywords = filters.keyword.split(/[\s„ÄÄ,„ÄÅ]+/).filter(k => k) // Á©∫ÁôΩ„Éª„Ç´„É≥„Éû„ÉªË™≠ÁÇπ„Å™„Å©„Åß„ÇÇÂàÜÂâ≤
                    const mode = filters.keywordMode || 'OR'

                    if (keywords.length > 0) {
                        // Note: companies.name „Åß„ÅÆÊ§úÁ¥¢„ÅØSupabase„ÅÆË§áÈõë„Å™„ÇØ„Ç®„É™„Å´„Å™„Çã„Åü„ÇÅ„ÄÅ
                        // „Åì„Åì„Åß„ÅØÁ∞°ÊòìÁöÑ„Å´ title, description, company (legacy column) „ÇíÂØæË±°„Å®„Åô„Çã„Åã„ÄÅ
                        // „ÇÇ„Åó„Åè„ÅØ companies„ÉÜ„Éº„Éñ„É´„ÇíÊ§úÁ¥¢„Åó„Å¶ID„ÇíÂèñÂæó„Åó„Å¶„Åã„Çâ...„Å®„ÅÑ„ÅÜÊâãÈ†Ü„ÅåÂøÖË¶Å„Å†„Åå„ÄÅ
                        // „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„ÇíËÄÉÊÖÆ„Åó„ÄÅ‰∏ÄÊó¶Êó¢Â≠ò„ÅÆ company „Ç´„É©„É†„ÇÇÊ§úÁ¥¢ÂØæË±°„Å´Âê´„ÇÅ„ÇãÔºà„Éá„Éº„ÇøÁßªË°åÊ∏à„Åø„Å™„Çâ company „Ç´„É©„É†„Å´„ÇÇÂÄ§„ÅåÂÖ•„Å£„Å¶„ÅÑ„Çã„ÅØ„ÅöÔºâ
                        // Êú¨Êù•ÁöÑ„Å´„ÅØ .or(`title.ilike.% ${ k }%, description.ilike.% ${ k }%, companies.name.ilike.% ${ k }% `) „Å®„Åó„Åü„ÅÑ„Åå„ÄÅ
                        // „Éç„Çπ„Éà„Åó„Åü„É™„É¨„Éº„Ç∑„Éß„É≥„ÅÆÊ§úÁ¥¢„ÅØÊßãÊñá„ÅåÁï∞„Å™„Çã„ÄÇ
                        // Êö´ÂÆöÂØæÂøú: company (legacy) „Ç´„É©„É†„ÅåÂêåÊúü„Åï„Çå„Å¶„ÅÑ„ÇãÂâçÊèê„ÅßÊ§úÁ¥¢„ÄÇ
                        if (mode === 'OR') {
                            const conditions = keywords.map(k =>
                                `title.ilike.%${k}%,description.ilike.%${k}%,company.ilike.%${k}%,job_code.ilike.%${k}%`
                            ).join(',')
                            query = query.or(conditions)
                        } else {
                            keywords.forEach(k => {
                                query = query.or(`title.ilike.%${k}%,description.ilike.%${k}%,company.ilike.%${k}%,job_code.ilike.%${k}%`)
                            })
                        }
                    }
                }

                if (filters.location) {
                    query = query.ilike('location', `%${filters.location}%`)
                }
                if (filters.prefecture && filters.prefecture.length > 0) {
                    const prefs = Array.isArray(filters.prefecture) ? filters.prefecture : [filters.prefecture];
                    const conditions = prefs.map(p => `location.ilike.%${p}%`).join(',');
                    query = query.or(conditions);
                }
                if (filters.employmentType && filters.employmentType.length > 0) {
                    const types = Array.isArray(filters.employmentType) ? filters.employmentType : [filters.employmentType];
                    // ÂÆåÂÖ®‰∏ÄËá¥(in)„Åã„ÇâÈÉ®ÂàÜ‰∏ÄËá¥(ilike)„Å´Â§âÊõ¥„Åó„Å¶„ÄÅ„Ç´„É≥„ÉûÂå∫Âàá„Çä„Éá„Éº„ÇøÁ≠â„Å´ÂØæÂøú
                    const conditions = types.map(t => `employment_type.ilike.%${t}%`).join(',');
                    query = query.or(conditions);
                }
                if (filters.jobCategory && filters.jobCategory.length > 0) {
                    const cats = Array.isArray(filters.jobCategory) ? filters.jobCategory : [filters.jobCategory];
                    // ÂÆåÂÖ®‰∏ÄËá¥(in)„Åã„ÇâÈÉ®ÂàÜ‰∏ÄËá¥(ilike)„Å´Â§âÊõ¥ + Ë°®Ë®òÊè∫„ÇåÂØæÁ≠ñÔºàÊã¨ÂºßÈô§ÂéªÔºâ
                    const conditions = cats.map(c => {
                        let cleanC = c.replace(/[\(Ôºà].*?[\)Ôºâ]/g, '').trim();
                        if (!cleanC) cleanC = c;
                        return `job_category.ilike.%${cleanC}%`;
                    }).join(',');
                    query = query.or(conditions);
                }
                if (filters.industryCategory && filters.industryCategory.length > 0) {
                    const inds = Array.isArray(filters.industryCategory) ? filters.industryCategory : [filters.industryCategory];
                    const conditions = inds.map(i => {
                        let cleanI = i.replace(/[\(Ôºà].*?[\)Ôºâ]/g, '').trim();
                        if (!cleanI) cleanI = i;
                        return `industry_category.ilike.%${cleanI}%`;
                    }).join(',');
                    query = query.or(conditions);
                }
                if (filters.salaryMin) {
                    const minVal = parseInt(filters.salaryMin) * 10000;
                    // Âπ¥ÂèéÊù°‰ª∂„ÇíÊ∫Ä„Åü„Åô„Åã„ÄÅÂπ¥ÂèéÊÉÖÂ†±„Åå„Å™„ÅÑ(null)Ê±Ç‰∫∫„ÇíË°®Á§∫
                    query = query.or(`salary_max.gte.${minVal}, salary_max.is.null`);
                }
                if (filters.jobExperienceOk) {
                    query = query.eq('job_experience_ok', 'ÂèØ')
                }
                if (filters.industryExperienceOk) {
                    query = query.eq('industry_experience_ok', 'ÂèØ')
                }
                if (filters.isRemote) {
                    query = query.eq('is_remote', true)
                }

                // „ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅÆ„Åø„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
                if (filters.favoritesOnly) {
                    if (favoriteJobIds.size > 0) {
                        query = query.in('id', Array.from(favoriteJobIds));
                    } else {
                        // „ÅäÊ∞ó„Å´ÂÖ•„Çä„Åå0‰ª∂„ÅÆÂ†¥Âêà„ÅØ‰Ωï„ÇÇË°®Á§∫„Åó„Å™„ÅÑ
                        // id.in.() „ÅØ„Ç®„É©„Éº„Å´„Å™„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çã„Åü„ÇÅ„ÄÅ„ÅÇ„ÇäÂæó„Å™„ÅÑÊù°‰ª∂„ÇíÂÖ•„Çå„Çã
                        query = query.eq('id', '00000000-0000-0000-0000-000000000000'); // Dummy UUID
                    }
                }

                // AI„Éû„ÉÉ„ÉÅ„É≥„Ç∞Ê∏à„ÅøÈô§Â§ñ
                if (filters.excludeMatched) {
                    const targetUserId = selectedTargetUserId || (currentUser.role === 'candidate' ? currentUser.id : null);

                    if (targetUserId) {
                        // Êé®Ëñ¶Ê∏à„ÅøÊ±Ç‰∫∫ID„ÇíÂèñÂæó
                        const { data: recommendations } = await supabase
                            .from('recommendations')
                            .select('job_id')
                            .eq('user_id', targetUserId);

                        if (recommendations && recommendations.length > 0) {
                            const matchedJobIds = recommendations.map(r => r.job_id);
                            if (matchedJobIds.length > 0) {
                                query = query.not('id', 'in', `(${matchedJobIds.join(',')})`);
                            }
                        }
                    }
                }

                // ÂøúÂãüÊ∏à„ÅøÈô§Â§ñ
                if (filters.excludeApplied) {
                    const targetUserId = selectedTargetUserId || (currentUser.role === 'candidate' ? currentUser.id : null);
                    if (targetUserId) {
                        const { data: applications } = await supabase
                            .from('applications')
                            .select('job_id')
                            .eq('user_id', targetUserId);
                        if (applications && applications.length > 0) {
                            const appliedJobIds = applications.map(a => a.job_id);
                            query = query.not('id', 'in', `(${appliedJobIds.join(',')})`);
                        }
                    }
                }

                // „ÇΩ„Éº„ÉàÈ†Ü„ÅÆÈÅ©Áî®
                const sortParam = filters.sort || 'created_at-desc';
                console.log('Applying sort:', sortParam);
                const [sortCol, sortOrder] = sortParam.split('-');
                query = query.order(sortCol, { ascending: sortOrder === 'asc' });

                // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥: Á∑è‰ª∂Êï∞„ÇíÂèñÂæó + ÊåáÂÆö„Éö„Éº„Ç∏„ÅÆ„Éá„Éº„Çø„ÇíÂèñÂæó
                currentJobPage = page;
                currentJobFilters = filters;

                const from = (page - 1) * ITEMS_PER_PAGE;
                const to = from + ITEMS_PER_PAGE - 1;

                console.log('Fetching jobs with pagination:', { from, to, page });

                // „ÇØ„Ç®„É™„ÇíÂÜçÊßãÁØâ„Åó„Å¶companies„Å®„ÅÆjoin„ÇíËøΩÂä†
                // range()„Å®countÂèñÂæó„ÇíÂêåÊôÇ„Å´Ë°å„ÅÜ
                const { data: jobsResult, error, count } = await query
                    .range(from, to);

                const jobs = jobsResult || [];
                console.log('Query result:', { jobs: jobs.length, error, count });

                // AIÊ§úÁ¥¢„Éú„ÉÉ„ÇØ„Çπ„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
                updateAISearchState('job', count);

                // --- AI Ranking Logic (Jobs) ---
                const isAiBoxDisabled = $('#job-ai-search-box').hasClass('disabled');
                console.log('AI Prompt Trigger Check (Jobs):', { isInitialLoad, isAiBoxDisabled, prompt: filters.aiPrompt, resultCount: count });

                if (!isInitialLoad && !isAiBoxDisabled && filters.aiPrompt && filters.aiPrompt.trim().length > 0) {
                    $('#job-ai-search-box').addClass('searching');
                    // showLoading('AI„ÅåÊåáÁ§∫ÂÜÖÂÆπ„Å´Âü∫„Å•„ÅçÊ±Ç‰∫∫„ÇíÁ≤æÊüª‰∏≠...'); // „É≠„Éº„Ç´„É´„Å´Âàá„ÇäÊõø„Åà„Çã„Åü„ÇÅÁÑ°ÂäπÂåñÔºàÂøÖË¶Å„Å™„ÇâÊÆã„Åó„Å¶„ÇÇ„Çà„ÅÑ„Åå„ÄÅ‰ªäÂõû„ÅØË¶ÅÊúõÈÄö„Çä„É≠„Éº„Ç´„É´„Å∏Ôºâ
                    try {
                        if (jobs && jobs.length > 0) {
                            const { data: aiRanked, error: aiError } = await supabase.functions.invoke('score-ai-recommendations', {
                                body: {
                                    type: 'job',
                                    customInstruction: filters.aiPrompt,
                                    jobs: jobs
                                }
                            });

                            console.log('AI Ranking Results (Jobs):', aiRanked);
                            if (!aiError && aiRanked) {
                                // AI„ÅÆ„Çπ„Ç≥„Ç¢„Çí jobs „Å´„Éû„ÉÉ„Éî„É≥„Ç∞
                                jobs.forEach(job => {
                                    const rank = aiRanked.find(r => r.job_id === job.id || r.id === job.id);
                                    if (rank) {
                                        job.ai_score = rank.score;
                                        job.ai_reason = rank.reason;
                                    }
                                });
                                // AI„Çπ„Ç≥„Ç¢È†Ü„Å´„ÇΩ„Éº„Éà
                                jobs.sort((a, b) => (b.ai_score || 0) - (a.ai_score || 0));
                            } else if (aiError) {
                                console.error('AI Ranking Edge Function error (Jobs):', aiError);
                                alert('AI„Å´„Çà„ÇãÁ≤æÊüª„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
                            }
                        }
                    } catch (err) {
                        console.error('AI Ranking error (Jobs):', err);
                        alert('AI„Å∏„ÅÆ„É™„ÇØ„Ç®„Çπ„Éà‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
                    } finally {
                        $('#job-ai-search-box').removeClass('searching');
                    }
                    // hideLoading();
                }

                // Á∑è„Éö„Éº„Ç∏Êï∞„ÇíË®àÁÆó
                totalJobPages = count ? Math.ceil(count / ITEMS_PER_PAGE) : 1;

                console.log(`Loaded page ${page}/${totalJobPages}, showing ${jobs?.length || 0} jobs (total: ${count})`);

                await renderJobs(jobs, count)
                renderJobPagination();
            } catch (error) {
                console.error('Load jobs error:', error)
                $('#jobs-container').html('<p class="text-red-500">Ê±Ç‰∫∫„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>')
            } finally {
                hideLoading()
            }
        }

        // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥UI„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        function renderJobPagination() {
            console.log('renderJobPagination called:', { currentJobPage, totalJobPages });

            const container = $('#job-pagination-container');
            if (!container.length) {
                console.log('Creating pagination container');
                // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥„Ç≥„É≥„ÉÜ„Éä„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ‰ΩúÊàê
                $('#jobs-container').after('<div id="job-pagination-container" class="mt-6"></div>');
            }

            if (totalJobPages <= 1) {
                console.log('Only 1 page, hiding pagination');
                $('#job-pagination-container').html('');
                return;
            }

            console.log('Rendering pagination UI');
            const maxButtons = 5; // Ë°®Á§∫„Åô„Çã„Éö„Éº„Ç∏„Éú„Çø„É≥„ÅÆÊúÄÂ§ßÊï∞
            let startPage = Math.max(1, currentJobPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalJobPages, startPage + maxButtons - 1);

            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            let html = '<div class="flex justify-center items-center gap-2">';

            // Ââç„Å∏„Éú„Çø„É≥
            if (currentJobPage > 1) {
                html += `<button onclick="goToJobPage(${currentJobPage - 1})" 
                    class="px-4 py-2 border rounded-lg hover:bg-gray-50 transition">
                    <i class="fas fa-chevron-left"></i> Ââç„Å∏
                </button>`;
            }

            // „Éö„Éº„Ç∏Áï™Âè∑„Éú„Çø„É≥
            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === currentJobPage;
                html += `<button onclick="goToJobPage(${i})" 
                    class="px-4 py-2 border rounded-lg transition ${isActive ? 'bg-indigo-600 text-white' : 'hover:bg-gray-50'}">
                    ${i}
                </button>`;
            }

            // Ê¨°„Å∏„Éú„Çø„É≥
            if (currentJobPage < totalJobPages) {
                html += `<button onclick="goToJobPage(${currentJobPage + 1})" 
                    class="px-4 py-2 border rounded-lg hover:bg-gray-50 transition">
                    Ê¨°„Å∏ <i class="fas fa-chevron-right"></i>
                </button>`;
            }

            html += '</div>';
            html += `<div class="text-center mt-2 text-sm text-gray-600">
                „Éö„Éº„Ç∏ ${currentJobPage} / ${totalJobPages}
            </div>`;

            console.log('Setting pagination HTML');
            $('#job-pagination-container').html(html);
        }

        // Ê±Ç‰∫∫Ê§úÁ¥¢„ÅÆ„Éö„Éº„Ç∏ÁßªÂãï
        window.goToJobPage = function (page) {
            loadJobs(currentJobFilters, page);
        }



        // Ê§úÁ¥¢Êù°‰ª∂„ÅÆ‰øùÂ≠ò„ÉªË™≠„ÅøËæº„Åø
        // Ê§úÁ¥¢Êù°‰ª∂„ÅÆ‰øùÂ≠ò„ÉªË™≠„ÅøËæº„Åø
        window.saveSearchFilters = function (filters) {
            if (!currentUser) {
                console.warn('Cannot save search filters: currentUser is null');
                return;
            }
            const key = `job_search_filters_${currentUser.id} `;
            localStorage.setItem(key, JSON.stringify(filters));
            console.log('Search filters saved:', filters);
        }

        window.loadSearchFilters = function () {
            if (!currentUser) {
                console.warn('Cannot load search filters: currentUser is null');
                return null;
            }
            const key = `job_search_filters_${currentUser.id} `;
            const saved = localStorage.getItem(key);
            console.log('Search filters loaded:', saved ? JSON.parse(saved) : 'none');
            return saved ? JSON.parse(saved) : null;
        }

        window.applySearchFilters = function applySearchFilters(filters) {
            if (!filters) return;

            console.log('Applying search filters:', filters);

            // „Ç≠„Éº„ÉØ„Éº„Éâ„Å®„Çø„Ç∞„ÅÆÂêåÊúü
            if (filters.keyword) {
                $('#search-keyword').val(filters.keyword);
                if (window.populateFreewordTags) {
                    window.populateFreewordTags(filters.keyword, 'tags-keyword', 'tag-indigo');
                    $('#search-keyword').val(''); // „Çø„Ç∞Âåñ„Åó„ÅüÂæå„ÅØÂÖ•Âäõ„Çí„ÇØ„É™„Ç¢
                }
            } else {
                $('#search-keyword').val('');
                if (window.populateFreewordTags) $('#tags-keyword').empty();
            }

            if (filters.keywordMode) {
                $(`input[name="search-keyword-mode"][value="${filters.keywordMode.toUpperCase()}"]`).prop('checked', true);
            }

            // „Ç®„É™„Ç¢Ë©≥Á¥∞„Å®„Çø„Ç∞„ÅÆÂêåÊúü
            if (filters.location) {
                $('#search-location').val(filters.location);
                if (window.populateFreewordTags) {
                    window.populateFreewordTags(filters.location, 'tags-freeword', 'tag-amber');
                    $('#search-location').val(''); // „Çø„Ç∞Âåñ„Åó„ÅüÂæå„ÅØÂÖ•Âäõ„Çí„ÇØ„É™„Ç¢
                }
            } else {
                $('#search-location').val('');
                if (window.populateFreewordTags) $('#tags-freeword').empty();
            }

            $('#search-prefecture').val(filters.prefecture || []).trigger('change');
            $('#search-employment-type').val(filters.employmentType || []).trigger('change');
            $('#search-job-category').val(filters.jobCategory || []).trigger('change');
            $('#search-industry-category').val(filters.industryCategory || []).trigger('change');
            $('#search-salary-min').val(filters.salaryMin || '');
            $('#search-salary-slider').val(filters.salaryMin || 0).trigger('input');
            $('#search-job-experience-ok').prop('checked', !!filters.jobExperienceOk);
            $('#search-industry-experience-ok').prop('checked', !!filters.industryExperienceOk);
            $('#search-is-remote').prop('checked', !!filters.isRemote);
            $('#search-exclude-matched').prop('checked', !!filters.excludeMatched);
            $('#search-exclude-applied').prop('checked', !!filters.excludeApplied);
            $('#search-favorites-only').prop('checked', !!filters.favoritesOnly);
        }

        window.applyPreferredConditions = async function () {
            if (!currentUser) return;

            showLoading('„Éó„É≠„Éï„Ç£„Éº„É´ÊÉÖÂ†±„ÇíÂèñÂæó‰∏≠...');
            try {
                // „Éó„É≠„Éï„Ç£„Éº„É´„Éá„Éº„Çø„ÅÆÂèñÂæó
                const { data: profile, error } = await supabase
                    .from('candidate_profiles')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                if (error) throw error;

                if (!profile) {
                    alert('„Éó„É≠„Éï„Ç£„Éº„É´ÊÉÖÂ†±„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Éó„É≠„Éï„Ç£„Éº„É´ÁîªÈù¢„Åã„ÇâÂ∏åÊúõÊù°‰ª∂„ÇíÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }

                // ÁèæÂú®„ÅÆ„Éï„Ç£„É´„ÇøÁä∂ÊÖã„ÇíÁ∂≠ÊåÅ„Åô„Çã„Åü„ÇÅ„ÄÅÊó¢Â≠ò„ÅÆÊù°‰ª∂„ÇíÂèñÂæó
                const currentFilters = {
                    excludeMatched: $('#search-exclude-matched').is(':checked'),
                    excludeApplied: $('#search-exclude-applied').is(':checked'),
                    favoritesOnly: $('#search-favorites-only').is(':checked'),
                    isRemote: $('#search-is-remote').is(':checked'),
                    jobExperienceOk: $('#search-job-experience-ok').is(':checked'),
                    industryExperienceOk: $('#search-industry-experience-ok').is(':checked')
                };

                // „Éó„É≠„Éï„Ç£„Éº„É´ÊÉÖÂ†±„ÇíÊ§úÁ¥¢„Éï„Ç£„É´„ÇøÂΩ¢Âºè„Å´Â§âÊèõ
                const preferredFilters = {
                    keyword: profile.desired_freewords || '',
                    keywordMode: (profile.desired_freewords_condition || 'or').toUpperCase(),
                    jobCategory: profile.desired_job_type ? profile.desired_job_type.split(',') : [],
                    industryCategory: profile.desired_industry ? profile.desired_industry.split(',') : [],
                    employmentType: profile.desired_employment_type ? profile.desired_employment_type.split(',') : [],
                    prefecture: (function () {
                        if (!profile.desired_location) return [];
                        // „Ç≥„É≥„ÉûÂå∫Âàá„Çä„ÅÆÈÉΩÈÅìÂ∫úÁúå„Çí„Éë„Éº„ÇπÔºàÂ∏ÇÁî∫Êùë„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÈô§Â§ñ„Åô„Çã„Ç∑„É≥„Éó„É´Âá¶ÁêÜÔºâ
                        const locations = profile.desired_location.split(',');
                        // prefectures„Éû„Çπ„Çø„Å´Âê´„Åæ„Çå„Çã„ÇÇ„ÅÆ„Å†„Åë„ÇíÊäΩÂá∫
                        return locations.map(l => l.trim()).filter(l => prefectures.includes(l));
                    })(),
                    location: (function () {
                        if (!profile.desired_location) return '';
                        const locations = profile.desired_location.split(',');
                        // prefectures„Éû„Çπ„Çø„Å´Âê´„Åæ„Çå„Å™„ÅÑ„ÇÇ„ÅÆ„Çí„Ç®„É™„Ç¢Ë©≥Á¥∞„Å®„Åó„Å¶ÊäΩÂá∫
                        return locations.map(l => l.trim()).filter(l => !prefectures.includes(l)).join(', ');
                    })(),
                    salaryMin: profile.desired_salary ? Math.floor(profile.desired_salary / 10000) : 0,
                    // Á∂≠ÊåÅ„Åô„ÇãÈ†ÖÁõÆ
                    ...currentFilters
                };

                console.log('Applying preferred filters:', preferredFilters);

                // „Éï„Ç£„É´„Çø„ÇíÈÅ©Áî®
                applySearchFilters(preferredFilters);

                // Ê§úÁ¥¢ÂÆüË°å
                await searchJobsImmediate();

                // ÊàêÂäüÈÄöÁü•Ôºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
                const toast = $('<div class="fixed top-10 right-10 bg-green-600 text-white px-6 py-3 rounded-xl shadow-2xl z-[9999] animate-bounce">Â∏åÊúõÊù°‰ª∂„ÇíÈÅ©Áî®„Åó„Åæ„Åó„Åü</div>');
                $('body').append(toast);
                setTimeout(() => toast.fadeOut(() => toast.remove()), 3000);

            } catch (err) {
                console.error('Apply preferred conditions error:', err);
                alert('Â∏åÊúõÊù°‰ª∂„ÅÆÈÅ©Áî®„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            } finally {
                hideLoading();
            }
        };

        function animateJobCount(targetCount) {
            const display = $('#job-count-display-premium');
            const numberElement = display.find('#job-count-number');
            if (targetCount === null || targetCount === undefined) {
                display.addClass('hidden');
                return;
            }
            display.removeClass('hidden');
            const duration = 1200;
            const startTime = Date.now();
            const startValue = 0;
            function updateCount() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeProgress = 1 - Math.pow(1 - progress, 4);
                const currentValue = Math.floor(startValue + (targetCount - startValue) * easeProgress);
                numberElement.text(currentValue.toLocaleString());
                if (progress < 1) requestAnimationFrame(updateCount);
                else numberElement.text(targetCount.toLocaleString());
            }
            requestAnimationFrame(updateCount);
        }

        function animateCandidateCount(targetCount) {
            const display = $('#candidate-count-display-premium');
            const numberElement = display.find('#candidate-count-number');

            if (targetCount === null || targetCount === undefined) {
                display.addClass('hidden');
                return;
            }

            display.removeClass('hidden');

            const duration = 1200;
            const startTime = Date.now();
            const startValue = 0;

            function updateCount() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeProgress = 1 - Math.pow(1 - progress, 4);
                const currentValue = Math.floor(startValue + (targetCount - startValue) * easeProgress);

                numberElement.text(currentValue.toLocaleString());

                if (progress < 1) {
                    requestAnimationFrame(updateCount);
                } else {
                    numberElement.text(targetCount.toLocaleString());
                }
            }

            requestAnimationFrame(updateCount);
        }

        // --- Premium Search UI Support ---
        function setupPremiumSearchUI() {

            // Salary slider sync
            $('#search-salary-slider').on('input', function () {
                const val = $(this).val();
                $('#search-salary-min').val(val);
                $('#salary-display').text(val === '0' ? 'ÊåáÂÆö„Å™„Åó' : val + ' ‰∏áÂÜÜ‰ª•‰∏ä');
            });

            $('#c-search-salary-slider').on('input', function () {
                const val = $(this).val();
                $('#c-search-salary-min').val(val);
                $('#c-salary-display').text(val === '0' ? 'ÊåáÂÆö„Å™„Åó' : val + ' ‰∏áÂÜÜ‰ª•‰∏ä');
            });

            // Tag sync for Select2
            function syncTags(selectId, containerId, colorClass) {
                const $select = $('#' + selectId);
                const $container = $('#' + containerId);
                if (!$select.length || !$container.length) return;

                $select.off('change.syncTags').on('change.syncTags', function () {
                    // Select2„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
                    if (!$select.hasClass('select2-hidden-accessible')) return;

                    $container.empty();
                    const selected = $select.select2('data') || [];
                    selected.forEach(item => {
                        const $tag = $(`
                            <span class="premium-tag ${colorClass}">
                                ${item.text}
                                <i class="fas fa-times tag-remove ml-2 opacity-50 hover:opacity-100" data-id="${item.id}"></i>
                            </span>
                        `);
                        $tag.find('.tag-remove').on('click', function (e) {
                            e.stopPropagation();
                            const id = $(this).data('id');
                            const values = $select.val() || [];
                            const newValues = values.filter(v => v !== id.toString());
                            $select.val(newValues).trigger('change');
                        });
                        $container.append($tag);
                    });
                });
            }

            // Jobs
            syncTags('search-industry-category', 'tags-industry', 'tag-blue');
            syncTags('search-job-category', 'tags-job', 'tag-blue');
            syncTags('search-employment-type', 'tags-employment', 'tag-blue');
            syncTags('search-prefecture', 'tags-prefecture', 'tag-blue');

            // Candidates
            syncTags('c-search-industry-category', 'c-tags-industry', 'tag-blue');
            syncTags('c-search-job-category', 'c-tags-job', 'tag-blue');
            syncTags('c-search-employment-type', 'c-tags-employment', 'tag-blue');
            syncTags('c-search-prefecture', 'c-tags-prefecture', 'tag-blue');

            // Freelance Keyword Tagging
            function setupFreeword(inputId, containerId, syncFunc, colorClass = 'tag-amber') {
                const $input = $('#' + inputId);
                const $container = $('#' + containerId);
                if (!$input.length) return;

                $input.off('keypress').on('keypress', function (e) {
                    if (e.which === 13) {
                        e.preventDefault();
                        const val = $(this).val().trim();
                        if (val) {
                            addFreewordTag(val, $container, syncFunc, colorClass);
                            $(this).val('');
                        }
                    }
                });
            }

            function addFreewordTag(val, $container, syncFunc, colorClass) {
                // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
                let exists = false;
                $container.find('.premium-tag').each(function () {
                    if ($(this).text().trim() === val) exists = true;
                });
                if (exists) return;

                const $tag = $(`
                    <span class="premium-tag ${colorClass}">
                        ${val}
                        <i class="fas fa-times tag-remove ml-2 opacity-50 hover:opacity-100"></i>
                    </span>
                `);
                $tag.find('.tag-remove').on('click', function () {
                    $tag.remove();
                    if (syncFunc) syncFunc();
                    else if (typeof executeSearch === 'function') executeSearch();
                });
                $container.append($tag);
                if (syncFunc) syncFunc();
            }

            // „Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨Èñã
            window.addKeywordTag = function (val) {
                addFreewordTag(val, $('#tags-keyword'), null, 'tag-indigo');
            };

            window.populateFreewordTags = function (text, containerId, colorClass = 'tag-indigo') {
                const $container = $('#' + containerId);
                $container.empty();
                if (!text) return;
                const words = text.split(/[,„ÄÅ\s]+/).map(s => s.trim()).filter(s => s.length > 0);
                words.forEach(word => {
                    addFreewordTag(word, $container, null, colorClass);
                });
            };

            window.getFreewordTagsText = function (containerId) {
                const tags = [];
                $('#' + containerId + ' .premium-tag').each(function () {
                    // Remove the 'X' button text if present
                    const text = $(this).contents().filter(function () {
                        return this.nodeType === 3;
                    }).text().trim();
                    if (text) tags.push(text);
                });
                return tags.join(', ');
            };

            // Search Keyword tagging
            setupFreeword('search-keyword', 'tags-keyword', null, 'tag-indigo');
            setupFreeword('c-search-keyword', 'c-tags-keyword', null, 'tag-indigo');

            // Location tagging
            setupFreeword('search-location', 'tags-freeword', null, 'tag-amber');
            setupFreeword('c-search-location', 'c-tags-location', null, 'tag-amber');

            // Profile tagging
            setupFreeword('profile-freewords', 'profile-freewords-tags', null, 'tag-indigo');
            setupFreeword('admin-user-freewords', 'admin-user-freewords-tags', null, 'tag-indigo');
        }

        // „Éá„Éê„Ç¶„É≥„ÇπÈñ¢Êï∞
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        const executeSearch = async function () {
            console.log('executeSearch called. Sort:', $('#search-sort').val());

            // „Ç≠„Éº„ÉØ„Éº„Éâ„Çø„Ç∞
            const kTags = [];
            $('#tags-keyword .premium-tag').each(function () {
                kTags.push($(this).text().trim().toLowerCase());
            });
            let keyword = $('#search-keyword').val().toLowerCase().trim();
            if (kTags.length > 0) {
                keyword = (keyword + ' ' + kTags.join(' ')).trim();
            }

            // „Éï„É™„Éº„ÉØ„Éº„Éâ„Çø„Ç∞
            let freeword = $('#search-location').val().trim();
            const fTags = [];
            $('#tags-freeword .premium-tag').each(function () {
                fTags.push($(this).text().trim());
            });
            if (fTags.length > 0) {
                freeword = (freeword + ' ' + fTags.join(' ')).trim();
            }

            const filters = {
                keyword: keyword,
                keywordMode: $('input[name="search-keyword-mode"]:checked').val(),
                location: freeword,
                prefecture: $('#search-prefecture').val(),
                employmentType: $('#search-employment-type').val(),
                jobCategory: $('#search-job-category').val(),
                industryCategory: $('#search-industry-category').val(),
                salaryMin: $('#search-salary-min').val(),
                jobExperienceOk: $('#search-job-experience-ok').is(':checked'),
                industryExperienceOk: $('#search-industry-experience-ok').is(':checked'),
                isRemote: $('#search-is-remote').is(':checked'),
                excludeMatched: $('#search-exclude-matched').is(':checked'),
                excludeApplied: $('#search-exclude-applied').is(':checked'),
                favoritesOnly: $('#search-favorites-only').is(':checked'),
                sort: $('#search-sort').val(),
                aiPrompt: $('#search-ai-prompt').val()
            }

            // Ê§úÁ¥¢Êù°‰ª∂„Çí‰øùÂ≠ò
            saveSearchFilters(filters);

            await loadJobs(filters)
        };

        // „Éá„Éê„Ç¶„É≥„Çπ‰ªò„Åç„ÅÆÊ§úÁ¥¢ÂÆüË°åÈñ¢Êï∞
        window.searchJobs = debounce(executeSearch, 500);

        // ÊâãÂãï„ÅßÂç≥ÊôÇÂÆüË°å„Åó„Åü„ÅÑÂ†¥ÂêàÔºà„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ„Å™„Å©Ôºâ
        window.searchJobsImmediate = executeSearch;

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆÂàùÊúüÂåñ
        function initSearchEventListeners() {
            const searchInputs = [
                '#search-keyword',
                '#search-salary-min'
            ];
            const searchSelects = [
                '#search-sort'
            ];
            const searchCheckboxes = [
                'input[name="search-keyword-mode"]',
                '#search-job-experience-ok',
                '#search-industry-experience-ok',
                '#search-is-remote',
                '#search-exclude-matched',
                '#search-exclude-applied',
                '#search-favorites-only'
            ];

            // ‰ª•Ââç„ÅÆ„É™„Çπ„Éä„Éº„ÇíËß£Èô§„Åó„Å¶ÈöõË®≠ÂÆöÔºà‰∏ÄÈÉ®„ÇíËá™ÂãïÊ§úÁ¥¢ÂØæË±°„Å´Ôºâ
            // Select2„Å™„Å©„ÅÆchange„Ç§„Éô„É≥„Éà„ÅØ„Çø„Ç∞ÂêåÊúüÂÅ¥„Åß„Éà„É™„Ç¨„Éº„Åï„Çå„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çã„Åü„ÇÅÊÖéÈáç„Å´
            // „Åì„Åì„Åß„ÅØÊ§úÁ¥¢„Éú„Çø„É≥„Åß„ÅÆÂÆüË°å„ÇíÂü∫Êú¨„Å®„Åô„Çã
        }

        // „Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇ„Å´„ÇÇÂÆüË°å
        $(document).ready(function () {
            initSearchEventListeners();
            setupPremiumSearchUI();
        });

        window.clearSearch = function () {
            // „ÉÜ„Ç≠„Çπ„ÉàÂÖ•Âäõ„ÅÆ„ÇØ„É™„Ç¢
            $('#search-keyword').val('');
            $('#tags-keyword').empty();
            $('#search-location').val('');
            $('#tags-freeword').empty();
            $('#search-salary-min').val('0');
            $('#search-salary-slider').val(0);
            $('#salary-display').text('ÊåáÂÆö„Å™„Åó');
            $('#search-ai-prompt').val('');

            // „É©„Ç∏„Ç™„Éú„Çø„É≥„ÅÆ„É™„Çª„ÉÉ„Éà
            $('input[name="search-keyword-mode"][value="OR"]').prop('checked', true);

            // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆ„ÇØ„É™„Ç¢ (È†ÜÂ∫è„ÇíÂâç„Å´ÁßªÂãï)
            $('#search-job-experience-ok').prop('checked', false);
            $('#search-industry-experience-ok').prop('checked', false);
            $('#search-is-remote').prop('checked', false);
            $('#search-exclude-matched').prop('checked', false);
            $('#search-exclude-applied').prop('checked', false);
            $('#search-favorites-only').prop('checked', false);

            // „ÇΩ„Éº„Éà„ÅÆ„É™„Çª„ÉÉ„Éà
            $('#search-sort').val('created_at-desc');

            // Select2„ÅÆ„ÇØ„É™„Ç¢ („Éà„É™„Ç¨„Éº„Å´„Çà„ÇãÂÜçÊ§úÁ¥¢„ÅåËµ∞„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çã„Åü„ÇÅÊúÄÂæå„Å´)
            $('#search-prefecture').val([]).trigger('change');
            $('#search-employment-type').val([]).trigger('change');
            $('#search-job-category').val([]).trigger('change');
            $('#search-industry-category').val([]).trigger('change');

            // ‰øùÂ≠ò„Åï„Çå„Åü„Éï„Ç£„É´„Çø„Çí„ÇØ„É™„Ç¢ÔºàÁ©∫„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Åß‰∏äÊõ∏„ÅçÔºâ
            if (window.saveSearchFilters) window.saveSearchFilters({});

            // ÊúÄÂæå„Å´Ê§úÁ¥¢ÂÆüË°å
            if (typeof loadJobs === 'function') loadJobs();
        }

        /**
         * ‰∏ä‰Ωç30‰ª∂„ÇíÈÅ∏Êäû„Åô„Çã
         */
        window.selectTop30Jobs = function () {
            const checkboxes = $('.job-checkbox:not(:disabled)');
            if (checkboxes.length === 0) {
                alert('ÈÅ∏ÊäûÂèØËÉΩ„Å™Ê±Ç‰∫∫„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            let count = 0;
            checkboxes.each(function (index) {
                if (index < 30) {
                    if (!$(this).prop('checked')) {
                        $(this).trigger('click');
                        count++;
                    }
                }
            });
        }

        // ========================
        // Favorites & Saved Searches
        // ========================
        async function loadFavorites() {
            if (!currentUser) return
            try {
                const { data: favs, error } = await supabase
                    .from('favorites')
                    .select('job_id')
                    .eq('user_id', currentUser.id)

                if (error) throw error
                favoriteJobIds = new Set(favs.map(f => f.job_id))
            } catch (error) {
                console.error('Load favorites error:', error)
            }
        }

        // „ÅäÊ∞ó„Å´ÂÖ•„Çä„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        window.openFavoritesModal = async function () {
            if (!currentUser) return;

            showLoading();
            try {
                // „ÅäÊ∞ó„Å´ÂÖ•„ÇäÊ±Ç‰∫∫ID„ÇíÂèñÂæóÔºàÂøµ„ÅÆ„Åü„ÇÅÂÜçÂèñÂæóÔºâ
                await loadFavorites();

                if (favoriteJobIds.size === 0) {
                    $('#favorites-list').html('<p class="text-center text-gray-500 py-8">„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ÁôªÈå≤„Åï„Çå„ÅüÊ±Ç‰∫∫„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>');
                    $('#favorites-modal').removeClass('hidden');
                    hideLoading();
                    return;
                }

                // Ê±Ç‰∫∫ÊÉÖÂ†±„ÇíÂèñÂæó
                const { data: jobs, error } = await supabase
                    .from('jobs')
                    .select('*, companies(name)')
                    .in('id', Array.from(favoriteJobIds));

                if (error) throw error;

                renderFavoriteJobs(jobs);
                $('#favorites-modal').removeClass('hidden');

            } catch (error) {
                console.error('Open favorites error:', error);
                alert('„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            } finally {
                hideLoading();
            }
        }

        // „ÅäÊ∞ó„Å´ÂÖ•„ÇäÊ±Ç‰∫∫„ÅÆÊèèÁîª
        function renderFavoriteJobs(jobs) {
            const container = $('#favorites-list');
            container.empty();

            const html = jobs.map(job => `
            <div class="border-b border-gray-200 py-4 last:border-0">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h4 class="text-lg font-bold text-gray-900 hover:text-indigo-600 cursor-pointer"
                            onclick="showJobDetailModal('${job.id}')">${job.title}</h4>
                        <p class="text-sm text-gray-600">${job.companies?.name || job.company}</p>
                        <div class="flex items-center gap-3 mt-2 text-sm text-gray-500">
                            <span><i class="fas fa-map-marker-alt mr-1"></i>${job.location}</span>
                            <span><i class="fas fa-yen-sign mr-1"></i>${(job.salary_min / 10000).toLocaleString()}‰∏á - ${(job.salary_max / 10000).toLocaleString()}‰∏áÂÜÜ</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="showJobDetailModal('${job.id}')" class="text-indigo-600 hover:text-indigo-800 p-2 text-sm">
                            Ë©≥Á¥∞
                        </button>
                        <button onclick="toggleFavorite('${job.id}'); $(this).closest('.border-b').remove();"
                            class="text-pink-500 hover:text-pink-700 p-2" title="„ÅäÊ∞ó„Å´ÂÖ•„Çä„Åã„ÇâÂâäÈô§">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
                </div>
            `).join('');

            container.html(html);
        }

        window.closeFavoritesModal = function () {
            $('#favorites-modal').addClass('hidden');
        }

        window.toggleFavorite = async function (jobId) {
            if (!currentUser) return
            const isFav = favoriteJobIds.has(jobId)

            try {
                const updateButtons = (active) => {
                    // „É™„Çπ„ÉàÁî®„Ç¢„Ç§„Ç≥„É≥
                    const listIcon = $(`#fav-btn-${jobId} i`);
                    if (active) {
                        listIcon.removeClass('far text-gray-400').addClass('fas text-pink-500');
                    } else {
                        listIcon.removeClass('fas text-pink-500').addClass('far text-gray-400');
                    }

                    // „É¢„Éº„ÉÄ„É´Áî®„Éú„Çø„É≥
                    const modalBtn = $(`#modal-fav-btn-${jobId}`);
                    if (modalBtn.length) {
                        if (active) {
                            modalBtn.removeClass('border-gray-300 text-gray-700').addClass('border-pink-500 text-pink-600');
                            modalBtn.html('<i class="fas fa-heart mr-2"></i>„ÅäÊ∞ó„Å´ÂÖ•„ÇäÁôªÈå≤Ê∏à„Åø');
                        } else {
                            modalBtn.removeClass('border-pink-500 text-pink-600').addClass('border-gray-300 text-gray-700');
                            modalBtn.html('<i class="fas fa-heart mr-2"></i>„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†');
                        }
                    }
                };

                if (isFav) {
                    // Remove
                    const { error } = await supabase
                        .from('favorites')
                        .delete()
                        .eq('user_id', currentUser.id)
                        .eq('job_id', jobId)
                    if (error) throw error
                    favoriteJobIds.delete(jobId)
                    updateButtons(false);
                } else {
                    // Add
                    const { error } = await supabase
                        .from('favorites')
                        .insert({ user_id: currentUser.id, job_id: jobId })
                    if (error) throw error
                    favoriteJobIds.add(jobId)
                    updateButtons(true);
                }
            } catch (error) {
                console.error('Toggle favorite error:', error)
                alert('„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü')
            }
        }

        async function loadSavedSearchesList() {
            if (!currentUser) return
            try {
                const { data: searches, error } = await supabase
                    .from('saved_searches')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })

                if (error) throw error
                savedSearches = searches

                const select = $('#saved-searches-select')
                select.empty()
                select.append('<option value="">‰øùÂ≠ò„Åó„ÅüÊ§úÁ¥¢Êù°‰ª∂</option>')

                if (searches.length > 0) {
                    select.removeClass('hidden')
                    searches.forEach(s => {
                        select.append(`<option value="${s.id}">${s.name}</option>`)
                    })
                } else {
                    select.addClass('hidden')
                }
            } catch (error) {
                console.error('Load saved searches error:', error)
            }
        }

        window.saveSearchConditions = async function () {
            if (!currentUser) return
            const name = prompt('Ê§úÁ¥¢Êù°‰ª∂„ÅÆÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:')
            if (!name) return

            const criteria = {
                keyword: $('#search-keyword').val().trim(),
                keywordMode: $('input[name="search-keyword-mode"]:checked').val(),
                location: $('#search-location').val().trim(),
                prefecture: $('#search-prefecture').val(),
                employmentType: $('#search-employment-type').val(),
                jobCategory: $('#search-job-category').val(),
                industryCategory: $('#search-industry-category').val(),
                salaryMin: $('#search-salary-min').val(),
                jobExperienceOk: $('#search-job-experience-ok').is(':checked'),
                industryExperienceOk: $('#search-industry-experience-ok').is(':checked'),
                isRemote: $('#search-is-remote').is(':checked'),
                excludeMatched: $('#search-exclude-matched').is(':checked'),
                favoritesOnly: $('#search-favorites-only').is(':checked')
            }

            try {
                const { error } = await supabase
                    .from('saved_searches')
                    .insert({
                        user_id: currentUser.id,
                        name: name,
                        criteria: criteria
                    })

                if (error) throw error
                alert('Ê§úÁ¥¢Êù°‰ª∂„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü')
                loadSavedSearchesList()
            } catch (error) {
                console.error('Save search error:', error)
                alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü')
            }
        }

        window.loadSavedSearch = function (searchId) {
            if (!searchId) return
            const search = savedSearches.find(s => s.id === searchId)
            if (!search) return

            const c = search.criteria
            $('#search-keyword').val(c.keyword || '')
            if (c.keywordMode) $(`input[name="search-keyword-mode"][value="${c.keywordMode}"]`).prop('checked', true)
            $('#search-location').val(c.location || '')
            $('#search-prefecture').val(c.prefecture || []).trigger('change')
            $('#search-employment-type').val(c.employmentType || []).trigger('change')
            $('#search-job-category').val(c.jobCategory || []).trigger('change')
            $('#search-industry-category').val(c.industryCategory || []).trigger('change')
            $('#search-salary-min').val(c.salaryMin || '0')
            $('#search-salary-slider').val(c.salaryMin || 0)
            $('#salary-display').text(!c.salaryMin || c.salaryMin === '0' ? 'ÊåáÂÆö„Å™„Åó' : c.salaryMin + ' ‰∏áÂÜÜ‰ª•‰∏ä')
            $('#search-job-experience-ok').prop('checked', !!c.jobExperienceOk)
            $('#search-industry-experience-ok').prop('checked', !!c.industryExperienceOk)
            $('#search-is-remote').prop('checked', !!c.isRemote)
            $('#search-exclude-matched').prop('checked', !!c.excludeMatched)
            $('#search-favorites-only').prop('checked', !!c.favoritesOnly)
            $('#search-favorites-only').prop('checked', !!c.favoritesOnly)

            // Ê§úÁ¥¢ÂÆüË°å
            searchJobs()
        }

        // AIÊé®Ëñ¶Ê∏à„ÅøÊ±Ç‰∫∫ID„ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•
        let recommendedJobIds = new Set();

        async function renderJobs(jobs, totalCount = null) {
            const container = $('#jobs-container')
            container.empty()

            if (!jobs || jobs.length === 0) {
                container.html('<p class="text-gray-500 text-center py-8">ÁèæÂú®ÂãüÈõÜ‰∏≠„ÅÆÊ±Ç‰∫∫„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>')
                animateJobCount(0); // „Ç´„Ç¶„É≥„Çø„Éº„Çí0„Å´„É™„Çª„ÉÉ„Éà
                return
            }

            // Ê±Ç‰∫∫‰ª∂Êï∞„Çí„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ë°®Á§∫
            animateJobCount(totalCount);

            // Ê§úÁ¥¢ÁµêÊûú„ÅÆ‰ª∂Êï∞Ë°®Á§∫
            if (totalCount !== null) {
                const resultInfo = `<div class="mb-4 text-sm text-gray-600">
                    Ê§úÁ¥¢ÁµêÊûú: ${totalCount}‰ª∂ (${currentJobPage}„Éö„Éº„Ç∏ÁõÆ„ÇíË°®Á§∫‰∏≠)
                </div>`;
                container.append(resultInfo);
            }

            const isAdminOrCoach = currentUser && ['org_admin', 'admin', 'coach', 'ca', 'super_admin'].includes(currentUser.role)
            const isCandidate = currentUser && currentUser.role === 'candidate'

            // ÈÅ∏Êäû‰∏≠„ÅÆ„É¶„Éº„Ç∂„ÉºID„ÇíÂèñÂæó
            const selectedUserId = selectedTargetUserId;
            console.log('renderJobs - selectedUserId:', selectedUserId);

            // AIÊé®Ëñ¶Ê∏à„ÅøÊ±Ç‰∫∫ID„ÇíÂèñÂæó
            // ÁÆ°ÁêÜËÄÖ/„Ç≥„Éº„ÉÅ/CA„ÅåÂØæË±°„É¶„Éº„Ç∂„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅ„Åæ„Åü„ÅØÊ±ÇËÅ∑ËÄÖ„ÅåËá™ÂàÜËá™Ë∫´„ÅÆÂ†¥Âêà
            const targetUserId = isAdminOrCoach ? selectedUserId : (isCandidate ? currentUser.id : null);
            console.log('renderJobs - targetUserId:', targetUserId);

            let recommendedJobsMap = new Map(); // job_id -> score „ÅÆ„Éû„ÉÉ„Éó
            let appliedJobIds = new Set();

            if (targetUserId) {
                try {
                    // AIÊé®Ëñ¶Ê∏à„ÅøÊ±Ç‰∫∫„Å®„Çπ„Ç≥„Ç¢„ÇíÂèñÂæó
                    const { data: recommendations, error: recError } = await supabase
                        .from('recommendations')
                        .select('job_id, score, match_type')
                        .eq('user_id', targetUserId);

                    console.log('renderJobs - recommendations:', recommendations, 'error:', recError);

                    if (!recError && recommendations) {
                        recommendations.forEach(r => {
                            recommendedJobsMap.set(r.job_id, { score: r.score, match_type: r.match_type });
                        });
                        recommendedJobIds = new Set(recommendations.map(r => r.job_id));
                    }

                    // ÂøúÂãüÊ∏à„ÅøÊ±Ç‰∫∫„ÇíÂèñÂæó
                    const { data: applications, error: appError } = await supabase
                        .from('applications')
                        .select('job_id')
                        .eq('user_id', targetUserId);

                    if (!appError && applications) {
                        appliedJobIds = new Set(applications.map(a => a.job_id));
                    }
                } catch (error) {
                    console.error('Failed to load recommendations/applications:', error);
                }
            }

            // „Ç≥„É≥„ÉÜ„Éä„Çí„Ç∞„É™„ÉÉ„Éâ„É¨„Ç§„Ç¢„Ç¶„Éà„Å´Â§âÊõ¥
            container.attr('class', 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6');

            const html = jobs.map(job => {
                const isSelected = selectedJobIds.has(job.id)
                const isRecommended = recommendedJobIds.has(job.id)
                const recommendation = recommendedJobsMap.get(job.id);
                const recommendationScore = recommendation ? recommendation.score : null;
                const matchType = recommendation ? recommendation.match_type : null;
                const isApplied = appliedJobIds.has(job.id)
                const showCheckbox = isAdminOrCoach || isCandidate

                // Áµ¶‰∏é„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÁî®„Éò„É´„Éë„ÉºÔºàÁ∞°ÊòìÔºâ
                const formatSalary = (val) => val ? (val / 10000).toLocaleString() + '‰∏á' : '-';

                return `
                <div class="bg-white border border-gray-200 rounded-lg p-5 shadow-sm hover:shadow-md transition flex flex-col h-full relative ${isSelected ? 'ring-2 ring-indigo-500 bg-indigo-50' : ''} ${isRecommended ? 'ring-2 ring-purple-400' : ''}">
                    
                    <div class="flex justify-between items-start mb-3">
                         <div class="flex items-center z-10">
                            ${showCheckbox ? `
                                <input type="checkbox" 
                                    class="job-checkbox w-5 h-5 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 mr-2 cursor-pointer ${isRecommended ? 'opacity-50 cursor-not-allowed' : ''}"
                                    onclick="event.stopPropagation(); toggleJobSelection('${job.id}')"
                                    ${isSelected ? 'checked' : ''}
                                    ${isRecommended ? 'disabled' : ''}>
                            ` : ''}
                         </div>
                         <div class="flex items-center gap-1.5 z-10">
                            ${isRecommended ? `
                                <span class="text-[10px] font-bold text-white bg-gradient-to-r from-purple-500 to-indigo-600 px-2 py-1 rounded-md shadow-sm flex items-center gap-1">
                                    <i class="fas ${matchType === 'auto' ? 'fa-robot' : 'fa-brain'}"></i>
                                    AI„Éû„ÉÉ„ÉÅ ${recommendationScore}%
                                </span>
                            ` : ''}
                            ${isApplied ? `
                                <span class="text-[10px] font-bold text-emerald-700 bg-emerald-100 border border-emerald-200 px-2 py-1 rounded-md flex items-center gap-1">
                                    <i class="fas fa-check-circle"></i>ÂøúÂãüÊ∏à
                                </span>
                            ` : ''}
                            <button id="fav-btn-${job.id}" onclick="event.stopPropagation(); toggleFavorite('${job.id}')" class="text-gray-400 hover:text-pink-500 transition p-1">
                                <i class="${favoriteJobIds.has(job.id) ? 'fas text-pink-500' : 'far'} fa-heart text-xl"></i>
                            </button>
                         </div>
                    </div>

                    <div class="flex-grow cursor-pointer" onclick="showJobDetailModal('${job.id}')">
                        <h3 class="font-bold text-lg text-gray-900 mb-1 leading-snug line-clamp-2 hover:text-indigo-600 transition">
                            ${job.title}
                        </h3>
                        <p class="text-[10px] font-medium text-indigo-500 mb-2 uppercase tracking-wider">${job.job_code ? `ID: ${job.job_code}` : ''}</p>
                        
                        <p class="text-xs font-medium text-gray-500 mb-3 line-clamp-1"><i class="far fa-building mr-1"></i>${job.companies?.name || job.company}</p>
                        
                        <div class="flex flex-wrap gap-2 mb-4">
                            ${job.job_category ? `<span class="px-2 py-1 text-xs bg-indigo-50 text-indigo-700 rounded border border-indigo-100">${job.job_category}</span>` : ''}
                            ${job.is_remote ? `<span class="px-2 py-1 text-xs bg-emerald-50 text-emerald-700 rounded border border-emerald-100">„É™„É¢„Éº„ÉàÂèØ</span>` : ''}
                            ${job.tags && Array.isArray(job.tags) ? job.tags.slice(0, 2).map(tag => `<span class="px-2 py-1 text-xs bg-gray-50 text-gray-600 rounded border border-gray-200">${tag}</span>`).join('') : ''}
                        </div>

                        <div class="space-y-2 text-sm text-gray-600 mb-4 border-t border-gray-100 pt-3">
                            <div class="flex items-start gap-2">
                                <i class="fas fa-map-marker-alt mt-1 text-gray-400 w-4 text-center"></i>
                                <span class="line-clamp-1">${job.location || 'Âã§ÂãôÂú∞Êú™ÂÆö'}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-yen-sign text-gray-400 w-4 text-center"></i>
                                <span>${formatSalary(job.salary_min)} - ${formatSalary(job.salary_max)}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-briefcase text-gray-400 w-4 text-center"></i>
                                <span>${job.employment_type || '-'}</span>
                            </div>
                        </div>

                        ${job.ai_score ? `
                        <div class="mb-4 bg-indigo-50 border-l-4 border-indigo-500 p-3 rounded-r">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[10px] font-bold bg-indigo-600 text-white px-1.5 py-0.5 rounded">AI SEARCH</span>
                                <span class="text-xs font-bold text-indigo-700">ÂêàËá¥Áéá: ${job.ai_score}%</span>
                            </div>
                            <p class="text-[11px] text-indigo-600 line-clamp-3 leading-relaxed">${job.ai_reason || ''}</p>
                        </div>
                        ` : ''}

                        ${job.welcome_requirements ? `
                        <div class="mb-2">
                            <span class="font-bold text-gray-700 block text-xs mb-1">„ÄêÂ∞öÂèØË¶Å‰ª∂„Äë</span>
                            <p class="text-xs text-gray-500 line-clamp-2">${job.welcome_requirements}</p>
                        </div>
                        ` : ''}
                    </div>

                    <div class="pt-4 mt-auto border-t border-gray-100 flex flex-col gap-2">
                        ${isAdminOrCoach ? `
                        <div class="flex gap-2 mb-1">
                             ${!isRecommended ? `
                            <button onclick="event.stopPropagation(); openRecommendJobModal('${job.id}')" 
                                class="flex-1 bg-amber-500 text-white py-1.5 rounded text-xs font-bold hover:bg-amber-600 transition">
                                <i class="fas fa-star mr-1"></i>Á¥π‰ªã
                            </button>
                            ` : ''}
                            ${!isApplied ? `
                            <button onclick="event.stopPropagation(); applyForJob('${job.id}', '${targetUserId || ''}')" 
                                class="flex-1 bg-indigo-600 text-white py-1.5 rounded text-xs font-bold hover:bg-indigo-700 transition">
                                <i class="fas fa-paper-plane mr-1"></i>‰ª£ÁêÜÂøúÂãü
                            </button>
                            ` : ''}
                        </div>
                        ` : ''}
                    
                        <button onclick="event.stopPropagation(); showJobDetailModal('${job.id}')" class="w-full bg-slate-700 text-white text-sm font-bold py-2.5 rounded-lg hover:bg-slate-800 transition shadow-sm hover:shadow">
                            Ë©≥Á¥∞„ÇíË¶ã„Çã
                        </button>
                    </div>
                </div>
            `}).join('')

            container.html(html)
        }

        // ========================
        // Email Notification Utility
        // ========================
        window.sendEmail = async function (type, to, data, organizationId = null) {
            try {
                const targetOrgId = organizationId || (window.currentUser ? window.currentUser.organization_id : null);
                const { data: result, error } = await supabase.functions.invoke('send-email', {
                    body: { type, to, data, organizationId: targetOrgId }
                })

                if (error) throw error
                console.log('Email sent successfully:', result)
                return true
            } catch (error) {
                console.error('Failed to send email:', error)
                // „É°„Éº„É´ÈÄÅ‰ø°Â§±Êïó„ÅØ„É¶„Éº„Ç∂„Éº‰ΩìÈ®ì„ÇíÈòªÂÆ≥„Åó„Å™„ÅÑ„Çà„ÅÜ„ÄÅ„É≠„Ç∞Âá∫Âäõ„ÅÆ„Åø„Åßfalse„ÇíËøî„Åô
                return false
            }
        }

        let currentApplyJobId = null;
        let currentApplyTargetUserId = null;

        window.applyForJob = async function (jobId, targetUserId = null) {
            currentApplyJobId = jobId;
            currentApplyTargetUserId = targetUserId;
            const isProxy = !!targetUserId;
            const applicantId = targetUserId || currentUser.id;

            showLoading();
            try {
                // Ê±Ç‰∫∫ÊÉÖÂ†±„ÇíÂèñÂæó
                const { data: job, error: jobError } = await supabase
                    .from('jobs')
                    .select('title, company')
                    .eq('id', jobId)
                    .single();
                if (jobError) throw jobError;

                // „É¢„Éº„ÉÄ„É´„ÅÆÂÜÖÂÆπ„Çí„Çª„ÉÉ„Éà
                $('#apply-job-title').text(job.title);
                $('#apply-company-name').text(job.company);

                if (isProxy) {
                    const { data: user, error: userError } = await supabase
                        .from('users')
                        .select('name')
                        .eq('id', applicantId)
                        .single();
                    if (!userError && user) {
                        $('#apply-proxy-user-name').text(user.name);
                        $('#apply-proxy-info').removeClass('hidden');
                    }
                } else {
                    $('#apply-proxy-info').addClass('hidden');
                }

                // „Éï„Ç©„Éº„É†„Çí„É™„Çª„ÉÉ„Éà
                $('input[name="apply-will-level"][value="A"]').prop('checked', true);
                $('#apply-interview-date-1').val('');
                $('#apply-interview-date-2').val('');
                $('#apply-interview-date-3').val('');
                $('#apply-notes').val('');

                hideLoading();
                $('#job-application-modal').removeClass('hidden');
            } catch (error) {
                console.error('Failed to open apply modal:', error);
                hideLoading();
                alert('ÂøúÂãü„Éï„Ç©„Éº„É†„ÅÆÂ±ïÈñã„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        };

        window.closeApplyJobModal = function () {
            $('#job-application-modal').addClass('hidden');
        };

        window.submitJobApplication = async function () {
            if (!currentApplyJobId) return;

            const jobId = currentApplyJobId;
            const targetUserId = currentApplyTargetUserId;
            const isProxy = !!targetUserId;
            const applicantId = targetUserId || currentUser.id;

            const willLevel = $('input[name="apply-will-level"]:checked').val();
            const dates = [
                $('#apply-interview-date-1').val().trim(),
                $('#apply-interview-date-2').val().trim(),
                $('#apply-interview-date-3').val().trim()
            ].filter(d => d).join('\n');
            const notes = $('#apply-notes').val().trim();

            if (!confirm('„Åì„ÅÆÂÜÖÂÆπ„ÅßÂøúÂãü„ÇíÁ¢∫ÂÆö„Åó„Åæ„Åô„ÅãÔºü')) return;

            showLoading();
            try {
                // ÂøúÂãüËÄÖÊÉÖÂ†±„ÇíÂèñÂæó
                let applicant = currentUser;
                if (isProxy) {
                    const { data: user, error } = await supabase
                        .from('users')
                        .select('*')
                        .eq('id', applicantId)
                        .single();
                    if (error) throw error;
                    applicant = user;
                }

                const { data: application, error } = await supabase
                    .from('applications')
                    .insert({
                        organization_id: currentUser.organization_id,
                        user_id: applicantId,
                        job_id: jobId,
                        status: 'ÂøúÂãüÂÆå‰∫Ü',
                        will_level: willLevel,
                        interview_dates: dates,
                        notes: notes
                    })
                    .select('*, jobs(title, company)')
                    .single();

                if (error) throw error;

                // „É≠„Ç∞Ë®òÈå≤
                await auditLog.applicationSubmitted(application.id, {
                    job_id: jobId,
                    applicant_id: applicantId,
                    is_proxy: isProxy,
                    will_level: willLevel
                });

                // ÈÄöÁü•‰ΩúÊàêÂá¶ÁêÜ
                try {
                    const { data: admins } = await supabase
                        .from('users')
                        .select('id')
                        .eq('organization_id', currentUser.organization_id)
                        .in('role', ['org_admin', 'admin']);

                    let coachId = applicant.coach_id;
                    const notifyUserIds = new Set(admins?.map(a => a.id) || []);
                    if (coachId) notifyUserIds.add(coachId);

                    const jobTitle = application.jobs.title;
                    const companyName = application.jobs.company;

                    const message = isProxy
                        ? `${currentUser.name} „Åï„Çì„Åå ${applicant.name} „Åï„Çì„ÅÆ‰ª£ÁêÜ„Åß„Äå${companyName} / ${jobTitle}„Äç„Å´ÂøúÂãü„Åó„Åæ„Åó„Åü„ÄÇ(ÂøóÊúõÂ∫¶: ${willLevel})`
                        : `${applicant.name} „Åï„Çì„Åå„Äå${companyName} / ${jobTitle}„Äç„Å´ÂøúÂãü„Åó„Åæ„Åó„Åü„ÄÇ(ÂøóÊúõÂ∫¶: ${willLevel})`;

                    const notifications = Array.from(notifyUserIds).map(uid => ({
                        user_id: uid,
                        title: 'Êñ∞Ë¶èÂøúÂãü„Åå„ÅÇ„Çä„Åæ„Åó„Åü',
                        message: message,
                        read: false,
                        metadata: {
                            page: 'admin-applicants',
                            application_id: application.id,
                            user_id: applicantId
                        },
                        created_at: new Date().toISOString()
                    }));

                    if (notifications.length > 0) {
                        await supabase.from('notifications').insert(notifications);
                    }

                    // „É°„Éº„É´ÈÄÅ‰ø°
                    await sendEmail('application_submitted', applicant.email, {
                        userName: applicant.name,
                        jobTitle: jobTitle,
                        companyName: companyName,
                        willLevel: willLevel,
                        interviewDates: dates,
                        notes: notes
                    });
                } catch (notifyErr) {
                    console.error('Notification failed:', notifyErr);
                }

                hideLoading();
                closeApplyJobModal();
                alert('ÂøúÂãü„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ');

                if (typeof appliedJobIds !== 'undefined') {
                    appliedJobIds.add(jobId);
                }
                if ($('#jobs-content').hasClass('active')) {
                    loadJobs();
                }
            } catch (error) {
                console.error('Application submission error:', error);
                hideLoading();
                alert('ÂøúÂãü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (error.message || '‰∏çÊòé„Å™„Ç®„É©„Éº'));
            }
        };



        // ========================
        // Applications History
        // ========================
        // Applications History
        // ========================
        let applicationsCache = [];
        let currentCandidateStatusFilter = 'all';

        window.setCandidateApplicationStatusFilter = function (status) {
            currentCandidateStatusFilter = status;

            // UIÊõ¥Êñ∞
            $('.candidate-status-filter').removeClass('active bg-indigo-600 text-white border-indigo-600').addClass('bg-white text-gray-600 border-gray-200 hover:bg-gray-50');
            $(`.candidate-status-filter[data-status="${status}"]`).addClass('active bg-indigo-600 text-white border-indigo-600').removeClass('bg-white text-gray-600 border-gray-200 hover:bg-gray-50');

            filterCandidateApplications();
        };

        window.filterCandidateApplications = function () {
            const searchText = $('#application-search-input').val().toLowerCase();

            let filtered = applicationsCache;

            // „Çπ„ÉÜ„Éº„Çø„Çπ„Éï„Ç£„É´„Çø„Éº
            if (currentCandidateStatusFilter !== 'all') {
                const group = window.statusGroups ? window.statusGroups[currentCandidateStatusFilter] : null;
                if (group) {
                    filtered = filtered.filter(app => group.values.includes(app.status));
                } else {
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                    filtered = filtered.filter(app => {
                        if (currentCandidateStatusFilter === 'applied') {
                            return app.status === 'ÂøúÂãüÂÆå‰∫Ü' || !app.status;
                        } else if (currentCandidateStatusFilter === 'screening_docs') {
                            return ['Êõ∏È°ûÈÅ∏ËÄÉ‰∏≠', 'Êõ∏È°ûÈÅ∏ËÄÉÈÄöÈÅé', 'pending', 'screening'].includes(app.status);
                        } else if (currentCandidateStatusFilter === 'screening_interviews') {
                            return ['‰∏ÄÊ¨°Èù¢Êé•‰∫àÂÆö', '‰∏ÄÊ¨°Èù¢Êé•ÂÆå‰∫Ü', '‰∫åÊ¨°Èù¢Êé•‰∫àÂÆö', '‰∫åÊ¨°Èù¢Êé•ÂÆå‰∫Ü', 'ÊúÄÁµÇÈù¢Êé•‰∫àÂÆö', 'ÊúÄÁµÇÈù¢Êé•ÂÆå‰∫Ü', 'interview'].includes(app.status);
                        } else if (currentCandidateStatusFilter === 'offered') {
                            return app.status === 'offered' || app.status === 'ÂÜÖÂÆö' || app.status === 'ÂÜÖÂÆöÊâøË´æ';
                        } else if (currentCandidateStatusFilter === 'closed') {
                            return ['rejected', 'withdrawn'].includes(app.status) || (app.status && app.status.startsWith('ÈÅ∏ËÄÉÁµÇ‰∫Ü'));
                        }
                        return true;
                    });
                }
            }

            // „Ç≠„Éº„ÉØ„Éº„ÉâÊ§úÁ¥¢
            if (searchText) {
                filtered = filtered.filter(app =>
                    (app.jobs && app.jobs.title && app.jobs.title.toLowerCase().includes(searchText)) ||
                    (app.jobs && app.jobs.company && app.jobs.company.toLowerCase().includes(searchText)) ||
                    (app.users && app.users.name && app.users.name.toLowerCase().includes(searchText))
                );
            }

            renderApplications(filtered);
        };

        async function loadApplications() {
            if (!currentUser) return

            showLoading()
            try {
                // „Çπ„ÉÜ„Éº„Çø„Çπ„Éû„Çπ„Çø„ÇíÂÖà„Å´Ë™≠„ÅøËæº„Çì„Åß„Éï„Ç£„É´„Çø„Éº„ÇíÊßãÁØâ
                await loadApplicationStatuses();

                let query = supabase
                    .from('applications')
                    .select('*, jobs(*), users!user_id(name), recommendation_text, resume_document_url, recommendation_letter_url')
                    .order('updated_at', { ascending: false })

                if (currentUser.role === 'super_admin' || currentUser.role === 'org_admin' || currentUser.role === 'admin') {
                    // ÁÆ°ÁêÜËÄÖ: ÁµÑÁπîÂÜÖ„ÅÆÂÖ®ÂøúÂãü
                    query = query.eq('organization_id', currentUser.organization_id)
                } else if (currentUser.role === 'coach') {
                    // „Ç≥„Éº„ÉÅ: ÊãÖÂΩì„É¶„Éº„Ç∂„Éº„ÅÆÂøúÂãü
                    // „Åæ„ÅöÊãÖÂΩì„É¶„Éº„Ç∂„ÉºID„ÇíÂèñÂæó
                    const { data: assignedUsers } = await supabase
                        .from('users')
                        .select('id')
                        .eq('coach_id', currentUser.id)

                    const assignedUserIds = assignedUsers?.map(u => u.id) || []

                    if (assignedUserIds.length > 0) {
                        query = query.in('user_id', assignedUserIds)
                    } else {
                        // ÊãÖÂΩì„É¶„Éº„Ç∂„Éº„Åå„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ‰Ωï„ÇÇË°®Á§∫„Åó„Å™„ÅÑ
                        renderApplications([])
                        hideLoading()
                        return
                    }
                } else {
                    // ‰∏ÄËà¨„É¶„Éº„Ç∂„Éº: Ëá™Ë∫´„ÅÆÂøúÂãü
                    query = query.eq('user_id', currentUser.id)
                }

                const { data: applications, error } = await query
                if (error) throw error

                applicationsCache = applications || [];
                filterCandidateApplications();
            } catch (error) {
                console.error('Load applications error:', error)
                console.error('Error details:', JSON.stringify(error, null, 2))
                $('#applications-container').html(`<p class="text-red-500">ÂøúÂãüÂ±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message || JSON.stringify(error)}</p>`)
            } finally {
                hideLoading()
            }
        }

        function renderApplications(applications) {
            const container = $('#applications-container')
            container.empty()

            if (applications.length === 0) {
                container.html('<p class="text-gray-500 text-center py-8">„Åæ„Å†ÂøúÂãü„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì</p>')
                return
            }

            // „Éá„Éï„Ç©„É´„Éà„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπË®≠ÂÆöÔºà„Éû„Çπ„Çø„Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
            let statusConfig = {
                'pending': { label: 'Êõ∏È°ûÈÅ∏ËÄÉ‰∏≠', color: 'bg-yellow-100 text-yellow-800' },
                'screening': { label: 'Êõ∏È°ûÈÅ∏ËÄÉ‰∏≠', color: 'bg-yellow-100 text-yellow-800' },
                'interview': { label: 'Èù¢Êé•‰∫àÂÆö', color: 'bg-blue-100 text-blue-800' },
                'offered': { label: 'ÂÜÖÂÆö', color: 'bg-green-100 text-green-800' },
                'rejected': { label: '‰∏çÂêàÊ†º', color: 'bg-red-100 text-red-800' },
                'withdrawn': { label: 'ËæûÈÄÄ', color: 'bg-gray-100 text-gray-800' },
                'applied': { label: 'ÂøúÂãüÂÆå‰∫Ü', color: 'bg-indigo-100 text-indigo-800' },
                'ÂøúÂãüÂÆå‰∫Ü': { label: 'ÂøúÂãüÂÆå‰∫Ü', color: 'bg-indigo-100 text-indigo-800' }
            };

            // „Éû„Çπ„Çø„Éá„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ‰∏äÊõ∏„Åç
            if (typeof applicationStatuses !== 'undefined' && applicationStatuses.length > 0) {
                applicationStatuses.forEach(s => {
                    statusConfig[s.value] = {
                        label: s.label,
                        color: s.metadata?.color || (s.value === 'ÂøúÂãüÂÆå‰∫Ü' ? 'bg-indigo-100 text-indigo-800' : 'bg-yellow-50 text-yellow-700 border border-yellow-200')
                    };
                });
            }

            const html = applications.map(app => {
                const status = statusConfig[app.status] || statusConfig['pending']
                const appliedDate = new Date(app.updated_at).toLocaleDateString('ja-JP')

                // URLÈ†ÖÁõÆ„ÅÆÂèñÂæóÂÖÉ„ÇíGoogle DriveÁî®„Ç´„É©„É†Ôºàpdf_urlÁ≠âÔºâ„Å´ÂÑ™ÂÖà
                const orgSettings = getOrgSettings();
                let driveCol = orgSettings.drive_column || 'pdf_url';
                if (driveCol === 'pdf' || driveCol === 'url') driveCol = 'pdf_url';
                const driveUrl = app.jobs?.[driveCol] || app.jobs?.url;

                return `
                    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-4 hover:shadow-md transition">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <h3 class="text-xl font-bold text-gray-900 hover:text-indigo-600 cursor-pointer transition-colors" onclick="showJobDetailModal('${app.jobs?.id || app.job_id}')">
                                        <i class="fas fa-external-link-alt text-sm mr-1 text-gray-400"></i>
                                        ${app.jobs ? app.jobs.title : '‰∏çÊòé„Å™Ê±Ç‰∫∫'}
                                    </h3>
                                </div>
                                <div class="flex flex-wrap items-center gap-x-4 gap-y-1 mb-2">
                                    <p class="text-gray-600">${app.jobs ? app.jobs.company : '-'}</p>
                                    ${app.will_level ? `
                                        <span class="text-xs font-bold px-2 py-0.5 rounded ${app.will_level === 'A' ? 'bg-red-100 text-red-700 border border-red-200' :
                            app.will_level === 'B' ? 'bg-orange-100 text-orange-700 border border-orange-200' :
                                'bg-blue-100 text-blue-700 border border-blue-200'
                        }">ÂøóÊúõÂ∫¶ ${app.will_level}</span>
                                    ` : ''}
                                    <button onclick="showJobDetailModal('${app.jobs?.id || app.job_id}')" class="text-xs text-indigo-600 hover:text-indigo-800 font-bold flex items-center gap-1 bg-indigo-50 px-2 py-0.5 rounded transition-colors">
                                        <i class="fas fa-file-alt"></i> Ê±Ç‰∫∫Ë©≥Á¥∞„ÇíÁ¢∫Ë™ç„Åô„Çã
                                    </button>
                                </div>
                                ${app.jobs?.pdf_filename ? `
                                <div class="flex items-center gap-2 mt-1 text-xs text-gray-500 bg-gray-50 px-2 py-1 rounded w-fit">
                                    <i class="fas fa-file-pdf text-red-500"></i>
                                    <span class="truncate max-w-[200px]" title="${app.jobs.pdf_filename}">${app.jobs.pdf_filename}</span>
                                </div>
                                ` : ''}
                                ${driveUrl ? `
                                <div class="flex items-center gap-2 mt-1 text-xs">
                                    <i class="fas fa-link text-indigo-400"></i>
                                    <a href="${driveUrl}" target="_blank" class="text-indigo-600 hover:underline truncate max-w-[300px]">${driveUrl}</a>
                                </div>
                                ` : ''}
                                ${app.users ? `<p class="text-sm text-indigo-600 mt-1"><i class="fas fa-user mr-1"></i>ÂøúÂãüËÄÖ: ${app.users.name}</p>` : ''}
                                
                                ${(app.interview_dates || app.notes) ? `
                                <div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-100 text-sm">
                                    ${app.interview_dates ? `
                                    <div class="mb-3">
                                        <span class="font-bold text-gray-700 block text-xs mb-1"><i class="far fa-calendar-check mr-1 text-indigo-500"></i>Èù¢Êé•Â∏åÊúõÊó•ÊôÇ:</span>
                                        <div class="text-gray-600 whitespace-pre-wrap pl-4 border-l-2 border-indigo-200 leading-relaxed text-[11px]">${app.interview_dates}</div>
                                    </div>
                                    ` : ''}
                                    ${app.notes ? `
                                    <div>
                                        <span class="font-bold text-gray-700 block text-xs mb-1"><i class="far fa-comment-alt mr-1 text-indigo-500"></i>‰ºùÈÅî‰∫ãÈ†Ö:</span>
                                        <div class="text-gray-600 whitespace-pre-wrap pl-4 border-l-2 border-indigo-200 leading-relaxed text-[11px]">${app.notes}</div>
                                    </div>
                                    ` : ''}
                                </div>
                                ` : ''}
                            </div>
                            <div class="flex flex-col items-end gap-2">
                                <span class="px-3 py-1 rounded-full text-sm font-medium ${status.color}">
                                    ${status.label}
                                </span>
                                ${['org_admin', 'admin', 'super_admin', 'coach', 'ca', 'ra'].includes(currentUser.role) ? `
                                <button onclick="openRecommendationModal('${app.id}')" class="text-sm font-medium flex items-center ${app.recommendation_text ? 'text-green-600 hover:text-green-800' : 'text-indigo-600 hover:text-indigo-800'}">
                                    <i class="fas ${app.recommendation_text ? 'fa-check-circle' : 'fa-file-alt'} mr-1"></i>
                                    ${app.recommendation_text ? 'Êé®Ëñ¶ÊñáÁ∑®ÈõÜ' : 'Êé®Ëñ¶Êñá‰ΩúÊàê'}
                                </button>
                                <button onclick="generateDocument('${app.id}', 'resume')" class="text-sm font-medium flex items-center ${app.resume_document_url ? 'text-blue-600 hover:text-blue-800' : 'text-blue-600 hover:text-blue-800'}">
                                    <i class="fas ${app.resume_document_url ? 'fa-download' : 'fa-file-word'} mr-1"></i>
                                    ${app.resume_document_url ? 'ËÅ∑ÂãôÁµåÊ≠¥Êõ∏DL' : 'ËÅ∑ÂãôÁµåÊ≠¥Êõ∏‰ΩúÊàê'}
                                </button>
                                <button onclick="generateDocument('${app.id}', 'recommendation')" class="text-sm font-medium flex items-center ${app.recommendation_letter_url ? 'text-purple-600 hover:text-purple-800' : 'text-purple-600 hover:text-purple-800'}">
                                    <i class="fas ${app.recommendation_letter_url ? 'fa-download' : 'fa-file-word'} mr-1"></i>
                                    ${app.recommendation_letter_url ? 'Êé®Ëñ¶Áä∂DL' : 'Êé®Ëñ¶Áä∂‰ΩúÊàê'}
                                </button>
                                <button onclick="openProgressModal('${app.id}')"
                                    class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition flex items-center gap-2">
                                    <i class="fas fa-tasks"></i>
                                    <span>ÈÄ≤ÊçóÁÆ°ÁêÜ</span>
                                </button>
                                ` : ''}
                            </div>
                        </div>

                        <div class="flex items-center gap-4 text-sm text-gray-600 mb-3">
                            <span><i class="fas fa-map-marker-alt mr-1"></i> ${app.jobs?.location || 'Âã§ÂãôÂú∞‰∏çÊòé'}</span>
                            <span><i class="fas fa-briefcase mr-1"></i> ${app.jobs?.employment_type || '-'}</span>
                            <span><i class="fas fa-calendar mr-1"></i> ÂøúÂãüÊó•: ${appliedDate}</span>
                        </div>

                        ${app.jobs?.salary_max ? `
                        <div class="text-sm text-gray-700 mb-3">
                            <i class="fas fa-yen-sign mr-1"></i>
                            ÊÉ≥ÂÆöÂπ¥Âèé: ${(app.jobs.salary_min / 10000).toLocaleString()}‰∏á - ${(app.jobs.salary_max / 10000).toLocaleString()}‰∏áÂÜÜ
                        </div>
                        ` : ''}

                        <p class="text-gray-600 text-sm line-clamp-2">${app.jobs?.description || 'Ê±Ç‰∫∫ÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì'}</p>

                        ${app.selection_info ? `
                        <div class="mt-4 p-4 bg-indigo-50 border border-indigo-100 rounded-lg">
                            <h4 class="text-sm font-bold text-indigo-800 mb-2 flex items-center">
                                <i class="fas fa-calendar-check mr-2"></i>ÈÅ∏ËÄÉÊÉÖÂ†±„ÉªÈÄ£Áµ°‰∫ãÈ†Ö
                            </h4>
                            <div class="text-sm text-indigo-900 whitespace-pre-wrap line-clamp-5 overflow-hidden">${app.selection_info}</div>
                        </div>
                        ` : ''}
                    </div>
                `
            }).join('')

            container.html(html)
        }

        // ========================
        // ========================
        // Progress Management
        // ========================
        let currentApplicationData = null;
        let applicationStatuses = [];

        function getSelectionStatusLabel(value) {
            if (!value) return '-';
            // „Åô„Åß„Å´Êó•Êú¨Ë™ûÔºà„É©„Éô„É´Ôºâ„ÅÆÂ†¥Âêà„ÅØ„Åù„ÅÆ„Åæ„ÅæËøî„Åô
            if (/^[^\x00-\x7F]+$/.test(value)) return value;

            // „Éû„Çπ„Çø„Åã„ÇâÊ§úÁ¥¢
            if (applicationStatuses && applicationStatuses.length > 0) {
                const status = applicationStatuses.find(s => s.value === value);
                if (status) return status.label;
            }

            // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
            const labels = {
                'pending': 'Êõ∏È°ûÈÅ∏ËÄÉ‰∏≠',
                'screening': 'Êõ∏È°ûÈÅ∏ËÄÉ‰∏≠',
                'interview': 'Èù¢Êé•‰∫àÂÆö',
                'offered': 'ÂÜÖÂÆö',
                'rejected': '‰∏çÂêàÊ†º',
                'withdrawn': 'ËæûÈÄÄ',
                'applied': 'ÂøúÂãüÂÆå‰∫Ü',
                'ÂøúÂãüÂÆå‰∫Ü': 'ÂøúÂãüÂÆå‰∫Ü'
            };
            return labels[value] || value;
        }

        window.openProgressModal = async function (applicationId) {
            showLoading();
            try {
                // ÂøúÂãüÊÉÖÂ†±„ÇíÂèñÂæó (email„ÇÇÂèñÂæó)
                const { data: application, error: appError } = await supabase
                    .from('applications')
                    .select('*, jobs(title, company), users!applications_user_id_fkey(name, email, coach_id)')
                    .eq('id', applicationId)
                    .single();

                if (appError) throw appError;

                currentApplicationData = application;
                $('#progress-application-id').val(applicationId);
                $('#progress-job-title').text(application.jobs.title);
                $('#progress-company-name').text(application.jobs.company);
                $('#progress-user-name').text(`ÂøúÂãüËÄÖ: ${application.users.name}`);
                $('#progress-current-status').data('code', application.status || 'applied').val(getSelectionStatusLabel(application.status || 'applied'));

                $('#progress-selection-info').val(application.selection_info || '');

                // Èù¢Êé•‰∫àÂÆöÊó•ÊôÇ„ÅÆ„Çª„ÉÉ„Éà
                if (application.interview_scheduled_at) {
                    const d = new Date(application.interview_scheduled_at);
                    const formattedDate = d.getFullYear() + '-' +
                        String(d.getMonth() + 1).padStart(2, '0') + '-' +
                        String(d.getDate()).padStart(2, '0') + 'T' +
                        String(d.getHours()).padStart(2, '0') + ':' +
                        String(d.getMinutes()).padStart(2, '0');
                    $('#progress-interview-scheduled-at').val(formattedDate);
                } else {
                    $('#progress-interview-scheduled-at').val('');
                }

                // „É®„ÉüÊÉÖÂ†±„ÅÆ„Çª„ÉÉ„Éà
                $('#progress-expected-revenue').val(application.expected_revenue || '');
                $('#progress-probability-rate').val(application.probability_rate || '0');
                $('#progress-expected-start-date').val(application.expected_start_date || '');
                $('#progress-yomi-notes').val(application.yomi_notes || '');

                // ÂøóÊúõÂ∫¶„ÉªÈù¢Êé•Â∏åÊúõÊó•„Éª‰ºùÈÅî‰∫ãÈ†Ö„ÅÆË°®Á§∫ËøΩÂä†
                if (application.will_level) {
                    $('#progress-will-level-display').text(`ÂøóÊúõÂ∫¶ ${application.will_level}`).removeClass('hidden');
                } else {
                    $('#progress-will-level-display').addClass('hidden');
                }
                $('#progress-interview-dates').text(application.interview_dates || '-');
                $('#progress-notes').text(application.notes || '-');

                // „Çπ„ÉÜ„Éº„Çø„Çπ„Éû„Çπ„Çø„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
                await loadApplicationStatuses();

                // ÈÄ≤ÊçóÂ±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø
                await loadProgressHistory(applicationId);

                $('#progress-modal').removeClass('hidden');
            } catch (error) {
                console.error('Open progress modal error:', error);
                alert('ÈÄ≤ÊçóÊÉÖÂ†±„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            } finally {
                hideLoading();
            }
        };

        window.closeProgressModal = function () {
            $('#progress-modal').addClass('hidden');
            $('#progress-update-form')[0].reset();
            currentApplicationData = null;
        };

        async function loadApplicationStatuses() {
            try {
                const { data: masters, error } = await supabase
                    .from('master_data')
                    .select('*')
                    .eq('type', 'application_status')
                    .eq('is_active', true)
                    .order('sort_order');

                if (error) throw error;

                const validMasters = masters.filter(m =>
                    m.organization_id === null || m.organization_id === currentUser.organization_id
                );

                applicationStatuses = validMasters;

                // „Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞Áî®„Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ
                const select = $('#progress-new-status');
                if (select.length) {
                    select.html('<option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>');
                    validMasters.forEach(m => {
                        select.append(`<option value="${m.value}">${m.label}</option>`);
                    });
                }

                // ‰∏ÄÊã¨Êõ¥Êñ∞Áî®„Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ
                const bulkSelect = $('#bulk-new-status');
                if (bulkSelect.length) {
                    bulkSelect.empty();
                    validMasters.forEach(m => {
                        bulkSelect.append($('<option>').val(m.value).text(m.label));
                    });
                }

                // „Éï„Ç£„É´„Çø„Éº„Éú„Çø„É≥„ÅÆÂãïÁöÑÁîüÊàê
                renderStatusFilters(validMasters);

            } catch (error) {
                console.error('Load application statuses error:', error);
            }
        }

        function renderStatusFilters(statuses) {
            // „Ç∞„É´„Éº„ÉóÂåñ (metadata.group „Åå„ÅÇ„Çã„ÇÇ„ÅÆ„ÇíÂÑ™ÂÖà)
            const groups = {};
            statuses.forEach(s => {
                const group = s.metadata?.group;
                const groupLabel = s.metadata?.group_label;
                if (group && groupLabel) {
                    if (!groups[group]) {
                        groups[group] = { label: groupLabel, values: [], sort_order: s.sort_order };
                    }
                    groups[group].values.push(s.value);
                    // „Ç∞„É´„Éº„ÉóÂÜÖ„ÅÆÊúÄÂ∞è„ÅÆsort_order„Çí„Ç∞„É´„Éº„Éó„ÅÆ‰∏¶„Å≥È†Ü„Å®„Åô„Çã
                    if (s.sort_order < groups[group].sort_order) {
                        groups[group].sort_order = s.sort_order;
                    }
                }
            });

            // „Ç∞„É´„Éº„Éó„Çísort_orderÈ†Ü„Å´‰∏¶„Å≥Êõø„Åà
            const sortedGroupKeys = Object.keys(groups).sort((a, b) => groups[a].sort_order - groups[b].sort_order);

            // 1. ÁÆ°ÁêÜËÄÖÁî®„Éï„Ç£„É´„Çø„Éº
            const adminContainer = $('#admin-applicant-status-filters');
            if (adminContainer.length) {
                let html = '';
                sortedGroupKeys.forEach(key => {
                    const isActive = adminApplicantStatusFilter === key;
                    html += `<button onclick="setAdminApplicantStatusFilter('${key}')" 
                        class="status-filter-btn ${isActive ? 'active bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-50'} px-4 py-2 rounded-lg text-sm font-bold border transition-all" 
                        data-status="${key}">${groups[key].label}</button>`;
                });
                html += `<button onclick="setAdminApplicantStatusFilter('all')" 
                    class="status-filter-btn ${adminApplicantStatusFilter === 'all' ? 'active bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-50'} px-4 py-2 rounded-lg text-sm font-bold border transition-all" 
                    data-status="all">„Åô„Åπ„Å¶</button>`;
                adminContainer.html(html);
            }

            // 2. ÂÄôË£úËÄÖÁî®„Éï„Ç£„É´„Çø„Éº
            const candidateContainer = $('.candidate-status-filter').parent();
            if (candidateContainer.length) {
                let html = `<button onclick="setCandidateApplicationStatusFilter('all')" 
                    class="candidate-status-filter ${currentCandidateStatusFilter === 'all' ? 'active bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'} whitespace-nowrap px-4 py-2 rounded-lg text-sm font-bold border transition-all" 
                    data-status="all">„Åô„Åπ„Å¶</button>`;

                sortedGroupKeys.forEach(key => {
                    const isActive = currentCandidateStatusFilter === key;
                    html += `<button onclick="setCandidateApplicationStatusFilter('${key}')" 
                        class="candidate-status-filter ${isActive ? 'active bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'} whitespace-nowrap px-4 py-2 rounded-lg text-sm font-bold border transition-all" 
                        data-status="${key}">${groups[key].label}</button>`;
                });
                candidateContainer.html(html);
            }

            window.statusGroups = groups;
        }

        async function loadProgressHistory(applicationId) {
            try {
                const { data: history, error } = await supabase
                    .from('progress_history')
                    .select('*')
                    .eq('application_id', applicationId)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                renderProgressTimeline(history || []);
            } catch (error) {
                console.error('Load progress history error:', error);
                $('#progress-timeline').html('<p class="text-red-500 text-sm">Â±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>');
            }
        }

        function renderProgressTimeline(history) {
            const container = $('#progress-timeline');
            container.empty();

            if (history.length === 0) {
                container.html('<p class="text-gray-500 text-sm">„Åæ„Å†ÈÄ≤ÊçóÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>');
                return;
            }

            const html = history.map((item, index) => {
                const date = new Date(item.created_at).toLocaleString('ja-JP');
                const isLast = index === history.length - 1;

                return `
                    <div class="flex gap-4">
                        <div class="flex flex-col items-center">
                            <div class="w-3 h-3 rounded-full ${isLast ? 'bg-gray-300' : 'bg-indigo-600'}"></div>
                            ${!isLast ? '<div class="w-0.5 h-full bg-gray-200 mt-1"></div>' : ''}
                        </div>
                        <div class="flex-1 pb-6">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-semibold text-gray-900">${getSelectionStatusLabel(item.old_status) || 'Êñ∞Ë¶è'} ‚Üí ${getSelectionStatusLabel(item.new_status)}</span>
                                <span class="text-xs text-gray-500">${date}</span>
                            </div>
                            ${item.changed_by_name ? `<p class="text-sm text-gray-600 mb-1">Â§âÊõ¥ËÄÖ: ${item.changed_by_name}</p>` : ''}
                            ${item.notes ? `<p class="text-sm text-gray-700 bg-gray-50 p-2 rounded">${item.notes}</p>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            container.html(html);
        }

        $('#progress-update-form').on('submit', async function (e) {
            e.preventDefault();
            showLoading();

            const applicationId = $('#progress-application-id').val();
            const oldStatus = $('#progress-current-status').data('code');
            const newStatus = $('#progress-new-status').val();
            const notes = $('#progress-notes').val();
            const finalStatus = newStatus || oldStatus;

            try {
                // 1. ÂøúÂãü„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞
                const { error: updateError } = await supabase
                    .from('applications')
                    .update({
                        status: finalStatus,
                        expected_revenue: $('#progress-expected-revenue').val() ? parseInt($('#progress-expected-revenue').val()) : null,
                        probability_rate: parseInt($('#progress-probability-rate').val()) || 0,
                        expected_start_date: $('#progress-expected-start-date').val() || null,
                        interview_scheduled_at: $('#progress-interview-scheduled-at').val() ? new Date($('#progress-interview-scheduled-at').val()).toISOString() : null,
                        yomi_notes: $('#progress-yomi-notes').val() || null,
                        selection_info: $('#progress-selection-info').val() || null,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', applicationId);

                if (updateError) throw updateError;

                // 2. ÈÄ≤ÊçóÂ±•Ê≠¥„ÇíË®òÈå≤
                const { error: historyError } = await supabase
                    .from('progress_history')
                    .insert({
                        organization_id: currentUser.organization_id,
                        application_id: applicationId,
                        user_id: currentApplicationData.user_id,
                        old_status: oldStatus,
                        new_status: finalStatus,
                        notes: notes,
                        changed_by: currentUser.id,
                        changed_by_name: currentUser.name
                    });

                if (historyError) throw historyError;

                // 3. ÈÄöÁü•‰ΩúÊàê (Ê±ÇËÅ∑ËÄÖ„Å∏) - „Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥ÊôÇ„ÅÆ„Åø
                if (newStatus && newStatus !== oldStatus) {
                    try {
                        const statusLabel = getSelectionStatusLabel(newStatus);
                        await supabase.from('notifications').insert({
                            user_id: currentApplicationData.user_id,
                            title: 'ÈÅ∏ËÄÉ„Çπ„ÉÜ„Éº„Çø„Çπ„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü',
                            message: `„Äå${currentApplicationData.jobs.company} / ${currentApplicationData.jobs.title}„Äç„ÅÆÈÅ∏ËÄÉÁä∂Ê≥Å„Åå„Äå${statusLabel}„Äç„Å´Êõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü„ÄÇ`,
                            read: false,
                            metadata: {
                                page: 'applications',
                                application_id: applicationId
                            },
                            created_at: new Date().toISOString()
                        });
                    } catch (notifyError) {
                        console.error('Candidate notification error:', notifyError);
                    }
                }

                // 4. „É°„Éº„É´ÈÄöÁü• („Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥ÊôÇ„ÅÆ„Åø)
                if (newStatus && newStatus !== oldStatus && currentApplicationData && currentApplicationData.users && currentApplicationData.users.email) {
                    const statusLabel = getSelectionStatusLabel(newStatus);

                    // ÂøúÂãüËÄÖ„Å∏
                    await sendEmail('status_changed', currentApplicationData.users.email, {
                        userName: currentApplicationData.users.name,
                        jobTitle: currentApplicationData.jobs.title,
                        companyName: currentApplicationData.jobs.company,
                        oldStatus: oldStatus,
                        newStatus: statusLabel,
                        status: newStatus
                    });

                    // ÊãÖÂΩì„Ç≥„Éº„ÉÅ„Å∏
                    if (currentApplicationData.users.coach_id) {
                        try {
                            const { data: coachData } = await supabase
                                .from('users')
                                .select('name, email')
                                .eq('id', currentApplicationData.users.coach_id)
                                .single();

                            if (coachData && coachData.email) {
                                await sendEmail('ca_notification', coachData.email, {
                                    userName: coachData.name,
                                    candidateName: currentApplicationData.users.name,
                                    jobTitle: currentApplicationData.jobs.title,
                                    companyName: currentApplicationData.jobs.company,
                                    body: `ÊãÖÂΩìÊ±ÇËÅ∑ËÄÖ„ÅÆ ${currentApplicationData.users.name} Êßò„ÅÆÈÅ∏ËÄÉ„Çπ„ÉÜ„Éº„Çø„Çπ„Åå„Äå${statusLabel}„Äç„Å´Êõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü„ÄÇ`
                                });
                            }
                        } catch (coachNotifyError) {
                            console.error('Coach notification error:', coachNotifyError);
                        }
                    }
                }

                alert('ÈÄ≤Êçó„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');

                // ÁîªÈù¢„ÇíÊõ¥Êñ∞
                $('#progress-current-status').data('code', finalStatus).val(getSelectionStatusLabel(finalStatus));
                $('#progress-notes').val('');
                $('#progress-new-status').val('');

                await loadProgressHistory(applicationId);
                loadApplications(); // ÂøúÂãü‰∏ÄË¶ß„ÇÇÊõ¥Êñ∞

            } catch (error) {
                console.error('Update progress error:', error);
                alert('„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            } finally {
                hideLoading();
            }
        });

        // ========================
        // AI Recommendations
        // ========================
        // ========================
        // Recommendation Pagination Variables
        // ========================
        const RECOMMENDATIONS_PER_PAGE = 20;
        let currentRecommendationPage = 1;
        let totalRecommendationPages = 1;
        let allRecommendationsCache = []; // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞Âæå„ÅÆÂÖ®Êé®Ëñ¶

        async function loadRecommendations(page = 1) {
            // window.currentUser„Çí‰ΩøÁî®Ôºà„Çπ„Ç≥„Éº„ÉóÂïèÈ°å„ÇíÂõûÈÅøÔºâ
            const currentUser = window.currentUser;

            if (!currentUser) {
                console.error('currentUser is null in loadRecommendations');
                hideLoading();
                alert('„Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÂàá„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇÂÜçÂ∫¶„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                showPage('login-page');
                return;
            }

            showLoading()
            try {
                // CA„É≠„Éº„É´„ÇÇÁÆ°ÁêÜËÄÖ/„Ç≥„Éº„ÉÅÊû†„Å´ËøΩÂä†
                const isAdminOrCoach = ['org_admin', 'admin', 'coach', 'ca', 'super_admin'].includes(currentUser.role);

                // 1. Êé®Ëñ¶„Éá„Éº„Çø„ÇíÂèñÂæó
                let query = supabase
                    .from('recommendations')
                    .select('*, jobs(*), users!recommendations_user_id_fkey(id, name, email)')
                    .order('score', { ascending: false });

                if (isAdminOrCoach) {
                    // ÁÆ°ÁêÜËÄÖ/„Ç≥„Éº„ÉÅ„ÅÆÂ†¥Âêà„ÅØÁµÑÁπîÂÜÖ„ÅÆÂÖ®Êé®Ëñ¶„ÇíÂèñÂæó
                    query = query.eq('organization_id', currentUser.organization_id);
                } else {
                    // ‰∏ÄËà¨„É¶„Éº„Ç∂„Éº„ÅØËá™ÂàÜ„ÅÆÊé®Ëñ¶„ÅÆ„Åø
                    query = query.eq('user_id', currentUser.id);
                }

                let { data: recs, error } = await query;
                if (error) throw error;

                console.log('Loaded recommendations:', recs); // „Éá„Éê„ÉÉ„Ç∞Áî®„É≠„Ç∞

                // 2. „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÂèñÂæóÔºàÁÆ°ÁêÜËÄÖ/„Ç≥„Éº„ÉÅ„ÅÆÂ†¥ÂêàÔºâ
                let users = [];
                let allCandidates = []; // „Éó„É´„ÉÄ„Ç¶„É≥Áî®„ÅÆÂÖ®ÂÄôË£úËÄÖ„É™„Çπ„Éà

                if (isAdminOrCoach) {
                    // 2-1. Êé®Ëñ¶„Éá„Éº„Çø„Å´Èñ¢ÈÄ£„Åô„Çã„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÂèñÂæó
                    if (recs.length > 0) {
                        const userIds = [...new Set(recs.map(r => r.user_id))];
                        const { data: recUsers, error: usersError } = await supabase
                            .from('users')
                            .select('id, name, email, coach_id')
                            .in('id', userIds);

                        if (!usersError && recUsers) {
                            users = recUsers;
                        }
                    }

                    // 2-2. ÁµÑÁπîÂÜÖ„ÅÆÂÖ®Ê±ÇËÅ∑ËÄÖ„ÇíÂèñÂæóÔºà„Éó„É´„ÉÄ„Ç¶„É≥Áî®Ôºâ
                    // „Ç≥„Éº„ÉÅ/CA„ÅÆÂ†¥Âêà„ÅØÊãÖÂΩìÊ±ÇËÅ∑ËÄÖ„ÅÆ„Åø„ÄÅ„Åù„Çå‰ª•Â§ñ„ÅØÁµÑÁπîÂÜÖÂÖ®Âì°
                    let candidateQuery = supabase
                        .from('users')
                        .select('id, name, email, coach_id')
                        .eq('organization_id', currentUser.organization_id)
                        .eq('role', 'candidate');

                    if (currentUser.role === 'coach' || currentUser.role === 'ca') {
                        candidateQuery = candidateQuery.eq('coach_id', currentUser.id);
                    }
                    // Ê¥ªÂãïÁµÇ‰∫Ü„É¶„Éº„Ç∂„Éº„ÇíÈô§Â§ñ
                    candidateQuery = candidateQuery.neq('management_status', 'inactive');

                    const { data: candidates, error: candidateError } = await candidateQuery;
                    if (!candidateError && candidates) {
                        allCandidates = candidates;
                    }

                    // „Ç≥„Éº„ÉÅ„Åæ„Åü„ÅØCA„ÅÆÂ†¥Âêà„ÅØÊé®Ëñ¶„Éá„Éº„Çø„ÇÇÊãÖÂΩìÊ±ÇËÅ∑ËÄÖ„ÅÆ„Åø„Å´„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
                    if (currentUser.role === 'coach' || currentUser.role === 'ca') {
                        const assignedUserIds = allCandidates.map(u => u.id);
                        // users„É™„Çπ„Éà„ÇÇ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
                        users = users.filter(u => assignedUserIds.includes(u.id));
                        // Êé®Ëñ¶„Éá„Éº„Çø„ÇÇ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
                        // Ê≥®ÊÑè: recs„ÅØconst„Åß„ÅØ„Å™„ÅÑ„Åå„ÄÅÂÜç‰ª£ÂÖ•„Åô„Çã„Åü„ÇÅ„Å´let„ÅßÂÆ£Ë®Ä„ÅóÁõ¥„Åô„Åã„ÄÅ„Åì„Åì„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞„Åó„ÅüÊñ∞„Åó„ÅÑÈÖçÂàó„Çí‰Ωø„ÅÜ
                        // „Åì„Åì„Åß„ÅØrecs„ÅÆÂÜÖÂÆπ„ÇíÁõ¥Êé•Êõ∏„ÅçÊèõ„Åà„Çã„Åì„Å®„ÅØ„Åß„Åç„Å™„ÅÑ„ÅÆ„Åß„ÄÅrender„Å´Ê∏°„ÅôÈöõ„Å´„Éï„Ç£„É´„Çø„É™„É≥„Ç∞Ê∏à„Åø„ÅÆ„ÇÇ„ÅÆ„ÇíÊ∏°„Åô
                    }

                    // Êé®Ëñ¶„Éá„Éº„Çø„Å´„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„Çí„Éû„Éº„Ç∏
                    recs.forEach(rec => {
                        rec.users = users.find(u => u.id === rec.user_id) || allCandidates.find(u => u.id === rec.user_id);
                    });
                }

                // „Ç≥„Éº„ÉÅ/CA„ÅÆÂ†¥Âêà„ÅÆ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÈÅ©Áî®
                let finalRecs = recs;
                if (currentUser.role === 'coach' || currentUser.role === 'ca') {
                    const assignedUserIds = allCandidates.map(u => u.id);
                    finalRecs = recs.filter(r => assignedUserIds.includes(r.user_id));
                }

                // ÂøúÂãüÊ∏à„ÅøÊ±Ç‰∫∫„ÇíÂèñÂæó
                let appliedJobIds = new Set();

                if (isAdminOrCoach) {
                    // ÁÆ°ÁêÜËÄÖ/„Ç≥„Éº„ÉÅ„ÅÆÂ†¥Âêà: ÂÖ®„É¶„Éº„Ç∂„Éº„ÅÆÂøúÂãüÊ∏à„ÅøÊ±Ç‰∫∫„ÇíÂèñÂæó
                    try {
                        const { data: applications } = await supabase
                            .from('applications')
                            .select('job_id, user_id')
                            .eq('organization_id', currentUser.organization_id);

                        if (applications) {
                            // „É¶„Éº„Ç∂„ÉºID„Å®Ê±Ç‰∫∫ID„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„ÇíSet„Å´Ê†ºÁ¥ç„Åó„Å¶„ÄÅÁâπÂÆö„ÅÆ„É¶„Éº„Ç∂„Éº„ÅåÂøúÂãüÊ∏à„Åø„Åã„ÇíÊ≠£Á¢∫„Å´Âà§ÂÆö„Åß„Åç„Çã„Çà„ÅÜ„Å´„Åô„Çã
                            appliedJobIds = new Set(applications.map(a => `${a.user_id}_${a.job_id}`));
                        }
                    } catch (error) {
                        console.error('Failed to load applications:', error);
                    }
                } else {
                    // Ê±ÇËÅ∑ËÄÖ„ÅÆÂ†¥Âêà: Ëá™ÂàÜ„ÅÆÂøúÂãüÊ∏à„ÅøÊ±Ç‰∫∫„ÅÆ„ÅøÂèñÂæó
                    try {
                        const { data: applications } = await supabase
                            .from('applications')
                            .select('job_id')
                            .eq('user_id', currentUser.id);

                        if (applications) {
                            appliedJobIds = new Set(applications.map(a => `${currentUser.id}_${a.job_id}`));
                        }
                    } catch (error) {
                        console.error('Failed to load applications:', error);
                    }
                }

                renderRecommendations(finalRecs, isAdminOrCoach, allCandidates, appliedJobIds);

            } catch (error) {
                console.error('Load recommendations error:', error)
                $('#recommendations-container').html('<p class="text-red-500">Êé®Ëñ¶„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>')
            } finally {
                hideLoading()
            }
        }

        // ÁèæÂú®„ÅÆ„Çø„ÉñÁä∂ÊÖã„Çí‰øùÊåÅ
        let currentRecommendationTab = 'matches';
        let allRecommendations = [];
        let isAdminOrCoachView = false;
        let allCandidatesList = []; // „Éó„É´„ÉÄ„Ç¶„É≥Áî®
        let currentSelectedUserId = ''; // ÈÅ∏Êäû‰∏≠„ÅÆ„É¶„Éº„Ç∂„ÉºID
        let appliedJobIdsCache = new Set(); // ÂøúÂãüÊ∏à„ÅøÊ±Ç‰∫∫ID

        let currentSortOption = 'date-desc'; // „ÇΩ„Éº„Éà„Ç™„Éó„Ç∑„Éß„É≥ÂàùÊúüÂÄ§ÔºàËøΩÂä†Êó•È†ÜÔºâ

        // „Çø„ÉñÂàá„ÇäÊõø„ÅàÈñ¢Êï∞
        window.switchRecommendationTab = function (tab) {
            currentRecommendationTab = tab;
            currentRecommendationPage = 1; // „Éö„Éº„Ç∏Áï™Âè∑„Çí„É™„Çª„ÉÉ„Éà

            // „Çø„Éñ„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÊõ¥Êñ∞
            $('.rec-tab').removeClass('border-indigo-600 text-indigo-600').addClass('border-transparent text-gray-500');
            $(`#rec-tab-${tab}`).removeClass('border-transparent text-gray-500').addClass('border-indigo-600 text-indigo-600');

            // Êé®Ëñ¶ÁµêÊûú„ÇíÂÜç„É¨„É≥„ÉÄ„É™„É≥„Ç∞
            renderRecommendations(allRecommendations, isAdminOrCoachView, allCandidatesList, appliedJobIdsCache);
        }

        // „ÇΩ„Éº„ÉàÂàá„ÇäÊõø„ÅàÈñ¢Êï∞
        window.sortRecommendations = function (option) {
            currentSortOption = option;
            currentRecommendationPage = 1; // „Éö„Éº„Ç∏Áï™Âè∑„Çí„É™„Çª„ÉÉ„Éà
            renderRecommendations(allRecommendations, isAdminOrCoachView, allCandidatesList, appliedJobIdsCache);
        }

        // ‰∏ÄÊã¨ÈÅ∏Êäû
        window.toggleAllRecommendations = function (checked) {
            $('.rec-checkbox').prop('checked', checked);
        };

        // ‰∏ÄÊã¨Ë¶ãÈÄÅ„Çä
        window.dismissSelectedRecommendations = async function () {
            const selectedItems = $('.rec-checkbox:checked').map((i, el) => {
                return { recId: $(el).val(), jobId: $(el).data('job-id') };
            }).get();

            if (selectedItems.length === 0) {
                alert('Êìç‰Ωú„Åô„ÇãÊ±Ç‰∫∫„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            if (!confirm(`${selectedItems.length}‰ª∂„ÅÆÊ±Ç‰∫∫„Çí‰∏ÄÊã¨„ÅßË¶ãÈÄÅ„Çä„Å´„Åó„Åæ„Åô„ÅãÔºü\nÔºà„Ç¢„É≥„Éû„ÉÉ„ÉÅ„Çø„Éñ„Å∏ÁßªÂãï„Åó„Åæ„ÅôÔºâ`)) return;

            const dismissedKey = (window.currentUser ? `dismissed_recs_${window.currentUser.id}` : 'dismissed_recs_temp');
            const dismissed = new Set(JSON.parse(localStorage.getItem(dismissedKey) || '[]'));

            selectedItems.forEach(item => {
                dismissed.add(item.jobId);
            });

            localStorage.setItem(dismissedKey, JSON.stringify(Array.from(dismissed)));
            alert('Ë¶ãÈÄÅ„ÇäÂá¶ÁêÜ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ');
            renderRecommendations();
        };

        // ‰∏ÄÊã¨ÂøúÂãü‰ª£ÁêÜ
        window.applySelectedRecommendations = async function () {
            const selectedItems = $('.rec-checkbox:checked').map((i, el) => {
                return { jobId: $(el).data('job-id'), userId: $(el).data('user-id') };
            }).get();

            if (selectedItems.length === 0) {
                alert('Êìç‰Ωú„Åô„ÇãÊ±Ç‰∫∫„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            if (!confirm(`${selectedItems.length}‰ª∂„ÅÆÊ±Ç‰∫∫„Å´‰∏ÄÊã¨„ÅßÂøúÂãü‰ª£ÁêÜ„ÇíÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü`)) return;

            showLoading();
            let successCount = 0;
            let failCount = 0;

            for (const item of selectedItems) {
                try {
                    // applyForJob „ÅØÂÜÖÈÉ®„Åß„Ç¢„É©„Éº„Éà„ÇíÂá∫„ÅôÂèØËÉΩÊÄß„Åå„ÅÇ„Çã„Åü„ÇÅ„ÄÅÈùô„Åã„Å´ÂÆüË°å„Åß„Åç„Çã„ÅãË¶ÅÁ¢∫Ë™ç
                    // „Åì„Åì„Åß„ÅØÂÄãÂà•„Å´ÂøúÂãüÂá¶ÁêÜ„ÇíËµ∞„Çâ„Åõ„Çã
                    await applyForJob(item.jobId, item.userId);
                    successCount++;
                } catch (e) {
                    console.error('Bulk apply error:', e);
                    failCount++;
                }
            }

            hideLoading();
            alert(`‰∏ÄÊã¨ÂøúÂãü„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ\nÊàêÂäü: ${successCount}‰ª∂${failCount > 0 ? `\nÂ§±Êïó: ${failCount}‰ª∂` : ''}`);
            renderRecommendations();
        };

        window.renderRecommendations = function (recs, isAdminOrCoach, candidates, appliedJobIds) {
            // ÂºïÊï∞ÁúÅÁï•ÊôÇ„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
            if (recs === undefined) recs = allRecommendations;
            if (isAdminOrCoach === undefined) isAdminOrCoach = isAdminOrCoachView;
            if (candidates === undefined) candidates = allCandidatesList;
            if (appliedJobIds === undefined) appliedJobIds = appliedJobIdsCache;

            // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å´‰øùÂ≠ò
            allRecommendations = recs;
            isAdminOrCoachView = isAdminOrCoach;
            allCandidatesList = candidates;
            appliedJobIdsCache = appliedJobIds;

            const container = $('#recommendations-container');
            // ÂÖ®ÈÅ∏Êäû„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Çí„É™„Çª„ÉÉ„Éà
            $('#select-all-recs').prop('checked', false);

            // Ë¶ãÈÄÅ„ÇäÊ∏à„Åø„Éá„Éº„Çø„ÅÆÂèñÂæó
            const dismissedKey = (window.currentUser ? `dismissed_recs_${window.currentUser.id}` : 'dismissed_recs_temp');
            const dismissed = new Set(JSON.parse(localStorage.getItem(dismissedKey) || '[]'));

            // „Ç≠„Éº„ÉØ„Éº„ÉâÊ§úÁ¥¢
            const keyword = $('#rec-search-keyword').val()?.toLowerCase().trim();

            // „É¶„Éº„Ç∂„ÉºÂêç„ÅÆ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞ (New)
            let displayRecs = recs;
            const candNameFilter = $('#rec-search-candidate-name').val()?.toLowerCase().trim();
            if (candNameFilter) {
                displayRecs = displayRecs.filter(r => {
                    const uName = (r.users?.name || '').toLowerCase();
                    return uName.includes(candNameFilter);
                });
            }

            // „Åä„Åô„Åô„ÇÅ‰∏ÄË¶ß„Åß„ÅØÂÖ®„É¶„Éº„Ç∂„Éº„ÇíË°®Á§∫„Åô„ÇãÊñπÈáùÔºà„Ç∞„É≠„Éº„Éê„É´„Åß„ÅÆ„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû„ÅØÂèçÊò†„Åï„Åõ„Å™„ÅÑÔºâ
            // if (currentSelectedUserId) {
            //     displayRecs = recs.filter(r => r.user_id === currentSelectedUserId);
            // }

            // „Ç≠„Éº„ÉØ„Éº„Éâ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            if (keyword) {
                displayRecs = displayRecs.filter(r => {
                    const job = r.jobs || {};
                    const searchTargets = [
                        job.company,
                        job.title,
                        job.description,
                        job.qualifications,
                        job.location,
                        job.employment_type,
                        job.job_category,
                        job.industry_category
                    ].filter(Boolean).map(s => String(s).toLowerCase());

                    return searchTargets.some(target => target.includes(keyword));
                });
            }

            // „Çø„Éñ„Å´Âøú„Åò„Å¶„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            let filteredRecs = displayRecs.filter(rec => {
                const isDismissed = dismissed.has(rec.job_id);
                if (currentRecommendationTab === 'matches') {
                    // ÊèêÊ°à„Çø„Éñ: „Çπ„Ç≥„Ç¢50%‰ª•‰∏ä „Åã„Å§ Ë¶ãÈÄÅ„Çä„Åß„Å™„ÅÑ
                    return rec.score >= 50 && !isDismissed;
                } else {
                    // „Ç¢„É≥„Éû„ÉÉ„ÉÅ„Çø„Éñ: „Çπ„Ç≥„Ç¢49%‰ª•‰∏ã „Åæ„Åü„ÅØ Ë¶ãÈÄÅ„ÇäÊ∏à„Åø
                    return rec.score < 50 || isDismissed;
                }
            });

            // „ÇΩ„Éº„ÉàÂá¶ÁêÜ

            filteredRecs.sort((a, b) => {
                // Ë¶ãÈÄÅ„ÇäÊ∏à„Åø„ÇíÂæå„Çç„Å∏
                const aDis = dismissed.has(a.job_id) ? 1 : 0;
                const bDis = dismissed.has(b.job_id) ? 1 : 0;
                if (aDis !== bDis) return aDis - bDis;

                const [key, order] = currentSortOption.split('-');
                let valA, valB;

                if (key === 'score') {
                    valA = a.score;
                    valB = b.score;
                } else if (key === 'date') {
                    valA = new Date(a.created_at).getTime();
                    valB = new Date(b.created_at).getTime();
                }

                if (order === 'asc') {
                    return valA - valB;
                } else {
                    return valB - valA;
                }
            });

            // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥Âá¶ÁêÜ
            allRecommendationsCache = filteredRecs;
            const totalCount = filteredRecs.length;
            totalRecommendationPages = Math.ceil(totalCount / RECOMMENDATIONS_PER_PAGE);

            const from = (currentRecommendationPage - 1) * RECOMMENDATIONS_PER_PAGE;
            const to = from + RECOMMENDATIONS_PER_PAGE;
            const paginatedRecs = filteredRecs.slice(from, to);

            console.log(`Loaded recommendation page ${currentRecommendationPage}/${totalRecommendationPages}, showing ${paginatedRecs.length} recommendations (total: ${totalCount})`);

            // „Ç≥„É≥„Éà„É≠„Éº„É´„Ç®„É™„Ç¢Ôºà„É¶„Éº„Ç∂„Éº„Éï„Ç£„É´„Çø„Éº ÔºÜ „ÇΩ„Éº„ÉàÔºâ„ÅÆÊßãÁØâ
            let controlsHtml = '<div class="flex flex-wrap items-center justify-between mb-6 gap-4">';

            // Â∑¶ÂÅ¥: „É¶„Éº„Ç∂„Éº„Éï„Ç£„É´„Çø„Éº („Åä„Åô„Åô„ÇÅ‰∏ÄË¶ß„Åß„ÅØ„Ç™„Éü„ÉÉ„Éà)
            controlsHtml += '<div></div>'; // „É¨„Ç§„Ç¢„Ç¶„ÉàË™øÊï¥Áî®„ÅÆ„Çπ„Éö„Éº„Çµ„Éº

            // Âè≥ÂÅ¥: „ÇΩ„Éº„ÉàÔºàÂÜçÂÆüË°å„Éú„Çø„É≥„ÅØÂâäÈô§Ôºâ
            controlsHtml += `
                <div class="flex items-center gap-2 ml-auto">
                    ${isAdminOrCoach ? `
                    <button onclick="reRunSelectedRecommendations()" class="bg-white text-indigo-600 border border-indigo-200 px-3 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-indigo-50 transition flex items-center gap-2 whitespace-nowrap">
                        <i class="fas fa-sync-alt"></i> ÂÜçÂà§ÂÆö
                    </button>
                    
                    <button onclick="openRecommendationMessageModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-indigo-700 transition flex items-center gap-2 whitespace-nowrap">
                        <i class="fas fa-envelope"></i> „É°„ÉÉ„Çª„Éº„Ç∏‰ΩúÊàê
                    </button>
                    ` : ''}

                    <div class="flex items-center gap-2 ml-2 pl-4 border-l">
                        <label class="text-sm font-medium text-gray-700 whitespace-nowrap"><i class="fas fa-sort mr-1"></i></label>
                        <select onchange="sortRecommendations(this.value)" class="px-3 py-2 border rounded-lg text-sm cursor-pointer hover:bg-gray-50 border-gray-200">
                            <option value="score-desc" ${currentSortOption === 'score-desc' ? 'selected' : ''}>„Éû„ÉÉ„ÉÅÂ∫¶È†Ü</option>
                            <option value="date-desc" ${currentSortOption === 'date-desc' ? 'selected' : ''}>Êñ∞ÁùÄÈ†Ü</option>
                            <option value="date-asc" ${currentSortOption === 'date-asc' ? 'selected' : ''}>Âè§„ÅÑÈ†Ü</option>
                        </select>
                    </div>
                </div>
            `;
            controlsHtml += '</div>';

            // ‰ª∂Êï∞Ë°®Á§∫„Å®‰∏ÄÊã¨Êìç‰Ωú„Ç®„É™„Ç¢
            if (totalCount > 0) {
                controlsHtml += `
                <div class="flex items-center justify-between mb-4 bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <div class="flex items-center gap-4 text-sm text-gray-600">
                        <label class="flex items-center gap-2 cursor-pointer font-medium text-gray-700">
                            <input type="checkbox" id="select-all-recs" onchange="toggleAllRecommendations(this.checked)" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            ÂÖ®„Å¶ÈÅ∏Êäû
                        </label>
                        <span>Ë°®Á§∫‰∏≠: ${paginatedRecs.length}‰ª∂ / ÂÖ®‰Ωì: ${totalCount}‰ª∂</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="dismissSelectedRecommendations()" class="text-xs bg-white text-gray-600 border border-gray-300 px-3 py-1.5 rounded hover:bg-gray-100 transition font-bold">
                            <i class="fas fa-eye-slash mr-1"></i>ÈÅ∏Êäû„Çí‰∏ÄÊã¨Ë¶ãÈÄÅ„Çä
                        </button>
                        <button onclick="applySelectedRecommendations()" class="text-xs bg-indigo-50 text-indigo-700 border border-indigo-200 px-3 py-1.5 rounded hover:bg-indigo-100 transition font-bold">
                            <i class="fas fa-paper-plane mr-1"></i>ÈÅ∏Êäû„Çí‰∏ÄÊã¨ÂøúÂãü‰ª£ÁêÜ
                        </button>
                    </div>
                </div>`;
            }

            container.empty();

            if (paginatedRecs.length === 0 && totalCount === 0) {
                const tabLabel = currentRecommendationTab === 'matches' ? 'Êé®Ëñ¶' : '„Ç¢„É≥„Éû„ÉÉ„ÉÅ';
                // „É¶„Éº„Ç∂„Éº„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çã„Åå„Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„Å®„ÄÅÊú¨ÂΩì„Å´„Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„Åß„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂ§â„Åà„Çã
                let message = `${tabLabel}„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì`;
                let subMessage = isAdminOrCoach ? 'Ê±Ç‰∫∫Ê§úÁ¥¢ÁîªÈù¢„Åã„ÇâÂØæË±°„É¶„Éº„Ç∂„Éº„ÇíÈÅ∏Êäû„Åó„Å¶AIÊé®Ëñ¶„ÇíÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ' : '„ÅÇ„Å™„Åü„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´„Å´Âü∫„Å•„ÅÑ„Å¶„ÄÅÊúÄÈÅ©„Å™Ê±Ç‰∫∫„ÇíAI„ÅåÂàÜÊûê„Åó„Åæ„Åô„ÄÇ';

                if (currentSelectedUserId) {
                    const selectedUser = candidates.find(u => u.id === currentSelectedUserId);
                    if (selectedUser) {
                        message = `${selectedUser.name} „Åï„Çì„ÅÆ${tabLabel}„Éá„Éº„Çø„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì`;
                        subMessage = 'Ê±Ç‰∫∫Ê§úÁ¥¢ÁîªÈù¢„Åã„Çâ„Åì„ÅÆ„É¶„Éº„Ç∂„Éº„ÇíÈÅ∏Êäû„Åó„Å¶AIÊé®Ëñ¶„ÇíÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                    }
                }

                container.html(controlsHtml + `
                    <div class="text-center py-12">
                        <div class="mb-4">
                            <i class="fas fa-robot text-6xl text-indigo-200"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">${message}</h3>
                        <p class="text-gray-600 mb-6">${subMessage}</p>
                        ${!isAdminOrCoach ? `
                        <button onclick="generateAIRecommendations()" 
                            class="bg-indigo-600 text-white px-8 py-3 rounded-lg hover:bg-indigo-700 transition font-bold shadow-lg">
                            <i class="fas fa-magic mr-2"></i>AIÂàÜÊûê„ÇíÈñãÂßã„Åô„Çã
                        </button>
                        ` : ''}
                    </div>
                `)
                return
            }

            const html = controlsHtml + `
                <div id="recommendations-list">
            ` + paginatedRecs.map(rec => {
                const matchColor = rec.score >= 50 ? 'bg-indigo-600' : 'bg-gray-500';
                // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„Ç¨„Éº„Éâ
                const userName = rec.users ? rec.users.name : '‰∏çÊòé„Å™„É¶„Éº„Ç∂„Éº';
                const userEmail = rec.users ? rec.users.email : '';
                const isApplied = appliedJobIds.has(`${rec.user_id}_${rec.job_id}`);

                // Ë¶ãÈÄÅ„Çä„ÉÅ„Çß„ÉÉ„ÇØ
                const isDismissed = dismissed.has(rec.job_id);
                const cardStyle = isDismissed ? 'bg-gray-100 opacity-60' : 'bg-white border-gray-200 hover:shadow-md';

                // URLÈ†ÖÁõÆ„ÅÆÂèñÂæóÂÖÉ„ÇíGoogle DriveÁî®„Ç´„É©„É†Ôºàpdf_urlÁ≠âÔºâ„Å´ÂÑ™ÂÖà
                const orgSettings = getOrgSettings();
                let driveCol = orgSettings.drive_column || 'pdf_url';
                if (driveCol === 'pdf' || driveCol === 'url') driveCol = 'pdf_url';
                const driveUrl = rec.jobs[driveCol] || rec.jobs.url;

                return `
                <div class="${cardStyle} border rounded-lg p-6 transition mb-4 relative overflow-hidden group cursor-pointer rec-card" 
                     data-user-id="${rec.user_id}" 
                     data-job-id="${rec.job_id}"
                     onclick="showJobDetailModal('${rec.job_id}')">
                    ${isAdminOrCoach ? `
                    <div class="absolute top-0 left-0 p-3 z-20" onclick="event.stopPropagation()">
                        <div class="bg-white rounded-md shadow-sm border border-gray-200 p-1 flex items-center justify-center">
                            <input type="checkbox" class="w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 rec-checkbox cursor-pointer" 
                                   value="${rec.id}" data-job-id="${rec.job_id}" data-user-id="${rec.user_id}">
                        </div>
                    </div>
                    ` : ''}
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow cursor-pointer relative" onclick="window.customShowJobDetailModal('${rec.job_id}')">
                    <div class="flex flex-col md:flex-row gap-6">
                        <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ (Â∑¶ÂÅ¥) -->
                        <div class="flex-1">
                            <div class="flex flex-wrap items-center gap-2 mb-3">
                                ${isAdminOrCoach ? `
                                <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-bold whitespace-nowrap">
                                    ${rec.users ? rec.users.name : 'Ê±ÇËÅ∑ËÄÖ'} Êßò
                                </span>
                                ` : ''}
                                ${rec.match_type === 'auto' ? `<span class="bg-indigo-50 text-indigo-700 px-2 py-1 rounded text-xs font-bold border border-indigo-100"><i class="fas fa-robot mr-1"></i>AIËá™Âãï„Éû„ÉÉ„ÉÅ</span>` : ''}
                                ${isApplied ? `<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold"><i class="fas fa-check-circle mr-1"></i>ÂøúÂãüÊ∏à„Åø</span>` : ''}
                                ${isAdminOrCoach && isDismissed ? `<span class="bg-gray-200 text-gray-600 px-2 py-1 rounded text-xs font-bold"><i class="fas fa-eye-slash mr-1"></i>Ë¶ãÈÄÅ„Çä</span>` : ''}
                            </div>

                            <h3 class="text-xl font-bold text-gray-900 mb-1 group-hover:text-indigo-600 transition leading-tight">${rec.jobs.title}</h3>
                            <p class="text-gray-600 font-medium mb-1">${rec.jobs.company}</p>
                            
                            <div class="flex flex-wrap gap-x-4 gap-y-1 mb-3">
                                ${rec.jobs.pdf_filename ? `
                                <div class="flex items-center gap-1 text-[10px] text-gray-500 bg-gray-50 px-1.5 py-0.5 rounded border border-gray-100">
                                    <i class="fas fa-file-pdf text-red-400"></i>
                                    <span class="truncate max-w-[150px]" title="${rec.jobs.pdf_filename}">${rec.jobs.pdf_filename}</span>
                                </div>
                                ` : ''}
                                ${driveUrl ? `
                                <div class="flex items-center gap-1 text-[10px] text-gray-400">
                                    <i class="fas fa-link"></i>
                                    <span class="truncate max-w-[200px]" title="${driveUrl}">${driveUrl}</span>
                                </div>
                                ` : ''}
                            </div>
                            
                            <!-- Ê±Ç‰∫∫Ê¶ÇË¶ÅÔºàÊäúÁ≤ãÔºâ -->
                            <p class="text-sm text-gray-500 mb-4 line-clamp-2">
                                ${rec.jobs.description || 'Ë©≥Á¥∞ÊÉÖÂ†±„ÅØÊ±Ç‰∫∫Ë©≥Á¥∞„Çí„ÅîË¶ß„Åè„Å†„Åï„ÅÑ„ÄÇ'}
                            </p>

                            <!-- AIÂàÜÊûêÁµêÊûú („Çπ„Ç≠„É´„Éû„ÉÉ„ÉÅ & Á§æÈ¢®) -->
                            ${(() => {
                        const text = rec.match_reason || rec.reason || '';
                        let skillReason = text;
                        let cultureRank = '', cultureReason = '';

                        const skillMatch = text.match(/„Éû„ÉÉ„ÉÅÂ∫¶Ë©ï‰æ°[\s\S]*?ÁêÜÁî±[:Ôºö]([\s\S]*?)(?=Á∑èÂêàË©ï‰æ°|Á§æÈ¢®|$)/);
                        if (skillMatch) skillReason = skillMatch[1].trim();

                        const cultureMatch = text.match(/Á§æÈ¢®„Éª„Ç´„É´„ÉÅ„É£„Éº„ÅÆ„Éï„Ç£„ÉÉ„ÉàÂ∫¶Ë©ï‰æ°[\s\S]*?Ë©ï‰æ°[:Ôºö]\s*([A-E\-])[\s\S]*?ÁêÜÁî±[:Ôºö]([\s\S]*)/);
                        if (cultureMatch) {
                            cultureRank = cultureMatch[1].trim();
                            cultureReason = cultureMatch[2].trim();
                        }

                        const getRankLabelColor = (r) => {
                            if (['A', 'B'].includes(r)) return 'bg-sky-100 text-sky-800 border-sky-200';
                            if (r === 'C') return 'bg-gray-100 text-gray-800 border-gray-200';
                            if (['D', 'E'].includes(r)) return 'bg-orange-100 text-orange-800 border-orange-200';
                            return 'bg-gray-100 text-gray-600 border-gray-200';
                        };

                        return `
                                <div class="bg-blue-50 border border-blue-100 rounded-md p-3 mb-2">
                                    <div class="flex items-start">
                                        <div class="w-1 self-stretch bg-blue-600 rounded-full mr-3 mt-1 mb-1"></div>
                                        <div>
                                            <h4 class="text-blue-700 font-bold text-sm mb-1">„Çπ„Ç≠„É´„Éû„ÉÉ„ÉÅ</h4>
                                            <p class="text-sm text-gray-800 leading-relaxed">${skillReason}</p>
                                        </div>
                                    </div>
                                </div>
                                ${cultureRank && cultureRank !== '-' ? `
                                <div class="mt-2 flex items-start text-sm">
                                    <span class="flex-shrink-0 inline-block px-2 py-0.5 border text-xs font-bold rounded mr-2 ${getRankLabelColor(cultureRank)}">
                                        Á§æÈ¢®: ${cultureRank}
                                    </span>
                                    <p class="text-gray-600 text-xs leading-relaxed self-center">
                                        ${cultureReason}
                                    </p>
                                </div>
                                ` : ''}
                                `;
                    })()}
                            
                            <!-- Êìç‰Ωú„Éú„Çø„É≥„Ç®„É™„Ç¢ -->
                            <div class="mt-4 flex gap-3">
                                ${!isApplied ? `
                                    <button onclick="event.stopPropagation(); applyForJob('${rec.job_id}', '${rec.user_id}')" 
                                        class="text-sm bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-700 transition">
                                        ${isAdminOrCoach ? '‰ª£ÁêÜÂøúÂãü' : 'ÂøúÂãü„Åô„Çã'}
                                    </button>
                                    ${rec.score >= 50 && !isDismissed ? `
                                    <button onclick="event.stopPropagation(); window.dismissRecommendation('${rec.job_id}')" 
                                        class="text-sm bg-white text-gray-600 border border-gray-300 px-3 py-2 rounded hover:bg-gray-50 transition">
                                        Ë¶ãÈÄÅ„Çã
                                    </button>
                                    ` : ''}
                                ` : ''}
                                ${isAdminOrCoach ? `
                                <button onclick="event.stopPropagation(); window.editRecommendationReason('${rec.id}')" 
                                    class="text-xs text-gray-500 hover:text-indigo-600 underline ml-auto self-center">
                                    <i class="fas fa-edit"></i> ÁêÜÁî±Á∑®ÈõÜ
                                </button>
                                ` : ''}
                            </div>
                        </div>

                        <!-- „Çµ„Ç§„Éâ„Éë„Éç„É´ (Âè≥ÂÅ¥: Âπ¥Âèé„Éª„É™„É≥„ÇØ„ÉªAI„Çπ„Ç≥„Ç¢) -->
                        <div class="w-full md:w-48 flex flex-col items-end gap-6 border-l border-gray-100 pl-6 md:pt-2">
                            
                            <!-- ‰ºÅÊ•≠Âêç & Âπ¥Âèé -->
                            <div class="text-right">
                                <p class="text-sm font-bold text-gray-800 mb-1">${rec.jobs.company}</p>
                                <p class="text-lg font-bold text-orange-500">
                                    ${rec.jobs.salary_min ? `${Math.floor(rec.jobs.salary_min / 10000)}‰∏áÂÜÜ` : ''} 
                                    ${rec.jobs.salary_max ? `~ ${Math.floor(rec.jobs.salary_max / 10000)}‰∏áÂÜÜ` : ''}
                                </p>
                            </div>

                            <!-- „É™„É≥„ÇØ (Á∏¶Êõ∏„ÅçÈ¢®„É¨„Ç§„Ç¢„Ç¶„Éà) -->
                            ${driveUrl ? `
                            <a href="${driveUrl}" target="_blank" onclick="event.stopPropagation();" 
                               class="writing-vertical-rl text-indigo-600 hover:text-indigo-800 text-sm font-medium tracking-widest border-r-2 border-indigo-100 pr-2 h-24 flex items-center justify-center hover:border-indigo-300 transition">
                               „É™„É≥„ÇØ„ÇíÈñã„Åè <i class="fas fa-external-link-alt mb-2 transform rotate-90"></i>
                            </a>
                            ` : ''}

                            <!-- AI„Çπ„Ç≥„Ç¢ -->
                            <div class="text-center mt-auto">
                                <i class="fas fa-robot text-3xl text-indigo-500 mb-1"></i>
                                <div class="text-lg font-bold text-indigo-900 leading-tight">AI</div>
                                <div class="text-xl font-bold text-indigo-900 leading-none">(${rec.score}ÁÇπ)</div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                `;
            }).join('') + '</div>';

            container.html(html);

            // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥UI„ÇíËøΩÂä†
            renderRecommendationPagination();

            // Select2„ÇíÂàùÊúüÂåñ
            if (isAdminOrCoach) {
                $('#rec-user-filter').select2({
                    placeholder: "Ê±ÇËÅ∑ËÄÖ„ÇíÈÅ∏Êäû",
                    allowClear: true,
                    language: "ja",
                    width: '100%'
                });
            }
        }

        // Êé®Ëñ¶‰∏ÄË¶ß„Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥UI„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        function renderRecommendationPagination() {
            const container = $('#recommendation-pagination-container');
            if (!container.length) {
                // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥„Ç≥„É≥„ÉÜ„Éä„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ‰ΩúÊàê
                $('#recommendations-container').after('<div id="recommendation-pagination-container" class="mt-6"></div>');
            }

            if (totalRecommendationPages <= 1) {
                $('#recommendation-pagination-container').html('');
                return;
            }

            const maxButtons = 5;
            let startPage = Math.max(1, currentRecommendationPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalRecommendationPages, startPage + maxButtons - 1);

            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            let html = '<div class="flex justify-center items-center gap-2">';

            // Ââç„Å∏„Éú„Çø„É≥
            if (currentRecommendationPage > 1) {
                html += `<button onclick="goToRecommendationPage(${currentRecommendationPage - 1})" 
                    class="px-4 py-2 border rounded-lg hover:bg-gray-50 transition">
                    <i class="fas fa-chevron-left"></i> Ââç„Å∏
                </button>`;
            }

            // „Éö„Éº„Ç∏Áï™Âè∑„Éú„Çø„É≥
            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === currentRecommendationPage;
                html += `<button onclick="goToRecommendationPage(${i})" 
                    class="px-4 py-2 border rounded-lg transition ${isActive ? 'bg-indigo-600 text-white' : 'hover:bg-gray-50'}">
                    ${i}
                </button>`;
            }

            // Ê¨°„Å∏„Éú„Çø„É≥
            if (currentRecommendationPage < totalRecommendationPages) {
                html += `<button onclick="goToRecommendationPage(${currentRecommendationPage + 1})" 
                    class="px-4 py-2 border rounded-lg hover:bg-gray-50 transition">
                    Ê¨°„Å∏ <i class="fas fa-chevron-right"></i>
                </button>`;
            }

            html += '</div>';
            html += `<div class="text-center mt-2 text-sm text-gray-600">
                „Éö„Éº„Ç∏ ${currentRecommendationPage} / ${totalRecommendationPages}
            </div>`;

            $('#recommendation-pagination-container').html(html);
        }

        // Êé®Ëñ¶‰∏ÄË¶ß„ÅÆ„Éö„Éº„Ç∏ÁßªÂãï
        window.goToRecommendationPage = function (page) {
            currentRecommendationPage = page;
            renderRecommendations();
        }


        // ÈÅ∏Êäû„Åó„ÅüÊ±Ç‰∫∫„ÅÆAIÂÜçÂà§ÂÆö
        window.reRunSelectedRecommendations = async function () {
            const checkboxes = $('.rec-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('ÂÜçÂà§ÂÆö„Åô„ÇãÊ±Ç‰∫∫„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            if (!confirm(`${checkboxes.length}‰ª∂„ÅÆÊ±Ç‰∫∫„Å´„Å§„ÅÑ„Å¶AI„Éû„ÉÉ„ÉÅ„É≥„Ç∞„ÇíÂÜçÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü\nÔºàÁèæÂú®„ÅÆÂà§ÂÆöÁµêÊûú„ÅØ‰∏äÊõ∏„Åç„Åï„Çå„Åæ„ÅôÔºâ`)) {
                return;
            }

            showLoading();
            try {
                // „É¶„Éº„Ç∂„Éº„Åî„Å®„Å´„Ç∞„É´„Éº„ÉóÂåñ
                const userJobMap = {}; // { userId: [{jobId, recId}...] }

                checkboxes.each(function () {
                    const userId = $(this).data('user-id');
                    const jobId = $(this).data('job-id');
                    const recId = $(this).val();
                    if (!userId || !jobId) return; // „Ç¨„Éº„Éâ
                    if (!userJobMap[userId]) userJobMap[userId] = [];
                    userJobMap[userId].push({ jobId, recId });
                });

                let totalSuccess = 0;
                let totalErrors = 0;

                // „É¶„Éº„Ç∂„Éº„Åî„Å®„Å´Âá¶ÁêÜ
                for (const userId of Object.keys(userJobMap)) {
                    const items = userJobMap[userId];
                    const jobIds = items.map(i => i.jobId);
                    // Always fetch fresh & complete data from DB to ensure AI has full context
                    // allCandidatesList only provides basic info (id, name)
                    const { data: dbUser } = await supabase.from('users')
                        .select('*, candidate_profiles(*)')
                        .eq('id', userId)
                        .single();

                    let userDataForAI = null;

                    if (dbUser) {
                        const profile = Array.isArray(dbUser.candidate_profiles) ? dbUser.candidate_profiles[0] : dbUser.candidate_profiles;
                        userDataForAI = { ...dbUser, ...profile, id: userId };
                        console.log('Fetched full user data for Re-Analysis:', userDataForAI.name);
                    } else {
                        // Fallback logic
                        const user = allCandidatesList.find(u => u.id === userId);
                        if (user) {
                            const profile = Array.isArray(user.candidate_profiles) ? user.candidate_profiles[0] : user.candidate_profiles;
                            userDataForAI = { ...user, ...profile, id: userId };
                        } else {
                            const sampleRec = allRecommendations.find(r => r.user_id === userId);
                            if (sampleRec && sampleRec.users) {
                                userDataForAI = { ...sampleRec.users, id: userId };
                            }
                        }
                    }

                    if (!userDataForAI) {
                        console.error('User data missing for AI reruun');
                        totalErrors += jobIds.length;
                        continue;
                    }

                    // Ê±Ç‰∫∫ÊÉÖÂ†±„ÅÆÂèñÂæó (allRecommendations„Åã„ÇâÊé¢„Åô)
                    // rec.jobs „ÅåÂøÖË¶Å
                    const jobs = jobIds.map(jobId => {
                        const rec = allRecommendations.find(r => r.job_id === jobId && r.user_id === userId);
                        return rec ? rec.jobs : null;
                    }).filter(j => j);

                    if (jobs.length === 0) continue;

                    console.log(`Re-analyzing for user ${userDataForAI.name || userId}: `, jobs.length, 'jobs');

                    const { data: results, error } = await supabase.functions.invoke('ai-matching', {
                        body: {
                            user: userDataForAI,
                            jobs: jobs
                        }
                    });

                    if (error) {
                        console.error('AI Matching Error:', error);
                        // Edge Function„Åã„Çâ„ÅÆË©≥Á¥∞„Ç®„É©„Éº„ÇíÂèñÂæó
                        if (error.context && error.context.body) {
                            try {
                                // ReadableStream„ÅÆÂ†¥Âêà„ÅØË™≠„ÅøÂèñ„Çã
                                if (error.context.body instanceof ReadableStream) {
                                    const reader = error.context.body.getReader();
                                    const decoder = new TextDecoder();
                                    let errorText = '';
                                    while (true) {
                                        const { done, value } = await reader.read();
                                        if (done) break;
                                        errorText += decoder.decode(value, { stream: true });
                                    }
                                    console.error('Error Details (from stream):', errorText);
                                    try {
                                        const errorJson = JSON.parse(errorText);
                                        console.error('Parsed Error:', errorJson);
                                    } catch (e) {
                                        console.error('Could not parse error as JSON:', errorText);
                                    }
                                } else {
                                    console.error('Error Details:', error.context.body);
                                }
                            } catch (streamError) {
                                console.error('Error reading stream:', streamError);
                            }
                        }
                        throw error;
                    }

                    // results„Åånull„Åæ„Åü„ÅØundefined„ÅÆÂ†¥Âêà„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
                    if (!results) {
                        console.error('AI Matching returned null/undefined results');
                        totalErrors += jobIds.length;
                        continue;
                    }

                    // results„Åå„Ç®„É©„Éº„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÂ†¥Âêà„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
                    if (results.error) {
                        console.error('AI Matching returned error in results:', results);
                        totalErrors += jobIds.length;
                        continue;
                    }

                    // ÊâãÂãïÂÆüË°åÊôÇ„ÅØ‰∏ç‰∏ÄËá¥„Åß„ÇÇÂÖ®„Å¶‰øùÂ≠ò
                    const upsertData = results.map(res => {
                        // ÂûãÂ§âÊèõ„ÅÆ‰∏ç‰∏ÄËá¥„ÇíÈò≤„Åê„Åü„ÇÅ == „Çí‰ΩøÁî®
                        const original = items.find(i => i.jobId == res.job_id);
                        return {
                            id: original ? original.recId : undefined,
                            organization_id: userDataForAI.organization_id || currentUser.organization_id, // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„ÇíËøΩÂä†
                            user_id: userId,
                            job_id: res.job_id,
                            score: res.ineligible ? 10 : res.match_score,
                            reason: res.recommendation_reason || res.reason,
                            details: res.details,
                            match_type: 'manual'
                        };
                    });

                    const { error: upsertError } = await supabase
                        .from('recommendations')
                        .upsert(upsertData);

                    if (upsertError) {
                        console.error('Upsert error:', upsertError);
                        totalErrors += jobIds.length;
                    } else {
                        totalSuccess += jobIds.length;
                    }
                }

                alert(`ÂÜçÂà§ÂÆö„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ\nÊàêÂäü: ${totalSuccess} ‰ª∂\nÂ§±Êïó: ${totalErrors} ‰ª∂`);

                // „Éá„Éº„ÇøÂÜçË™≠„ÅøËæº„Åø
                if (typeof loadRecommendations === 'function') {
                    loadRecommendations();
                }

            } catch (error) {
                console.error('Re-run error:', error);
                // „Ç®„É©„Éº„ÅÆË©≥Á¥∞ÊÉÖÂ†±„ÇíË°®Á§∫
                let errorMessage = 'ÂÜçÂà§ÂÆö‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + (error.message || 'Unknown error');

                // ReadableStream„Åã„Çâ„Ç®„É©„ÉºË©≥Á¥∞„ÇíË™≠„ÅøÂèñ„Çã
                if (error.context && error.context.body) {
                    try {
                        if (error.context.body instanceof ReadableStream) {
                            const reader = error.context.body.getReader();
                            const decoder = new TextDecoder();
                            let errorText = '';
                            while (true) {
                                const { done, value } = await reader.read();
                                if (done) break;
                                errorText += decoder.decode(value, { stream: true });
                            }
                            console.error('Full error context (from stream):', errorText);
                            try {
                                const errorBody = JSON.parse(errorText);
                                if (errorBody.error) {
                                    errorMessage += '\nË©≥Á¥∞: ' + errorBody.error;
                                }
                                if (errorBody.errorType) {
                                    errorMessage += '\n„Ç®„É©„Éº„Çø„Ç§„Éó: ' + errorBody.errorType;
                                }
                                if (errorBody.details) {
                                    console.error('Stack trace:', errorBody.details);
                                }
                            } catch (parseError) {
                                errorMessage += '\nË©≥Á¥∞: ' + errorText;
                            }
                        } else {
                            const errorBody = error.context.body;
                            if (errorBody.error) {
                                errorMessage += '\nË©≥Á¥∞: ' + errorBody.error;
                            }
                            if (errorBody.errorType) {
                                errorMessage += '\n„Ç®„É©„Éº„Çø„Ç§„Éó: ' + errorBody.errorType;
                            }
                            console.error('Full error context:', errorBody);
                        }
                    } catch (streamError) {
                        console.error('Error reading error details:', streamError);
                    }
                }
                alert(errorMessage);
            } finally {
                hideLoading();
            }
        }

        // „Åä„Åô„Åô„ÇÅÁêÜÁî±„ÅÆÁ∑®ÈõÜ
        window.editRecommendationReason = function (recId) {
            console.log('Edit Recommendation Reason requested for ID:', recId);

            const rec = allRecommendations.find(r => r.id === recId) ||
                (typeof allRecommendationsCache !== 'undefined' ? allRecommendationsCache.find(r => r.id === recId) : null);

            if (!rec) {
                console.error('Data not found for ID:', recId);
                alert('„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            const currentReason = rec.reason || rec.match_reason || '';

            // Êó¢Â≠ò„ÅÆ„É¢„Éº„ÉÄ„É´„Åå„ÅÇ„Çå„Å∞ÂâäÈô§
            $('#dynamic-edit-rec-modal').remove();

            // „É¢„Éº„ÉÄ„É´HTML„ÇíÂÆöÁæ©
            const modalHtml = `
            <div id="dynamic-edit-rec-modal"
                class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4" 
                style="z-index: 9999999 !important; position: fixed !important; top:0; left:0; width:100%; height:100%;">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden transform transition-all" onclick="event.stopPropagation()">
                    <div class="bg-indigo-600 px-6 py-4 flex justify-between items-center text-white">
                        <h3 class="text-lg font-bold flex items-center gap-2 m-0">
                            <i class="fas fa-edit"></i> „Åä„Åô„Åô„ÇÅÁêÜÁî±„ÅÆÁ∑®ÈõÜ
                        </h3>
                        <button onclick="$('#dynamic-edit-rec-modal').remove()" class="text-white hover:text-indigo-200 transition-colors text-2xl border-none bg-transparent cursor-pointer">&times;</button>
                    </div>

                    <div class="p-6">
                        <input type="hidden" id="edit-rec-reason-id" value="${recId}">
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">„Åä„Åô„Åô„ÇÅÁêÜÁî±„ÅÆÂÖ•Âäõ</label>
                            <textarea id="edit-rec-reason-text" rows="10" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-800 leading-relaxed transition-all"
                                placeholder="${rec.score >= 50 ? '„Åä„Åô„Åô„ÇÅ„ÅÆÁêÜÁî±„ÇíË©≥„Åó„ÅèÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ...' : '‰∏ç‰∏ÄËá¥„ÅÆÁêÜÁî±„ÇíÂÖ∑‰ΩìÁöÑ„Å´ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ...'}">${currentReason}</textarea>
                            <p class="mt-2 text-xs text-gray-500">‚Äª‰øùÂ≠ò„Åï„Çå„Çã„Å®Ê±ÇËÅ∑ËÄÖÁîªÈù¢„Å´„ÇÇÂç≥ÊôÇÂèçÊò†„Åï„Çå„Åæ„Åô„ÄÇ</p>
                        </div>

                        <div class="flex justify-end gap-3 mt-8">
                            <button onclick="$('#dynamic-edit-rec-modal').remove()" 
                                class="px-6 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium transition-colors cursor-pointer bg-white">„Ç≠„É£„É≥„Çª„É´</button>
                            <button onclick="saveRecommendationReason()" 
                                class="px-8 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold shadow-md transition-all cursor-pointer border-none">Â§âÊõ¥„Çí‰øùÂ≠ò„Åô„Çã</button>
                        </div>
                    </div>
                </div>
            </div>`;

            $('body').append(modalHtml);
            console.log('Dynamic modal created and added to body. Displaying now.');
        }

        window.closeEditRecReasonModal = function () {
            $('#dynamic-edit-rec-modal').remove();
            // Âøµ„ÅÆ„Åü„ÇÅÊóßID„ÅÆÊñπ„ÇÇÊ∂à„Åô
            $('#edit-recommendation-reason-modal').addClass('hidden').attr('style', 'display: none !important;');
        }

        window.saveRecommendationReason = async function () {
            const recId = $('#edit-rec-reason-id').val();
            const newReason = $('#edit-rec-reason-text').val();

            showLoading();
            try {
                const user = window.currentUser;

                const { error } = await supabase
                    .from('recommendations')
                    .update({
                        reason: newReason,
                        recommended_by: user.id,
                        match_type: 'manual'
                    })
                    .eq('id', recId);

                if (error) throw error;

                alert('„Åä„Åô„Åô„ÇÅÁêÜÁî±„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');

                // „Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÊõ¥Êñ∞
                const rec = allRecommendations.find(r => r.id === recId) ||
                    (typeof allRecommendationsCache !== 'undefined' ? allRecommendationsCache.find(r => r.id === recId) : null);
                if (rec) {
                    rec.reason = newReason;
                    rec.recommended_by = user.id;
                }

                closeEditRecReasonModal();
                // ÂÜçÊèèÁîª
                renderRecommendations();
            } catch (error) {
                console.error('Update reason error:', error);
                alert('Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Êé®Ëñ¶ÁµêÊûú„ÅÆ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        window.filterRecommendations = function (userId) {
            currentSelectedUserId = userId;
            currentRecommendationPage = 1; // „Éö„Éº„Ç∏Áï™Âè∑„Çí„É™„Çª„ÉÉ„Éà
            // ÂÜç„É¨„É≥„ÉÄ„É™„É≥„Ç∞„Çí„Éà„É™„Ç¨„Éº„Åó„Å¶„ÄÅ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞„É≠„Ç∏„ÉÉ„ÇØ„ÇíÈÅ©Áî®
            renderRecommendations(allRecommendations, isAdminOrCoachView, allCandidatesList, appliedJobIdsCache);
        }

        window.generateAIRecommendations = async function () {
            if (!confirm('AIÂàÜÊûê„ÇíÈñãÂßã„Åó„Åæ„Åô„ÅãÔºüÔºà„Åì„Çå„Å´„ÅØÊï∞Áßí„Åã„Åã„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„ÅôÔºâ')) return

            showLoading()
            try {
                // 1. Ê±Ç‰∫∫„Éá„Éº„Çø„ÇíÂèñÂæó
                const { data: jobs } = await supabase
                    .from('jobs')
                    .select('*')
                    .eq('organization_id', currentUser.organization_id)
                    .eq('status', 'active')

                if (!jobs || jobs.length === 0) throw new Error('ÂàÜÊûêÂØæË±°„ÅÆÊ±Ç‰∫∫„Åå„ÅÇ„Çä„Åæ„Åõ„Çì')

                // 2. „É¶„Éº„Ç∂„Éº„Éó„É≠„Éï„Ç£„Éº„É´ÔºàDB„Åã„ÇâÂèñÂæóÔºâ
                const userProfile = `
                Â∏åÊúõËÅ∑Á®Æ: ${currentUser.desired_job_type || 'Êú™Ë®≠ÂÆö'}
                Â∏åÊúõÂã§ÂãôÂã§ÂãôÂú∞: ${currentUser.desired_location || 'Êú™Ë®≠ÂÆö'}
                „Çπ„Ç≠„É´: ${currentUser.skills || 'Êú™Ë®≠ÂÆö'}
                ËÅ∑Ê≠¥„ÉªËá™Â∑±PR: ${currentUser.work_history || 'Êú™Ë®≠ÂÆö'}
                `

                // 3. Edge Function Âëº„Å≥Âá∫„Åó
                // „Çµ„Éº„Éê„Éº„Çµ„Ç§„Éâ„ÅßGemini API„ÇíÂÆüË°å„Åó„ÄÅAPI„Ç≠„Éº„ÇíÈö†ËîΩ„Åó„Åæ„Åô
                const { data: recommendations, error: functionError } = await supabase.functions.invoke('score-ai-recommendations', {
                    body: {
                        userProfile,
                        jobs: jobs.map(j => ({ id: j.id, title: j.title, description: j.description }))
                    }
                })

                if (functionError) {
                    throw functionError
                }

                if (!recommendations || recommendations.length === 0) {
                    throw new Error('AI„Åã„Çâ„ÅÆÂøúÁ≠î„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„Åß„Åó„ÅüÔºàÂÄôË£ú„Å™„ÅóÔºâ')
                }

                // 4. „Éá„Éº„Çø„Éô„Éº„Çπ„Å´‰øùÂ≠òÔºàupsertÊñπÂºèÔºöÊó¢Â≠ò„ÅØÊõ¥Êñ∞„ÄÅÊñ∞Ë¶è„ÅØËøΩÂä†Ôºâ
                for (const rec of recommendations) {
                    // Êó¢Â≠ò„ÅÆ„É¨„Ç≥„Éº„Éâ„ÇíÁ¢∫Ë™ç
                    const { data: existing } = await supabase
                        .from('recommendations')
                        .select('id')
                        .eq('user_id', currentUser.id)
                        .eq('job_id', rec.job_id)
                        .maybeSingle();

                    if (existing) {
                        // Êó¢Â≠ò„É¨„Ç≥„Éº„Éâ„ÇíÊõ¥Êñ∞
                        await supabase
                            .from('recommendations')
                            .update({
                                score: rec.score,
                                reason: rec.reason,
                                match_type: 'manual', // ÊâãÂãïÂÆüË°å„Å™„ÅÆ„Åßmanual„Å´
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', existing.id);
                    } else {
                        // Êñ∞Ë¶è„É¨„Ç≥„Éº„Éâ„ÇíÊåøÂÖ•
                        await supabase.from('recommendations').insert({
                            organization_id: currentUser.organization_id,
                            user_id: currentUser.id,
                            job_id: rec.job_id,
                            score: rec.score,
                            reason: rec.reason,
                            match_type: 'manual' // ÊâãÂãïÂÆüË°å
                        });
                    }
                }

                alert('AIÂàÜÊûê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ')
                loadRecommendations()
                loadDashboard()

            } catch (error) {
                console.error('AI generation error:', error)
                alert('AIÂàÜÊûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message)
            } finally {
                hideLoading()
            }
        }

        // ========================
        // Êé®Ëñ¶„É°„ÉÉ„Çª„Éº„Ç∏„Éª„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈñ¢ÈÄ£
        // ========================
        let currentTemplates = [];

        window.openRecommendationMessageModal = async function () {
            const checkboxes = $('.rec-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('„É°„ÉÉ„Çª„Éº„Ç∏„Å´Âê´„ÇÅ„ÇãÊ±Ç‰∫∫„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const targetUserIds = [...new Set(checkboxes.map((_, el) => $(el).data('user-id')).get())];
            if (targetUserIds.length > 1) {
                alert('Áï∞„Å™„ÇãÊ±ÇËÅ∑ËÄÖ„ÅÆÊ±Ç‰∫∫„ÅåÊ∑∑Âú®„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ„É°„ÉÉ„Çª„Éº„Ç∏‰ΩúÊàê„ÅØ1‰∫∫„ÅÆÊ±ÇËÅ∑ËÄÖ„Åî„Å®„Å´Ë°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            const targetUserId = targetUserIds[0];
            const targetUser = allCandidatesList.find(u => u.id === targetUserId);

            // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
            $('#recommendation-message-modal').removeClass('hidden');

            // „ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí„É≠„Éº„Éâ
            await loadEmailTemplates();

            // „É°„ÉÉ„Çª„Éº„Ç∏ÁîüÊàê
            generateRecommendationMessage();
        };

        window.closeRecommendationMessageModal = function () {
            $('#recommendation-message-modal').addClass('hidden');
        };

        window.loadEmailTemplates = async function () {
            try {
                const { data, error } = await supabase
                    .from('email_templates')
                    .select('*')
                    .eq('organization_id', currentUser.organization_id)
                    .order('is_default', { ascending: false })
                    .order('name');

                if (error) throw error;
                currentTemplates = data || [];

                // Êé®Ëñ¶„É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû„Éó„É´„ÉÄ„Ç¶„É≥
                const select = $('#message-template-select');
                if (select.length) {
                    select.empty();
                    currentTemplates.forEach(t => {
                        select.append(`<option value="${t.id}" ${t.is_default ? 'selected' : ''}>${t.name}</option>`);
                    });
                }

                // ÁÆ°ÁêÜÁîªÈù¢„ÅÆ„É™„Çπ„ÉàË°®Á§∫
                renderEmailTemplatesList();
            } catch (error) {
                console.error('Failed to load email templates:', error);
            }
        };

        window.applyMessageTemplate = function (templateId) {
            generateRecommendationMessage();
        };

        window.generateRecommendationMessage = function () {
            const checkboxes = $('.rec-checkbox:checked');
            const templateId = $('#message-template-select').val();
            const template = currentTemplates.find(t => t.id === templateId);

            if (!template) {
                $('#recommendation-message-body').val('„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const targetUserId = checkboxes.first().data('user-id');
            const targetUser = allCandidatesList.find(u => u.id === targetUserId);

            // ÈÅ∏Êäû„Åï„Çå„ÅüÊ±Ç‰∫∫Êé®Ëñ¶„Éá„Éº„Çø„ÇíÂèñÂæó
            const selectedRecIds = checkboxes.map((_, el) => $(el).val()).get();
            const selectedRecs = allRecommendations.filter(r => selectedRecIds.includes(r.id));

            // Â§âÊï∞„ÅÆÁµÑ„ÅøÁ´ã„Å¶
            let jobDetailsText = '';
            let jobListText = '';
            let reasonsText = '';

            selectedRecs.forEach((rec, idx) => {
                const job = rec.jobs;

                // URLÈ†ÖÁõÆ„ÅÆÂèñÂæóÂÖÉ„ÇíGoogle DriveÁî®„Ç´„É©„É†Ôºàpdf_urlÁ≠âÔºâ„Å´ÂÑ™ÂÖàÈ†Ü‰Ωç„ÇíÂ§âÊõ¥
                const orgSettings = getOrgSettings();
                let driveCol = orgSettings.drive_column || 'pdf_url';
                if (driveCol === 'pdf' || driveCol === 'url') driveCol = 'pdf_url';

                const driveUrl = job[driveCol] || job.url || 'URL„Å™„Åó';

                // AIÂá∫Âäõ„ÉÜ„Ç≠„Çπ„Éà„ÅÆÂèñÂæó„Å®„ÇØ„É™„Éº„Éã„É≥„Ç∞
                let fullText = rec.details || rec.reason || rec.recommendation_reason || rec.match_reason || '';

                // „ÉÑ„Éº„É´„É≠„Ç∞„ÅÆÈô§ÂéªÔºàÂøµ„ÅÆ„Åü„ÇÅ„Éï„É≠„É≥„Éà„Ç®„É≥„Éâ„Åß„ÇÇÂÆüÊñΩÔºâ
                const headerIndex = fullText.indexOf('„Éû„ÉÉ„ÉÅÂ∫¶Ë©ï‰æ°');
                if (headerIndex !== -1) fullText = fullText.substring(headerIndex);
                fullText = fullText.replace(/tool_code[\s\S]*?print\(.*?\)/g, '')
                    .replace(/thought\n[\s\S]*?(?=\n\n|\Z)/g, '')
                    .replace(/^```[\s\S]*?```/gm, '')
                    .trim();

                // ÂêÑË¶ÅÁ¥†„ÅÆÊäΩÂá∫
                let matchReason = '';
                let cultureGrade = '-';
                let cultureReason = '';

                // „Éû„ÉÉ„ÉÅÂ∫¶Âå∫Áîª„ÅÆÊäΩÂá∫
                const matchSectionMatch = fullText.match(/„Éû„ÉÉ„ÉÅÂ∫¶Ë©ï‰æ°([\s\S]*?)(?:Á§æÈ¢®„Éª„Ç´„É´„ÉÅ„É£„Éº|$)/);
                if (matchSectionMatch) {
                    const m = matchSectionMatch[1].match(/ÁêÜÁî±[:Ôºö]\s*([^\n]+)/);
                    if (m) matchReason = m[1].trim();
                } else {
                    // Âå∫Áîª„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÄÅÊúÄÂàù„ÅÆ„ÄåÁêÜÁî±:„Äç„ÇíÊé°Áî®
                    const m = fullText.match(/ÁêÜÁî±[:Ôºö]\s*([^\n]+)/);
                    if (m) matchReason = m[1].trim();
                }

                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ÂÖ®„ÅèÊäΩÂá∫„Åß„Åç„Å™„Åë„Çå„Å∞ÂÖ®Êñá„Çí‰ΩøÁî®Ôºà„Åü„Å†„ÅóÁü≠„ÇÅ„Å´„Åô„ÇãÔºâ
                if (!matchReason && fullText) {
                    matchReason = fullText.length > 100 ? fullText.substring(0, 100) + '...' : fullText;
                }

                // Á§æÈ¢®Âå∫Áîª„ÅÆÊäΩÂá∫
                const cultureSectionMatch = fullText.match(/Á§æÈ¢®„Éª„Ç´„É´„ÉÅ„É£„Éº„ÅÆ„Éï„Ç£„ÉÉ„ÉàÂ∫¶Ë©ï‰æ°([\s\S]*)/);
                if (cultureSectionMatch) {
                    const section = cultureSectionMatch[1];
                    const gm = section.match(/Ë©ï‰æ°[:Ôºö]\s*([A-E\-])/);
                    if (gm) cultureGrade = gm[1];
                    const rm = section.match(/ÁêÜÁî±[:Ôºö]\s*([^\n]+)/);
                    if (rm) cultureReason = rm[1].trim();
                }

                // 1. jobDetails (ÁêÜÊÉ≥„Éï„Ç©„Éº„Éû„ÉÉ„Éà)
                jobDetailsText += `Ê±Ç‰∫∫${idx + 1}\n`;
                jobDetailsText += `‰ºÅÊ•≠ÂêçÔºö ${job.company}\n`;
                jobDetailsText += `Ê±Ç‰∫∫ÂêçÔºö ${job.title}\n`;
                jobDetailsText += `„Éû„ÉÉ„ÉÅÂ∫¶Ôºö ${rec.score}ÁÇπ (${matchReason})\n`;
                jobDetailsText += `Á§æÈ¢®„Éû„ÉÉ„ÉÅÔºö ${cultureGrade} (${cultureReason})\n`;
                jobDetailsText += `Ë©≥Á¥∞URLÔºö ${driveUrl}\n\n`;

                // 2. jobList (ÁêÜÁî±„Å™„Åó)
                jobListText += `„ÄêÊ°à‰ª∂ ${idx + 1}„Äë ${job.company} / ${job.title}\n`;
                jobListText += `Ë©≥Á¥∞URL: ${driveUrl}\n\n`;

                // 3. recommendationReason (ÁêÜÁî±„ÅÆ„Åø„É™„Çπ„Éà - „Éû„ÉÉ„ÉÅÂ∫¶ÁêÜÁî±„Çí‰ΩøÁî®)
                if (matchReason) {
                    if (selectedRecs.length > 1) {
                        reasonsText += `‚ñ† ${job.company} (${job.title})\n${matchReason}\n\n`;
                    } else {
                        reasonsText = matchReason;
                    }
                }
            });

            // Â§âÊï∞ÁΩÆÊèõ
            const rawUserName = targetUser ? targetUser.name || 'Ê±ÇËÅ∑ËÄÖ' : 'Ê±ÇËÅ∑ËÄÖ';
            const cleanUserName = rawUserName.replace(/Êßò$/, '');

            const body = template.body_template
                .replace(/{{userName}}/g, cleanUserName)
                .replace(/{{agentName}}/g, currentUser.name || '')
                .replace(/{{jobDetails}}/g, jobDetailsText.trim())
                .replace(/{{jobList}}/g, jobListText.trim())
                .replace(/{{jobDetailsCount}}/g, selectedRecs.length)
                .replace(/{{recommendationReason}}/g, reasonsText.trim());

            $('#recommendation-message-body').val(body);
        };

        window.copyRecommendationMessage = function () {
            const body = $('#recommendation-message-body').val();
            if (!body) return;
            navigator.clipboard.writeText(body).then(() => {
                alert('„É°„ÉÉ„Çª„Éº„Ç∏„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
            });
        };

        window.sendRecommendationEmail = async function () {
            const checkboxes = $('.rec-checkbox:checked');
            const targetUserId = checkboxes.first().data('user-id');
            const body = $('#recommendation-message-body').val();
            const templateId = $('#message-template-select').val();
            const template = currentTemplates.find(t => t.id === templateId);

            if (!body) {
                alert('„É°„ÉÉ„Çª„Éº„Ç∏ÂÜÖÂÆπ„ÅåÁ©∫„Åß„Åô');
                return;
            }

            // Ê±ÇËÅ∑ËÄÖÊÉÖÂ†±„ÇíÂèñÂæó
            const { data: user, error } = await supabase
                .from('users')
                .select('name, email')
                .eq('id', targetUserId)
                .single();

            if (error || !user || !user.email) {
                alert('ÂÄôË£úËÄÖ„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åõ„Çì„ÄÇ');
                return;
            }

            if (!confirm(`${user.name} „Åï„ÇìÔºà${user.email}Ôºâ„Å´„Åì„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„Çí„É°„Éº„É´„ÅßÈÄÅ‰ø°„Åó„Åæ„Åô„ÅãÔºü`)) {
                return;
            }

            $('#send-recommendation-email-btn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>ÈÄÅ‰ø°‰∏≠...');

            try {
                // sendEmail(type, to, data)
                const success = await sendEmail('recommendation', user.email, {
                    userName: user.name,
                    subject: template.subject || '„ÄêÊ±Ç‰∫∫„ÅÆ„ÅîÁ¥π‰ªã„Äë',
                    body: body,
                    scoutUrl: 'https://rightjob2025.github.io/matching/index-supabase.html'
                });

                if (success) {
                    alert('„É°„Éº„É´„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ');
                    closeRecommendationMessageModal();
                } else {
                    alert('„É°„Éº„É´„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
                }
            } catch (error) {
                console.error('Email send error:', error);
                alert('ÈÄÅ‰ø°‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            } finally {
                $('#send-recommendation-email-btn').prop('disabled', false).html('<i class="fas fa-paper-plane mr-2"></i>ÂÄôË£úËÄÖ„Å∏„É°„Éº„É´ÈÄÅ‰ø°');
            }
        };

        // „ÉÜ„É≥„Éó„É¨„Éº„Éà„É™„Çπ„ÉàË°®Á§∫ÔºàÁÆ°ÁêÜÁîªÈù¢Áî®Ôºâ
        window.renderEmailTemplatesList = function () {
            const container = $('#email-templates-list');
            if (!container.length) return;
            container.empty();

            if (currentTemplates.length === 0) {
                container.html('<div class="col-span-full py-12 text-center text-gray-500 bg-gray-50 border-2 border-dashed rounded-xl">„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</div>');
                return;
            }

            currentTemplates.forEach(t => {
                const card = `
                    <div class="bg-white border ${t.is_default ? 'border-indigo-600 ring-1 ring-indigo-600' : 'border-gray-200'} p-5 rounded-xl shadow-sm hover:shadow-md transition group">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-bold text-gray-900">${t.name}</h4>
                                ${t.is_default ? '<span class="inline-block mt-1 text-[10px] bg-indigo-100 text-indigo-700 font-bold px-2 py-0.5 rounded uppercase">„Éá„Éï„Ç©„É´„Éà</span>' : ''}
                            </div>
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition">
                                <button onclick="editEmailTemplate('${t.id}')" class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition" title="Á∑®ÈõÜ">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteEmailTemplate('${t.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="ÂâäÈô§">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 line-clamp-3 mb-4 leading-relaxed">${t.body_template.substring(0, 100)}...</p>
                        <div class="text-[10px] text-gray-400 border-t pt-3">
                            <i class="far fa-clock mr-1"></i>ÊúÄÁµÇÊõ¥Êñ∞: ${new Date(t.updated_at).toLocaleDateString()}
                        </div>
                    </div>
                `;
                container.append(card);
            });
        };

        window.openEmailTemplateModal = function (template = null) {
            $('#email-template-modal').removeClass('hidden');
            if (template) {
                $('#template-modal-title').text('„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÁ∑®ÈõÜ');
                $('#template-id').val(template.id);
                $('#template-name').val(template.name);
                $('#template-subject').val(template.subject);
                $('#template-body').val(template.body_template);
                $('#template-is-default').prop('checked', template.is_default);
            } else {
                $('#template-modal-title').text('Êñ∞Ë¶è„ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩúÊàê');
                $('#template-id').val('');
                $('#template-name').val('');
                $('#template-subject').val('');
                $('#template-body').val('');
                $('#template-is-default').prop('checked', currentTemplates.length === 0);
            }
        };

        window.closeEmailTemplateModal = function () {
            $('#email-template-modal').addClass('hidden');
        };

        window.editEmailTemplate = function (id) {
            const template = currentTemplates.find(t => t.id === id);
            if (template) openEmailTemplateModal(template);
        };

        window.saveEmailTemplate = async function () {
            const id = $('#template-id').val();
            const name = $('#template-name').val();
            const subject = $('#template-subject').val();
            const body = $('#template-body').val();
            const isDefault = $('#template-is-default').prop('checked');

            if (!name || !body) {
                alert('„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂêç„Å®Êú¨Êñá„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            showLoading();
            try {
                // „Éá„Éï„Ç©„É´„Éà„ÅÆËß£Èô§Ôºà„Åù„ÅÆÁµÑÁπîÂÜÖ„Åß‰∏Ä„Å§„Å†„Åë„Å´Âà∂ÈôêÔºâ
                if (isDefault) {
                    await supabase
                        .from('email_templates')
                        .update({ is_default: false })
                        .eq('organization_id', currentUser.organization_id);
                }

                const data = {
                    organization_id: currentUser.organization_id,
                    name: name,
                    subject: subject,
                    body_template: body,
                    is_default: isDefault,
                    updated_at: new Date().toISOString()
                };

                let error;
                if (id) {
                    const { error: err } = await supabase.from('email_templates').update(data).eq('id', id);
                    error = err;
                } else {
                    const { error: err } = await supabase.from('email_templates').insert(data);
                    error = err;
                }

                if (error) throw error;

                alert('‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
                closeEmailTemplateModal();
                loadEmailTemplates();
            } catch (error) {
                console.error('Error saving template:', error);
                alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            } finally {
                hideLoading();
            }
        };

        window.deleteEmailTemplate = async function (id) {
            if (!confirm('„Åì„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) return;

            showLoading();
            try {
                const { error } = await supabase.from('email_templates').delete().eq('id', id);
                if (error) throw error;
                loadEmailTemplates();
            } catch (error) {
                console.error('Error deleting template:', error);
                alert('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            } finally {
                hideLoading();
            }
        };

        // ========================
        // Profile
        // ========================

        async function loadMasterDataForProfile(user) {
            try {
                // Select2„ÅÆÂàùÊúüÂåñ„ÅØ„Ç™„Éó„Ç∑„Éß„É≥ËøΩÂä†Âæå„Å´Ë°å„ÅÜ„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅØÂâäÈô§
                /*
                $('.select2').select2({
                    language: "ja",
                    width: 'resolve'
                });
                */

                // ÈÉΩÈÅìÂ∫úÁúå„ÅÆË®≠ÂÆö
                const setPrefectureOptions = (selector) => {
                    const select = $(selector);
                    select.empty().append('<option value="">ÈÉΩÈÅìÂ∫úÁúå</option>');
                    prefectures.forEach(pref => {
                        select.append(`<option value="${pref}">${pref}</option>`);
                    });
                };
                setPrefectureOptions('#profile-prefecture');
                setPrefectureOptions('#reg-prefecture');
                setPrefectureOptions('#admin-user-prefecture');

                // „Éû„Çπ„Çø„Éá„Éº„Çø„ÅåÊú™„É≠„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØ„É≠„Éº„Éâ„Åô„Çã
                if (masterJobCategories.length === 0 || masterIndustries.length === 0) {
                    await initMasterDataDropdowns();
                }

                // ÈõáÁî®ÂΩ¢ÊÖã„ÇíÂèñÂæó („Ç≠„É£„ÉÉ„Ç∑„É•„Åæ„Åü„ÅØmaster_data„Åã„Çâ)
                let validMasters;

                if (masterDataCache.isValid() && masterDataCache.employmentTypes) {
                    console.log('Using cached employment types');
                    validMasters = masterDataCache.employmentTypes;
                } else {
                    console.log('Fetching employment types from database');

                    const { data: masters, error } = await supabase
                        .from('master_data')
                        .select('type, label, value, organization_id, sort_order') // ÂøÖË¶Å„Å™„Ç´„É©„É†„ÅÆ„ÅøÂèñÂæó
                        .eq('type', 'employment_type')
                        .eq('is_active', true)
                        .order('sort_order')

                    if (error) throw error

                    // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞: Ëá™Á§æÂ∞ÇÁî®„Éá„Éº„Çø„ÇíÂÑ™ÂÖà„ÄÅ„Å™„Åë„Çå„Å∞„Ç∞„É≠„Éº„Éê„É´„Éá„Éº„Çø„Çí‰ΩøÁî®
                    // 1. „Åæ„ÅöËá™Á§æÂ∞ÇÁî®„ÅÆ„Éá„Éº„Çø„ÇíÂèñÂæó
                    const orgSpecific = masters.filter(m => m.organization_id === currentUser.organization_id);

                    // 2. „Ç∞„É≠„Éº„Éê„É´„Éá„Éº„Çø„ÇíÂèñÂæó
                    const globalData = masters.filter(m => m.organization_id === null);

                    // 3. Ëá™Á§æÂ∞ÇÁî®„Éá„Éº„Çø„ÅßÊó¢„Å´Â≠òÂú®„Åô„Çãlabel„ÇíË®òÈå≤ (value„Åß„ÅØ„Å™„Åèlabel„ÅßÂà§ÂÆö)
                    const orgSpecificLabels = new Set(orgSpecific.map(m => m.label));

                    // 4. „Ç∞„É≠„Éº„Éê„É´„Éá„Éº„Çø„Åã„Çâ„ÄÅËá™Á§æÂ∞ÇÁî®„Éá„Éº„Çø„Å®ÈáçË§á„Åó„Å™„ÅÑ„ÇÇ„ÅÆ„Å†„Åë„ÇíÂèñÂæó
                    const nonDuplicateGlobal = globalData.filter(m => !orgSpecificLabels.has(m.label));

                    // 5. Ëá™Á§æÂ∞ÇÁî®„Éá„Éº„Çø„Å®„Ç∞„É≠„Éº„Éê„É´„Éá„Éº„Çø„ÇíÁµêÂêà
                    validMasters = [...orgSpecific, ...nonDuplicateGlobal];

                    // „Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÊõ¥Êñ∞
                    masterDataCache.employmentTypes = validMasters;
                    if (!masterDataCache.lastUpdated) {
                        masterDataCache.lastUpdated = Date.now();
                    }
                }

                console.log('Employment types after filtering:', validMasters.map(m => `${m.label} (org: ${m.organization_id ? 'custom' : 'global'}, value: ${m.value})`));

                // ÈõáÁî®ÂΩ¢ÊÖã„ÅÆ„Éó„É´„ÉÄ„Ç¶„É≥ÁîüÊàê
                const empTargets = ['#profile-employment-type', '#reg-employment-type', '#admin-user-employment-type'];
                empTargets.forEach(s => {
                    const select = $(s);

                    // Select2„ÅåÊó¢„Å´ÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÁ†¥Ê£Ñ
                    if (select.hasClass("select2-hidden-accessible")) {
                        select.select2('destroy');
                    }

                    // „Ç™„Éó„Ç∑„Éß„É≥„Çí„ÇØ„É™„Ç¢„Åó„Å¶ÂÜçÁîüÊàê
                    select.empty();
                    validMasters.forEach(m => {
                        select.append(`<option value="${m.label}">${m.label}</option>`);
                    });
                });

                // ËÅ∑Á®Æ„Ç´„ÉÜ„Ç¥„É™„ÅÆ„Éó„É´„ÉÄ„Ç¶„É≥ÁîüÊàê (ÂÖ±ÈÄö„Éû„Çπ„Çø‰ΩøÁî®)
                const jobTargets = ['#profile-job-type', '#reg-job-type', '#admin-user-job-type'];
                jobTargets.forEach(s => {
                    const select = $(s);

                    // Select2„ÅåÊó¢„Å´ÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÁ†¥Ê£Ñ
                    if (select.hasClass("select2-hidden-accessible")) {
                        select.select2('destroy');
                    }

                    select.empty();
                    masterJobCategories.forEach(c => {
                        select.append(`<option value="${c}">${c}</option>`);
                    });
                });

                // Ê•≠Áïå„Ç´„ÉÜ„Ç¥„É™„ÅÆ„Éó„É´„ÉÄ„Ç¶„É≥ÁîüÊàê (ÂÖ±ÈÄö„Éû„Çπ„Çø‰ΩøÁî®)
                const indTargets = ['#profile-industry', '#reg-industry', '#admin-user-industry'];
                indTargets.forEach(s => {
                    const select = $(s);

                    // Select2„ÅåÊó¢„Å´ÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÁ†¥Ê£Ñ
                    if (select.hasClass("select2-hidden-accessible")) {
                        select.select2('destroy');
                    }

                    select.empty();
                    masterIndustries.forEach(i => {
                        select.append(`<option value="${i}">${i}</option>`);
                    });
                });

                // Select2„ÅÆÂàùÊúüÂåñÔºà„Ç™„Éó„Ç∑„Éß„É≥Ë®≠ÂÆöÂæå„Å´ÂÆüË°åÔºâ
                // Êó¢Â≠ò„ÅÆSelect2„Ç§„É≥„Çπ„Çø„É≥„Çπ„ÇíÁ†¥Ê£ÑÔºàselectË¶ÅÁ¥†„ÅÆ„ÅøÂØæË±°Ôºâ
                $('select.select2').each(function () {
                    if ($(this).hasClass("select2-hidden-accessible")) {
                        try {
                            $(this).select2('destroy');
                        } catch (e) {
                            console.warn('Failed to destroy Select2:', e);
                        }
                    }
                });

                // ÁÆ°ÁêÜËÄÖÁî®„Éï„Ç©„Éº„É†„ÅÆSelect2„ÅØÁâπÂà•„Å™Ë®≠ÂÆö„ÅåÂøÖË¶Å
                $('#admin-user-job-type, #admin-user-industry, #admin-user-employment-type, #admin-user-prefecture').select2({
                    language: "ja",
                    width: '100%',
                    closeOnSelect: false,
                    allowClear: true,
                    placeholder: 'ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'
                });

                // „Åù„ÅÆ‰ªñ„ÅÆSelect2„ÅØÊ®ôÊ∫ñË®≠ÂÆöÔºàselectË¶ÅÁ¥†„ÅÆ„ÅøÔºâ
                $('select.select2').not('#admin-user-job-type, #admin-user-industry, #admin-user-employment-type, #admin-user-prefecture').each(function () {
                    if (!$(this).hasClass("select2-hidden-accessible")) {
                        $(this).select2({
                            language: "ja",
                            width: 'resolve'
                        });
                    }
                });

                // „É¶„Éº„Ç∂„Éº„ÅÆÈÅ∏ÊäûÂÄ§„Çí„Çª„ÉÉ„Éà („Éó„É≠„Éï„Ç£„Éº„É´Á∑®ÈõÜÊôÇ„ÅÆ„Åø)
                if (user) {
                    console.log('Before parse:', user.desired_location, typeof user.desired_location);

                    // ÂÄ§„ÇíÊ≠£Ë¶èÂåñÔºàJSONÊñáÂ≠óÂàó„Å™„Çâ„Éë„Éº„Çπ„Åô„ÇãÔºâ
                    user.desired_job_type = window.safeParseList(user.desired_job_type);
                    user.desired_industry = window.safeParseList(user.desired_industry);
                    user.desired_employment_type = window.safeParseList(user.desired_employment_type);
                    user.desired_location = window.safeParseList(user.desired_location);

                    console.log('After parse:', user.desired_location, Array.isArray(user.desired_location));

                    const setSelect2Val = (selectId, val) => {
                        if (!val) return;
                        if (Array.isArray(val)) {
                            $(selectId).val(val).trigger('change');
                        } else {
                            const v = val.toString().includes(',') ? val.split(',') : [val];
                            $(selectId).val(v).trigger('change');
                        }
                    };

                    // „Éó„É≠„Éï„Ç£„Éº„É´„Éï„Ç©„Éº„É†
                    setSelect2Val('#profile-employment-type', user.desired_employment_type);
                    setSelect2Val('#profile-job-type', user.desired_job_type);
                    setSelect2Val('#profile-industry', user.desired_industry);

                    // ÁÆ°ÁêÜËÄÖÁî®„É¶„Éº„Ç∂„ÉºÁ∑®ÈõÜ„Éï„Ç©„Éº„É†
                    console.log('Setting admin user form values:', {
                        employment_type: user.desired_employment_type,
                        job_type: user.desired_job_type,
                        industry: user.desired_industry
                    });
                    setSelect2Val('#admin-user-employment-type', user.desired_employment_type);
                    setSelect2Val('#admin-user-job-type', user.desired_job_type);
                    setSelect2Val('#admin-user-industry', user.desired_industry);

                    // ÂÄ§„ÅåÊ≠£„Åó„Åè„Çª„ÉÉ„Éà„Åï„Çå„Åü„ÅãÁ¢∫Ë™ç
                    setTimeout(() => {
                        console.log('Verification - Values after setting:', {
                            employment_type: $('#admin-user-employment-type').val(),
                            job_type: $('#admin-user-job-type').val(),
                            industry: $('#admin-user-industry').val()
                        });
                    }, 50);

                    // Âã§ÂãôÂú∞„ÅÆÂàÜÂâ≤„Çª„ÉÉ„Éà
                    if (user.desired_location) {
                        let locations = Array.isArray(user.desired_location) ? user.desired_location : [user.desired_location];

                        // Ë¶ÅÁ¥†ÂÜÖ„Å´„Çπ„É©„ÉÉ„Ç∑„É•„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÂ±ïÈñã„Åô„Çã (‰æã: ["A/B"] -> ["A", "B"])
                        let flatLocations = [];
                        locations.forEach(loc => {
                            if (typeof loc === 'string') {
                                // ÂçäËßí/ÂÖ®Ëßí„Çπ„É©„ÉÉ„Ç∑„É•„ÄÅ„Ç´„É≥„Éû„ÄÅË™≠ÁÇπ„ÄÅ„Çπ„Éö„Éº„Çπ„ÅßÂàÜÂâ≤
                                const parts = loc.split(/[\/\uff0f,„ÄÅ\s]+/).map(s => s.trim()).filter(s => s);
                                if (parts.length > 0) {
                                    flatLocations.push(...parts);
                                } else {
                                    flatLocations.push(loc);
                                }
                            } else {
                                flatLocations.push(loc);
                            }
                        });
                        locations = flatLocations;
                        console.log('Flat locations:', locations);

                        const matchedPrefs = [];
                        const unmatched = [];

                        locations.forEach(loc => {
                            // "Êù±‰∫¨ÈÉΩ" or "Êù±‰∫¨ÈÉΩxxxÂå∫" „ÅÆÂ†¥Âêà„ÄÅ"Êù±‰∫¨ÈÉΩ" „ÇíÊäΩÂá∫„Åó„Å¶„Éû„ÉÉ„ÉÅ„Åï„Åõ„Çã
                            let found = false;
                            for (const pref of prefectures) {
                                if (loc === pref || loc.startsWith(pref)) {
                                    if (!matchedPrefs.includes(pref)) {
                                        matchedPrefs.push(pref);
                                    }
                                    const rest = loc.substring(pref.length);
                                    if (rest) unmatched.push(rest);
                                    found = true;
                                    break;
                                }
                            }
                            if (!found) {
                                unmatched.push(loc);
                            }
                        });

                        console.log('Matched Prefs:', matchedPrefs);
                        console.log('Unmatched:', unmatched);

                        // „Éó„É´„ÉÄ„Ç¶„É≥„Å´„Çª„ÉÉ„ÉàÔºàË§áÊï∞ÈÅ∏ÊäûÔºâ
                        $('#profile-prefecture').val(matchedPrefs).trigger('change');
                        $('#admin-user-prefecture').val(matchedPrefs).trigger('change');

                        // ÊÆã„Çä„Çí„ÉÜ„Ç≠„Çπ„Éà„Éú„ÉÉ„ÇØ„Çπ„Å´„Çª„ÉÉ„Éà
                        console.log('Finalizing location sets...');
                        const restStr = unmatched.join(' / ');
                        $('#profile-city').val(restStr);
                        $('#admin-user-city').val(restStr);

                        // ÊÄßÂà•„Å®Áèæ‰ΩèÊâÄ„ÅÆ„Çª„ÉÉ„Éà
                        $('#profile-gender').val(user.gender || '');
                        $('#admin-user-gender').val(user.gender || '');

                        // ÈÉΩÈÅìÂ∫úÁúå„Éó„É´„ÉÄ„Ç¶„É≥„ÅÆÂàùÊúüÂåñ (Áèæ‰ΩèÊâÄÁî®)
                        const prefSelects = $('#profile-current-location, #admin-user-current-location');
                        prefSelects.empty().append('<option value="">ÈÉΩÈÅìÂ∫úÁúå„ÇíÈÅ∏Êäû</option>');
                        prefectures.forEach(p => {
                            prefSelects.append(`<option value="${p}">${p}</option>`);
                        });
                        $('#profile-current-location').val(user.current_location || '');
                        $('#admin-user-current-location').val(user.current_location || '');

                    }
                    console.log('loadMasterDataForProfile: Done');
                }

            } catch (error) {
                console.error('Load profile master error:', error);
                throw error;
            }
        }
        // „Åä„Åô„Åô„ÇÅÂØæË±°Â§ñ‰ºÅÊ•≠„ÅÆÁÆ°ÁêÜ
        let currentExcludedCompanies = [];

        window.handleExcludedCompanySearch = async function (searchText, isAdmin = false) {
            const resultSelector = isAdmin ? '#admin-excluded-company-results' : '#excluded-company-results';
            const $results = $(resultSelector);
            if (!searchText || searchText.length < 1) {
                $results.addClass('hidden').empty();
                return;
            }

            try {
                const { data: companies, error } = await supabase
                    .from('companies')
                    .select('id, name')
                    .eq('organization_id', currentUser.organization_id)
                    .ilike('name', `%${searchText}%`)
                    .is('deleted_at', null)
                    .limit(5);

                if (error) throw error;

                if (companies && companies.length > 0) {
                    $results.empty().removeClass('hidden');
                    companies.forEach(company => {
                        const isAlreadyAdded = currentExcludedCompanies.some(ec => ec.company_id === company.id);
                        const onClickAction = isAdmin ? `addAdminExcludedCompany('${company.id}', '${company.name.replace(/'/g, "\\'")}')` : `addExcludedCompany('${company.id}', '${company.name.replace(/'/g, "\\'")}')`;
                        $results.append(`
                            <div onclick="${onClickAction}" 
                                class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm flex justify-between items-center ${isAlreadyAdded ? 'opacity-50 pointer-events-none' : ''}">
                                <span>${company.name}</span>
                                ${isAlreadyAdded ? '<span class="text-[10px] bg-gray-200 px-1 rounded">ÁôªÈå≤Ê∏à„Åø</span>' : '<i class="fas fa-plus text-indigo-500 text-xs"></i>'}
                            </div>
                        `);
                    });
                } else {
                    $results.html('<div class="px-4 py-3 text-sm text-gray-500 text-center">Ë©≤ÂΩì„Åô„Çã‰ºÅÊ•≠„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</div>').removeClass('hidden');
                }
            } catch (error) {
                console.error('Excluded company search error:', error);
            }
        };

        window.handleAdminExcludedCompanySearch = function (text) {
            handleExcludedCompanySearch(text, true);
        };

        window.addExcludedCompany = async function (companyId, companyName, targetUserId = null) {
            const userId = targetUserId || currentUser.id;
            const isAdminAction = !!targetUserId;

            try {
                showLoading('Êõ¥Êñ∞‰∏≠...');
                const { error } = await supabase
                    .from('excluded_companies')
                    .insert({
                        user_id: userId,
                        company_id: companyId,
                        organization_id: currentUser.organization_id
                    });

                if (error) {
                    if (error.code === '23505') {
                        alert('„Åì„ÅÆ‰ºÅÊ•≠„ÅØÊó¢„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
                    } else {
                        throw error;
                    }
                } else {
                    if (isAdminAction) {
                        $('#admin-excluded-company-search-input').val('');
                        $('#admin-excluded-company-results').addClass('hidden');
                    } else {
                        $('#excluded-company-search-input').val('');
                        $('#excluded-company-results').addClass('hidden');
                    }
                    await loadExcludedCompanies(userId, isAdminAction);
                }
            } catch (error) {
                console.error('Add excluded company error:', error);
                alert('ÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            } finally {
                hideLoading();
            }
        };

        window.addAdminExcludedCompany = function (companyId, companyName) {
            const targetUserId = $('#admin-user-id').val();
            addExcludedCompany(companyId, companyName, targetUserId);
        };

        window.removeExcludedCompany = async function (id, isAdminAction = false) {
            if (!confirm('„Åì„ÅÆ‰ºÅÊ•≠„Çí„Åä„Åô„Åô„ÇÅÂØæË±°Â§ñ„Åã„ÇâËß£Èô§„Åó„Åæ„Åô„ÅãÔºü')) return;

            try {
                showLoading('Ëß£Èô§‰∏≠...');
                const { error } = await supabase
                    .from('excluded_companies')
                    .delete()
                    .eq('id', id);

                if (error) throw error;
                const userId = isAdminAction ? $('#admin-user-id').val() : currentUser.id;
                await loadExcludedCompanies(userId, isAdminAction);
            } catch (error) {
                console.error('Remove excluded company error:', error);
                alert('Ëß£Èô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            } finally {
                hideLoading();
            }
        };

        window.loadExcludedCompanies = async function (userId, isAdminAction = false) {
            try {
                const { data, error } = await supabase
                    .from('excluded_companies')
                    .select('id, company_id, companies(name)')
                    .eq('user_id', userId);

                if (error) throw error;

                currentExcludedCompanies = data || [];
                renderExcludedCompanies(isAdminAction);
            } catch (error) {
                console.error('Load excluded companies error:', error);
            }
        };

        window.renderExcludedCompanies = function (isAdminAction = false) {
            const containerSelector = isAdminAction ? '#admin-excluded-companies-tags' : '#excluded-companies-tags';
            const $container = $(containerSelector);
            $container.empty();

            if (currentExcludedCompanies.length === 0) {
                $container.html('<span class="text-xs text-gray-400">ÁèæÂú®„ÄÅÂØæË±°Â§ñ„Å®„Åó„Å¶ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Çã‰ºÅÊ•≠„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</span>');
                return;
            }

            currentExcludedCompanies.forEach(ec => {
                const name = ec.companies?.name || '‰∏çÊòé„Å™‰ºÅÊ•≠';
                const removeAction = isAdminAction ? `removeExcludedCompany('${ec.id}', true)` : `removeExcludedCompany('${ec.id}')`;
                $container.append(`
                    <span class="inline-flex items-center gap-1.5 px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs font-medium border border-red-200">
                        ${name}
                        <button type="button" onclick="${removeAction}" class="hover:text-red-900 transition">
                            <i class="fas fa-times"></i>
                        </button>
                    </span>
                `);
            });
        };

        async function loadProfile() {
            if (!currentUser) return

            showLoading()
            try {
                // users„ÉÜ„Éº„Éñ„É´„Å®candidate_profiles„ÇíÁµêÂêà„Åó„Å¶ÂèñÂæó
                const { data: userData, error } = await supabase
                    .from('users')
                    .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                    .eq('id', currentUser.id)
                    .single()

                if (error) throw error

                // „Éï„É©„ÉÉ„ÉàÂåñÔºà„Éó„É≠„Éï„Ç£„Éº„É´„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥ÂêàÔºâ
                const profile = Array.isArray(userData.candidate_profiles) ? userData.candidate_profiles[0] : userData.candidate_profiles;
                const user = { ...userData, ...profile };
                user.id = userData.id;

                // Update local currentUser cache
                currentUser = user

                // „Éû„Çπ„Çø„Éá„Éº„Çø„É≠„Éº„Éâ & ÂÄ§„Çª„ÉÉ„Éà
                await loadMasterDataForProfile(user);

                // ÂØæË±°Â§ñ‰ºÅÊ•≠„É≠„Éº„Éâ (New)
                await loadExcludedCompanies(currentUser.id);

                // Fill form
                $('#profile-name').val(user.name)
                $('#profile-furigana').val(user.furigana || '')
                $('#profile-email').val(user.email)
                $('#profile-phone').val(user.phone || '')
                $('#profile-birth-date').val(user.birth_date || '')
                $('#profile-age').val(user.age || '')

                // ËÅ∑Á®Æ„ÄÅÊ•≠Áïå„ÄÅÈõáÁî®ÂΩ¢ÊÖã„ÄÅÂã§ÂãôÂú∞„ÅØ loadMasterDataForProfile „Åß„Çª„ÉÉ„ÉàÊ∏à„Åø

                $('#profile-salary').val(user.desired_salary ? Math.floor(user.desired_salary / 10000) : '')
                $('#profile-freewords').val('');
                if (window.populateFreewordTags) {
                    window.populateFreewordTags(user.desired_freewords || '', 'profile-freewords-tags');
                }
                $(`input[name="profile-freewords-condition"][value="${user.desired_freewords_condition || 'and'}"]`).prop('checked', true)
                $('#profile-enable-auto-recommendations').prop('checked', !!user.enable_auto_recommendations); // Default false

                $('#profile-skills').val(user.skills || '')
                $('#profile-history').val(user.work_history || '')
                $('#profile-work-history-detail').val(user.work_history_detail || '')
                $('#profile-history-info').val(user.history_info || '')

                $('#profile-current-salary').val(user.current_salary ? user.current_salary / 10000 : '')
                $('#profile-academic').val(user.education || user.academic_background || '')
                $('#profile-languages').val(user.languages || '')
                $('#profile-certifications').val(user.certifications || '')
                $('#profile-start-date').val(user.available_start_date || '')

                // Ë©≥Á¥∞ËÅ∑Ê≠¥
                $('#profile-work-history-list').empty();
                if (user.work_history_structured && Array.isArray(user.work_history_structured)) {
                    user.work_history_structured.forEach(item => addWorkHistoryItemToContainer('#profile-work-history-list', item));
                }
                updateJobChangeCountInContainer('#profile-work-history-list', '#profile-job-change-count');

                // Á§æÂÜÖÁî®ÊÉÖÂ†±„ÅÆ„Çª„ÉÉ„Éà & Ë°®Á§∫Âà∂Âæ°
                $('#profile-drive-url').val(user.drive_folder_url || '')
                $('#profile-notebooklm-url').val(user.notebooklm_url || '')
                $('#profile-line-url').val(user.line_url || '')
                $('#profile-resume-detail').val(user.resume || '')
                $('#profile-notes').val(user.notes || '')

                if (['admin', 'org_admin', 'super_admin', 'coach', 'ca', 'ra'].includes(currentUser.role)) {
                    $('#internal-profile-info').removeClass('hidden')
                } else {
                    $('#internal-profile-info').addClass('hidden')
                }

            } catch (error) {
                console.error('Load profile error:', error)
                alert('„Éó„É≠„Éï„Ç£„Éº„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü')
            } finally {
                hideLoading()
            }
        }

        // Ëá™Âãï„Åä„Åô„Åô„ÇÅÊ±Ç‰∫∫„ÅÆÂç≥ÊôÇ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
        $(document).on('change', '#profile-enable-auto-recommendations', function () {
            if ($(this).is(':checked')) {
                const jobTypes = $('#profile-job-type').val();
                const prefs = $('#profile-prefecture').val();
                const city = $('#profile-city').val()?.trim();

                if (!jobTypes || jobTypes.length === 0 || ((!prefs || prefs.length === 0) && !city)) {
                    alert('Ëá™Âãï„Åä„Åô„Åô„ÇÅÊ±Ç‰∫∫„ÇíÊúâÂäπ„Å´„Åô„Çã„Å´„ÅØ„ÄÅ„ÄåÂ∏åÊúõËÅ∑Á®Æ„Äç„Å®„ÄåÂ∏åÊúõÂã§ÂãôÂú∞„Äç„ÇíÂÖà„Å´ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    $(this).prop('checked', false);
                }
            }
        });

        $('#profile-form').on('submit', async function (e) {
            e.preventDefault()

            // Ëá™Âãï„Åä„Åô„Åô„ÇÅÊ±Ç‰∫∫„ÅÆ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
            if ($('#profile-enable-auto-recommendations').is(':checked')) {
                const jobTypes = $('#profile-job-type').val();
                const prefs = $('#profile-prefecture').val();
                const city = $('#profile-city').val()?.trim();

                if (!jobTypes || jobTypes.length === 0) {
                    alert('AIËá™Âãï„Åä„Åô„Åô„ÇÅÊ±Ç‰∫∫„ÇíÊúâÂäπ„Å´„Åô„Çã„Å´„ÅØ„ÄÅ„ÄåÂ∏åÊúõËÅ∑Á®Æ„Äç„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    $('#profile-enable-auto-recommendations').focus();
                    return;
                }
                if ((!prefs || prefs.length === 0) && !city) {
                    alert('AIËá™Âãï„Åä„Åô„Åô„ÇÅÊ±Ç‰∫∫„ÇíÊúâÂäπ„Å´„Åô„Çã„Å´„ÅØ„ÄÅ„ÄåÂ∏åÊúõÂã§ÂãôÂú∞„Äç„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    $('#profile-enable-auto-recommendations').focus();
                    return;
                }
            }

            showLoading()

            const salaryNum = $('#profile-salary').val() ? parseInt($('#profile-salary').val()) * 10000 : null;

            // users„ÉÜ„Éº„Éñ„É´Êõ¥Êñ∞Áî®
            const userUpdates = {
                email: $('#profile-email').val().trim(),
                furigana: $('#profile-furigana').val().trim(),
                enable_auto_recommendations: $('#profile-enable-auto-recommendations').is(':checked'),
                updated_at: new Date().toISOString()
            }

            // candidate_profiles„ÉÜ„Éº„Éñ„É´Êõ¥Êñ∞Áî®
            const profileUpdates = {
                desired_job_type: $('#profile-job-type').val() ? $('#profile-job-type').val().join(',') : null,
                desired_industry: $('#profile-industry').val() ? $('#profile-industry').val().join(',') : null,
                desired_location: (() => {
                    const prefs = $('#profile-prefecture').val();
                    const city = $('#profile-city').val() || '';
                    if (Array.isArray(prefs) && prefs.length > 0) {
                        let loc = prefs.join(',');
                        if (city) {
                            if (prefs.length > 1) {
                                loc += ' ' + city;
                            } else {
                                loc = prefs[0] + city;
                            }
                        }
                        return loc;
                    } else if (prefs) {
                        return prefs + city;
                    }
                    return city || null;
                })(),
                desired_employment_type: $('#profile-employment-type').val() ? $('#profile-employment-type').val().join(',') : null,
                desired_salary: salaryNum,
                desired_freewords: window.getFreewordTagsText ? window.getFreewordTagsText('profile-freewords-tags') : $('#profile-freewords').val().trim(),
                desired_freewords_condition: $('input[name="profile-freewords-condition"]:checked').val() || 'and',
                desired_job_experience_ok: $('#profile-job-experience-ok').is(':checked'),
                desired_industry_experience_ok: $('#profile-industry-experience-ok').is(':checked'),
                skills: $('#profile-skills').val().trim(),
                work_history: $('#profile-history').val().trim(),
                work_history_detail: $('#profile-work-history-detail').val().trim(),
                history_info: $('#profile-history-info').val().trim(),
                current_salary: $('#profile-current-salary').val() ? parseInt($('#profile-current-salary').val()) * 10000 : null,
                education: $('#profile-academic').val().trim(),
                languages: $('#profile-languages').val().trim(),
                certifications: $('#profile-certifications').val().trim(),
                available_start_date: $('#profile-start-date').val() || null,
                birth_date: $('#profile-birth-date').val() || null,
                age: $('#profile-age').val() ? parseInt($('#profile-age').val()) : null,
                gender: $('#profile-gender').val() || null,
                current_location: $('#profile-current-location').val() || null,
                phone: $('#profile-phone').val().trim() || null,

                // Ë©≥Á¥∞ËÅ∑Ê≠¥„ÅÆÂèñÂæó
                work_history_structured: (() => {
                    const list = [];
                    $('#profile-work-history-list .work-history-item').each(function () {
                        list.push({
                            company_name: $(this).find('.wh-company').val(),
                            period: $(this).find('.wh-period').val(),
                            industry: $(this).find('.wh-industry').val(),
                            job_category: $(this).find('.wh-job-category').val(),
                            role: $(this).find('.wh-role').val(),
                            description: $(this).find('.wh-description').val()
                        });
                    });
                    return list;
                })(),
                job_change_count: parseInt($('#profile-job-change-count').val()) || 0,

                updated_at: new Date().toISOString()
            }

            // Á§æÂÜÖÁî®ÊÉÖÂ†±„ÅÆËøΩÂä† (Ê®©Èôê„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„Åø„ÄÅ‰∏î„Å§users/profiles„Å´ÂàÜÊï£„Åó„Å¶‰øùÂ≠ò)
            if (['admin', 'org_admin', 'super_admin', 'coach', 'ca', 'ra'].includes(currentUser.role)) {
                // users„ÉÜ„Éº„Éñ„É´ÂÅ¥
                userUpdates.drive_folder_url = $('#profile-drive-url').val().trim() || null;
                userUpdates.notebooklm_url = $('#profile-notebooklm-url').val().trim() || null;
                userUpdates.line_url = $('#profile-line-url').val().trim() || null;

                // profiles„ÉÜ„Éº„Éñ„É´ÂÅ¥
                profileUpdates.resume = $('#profile-resume-detail').val().trim() || null;
                profileUpdates.notes = $('#profile-notes').val().trim() || null;
            }

            try {
                // 1. users„ÉÜ„Éº„Éñ„É´Êõ¥Êñ∞
                const { error: userError } = await supabase
                    .from('users')
                    .update(userUpdates)
                    .eq('id', currentUser.id)

                if (userError) throw userError

                // 2. candidate_profiles„ÉÜ„Éº„Éñ„É´Êõ¥Êñ∞ (upsert)
                const { error: profileError } = await supabase
                    .from('candidate_profiles')
                    .upsert({ user_id: currentUser.id, ...profileUpdates }, { onConflict: 'user_id' });

                if (profileError) throw profileError

                // Update local cache
                Object.assign(currentUser, userUpdates, profileUpdates)

                alert('„Éó„É≠„Éï„Ç£„Éº„É´„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ')
            } catch (error) {
                console.error('Save profile error:', error)
                alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message)
            } finally {
                hideLoading()
            }
        })

        // ========================
        // Admin: Job Management
        // ========================
        let adminJobsCache = [];
        const ADMIN_JOBS_PER_PAGE = 20;
        let currentAdminJobPage = 1;
        let totalAdminJobPages = 1;

        async function loadCoachStudents() {
            if (!currentUser) {
                console.warn('loadCoachStudents: currentUser is null');
                return;
            }
            console.log('loadCoachStudents START', {
                userId: currentUser.id,
                role: currentUser.role,
                orgId: currentUser.organization_id
            });
            showLoading()
            try {
                // ÊãÖÂΩì„É¶„Éº„Ç∂„Éº„ÇíÂèñÂæó
                let studentQuery = supabase
                    .from('users')
                    .select('*')
                    .eq('coach_id', currentUser.id)
                    .eq('organization_id', currentUser.organization_id)
                    .order('created_at', { ascending: false });

                console.log('Executing studentQuery...');
                const { data: users, error } = await studentQuery;

                if (error) {
                    console.error('studentQuery error:', error);
                    throw error;
                }

                console.log(`Loaded ${users ? users.length : 0} assigned students`);
                renderCoachStudents(users || [])
            } catch (error) {
                console.error('Load students error:', error)
                alert('ÊãÖÂΩì„É¶„Éº„Ç∂„Éº„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (error.message || error));
            } finally {
                hideLoading()
            }
        }

        function renderCoachStudents(users) {
            console.log('renderCoachStudents START', users);
            const container = $('#coach-students-container')
            if (container.length === 0) {
                console.error('Error: #coach-students-container not found');
                return;
            }
            container.empty()

            if (!users || users.length === 0) {
                console.log('No assigned students to render');
                container.html('<tr><td colspan="4" class="px-6 py-8 text-center text-gray-500">ÊãÖÂΩì„É¶„Éº„Ç∂„Éº„Åå„ÅÑ„Åæ„Åõ„Çì</td></tr>')
                return
            }

            const html = users.map(u => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${u.name || 'ÂêçÂâç„Å™„Åó'}</div>
                        <div class="text-sm text-gray-500">${u.email || '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${u.created_at ? new Date(u.created_at).toLocaleDateString() : '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <!-- „Åì„Åì„Å´ÈÄ≤ÊçóÁä∂Ê≥ÅÔºàÂøúÂãüÊï∞„Å™„Å©Ôºâ„ÇíË°®Á§∫„Åß„Åç„Çã„Å®ËâØ„ÅÑ -->
                        -
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="viewCandidateProfile('${u.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">
                            Ë©≥Á¥∞
                        </button>
                    </td>
                </tr>
            `).join('')

            container.html(html)
            console.log('renderCoachStudents DONE');
        }

        // ========================
        // Admin: Job CSV Import
        // ========================
        window.showJobCsvImportModal = function () {
            console.log('DEBUG: showJobCsvImportModal called');
            $('#job-csv-file').val('');
            $('#job-csv-preview').addClass('hidden').empty();
            const $modal = $('#admin-job-csv-modal');
            // Ë¶ÅÁ¥†„Çíbody„Å∏ÁßªÂãïÔºà‰∫åÈáçÂØæÁ≠ñÔºâ
            $modal.appendTo('body');
            // Âº∑Âà∂ÁöÑ„Å´Ë°®Á§∫Áä∂ÊÖã„Å´„Åô„Çã
            $modal.removeClass('hidden').attr('style', 'display: flex !important; z-index: 100000 !important;');
            console.log('DEBUG: Modal visibility forced. visible check:', $modal.is(':visible'));
        }

        window.closeJobCsvImportModal = function () {
            $('#admin-job-csv-modal').addClass('hidden').attr('style', '');
        }

        window.downloadJobCsvTemplate = function (e) {
            e.preventDefault();

            if (typeof jobFields === 'undefined') {
                alert('„ÉÜ„É≥„Éó„É¨„Éº„ÉàÁîüÊàê„Ç®„É©„Éº: „Éï„Ç£„Éº„É´„ÉâÂÆöÁæ©„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }

            // „Éò„ÉÉ„ÉÄ„ÉºÁîüÊàê („Ç®„Ç§„É™„Ç¢„Çπ„ÅÆÂÖàÈ†≠„Çí‰ΩøÁî®„ÄÅ„Å™„Åë„Çå„Å∞„É©„Éô„É´)
            // „Åì„Çå„Å´„Çà„Çä„ÄÅËøΩÂä†„Åï„Çå„ÅüÂÖ®È†ÖÁõÆÔºàURL„ÄÅÁ¶èÂà©ÂéöÁîü„Å™„Å©Ôºâ„ÅåËá™ÂãïÁöÑ„Å´ÂèçÊò†„Åï„Çå„Çã
            const headers = jobFields.map(f => {
                const name = f.aliases && f.aliases.length > 0 ? f.aliases[0] : f.label;
                return `"${name}"`; // „ÇØ„Ç©„Éº„Éà„ÅßÂõ≤„ÇÄ
            });

            // „Çµ„É≥„Éó„É´„Éá„Éº„Çø1
            const sample1Values = jobFields.map(f => {
                switch (f.key) {
                    case 'title': return 'Ê≥ï‰∫∫Âñ∂Ê•≠„Éû„Éç„Éº„Ç∏„É£„Éº';
                    case 'company': return 'Ê†™Âºè‰ºöÁ§æABC';
                    case 'salary_min': return '600'; // ‰∏áÂÜÜ
                    case 'salary_max': return '900'; // ‰∏áÂÜÜ
                    case 'location': return 'Êù±‰∫¨ÈÉΩÊ∏ØÂå∫';
                    case 'description': return 'Âñ∂Ê•≠„ÉÅ„Éº„É†„ÅÆ„Éû„Éç„Ç∏„É°„É≥„Éà„ÄÅÊà¶Áï•Á´ãÊ°àÊ•≠Âãô„Çí„Åä‰ªª„Åõ„Åó„Åæ„Åô„ÄÇ';
                    case 'requirements': return 'Ê≥ï‰∫∫Âñ∂Ê•≠ÁµåÈ®ì5Âπ¥‰ª•‰∏ä';
                    case 'welcome_requirements': return '„Éû„Éç„Ç∏„É°„É≥„ÉàÁµåÈ®ì„Åå„ÅÇ„Çå„Å∞Â∞öÂèØ';
                    case 'work_hours': return '9:00 - 18:00';
                    case 'holidays': return 'ÂúüÊó•Á•ù„ÄÅÂπ¥Êú´Âπ¥Âßã';
                    case 'employment_type': return 'Ê≠£Á§æÂì°';
                    case 'benefits': return 'Á§æ‰ºö‰øùÈô∫ÂÆåÂÇô„ÄÅ‰∫§ÈÄöË≤ªÂÖ®È°çÊîØÁµ¶';
                    case 'is_remote': return 'ÂèØ'; // „Åæ„Åü„ÅØ '„ÅÇ„Çä', 'true'
                    case 'experience_level': return '„Éû„Éç„Ç∏„É°„É≥„ÉàÁµåÈ®ìËÄÖ';
                    case 'industry': return 'IT„ÉªÈÄö‰ø°';
                    case 'url': return 'https://example.com/recruit/sales-mgr';
                    case 'qualifications': return 'ÊôÆÈÄöËá™ÂãïËªäÂÖçË®±„ÄÅTOEIC 700ÁÇπ‰ª•‰∏ä';
                    case 'pdf_url': return 'https://drive.google.com/xxx';
                    case 'pdf_filename': return 'ÂãüÈõÜË¶ÅÈ†Ö.pdf';
                    case 'status': return 'active';
                    default: return '';
                }
            });
            const sample1 = sample1Values.map(v => `"${v}"`).join(',');

            // „Çµ„É≥„Éó„É´„Éá„Éº„Çø2
            const sample2Values = jobFields.map(f => {
                switch (f.key) {
                    case 'title': return 'Web„Ç®„É≥„Ç∏„Éã„Ç¢';
                    case 'company': return '„ÉÜ„ÉÉ„ÇØÊ†™Âºè‰ºöÁ§æ';
                    case 'salary_min': return '500';
                    case 'salary_max': return '800';
                    case 'location': return '„Éï„É´„É™„É¢„Éº„Éà';
                    case 'description': return 'Ëá™Á§æ„Çµ„Éº„Éì„Çπ„ÅÆWeb„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÈñãÁô∫„ÇíÊãÖÂΩì„Åó„Å¶„ÅÑ„Åü„Å†„Åç„Åæ„Åô„ÄÇ';
                    case 'requirements': return 'Java„Åß„ÅÆÈñãÁô∫ÁµåÈ®ì3Âπ¥‰ª•‰∏ä';
                    case 'welcome_requirements': return 'AWS„ÅÆÈÅãÁî®ÁµåÈ®ì';
                    case 'work_hours': return '„Éï„É¨„ÉÉ„ÇØ„Çπ„Çø„Ç§„É†Âà∂';
                    case 'holidays': return 'ÂÆåÂÖ®ÈÄ±‰ºë2Êó•Âà∂';
                    case 'employment_type': return 'Ê≠£Á§æÂì°';
                    case 'benefits': return 'Êõ∏Á±çË≥ºÂÖ•Ë£úÂä©„ÄÅ„É™„É¢„Éº„Éà„ÉØ„Éº„ÇØÊâãÂΩì';
                    case 'is_remote': return '„ÅØ„ÅÑ';
                    case 'experience_level': return 'ÂÆüÂãôÁµåÈ®ì3Âπ¥‰ª•‰∏ä';
                    case 'industry': return 'Web„Çµ„Éº„Éì„Çπ';
                    case 'url': return 'https://example.com/recruit/engineer';
                    case 'qualifications': return 'Java Silver‰ª•‰∏ä„Å™„Å©„ÅÆË≥áÊ†º';
                    case 'pdf_url': return '';
                    case 'pdf_filename': return '';
                    case 'status': return 'active';
                    default: return '';
                }
            });
            const sample2 = sample2Values.map(v => `"${v}"`).join(',');

            const csvContent = headers.join(',') + "\n" + sample1 + "\n" + sample2;
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "job_import_template.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.processJobCsvImport = function () {
            const fileInput = document.getElementById('job-csv-file');
            const file = fileInput.files[0];

            if (!file) {
                alert('CSV„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // ÂÖ±ÈÄö„ÅÆCSVÂá¶ÁêÜ„Éï„É≠„ÉºÔºà„Éû„ÉÉ„Éî„É≥„Ç∞„É¢„Éº„ÉÄ„É´Ë°®Á§∫Ôºâ„Å∏ÂßîË≠≤
            processCSVFile(file, 'jobs');

            // „Ç∑„É≥„Éó„É´„Å™„Ç§„É≥„Éù„Éº„Éà„É¢„Éº„ÉÄ„É´„ÅØÈñâ„Åò„Çã
            if (typeof closeJobCsvImportModal === 'function') {
                closeJobCsvImportModal();
            }
        }

        // window.executeCSVImport is defined below in the main CSV processing section


        window.exportJobsCsv = async function () {
            const searchText = $('#admin-job-search').val().trim();
            showLoading('„Éá„Éº„Çø„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà‰∏≠...');

            try {
                let query = supabase
                    .from('jobs')
                    .select('*, companies(name)')
                    .eq('organization_id', currentUser.organization_id)
                    .is('deleted_at', null);

                if (searchText) {
                    query = query.or(`title.ilike.%${searchText}%,company.ilike.%${searchText}%`);
                }

                query = query.order('created_at', { ascending: false }).limit(5000); // 5000‰ª∂„Åæ„Åß„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÂèØËÉΩ„Å´

                const { data: allJobs, error } = await query;

                if (error) throw error;

                if (!allJobs || allJobs.length === 0) {
                    alert('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                    return;
                }

                const csvData = allJobs.map(job => ({
                    title: job.title,
                    company: job.companies ? job.companies.name : job.company,
                    salary_min: job.salary_min,
                    salary_max: job.salary_max,
                    location: job.location,
                    description: job.description,
                    requirements: job.requirements,
                    welcome_requirements: job.welcome_requirements,
                    created_at: new Date(job.created_at).toLocaleString()
                }));

                const csv = Papa.unparse(csvData);
                const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `jobs_export_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error('Export error:', error);
                alert('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            } finally {
                hideLoading();
            }
        }

        window.loadAdminJobs = async function (page = 1, searchText = '') {
            if (!currentUser) return

            // UIÊõ¥Êñ∞: Google„Éâ„É©„Ç§„Éñ„Ç§„É≥„Éù„Éº„Éà„Éú„Çø„É≥„ÅÆË°®Á§∫Âà∂Âæ°
            const orgSettings = getOrgSettings();
            $('#admin-job-drive-import-btn').toggleClass('hidden', !orgSettings.drive_import_enabled);
            $('#admin-job-drive-sync-btn').toggleClass('hidden', !orgSettings.drive_import_enabled);

            showLoading()
            try {
                let query = supabase
                    .from('jobs')
                    .select('*, companies(name)', { count: 'exact' }) // Join with companies
                    .eq('organization_id', currentUser.organization_id)
                    .is('deleted_at', null)

                if (searchText) {
                    query = query.or(`title.ilike.%${searchText}%,company.ilike.%${searchText}%,job_code.ilike.%${searchText}%`)
                }

                query = query.order('created_at', { ascending: false })

                // Pagination
                currentAdminJobPage = page;
                const from = (page - 1) * ADMIN_JOBS_PER_PAGE;
                const to = from + ADMIN_JOBS_PER_PAGE - 1;

                const { data: jobs, error, count } = await query.range(from, to);

                if (error) throw error

                totalAdminJobPages = count ? Math.ceil(count / ADMIN_JOBS_PER_PAGE) : 1;
                adminJobsCache = jobs || [];
                renderAdminJobs(adminJobsCache, count);
                renderAdminJobPagination();
            } catch (error) {
                console.error('Load admin jobs error:', error)
                $('#admin-jobs-container').html('<p class="text-red-500">Ê±Ç‰∫∫„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>')
            } finally {
                hideLoading()
            }
        }

        const debouncedLoadAdminJobs = debounce((text) => loadAdminJobs(1, text), 500);

        window.filterAdminJobs = function () {
            const searchText = $('#admin-job-search').val().trim();
            debouncedLoadAdminJobs(searchText);
        }

        function renderAdminJobPagination() {
            const container = $('#admin-job-pagination-container');
            if (!container.length) {
                $('#admin-jobs-container').after('<div id="admin-job-pagination-container" class="mt-6 flex justify-center gap-2"></div>');
            }
            const $container = $('#admin-job-pagination-container');

            if (totalAdminJobPages <= 1) {
                $container.html('');
                return;
            }

            let html = '';
            // Previous
            html += `<button onclick="loadAdminJobs(${currentAdminJobPage - 1}, $('#admin-job-search').val())" 
                        class="px-3 py-1 rounded border ${currentAdminJobPage === 1 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'hover:bg-gray-100 text-gray-700'}" 
                        ${currentAdminJobPage === 1 ? 'disabled' : ''}>Ââç„Å∏</button>`;

            // Page numbers (simplified)
            const maxButtons = 5;
            let start = Math.max(1, currentAdminJobPage - 2);
            let end = Math.min(totalAdminJobPages, start + maxButtons - 1);
            if (end - start + 1 < maxButtons) {
                start = Math.max(1, end - maxButtons + 1);
            }

            for (let i = start; i <= end; i++) {
                html += `<button onclick="loadAdminJobs(${i}, $('#admin-job-search').val())" 
                            class="px-3 py-1 rounded border ${i === currentAdminJobPage ? 'bg-indigo-600 text-white' : 'hover:bg-gray-100 text-gray-700'}">${i}</button>`;
            }

            // Next
            html += `<button onclick="loadAdminJobs(${currentAdminJobPage + 1}, $('#admin-job-search').val())" 
                        class="px-3 py-1 rounded border ${currentAdminJobPage === totalAdminJobPages ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'hover:bg-gray-100 text-gray-700'}" 
                        ${currentAdminJobPage === totalAdminJobPages ? 'disabled' : ''}>Ê¨°„Å∏</button>`;

            $container.html(html);
        }

        function renderAdminJobs(jobs, totalCount) {
            const container = $('#admin-jobs-container')
            container.empty()

            // ‰ª∂Êï∞Ë°®Á§∫„ÇíËøΩÂä†
            if (totalCount !== undefined) {
                container.append(`<p class="text-sm text-gray-600 mb-4">ÂÖ® ${totalCount.toLocaleString()} ‰ª∂‰∏≠ ${jobs.length} ‰ª∂„ÇíË°®Á§∫</p>`);
            }

            if (jobs.length === 0) {
                container.append('<p class="text-gray-500 text-center py-8">Ë©≤ÂΩì„Åô„ÇãÊ±Ç‰∫∫„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>')
                return
            }

            const statusBadge = (status) => {
                const config = {
                    'active': { label: 'ÂÖ¨Èñã‰∏≠', color: 'bg-green-100 text-green-800' },
                    'draft': { label: '‰∏ãÊõ∏„Åç', color: 'bg-gray-100 text-gray-800' },
                    'closed': { label: 'ÂãüÈõÜÁµÇ‰∫Ü', color: 'bg-red-100 text-red-800' }
                }
                const s = config[status] || config['draft']
                return `<span class="px-2 py-1 rounded text-xs font-medium ${s.color}">${s.label}</span>`
            }

            const html = jobs.map(job => `
                <div class="bg-white border border-gray-200 rounded-lg p-6 mb-4">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-1">
                                <h3 class="text-lg font-bold text-gray-900">${job.title}</h3>
                                ${statusBadge(job.status)}
                            </div>
                            <div class="flex items-center gap-4 mb-2">
                                <p class="text-gray-600 text-sm font-medium"><i class="far fa-building mr-1"></i>${job.companies ? job.companies.name : job.company}</p>
                                ${job.job_code ? `<span class="text-[10px] text-indigo-600 bg-indigo-50 px-1.5 py-0.5 rounded font-bold">ID: ${job.job_code}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick='openEditJobModal("${job.id}")' class="text-indigo-600 hover:text-indigo-800 px-3 py-1 text-sm">
                                <i class="fas fa-edit mr-1"></i>Á∑®ÈõÜ
                            </button>
                            <button onclick="deleteJob('${job.id}')" class="text-red-600 hover:text-red-800 px-3 py-1 text-sm">
                                <i class="fas fa-trash mr-1"></i>ÂâäÈô§
                            </button>
                        </div>
                    </div>
                    <p class="text-gray-600 text-sm line-clamp-2">${job.description || ''}</p>
                </div>
            `).join('')

            container.html(html)
        }

        window.deleteJob = async function (jobId) {
            if (!confirm('„Åì„ÅÆÊ±Ç‰∫∫„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return

            showLoading()
            try {
                const { error } = await supabase
                    .from('jobs')
                    .update({ deleted_at: new Date().toISOString() })
                    .eq('id', jobId)

                if (error) throw error

                alert('ÂâäÈô§„Åó„Åæ„Åó„Åü')
                loadAdminJobs()
            } catch (error) {
                console.error('Delete job error:', error)
                alert('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message)
            } finally {
                hideLoading()
            }
        }

        // Ê•≠Á®Æ„Éû„Çπ„Çø‰∏ÄÊã¨Êõ¥Êñ∞Áî®Èñ¢Êï∞
        window.updateIndustryCategoriesMaster = async function () {
            if (!currentUser || !currentUser.organization_id) {
                alert('ÁµÑÁπîÊÉÖÂ†±„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ');
                return;
            }
            if (currentUser.role !== 'super_admin') {
                alert('„Åì„ÅÆÊìç‰Ωú„ÅØ„Çπ„Éº„Éë„ÉºÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÂèØËÉΩ„Åß„Åô„ÄÇ');
                return;
            }
            if (!confirm('Ëá™ÁµÑÁπî„ÅÆÊ•≠Á®Æ„Éû„Çπ„Çø„ÇíÂàùÊúüÂåñ„Åó„Å¶„ÄÅÊñ∞„Åó„ÅÑ„É™„Çπ„Éà„ÅßÊõ¥Êñ∞„Åó„Åæ„Åô„ÅãÔºü\nÊó¢Â≠ò„ÅÆÊ•≠Á®Æ„Ç´„ÉÜ„Ç¥„É™„ÅØÂÖ®„Å¶ÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ')) return;

            const newIndustryCategories = [
                "IT„ÉªÈÄö‰ø°„Éª„Ç§„É≥„Çø„Éº„Éç„ÉÉ„Éà",
                "„É°„Éº„Ç´„ÉºÔºàÊ©üÊ¢∞„ÉªÈõªÊ∞ó„ÉªÈõªÂ≠êÔºâ",
                "„É°„Éº„Ç´„ÉºÔºàÁ¥†Êùê„ÉªÂåñÂ≠¶„ÉªÈ£üÂìÅ„Éª„Åù„ÅÆ‰ªñÔºâ",
                "ÂïÜÁ§æÔºàÁ∑èÂêà„ÉªÂ∞ÇÈñÄÔºâ",
                "ÈáëËûç„Éª‰øùÈô∫",
                "Âª∫Ë®≠„Éª‰∏çÂãïÁî£„Éª‰ΩèÂÆÖ",
                "Áâ©ÊµÅ„ÉªÈÅãËº∏",
                "ÊµÅÈÄö„ÉªÂ∞èÂ£≤„Éª„Çµ„Éº„Éì„Çπ",
                "Â∫ÉÂëä„ÉªÂá∫Áâà„Éª„Éû„Çπ„Ç≥„Éü",
                "„Ç≥„É≥„Çµ„É´„ÉÜ„Ç£„É≥„Ç∞„ÉªË™øÊüª",
                "‰∫∫Êùê„Çµ„Éº„Éì„Çπ",
                "ÂåªÁôÇ„ÉªÂåªËñ¨„ÉªÁ¶èÁ•â",
                "ÊïôËÇ≤„ÉªÂÆòÂÖ¨Â∫Å„Éª„Åù„ÅÆ‰ªñ",
                "„Ç®„Éç„É´„ÇÆ„Éº„Éª„Ç§„É≥„Éï„É©",
                "ÊóÖË°å„ÉªÂÆøÊ≥ä„Éª„É¨„Ç∏„É£„Éº",
                "„Åù„ÅÆ‰ªñ"
            ];

            try {
                // 1. Êó¢Â≠ò„ÅÆÊ•≠Á®Æ„Ç´„ÉÜ„Ç¥„É™„ÇíÂâäÈô§ (Ëá™ÁµÑÁπî„ÅÆ„ÅøÂØæË±°)
                const { error: deleteError } = await supabase
                    .from('master_data')
                    .delete()
                    .eq('type', 'industry_category')
                    .eq('organization_id', currentUser.organization_id);

                if (deleteError) throw deleteError;

                // 2. Êñ∞„Åó„ÅÑÊ•≠Á®Æ„Ç´„ÉÜ„Ç¥„É™„ÇíËøΩÂä†
                const insertData = newIndustryCategories.map((label, index) => ({
                    type: 'industry_category',
                    label: label,
                    value: label,
                    sort_order: (index + 1) * 10,
                    is_active: true,
                    organization_id: currentUser.organization_id
                }));

                const { error } = await supabase
                    .from('master_data')
                    .insert(insertData);

                if (error) throw error;

                alert('Ê•≠Á®Æ„Éû„Çπ„Çø„ÇíÂàùÊúüÂåñ„Åó„Åæ„Åó„Åü');
                // „Éû„Çπ„ÇøÁÆ°ÁêÜÁîªÈù¢„ÅåÈñã„ÅÑ„Å¶„ÅÑ„Çå„Å∞ÂÜçË™≠„ÅøËæº„Åø
                if ($('#admin-master-content').is(':visible')) {
                    loadMasterData();
                }

            } catch (error) {
                console.error('Failed to update industry categories:', error);
                alert('Ê•≠Á®Æ„Éû„Çπ„Çø„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }

        window.deleteUser = async function (userId) {
            if (!confirm('„Åì„ÅÆ„É¶„Éº„Ç∂„Éº„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\nÔºàË´ñÁêÜÂâäÈô§„Åï„Çå„ÄÅ‰∏ÄË¶ß„Åã„ÇâÈùûË°®Á§∫„Å´„Å™„Çä„Åæ„ÅôÔºâ')) return

            showLoading()
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ deleted_at: new Date().toISOString() })
                    .eq('id', userId)

                if (error) throw error

                alert('ÂâäÈô§„Åó„Åæ„Åó„Åü')

                // „É™„É≠„Éº„Éâ
                if ($('#admin-users-content').is(':visible')) {
                    loadAdminUsers();
                } else if ($('#admin-candidates-content').is(':visible')) {
                    loadAdminCandidates();
                }
            } catch (error) {
                console.error('Delete user error:', error)
                alert('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message)
            } finally {
                hideLoading()
            }
        }

        window.openEditJobModal = function (jobId) {
            showJobForm(jobId)
        }

        // „Éû„Çπ„Çø„Éá„Éº„Çø„Åã„ÇâÈÅ∏ÊäûËÇ¢„Çí„É≠„Éº„Éâ„Åô„Çã„Éò„É´„Éë„ÉºÈñ¢Êï∞
        async function loadMasterOptions(type, selectId, selectedValue = null) {
            try {
                const { data: masters, error } = await supabase
                    .from('master_data')
                    .select('*')
                    .eq('type', type)
                    .eq('is_active', true)
                    .order('sort_order', { ascending: true })

                if (error) throw error

                // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞Ôºà„Ç∞„É≠„Éº„Éê„É´ „Åæ„Åü„ÅØ Ëá™Á§æÁî®Ôºâ
                const validMasters = masters.filter(m =>
                    m.organization_id === null || m.organization_id === currentUser.organization_id
                )

                const select = $(`#${selectId}`)
                select.empty()

                if (validMasters.length > 0) {
                    validMasters.forEach(m => {
                        const option = $('<option></option>').val(m.value).text(m.label)
                        if (selectedValue && m.value === selectedValue) {
                            option.prop('selected', true)
                        }
                        select.append(option)
                    })
                } else {
                    // „Éû„Çπ„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                    const fallbacks = {
                        'employment_type': ['Ê≠£Á§æÂì°', 'Â•ëÁ¥ÑÁ§æÂì°', 'Ê¥æÈÅ£Á§æÂì°', 'Ê•≠ÂãôÂßîË®ó'],
                        'job_category': ['„Ç®„É≥„Ç∏„Éã„Ç¢', 'Âñ∂Ê•≠', '„Éá„Ç∂„Ç§„Éä„Éº', '„Åù„ÅÆ‰ªñ']
                    }
                    const options = fallbacks[type] || []
                    options.forEach(opt => {
                        const option = $('<option></option>').val(opt).text(opt)
                        if (selectedValue && opt === selectedValue) {
                            option.prop('selected', true)
                        }
                        select.append(option)
                    })
                }
            } catch (error) {
                console.error(`Load master options error (${type}):`, error)
            }
        }

        window.showJobForm = async function (jobId = null) {
            // „Éû„Çπ„Çø„Éá„Éº„Çø„ÅåÊú™„É≠„Éº„Éâ„Å™„Çâ„É≠„Éº„Éâ„Åô„Çã
            if (masterJobCategories.length === 0 || masterIndustries.length === 0) {
                await initMasterDataDropdowns();
            }

            $('#job-form')[0].reset()
            $('#job-id').val('')
            $('#job-drive-pdf-url').val('') // Clear hidden field


            try {
                // ‰ºÅÊ•≠ÈÅ∏ÊäûËÇ¢ÔºàSelect2Ôºâ„ÅÆÂàùÊúüÂåñ
                const select = $('#job-company-select');

                // Select2 „Çí‰∏ÄÂ∫¶Á†¥Ê£Ñ
                if (select.hasClass('select2-hidden-accessible')) {
                    select.select2('destroy');
                }
                select.empty();

                // Á∑®ÈõÜ„É¢„Éº„Éâ„ÅßÁâπÂÆö„ÅÆ‰ºÅÊ•≠„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅ„Åù„ÅÆ‰ºÅÊ•≠ÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Å¶ÈÅ∏ÊäûËÇ¢„Å´ËøΩÂä†
                if (jobId) {
                    try {
                        // Ê±Ç‰∫∫ÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Å¶‰ºöÁ§æID„ÇíÁ¢∫Ë™ç
                        const { data: jobInfo } = await supabase.from('jobs').select('company_id').eq('id', jobId).single();
                        if (jobInfo && jobInfo.company_id) {
                            const { data: comp } = await supabase.from('companies').select('id, name').eq('id', jobInfo.company_id).single();
                            if (comp) {
                                select.append(new Option(comp.name, comp.id, true, true));
                            }
                        }
                    } catch (e) {
                        console.error('Failed to pre-fetch company for job edit:', e);
                    }
                }

                // Select2 „Çí AJAX „É¢„Éº„Éâ„ÅßÂàùÊúüÂåñ
                select.select2({
                    placeholder: "‰ºÅÊ•≠„ÇíÊ§úÁ¥¢„Åæ„Åü„ÅØÈÅ∏Êäû",
                    allowClear: true,
                    width: '100%',
                    dropdownParent: $('#job-modal'),
                    language: {
                        searching: function () { return "Ê§úÁ¥¢‰∏≠..."; },
                        noResults: function () { return "Ë¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü"; },
                        inputTooShort: function () { return "1ÊñáÂ≠ó‰ª•‰∏äÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"; }
                    },
                    ajax: {
                        delay: 250,
                        transport: async function (params, success, failure) {
                            try {
                                const searchText = params.data.q;
                                let query = supabase
                                    .from('companies')
                                    .select('id, name')
                                    .eq('organization_id', currentUser.organization_id)
                                    .is('deleted_at', null)
                                    .order('name');

                                if (searchText) {
                                    query = query.ilike('name', `%${searchText}%`);
                                }

                                const { data, error } = await query.limit(20);
                                if (error) throw error;

                                let results = data.map(c => ({ id: c.id, text: c.name }));

                                // „ÄåÊñ∞Ë¶è‰ºÅÊ•≠„Çí‰ΩúÊàê„Äç„Ç™„Éó„Ç∑„Éß„É≥„ÇíÊ§úÁ¥¢ÁµêÊûú„ÅÆÂÖàÈ†≠„Å´ËøΩÂä†
                                if (!searchText || "+ Êñ∞Ë¶è‰ºÅÊ•≠„Çí‰ΩúÊàê".includes(searchText)) {
                                    results.unshift({ id: 'new', text: '+ Êñ∞Ë¶è‰ºÅÊ•≠„Çí‰ΩúÊàê' });
                                }

                                success({ results });
                            } catch (e) {
                                console.error('Select2 Fetch Error:', e);
                                failure(e);
                            }
                        }
                    }
                });

                // „Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„ÅÆË®≠ÂÆö
                select.off('change').on('change', function () {
                    handleCompanySelect($(this).val());
                });

            } catch (e) {
                console.error('Failed to load companies for select:', e);
            }

            // ÊãÖÂΩìËÄÖ„É™„Çπ„Éà„ÅÆ„É≠„Éº„Éâ (ÁÆ°ÁêÜËÄÖ„Éª„Ç≥„Éº„ÉÅ„ÉªCA)
            try {
                const { data: picUsers } = await supabase
                    .from('users')
                    .select('id, name')
                    .eq('organization_id', currentUser.organization_id)
                    .in('role', ['admin', 'super_admin', 'coach', 'ca', 'org_admin'])
                    .neq('management_status', 'inactive')
                    .order('name');

                const picSelect1 = $('#job-pic-user-1');
                const picSelect2 = $('#job-pic-user-2');

                const defaultOption = '<option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>';
                picSelect1.empty().append(defaultOption);
                picSelect2.empty().append(defaultOption);

                if (picUsers) {
                    picUsers.forEach(u => {
                        const option = `<option value="${u.id}">${u.name}</option>`;
                        picSelect1.append(option);
                        picSelect2.append(option);
                    });
                }
            } catch (e) {
                console.error('Failed to load users for PIC select:', e);
            }

            // „Éû„Çπ„Çø„Éá„Éº„Çø„ÅÆ„Éó„É´„ÉÄ„Ç¶„É≥ÂàùÊúüÂåñÔºàÂÄ§„Å™„ÅóÔºâ
            populateSelectOptions('job-employment-type', ['Ê≠£Á§æÂì°', 'Â•ëÁ¥ÑÁ§æÂì°', 'Ê¥æÈÅ£Á§æÂì°', 'Ê•≠ÂãôÂßîË®ó']);

            populateSelectOptions('job-category', masterJobCategories);
            populateSelectOptions('job-industry-category', masterIndustries);

            if (jobId) {
                $('#job-modal-title').text('Ê±Ç‰∫∫Á∑®ÈõÜ')
                $('#job-id').val(jobId)

                // Á∑®ÈõÜÊôÇ„ÅØ„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„Å¶„Çª„ÉÉ„Éà
                const { data: job } = await supabase
                    .from('jobs')
                    .select('*')
                    .eq('id', jobId)
                    .single()

                if (job) {
                    $('#job-title').val(job.title)
                    $('#job-code').val(job.job_code || '')
                    $('#job-company-id').val(job.company_id)
                    // Select2 „ÅÆÂÄ§„Çí„Çª„ÉÉ„Éà
                    $('#job-company-select').val(job.company_id).trigger('change');

                    $('#job-location').val(job.location)
                    if (job.salary_min) $('#job-salary-min').val(job.salary_min / 10000)
                    if (job.salary_max) $('#job-salary-max').val(job.salary_max / 10000)
                    $('#job-description').val(job.description)
                    $('#job-work-hours').val(job.work_hours)
                    $('#job-holidays').val(job.holidays)
                    $('#job-benefits').val(job.benefits)
                    $('#job-interview-process').val(job.interview_process)
                    // Requirements and Welcome Requirements
                    $('#job-requirements').val(job.requirements || '')
                    $('#job-welcome-requirements').val(job.welcome_requirements || '')

                    // ËøΩÂä†È†ÖÁõÆ
                    $('#job-pic-user-1').val(job.pic_user_id_1 || '');
                    $('#job-pic-user-2').val(job.pic_user_id_2 || '');
                    $('#job-pdf-filename').val(job.pdf_filename || '');

                    // URLÁÆ°ÁêÜÔºàpdf_urlÁ≠â„ÅÆ„Éâ„É©„Ç§„ÉñÁî®„Ç´„É©„É†„Çí„É°„Ç§„É≥„ÅÆURLÊ¨Ñ„Å´Ë°®Á§∫Ôºâ
                    const orgSettings = getOrgSettings();
                    let driveCol = orgSettings.drive_column || 'pdf_url';
                    if (driveCol === 'pdf' || driveCol === 'url') driveCol = 'pdf_url';

                    const driveUrl = job[driveCol] || '';
                    $('#job-url').val(driveUrl);
                    $('#job-drive-pdf-url').val(driveUrl);


                    $('#job-employment-type').val(job.employment_type)
                    $('#job-is-remote').prop('checked', job.is_remote)
                    $('#job-experience-ok').prop('checked', job.job_experience_ok === 'ÂèØ')
                    $('#job-industry-experience-ok').prop('checked', job.industry_experience_ok === 'ÂèØ')

                    // „Éû„Çπ„Çø„Éá„Éº„ÇøÈÅ∏ÊäûËÇ¢„ÅÆÂÜçË®≠ÂÆö (selected value„ÇíÂèçÊò†)
                    // populateSelectOptions „ÅØ„Éû„Çπ„Çø„Å´„Å™„ÅÑÂÄ§„ÇÇËøΩÂä†„Åó„Å¶„Åè„Çå„Çã
                    populateSelectOptions('job-category', masterJobCategories, job.job_category);
                    populateSelectOptions('job-industry-category', masterIndustries, job.industry_category);
                }
            } else {
                $('#job-modal-title').text('Ê±Ç‰∫∫‰ΩúÊàê')
                // Êñ∞Ë¶è‰ΩúÊàêÊôÇ„ÅØ Select2 „Çí„É™„Çª„ÉÉ„Éà
                $('#job-company-select').val('').trigger('change');
            }
            $('#job-modal').removeClass('hidden')
        }

        window.handleCompanySelect = function (value) {
            if (value === 'new') {
                // Êñ∞Ë¶è‰ΩúÊàê„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè„Å™„Å©„ÅÆÂá¶ÁêÜ„ÅåÂøÖË¶Å„Å†„Åå„ÄÅ
                // „Åì„Åì„Åß„ÅØÁ∞°ÊòìÁöÑ„Å´„Äå‰ºÅÊ•≠ÁÆ°ÁêÜÁîªÈù¢„Åß‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„Äç„Å®Ê°àÂÜÖ„Åô„Çã„Åã„ÄÅ
                // „ÅÇ„Çã„ÅÑ„ÅØCompanyModal„ÇíÈáç„Å≠„Å¶Èñã„Åè„ÄÇ
                // Èáç„Å≠„Å¶Èñã„Åè„ÅÆ„ÅØZ-indexÁÆ°ÁêÜ„ÅåÈù¢ÂÄí„Å™„ÅÆ„Åß„ÄÅ‰∏ÄÊó¶„Ç¢„É©„Éº„Éà„ÅßÊ°àÂÜÖ„ÄÇ
                if (confirm('Êñ∞„Åó„ÅÑ‰ºÅÊ•≠„ÇíÁôªÈå≤„Åó„Åæ„Åô„ÅãÔºü\nOK„ÇíÊäº„Åô„Å®‰ºÅÊ•≠ÁôªÈå≤ÁîªÈù¢„ÅåÈñã„Åç„Åæ„Åô„ÄÇ\nÔºàÁèæÂú®„ÅÆÂÖ•ÂäõÂÜÖÂÆπ„ÅØÁ†¥Ê£Ñ„Åï„Çå„Åæ„ÅôÔºâ')) {
                    closeJobModal();
                    showCompanyForm();
                } else {
                    $('#job-company-select').val('');
                }
            } else {
                $('#job-company-id').val(value);
            }
        }

        window.closeJobModal = function () {
            $('#job-modal').addClass('hidden')
            $('#job-form')[0].reset()
        }

        $('#job-form').on('submit', async function (e) {
            e.preventDefault()
            showLoading()

            const jobId = $('#job-id').val()
            const salaryMin = $('#job-salary-min').val()
            const salaryMax = $('#job-salary-max').val()

            const jobData = {
                organization_id: currentUser.organization_id,
                title: $('#job-title').val(),
                job_code: $('#job-code').val() || null,
                company_id: $('#job-company-id').val(),
                company: $('#job-company-select option:selected').text(), // Legacy support but required by DB constraint
                location: $('#job-location').val(),
                employment_type: $('#job-employment-type').val(),
                salary_min: salaryMin ? parseInt(salaryMin) * 10000 : null,
                salary_max: salaryMax ? parseInt(salaryMax) * 10000 : null,
                job_category: $('#job-category').val() || null,
                industry_category: $('#job-industry-category').val() || null,
                job_experience_ok: $('#job-experience-ok').is(':checked') ? 'ÂèØ' : '‰∏çÂèØ',
                industry_experience_ok: $('#job-industry-experience-ok').is(':checked') ? 'ÂèØ' : '‰∏çÂèØ',
                description: $('#job-description').val(),
                requirements: $('#job-requirements').val(),
                welcome_requirements: $('#job-welcome-requirements').val(),
                status: $('#job-status').val(),
                is_remote: $('#job-is-remote').is(':checked'),
                work_hours: $('#job-work-hours').val(),
                holidays: $('#job-holidays').val(),
                benefits: $('#job-benefits').val(),
                interview_process: $('#job-interview-process').val(),
                pic_user_id_1: $('#job-pic-user-1').val() || null,
                pic_user_id_2: $('#job-pic-user-2').val() || null,
                pdf_filename: $('#job-pdf-filename').val() || null,
                updated_at: new Date().toISOString()
            }

            // URLÈ†ÖÁõÆ„ÅÆ‰øùÂ≠òÂÖà„ÇíGoogle DriveÁî®„Ç´„É©„É†Ôºàpdf_urlÁ≠âÔºâ„Å´Áµ±‰∏Ä
            const orgSettings = getOrgSettings();
            let driveCol = orgSettings.drive_column || 'pdf_url';
            if (driveCol === 'pdf' || driveCol === 'url') driveCol = 'pdf_url';

            // ÂÖ•Âäõ„Åï„Çå„ÅüURL„Çípdf_url„Å´‰øùÂ≠ò
            jobData[driveCol] = $('#job-url').val() || null;
            // ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅ„ÄÅurl„Ç´„É©„É†„ÅØ‰øùÂ≠òÂØæË±°„Åã„ÇâÂ§ñ„ÅôÔºà„Åæ„Åü„ÅØnull„Å´„Åô„ÇãÔºâ
            delete jobData.url;

            if (!jobData.company_id) {
                alert('‰ºÅÊ•≠„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                hideLoading();
                return;
            }

            try {
                if (jobId) {
                    // Update
                    const { error } = await supabase
                        .from('jobs')
                        .update(jobData)
                        .eq('id', jobId)

                    if (error) throw error

                    // „É≠„Ç∞Ë®òÈå≤
                    await auditLog.jobUpdated(jobId, { title: jobData.title });

                    alert('Ê±Ç‰∫∫„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü')
                } else {
                    // Create
                    const { data: newJob, error } = await supabase
                        .from('jobs')
                        .insert(jobData)
                        .select()
                        .single()

                    if (error) throw error

                    // „É≠„Ç∞Ë®òÈå≤
                    if (newJob) {
                        await auditLog.jobCreated(newJob.id, { title: jobData.title });
                    }

                    alert('Ê±Ç‰∫∫„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü')
                }

                closeJobModal()
                loadAdminJobs()
            } catch (error) {
                console.error('Save job error:', error)
                alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message)
            } finally {
                hideLoading()
            }
        })

        // ========================
        // ========================
        // Admin: Candidate Management
        // ========================
        let adminCandidatesCache = [];
        // ========================
        // Admin: User Edit Modal Logic
        // ========================
        let adminCoachesCache = [];

        async function loadAdminCoaches() {
            // „Ç≥„Éº„ÉÅ„ÄÅCA„ÄÅRA„Å´Âä†„Åà„Å¶ÁÆ°ÁêÜËÄÖ„ÇÇÊãÖÂΩìËÄÖ„Å®„Åó„Å¶ÂèñÂæóÂèØËÉΩ„Å´„Åô„Çã
            const { data: coaches } = await supabase
                .from('users')
                .select('id, name, role, status, management_status')
                .eq('organization_id', currentUser.organization_id)
                .in('role', ['coach', 'ca', 'ra', 'admin', 'org_admin']);
            // ÂÅúÊ≠¢‰∏≠„É¶„Éº„Ç∂„Éº„Åæ„Åü„ÅØÁÆ°ÁêÜ„Çπ„ÉÜ„Éº„Çø„Çπ„Åå„ÄåÊ¥ªÂãïÁµÇ‰∫Ü„Äç„ÅÆ„É¶„Éº„Ç∂„Éº„ÇíÈô§Â§ñ
            adminCoachesCache = (coaches || []).filter(u => u.status !== 'suspended' && (u.management_status !== 'inactive'));
        }

        window.showAdminUserModal = async function (userId) {
            console.log('showAdminUserModal called with userId:', userId);
            if (!currentUser) return;

            // Reset modal ready flag to prevent premature submission
            isModalReady = false;

            // „Ç≥„Éº„ÉÅ„É™„Çπ„Éà„Çí„É≠„Éº„ÉâÔºàÊú™„É≠„Éº„Éâ„ÅÆÂ†¥ÂêàÔºâ
            if (adminCoachesCache.length === 0) {
                await loadAdminCoaches();
            }

            // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÂèñÂæó
            const { data: userData, error } = await supabase
                .from('users')
                .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                .eq('id', userId)
                .single();

            if (error || !userData) {
                console.error('Error fetching user:', error);
                alert('„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                return;
            }

            console.log('Fetched userData:', userData);
            console.log('candidate_profiles:', userData.candidate_profiles);

            // „Éï„É©„ÉÉ„ÉàÂåñ
            const profile = Array.isArray(userData.candidate_profiles) ? userData.candidate_profiles[0] : userData.candidate_profiles;
            const user = { ...userData, ...profile };
            user.id = userData.id; // IDÁ¢∫‰øù

            console.log('Merged user object:', {
                desired_job_type: user.desired_job_type,
                desired_industry: user.desired_industry,
                desired_employment_type: user.desired_employment_type,
                desired_location: user.desired_location
            });

            // Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØ: „Ç≥„Éº„ÉÅ/CA/RA„ÅØÊãÖÂΩìÊ±ÇËÅ∑ËÄÖ„ÅÆ„ÅøÁ∑®ÈõÜÂèØËÉΩ
            if (['coach', 'ca', 'ra'].includes(currentUser.role)) {
                if (user.role !== 'candidate' || user.coach_id !== currentUser.id) {
                    alert('„Åì„ÅÆ„É¶„Éº„Ç∂„Éº„ÇíÁ∑®ÈõÜ„Åô„ÇãÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                    return;
                }
            }

            // „Éï„Ç©„Éº„É†„Å´ÂÄ§„Çí„Çª„ÉÉ„Éà
            $('#admin-user-id').val(user.id);
            $('#admin-user-name').val(user.name);
            $('#admin-user-furigana').val(user.furigana || '');
            $('#admin-user-email').val(user.email);
            $('#admin-user-new-password').val(''); // „Éë„Çπ„ÉØ„Éº„Éâ„Éï„Ç£„Éº„É´„Éâ„Çí„É™„Çª„ÉÉ„Éà (Êñ∞Ë¶èËøΩÂä†)

            // Ê®©Èôê„É©„Éô„É´„ÅÆÊõ¥Êñ∞
            const $roleSelect = $('#admin-user-role');
            $roleSelect.find('option[value="org_admin"]').text(getRoleLabel('org_admin'));
            $roleSelect.find('option[value="admin"]').text(getRoleLabel('admin'));
            $roleSelect.find('option[value="coach"]').text(getRoleLabel('coach'));
            $roleSelect.find('option[value="candidate"]').text(getRoleLabel('candidate'));

            $roleSelect.val(user.role);
            $('#admin-user-status').val(user.status || 'active');
            $('#admin-user-management-status').val(user.management_status || 'active');

            // Ê®©ÈôêÂ§âÊõ¥„ÅÆÂà∂Âæ°: ÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÂèØËÉΩ
            if (['org_admin', 'admin', 'super_admin'].includes(currentUser.role)) {
                $('#admin-user-role-container').show();
                $('#admin-user-coach-container').show();
                $('#admin-user-coach').prop('disabled', false);

                // „ÉÅ„Éº„É†„É™„Çπ„Éà„ÅÆ„É≠„Éº„Éâ
                const { data: teams } = await window.supabase
                    .from('teams')
                    .select('*')
                    .eq('organization_id', currentUser.organization_id)
                    .order('display_order');

                if (teams) {
                    const teamSelect = $('#admin-user-team');
                    teamSelect.empty().append('<option value="">Êú™Ë®≠ÂÆö</option>');
                    teams.forEach(t => {
                        const indent = '&nbsp;'.repeat((t.level - 1) * 4);
                        teamSelect.append(`<option value="${t.id}">${indent}${t.name}</option>`);
                    });
                    if (user.team_id) teamSelect.val(user.team_id);
                }
            } else {
                $('#admin-user-role-container').hide();
                $('#admin-user-coach-container').hide();
                $('#admin-user-team').closest('div').hide();
            }

            // Ê±ÇËÅ∑ËÄÖ„Éï„Ç£„Éº„É´„Éâ„ÅÆË°®Á§∫Âà∂Âæ°
            if (user.role === 'candidate') {
                $('#admin-candidate-fields').removeClass('hidden');

                // „Ç≥„Éº„ÉÅ„Éó„É´„ÉÄ„Ç¶„É≥„ÅÆÁîüÊàê
                const coachSelect = $('#admin-user-coach');
                coachSelect.empty();
                coachSelect.append('<option value="">Êú™Ë®≠ÂÆö</option>');
                adminCoachesCache.forEach(c => {
                    const roleLabel = `(${getRoleLabel(c.role)})`;
                    coachSelect.append(`<option value="${c.id}">${c.name} ${roleLabel}</option>`);
                });
                if (user.coach_id) {
                    coachSelect.val(user.coach_id);
                }

                // „Éû„Çπ„Çø„Éá„Éº„Çø„É≠„Éº„Éâ & ÂÄ§„Çª„ÉÉ„Éà
                try {
                    console.log('Loading master data for user:', user);
                    await loadMasterDataForProfile(user);

                    // loadMasterDataForProfileÂÜÖ„ÅßÊó¢„Å´Select2„ÅÆÂàùÊúüÂåñ„Å®ÂÄ§„ÅÆ„Çª„ÉÉ„Éà„ÅåÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Çã
                    console.log('Master data loaded and values set successfully');
                } catch (err) {
                    console.error('Failed to load master data:', err);
                    // „Ç®„É©„Éº„ÅåÂá∫„Å¶„ÇÇ„Éï„Ç©„Éº„É†„ÅØÈñã„Åè„Çà„ÅÜ„Å´„Åô„ÇãÔºà„Åü„Å†„ÅóÂÄ§„ÅØ„Çª„ÉÉ„Éà„Åï„Çå„Å™„ÅÑÂèØËÉΩÊÄß„Åå„ÅÇ„ÇãÔºâ
                }

                const salary = user.desired_salary ? Math.floor(user.desired_salary / 10000) : '';
                // Áï∞Â∏∏ÂÄ§Ôºà10ÂÑÑÂÜÜ‰ª•‰∏ä„Å™„Å©„ÄÅInt32‰∏äÈôê„Ç™„Éº„Éê„Éº„Éï„É≠„ÉºÁî±Êù•„ÅÆÂÄ§Ôºâ„ÅØË°®Á§∫„Åó„Å™„ÅÑ
                // Áï∞Â∏∏ÂÄ§Ôºà10ÂÑÑÂÜÜ‰ª•‰∏ä„Å™„Å©„ÄÅInt32‰∏äÈôê„Ç™„Éº„Éê„Éº„Éï„É≠„ÉºÁî±Êù•„ÅÆÂÄ§Ôºâ„ÅØË°®Á§∫„Åó„Å™„ÅÑ
                $('#admin-user-salary').val(salary > 100000 ? '' : salary);
                $('#admin-user-birth-date').val(user.birth_date || '');
                $('#admin-user-age').val(user.age || '');
                $('#admin-user-education').val(user.education || '');
                $('#admin-user-skills').val(user.skills || '');
                $('#admin-user-history').val(user.work_history || '');
                $('#admin-user-work-history-detail').val(user.work_history_detail || '');
                $('#admin-user-history-info').val(user.history_info || '');


                // ËøΩÂä†Ë©≥Á¥∞È†ÖÁõÆ„ÅÆ„Çª„ÉÉ„Éà
                $('#admin-user-phone').val(user.phone || '');
                $('#admin-user-salary').val(user.desired_salary ? Math.floor(user.desired_salary / 10000) : '');
                $('#admin-user-freewords').val('');
                if (window.populateFreewordTags) {
                    window.populateFreewordTags(user.desired_freewords || '', 'admin-user-freewords-tags');
                }
                $(`input[name="admin-user-freewords-condition"][value="${user.desired_freewords_condition || 'and'}"]`).prop('checked', true);
                $('#admin-user-job-exp-ok').prop('checked', user.desired_job_experience_ok);
                $('#admin-user-industry-exp-ok').prop('checked', user.desired_industry_experience_ok);
                $('#admin-user-work-history-detail').val(user.work_history || '');
                $('#admin-user-resume-detail').val(user.resume || '');
                $('#admin-user-notes').val(user.notes || '');
                $('#admin-user-drive-url').val(user.drive_folder_url || '');
                $('#admin-user-notebooklm-url').val(user.notebooklm_url || '');
                $('#admin-user-line-url').val(user.line_url || '');
                $('#admin-user-enable-auto-reco').prop('checked', !!user.enable_auto_recommendations);

                // Ë©≥Á¥∞ËÅ∑Ê≠¥
                console.log('Rendering work history list...');
                $('#work-history-list').empty();
                if (user.work_history_structured && Array.isArray(user.work_history_structured)) {
                    user.work_history_structured.forEach(item => addWorkHistoryItem(item));
                }
                updateJobChangeCount();
                console.log('Work history rendering complete');

                // ÂØæË±°Â§ñ‰ºÅÊ•≠„É≠„Éº„Éâ (New)
                console.log('Loading excluded companies for admin view...');
                await loadExcludedCompanies(userId, true);

            } else {
                console.log('User is not a candidate, skipping candidate fields');
                $('#admin-candidate-fields').addClass('hidden');
            }
            console.log('Forcing modal visibility (z-index 99999)...');
            const modal = $('#admin-user-modal');
            if (modal.length === 0) {
                console.error('CRITICAL: #admin-user-modal not found!');
                return;
            }
            // Move to body to avoid parent clipping
            $('body').append(modal);
            modal.removeClass('hidden').attr('style', 'display: flex !important; z-index: 99999 !important; visibility: visible !important; opacity: 1 !important;');
            console.log('showAdminUserModal process finished');

            // Set modal ready flag after everything is loaded
            setTimeout(() => {
                isModalReady = true;
                console.log('Modal is now ready for submission');
            }, 100);
        }

        window.closeAdminUserModal = function () {
            console.log('--- closeAdminUserModal Triggered ---');
            console.trace('closeAdminUserModal called from:');

            // Reset the ready flag
            isModalReady = false;

            $('#admin-user-modal').addClass('hidden').attr('style', 'display: none !important;');
        }

        // „Éë„Çπ„ÉØ„Éº„ÉâÊõ¥Êñ∞Âá¶ÁêÜ (Êñ∞Ë¶èËøΩÂä†)
        window.updateUserPassword = async function () {
            const userId = $('#admin-user-id').val();
            const newPassword = $('#admin-user-new-password').val();

            if (!userId) {
                alert('„É¶„Éº„Ç∂„ÉºID„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }

            if (!newPassword || newPassword.length < 6) {
                alert('„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ6ÊñáÂ≠ó‰ª•‰∏ä„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            if (!confirm('Êú¨ÂΩì„Å´„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åô„ÅãÔºü')) {
                return;
            }

            showLoading();
            try {
                const { data, error } = await supabase.functions.invoke('update-user-password', {
                    body: { userId, newPassword }
                });

                if (error) throw error;
                if (data && data.success === false) throw new Error(data.error);

                alert('„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
                $('#admin-user-new-password').val(''); // „ÇØ„É™„Ç¢
            } catch (error) {
                console.error('Password update error:', error);
                alert('„Éë„Çπ„ÉØ„Éº„Éâ„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // ËÅ∑Ê≠¥„É™„Çπ„ÉàÊìç‰ΩúÈñ¢Êï∞ (Ê±éÁî®Âåñ)
        window.addWorkHistoryItemToContainer = function (containerSelector, data = {}) {
            const container = $(containerSelector);
            const count = container.children().length;
            if (count >= 10) {
                alert('ËÅ∑Ê≠¥È†ÖÁõÆ„ÅØÊúÄÂ§ß10‰ª∂„Åæ„Åß„Åß„Åô„ÄÇ');
                return;
            }
            const index = count + 1;
            const targetCountId = containerSelector === '#work-history-list' ? '#admin-user-job-change-count' : '#profile-job-change-count';

            const $item = $(`
                <div class="work-history-item bg-gray-50 p-4 rounded-lg border border-gray-200 relative mb-4">
                    <button type="button" onclick="$(this).closest('.work-history-item').remove(); updateJobChangeCountInContainer('${containerSelector}', '${targetCountId}');" 
                        class="absolute top-2 right-2 text-gray-400 hover:text-red-500 w-6 h-6 flex items-center justify-center rounded-full hover:bg-gray-200 transition">
                        <i class="fas fa-times"></i>
                    </button>
                    <h5 class="text-sm font-bold text-indigo-700 mb-2">ËÅ∑Ê≠¥ ${index}</h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">‰ºöÁ§æÂêç</label>
                            <input type="text" class="wh-company w-full px-3 py-2 border rounded text-sm bg-white" placeholder="‰ºöÁ§æÂêç">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Âú®Á±çÊúüÈñì</label>
                            <input type="text" class="wh-period w-full px-3 py-2 border rounded text-sm bg-white" placeholder="‰æã: 2020/04 - 2023/03">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">ÊâÄÂ±û‰ºÅÊ•≠„ÅÆÊ•≠Á®Æ</label>
                            <input type="text" class="wh-industry w-full px-3 py-2 border rounded text-sm bg-white" placeholder="‰æã: IT„ÉªÈÄö‰ø°" list="master-industry-list">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">ËÅ∑Á®Æ</label>
                            <input type="text" class="wh-job-category w-full px-3 py-2 border rounded text-sm bg-white" placeholder="‰æã: Ê≥ï‰∫∫Âñ∂Ê•≠" list="master-job-category-list">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="block text-xs text-gray-500 mb-1">ÂΩπÂâ≤„ÉªÂΩπËÅ∑</label>
                        <input type="text" class="wh-role w-full px-3 py-2 border rounded text-sm bg-white" placeholder="ÂΩπÂâ≤„ÉªÂΩπËÅ∑">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">ËÅ∑ÂãôÂÜÖÂÆπ</label>
                        <textarea class="wh-description w-full px-3 py-2 border rounded text-sm bg-white" rows="3" placeholder="ËÅ∑ÂãôÂÜÖÂÆπ"></textarea>
                    </div>
                </div>
            `);

            $item.find('.wh-company').val(data.company_name || '');
            $item.find('.wh-period').val(data.period || '');
            $item.find('.wh-industry').val(data.industry || '');
            $item.find('.wh-job-category').val(data.job_category || '');
            $item.find('.wh-role').val(data.role || '');
            $item.find('.wh-description').val(data.description || '');

            container.append($item);

            // ‰ºöÁ§æÂêç„ÅåÂÖ•Âäõ„Åï„Çå„Åü„ÇâÂÜçË®àÁÆó
            $item.find('.wh-company').on('input', function () {
                updateJobChangeCountInContainer(containerSelector, targetCountId);
            });

            updateJobChangeCountInContainer(containerSelector, targetCountId);
        };

        window.updateJobChangeCountInContainer = function (containerSelector, countIdSelector) {
            const container = $(containerSelector);
            const companies = new Set();
            container.find('.wh-company').each(function () {
                const val = $(this).val().trim();
                if (val) companies.add(val);
            });
            const count = companies.size;
            $(countIdSelector).val(count);
            // Áï™Âè∑ÊåØ„ÇäÁõ¥„Åó
            container.find('.work-history-item').each(function (i) {
                $(this).find('h5').text(`ËÅ∑Ê≠¥ ${i + 1}`);
            });
        };

        // ÊóßÈñ¢Êï∞„Çí„Ç®„Ç§„É™„Ç¢„Çπ„Å®„Åó„Å¶ÊÆã„Åô (‰∫íÊèõÊÄßÁ∂≠ÊåÅ)
        window.addWorkHistoryItem = function (data = {}) {
            addWorkHistoryItemToContainer('#work-history-list', data);
        };
        window.updateJobChangeCount = function () {
            updateJobChangeCountInContainer('#work-history-list', '#admin-user-job-change-count');
        };

        // ÁÆ°ÁêÜËÄÖÁî®: PDF„Åã„Çâ„ÅÆËá™ÂãïÂÖ•Âäõ„Éè„É≥„Éâ„É©
        window.handleAdminUserPdfUpload = async function (input) {
            if (input.files.length === 0) return;

            if (!confirm('PDF„ÇíËß£Êûê„Åó„Å¶„Éï„Ç©„Éº„É†„Å´Ëá™ÂãïÂÖ•Âäõ„Åó„Åæ„Åô„ÅãÔºü\n‚ÄªÊó¢Â≠ò„ÅÆÂÖ•ÂäõÂÜÖÂÆπ„ÅØ‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇ')) {
                input.value = '';
                return;
            }

            showLoading('PDF„ÇíËß£Êûê‰∏≠...');
            try {
                let combinedText = '';
                for (let i = 0; i < input.files.length; i++) {
                    combinedText += await extractTextFromPDF(input.files[i]);
                }

                // AIËß£ÊûêÂÆüË°å
                let result = await analyzeDocumentWithAI(combinedText, 'resume');

                // ÈÖçÂàó„ÅßËøî„Å£„Å¶„Åç„ÅüÂ†¥Âêà„ÅØÊúÄÂàù„ÅÆË¶ÅÁ¥†„Çí‰Ωø„ÅÜ
                if (Array.isArray(result)) {
                    result = result[0] || {};
                }

                console.log('PDF Analysis Result:', result);

                // --- „Éï„Ç©„Éº„É†„Å∏„ÅÆÂèçÊò† ---

                // Âü∫Êú¨ÊÉÖÂ†±
                if (result.name) $('#admin-user-name').val(result.name);
                if (result.furigana || result.kana) $('#admin-user-furigana').val(result.furigana || result.kana);
                if (result.email) $('#admin-user-email').val(result.email);

                // Âπ¥ÈΩ¢„ÉªÁîüÂπ¥ÊúàÊó• (Êé®ÂÆöÂÄ§„Åå„ÅÇ„Çå„Å∞)
                if (result.age) $('#admin-user-age').val(result.age);

                // Âπ¥Âèé
                if (result.current_salary) {
                    $('#admin-user-salary').val(result.current_salary / 10000); // ‰∏áÂÜÜÂçò‰Ωç
                }

                // Â≠¶Ê≠¥
                if (result.academic_background) {
                    $('#admin-user-education').val(result.academic_background);
                }

                // „Çπ„Ç≠„É´
                if (result.skills) {
                    $('#admin-user-skills').val(result.skills);
                }

                // ËÅ∑Ê≠¥
                if (result.work_history) {
                    $('#admin-user-history').val(result.work_history);
                }
                if (result.work_history_detail) {
                    $('#admin-user-work-history-detail').val(result.work_history_detail);
                }

                // ÊßãÈÄ†Âåñ„Åï„Çå„ÅüËÅ∑Ê≠¥
                if (result.work_history_structured && Array.isArray(result.work_history_structured)) {
                    $('#work-history-list').empty();
                    result.work_history_structured.forEach(item => addWorkHistoryItem(item));
                    updateJobChangeCount();
                }

                // --- „Éû„Çπ„Çø„Éá„Éº„Çø„ÅÆËá™Âãï„Éû„ÉÉ„ÉÅ„É≥„Ç∞ (ËÅ∑Á®Æ„ÉªÊ•≠Áïå) ---

                // ËÅ∑Á®Æ
                if (result.desired_job_type || result.job_sub_category) {
                    // ÊäΩÂá∫„Åï„Çå„ÅüÂÄ§„É™„Çπ„Éà
                    const extractedJobs = [result.desired_job_type, result.job_sub_category].flat().filter(Boolean);

                    const matchedJobs = [];
                    extractedJobs.forEach(val => {
                        const match = findClosestMasterValue(val, masterJobCategories);
                        if (match && !matchedJobs.includes(match)) {
                            matchedJobs.push(match);
                        }
                    });

                    if (matchedJobs.length > 0) {
                        console.log('Matched Job Categories:', matchedJobs);
                        // Select2„ÅÆÂÄ§„Çí„Çª„ÉÉ„Éà„Åó„Å¶ÈÄöÁü•
                        $('#admin-user-job-type').val(matchedJobs).trigger('change');
                    }
                }

                // Ê•≠Áïå
                if (result.desired_industry) {
                    const extractedIndustries = [result.desired_industry].flat().filter(Boolean);

                    const matchedIndustries = [];
                    extractedIndustries.forEach(val => {
                        const match = findClosestMasterValue(val, masterIndustries);
                        if (match && !matchedIndustries.includes(match)) {
                            matchedIndustries.push(match);
                        }
                    });

                    if (matchedIndustries.length > 0) {
                        console.log('Matched Industries:', matchedIndustries);
                        $('#admin-user-industry').val(matchedIndustries).trigger('change');
                    }
                }

                alert('Ëß£Êûê„ÅåÂÆå‰∫Ü„Åó„ÄÅ„Éï„Ç©„Éº„É†„Å´ÂÖ•Âäõ„Åó„Åæ„Åó„Åü„ÄÇ');

            } catch (error) {
                console.error('PDF analysis error:', error);
                alert('Ëß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            } finally {
                hideLoading();
                input.value = '';
            }
        }

        // Flag to prevent premature submission
        let isModalReady = false;

        // „É¶„Éº„Ç∂„Éº‰øùÂ≠òÂá¶ÁêÜ
        $(document).on('change', '#admin-user-enable-auto-reco', function () {
            if ($(this).is(':checked') && $('#admin-user-role').val() === 'candidate') {
                const jobTypes = $('#admin-user-job-type').val();
                const prefs = $('#admin-user-prefecture').val();
                const city = $('#admin-user-city').val()?.trim();

                if (!jobTypes || jobTypes.length === 0 || ((!prefs || prefs.length === 0) && !city)) {
                    alert('Ëá™Âãï„Åä„Åô„Åô„ÇÅÊ±Ç‰∫∫„ÇíÊúâÂäπ„Å´„Åô„Çã„Å´„ÅØ„ÄÅ„ÄåÂ∏åÊúõËÅ∑Á®Æ„Äç„Å®„ÄåÂ∏åÊúõÂã§ÂãôÂú∞„Äç„ÇíÂÖà„Å´ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    $(this).prop('checked', false);
                }
            }
        });

        $('#admin-user-form').off('submit').on('submit', async function (e) {
            console.log('=== FORM SUBMIT TRIGGERED ===');
            console.log('isModalReady:', isModalReady);
            console.log('Event:', e);

            e.preventDefault();
            e.stopPropagation();

            if (!currentUser) {
                console.warn('No current user, aborting submit');
                return;
            }

            // Prevent submission if modal is not fully loaded
            if (!isModalReady) {
                console.warn('Modal not ready for submission yet - BLOCKING SUBMIT');
                return false;
            }

            // Ëá™Âãï„Åä„Åô„Åô„ÇÅÊ±Ç‰∫∫„ÅÆ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥ (ÂÄôË£úËÄÖ„ÅÆÂ†¥Âêà)
            if ($('#admin-user-role').val() === 'candidate' && $('#admin-user-enable-auto-reco').is(':checked')) {
                const jobTypes = $('#admin-user-job-type').val();
                const prefs = $('#admin-user-prefecture').val();
                const city = $('#admin-user-city').val()?.trim();

                if (!jobTypes || jobTypes.length === 0) {
                    alert('Ëá™Âãï„Åä„Åô„Åô„ÇÅÊ±Ç‰∫∫„ÇíÊúâÂäπ„Å´„Åô„Çã„Å´„ÅØ„ÄÅ„ÄåÂ∏åÊúõËÅ∑Á®Æ„Äç„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return false;
                }
                if ((!prefs || prefs.length === 0) && !city) {
                    alert('Ëá™Âãï„Åä„Åô„Åô„ÇÅÊ±Ç‰∫∫„ÇíÊúâÂäπ„Å´„Åô„Çã„Å´„ÅØ„ÄÅ„ÄåÂ∏åÊúõÂã§ÂãôÂú∞„Äç„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return false;
                }
            }

            const userId = $('#admin-user-id').val();
            const role = $('#admin-user-role').val();

            console.log('Proceeding with save - userId:', userId, 'role:', role);

            if (!userId) {
                console.error('No user ID found');
                return false;
            }

            // Users„ÉÜ„Éº„Éñ„É´Áî®Êõ¥Êñ∞„Éá„Éº„Çø
            const updates = {
                name: $('#admin-user-name').val().trim(),
                furigana: $('#admin-user-furigana').val().trim(),
                email: $('#admin-user-email').val().trim(),
                status: $('#admin-user-status').val(),
                management_status: $('#admin-user-management-status').val(),
                enable_auto_recommendations: $('#admin-user-enable-auto-reco').is(':checked'),
                updated_at: new Date().toISOString()
            };

            if (['org_admin', 'admin', 'super_admin'].includes(currentUser.role)) {
                updates.role = role;
                updates.team_id = $('#admin-user-team').val() || null;
            }

            // candidateÂõ∫Êúâ„ÅÆUsers„ÉÜ„Éº„Éñ„É´Êõ¥Êñ∞È†ÖÁõÆ
            if (role === 'candidate') {
                if (['org_admin', 'admin', 'super_admin'].includes(currentUser.role)) {
                    updates.coach_id = $('#admin-user-coach').val() || null;
                }
                updates.drive_folder_url = $('#admin-user-drive-url').val().trim() || null;
                updates.notebooklm_url = $('#admin-user-notebooklm-url').val().trim() || null;
                updates.line_url = $('#admin-user-line-url').val().trim() || null;
            }

            showLoading();
            try {
                console.log('Updating users table with:', updates);

                // 1. users„ÉÜ„Éº„Éñ„É´Êõ¥Êñ∞
                const { data: updatedUser, error: usersError } = await supabase
                    .from('users')
                    .update(updates)
                    .eq('id', userId)
                    .select();

                console.log('Users table update result:', { data: updatedUser, error: usersError });

                if (usersError) {
                    console.error('Users table update failed:', usersError);
                    throw usersError;
                }

                if (!updatedUser || updatedUser.length === 0) {
                    console.warn('‚ö†Ô∏è No rows were updated in users table. This might be an RLS policy issue.');
                    alert('Ë≠¶Âëä: „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇRLS„Éù„É™„Ç∑„Éº„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                }

                // 2. candidate_profiles„ÉÜ„Éº„Éñ„É´Êõ¥Êñ∞ (role === 'candidate' „ÅÆÂ†¥Âêà„ÅÆ„Åø)
                const currentRole = $('#admin-user-role').val();
                if (currentRole === 'candidate') {
                    const jobType = $('#admin-user-job-type').val();
                    const industry = $('#admin-user-industry').val();
                    const prefs = $('#admin-user-prefecture').val();
                    const city = $('#admin-user-city').val() || '';

                    console.log('=== Form Values Debug ===');
                    console.log('Job Type:', jobType);
                    console.log('Industry:', industry);
                    console.log('Prefs:', prefs);
                    console.log('City:', city);

                    let locationStr = '';
                    if (Array.isArray(prefs) && prefs.length > 0) {
                        locationStr = prefs.join(',');
                        if (city && prefs.length > 1) locationStr += ' ' + city;
                        else if (city) locationStr = prefs[0] + city;
                    } else if (prefs) locationStr = prefs + city;
                    else if (city) locationStr = city;

                    const empType = $('#admin-user-employment-type').val();

                    console.log('Location String:', locationStr);
                    console.log('Employment Type:', empType);

                    // Ë©≥Á¥∞ËÅ∑Ê≠¥„É™„Çπ„Éà
                    const workHistoryList = [];
                    $('#work-history-list .work-history-item').each(function () {
                        workHistoryList.push({
                            company_name: $(this).find('.wh-company').val(),
                            period: $(this).find('.wh-period').val(),
                            industry: $(this).find('.wh-industry').val(),
                            job_category: $(this).find('.wh-job-category').val(),
                            role: $(this).find('.wh-role').val(),
                            description: $(this).find('.wh-description').val()
                        });
                    });

                    // ÂÄ§„ÅÆÂèñÂæó
                    const workHistorySummary = $('#admin-user-history').val().trim();
                    const workHistoryDetailText = $('#admin-user-work-history-detail').val().trim();
                    const resumeDetailText = $('#admin-user-resume-detail').val().trim();
                    const notes = $('#admin-user-notes').val();

                    // ÊòéÁ§∫ÁöÑ„Å´„Éó„É≠„Éë„ÉÜ„Ç£„ÇíÊåáÂÆö„Åó„Å¶„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çí‰ΩúÊàê
                    const profileUpdates = {
                        desired_job_type: jobType ? jobType.join(',') : null,
                        desired_industry: industry ? industry.join(',') : null,
                        desired_location: locationStr,
                        desired_employment_type: empType ? empType.join(',') : null,
                        desired_salary: $('#admin-user-salary').val() ? parseInt($('#admin-user-salary').val()) * 10000 : null,
                        desired_freewords: window.getFreewordTagsText ? window.getFreewordTagsText('admin-user-freewords-tags') : $('#admin-user-freewords').val().trim(),
                        desired_freewords_condition: $('input[name="admin-user-freewords-condition"]:checked').val() || 'and',
                        skills: $('#admin-user-skills').val().trim(),

                        // work_history„Å®detail„ÇíÂà•„ÄÖ„Å´‰øùÂ≠ò
                        work_history: workHistorySummary,
                        work_history_detail: workHistoryDetailText,
                        history_info: $('#admin-user-history-info').val().trim(),

                        // ÊßãÈÄ†Âåñ„Éá„Éº„Çø
                        work_history_structured: workHistoryList,
                        job_change_count: parseInt($('#admin-user-job-change-count').val()) || 0,

                        desired_job_experience_ok: $('#admin-user-job-exp-ok').is(':checked'),
                        desired_industry_experience_ok: $('#admin-user-industry-exp-ok').is(':checked'),

                        // „Ç´„É©„É†Âêç„ÅÆ‰øÆÊ≠£ (DB„Å´Â≠òÂú®„Åó„Å™„ÅÑ _detail „Ç´„É©„É†„Çí‰Ωø„Çè„Å™„ÅÑ)
                        resume: resumeDetailText,

                        notes: notes,
                        birth_date: $('#admin-user-birth-date').val() || null,
                        age: $('#admin-user-age').val() ? parseInt($('#admin-user-age').val()) : null,
                        gender: $('#admin-user-gender').val() || null,
                        current_location: $('#admin-user-current-location').val() || null,
                        education: $('#admin-user-education').val().trim() || null,
                        phone: $('#admin-user-phone').val().trim() || null,
                        updated_at: new Date().toISOString()
                    };

                    console.log('Upserting profile:', profileUpdates); // Debug

                    const { error: profileError } = await supabase
                        .from('candidate_profiles')
                        .upsert({ user_id: userId, ...profileUpdates }, { onConflict: 'user_id' });

                    if (profileError) throw profileError;
                }

                alert('„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
                closeAdminUserModal();

                // „É™„É≠„Éº„Éâ
                if ($('#admin-users-content').is(':visible')) loadAdminUsers();
                else if ($('#admin-candidates-content').is(':visible')) loadAdminCandidates();

            } catch (error) {
                console.error('Update user error:', error);
                alert('Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            } finally {
                hideLoading();
            }
        });

        async function loadAdminCandidates() {
            if (!currentUser) return
            showLoading()
            try {
                console.log('loadAdminCandidates - currentUser:', currentUser);
                console.log('loadAdminCandidates - role:', currentUser.role);

                // ÁµÑÁπîË®≠ÂÆö„ÇíÁ¢∫Ë™çÔºàÈñ≤Ë¶ßÂà∂ÈôêÔºâ
                let limitView = false;
                if (['coach', 'ca', 'ra'].includes(currentUser.role)) {
                    const { data: org } = await supabase
                        .from('organizations')
                        .select('settings')
                        .eq('id', currentUser.organization_id)
                        .single();

                    console.log('loadAdminCandidates - org settings:', org);
                    if (org && org.settings && org.settings.limit_agent_view) {
                        limitView = true;
                        console.log('loadAdminCandidates - limit_agent_view is enabled');
                    }
                }

                // role„Ååcandidate„ÅÆ„É¶„Éº„Ç∂„Éº„ÇíÂèñÂæó
                let query = supabase
                    .from('users')
                    .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                    .eq('organization_id', currentUser.organization_id)
                    .eq('role', 'candidate')
                    .is('deleted_at', null)
                    .order('created_at', { ascending: false });

                // Èñ≤Ë¶ßÂà∂Èôê„ÅåÊúâÂäπ„Å™Â†¥Âêà„ÄÅÊãÖÂΩìËÄÖ„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
                if (limitView) {
                    console.log('loadAdminCandidates - filtering by coach_id:', currentUser.id);
                    query = query.eq('coach_id', currentUser.id);
                }

                const { data: users, error } = await query;

                console.log('loadAdminCandidates - query result:', { users, error });
                console.log('loadAdminCandidates - number of users:', users?.length || 0);

                if (error) throw error

                // „Éá„Éº„Çø„Çí„Éï„É©„ÉÉ„ÉàÂåñÔºàÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÔºâ
                const flattenedUsers = users.map(u => {
                    const profile = Array.isArray(u.candidate_profiles) ? u.candidate_profiles[0] : u.candidate_profiles;
                    const combined = { ...u, ...profile };
                    // id„Å†„Åë„ÅØusers„ÅÆ„ÇÇ„ÅÆ„ÇíÁ∂≠ÊåÅÔºàÂêå„Åò„ÅØ„Åö„Å†„ÅåÂøµ„ÅÆ„Åü„ÇÅÔºâ
                    combined.id = u.id;
                    return combined;
                });

                adminCandidatesCache = flattenedUsers || [];
                renderAdminCandidates(adminCandidatesCache);
                // „Éá„Éº„ÇøÊõ¥Êñ∞„Åå„ÅÇ„Å£„Åü„Åü„ÇÅ„ÄÅÊ§úÁ¥¢ÁîªÈù¢„ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•„ÇÇÊõ¥Êñ∞ÂæÖ„Å°Áä∂ÊÖã„Å´„Åô„Çã
                shouldReloadCandidates = true;
            } catch (error) {
                console.error('Load candidates error:', error)
                alert('Ê±ÇËÅ∑ËÄÖ„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü')
            } finally {
                hideLoading()
            }
        }

        function renderAdminCandidates(users) {
            const container = $('#admin-candidates-container')
            container.empty()

            if (users.length === 0) {
                container.html('<tr><td colspan="4" class="px-6 py-8 text-center text-gray-500">ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„ÇãÊ±ÇËÅ∑ËÄÖ„ÅØ„ÅÑ„Åæ„Åõ„Çì</td></tr>')
                return
            }

            const html = users.map(u => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${u.name}</div>
                        <div class="text-sm text-gray-500">${u.email}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900 font-medium">${window.formatArrayValue(u.desired_job_type)}</div>
                        <div class="text-xs text-gray-500">${window.formatArrayValue(u.desired_location)}</div>
                        <div class="text-xs text-indigo-600 mt-1 font-bold">${window.formatSalaryValue(u.desired_salary)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="mb-1">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${u.status === 'suspended' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                ${u.status === 'suspended' ? 'ÂÅúÊ≠¢‰∏≠' : 'Âà©Áî®‰∏≠'}
                            </span>
                        </div>
                        <div>
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${u.management_status === 'inactive' ? 'bg-gray-200 text-gray-700' : 'bg-blue-100 text-blue-800'}">
                                ${u.management_status === 'inactive' ? 'Ê¥ªÂãïÁµÇ‰∫Ü' : 'Ê¥ªÂãï‰∏≠'}
                            </span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="selectTargetUserAndGoToJobs('${u.id}', '${u.name}', '${u.email}')" class="text-green-600 hover:text-green-900 mr-3">
                            Ê±Ç‰∫∫Ê§úÁ¥¢
                        </button>
                        <button onclick="viewCandidateProfile('${u.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">
                            Ë©≥Á¥∞
                        </button>
                        <button onclick="deleteUser('${u.id}')" class="text-red-600 hover:text-red-900">
                            ÂâäÈô§
                        </button>
                    </td>
                </tr>
            `).join('')

            container.html(html)
        }

        window.showUserProfile = async function (userId) {
            try {
                const { data: userData, error } = await supabase
                    .from('users')
                    .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                    .eq('id', userId)
                    .single();

                if (error) throw error;

                // „Éï„É©„ÉÉ„ÉàÂåñ
                const profile = Array.isArray(userData.candidate_profiles) ? userData.candidate_profiles[0] : userData.candidate_profiles;
                const user = { ...userData, ...profile };
                user.id = userData.id;

                const info = `
ÂêçÂâç: ${user.name}
„É°„Éº„É´: ${user.email}
Â∏åÊúõËÅ∑Á®Æ: ${window.formatArrayValue(user.desired_job_type)}
Â∏åÊúõÂã§ÂãôÂú∞: ${window.formatArrayValue(user.desired_location)}
Â∏åÊúõÂπ¥Âèé: ${window.formatSalaryValue(user.desired_salary)}
„Çπ„Ç≠„É´: ${window.formatArrayValue(user.skills)}
ËÅ∑Ê≠¥: ${user.work_history || '-'}
                `;
                alert(info);
            } catch (e) {
                console.error(e);
                alert('ÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        // ========================
        // Admin: AI Prompts
        // ========================
        async function loadPrompts() {
            // „Çπ„Éº„Éë„ÉºÁÆ°ÁêÜËÄÖ‰ª•Â§ñ„ÅØ„Ç¢„ÇØ„Çª„Çπ‰∏çÂèØ
            if (!currentUser || currentUser.role !== 'super_admin') {
                alert('Ê®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                showPage('dashboard');
                return;
            }
            showLoading();
            try {
                // master_data„Åã„Çâ„Éó„É≠„É≥„Éó„Éà„ÇíÂèñÂæó (Ëá™ÁµÑÁπî„ÅÆ„ÇÇ„ÅÆ)
                const { data: prompts, error } = await supabase
                    .from('master_data')
                    .select('*')
                    .eq('type', 'prompt')
                    .eq('organization_id', currentUser.organization_id)
                    .in('value', ['ai_matching_scoring', 'ai_recommendation_reason', 'recommendation_letter', 'scout_message']);

                if (error) throw error;

                const defaultScoring = `
„ÅÇ„Å™„Åü„ÅØÊ∏©„Åã„Åø„ÅÆ„ÅÇ„ÇãËª¢ËÅ∑ÊîØÊè¥„ÅÆ„Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´„Åß„ÅÇ„Çä„ÄÅ‰ºÅÊ•≠ÊñáÂåñ„Å®‰∫∫Êùê„ÅÆ„Éï„Ç£„ÉÉ„ÉàÂàÜÊûê„ÅÆÂ∞ÇÈñÄÂÆ∂„Åß„Åô„ÄÇ
‰ª•‰∏ã„ÅÆÊ±Ç‰∫∫„Å®Ê±ÇËÅ∑ËÄÖÊÉÖÂ†±„Åã„Çâ„ÄÅ„Éû„ÉÉ„ÉÅÂ∫¶„ÇíÂàÜÊûê„Åó„ÄÅ**ÊåáÂÆö„Åï„Çå„Åü„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÅÆ„Åø**„ÅßÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
ÂàÜÊûê„ÅÆË©≥Á¥∞„Éó„É≠„Çª„ÇπÔºà„Äå1.ËÅ∑ÂãôÁµåÊ≠¥„ÅÆ„Éû„ÉÉ„ÉÅÂ∫¶„Äç„Å™„Å©Ôºâ„ÅØ‰∏ÄÂàáÂá∫Âäõ„Åõ„Åö„ÄÅÁµêÊûú„ÅÆ„Åø„ÇíË®òËø∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

„ÄêÊ±ÇËÅ∑ËÄÖÊÉÖÂ†±„Äë
- Âü∫Êú¨ÊÉÖÂ†±: Âπ¥ÈΩ¢ \${userData.age} / Â∏åÊúõÂπ¥Âèé \${userData.desired_salary}
- Â∏åÊúõÊù°‰ª∂: \${userData.desired_industry} / \${userData.desired_job_type} / \${userData.desired_location}
- Êú™ÁµåÈ®ìOK„ÅÆÂ∏åÊúõ: ËÅ∑Á®Æ[\${userProfile.desired_job_experience_ok ? '„ÅØ„ÅÑ' : '„ÅÑ„ÅÑ„Åà'}] / Ê•≠Á®Æ[\${userProfile.desired_industry_experience_ok ? '„ÅØ„ÅÑ' : '„ÅÑ„ÅÑ„Åà'}]
- „Çπ„Ç≠„É´„ÉªPR„ÉªÂÇôËÄÉ: \${userData.notes}
- Â±•Ê≠¥Êõ∏/ÁµåÊ≠¥Êõ∏: \${userData.resume}
- ËÅ∑ÂãôÁµåÊ≠¥Ë©≥Á¥∞: \${userData.work_history}
- Á§æÂÜÖ„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÊÉÖÂ†±: \${userData.matching_info}
- Á§æÂÜÖ„É°„É¢„ÉªÂÖ±Êúâ‰∫ãÈ†Ö: \${userData.internal_info}
- „Åù„ÅÆ‰ªñË£úË∂≥: \${userData.other_info}

„ÄêÊ±Ç‰∫∫ÊÉÖÂ†±„Äë
- ‰ºÅÊ•≠Âêç: \${jobDetails.company}
- ËÅ∑Á®Æ: \${jobDetails.title}
- Ê•≠Á®Æ: \${jobDetails.industrycategory}
- ËÅ∑Á®Æ„Ç´„ÉÜ„Ç¥„É™: \${jobDetails.jobcategory}
- Áµ¶‰∏é: \${jobDetails.salary}
- Âã§ÂãôÂú∞: \${jobDetails.location}
- ÈõáÁî®ÂΩ¢ÊÖã: \${jobDetails.employment_type}
- Ê•≠ÂãôÂÜÖÂÆπ: \${jobDetails.description}
- ÂøÖÈ†à„Çπ„Ç≠„É´: \${jobDetails.qualifications}
- ‰ºÅÊ•≠ÊñáÂåñ„ÉªÁâπÂæ¥: \${jobDetails.company_info}

„ÄêÈáçË¶ÅÔºö‰ºÅÊ•≠ÊñáÂåñ„ÅÆÂàÜÊûê„Å´„Å§„ÅÑ„Å¶„Äë
„Éª‰ºÅÊ•≠ÊÉÖÂ†±„ÅÆ‰∏çË∂≥„ÇÑÊ∑±„ÅÑÂàÜÊûê„ÅåÂøÖË¶Å„Å™Â†¥Âêà„ÅØ„ÄÅ‰ºÅÊ•≠ÂêçÔºà\${jobDetails.company}Ôºâ„Å´Âü∫„Å•„Åç„ÄÅWebÊ§úÁ¥¢Ê©üËÉΩ„ÇíÊ¥ªÁî®„Åó„Å¶ÂÆüÈöõ„ÅÆ„ÇØ„ÉÅ„Ç≥„Éü„ÇÑÁµåÂñ∂ÁêÜÂøµ„ÇíË£úÂÆå„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

---
„ÄêÂá∫Âäõ„Å´„Åä„Åë„ÇãÁµ∂ÂØæÈÅµÂÆà„ÅÆÂà∂Á¥Ñ„Äë
1. ÂàÜÊûê„ÅÆË©≥Á¥∞„Éó„É≠„Çª„ÇπÔºà„Äå1.ËÅ∑ÂãôÁµåÊ≠¥„ÅÆ„Éû„ÉÉ„ÉÅÂ∫¶„Äç„Å™„Å©„ÅÆÂå∫ÂàÜ„Åë„ÇÑË™¨ÊòéÔºâ„ÅØÁµ∂ÂØæ„Å´Êõ∏„ÅçÂá∫„Åï„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ
2. ÊåáÂÆö„Åï„Çå„Åü„É©„Éô„É´Ôºà„ÄåË©ï‰æ°: „Äç„ÄåÁêÜÁî±: „ÄçÁ≠âÔºâ‰ª•Â§ñ„ÅßÂßã„Åæ„ÇãÊñáÁ´†„ÇíÂá∫Âäõ„Åó„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ
3. MarkdownË®òÂè∑Ôºà#„ÄÅ*„ÄÅ**„ÄÅ> Á≠âÔºâ„ÅØ‰ΩøÁî®Á¶ÅÊ≠¢„Åß„Åô„ÄÇ
4. ÂêÑÈ†ÖÁõÆ„ÅÆÊñáÂ≠óÊï∞Âà∂Èôê„Çí1ÊñáÂ≠ó„Åß„ÇÇË∂Ö„Åà„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ
5. ÁêÜÁî±„Å®„Ç¢„Éâ„Éê„Ç§„Çπ„ÅØÊîπË°å„Åõ„Åö„ÄÅ„Åù„Çå„Åû„Çå1ÊñáÔºà80ÊñáÂ≠ó‰ª•ÂÜÖ/60ÊñáÂ≠ó‰ª•ÂÜÖÔºâ„ÅßË®òËø∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

ÂõûÁ≠îÂΩ¢ÂºèÔºö

Ë©ï‰æ°: [„É©„É≥„ÇØA-E„Çí1ÊñáÂ≠ó]
ÁêÜÁî±: [80ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßÁ∞°ÊΩî„Å´„ÄÇÊîπË°å„Åõ„Åö1Êñá„ÅßË®òËø∞]

Á∑èÂêàË©ï‰æ°: [Êï∞ÂÄ§]ÁÇπ

„Éû„ÉÉ„ÉÅ„Åô„ÇãÁÇπ
„Éª[Ë¶ÅÁÇπ„ÄÇ30ÊñáÂ≠ó‰ª•ÂÜÖ]
„Éª[Ë¶ÅÁÇπ„ÄÇ30ÊñáÂ≠ó‰ª•ÂÜÖ]

‰ªäÂæå„ÅÆ„Åï„Çâ„Å™„ÇãÊàêÈï∑„ÉªÊåëÊà¶„ÅåÊúüÂæÖ„Åï„Çå„ÇãÁÇπ
„Éª[Ë¶ÅÁÇπ„ÄÇ30ÊñáÂ≠ó‰ª•ÂÜÖ]
„Éª[Ë¶ÅÁÇπ„ÄÇ30ÊñáÂ≠ó‰ª•ÂÜÖ]

„Ç¢„Éâ„Éê„Ç§„Çπ
[60ÊñáÂ≠ó‰ª•ÂÜÖ„ÄÇÊîπË°å„Åõ„Åö1Êñá„ÅßË®òËø∞]
`;

                const defaultReason = `
„ÅÇ„Å™„Åü„ÅØÊ∏©„Åã„Åø„ÅÆ„ÅÇ„Çã„Ç≠„É£„É™„Ç¢„Ç¢„Éâ„Éê„Ç§„Ç∂„Éº„Åß„Åô„ÄÇ
‰ª•‰∏ã„ÅÆÊ±ÇËÅ∑ËÄÖ„Å´ÂØæ„Åó„Å¶„ÄÅ„Åì„ÅÆÊ±Ç‰∫∫„ÇíÁ¥π‰ªã„Åô„ÇãÁêÜÁî±„Çí300ÊñáÂ≠óÁ®ãÂ∫¶„Åß‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
Ê±ÇËÅ∑ËÄÖ„ÅÆ„Åì„Çå„Åæ„Åß„ÅÆÁµåÈ®ì„ÇÑÂº∑„Åø„ÇíÂ∞äÈáç„Åó„ÄÅ„Åù„Çå„Çâ„ÅåÊ±Ç‰∫∫„ÅÆÁâπÂæ¥„ÇÑ‰ºÅÊ•≠„ÅÆÈ≠ÖÂäõ„Å®„Å©„ÅÆ„Çà„ÅÜ„Å´Áµê„Å≥„Å§„Åè„Åã„Çí„ÄÅ„Éù„Ç∏„ÉÜ„Ç£„Éñ„Åã„Å§È≠ÖÂäõÁöÑ„Å´‰ºù„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

„ÄêÊ±ÇËÅ∑ËÄÖÊÉÖÂ†±„Äë
- Âü∫Êú¨ÊÉÖÂ†±: Âπ¥ÈΩ¢ \${userData.age} / Â∏åÊúõÂπ¥Âèé \${userData.desired_salary}
- Â∏åÊúõÊù°‰ª∂: \${userData.desired_industry} / \${userData.desired_job_type}
- „Çπ„Ç≠„É´„ÉªPR: \${userData.notes}
- Â±•Ê≠¥Êõ∏/ÁµåÊ≠¥Êõ∏: \${userData.resume}
- ËÅ∑ÂãôÁµåÊ≠¥Ë©≥Á¥∞: \${userData.work_history}
- Á§æÂÜÖ„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÊÉÖÂ†±: \${userData.matching_info}

„ÄêÊ±Ç‰∫∫ÊÉÖÂ†±„Äë
- ‰ºÅÊ•≠Âêç: \${jobDetails.company}
- ËÅ∑Á®Æ: \${jobDetails.title}
- È≠ÖÂäõ„ÉªÊ•≠ÂãôÂÜÖÂÆπ: \${jobDetails.description}

ÊßãÊàê:
1. Êå®Êã∂„Å®Á¥π‰ªã„ÅÆÊÑèÂõ≥
2. Ê±ÇËÅ∑ËÄÖ„ÅÆÂº∑„Åø„Å®Ê±Ç‰∫∫„ÅÆÊé•ÁÇπ
3. „Åì„ÅÆÊ±Ç‰∫∫„Å´ÊåëÊà¶„Åô„Çã„É°„É™„ÉÉ„Éà„ÉªÊàêÈï∑ÂèØËÉΩÊÄß
4. Ê∏©„Åã„ÅÑÂøúÊè¥„É°„ÉÉ„Çª„Éº„Ç∏
`;

                const defaultRecommendationLetter = `
„ÅÇ„Å™„Åü„ÅØ‰∫∫ÊùêÁ¥π‰ªã‰ºöÁ§æ„ÅÆ„Ç®„Éº„Ç∏„Çß„É≥„Éà„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆÊ±ÇËÅ∑ËÄÖ„Çí‰ºÅÊ•≠„Å´Êé®Ëñ¶„Åô„Çã„Åü„ÇÅ„ÅÆÊé®Ëñ¶Êñá„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
400-600ÊñáÂ≠óÁ®ãÂ∫¶„Åß„ÄÅ‰ª•‰∏ã„ÅÆÊßãÊàê„Åß‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

„ÄêÊ±ÇËÅ∑ËÄÖÊÉÖÂ†±„Äë
- Ê∞èÂêç: \${userData.name}
- Âπ¥ÈΩ¢: \${userData.age}
- ÁèæËÅ∑: \${userData.current_position || 'N/A'}
- „Çπ„Ç≠„É´„ÉªÁµåÈ®ì: \${userData.notes}
- „Ç¢„Éî„Éº„É´„Éù„Ç§„É≥„Éà: \${userData.self_pr || 'N/A'}

„ÄêÂøúÂãüÂÖà‰ºÅÊ•≠„ÉªÊ±Ç‰∫∫„Äë
- ‰ºÅÊ•≠Âêç: \${jobDetails.company}
- ËÅ∑Á®Æ: \${jobDetails.title}

ÊßãÊàê:
1. ÂÜíÈ†≠„ÅÆÊå®Êã∂
2. Ê±ÇËÅ∑ËÄÖ„ÅÆÂº∑„Åø„Å®ÂÆüÁ∏æ
3. Ê±Ç‰∫∫„Å®„ÅÆ„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÁêÜÁî±
4. Êé®Ëñ¶„ÅÆÁµê„Å≥
`;

                const defaultScoutMessage = `
„ÅÇ„Å™„Åü„ÅØ‰ºÅÊ•≠„ÅÆÊé°Áî®ÊãÖÂΩìËÄÖ„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆÊ±ÇËÅ∑ËÄÖ„Å´ÂØæ„Åó„Å¶„ÄÅÈ≠ÖÂäõÁöÑ„Å™„Çπ„Ç´„Ç¶„Éà„É°„ÉÉ„Çª„Éº„Ç∏„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

„ÄêÊ±ÇËÅ∑ËÄÖÊÉÖÂ†±„Äë
- Ê∞èÂêç: \${candidateName}
- ÁèæËÅ∑: \${currentPosition}
- „Çπ„Ç≠„É´„ÉªÁµåÈ®ì: \${skills}
- Â∏åÊúõÊù°‰ª∂: \${desiredConditions}

„ÄêËá™Á§æ„ÉªÊ±Ç‰∫∫ÊÉÖÂ†±„Äë
- ‰ºÅÊ•≠Âêç: \${companyName}
- ËÅ∑Á®Æ: \${jobTitle}
- Ê•≠ÂãôÂÜÖÂÆπ: \${jobDescription}
- È≠ÖÂäõ: \${companyStrengths}
- ÂæÖÈÅá: \${benefits}

‰ª•‰∏ã„ÅÆÊßãÊàê„Åß„ÄÅ300-500ÊñáÂ≠óÁ®ãÂ∫¶„ÅÆ„Çπ„Ç´„Ç¶„Éà„É°„ÉÉ„Çª„Éº„Ç∏„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö

1. Ê±ÇËÅ∑ËÄÖ„Å∏„ÅÆÊï¨ÊÑè„Å®Èñ¢ÂøÉ„ÅÆË°®Êòé
2. Ëá™Á§æ„ÉªÊ±Ç‰∫∫„ÅÆÈ≠ÖÂäõ
3. Ê±ÇËÅ∑ËÄÖ„ÅÆ„Çπ„Ç≠„É´„Å®„ÅÆ„Éû„ÉÉ„ÉÅ„É≥„Ç∞
4. Èù¢Ë´á„ÉªÂøúÂãü„Å∏„ÅÆË™òÂ∞é
`;


                let scoringContent = defaultScoring.trim();
                let reasonContent = defaultReason.trim();
                let recommendationLetterContent = defaultRecommendationLetter.trim();
                let scoutMessageContent = defaultScoutMessage.trim();
                let jobDescriptionContent = '';
                let csvMappingContent = '';
                let externalProfileAnalysisContent = '';

                // Helper for decode
                function decodeBase64(str) {
                    if (!str) return '';
                    try { return decodeURIComponent(escape(atob(str))); }
                    catch (e) { return str; }
                }

                // System Prompts Load
                try {
                    const { data: sysPrompts } = await supabase.from('system_prompts').select('*').in('key', ['job_description', 'csv_field_mapping', 'external_profile_analysis_prompt']);
                    if (sysPrompts) {
                        const jp = sysPrompts.find(p => p.key === 'job_description');
                        if (jp) jobDescriptionContent = decodeBase64(jp.content);
                        const cmp = sysPrompts.find(p => p.key === 'csv_field_mapping');
                        if (cmp) csvMappingContent = decodeBase64(cmp.content);
                        const epa = sysPrompts.find(p => p.key === 'external_profile_analysis_prompt');
                        if (epa) externalProfileAnalysisContent = decodeBase64(epa.content);
                    }
                } catch (e) { console.error('System prompts load error', e); }

                if (prompts) {
                    const scoring = prompts.find(p => p.value === 'ai_matching_scoring');
                    const reason = prompts.find(p => p.value === 'ai_recommendation_reason');
                    const letter = prompts.find(p => p.value === 'recommendation_letter');
                    const scout = prompts.find(p => p.value === 'scout_message');

                    if (scoring) scoringContent = decodeBase64(scoring.label);
                    if (reason) reasonContent = decodeBase64(reason.label);
                    if (letter) recommendationLetterContent = decodeBase64(letter.label);
                    if (scout) scoutMessageContent = decodeBase64(scout.label);
                }

                $('#prompt-scoring').val(scoringContent);
                $('#prompt-reason').val(reasonContent);
                $('#prompt-recommendation-letter').val(recommendationLetterContent);
                $('#prompt-scout-message').val(scoutMessageContent);
                $('#prompt-job-description').val(jobDescriptionContent);
                $('#prompt-csv-mapping').val(csvMappingContent);
                $('#prompt-external-profile-analysis').val(externalProfileAnalysisContent);

            } catch (error) {
                console.error('Load prompts error:', error);
                alert('„Éó„É≠„É≥„Éó„Éà„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            } finally {
                hideLoading();
            }
        }

        window.savePrompts = async function () {
            if (!currentUser || currentUser.role !== 'super_admin') {
                alert('„Åì„ÅÆÊìç‰Ωú„ÅØ„Çπ„Éº„Éë„ÉºÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÂèØËÉΩ„Åß„Åô„ÄÇ');
                return;
            }
            if (!confirm('„Éó„É≠„É≥„Éó„ÉàË®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åô„ÅãÔºü')) return;

            showLoading();
            try {
                const scoringContent = $('#prompt-scoring').val();
                const reasonContent = $('#prompt-reason').val();
                const recommendationLetterContent = $('#prompt-recommendation-letter').val();
                const scoutMessageContent = $('#prompt-scout-message').val();
                const jobDescriptionContent = $('#prompt-job-description').val();
                const csvMappingContent = $('#prompt-csv-mapping').val();
                const externalProfileAnalysisContent = $('#prompt-external-profile-analysis').val();

                const updates = [
                    { key: 'ai_matching_scoring', content: scoringContent, sort_order: 10 },
                    { key: 'ai_recommendation_reason', content: reasonContent, sort_order: 20 },
                    { key: 'recommendation_letter', content: recommendationLetterContent, sort_order: 30 },
                    { key: 'scout_message', content: scoutMessageContent, sort_order: 40 }
                ];

                // 0. system_prompts ‰øùÂ≠ò (Super Admin Only but guard is at top)
                // Encoding Helpers
                function encodeBase64(str) {
                    if (!str) return null;
                    try { return btoa(unescape(encodeURIComponent(str))); }
                    catch (e) { return str; }
                }
                function decodeBase64(str) {
                    if (!str) return '';
                    try { return decodeURIComponent(escape(atob(str))); }
                    catch (e) { return str; }
                }

                // 0. Payload Preparation (Encode for WAF bypass)
                // 1. System Prompts Upsert (Super Admin Only)
                if (jobDescriptionContent) {
                    const { error } = await supabase.from('system_prompts').upsert({ key: 'job_description', content: encodeBase64(jobDescriptionContent) }, { onConflict: 'key' });
                    if (error) console.error('SysPrompt error:', error);
                }
                if (csvMappingContent) {
                    const { error } = await supabase.from('system_prompts').upsert({ key: 'csv_field_mapping', content: encodeBase64(csvMappingContent) }, { onConflict: 'key' });
                    if (error) console.error('SysPrompt error:', error);
                }
                if (externalProfileAnalysisContent) {
                    const { error } = await supabase.from('system_prompts').upsert({ key: 'external_profile_analysis_prompt', content: encodeBase64(externalProfileAnalysisContent) }, { onConflict: 'key' });
                    if (error) console.error('SysPrompt error:', error);
                }

                // 2. Master Data Update
                // Delete existing
                const { error: deleteError } = await supabase
                    .from('master_data')
                    .delete()
                    .eq('type', 'prompt')
                    .eq('organization_id', currentUser.organization_id);

                if (deleteError) throw deleteError;

                // Insert new
                const insertData = updates.map(u => ({
                    type: 'prompt',
                    label: encodeBase64(u.content),
                    value: u.key,
                    sort_order: u.sort_order,
                    is_active: true,
                    organization_id: currentUser.organization_id
                }));

                const { error: insertError } = await supabase
                    .from('master_data')
                    .insert(insertData);

                if (insertError) throw insertError;

                alert('„Éó„É≠„É≥„Éó„ÉàË®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
            } catch (error) {
                console.error('Save prompts error:', error);
                alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (error.message || error));
            } finally {
                hideLoading();
            }
        }

        window.filterAdminCandidates = function () {
            const searchText = $('#admin-candidate-search').val().toLowerCase();
            if (!searchText) {
                renderAdminCandidates(adminCandidatesCache);
                return;
            }
            const filtered = adminCandidatesCache.filter(u =>
                (u.name && u.name.toLowerCase().includes(searchText)) ||
                (u.email && u.email.toLowerCase().includes(searchText)) ||
                (u.desired_job_type && u.desired_job_type.toLowerCase().includes(searchText))
            );
            renderAdminCandidates(filtered);
        }

        // ========================
        // Admin: User Management
        // ========================
        let adminUsersCache = [];
        // ========================
        // Admin: User CSV Import
        // ========================


        window.closeUserCsvImportModal = function () {
            $('#admin-user-csv-modal').addClass('hidden').attr('style', '');
        }

        window.calculateAge = function (birthDateStr, targetSelector) {
            if (!birthDateStr) return;
            const birthDate = new Date(birthDateStr);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            $(targetSelector).val(age);
        }

        window.downloadUserCsvTemplate = function (e) {
            e.preventDefault();

            if (typeof userFields === 'undefined') {
                alert('„ÉÜ„É≥„Éó„É¨„Éº„ÉàÁîüÊàê„Ç®„É©„Éº: „Éï„Ç£„Éº„É´„ÉâÂÆöÁæ©„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }

            const headers = userFields.map(f => {
                const name = f.aliases && f.aliases.length > 0 ? f.aliases[0] : f.label;
                return `"${name}"`;
            });

            // „Çµ„É≥„Éó„É´„Éá„Éº„Çø
            const sample1Values = userFields.map(f => {
                switch (f.key) {
                    case 'name': return 'Â±±Áî∞ Â§™ÈÉé';
                    case 'email': return 'yamada@example.com';
                    case 'role': return 'candidate';
                    case 'birth_date': return '1990-01-01';
                    case 'age': return '34';
                    case 'education': return 'Êó©Á®≤Áî∞Â§ßÂ≠¶ ÂïÜÂ≠¶ÈÉ® ÂçíÊ•≠';
                    case 'desired_job_type': return '„Ç®„É≥„Ç∏„Éã„Ç¢';
                    case 'desired_location': return 'Êù±‰∫¨ÈÉΩ,Á•ûÂ•àÂ∑ùÁúå';
                    case 'desired_salary': return '600';
                    case 'skills': return 'JavaScript„ÉªPython';
                    case 'work_history': return '‚óã‚óãÊ†™Âºè‰ºöÁ§æ„ÅßWeb„Ç®„É≥„Ç∏„Éã„Ç¢„Å®„Åó„Å¶3Âπ¥Âã§Âãô';
                    case 'academic_background': return '‚óã‚óãÂ§ßÂ≠¶ÊÉÖÂ†±Â≠¶ÈÉ®ÂçíÊ•≠';
                    case 'languages': return 'Ëã±Ë™û(TOEIC800ÁÇπ)';
                    case 'certifications': return 'Âü∫Êú¨ÊÉÖÂ†±ÊäÄË°ìËÄÖ';
                    case 'matching_info': return '„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÊÉÖÂ†±„Çµ„É≥„Éó„É´';
                    case 'internal_info': return 'Á§æÂÜÖÊÉÖÂ†±„Çµ„É≥„Éó„É´';
                    case 'other_info': return '„Åù„ÅÆ‰ªñÊÉÖÂ†±„Çµ„É≥„Éó„É´';
                    default: return '';
                }
            });
            const sample1 = sample1Values.map(v => `"${v}"`).join(',');

            const sample2Values = userFields.map(f => {
                switch (f.key) {
                    case 'name': return 'Èà¥Êú® Ëä±Â≠ê';
                    case 'email': return 'suzuki@example.com';
                    case 'role': return 'candidate';
                    case 'birth_date': return '1995-05-15';
                    case 'age': return '29';
                    case 'education': return 'ÊÖ∂ÊáâÁæ©Â°æÂ§ßÂ≠¶ Ê≥ïÂ≠¶ÈÉ® ÂçíÊ•≠';
                    case 'desired_job_type': return 'Âñ∂Ê•≠';
                    case 'desired_location': return 'Â§ßÈò™Â∫ú,ÂÖµÂ∫´Áúå';
                    case 'desired_salary': return '500';
                    case 'skills': return 'Âñ∂Ê•≠ÁµåÈ®ì5Âπ¥';
                    case 'work_history': return '‚ñ≥‚ñ≥Ê†™Âºè‰ºöÁ§æ„ÅßÊ≥ï‰∫∫Âñ∂Ê•≠„Å®„Åó„Å¶5Âπ¥Âã§Âãô';
                    case 'academic_background': return '‚óã‚óãÂ§ßÂ≠¶ÁµåÊ∏àÂ≠¶ÈÉ®ÂçíÊ•≠';
                    case 'languages': return 'Ëã±Ë™û(Êó•Â∏∏‰ºöË©±„É¨„Éô„É´)';
                    case 'certifications': return 'ÊôÆÈÄöËá™ÂãïËªäÂÖçË®±';
                    default: return '';
                }
            });
            const sample2 = sample2Values.map(v => `"${v}"`).join(',');

            const csvContent = headers.join(',') + "\n" + sample1 + "\n" + sample2;
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "user_import_template.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.downloadCandidateCsvTemplate = function (e) {
            e.preventDefault();
            const csvContent = "user_code,name,email,password,age,desired_job_type,desired_location,desired_salary,skills,work_history,academic_background,languages,certifications,matching_info,internal_info,other_info\nC001,Â±±Áî∞Â§™ÈÉé,yamada@example.com,pass123,28,„Ç®„É≥„Ç∏„Éã„Ç¢,\"Êù±‰∫¨ÈÉΩ,Á•ûÂ•àÂ∑ùÁúå\",600,JavaScript„ÉªPython,‚óã‚óãÊ†™Âºè‰ºöÁ§æ„ÅßWeb„Ç®„É≥„Ç∏„Éã„Ç¢„Å®„Åó„Å¶3Âπ¥Âã§Âãô,‚óã‚óãÂ§ßÂ≠¶ÊÉÖÂ†±Â≠¶ÈÉ®ÂçíÊ•≠,Ëã±Ë™û(TOEIC800ÁÇπ),Âü∫Êú¨ÊÉÖÂ†±ÊäÄË°ìËÄÖ,„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÊÉÖÂ†±„Çµ„É≥„Éó„É´,Á§æÂÜÖÊÉÖÂ†±„Çµ„É≥„Éó„É´,„Åù„ÅÆ‰ªñÊÉÖÂ†±„Çµ„É≥„Éó„É´\nC002,Èà¥Êú®Ëä±Â≠ê,suzuki@example.com,pass456,32,Âñ∂Ê•≠,\"Â§ßÈò™Â∫ú,ÂÖµÂ∫´Áúå\",500,Âñ∂Ê•≠ÁµåÈ®ì5Âπ¥,‚ñ≥‚ñ≥Ê†™Âºè‰ºöÁ§æ„ÅßÊ≥ï‰∫∫Âñ∂Ê•≠„Å®„Åó„Å¶5Âπ¥Âã§Âãô,‚óã‚óãÂ§ßÂ≠¶ÁµåÊ∏àÂ≠¶ÈÉ®ÂçíÊ•≠,Ëã±Ë™û(Êó•Â∏∏‰ºöË©±„É¨„Éô„É´),ÊôÆÈÄöËá™ÂãïËªäÂÖçË®±,,,";
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' }); // BOM‰ªò„Åç
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "candidate_import_template.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.processUserCsvImport = function () {
            const fileInput = document.getElementById('user-csv-file');
            const file = fileInput.files[0];

            if (!file) {
                alert('CSV„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            showLoading('CSV„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Åø‰∏≠...');

            const encoding = $('#user-csv-encoding').val() || 'UTF-8';
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                encoding: encoding,
                complete: async function (results) {
                    hideLoading();

                    const data = results.data;
                    if (data.length === 0) {
                        alert('„Éá„Éº„Çø„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                        return;
                    }

                    // CSV„ÅÆ„Éò„ÉÉ„ÉÄ„ÉºÔºà„Ç´„É©„É†ÂêçÔºâ„ÇíÂèñÂæó
                    const csvHeaders = Object.keys(data[0]);

                    // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å´‰øùÂ≠òÔºàÊó¢Â≠ò„ÅÆCSV„Ç§„É≥„Éù„Éº„Éà„Éï„É≠„Éº„Åß‰ΩøÁî®Ôºâ
                    currentCSVData = data;
                    currentCSVHeaders = csvHeaders;
                    currentImportType = 'candidates'; // Ê±ÇËÅ∑ËÄÖÂ∞ÇÁî®

                    // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
                    closeUserCsvImportModal();

                    // AI„Éû„ÉÉ„Éî„É≥„Ç∞„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫ÔºàÊó¢Â≠ò„ÅÆÈñ¢Êï∞„Çí‰ΩøÁî®Ôºâ
                    showCSVMappingModal('users'); // 'users' „Çø„Ç§„Éó„Çí‰ΩøÁî®ÔºàuserFields„ÇíÂèÇÁÖßÔºâ
                },
                error: function (error) {
                    hideLoading();
                    console.error('CSV parse error:', error);
                    alert('CSV„ÅÆËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            });
        }

        window.exportUsersCsv = function () {
            if (!adminUsersCache || adminUsersCache.length === 0) {
                alert('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            const csvData = adminUsersCache.map(user => ({
                name: user.name,
                email: user.email,
                role: user.role,
                created_at: new Date(user.created_at).toLocaleString()
            }));

            const csv = Papa.unparse(csvData);
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `users_export_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function loadAdminUsers() {
            if (!currentUser) return
            showLoading()
            try {
                // ÂÖ®„É¶„Éº„Ç∂„Éº„ÇíÂèñÂæóÔºàËá™ÁµÑÁπî„ÅÆ„ÅøÔºâ
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                    .eq('organization_id', currentUser.organization_id)
                    .neq('role', 'candidate')
                    .is('deleted_at', null)
                    .order('created_at', { ascending: false })

                if (error) throw error

                // „Éï„É©„ÉÉ„ÉàÂåñÔºà‰∏ÄË¶ßË°®Á§∫„Åß„Éó„É≠„Éï„Ç£„Éº„É´ÊÉÖÂ†±„ÅåÂøÖË¶Å„Å™Â†¥Âêà„ÅÆ„Åü„ÇÅÔºâ
                const flattenedUsers = (users || []).map(u => {
                    const profile = Array.isArray(u.candidate_profiles) ? u.candidate_profiles[0] : u.candidate_profiles;
                    return { ...u, ...profile, id: u.id };
                });

                adminUsersCache = flattenedUsers;
                renderAdminUsers(adminUsersCache);
            } catch (error) {
                console.error('Load users error:', error)
                alert('„É¶„Éº„Ç∂„Éº„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü')
            } finally {
                hideLoading()
            }
        }

        function renderAdminUsers(users) {
            const container = $('#admin-users-container')
            const infoContainer = $('#org-info-display'); // Placeholder for Org Info
            container.empty()

            // Display Organization Code for Org Admins
            if (currentUser && ['org_admin', 'admin'].includes(currentUser.role)) {
                if ($('#org-code-info').length === 0) {
                    // Add Org Code Display Area if not exists
                    const headerSection = $('#admin-users-content h2').parent();
                    // Fetch Org Code async
                    (async () => {
                        const { data, error } = await supabase.from('organizations').select('code').eq('id', currentUser.organization_id).single();
                        if (data && data.code) {
                            headerSection.append(`
                                <div id="org-code-info" class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg inline-block">
                                    <span class="text-sm text-blue-800 font-bold">ÁµÑÁπî„Ç≥„Éº„Éâ: </span>
                                    <span class="text-lg font-mono text-blue-900 mx-2">${data.code}</span>
                                    <span class="text-xs text-gray-500">Ôºà„Åì„ÅÆ„Ç≥„Éº„Éâ„ÇíÊ±ÇËÅ∑ËÄÖ„Å´ÂÖ±Êúâ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ</span>
                                </div>
                             `);
                        }
                    })();
                }
            }

            if (users.length === 0) {
                container.html('<tr><td colspan="4" class="px-6 py-8 text-center text-gray-500">„É¶„Éº„Ç∂„Éº„Åå„ÅÑ„Åæ„Åõ„Çì</td></tr>')
                return
            }

            const html = users.map(u => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${u.name}</div>
                        <div class="text-sm text-gray-500">${u.email}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getRoleBadgeColor(u.role)}">
                            ${getRoleLabel(u.role)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="mb-1">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${u.status === 'suspended' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                ${u.status === 'suspended' ? 'ÂÅúÊ≠¢‰∏≠' : 'Âà©Áî®‰∏≠'}
                            </span>
                        </div>
                        <div>
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${u.management_status === 'inactive' ? 'bg-gray-200 text-gray-700' : 'bg-blue-100 text-blue-800'}">
                                ${u.management_status === 'inactive' ? 'Ê¥ªÂãïÁµÇ‰∫Ü' : 'Ê¥ªÂãï‰∏≠'}
                            </span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${new Date(u.created_at).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="viewCandidateProfile('${u.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">
                            Ë©≥Á¥∞
                        </button>
                        <button onclick="deleteUser('${u.id}')" class="text-red-600 hover:text-red-900">
                            ÂâäÈô§
                        </button>
                    </td>
                </tr>
            `).join('')

            container.html(html)
        }

        function getOrgSettings(user) {
            const u = user || window.currentUser;
            if (!u || !u.organizations) return {};
            if (Array.isArray(u.organizations)) {
                return u.organizations[0]?.settings || {};
            }
            return u.organizations.settings || {};
        }

        function getRoleLabel(role) {
            const roles = {
                'super_admin': '„Çπ„Éº„Éë„ÉºÁÆ°ÁêÜËÄÖ',
                'org_admin': 'ÁµÑÁπîÁÆ°ÁêÜËÄÖ',
                'admin': 'ÁÆ°ÁêÜËÄÖ',
                'coach': 'CA„ÉªRA',
                'ca': 'CA',
                'ra': 'RA',
                'candidate': 'Ê±ÇËÅ∑ËÄÖ'
            };

            // ÁµÑÁπî„Åî„Å®„ÅÆ„Ç´„Çπ„Çø„Éû„Ç§„Ç∫ÂêçÁß∞„ÇíÁ¢∫Ë™ç
            let customLabel = null;
            const orgSettings = getOrgSettings();
            if (orgSettings.role_labels) {
                const labels = orgSettings.role_labels || {};

                // ÁâπÂÆö„ÅÆ„É≠„Éº„É´„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„Åã
                if (labels && labels[role]) {
                    customLabel = labels[role];
                }
                // ca, ra „ÅÆÂ†¥Âêà„ÅØ coach „ÅÆË®≠ÂÆö„ÇíÊµÅÁî®„Åô„ÇãÔºàÂÄãÂà•„Å´Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„Åë„Çå„Å∞Ôºâ
                else if ((role === 'ca' || role === 'ra') && labels && labels['coach']) {
                    customLabel = labels['coach'];
                }
            }

            return customLabel || roles[role] || role;
        }

        function getRoleBadgeColor(role) {
            const colors = {
                'super_admin': 'bg-purple-100 text-purple-800',
                'org_admin': 'bg-blue-100 text-blue-800',
                'admin': 'bg-indigo-100 text-indigo-800',
                'coach': 'bg-yellow-100 text-yellow-800',
                'candidate': 'bg-green-100 text-green-800'
            };
            return colors[role] || 'bg-gray-100 text-gray-800';
        }

        window.filterAdminUsers = function () {
            const searchText = $('#admin-user-search').val().toLowerCase();
            if (!searchText) {
                renderAdminUsers(adminUsersCache);
                return;
            }
            const filtered = adminUsersCache.filter(u =>
                (u.name && u.name.toLowerCase().includes(searchText)) ||
                (u.email && u.email.toLowerCase().includes(searchText)) ||
                (u.user_code && u.user_code.toLowerCase().includes(searchText))
            );
            renderAdminUsers(filtered);
        }

        window.editUserRole = async function (userId, currentRole) {
            const newRole = prompt('Êñ∞„Åó„ÅÑ„É≠„Éº„É´„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ (admin, coach, candidate):', currentRole);
            if (newRole && newRole !== currentRole) {
                if (!['admin', 'coach', 'candidate'].includes(newRole)) {
                    alert('ÁÑ°Âäπ„Å™„É≠„Éº„É´„Åß„Åô');
                    return;
                }
                try {
                    const { error } = await supabase
                        .from('users')
                        .update({ role: newRole })
                        .eq('id', userId);

                    if (error) throw error;
                    alert('Ê®©Èôê„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
                    loadAdminUsers();
                } catch (e) {
                    console.error(e);
                    alert('Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            }
        }

        // ========================
        // User Registration
        // ========================
        window.showUserRegistrationModal = async function (type) {
            $('#user-registration-form')[0].reset();
            $('#reg-resume-filename').text('');

            // „Éû„Çπ„Çø„Éá„Éº„ÇøÂàùÊúüÂåñ
            await loadMasterDataForProfile(null);

            // Select2„ÅÆÊó¢Â≠ò„Ç§„É≥„Çπ„Çø„É≥„Çπ„ÇíÁ†¥Ê£Ñ„Åó„Å¶„Åã„ÇâÂÜçÂàùÊúüÂåñ
            $('#reg-job-type, #reg-industry, #reg-employment-type, #reg-prefecture').each(function () {
                if ($(this).hasClass("select2-hidden-accessible")) {
                    $(this).select2('destroy');
                }
            });

            // Select2ÂàùÊúüÂåñÔºàË§áÊï∞ÈÅ∏Êäû„ÅÆÊìç‰ΩúÊÄßÂêë‰∏äÔºâ
            $('#reg-job-type, #reg-industry, #reg-employment-type, #reg-prefecture').select2({
                width: '100%',
                closeOnSelect: false,
                allowClear: true,
                placeholder: 'ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
                language: 'ja'
            });

            if (type === 'candidate') {
                $('#user-reg-title').text('Êñ∞Ë¶èÊ±ÇËÅ∑ËÄÖÁôªÈå≤');
                $('#reg-role').val('candidate');
                $('#reg-role-section').addClass('hidden');
                $('#reg-candidate-fields').removeClass('hidden');
            } else {
                $('#user-reg-title').text('Êñ∞Ë¶è„É¶„Éº„Ç∂„ÉºÁôªÈå≤');
                $('#reg-role').val('');

                // Ê®©Èôê„É©„Éô„É´„ÅÆÊõ¥Êñ∞
                const $regRoleSelect = $('#reg-role-select');
                $regRoleSelect.empty();
                $regRoleSelect.append(`<option value="admin">${getRoleLabel('admin')}</option>`);
                $regRoleSelect.append(`<option value="coach">${getRoleLabel('coach')}</option>`);
                $regRoleSelect.append(`<option value="org_admin">${getRoleLabel('org_admin')}</option>`);

                $('#reg-role-section').removeClass('hidden');
                $('#reg-candidate-fields').addClass('hidden');
            }

            $('#user-registration-modal').removeClass('hidden');
        }

        window.closeUserRegistrationModal = function () {
            $('#user-registration-modal').addClass('hidden');
        }

        // ÁôªÈå≤Áî®ËÅ∑Ê≠¥„É™„Çπ„ÉàÊìç‰ΩúÈñ¢Êï∞
        window.addRegWorkHistoryItem = function (data = {}) {
            const count = $('#reg-work-history-list').children().length;
            if (count >= 10) return;
            const index = count + 1;
            const $item = $(`
                <div class="reg-work-history-item bg-gray-50 p-4 rounded-lg border border-gray-200 relative mb-2">
                    <button type="button" onclick="$(this).closest('.reg-work-history-item').remove(); updateRegJobChangeCount();" 
                        class="absolute top-2 right-2 text-gray-400 hover:text-red-500 w-6 h-6 flex items-center justify-center rounded-full hover:bg-gray-200 transition">
                        <i class="fas fa-times"></i>
                    </button>
                    <h5 class="text-sm font-bold text-indigo-700 mb-2">ËÅ∑Ê≠¥ ${index}</h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">‰ºöÁ§æÂêç</label>
                            <input type="text" class="wh-company w-full px-3 py-2 border rounded text-sm bg-white" placeholder="‰ºöÁ§æÂêç">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Âú®Á±çÊúüÈñì</label>
                            <input type="text" class="wh-period w-full px-3 py-2 border rounded text-sm bg-white" placeholder="‰æã: 2020/04 - 2023/03">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">ÊâÄÂ±û‰ºÅÊ•≠„ÅÆÊ•≠Á®Æ</label>
                            <input type="text" class="wh-industry w-full px-3 py-2 border rounded text-sm bg-white" placeholder="‰æã: IT„ÉªÈÄö‰ø°" list="master-industry-list">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">ËÅ∑Á®Æ</label>
                            <input type="text" class="wh-job-category w-full px-3 py-2 border rounded text-sm bg-white" placeholder="‰æã: Ê≥ï‰∫∫Âñ∂Ê•≠" list="master-job-category-list">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="block text-xs text-gray-500 mb-1">ÂΩπÂâ≤„ÉªÂΩπËÅ∑</label>
                        <input type="text" class="wh-role w-full px-3 py-2 border rounded text-sm bg-white" placeholder="ÂΩπÂâ≤„ÉªÂΩπËÅ∑">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">ËÅ∑ÂãôÂÜÖÂÆπ</label>
                        <textarea class="wh-description w-full px-3 py-2 border rounded text-sm bg-white" rows="3" placeholder="ËÅ∑ÂãôÂÜÖÂÆπ"></textarea>
                    </div>
                </div>
            `);

            $item.find('.wh-company').val(data.company_name || '');
            $item.find('.wh-period').val(data.period || '');
            $item.find('.wh-industry').val(data.industry || '');
            $item.find('.wh-job-category').val(data.job_category || '');
            $item.find('.wh-role').val(data.role || '');
            $item.find('.wh-description').val(data.description || '');

            $('#reg-work-history-list').append($item);

            // ‰ºöÁ§æÂêç„ÅåÂÖ•Âäõ„Åï„Çå„Åü„ÇâÂÜçË®àÁÆó
            $item.find('.wh-company').on('input', function () {
                updateRegJobChangeCount();
            });

            updateRegJobChangeCount();
        };

        window.updateRegJobChangeCount = function () {
            const companies = new Set();
            $('#reg-work-history-list .wh-company').each(function () {
                const val = $(this).val().trim();
                if (val) companies.add(val);
            });
            const count = companies.size;
            $('#reg-job-change-count').val(count);
            $('#reg-work-history-list .reg-work-history-item').each(function (i) {
                $(this).find('h5').text(`ËÅ∑Ê≠¥ ${i + 1}`);
            });
        };

        window.handleRegResumeUpload = async function (input) {
            if (input.files.length === 0) return;

            const fileNames = Array.from(input.files).map(f => f.name).join(', ');
            $('#reg-resume-filename').text(fileNames);

            showLoading();
            try {
                let combinedText = '';
                for (let i = 0; i < input.files.length; i++) {
                    const text = await extractTextFromPDF(input.files[i]);
                    combinedText += `--- File ${i + 1} ---\n${text}\n`;
                }

                let result = await analyzeDocumentWithAI(combinedText, 'resume');

                // ÈÖçÂàó„ÅßËøî„Å£„Å¶„Åç„ÅüÂ†¥Âêà„ÅØÊúÄÂàù„ÅÆË¶ÅÁ¥†„Çí‰Ωø„ÅÜ
                if (Array.isArray(result)) {
                    result = result[0] || {};
                }

                // „Éï„Ç©„Éº„É†„Å´ÂèçÊò†
                // ÂêçÂâç„Éª„Åµ„Çä„Åå„Å™
                if (result.name) $('#reg-name').val(result.name);
                if (result.furigana || result.kana) $('#reg-furigana').val(result.furigana || result.kana);

                if (result.desired_job_type) $('#reg-job-type').val(result.desired_job_type);
                if (result.desired_location) $('#reg-location').val(result.desired_location);
                if (result.desired_employment_type) $('#reg-employment-type').val(result.desired_employment_type);
                if (result.desired_salary) $('#reg-salary').val(Math.floor(result.desired_salary / 10000));
                if (result.skills) $('#reg-skills').val(result.skills);
                if (result.work_history) $('#reg-history').val(result.work_history);
                if (result.work_history_detail) $('#reg-work-history-detail').val(result.work_history_detail);
                if (result.resume) $('#reg-resume-detail').val(result.resume); // resume„ÅØË©≥Á¥∞„ÉÜ„Ç≠„Çπ„ÉàÊâ±„ÅÑ

                // ÊßãÈÄ†Âåñ„Åï„Çå„ÅüËÅ∑Ê≠¥
                if (result.work_history_structured && Array.isArray(result.work_history_structured)) {
                    $('#reg-work-history-list').empty();
                    result.work_history_structured.forEach(item => addRegWorkHistoryItem(item));
                    updateRegJobChangeCount();
                }

                alert('Ëß£Êûê„ÅåÂÆå‰∫Ü„Åó„ÄÅ„Éï„Ç©„Éº„É†„Å´ÂÖ•Âäõ„Åó„Åæ„Åó„Åü„ÄÇ\nÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç„Åó„Å¶ÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            } catch (error) {
                console.error('Resume analysis error:', error);
                alert('Ëß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        window.handleUserRegistration = async function (event) {
            event.preventDefault();

            let email = $('#reg-email').val().trim();
            let password = $('#reg-password').val();
            const name = $('#reg-name').val().trim();
            const furigana = $('#reg-furigana').val().trim();

            let role = $('#reg-role').val();
            if (!role) {
                // hiddenÂÄ§„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Éó„É´„ÉÄ„Ç¶„É≥„ÅÆÂÄ§„Çí‰ΩøÁî®ÔºàÁÆ°ÁêÜËÄÖ„Éª„Ç≥„Éº„ÉÅÁôªÈå≤ÊôÇÔºâ
                role = $('#reg-role-select').val();
            }

            if (!role) {
                // „É≠„Éº„É´ÈÅ∏Êäû„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÁÆ°ÁêÜËÄÖÁôªÈå≤ÁîªÈù¢„Åã„Çâ„ÅÆÂëº„Å≥Âá∫„Åó„Å®„Åø„Å™„ÅôÔºàÈÄöÂ∏∏„ÅØ„ÅÇ„Çä„Åà„Å™„ÅÑ„ÅåÂøµ„ÅÆ„Åü„ÇÅÔºâ
                // „Åó„Åã„Åó showUserRegistrationModal('candidate') „Åß„ÅØ hidden „Å´„Åó„Å¶ 'candidate' „Çí„Çª„ÉÉ„Éà„Åó„Å¶„ÅÑ„Çã
                // „Åì„Åì„Åß„ÅØ„Éï„Ç©„Éº„É†„ÅÆÂÄ§„ÇíÁ¢∫Ë™ç
                if ($('#reg-candidate-fields').is(':visible') || $('#user-reg-title').text().includes('Ê±ÇËÅ∑ËÄÖ')) {
                    role = 'candidate';
                } else {
                    // „Éá„Éï„Ç©„É´„Éà„ÅØ admin „Å´„Åô„ÇãÔºàuser „ÅØDBÂà∂Á¥ÑÈÅïÂèç„Å´„Å™„Çã„Åü„ÇÅÔºâ
                    role = 'admin';
                }
            }

            // Ê±ÇËÅ∑ËÄÖ„ÅÆÂ†¥Âêà„ÄÅ„É°„Ç¢„Éâ„Éª„Éë„Çπ„ÉØ„Éº„ÉâÊú™ÂÖ•Âäõ„Å™„ÇâËá™ÂãïÁîüÊàê
            if (role === 'candidate') {
                if (!email) {
                    const uuid = crypto.randomUUID();
                    email = `candidate-${Date.now()}-${uuid.substring(0, 8)}@placeholder.local`;
                }

                if (!password) {
                    password = crypto.randomUUID();
                }
            }

            if ((role !== 'candidate' && (!email || !password)) || !name) {
                alert('ÂøÖÈ†àÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            showLoading();
            try {
                // „Éó„É≠„Éï„Ç£„Éº„É´„Éá„Éº„Çø„ÅÆÊßãÁØâÔºàÊ±ÇËÅ∑ËÄÖ„ÅÆÂ†¥ÂêàÔºâ
                const profileData = {};
                if (role === 'candidate') {
                    const jobType = $('#reg-job-type').val();
                    profileData.desired_job_type = jobType ? jobType.join(',') : null;

                    const industry = $('#reg-industry').val();
                    profileData.desired_industry = industry ? industry.join(',') : null;

                    const prefs = $('#reg-prefecture').val(); // ÈÖçÂàó„Åæ„Åü„ÅØÊñáÂ≠óÂàó
                    const city = $('#reg-city').val() || '';
                    let location = '';

                    if (Array.isArray(prefs) && prefs.length > 0) {
                        location = prefs.join(',');
                        if (city) {
                            // Ë§áÊï∞ÈÅ∏ÊäûÊôÇ„ÅØ„Çπ„Éö„Éº„ÇπÂå∫Âàá„Çä„ÄÅÂçò‰∏Ä„ÅÆÂ†¥Âêà„ÅØÁµêÂêàÔºàÂæìÊù•‰∫íÊèõÔºâ
                            if (prefs.length > 1) {
                                location += ' ' + city;
                            } else {
                                location = prefs[0] + city;
                            }
                        }
                    } else if (prefs) {
                        // ÊñáÂ≠óÂàó„ÅÆÂ†¥ÂêàÔºàÂçò‰∏ÄÈÅ∏ÊäûË®≠ÂÆö„Å™„Å©„ÅÆÂ†¥ÂêàÔºâ
                        location = prefs + city;
                    } else if (city) {
                        location = city;
                    }
                    profileData.desired_location = location || null;

                    const empType = $('#reg-employment-type').val();
                    profileData.desired_employment_type = empType ? empType.join(',') : null;
                    const salary = $('#reg-salary').val();
                    profileData.desired_salary = salary ? parseInt(salary) * 10000 : null;
                    profileData.skills = $('#reg-skills').val() || null;
                    profileData.work_history = $('#reg-history').val() || null;
                    profileData.work_history_detail = $('#reg-work-history-detail').val() || null;
                    profileData.resume = $('#reg-resume-detail').val() || null;

                    // ÊßãÈÄ†Âåñ„Éá„Éº„ÇøÂèéÈõÜ
                    const workHistoryList = [];
                    $('#reg-work-history-list .reg-work-history-item').each(function () {
                        workHistoryList.push({
                            company_name: $(this).find('.wh-company').val(),
                            period: $(this).find('.wh-period').val(),
                            industry: $(this).find('.wh-industry').val(),
                            job_category: $(this).find('.wh-job-category').val(),
                            role: $(this).find('.wh-role').val(),
                            description: $(this).find('.wh-description').val()
                        });
                    });
                    profileData.work_history_structured = workHistoryList;
                    profileData.job_change_count = parseInt($('#reg-job-change-count').val()) || 0;
                }

                const requestBody = {
                    email,
                    password,
                    name,
                    furigana,
                    userCode: $('#reg-user-code').val() || null,
                    role,
                    organizationId: currentUser.organization_id,
                    profileData
                };



                console.log('Sending user registration request:', requestBody);

                // Edge FunctionÂëº„Å≥Âá∫„Åó
                const { data, error } = await supabase.functions.invoke('create-user', {
                    body: requestBody
                });

                console.log('Edge Function response:', { data, error });

                if (error) {
                    // „Ç®„É©„Éº„ÅÆË©≥Á¥∞„ÇíÂèñÂæó
                    console.error('Edge Function error details:', error);

                    // FunctionsHttpError„ÅÆÂ†¥Âêà„ÄÅ„É¨„Çπ„Éù„É≥„Çπ„Éú„Éá„Ç£„ÇíÁ¢∫Ë™ç
                    if (error.context) {
                        console.error('Error context:', error.context);
                    }

                    throw error;
                }

                // data„Å´„Ç®„É©„ÉºÊÉÖÂ†±„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÇÇ„ÉÅ„Çß„ÉÉ„ÇØ
                if (data && data.error) {
                    console.error('Edge Function returned error:', data);
                    throw new Error(data.error + (data.details ? '\nË©≥Á¥∞: ' + data.details : ''));
                }

                // ÊãõÂæÖ„É°„Éº„É´ÈÄÅ‰ø°
                if (email) {
                    const orgName = currentUser.organizations ? currentUser.organizations.name : 'RightJob';
                    const loginUrl = 'https://rightjob2025.github.io/matching/index-supabase.html';

                    // ÈùûÂêåÊúü„Åß„É°„Éº„É´ÈÄÅ‰ø°Ôºà„Ç®„É©„Éº„Åß„ÇÇ„Éï„É≠„Éº„ÅØÊ≠¢„ÇÅ„Å™„ÅÑÔºâ
                    sendEmail('invitation', email, {
                        organizationName: orgName,
                        invitationUrl: loginUrl
                    }).catch(e => console.error('Failed to send invitation email:', e));
                }

                alert('„É¶„Éº„Ç∂„Éº„ÇíÁôªÈå≤„Åó„Åæ„Åó„Åü');
                closeUserRegistrationModal();

                // „É™„Çπ„Éà„ÇíÂÜçË™≠„ÅøËæº„Åø
                if (role === 'candidate') {
                    loadAdminCandidates();
                } else {
                    loadAdminUsers();
                }

            } catch (error) {
                console.error('User registration error:', error);

                // „Çà„ÇäË©≥Á¥∞„Å™„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
                let errorMessage = 'ÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü\n\n';

                if (error.message) {
                    errorMessage += '„Ç®„É©„Éº: ' + error.message + '\n';
                }

                // error.context„ÅåResponse„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÂ†¥Âêà„ÅÆÂá¶ÁêÜ
                if (error.context) {
                    try {
                        // Response„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÂ†¥Âêà
                        if (error.context instanceof Response) {
                            const responseText = await error.context.text();
                            console.log('Response text:', responseText);

                            try {
                                const errorBody = JSON.parse(responseText);
                                if (errorBody.error) {
                                    errorMessage += '\nË©≥Á¥∞: ' + errorBody.error;
                                }
                                if (errorBody.details) {
                                    errorMessage += '\n' + errorBody.details;
                                }
                            } catch (parseError) {
                                // JSON„Éë„Éº„Çπ„Å´Â§±Êïó„Åó„ÅüÂ†¥Âêà„ÄÅ„ÉÜ„Ç≠„Çπ„Éà„Çí„Åù„ÅÆ„Åæ„ÅæË°®Á§∫
                                errorMessage += '\nË©≥Á¥∞: ' + responseText;
                            }
                        }
                        // body„Éó„É≠„Éë„ÉÜ„Ç£„Åå„ÅÇ„ÇãÂ†¥Âêà
                        else if (error.context.body) {
                            const errorBody = typeof error.context.body === 'string'
                                ? JSON.parse(error.context.body)
                                : error.context.body;

                            if (errorBody.error) {
                                errorMessage += '\nË©≥Á¥∞: ' + errorBody.error;
                            }
                            if (errorBody.details) {
                                errorMessage += '\n' + errorBody.details;
                            }
                        }
                    } catch (e) {
                        console.error('Failed to parse error context:', e);
                    }
                }

                // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÊó•Êú¨Ë™ûÂåñÔºà„É¶„Éº„Ç∂„Éº„Éï„É¨„É≥„Éâ„É™„Éº„Å™„É°„ÉÉ„Çª„Éº„Ç∏„Å∏ÁΩÆÊèõÔºâ
                if (errorMessage.includes('already been registered') || errorMessage.includes('User already registered')) {
                    errorMessage = 'ÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü\n\n„Åì„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅØÊó¢„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ\nÂà•„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Çí‰ΩøÁî®„Åô„Çã„Åã„ÄÅÁÆ°ÁêÜËÄÖ„Å´Á¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                } else if (errorMessage.includes('Password should be at least')) {
                    errorMessage = 'ÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü\n\n„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ6ÊñáÂ≠ó‰ª•‰∏ä„ÅßË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                }

                alert(errorMessage);
            } finally {
                hideLoading();
            }
        }

        // Admin: Applicant Management
        // ========================
        let adminApplicantsCache = [];

        async function loadAdminApplicants() {
            if (!currentUser) return

            showLoading()
            try {
                // „Çπ„ÉÜ„Éº„Çø„Çπ„Éû„Çπ„Çø„ÇíÂÖà„Å´Ë™≠„ÅøËæº„Çì„Åß„Éï„Ç£„É´„Çø„Éº„ÇíÊßãÁØâ
                await loadApplicationStatuses();

                let query = supabase
                    .from('applications')
                    .select('*, jobs(*), users!user_id(*)')
                    .eq('organization_id', currentUser.organization_id);

                if (selectedTargetUserId) {
                    query = query.eq('user_id', selectedTargetUserId);
                }

                const { data: applications, error } = await query
                    .order('updated_at', { ascending: false });

                if (error) throw error

                adminApplicantsCache = applications || [];
                filterAdminApplicants();
            } catch (error) {
                console.error('Load admin applicants error:', error)
                $('#admin-applicants-container').html('<p class="text-red-500">ÂøúÂãüËÄÖ„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>')
            } finally {
                hideLoading()
            }
        }

        let adminApplicantStatusFilter = 'applied';
        let selectedAdminApplicantIds = new Set();

        window.setAdminApplicantStatusFilter = function (status) {
            adminApplicantStatusFilter = status;

            // UIÊõ¥Êñ∞
            $('.status-filter-btn').removeClass('active bg-indigo-600 text-white border-indigo-600').addClass('bg-white text-gray-600 border-gray-300 hover:bg-gray-50');
            $(`.status-filter-btn[data-status="${status}"]`).addClass('active bg-indigo-600 text-white border-indigo-600').removeClass('bg-white text-gray-600 border-gray-300 hover:bg-gray-50');

            filterAdminApplicants();
        };

        window.filterAdminApplicants = function () {
            const searchText = $('#admin-applicant-search').val().toLowerCase();

            let filtered = adminApplicantsCache;

            // „Çπ„ÉÜ„Éº„Çø„Çπ„Éï„Ç£„É´„Çø„Éº
            if (adminApplicantStatusFilter !== 'all') {
                const group = window.statusGroups ? window.statusGroups[adminApplicantStatusFilter] : null;
                if (group) {
                    filtered = filtered.filter(app => group.values.includes(app.status));
                } else {
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                    filtered = filtered.filter(app => {
                        if (adminApplicantStatusFilter === 'applied') {
                            return app.status === 'ÂøúÂãüÂÆå‰∫Ü' || !app.status;
                        } else if (adminApplicantStatusFilter === 'screening_docs') {
                            return ['Êõ∏È°ûÈÅ∏ËÄÉ‰∏≠', 'Êõ∏È°ûÈÅ∏ËÄÉÈÄöÈÅé', 'pending', 'screening'].includes(app.status);
                        } else if (adminApplicantStatusFilter === 'screening_interviews') {
                            return ['‰∏ÄÊ¨°Èù¢Êé•‰∫àÂÆö', '‰∏ÄÊ¨°Èù¢Êé•ÂÆå‰∫Ü', '‰∫åÊ¨°Èù¢Êé•‰∫àÂÆö', '‰∫åÊ¨°Èù¢Êé•ÂÆå‰∫Ü', 'ÊúÄÁµÇÈù¢Êé•‰∫àÂÆö', 'ÊúÄÁµÇÈù¢Êé•ÂÆå‰∫Ü', 'interview'].includes(app.status);
                        } else if (adminApplicantStatusFilter === 'offered') {
                            return app.status === 'offered' || app.status === 'ÂÜÖÂÆö' || app.status === 'ÂÜÖÂÆöÊâøË´æ';
                        } else if (adminApplicantStatusFilter === 'contracted') {
                            return app.status === 'contracted' || app.status === 'ÂÖ•Á§æÁ¢∫Ë™çÊ∏à';
                        } else if (adminApplicantStatusFilter === 'closed') {
                            return ['rejected', 'withdrawn'].includes(app.status) || (app.status && app.status.startsWith('ÈÅ∏ËÄÉÁµÇ‰∫Ü'));
                        }
                        return true;
                    });
                }
            }

            // „Ç≠„Éº„ÉØ„Éº„ÉâÊ§úÁ¥¢
            if (searchText) {
                filtered = filtered.filter(app =>
                    (app.users && app.users.name && app.users.name.toLowerCase().includes(searchText)) ||
                    (app.jobs && app.jobs.title && app.jobs.title.toLowerCase().includes(searchText)) ||
                    (app.jobs && app.jobs.company && app.jobs.company.toLowerCase().includes(searchText))
                );
            }

            renderAdminApplicants(filtered);
        }

        window.toggleAllAdminApplicants = function (checked) {
            if (checked) {
                const visibleCheckboxes = $('.admin-applicant-checkbox');
                visibleCheckboxes.each(function () {
                    $(this).prop('checked', true);
                    selectedAdminApplicantIds.add($(this).val());
                });
            } else {
                const visibleCheckboxes = $('.admin-applicant-checkbox');
                visibleCheckboxes.each(function () {
                    $(this).prop('checked', false);
                    selectedAdminApplicantIds.delete($(this).val());
                });
            }
            updateAdminApplicantSelectionUI();
        };

        window.toggleAdminApplicantSelection = function (id, checked) {
            if (checked) {
                selectedAdminApplicantIds.add(id);
            } else {
                selectedAdminApplicantIds.delete(id);
            }
            updateAdminApplicantSelectionUI();
        };

        window.openBulkStatusUpdateModal = function () {
            if (selectedAdminApplicantIds.size === 0) return;

            $('#bulk-status-target-count').text(`${selectedAdminApplicantIds.size}‰ª∂„ÅÆÂøúÂãü„ÇíÈÅ∏Êäû‰∏≠`);

            // „Çπ„ÉÜ„Éº„Çø„Çπ„Ç™„Éó„Ç∑„Éß„É≥„Çí„Éû„Çπ„Çø„Åã„ÇâË™≠„ÅøËæº„Åø
            const select = $('#bulk-new-status');
            select.empty();

            const options = (typeof applicationStatuses !== 'undefined' && applicationStatuses.length > 0)
                ? applicationStatuses
                : [
                    { value: 'pending', label: 'Êõ∏È°ûÈÅ∏ËÄÉ‰∏≠' },
                    { value: 'interview', label: 'Èù¢Êé•‰∫àÂÆö' },
                    { value: 'offered', label: 'ÂÜÖÂÆö' },
                    { value: 'contracted', label: 'ÂÖ•Á§æÊ±∫ÂÆö' },
                    { value: 'rejected', label: '‰∏çÂêàÊ†º' },
                    { value: 'withdrawn', label: 'ËæûÈÄÄ' }
                ];

            options.forEach(opt => {
                select.append($('<option>').val(opt.value || opt.label).text(opt.label));
            });

            $('#bulk-status-modal').removeClass('hidden');
        };

        window.closeBulkStatusModal = function () {
            $('#bulk-status-modal').addClass('hidden');
        };

        window.submitBulkStatusUpdate = async function () {
            const newStatus = $('#bulk-new-status').val();
            if (!newStatus) return;

            const count = selectedAdminApplicantIds.size;
            if (!confirm(`${count}‰ª∂„ÅÆÂøúÂãü„Çπ„ÉÜ„Éº„Çø„Çπ„Çí„Äå${$('#bulk-new-status option:selected').text()}„Äç„Å´Â§âÊõ¥„Åó„Åæ„Åô„ÅãÔºü`)) return;

            showLoading();
            try {
                const ids = Array.from(selectedAdminApplicantIds);

                // Supabase„ÅßÊõ¥Êñ∞
                const { error } = await supabase
                    .from('applications')
                    .update({
                        status: newStatus,
                        updated_at: new Date().toISOString()
                    })
                    .in('id', ids);

                if (error) throw error;

                // 2. ÈÄöÁü•„Å®„É°„Éº„É´ÈÄÅ‰ø°ÔºàÈùûÂêåÊúü„ÅßÂÆüË°å„Åó„ÄÅUI„ÇíÊ≠¢„ÇÅ„Å™„ÅÑÔºâ
                const statusLabel = getSelectionStatusLabel(newStatus);
                (async () => {
                    try {
                        const { data: apps } = await supabase
                            .from('applications')
                            .select('*, jobs(title, company), users!user_id(name, email, coach_id)')
                            .in('id', ids);

                        if (apps) {
                            for (const app of apps) {
                                // Ê±ÇËÅ∑ËÄÖ„Å∏ÈÄöÁü•„Å®„É°„Éº„É´
                                try {
                                    await supabase.from('notifications').insert({
                                        user_id: app.user_id,
                                        title: 'ÈÅ∏ËÄÉ„Çπ„ÉÜ„Éº„Çø„Çπ„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü',
                                        message: `„Äå${app.jobs.company} / ${app.jobs.title}„Äç„ÅÆÈÅ∏ËÄÉÁä∂Ê≥Å„Åå„Äå${statusLabel}„Äç„Å´Êõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü„ÄÇ`,
                                        read: false,
                                        metadata: { page: 'applications', application_id: app.id },
                                        created_at: new Date().toISOString()
                                    });

                                    if (app.users && app.users.email) {
                                        await sendEmail('status_changed', app.users.email, {
                                            userName: app.users.name,
                                            jobTitle: app.jobs.title,
                                            companyName: app.jobs.company,
                                            newStatus: statusLabel,
                                            status: newStatus
                                        });
                                    }

                                    // ÊãÖÂΩì„Ç≥„Éº„ÉÅ„Å∏„É°„Éº„É´
                                    if (app.users.coach_id) {
                                        const { data: coachData } = await supabase
                                            .from('users')
                                            .select('name, email')
                                            .eq('id', app.users.coach_id)
                                            .single();

                                        if (coachData && coachData.email) {
                                            await sendEmail('ca_notification', coachData.email, {
                                                userName: coachData.name,
                                                candidateName: app.users.name,
                                                jobTitle: app.jobs.title,
                                                companyName: app.jobs.company,
                                                body: `ÊãÖÂΩìÊ±ÇËÅ∑ËÄÖ„ÅÆ ${app.users.name} Êßò„ÅÆÈÅ∏ËÄÉ„Çπ„ÉÜ„Éº„Çø„Çπ„Åå„Äå${statusLabel}„Äç„Å´‰∏ÄÊã¨Êõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü„ÄÇ`
                                            });
                                        }
                                    }
                                } catch (innerError) {
                                    console.error(`Notification failed for app ${app.id}:`, innerError);
                                }
                            }
                        }
                    } catch (notifyErr) {
                        console.error('Bulk notification summary fetch failed:', notifyErr);
                    }
                })();

                alert(`${count}‰ª∂„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„Çí‰∏ÄÊã¨Êõ¥Êñ∞„Åó„Åæ„Åó„Åü`);
                closeBulkStatusModal();

                // ÈÅ∏Êäû„ÇíÂÖ®Ëß£Èô§
                selectedAdminApplicantIds.clear();
                $('#admin-applicant-select-all').prop('checked', false);
                updateAdminApplicantSelectionUI();

                // „Ç≠„É£„ÉÉ„Ç∑„É•Êõ¥Êñ∞
                ids.forEach(id => {
                    const idx = adminApplicantsCache.findIndex(a => a.id === id);
                    if (idx !== -1) adminApplicantsCache[idx].status = newStatus;
                });

                // ÂÜçÊèèÁîª
                filterAdminApplicants();

            } catch (error) {
                console.error('Bulk update error:', error);
                alert('‰∏ÄÊã¨Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            } finally {
                hideLoading();
            }
        };

        function updateAdminApplicantSelectionUI() {
            const count = selectedAdminApplicantIds.size;
            $('#admin-applicant-selection-count').text(`${count}‰ª∂ÈÅ∏Êäû‰∏≠`);

            const btn = $('#admin-bulk-status-btn');
            if (count > 0) {
                btn.prop('disabled', false).removeClass('text-indigo-300 border-indigo-100 italic cursor-not-allowed').addClass('text-indigo-600 border-indigo-600 hover:bg-indigo-50');
            } else {
                btn.prop('disabled', true).addClass('text-indigo-300 border-indigo-100 italic cursor-not-allowed').removeClass('text-indigo-600 border-indigo-600 hover:bg-indigo-50');
            }
        }

        function renderAdminApplicants(applications) {
            const container = $('#admin-applicants-container')
            container.empty()

            if (applications.length === 0) {
                container.html('<p class="text-gray-500 text-center py-8">ÂøúÂãüËÄÖ„Åå„ÅÑ„Åæ„Åõ„Çì</p>')
                return
            }

            const statusOptions = (typeof applicationStatuses !== 'undefined' && applicationStatuses.length > 0)
                ? applicationStatuses.map(s => s.value)
                : ['pending', 'screening', 'interview', 'offered', 'rejected', 'withdrawn', 'ÂøúÂãüÂÆå‰∫Ü'];

            const statusLabels = (typeof applicationStatuses !== 'undefined' && applicationStatuses.length > 0)
                ? applicationStatuses.reduce((acc, s) => ({ ...acc, [s.value]: s.label }), {})
                : {
                    'pending': 'Êõ∏È°ûÈÅ∏ËÄÉ‰∏≠',
                    'screening': 'Êõ∏È°ûÈÅ∏ËÄÉ‰∏≠',
                    'interview': 'Èù¢Êé•‰∫àÂÆö',
                    'offered': 'ÂÜÖÂÆö',
                    'rejected': '‰∏çÂêàÊ†º',
                    'withdrawn': 'ËæûÈÄÄ',
                    'ÂøúÂãüÂÆå‰∫Ü': 'ÂøúÂãüÂÆå‰∫Ü'
                };

            const html = applications.map(app => {
                // null„ÉÅ„Çß„ÉÉ„ÇØ
                const userName = app.users?.name || '‰∏çÊòé„Å™„É¶„Éº„Ç∂„Éº';
                const jobTitle = app.jobs?.title || '‰∏çÊòé„Å™Ê±Ç‰∫∫';
                const companyName = app.jobs?.company || '-';
                const updatedDate = app.updated_at ? new Date(app.updated_at).toLocaleDateString('ja-JP') : '-';
                const isSelected = selectedAdminApplicantIds.has(app.id);

                return `
                <div class="bg-white border ${isSelected ? 'border-indigo-300 ring-2 ring-indigo-100' : 'border-gray-200'} rounded-lg p-6 mb-4 hover:shadow-md transition-shadow">
                    <div class="flex items-start gap-4">
                        <div class="pt-1">
                            <input type="checkbox" class="admin-applicant-checkbox w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer" 
                                value="${app.id}" ${isSelected ? 'checked' : ''} onchange="toggleAdminApplicantSelection('${app.id}', this.checked)">
                        </div>
                        <div class="flex-1">
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <h3 class="text-lg font-bold text-gray-900">${userName}</h3>
                                        <span class="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded">ID: ${app.id.substring(0, 8)}</span>
                                        ${app.will_level ? `
                                            <span class="text-xs font-bold px-2 py-0.5 rounded ${app.will_level === 'A' ? 'bg-red-100 text-red-700 border border-red-200' :
                            app.will_level === 'B' ? 'bg-orange-100 text-orange-700 border border-orange-200' :
                                'bg-blue-100 text-blue-700 border border-blue-200'
                        }">ÂøóÊúõÂ∫¶ ${app.will_level}</span>
                                        ` : ''}
                                    </div>
                                    <div class="space-y-1 mb-2">
                                        <p class="text-blue-600 font-bold"><i class="fas fa-building mr-1"></i>${companyName}</p>
                                        <p class="text-gray-800 font-medium cursor-pointer hover:text-indigo-600 hover:underline" onclick="openJobDetailModal('${app.job_id}')">
                                            <i class="fas fa-external-link-alt text-xs mr-1 opacity-50"></i>${jobTitle}
                                        </p>
                                    </div>

                                    ${(app.interview_dates || app.notes) ? `
                                    <div class="mt-3 p-3 bg-gray-50 rounded-lg border border-gray-100 text-sm">
                                        ${app.interview_dates ? `
                                        <div class="mb-2">
                                            <span class="font-bold text-gray-700 block text-xs mb-1"><i class="far fa-calendar-check mr-1"></i>Èù¢Êé•Â∏åÊúõÊó•ÊôÇ:</span>
                                            <div class="text-gray-600 whitespace-pre-wrap pl-4 border-l-2 border-gray-200 text-[11px] leading-relaxed">${app.interview_dates}</div>
                                        </div>
                                        ` : ''}
                                        ${app.notes ? `
                                        <div>
                                            <span class="font-bold text-gray-700 block text-xs mb-1"><i class="far fa-comment-alt mr-1"></i>‰ºùÈÅî‰∫ãÈ†Ö:</span>
                                            <div class="text-gray-600 whitespace-pre-wrap pl-4 border-l-2 border-gray-200 text-[11px] leading-relaxed">${app.notes}</div>
                                        </div>
                                        ` : ''}
                                    </div>
                                    ` : ''}

                                    <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs text-gray-500 mt-2">
                                        <span><i class="far fa-calendar-alt mr-1"></i>${updatedDate}Êõ¥Êñ∞</span>
                                        ${app.users?.email ? `<span><i class="far fa-envelope mr-1"></i>${app.users.email}</span>` : ''}
                                    </div>
                                </div>
                                <div class="flex flex-col gap-3 items-end">
                                    <div class="flex items-center gap-2">
                                        <label class="text-xs font-bold text-gray-500">„Çπ„ÉÜ„Éº„Çø„Çπ:</label>
                                        <select onchange="updateApplicationStatus('${app.id}', this.value)" class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm font-bold focus:ring-2 focus:ring-indigo-500 outline-none">
                                            ${statusOptions.map(s => `
                                                <option value="${s}" ${app.status === s ? 'selected' : ''}>${statusLabels[s] || s}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="openRecommendationModal('${app.id}')" class="px-3 py-1.5 text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-lg text-sm font-bold transition flex items-center gap-1">
                                            <i class="fas fa-file-alt"></i> Êé®Ëñ¶
                                        </button>
                                        <button onclick="openProgressModal('${app.id}')" class="px-3 py-1.5 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-bold transition">
                                            Ë©≥Á¥∞
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }).join('')

            container.html(html)
        }

        window.updateApplicationStatus = async function (applicationId, newStatus) {
            showLoading()
            try {
                // 1. ÁèæÂú®„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂèñÂæóÔºàÂ±•Ê≠¥Áî®Ôºâ
                const { data: currentApp, error: fetchError } = await supabase
                    .from('applications')
                    .select('status, user_id, organization_id')
                    .eq('id', applicationId)
                    .single();

                if (fetchError) throw fetchError;
                const oldStatus = currentApp.status;

                // 2. ÂøúÂãü„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞
                const { error: updateError } = await supabase
                    .from('applications')
                    .update({
                        status: newStatus,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', applicationId)

                if (updateError) throw updateError

                // 3. ÈÄ≤ÊçóÂ±•Ê≠¥„ÇíË®òÈå≤
                await supabase.from('progress_history').insert({
                    organization_id: currentApp.organization_id || currentUser.organization_id,
                    application_id: applicationId,
                    user_id: currentApp.user_id,
                    old_status: oldStatus,
                    new_status: newStatus,
                    changed_by: currentUser.id,
                    changed_by_name: currentUser.name
                });

                // 4. „É≠„Ç∞Ë®òÈå≤ (Áõ£ÊüªÁî®)
                await logAction('update', 'application', applicationId, { status: newStatus })

                alert('„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü')

                // 5. „Ç≠„É£„ÉÉ„Ç∑„É•Êõ¥Êñ∞„Å®ÂÜçÊèèÁîª
                if (typeof adminApplicantsCache !== 'undefined') {
                    const idx = adminApplicantsCache.findIndex(a => a.id === applicationId);
                    if (idx !== -1) adminApplicantsCache[idx].status = newStatus;
                    filterAdminApplicants();
                }

                if (typeof applicationsCache !== 'undefined') {
                    const idx = applicationsCache.findIndex(a => a.id === applicationId);
                    if (idx !== -1) applicationsCache[idx].status = newStatus;
                    filterCandidateApplications();
                }

            } catch (error) {
                console.error('Update status error:', error)
                alert('Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message)
                loadAdminApplicants() // Reload to revert
            } finally {
                hideLoading()
            }
        }

        // ========================
        // Admin: Company Management
        // ========================
        let companiesCache = []; // „Ç≠„É£„ÉÉ„Ç∑„É•„Åó„Å¶Ê§úÁ¥¢„Å´‰ΩøÁî®
        let searchTimeout = null;
        async function loadCompanies(searchText = '') {
            if (!currentUser) return
            showLoading()
            console.log('--- loadCompanies START ---', searchText ? `(Search: ${searchText})` : '');
            try {
                const targetOrgId = currentUser.organization_id;

                // Âü∫Êú¨„ÇØ„Ç®„É™
                let query = supabase
                    .from('companies')
                    .select('*')
                    .eq('organization_id', targetOrgId)
                    .order('created_at', { ascending: false });

                // Ë´ñÁêÜÂâäÈô§ÂØæÂøú
                query = query.or('deleted_at.is.null');

                // „Çµ„Éº„Éê„Éº„Çµ„Ç§„ÉâÊ§úÁ¥¢„ÅÆÈÅ©Áî®
                if (searchText) {
                    // search_vector„Ç´„É©„É†„Å™„Å©„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅilike„ÅßÂÄãÂà•„Å´„Éï„Ç£„É´„Çø„Åô„Çã
                    // Ê≥®ÊÑè: Supabase„ÅÆ or Âè•ÂÜÖ„Åß ilike „Çí‰ΩøÁî®„Åô„ÇãÂΩ¢Âºè
                    query = query.or(`name.ilike.%${searchText}%,industry.ilike.%${searchText}%,location.ilike.%${searchText}%`);
                }

                const { data: companies, error } = await query;

                if (error) {
                    console.error('Supabase query error in loadCompanies:', error);
                    throw error;
                }

                console.log('Companies loaded. Count:', companies ? companies.length : 0);

                // Ê§úÁ¥¢‰∏≠„Åß„Å™„ÅÑÂ†¥Âêà„ÅØ„Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÊõ¥Êñ∞
                if (!searchText) {
                    companiesCache = companies || [];
                }

                renderCompanies(companies || []);
            } catch (error) {
                console.error('Load companies error detail:', error)
                alert('‰ºÅÊ•≠„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:\n' + (error.message || JSON.stringify(error)))
            } finally {
                console.log('--- loadCompanies END ---');
                hideLoading()
            }
        }

        function renderCompanies(companies) {
            const container = $('#companies-container')
            container.empty()

            // ÂÖ®ÈÅ∏Êäû„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Çí„É™„Çª„ÉÉ„Éà
            $('#select-all-companies').prop('checked', false);
            updateBulkDeleteButton();

            if (companies.length === 0) {
                container.html('<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Çã‰ºÅÊ•≠„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</td></tr>')
                return
            }

            const html = companies.map(c => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="checkbox" class="company-checkbox rounded text-indigo-600 focus:ring-indigo-500" value="${c.id}" onchange="updateBulkDeleteButton()">
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium text-gray-900 break-words">${c.name}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-600 break-words">${c.industry || '-'}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-600 break-words">${c.location || '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${c.website ? `<a href="${c.website}" target="_blank" class="text-indigo-600 hover:underline text-sm"><i class="fas fa-external-link-alt mr-1"></i>„É™„É≥„ÇØ</a>` : '<span class="text-sm text-gray-400">-</span>'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick='editCompany(${JSON.stringify(c).replace(/'/g, "&#39;")})' class="text-indigo-600 hover:text-indigo-900 mr-3">
                            <i class="fas fa-edit"></i> Á∑®ÈõÜ
                        </button>
                        <button onclick="deleteCompany('${c.id}')" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash"></i> ÂâäÈô§
                        </button>
                    </td>
                </tr>
            `).join('')

            container.html(html)
        }

        window.toggleAllCompanies = function (source) {
            $('.company-checkbox').prop('checked', source.checked);
            updateBulkDeleteButton();
        }

        window.updateBulkDeleteButton = function () {
            const selectedCount = $('.company-checkbox:checked').length;
            $('#selected-companies-count').text(selectedCount);
            if (selectedCount > 0) {
                $('#bulk-delete-companies').removeClass('hidden');
            } else {
                $('#bulk-delete-companies').addClass('hidden');
            }
        }

        window.bulkDeleteCompanies = async function () {
            const selectedIds = $('.company-checkbox:checked').map(function () {
                return $(this).val();
            }).get();

            if (selectedIds.length === 0) return;

            if (!confirm(`${selectedIds.length}‰ª∂„ÅÆ‰ºÅÊ•≠„Çí‰∏ÄÊã¨ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ`)) {
                return;
            }

            showLoading('‰∏ÄÊã¨ÂâäÈô§‰∏≠...');
            try {
                // Ë´ñÁêÜÂâäÈô§ (deleted_at „ÇíÊõ¥Êñ∞)
                const { error } = await supabase
                    .from('companies')
                    .update({ deleted_at: new Date().toISOString() })
                    .in('id', selectedIds);

                if (error) throw error;

                alert(`${selectedIds.length}‰ª∂„ÅÆ‰ºÅÊ•≠„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ`);
                loadCompanies();
            } catch (error) {
                console.error('Bulk delete error:', error);
                alert('‰∏ÄÊã¨ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        window.filterCompanies = function () {
            const searchText = $('#company-search').val().trim();

            // ÂÖ•Âäõ„ÅÆ„Åü„Å≥„Å´„Çµ„Éº„Éê„Éº„Å´„É™„ÇØ„Ç®„Çπ„Éà„ÅåÈ£õ„Å∞„Å™„ÅÑ„Çà„ÅÜ„Éá„Éê„Ç¶„É≥„ÇπÂá¶ÁêÜ
            if (searchTimeout) clearTimeout(searchTimeout);

            searchTimeout = setTimeout(() => {
                loadCompanies(searchText);
            }, 500); // 500msÂæÖÊ©ü„Åó„Å¶„Åã„ÇâÂÆüË°å
        }

        window.showCompanyForm = function () {
            $('#company-modal-title').text('‰ºÅÊ•≠ÁôªÈå≤')
            $('#company-form')[0].reset()
            $('#company-id').val('')
            populateSelectOptions('company-industry', masterIndustries); // „Éû„Çπ„ÇøÂàùÊúüÂåñ
            $('#company-modal').removeClass('hidden')
        }

        window.closeCompanyModal = function () {
            $('#company-modal').addClass('hidden')
        }

        window.editCompany = function (company) {
            $('#company-modal-title').text('‰ºÅÊ•≠Á∑®ÈõÜ')
            $('#company-id').val(company.id)
            $('#company-name').val(company.name)
            // $('#company-industry').val(company.industry) // populateSelectOptions„ÅßË®≠ÂÆö
            populateSelectOptions('company-industry', masterIndustries, company.industry);
            $('#company-location').val(company.location)
            $('#company-website').val(company.website)
            $('#company-description').val(company.description)
            $('#company-modal').removeClass('hidden')
        }

        window.handleCompanySubmit = async function (e) {
            e.preventDefault()
            if (!currentUser) return;

            showLoading()
            try {
                const id = $('#company-id').val()
                const orgId = currentUser.organization_id || $('#admin-user-org').val(); // super_admin„ÅÆÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ

                if (!orgId) {
                    throw new Error('ÁµÑÁπîID„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇÁÆ°ÁêÜËÄÖ„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ');
                }

                const companyData = {
                    organization_id: orgId,
                    name: $('#company-name').val(),
                    industry: $('#company-industry').val(),
                    location: $('#company-location').val(),
                    website: $('#company-website').val(),
                    description: $('#company-description').val()
                }

                console.log('--- Company registration attempt ---');
                console.log('Data:', companyData);
                console.log('Mode:', id ? 'Update' : 'Insert');

                let result;
                if (id) {
                    result = await supabase.from('companies').update(companyData).eq('id', id).select();
                } else {
                    result = await supabase.from('companies').insert(companyData).select();
                }

                console.log('Supabase full response:', result);

                if (result.error) {
                    console.error('Supabase error detail:', result.error);
                    let errMsg = result.error.message;
                    if (result.error.code === '42501') {
                        errMsg = 'Ê®©ÈôêÔºàRLSÔºâ„Ç®„É©„Éº„Åß„Åô„ÄÇÁÆ°ÁêÜËÄÖ„ÅÆÁµÑÁπîIDË®≠ÂÆö„Åæ„Åü„ÅØSQL„Éù„É™„Ç∑„Éº„Å´ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ';
                    }
                    throw new Error(errMsg);
                }

                console.log('Success result:', result.data);
                closeCompanyModal()
                if (typeof loadCompanies === 'function') loadCompanies();
                alert('‰ºÅÊ•≠„ÅÆÁôªÈå≤„Å´ÊàêÂäü„Åó„Åæ„Åó„Åü');
            } catch (error) {
                console.error('Final caught error:', error)
                alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:\n' + error.message);
            } finally {
                hideLoading()
            }
        }

        window.deleteCompany = async function (id) {
            if (!confirm('Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\nÔºàË´ñÁêÜÂâäÈô§„Åï„Çå„ÄÅ‰∏ÄË¶ß„Åã„ÇâÈùûË°®Á§∫„Å´„Å™„Çä„Åæ„ÅôÔºâ')) return

            showLoading()
            try {
                const { error } = await supabase
                    .from('companies')
                    .update({ deleted_at: new Date().toISOString() })
                    .eq('id', id)
                if (error) throw error

                alert('ÂâäÈô§„Åó„Åæ„Åó„Åü')
                loadCompanies()
            } catch (error) {
                console.error('Delete company error:', error)
                alert('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message)
            } finally {
                hideLoading()
            }
        }

        // ========================
        // Admin: CSV Import
        // ========================


        // ========================
        // CSV Import Logic
        // ========================

        // „Ç∑„Çπ„ÉÜ„É†„Éï„Ç£„Éº„É´„ÉâÂÆöÁæ©
        const jobFields = [
            { key: 'job_code', label: 'Ê±Ç‰∫∫ÁÆ°ÁêÜID', aliases: ['ID', 'Ê±Ç‰∫∫ID', 'ÁÆ°ÁêÜID', 'Ê±Ç‰∫∫„Ç≥„Éº„Éâ'] },
            { key: 'title', label: 'Ê±Ç‰∫∫„Çø„Ç§„Éà„É´', required: true, aliases: ['„Çø„Ç§„Éà„É´', 'Ê±Ç‰∫∫Âêç', 'ËÅ∑Á®ÆÂêç'] },
            { key: 'company', label: '‰ºÅÊ•≠Âêç', required: true, aliases: ['‰ºöÁ§æÂêç', '‰ºÅÊ•≠'] },
            { key: 'job_category', label: 'ËÅ∑Á®Æ„Ç´„ÉÜ„Ç¥„É™„Éº', aliases: ['ËÅ∑Á®Æ', '„Ç´„ÉÜ„Ç¥„É™„Éº'] },
            { key: 'employment_type', label: 'ÈõáÁî®ÂΩ¢ÊÖã', aliases: ['ÈõáÁî®„Çø„Ç§„Éó', 'Âã§ÂãôÂΩ¢ÊÖã'] },
            { key: 'location', label: 'Âã§ÂãôÂú∞', aliases: ['Â†¥ÊâÄ', '‰ΩèÊâÄ', 'Âã§ÂãôÂ†¥ÊâÄ'] },
            { key: 'salary_min', label: 'ÊúÄ‰ΩéÂπ¥Âèé(‰∏áÂÜÜ)', aliases: ['Âπ¥Âèé‰∏ãÈôê', 'ÊúÄ‰ΩéÁµ¶‰∏é'] },
            { key: 'salary_max', label: 'ÊúÄÈ´òÂπ¥Âèé(‰∏áÂÜÜ)', aliases: ['Âπ¥Âèé‰∏äÈôê', 'ÊúÄÈ´òÁµ¶‰∏é'] },
            { key: 'description', label: 'ËÅ∑ÂãôÂÜÖÂÆπ', aliases: ['‰ªï‰∫ãÂÜÖÂÆπ', 'Ë©≥Á¥∞'] },
            { key: 'requirements', label: 'ÂøÖÈ†àË¶Å‰ª∂', aliases: ['ÂøúÂãüË≥áÊ†º', 'ÂøÖÈ†à„Çπ„Ç≠„É´'] },
            { key: 'welcome_requirements', label: 'Ê≠ìËøéË¶Å‰ª∂', aliases: ['Ê≠ìËøé„Çπ„Ç≠„É´', 'Â∞öÂèØ'] },
            { key: 'qualifications', label: 'ÂøúÂãüË≥áÊ†º(Ë©≥Á¥∞)', aliases: ['Ê±Ç„ÇÅ„ÇãË≥áÊ†º', 'Ë≥áÊ†º'] },
            { key: 'benefits', label: 'Á¶èÂà©ÂéöÁîü', aliases: ['ÂæÖÈÅá', 'Á¶èÂà©'] },
            { key: 'is_remote', label: '„É™„É¢„Éº„ÉàÂèØÂê¶', aliases: ['„É™„É¢„Éº„Éà', 'Âú®ÂÆÖ'] },
            { key: 'experience_level', label: 'ÁµåÈ®ì„É¨„Éô„É´', aliases: ['ÁµåÈ®ìÂπ¥Êï∞', '„É¨„Éô„É´'] },
            { key: 'industry', label: 'Ê•≠Áïå', aliases: ['Ê•≠Á®Æ', 'Áî£Ê•≠'] },
            { key: 'url', label: 'Ê±Ç‰∫∫URL', aliases: ['URL', '„É™„É≥„ÇØ', '„Çµ„Ç§„Éà', '„Éö„Éº„Ç∏'] },
            { key: 'pdf_url', label: 'PDF„Éï„Ç°„Ç§„É´URL', aliases: ['PDF', 'Ê∑ª‰ªò„Éï„Ç°„Ç§„É´'] },
            { key: 'pdf_filename', label: 'PDF„Éï„Ç°„Ç§„É´Âêç', aliases: ['„Éï„Ç°„Ç§„É´Âêç'] },
            { key: 'status', label: '„Çπ„ÉÜ„Éº„Çø„Çπ', aliases: ['ÂÖ¨ÈñãÁä∂ÊÖã', 'Áä∂ÊÖã'] },
            { key: 'job_experience_ok', label: 'ËÅ∑Á®ÆÊú™ÁµåÈ®ìOK', aliases: ['ËÅ∑Á®ÆÊú™ÁµåÈ®ì', 'Êú™ÁµåÈ®ìÂèØ', 'ËÅ∑Á®ÆÊú™ÁµåÈ®ìÊ≠ìËøé'] },
            { key: 'industry_experience_ok', label: 'Ê•≠Á®ÆÊú™ÁµåÈ®ìOK', aliases: ['Ê•≠ÁïåÊú™ÁµåÈ®ì', 'Ê•≠Á®ÆÊú™ÁµåÈ®ì', 'Ê•≠ÁïåÊú™ÁµåÈ®ìÊ≠ìËøé'] },
            { key: 'work_hours', label: 'Âã§ÂãôÊôÇÈñì', aliases: ['Â∞±Ê•≠ÊôÇÈñì', 'ÊãòÊùüÊôÇÈñì'] },
            { key: 'holidays', label: '‰ºëÊó•‰ºëÊöá', aliases: ['‰ºëÊó•', '‰ºëÊöá'] },
            { key: 'interview_process', label: 'ÈÅ∏ËÄÉ„Éó„É≠„Çª„Çπ', aliases: ['ÈÅ∏ËÄÉ„ÅÆÊµÅ„Çå', 'Êé°Áî®„Éï„É≠„Éº'] }
        ];

        const companyFields = [
            { key: 'name', label: '‰ºÅÊ•≠Âêç', required: true, aliases: ['‰ºöÁ§æÂêç', '‰ºÅÊ•≠', 'Name'] },
            { key: 'industry', label: 'Ê•≠Áïå', aliases: ['Ê•≠Á®Æ', 'Áî£Ê•≠', 'Industry'] },
            { key: 'location', label: 'ÊâÄÂú®Âú∞', aliases: ['Â†¥ÊâÄ', '‰ΩèÊâÄ', 'Êú¨ÈÉ®ÊâÄÂú®Âú∞', 'Location'] },
            { key: 'website', label: 'Web„Çµ„Ç§„Éà', aliases: ['URL', '„Ç¶„Çß„Éñ„Çµ„Ç§„Éà', 'HP', 'Website'] },
            { key: 'description', label: '‰ºÅÊ•≠Ë™¨Êòé', aliases: ['‰ºöÁ§æÊ¶ÇË¶Å', 'Ë©≥Á¥∞', 'Description'] }
        ];

        const userFields = [
            // Âü∫Êú¨ÊÉÖÂ†±
            { key: 'user_code', label: 'Ê±ÇËÅ∑ËÄÖID', aliases: ['ID', 'Ê±ÇËÅ∑ËÄÖID', 'ÁÆ°ÁêÜID', 'Ê±ÇËÅ∑ËÄÖ„Ç≥„Éº„Éâ', 'User Code'] },
            { key: 'name', label: 'Ê∞èÂêç', required: true, aliases: ['ÂêçÂâç', '„É¶„Éº„Ç∂„ÉºÂêç', 'Ê∞èÂêç'] },
            { key: 'email', label: '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ', required: true, aliases: ['„É°„Éº„É´', 'Email', 'E-mail'] },
            { key: 'password', label: '„Éë„Çπ„ÉØ„Éº„Éâ', required: false, aliases: ['„Éë„Çπ„ÉØ„Éº„Éâ', 'Password', 'pass'] },
            { key: 'role', label: 'Ê®©Èôê(candidate/coach/...)', aliases: ['„É≠„Éº„É´', 'ÂΩπÂâ≤'] },
            { key: 'birth_date', label: 'ÁîüÂπ¥ÊúàÊó•', aliases: ['Ë™ïÁîüÊó•', 'Áîü„Çå'] },
            { key: 'age', label: 'Âπ¥ÈΩ¢', aliases: ['Ê≠≥', 'Âπ¥ÈΩ¢'] },

            // Â∏åÊúõÊù°‰ª∂
            { key: 'desired_job_type', label: 'Â∏åÊúõËÅ∑Á®Æ', aliases: ['Â∏åÊúõËÅ∑Á®ÆÂêç', 'ËÅ∑Á®Æ'] },
            { key: 'desired_location', label: 'Â∏åÊúõÂã§ÂãôÂú∞', aliases: ['Â∏åÊúõÂ†¥ÊâÄ', 'Âã§ÂãôÂú∞'] },
            { key: 'desired_salary', label: 'Â∏åÊúõÂπ¥Âèé(‰∏áÂÜÜ)', aliases: ['Â∏åÊúõÁµ¶‰∏é', 'Âπ¥Âèé'] },

            // „Çπ„Ç≠„É´„ÉªÁµåÊ≠¥
            { key: 'skills', label: '„Çπ„Ç≠„É´', aliases: ['ÊäÄË°ì', 'ÊäÄËÉΩ', '‰øùÊúâ„Çπ„Ç≠„É´'] },
            { key: 'work_history', label: 'ËÅ∑Ê≠¥„ÉªËá™Â∑±PR', aliases: ['ÁµåÊ≠¥', 'Ëá™Â∑±Á¥π‰ªã', 'ËÅ∑ÂãôÁµåÊ≠¥'] },
            { key: 'academic_background', label: 'Â≠¶Ê≠¥', aliases: ['ÊúÄÁµÇÂ≠¶Ê≠¥', 'Â≠¶Ê†°', 'Âá∫Ë∫´Ê†°'] },
            { key: 'certifications', label: 'Ë≥áÊ†º', aliases: ['ÂÖçË®±', '‰øùÊúâË≥áÊ†º'] },
            { key: 'languages', label: 'Ë®ÄË™û„Çπ„Ç≠„É´', aliases: ['Ë™ûÂ≠¶', 'Ë™ûÂ≠¶Âäõ'] },

            // ÁÆ°ÁêÜÁî®ÊÉÖÂ†±ÔºàÊú¨‰∫∫ÈùûË°®Á§∫Ôºâ
            { key: 'matching_info', label: '„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÊÉÖÂ†±', aliases: ['„Éû„ÉÉ„ÉÅ„É≥„Ç∞„É°„É¢', '„Éû„ÉÉ„ÉÅ„É≥„Ç∞'] },
            { key: 'internal_info', label: 'Á§æÂÜÖÊÉÖÂ†±', aliases: ['Á§æÂÜÖ„É°„É¢', 'ÂÜÖÈÉ®ÊÉÖÂ†±'] },
            { key: 'other_info', label: '„Åù„ÅÆ‰ªñÊÉÖÂ†±', aliases: ['„Åù„ÅÆ‰ªñ', 'ÂÇôËÄÉ2'] }
        ];

        let currentCSVData = [];
        let currentImportType = ''; // 'jobs' or 'users'
        let currentCSVHeaders = [];

        // CSV„Éë„Éº„ÇπÈñ¢Êï∞ÔºàÊó¢Â≠ò„ÅÆ„ÇÇ„ÅÆ„ÇíÂº∑ÂåñÔºâ
        function parseCSV(text) {
            const lines = text.split(/\r\n|\n/).filter(line => line.trim() !== '');
            if (lines.length < 2) return [];

            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));

            const data = [];
            for (let i = 1; i < lines.length; i++) {
                // Á∞°ÊòìÁöÑ„Å™CSV„Éë„Éº„ÇπÔºà„Ç´„É≥„ÉûÂå∫Âàá„Çä„ÄÅÂºïÁî®Á¨¶ÂØæÂøú„ÅØÂÆåÂÖ®„Åß„ÅØ„Å™„ÅÑÔºâ
                // Êú¨Ê†ºÁöÑ„Å™„É©„Ç§„Éñ„É©„É™ÔºàPapaParse„Å™„Å©Ôºâ„ÅÆ‰ΩøÁî®„ÅåÊé®Â•®„Åï„Çå„Çã„Åå„ÄÅ„Åì„Åì„Åß„ÅØÁ∞°ÊòìÂÆüË£Ö
                const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
                if (values.length === headers.length) {
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = values[index];
                    });
                    data.push(obj);
                }
            }
            return { headers, data };
        }

        window.importJobsCSV = function () {
            handleCSVUpload('jobs');
        }

        window.importUsersCSV = function () {
            handleCSVUpload('users');
        }

        window.showCompanyCsvImportModal = function () {
            $('#admin-company-csv-modal').removeClass('hidden');
        }

        window.closeCompanyCsvImportModal = function () {
            $('#admin-company-csv-modal').addClass('hidden').attr('style', '');
        }

        window.processCompanyCsvImport = function () {
            const fileInput = document.getElementById('company-csv-file');
            const file = fileInput.files[0];

            if (!file) {
                alert('CSV„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            processCSVFile(file, 'companies');

            if (typeof closeCompanyCsvImportModal === 'function') {
                closeCompanyCsvImportModal();
            }
        }

        window.downloadCompanyCsvTemplate = function (event) {
            if (event) event.preventDefault();
            const headers = companyFields.map(f => f.label);
            const csvContent = headers.join(',') + "\n" +
                '"Ê†™Âºè‰ºöÁ§æ„Çµ„É≥„Éó„É´","IT„ÉªÈÄö‰ø°","Êù±‰∫¨ÈÉΩÊ∏ãË∞∑Âå∫","https://example.com","„ÉÜ„ÉÉ„ÇØÁ≥ª„Çπ„Çø„Éº„Éà„Ç¢„ÉÉ„Éó„Åß„Åô„ÄÇ"';
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "company_import_template.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.toggleUpsertKey = function () {
            const isChecked = $('#csv-upsert-mode').is(':checked');
            if (isChecked) {
                $('#csv-upsert-key-container').removeClass('hidden');
                updateUpsertKeyOptions();
            } else {
                $('#csv-upsert-key-container').addClass('hidden');
            }
        }

        function updateUpsertKeyOptions() {
            const select = $('#csv-upsert-key');
            const currentValue = select.val();
            select.empty();

            const fields = currentImportType === 'jobs' ? jobFields :
                currentImportType === 'companies' ? companyFields : userFields;

            let hasOption = false;
            fields.forEach(f => {
                // „Éû„ÉÉ„Éî„É≥„Ç∞„Åï„Çå„Å¶„ÅÑ„ÇãÈ†ÖÁõÆ„ÅÆ„ÅøÈÅ∏ÊäûËÇ¢„Å´„Åô„Çã
                const mapping = $(`.mapping-select[data-key="${f.key}"]`).val();
                if (mapping) {
                    const selected = f.key === currentValue ? 'selected' : '';
                    select.append(`<option value="${f.key}" ${selected}>${f.label} (${f.key})</option>`);
                    hasOption = true;
                }
            });

            if (!hasOption) {
                select.append('<option value="">-- „Éû„ÉÉ„Éî„É≥„Ç∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ --</option>');
            }
        }

        function handleCSVUpload(type) {
            const fileInput = type === 'jobs' ? $('#csv-jobs-file')[0] : $('#csv-users-file')[0]; // „É¶„Éº„Ç∂„ÉºÁî®input„ÅåÂøÖË¶Å„Å™„ÇâËøΩÂä†
            // „É¶„Éº„Ç∂„ÉºÁî®„ÅÆinput„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ‰∏ÄÊôÇÁöÑ„Å´‰ΩúÊàê„Åó„Å¶„ÇØ„É™„ÉÉ„ÇØ
            if (type === 'users' && !$('#csv-users-file').length) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.csv';
                input.onchange = e => processCSVFile(e.target.files[0], type);
                input.click();
                return;
            }

            if (!fileInput.files.length) {
                alert('„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            processCSVFile(fileInput.files[0], type);
        }

        function processCSVFile(file, type) {
            const encoding = type === 'jobs' ? $('#csv-jobs-encoding').val() :
                type === 'companies' ? $('#company-csv-encoding').val() :
                    $('#csv-users-encoding').val();

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true, // Á©∫Ë°å„Çí„Çπ„Ç≠„ÉÉ„Éó
                encoding: encoding || 'UTF-8',
                complete: function (results) {
                    console.log('Parsed results:', results);

                    const data = results.data;
                    const headers = results.meta.fields;

                    if (!data || data.length === 0) {
                        alert('ÊúâÂäπ„Å™„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
                        return;
                    }

                    currentCSVData = data;
                    currentCSVHeaders = headers;
                    currentImportType = type;

                    showCSVMappingModal(type);
                },
                error: function (error) {
                    console.error('CSV parse error:', error);
                    alert('CSV„ÅÆËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            });
        }

        function showCSVMappingModal(type) {
            const fields = type === 'jobs' ? jobFields :
                type === 'companies' ? companyFields : userFields;
            const tbody = $('#csv-mapping-tbody');
            tbody.empty();

            // „Ç¢„ÉÉ„Éó„Çµ„Éº„ÉàË®≠ÂÆö„ÅÆÂàùÊúüÂåñ
            $('#csv-upsert-mode').prop('checked', false);
            $('#csv-upsert-key-container').addClass('hidden');

            // ‰øùÂ≠òÊ∏à„ÅøË®≠ÂÆö„ÅÆ„Éó„É´„ÉÄ„Ç¶„É≥„ÇíÊõ¥Êñ∞
            // candidates„Çø„Ç§„Éó„ÅÆÂ†¥Âêà„ÅØ„ÄÅusers„ÅÆË®≠ÂÆö„ÇíË™≠„ÅøËæº„ÇÄ
            const mappingType = (currentImportType === 'candidates') ? 'users' : type;
            updateSavedMappingSelect(mappingType);
            $('#new-mapping-name').val(''); // ÂÖ•ÂäõÊ¨Ñ„ÇØ„É™„Ç¢

            fields.forEach(field => {
                // Ëá™Âãï„Éû„ÉÉ„Éî„É≥„Ç∞„É≠„Ç∏„ÉÉ„ÇØ
                let selectedHeader = '';
                // ÂÆåÂÖ®‰∏ÄËá¥„Åæ„Åü„ÅØ„Ç®„Ç§„É™„Ç¢„Çπ‰∏ÄËá¥„ÇíÊé¢„Åô
                const match = currentCSVHeaders.find(h =>
                    h === field.key ||
                    h === field.label ||
                    (field.aliases && field.aliases.some(alias => h.includes(alias)))
                );
                if (match) selectedHeader = match;

                const options = currentCSVHeaders.map(h =>
                    `<option value="${h}" ${h === selectedHeader ? 'selected' : ''}>${h}</option>`
                ).join('');

                const previewValue = currentCSVData.length > 0 && selectedHeader ? currentCSVData[0][selectedHeader] : '-';

                const row = `
                    <tr>
                        <td class="px-6 py-4 text-sm font-medium text-gray-900 border-b">
                            ${field.label} ${field.required ? '<span class="text-red-500">*</span>' : ''}
                            <div class="text-xs text-gray-500">${field.key}</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500 border-b">
                            <select class="mapping-select w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" data-key="${field.key}">
                                <option value="">(„Ç§„É≥„Éù„Éº„Éà„Åó„Å™„ÅÑ)</option>
                                ${options}
                            </select>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500 mapping-preview border-b break-all" data-key="${field.key}">
                            <div class="max-h-24 overflow-y-auto w-full">
                                ${previewValue}
                            </div>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });

            // „Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„ÇπÂ§âÊõ¥ÊôÇ„Å´„Éó„É¨„Éì„É•„ÉºÊõ¥Êñ∞„Å®„Ç¢„ÉÉ„Éó„Çµ„Éº„Éà„Ç≠„ÉºÈÅ∏ÊäûËÇ¢Êõ¥Êñ∞
            $('.mapping-select').on('change', function () {
                const key = $(this).data('key');
                const header = $(this).val();
                const previewCell = $(`.mapping-preview[data-key="${key}"]`);
                const val = currentCSVData.length > 0 && header ? currentCSVData[0][header] : '-';
                previewCell.text(val);

                // „Ç¢„ÉÉ„Éó„Çµ„Éº„Éà„Ç≠„Éº„ÅÆÈÅ∏ÊäûËÇ¢„ÇíÊõ¥Êñ∞
                if ($('#csv-upsert-mode').is(':checked')) {
                    updateUpsertKeyOptions();
                }
            });

            $('#csv-mapping-modal').removeClass('hidden');
        }

        // ========================
        // Mapping Settings Logic
        // ========================
        const MAPPING_STORAGE_KEY = 'csv_mapping_settings';

        function getSavedMappings(type) {
            try {
                const saved = localStorage.getItem(MAPPING_STORAGE_KEY);
                if (!saved) return [];
                const settings = JSON.parse(saved);
                // ÁèæÂú®„ÅÆÁµÑÁπî„Å®„Çø„Ç§„Éó„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
                return settings.filter(s => s.type === type && s.organization_id === currentUser.organization_id);
            } catch (e) {
                console.error('Failed to load mappings', e);
                return [];
            }
        }

        function updateSavedMappingSelect(type) {
            const mappings = getSavedMappings(type);
            const select = $('#saved-mapping-select');
            select.empty();
            select.append('<option value="">-- Ë®≠ÂÆö„ÇíÈÅ∏Êäû --</option>');
            mappings.forEach(m => {
                select.append(`<option value="${m.name}">${m.name}</option>`);
            });
        }

        window.applySavedMapping = function (name) {
            if (!name) return;

            // candidates„Çø„Ç§„Éó„ÅÆÂ†¥Âêà„ÅØ„ÄÅusers„ÅÆË®≠ÂÆö„ÇÇË™≠„ÅøËæº„ÇÄ
            let importType = currentImportType;
            if (importType === 'candidates') {
                importType = 'users';
            }

            const mappings = getSavedMappings(importType);
            const target = mappings.find(m => m.name === name);
            if (!target) return;

            // „Éû„ÉÉ„Éî„É≥„Ç∞ÈÅ©Áî®
            for (const [key, header] of Object.entries(target.mapping)) {
                const select = $(`.mapping-select[data-key="${key}"]`);
                if (select.length) {
                    // CSV„Éò„ÉÉ„ÉÄ„Éº„Å´„Åù„ÅÆÂÄ§„ÅåÂ≠òÂú®„Åô„Çã„ÅãÁ¢∫Ë™ç
                    // Â≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅË≠¶Âëä„ÇíÂá∫„Åï„Åö„Å´Á©∫„Å´„Åô„Çã„Åã„ÄÅ„Åù„ÅÆ„Åæ„Åæ„Å´„Åô„Çã„Åã„ÄÇ
                    // „Åì„Åì„Åß„ÅØ„ÄÅ„Éò„ÉÉ„ÉÄ„Éº„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅÆ„ÅøÈÅ©Áî®„Åô„Çã
                    if (currentCSVHeaders.includes(header)) {
                        select.val(header).trigger('change');
                    }
                }
            }
        }

        window.saveCurrentMapping = function () {
            const name = $('#new-mapping-name').val().trim();
            if (!name) {
                alert('Ë®≠ÂÆöÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const mapping = {};
            let hasMapping = false;
            $('.mapping-select').each(function () {
                const key = $(this).data('key');
                const val = $(this).val();
                if (val) {
                    mapping[key] = val;
                    hasMapping = true;
                }
            });

            if (!hasMapping) {
                alert('‰øùÂ≠ò„Åô„Çã„Éû„ÉÉ„Éî„É≥„Ç∞Ë®≠ÂÆö„Åå„ÅÇ„Çä„Åæ„Åõ„ÇìÔºàÂ∞ë„Å™„Åè„Å®„ÇÇ1„Å§„ÅØ„Éû„ÉÉ„Éî„É≥„Ç∞„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ');
                return;
            }

            try {
                const saved = localStorage.getItem(MAPPING_STORAGE_KEY);
                let settings = saved ? JSON.parse(saved) : [];

                // candidates„Çø„Ç§„Éó„ÅÆÂ†¥Âêà„ÅØ„ÄÅusers„Å®„Åó„Å¶‰øùÂ≠ò
                const saveType = (currentImportType === 'candidates') ? 'users' : currentImportType;

                // Êó¢Â≠ò„ÉÅ„Çß„ÉÉ„ÇØ
                const idx = settings.findIndex(s => s.name === name && s.type === saveType && s.organization_id === currentUser.organization_id);

                const newSetting = {
                    name,
                    type: saveType,
                    organization_id: currentUser.organization_id,
                    mapping,
                    updated_at: new Date().toISOString()
                };

                if (idx >= 0) {
                    if (!confirm(`Ë®≠ÂÆö„Äå${name}„Äç„ÅØÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô„ÄÇ‰∏äÊõ∏„Åç„Åó„Åæ„Åô„ÅãÔºü`)) return;
                    settings[idx] = newSetting;
                } else {
                    settings.push(newSetting);
                }

                localStorage.setItem(MAPPING_STORAGE_KEY, JSON.stringify(settings));
                alert('Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');

                // ‰øùÂ≠òÊ∏à„ÅøË®≠ÂÆö„ÅÆ„Éó„É´„ÉÄ„Ç¶„É≥„ÇíÊõ¥Êñ∞
                const mappingType = (currentImportType === 'candidates') ? 'users' : currentImportType;
                updateSavedMappingSelect(mappingType);
                $('#saved-mapping-select').val(name);

            } catch (e) {
                console.error('Save error', e);
                alert('Ë®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        window.deleteSavedMapping = function () {
            const name = $('#saved-mapping-select').val();
            if (!name) {
                alert('ÂâäÈô§„Åô„ÇãË®≠ÂÆö„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            if (!confirm(`Ë®≠ÂÆö„Äå${name}„Äç„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü`)) return;

            try {
                const saved = localStorage.getItem(MAPPING_STORAGE_KEY);
                if (!saved) return;

                let settings = JSON.parse(saved);
                settings = settings.filter(s => !(s.name === name && s.type === currentImportType && s.organization_id === currentUser.organization_id));

                localStorage.setItem(MAPPING_STORAGE_KEY, JSON.stringify(settings));
                alert('Ë®≠ÂÆö„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
                updateSavedMappingSelect(currentImportType);
                $('#new-mapping-name').val('');

            } catch (e) {
                console.error('Delete error', e);
                alert('Ë®≠ÂÆö„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        window.closeCSVMappingModal = function () {
            $('#csv-mapping-modal').addClass('hidden');
            currentCSVData = [];
            currentCSVHeaders = [];
        }

        window.autoMapWithAI = async function (event) {
            if (!currentCSVHeaders || currentCSVHeaders.length === 0) {
                alert('Ëß£ÊûêÂØæË±°„ÅÆCSV„Éò„ÉÉ„ÉÄ„Éº„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            const fields = currentImportType === 'jobs' ? jobFields :
                currentImportType === 'companies' ? companyFields : userFields;

            // AI„Å´ÈÄÅ„ÇãÊÉÖÂ†±
            // Ë£úË∂≥ÊÉÖÂ†±„Å®„Åó„Å¶Êó¢Â≠ò„ÅÆ„Ç®„Ç§„É™„Ç¢„Çπ„ÇÇÊ∏°„Åô„Åì„Å®„ÅßÁ≤æÂ∫¶Âêë‰∏ä„ÇíÂõ≥„Çã
            const inputData = {
                csv_headers: currentCSVHeaders,
                system_fields: fields.map(f => ({
                    key: f.key,
                    label: f.label,
                    description: f.aliases ? f.aliases.join(', ') : ''
                }))
            };

            const btn = $(event.currentTarget);
            const originalContent = btn.html();
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>AIËß£Êûê‰∏≠...');

            try {
                // analyzeDocumentWithAI „ÅØÊó¢Â≠ò„ÅÆÈñ¢Êï∞ (ÂÜÖÈÉ®„ÅßEdge Function„ÇíÂëº„Å∂)
                // „ÉÜ„Ç≠„Çπ„Éà„Å®„Åó„Å¶JSONÊñáÂ≠óÂàó„ÇíÊ∏°„Åô
                // prompt_key 'csv_field_mapping' (Step 435„ÅßËøΩÂä†) „ÇíÊåáÂÆö
                const promptDetail = JSON.stringify(inputData, null, 2);

                const result = await analyzeDocumentWithAI(promptDetail, 'csv_field_mapping');

                let mapping = null;
                // ÁµêÊûú„ÅåÊñáÂ≠óÂàó(JSONÊñáÂ≠óÂàó)„ÅÆÂ†¥Âêà„Å®„ÄÅÊó¢„Å´„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÂ†¥Âêà„Å´ÂØæÂøú
                if (typeof result === 'string') {
                    try {
                        // Markdown„Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØÈô§Âéª
                        const cleanJson = result.replace(/^```json\s*|\s*```$/g, '').trim();
                        mapping = JSON.parse(cleanJson);
                    } catch (e) {
                        console.error('JSON parse error from AI', e);
                    }
                } else if (typeof result === 'object') {
                    mapping = result;
                }

                if (mapping) {
                    console.log('AI Mapping Result:', mapping);
                    let count = 0;

                    // Êó¢Â≠ò„ÅÆÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢„Åô„Çã„Åã„Å©„ÅÜ„ÅãÔºü -> Êó¢Â≠ò„ÇíÁîü„Åã„Åó„Å§„Å§„ÄÅÊú™Ââ≤ÂΩì„ÇíÂüã„ÇÅ„Çã„ÄÅ„ÅÇ„Çã„ÅÑ„ÅØ‰∏äÊõ∏„Åç„Åô„Çã
                    // „Åì„Åì„Åß„ÅØ„ÄåÁ©∫Ê¨Ñ„Äç„Åæ„Åü„ÅØ„ÄåAI„Åå„Çà„ÇäÁ¢∫Â∫¶„ÅÆÈ´ò„ÅÑÊèêÊ°à„Çí„Åó„Å¶„Åç„Åü„ÄçÂ†¥Âêà„Å´ÈÅ©Áî®„Åô„Çã„Åå„ÄÅ
                    // „Ç∑„É≥„Éó„É´„Å´„ÄåAI„ÅÆÊèêÊ°à„ÇíÂÖ®ÈÅ©Áî®Ôºà‰∏äÊõ∏„ÅçÔºâ„Äç„Å®„Åô„Çã„ÄÇ
                    // „É¶„Éº„Ç∂„Éº„ÅØÊ∞ó„Å´ÂÖ•„Çâ„Å™„Åë„Çå„Å∞ÊâãÂãï„ÅßÊàª„Åõ„Çã„ÄÇ

                    for (const [key, header] of Object.entries(mapping)) {
                        // „Éò„ÉÉ„ÉÄ„Éº„ÅåCSV„Å´Êú¨ÂΩì„Å´Â≠òÂú®„Åô„Çã„ÅãÁ¢∫Ë™ç
                        if (currentCSVHeaders.includes(header)) {
                            const select = $(`.mapping-select[data-key="${key}"]`);
                            if (select.length) {
                                // Êó¢„Å´ÂÄ§„ÅåÂÖ•„Å£„Å¶„ÅÑ„Å¶„ÇÇ‰∏äÊõ∏„Åç„Åô„Çã
                                select.val(header).trigger('change');
                                count++;
                            }
                        }
                    }
                    alert(`${count}‰ª∂„ÅÆ„Éï„Ç£„Éº„É´„Éâ„ÇíËá™Âãï„Éû„ÉÉ„Éî„É≥„Ç∞„Åó„Åæ„Åó„Åü„ÄÇ\nÁµêÊûú„ÇíÁ¢∫Ë™ç„Åó„ÄÅÂøÖË¶Å„Å´Âøú„Åò„Å¶‰øÆÊ≠£„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                } else {
                    alert('AI„Å´„Çà„ÇãËß£ÊûêÁµêÊûú„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
                }

            } catch (err) {
                console.error('AI Auto Map Error:', err);
                alert('AIÂá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + err.message);
            } finally {
                btn.prop('disabled', false).html(originalContent);
            }
        }

        window.previewAIAnalysis = async function (event) {
            if (!currentCSVData || currentCSVData.length === 0) {
                alert('„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }

            if (currentImportType !== 'jobs' && currentImportType !== 'candidates' && currentImportType !== 'users') {
                alert('ÁèæÂú®„ÄÅÊ±Ç‰∫∫„Åæ„Åü„ÅØÊ±ÇËÅ∑ËÄÖ„ÅÆAIËß£Êûê„Éó„É¨„Éì„É•„Éº„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åô');
                return;
            }

            const btn = $(event.currentTarget);
            const originalContent = btn.html();
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>Ëß£Êûê‰∏≠...');

            try {
                const row = currentCSVData[0];
                // ÂÖ®„Ç´„É©„É†„Çí„ÉÜ„Ç≠„Çπ„ÉàÂåñ
                const text = Object.entries(row).map(([k, v]) => `${k}: ${v}`).join('\n');

                const options = {
                    job_categories: typeof masterJobCategories !== 'undefined' ? masterJobCategories : [],
                    industry_categories: typeof masterIndustries !== 'undefined' ? masterIndustries : []
                };

                // „Éó„É≠„É≥„Éó„Éà„Ç≠„Éº„ÅÆÊ±∫ÂÆö
                const aiType = (currentImportType === 'users' || currentImportType === 'candidates') ? 'resume' : 'job_description';

                let aiResult = await analyzeDocumentWithAI(text, aiType, options);

                // ÈÖçÂàó„ÅßËøî„Å£„Å¶„Åè„ÇãÂ†¥Âêà„Å∏„ÅÆÂØæÂøú
                if (Array.isArray(aiResult)) aiResult = aiResult[0] || {};

                if (typeof aiResult === 'string') {
                    try { aiResult = JSON.parse(aiResult.replace(/```json|```/g, '').trim()); } catch (e) { }
                }

                // „Ç≠„Éº„ÅÆÊ≠£Ë¶èÂåñ (AI„ÅÆÊè∫„Çâ„ÅéÂê∏Âèé)
                if (aiResult.industry_category && !aiResult.industry) aiResult.industry = aiResult.industry_category;

                // Ê±ÇËÅ∑ËÄÖÁî®„Éï„Ç£„Éº„É´„Éâ„ÅÆÊ≠£Ë¶èÂåñ
                if (aiResult.experience && !aiResult.work_history) aiResult.work_history = aiResult.experience;
                if (aiResult.education && !aiResult.academic_background) aiResult.academic_background = aiResult.education;

                // „É™„É¢„Éº„ÉàÂèØÂê¶„ÅÆË°®Á§∫Áî®Â§âÊèõ
                if (aiResult.is_remote === true || aiResult.is_remote === 'true') aiResult.is_remote = 'ÂèØ';
                if (aiResult.is_remote === false || aiResult.is_remote === 'false') aiResult.is_remote = '‰∏çÂèØ';

                // ÈÖçÂàó„Éá„Éº„Çø„ÅÆË°®Á§∫Áî®Â§âÊèõ (Ê±ÇËÅ∑ËÄÖÁî®)
                if (Array.isArray(aiResult.desired_job_type)) aiResult.desired_job_type = aiResult.desired_job_type.join(', ');
                if (Array.isArray(aiResult.desired_location)) aiResult.desired_location = aiResult.desired_location.join(', ');
                if (Array.isArray(aiResult.skills)) aiResult.skills = aiResult.skills.join(', ');

                console.log('AI Preview Result:', aiResult);

                // ÁµêÊûú„ÇíË°®Á§∫
                $('.ai-preview-badge').remove(); // Êó¢Â≠ò„ÅÆ„Éê„ÉÉ„Ç∏Ê∂àÂéª

                let matchCount = 0;
                for (const [key, value] of Object.entries(aiResult)) {
                    if (value === null || value === undefined || value === '') continue;

                    // keyÂêç„Åå jobFields „ÅÆ key „Å®‰∏ÄËá¥„Åô„Çã„ÇÇ„ÅÆ„ÇíÊé¢„Åô
                    const select = $(`.mapping-select[data-key="${key}"]`);
                    if (select.length) {
                        const rowEl = select.closest('tr');
                        const previewCell = rowEl.find('td:last-child');

                        // ÂÄ§„ÅåÈï∑„ÅÑÂ†¥Âêà„ÅØÂàá„ÇäË©∞„ÇÅ„Çã
                        let displayValue = String(value);
                        if (displayValue.length > 30) displayValue = displayValue.substring(0, 30) + '...';

                        previewCell.append(`
                            <div class="ai-preview-badge mt-2 text-xs text-indigo-700 bg-indigo-50 border border-indigo-200 rounded px-2 py-1 shadow-sm">
                                <strong class="block text-indigo-900 mb-0.5"><i class="fas fa-robot mr-1"></i>AIËß£Êûê</strong>
                                ${displayValue}
                            </div>
                        `);
                        matchCount++;
                    }
                }

                if (matchCount > 0) {
                    alert(`1‰ª∂ÁõÆ„ÅÆËß£Êûê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ\n${matchCount}È†ÖÁõÆ„ÅÆAIËß£ÊûêÁµêÊûú„Çí„Éó„É¨„Éì„É•„ÉºÂàó„Å´Ë°®Á§∫„Åó„Åæ„Åó„Åü„ÄÇ`);
                } else {
                    alert('AIËß£Êûê„ÇíÂÆüË°å„Åó„Åæ„Åó„Åü„Åå„ÄÅË°®Á§∫„Åß„Åç„ÇãÈ†ÖÁõÆ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ\nËß£ÊûêÁµêÊûú: ' + JSON.stringify(aiResult, null, 2));
                }

            } catch (e) {
                console.error('AI Preview Error:', e);
                let errorMsg = e.message;
                if (e.details) {
                    try {
                        const detailObj = JSON.parse(e.details);
                        if (detailObj.error && detailObj.error.message) {
                            errorMsg += '\nË©≥Á¥∞: ' + detailObj.error.message;
                        } else {
                            errorMsg += '\nË©≥Á¥∞: ' + e.details;
                        }
                    } catch (err) {
                        errorMsg += '\nË©≥Á¥∞: ' + e.details;
                    }
                }
                alert('Ëß£ÊûêÂ§±Êïó: ' + errorMsg);
            } finally {
                btn.prop('disabled', false).html(originalContent);
            }
        }

        let suspectedDuplicates = [];
        window.closeSuspectedDuplicatesModal = function () {
            $('#suspected-duplicates-modal').addClass('hidden');
            suspectedDuplicates = [];
        };

        window.toggleDuplicateCheckAll = function (el) {
            $('.duplicate-row-check').prop('checked', $(el).is(':checked'));
        };

        window.importSelectedDuplicates = async function () {
            const selectedIndices = [];
            $('.duplicate-row-check:checked').each(function () {
                selectedIndices.push(parseInt($(this).val()));
            });

            if (selectedIndices.length === 0) {
                alert('„Ç§„É≥„Éù„Éº„Éà„Åô„ÇãÊ±Ç‰∫∫„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            const totalCount = selectedIndices.length;
            showImportProgress('ÈáçË§áÂÄôË£ú„ÅÆÁôªÈå≤„ÉªÊõ¥Êñ∞', `${totalCount}‰ª∂„ÅÆÊ±Ç‰∫∫„ÇíÂá¶ÁêÜ„Åó„Å¶„ÅÑ„Åæ„Åô`);
            addImportStep('db', '„Éá„Éº„Çø„Éô„Éº„ÇπÁôªÈå≤');

            let successCount = 0;
            let failedCount = 0;
            const errors = [];

            try {
                for (let i = 0; i < selectedIndices.length; i++) {
                    const index = selectedIndices[i];
                    const item = suspectedDuplicates[index];
                    const action = $(`input[name="duplicate-action-${index}"]:checked`).val();

                    setImportStepStatus('db', 'active');
                    updateImportProgress((i / totalCount) * 100, i, totalCount);

                    try {
                        if (item.duplicate_id && action === 'update') {
                            // „Ç¢„ÉÉ„Éó„Çµ„Éº„Éà(Êõ¥Êñ∞)Âá¶ÁêÜ
                            const updatePayload = mergeJobData(item.data || item.importData, {});
                            const { error: updateError } = await supabase.from('jobs').update(updatePayload).eq('id', item.duplicate_id);
                            if (updateError) throw updateError;
                        } else {
                            // Êñ∞Ë¶èÁôªÈå≤
                            const { error: insertError } = await supabase.from('jobs').insert(item.data || item.importData);
                            if (insertError) throw insertError;
                        }
                        successCount++;
                    } catch (err) {
                        console.error('Duplicate import error:', err);
                        failedCount++;
                        errors.push({ row: item.row, error: err.message });
                    }
                }

                setImportStepStatus('db', 'done');
                updateImportProgress(100, totalCount, totalCount);

                setTimeout(() => {
                    alert(`Âá¶ÁêÜÂÆå‰∫Ü\nÊàêÂäü: ${successCount}‰ª∂\nÂ§±Êïó: ${failedCount}‰ª∂${failedCount > 0 ? '\n\n„Ç®„É©„ÉºÂÜÖÂÆπ:\n' + errors.map(e => `${e.row}Ë°åÁõÆ: ${e.error}`).join('\n') : ''}`);
                    closeSuspectedDuplicatesModal();
                    if (typeof loadAdminJobs === 'function') loadAdminJobs();
                }, 500);
            } catch (err) {
                alert('Âá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + err.message);
            } finally {
                hideImportProgress();
            }

        };

        window.executeCSVImport = async function () {
            const totalRows = currentCSVData.length;
            showImportProgress('CSV„Ç§„É≥„Éù„Éº„ÉàÂÆüË°å‰∏≠', `${totalRows}‰ª∂„ÅÆ„Éá„Éº„Çø„ÇíÂá¶ÁêÜ„Åó„Å¶„ÅÑ„Åæ„Åô`);
            addImportStep('parse', '„Éá„Éº„ÇøÂ§âÊèõ„Éª„Éê„É™„Éá„Éº„Ç∑„Éß„É≥');
            addImportStep('ai', 'AIËá™ÂãïË£úÂÆå', 'fa-magic');
            addImportStep('db', '„Éá„Éº„Çø„Éô„Éº„ÇπÁôªÈå≤');

            suspectedDuplicates = [];
            try {
                const mapping = {};
                let missingRequired = [];
                const fields = currentImportType === 'jobs' ? jobFields :
                    currentImportType === 'companies' ? companyFields : userFields;

                const isUpsert = $('#csv-upsert-mode').is(':checked');
                const upsertKey = $('#csv-upsert-key').val();

                if (isUpsert && !upsertKey) {
                    alert('„Ç¢„ÉÉ„Éó„Çµ„Éº„Éà„ÇíÊúâÂäπ„Å´„Åô„ÇãÂ†¥Âêà„ÅØ„ÄÅÊõ¥Êñ∞„Ç≠„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    hideLoading();
                    return;
                }

                // „Éû„ÉÉ„Éî„É≥„Ç∞ÊÉÖÂ†±„ÅÆÂèéÈõÜ
                $('.mapping-select').each(function () {
                    const key = $(this).data('key');
                    const header = $(this).val();
                    if (header) {
                        mapping[key] = header;
                    } else {
                        const field = fields.find(f => f.key === key);
                        if (field && field.required) {
                            // „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅÆÂøÖÈ†à„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÁµÑÁπîË®≠ÂÆö„Å´Âü∫„Å•„ÅÑ„Å¶„Çπ„Ç≠„ÉÉ„Éó
                            if ((currentImportType === 'users' || currentImportType === 'candidates') && field.key === 'email') {
                                if (currentUser.organizations && currentUser.organizations.settings && currentUser.organizations.settings.candidate_email_required === false) {
                                    return; // „Çπ„Ç≠„ÉÉ„Éó
                                }
                            }
                            missingRequired.push(field.label);
                        }
                    }
                });

                if (missingRequired.length > 0) {
                    alert(`ÂøÖÈ†àÈ†ÖÁõÆ„Åå„Éû„ÉÉ„Éî„É≥„Ç∞„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì: ${missingRequired.join(', ')}`);
                    hideLoading();
                    return;
                }

                let successCount = 0;
                let failedCount = 0;
                let skipCount = 0;
                const errors = [];
                const skips = [];

                const salaryUnit = $('input[name="csv-salary-unit"]:checked').val() || 'auto';

                for (let i = 0; i < currentCSVData.length; i++) {
                    const row = currentCSVData[i];
                    // „Éá„Éº„ÇøË°åÊï∞Ôºà1Âßã„Åæ„ÇäÔºâ
                    const csvRowNumber = i + 1;
                    // Ë°®Á§∫Áî®Ë°åÊï∞Ôºà„Éò„ÉÉ„ÉÄ„Éº„Åå„ÅÇ„Çã„Åü„ÇÅ +1Ôºâ
                    const displayRowNumber = i + 2;

                    setImportStepStatus('parse', 'active');
                    updateImportProgress((i / totalRows) * 100, i, totalRows);


                    try {
                        const importData = {};
                        // „Éû„ÉÉ„Éî„É≥„Ç∞„Å´Âü∫„Å•„ÅÑ„Å¶„Éá„Éº„ÇøÂ§âÊèõ
                        for (const [key, header] of Object.entries(mapping)) {
                            let value = row[header];

                            // Êï∞ÂÄ§Â§âÊèõ„ÅåÂøÖË¶Å„Å™„Éï„Ç£„Éº„É´„Éâ„ÅÆÂá¶ÁêÜÔºàÂπ¥Âèé„ÉªÂ∏åÊúõÂπ¥ÂèéÔºâ
                            if (['salary_min', 'salary_max', 'desired_salary'].includes(key)) {
                                if (value) {
                                    // ÂÖ®ËßíÊï∞Â≠ó„ÇíÂçäËßí„Å´„ÄÅ„Ç´„É≥„ÉûÈô§Âéª
                                    let str = String(value)
                                        .replace(/[Ôºê-Ôºô]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
                                        .replace(/,/g, '');

                                    // „Äå‰∏áÂÜÜ„Äç„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                                    const hasMan = str.includes('‰∏á');

                                    // ÂÖ®„Å¶„ÅÆÊï∞ÂÄ§ÔºàÂ∞èÊï∞ÁÇπÂê´„ÇÄÔºâ„ÇíÊäΩÂá∫
                                    const numbers = str.match(/[0-9.]+/g);

                                    if (numbers && numbers.length > 0) {
                                        let num;
                                        if (numbers.length >= 2) {
                                            // 2„Å§‰ª•‰∏äÊï∞ÂÄ§„Åå„ÅÇ„ÇãÂ†¥ÂêàÔºàÁØÑÂõ≤„Å®„Åø„Å™„ÅôÔºâ
                                            if (key === 'salary_min' || key === 'desired_salary') {
                                                num = parseFloat(numbers[0]); // ÊúÄÂàù„ÅÆÊï∞ÂÄ§„ÇíÊúÄÂ∞èÂÄ§„Å´
                                            } else if (key === 'salary_max') {
                                                num = parseFloat(numbers[1]); // 2Áï™ÁõÆ„ÅÆÊï∞ÂÄ§„ÇíÊúÄÂ§ßÂÄ§„Å´
                                            }
                                        } else {
                                            // 1„Å§„Åó„ÅãÊï∞ÂÄ§„Åå„Å™„ÅÑÂ†¥Âêà
                                            num = parseFloat(numbers[0]);
                                        }

                                        if (!isNaN(num)) {
                                            if (hasMan || salaryUnit === 'man') {
                                                value = Math.round(num * 10000);
                                            } else if (salaryUnit === 'yen') {
                                                value = Math.round(num);
                                            } else {
                                                // auto: 1‰∏áÊú™Ê∫Ä„Å™„Çâ‰∏áÂÜÜÂçò‰Ωç„Å®„Åø„Å™„Åô
                                                value = num < 10000 ? Math.round(num * 10000) : Math.round(num);
                                            }
                                        } else {
                                            value = null;
                                        }
                                    } else {
                                        value = null;
                                    }
                                    console.log(`Salary Conversion: [${key}] "${str}" -> extracted num: ${value / 10000}‰∏á`);
                                } else {
                                    value = null;
                                }
                            }

                            if (key === 'is_remote') {
                                value = ['true', 'yes', '1', 'ÂèØ', '„ÅÇ„Çä', 'Êúâ', 'ok', '„Äá', '‚óØ'].includes(String(value).toLowerCase());
                            }

                            if (key === 'job_experience_ok' || key === 'industry_experience_ok') {
                                const isPos = ['true', 'yes', '1', 'ÂèØ', '„ÅÇ„Çä', 'Êúâ', 'ok', '„Äá', '‚óØ'].includes(String(value).toLowerCase());
                                value = isPos ? 'ÂèØ' : '‰∏çÂèØ';
                            }

                            if (key === 'status') {
                                const valStr = String(value || '').trim().toLowerCase();
                                if (['active', 'ÂÖ¨Èñã‰∏≠', 'ÂÖ¨Èñã', 'ÂãüÈõÜÈñãÂßã', 'ÈñãÂßã', '1'].includes(valStr)) {
                                    value = 'active';
                                } else if (['inactive', 'ÈùûÂÖ¨Èñã', 'ÂÅúÊ≠¢', '‰∏ÄÊôÇÂÅúÊ≠¢', '0'].includes(valStr)) {
                                    value = 'inactive';
                                } else if (['closed', 'ÁµÇ‰∫Ü', 'ÂãüÈõÜÁµÇ‰∫Ü', 'ÂÆåÂ£≤'].includes(valStr)) {
                                    value = 'closed';
                                } else {
                                    value = 'active'; // „Éá„Éï„Ç©„É´„Éà
                                }
                            }

                            importData[key] = value;
                        }

                        importData.organization_id = currentUser.organization_id;
                        setImportStepStatus('parse', 'done');


                        // AIËá™ÂãïË£úÂÆå
                        const useAI = $('#csv-ai-augment').is(':checked');
                        if (useAI && (currentImportType === 'jobs' || currentImportType === 'candidates')) {
                            setImportStepStatus('ai', 'active');

                            const rowText = Object.entries(row).map(([k, v]) => `${k}: ${v}`).join('\n');
                            const aiType = currentImportType === 'jobs' ? 'job_description' : 'resume';
                            const options = {
                                job_categories: typeof masterJobCategories !== 'undefined' ? masterJobCategories : [],
                                industry_categories: typeof masterIndustries !== 'undefined' ? masterIndustries : []
                            };

                            try {
                                let aiResult = await analyzeDocumentWithAI(rowText, aiType, options);
                                if (Array.isArray(aiResult)) aiResult = aiResult[0] || {};

                                if (aiResult) {
                                    if (currentImportType === 'jobs') {
                                        if (!importData.job_category && aiResult.job_category) importData.job_category = aiResult.job_category;
                                        if (!importData.industry_category && aiResult.industry_category) importData.industry_category = aiResult.industry_category;
                                        if (!importData.is_remote) {
                                            if (aiResult.is_remote === true || aiResult.is_remote === 'true') importData.is_remote = true;
                                            else if (aiResult.is_remote === false || aiResult.is_remote === 'false') importData.is_remote = false;
                                            else if (aiResult.is_remote) importData.is_remote = aiResult.is_remote;
                                        }
                                        if (!importData.industry) importData.industry = aiResult.industry || aiResult.industry_category;
                                        if (aiResult.requirements && (!importData.requirements || importData.requirements.length < 10)) importData.requirements = aiResult.requirements;
                                        if (aiResult.welcome_requirements && (!importData.welcome_requirements || importData.welcome_requirements.length < 5)) importData.welcome_requirements = aiResult.welcome_requirements;
                                        if (!importData.description && aiResult.description) importData.description = aiResult.description;
                                        if (!importData.work_hours && aiResult.work_hours) importData.work_hours = aiResult.work_hours;
                                        if (!importData.holidays && aiResult.holidays) importData.holidays = aiResult.holidays;
                                        if (!importData.benefits && aiResult.benefits) importData.benefits = aiResult.benefits;
                                        if (!importData.interview_process && aiResult.interview_process) importData.interview_process = aiResult.interview_process;
                                        if (!importData.employment_type && aiResult.employment_type) importData.employment_type = aiResult.employment_type;
                                    } else if (currentImportType === 'candidates') {
                                        if (!importData.age && aiResult.age) importData.age = aiResult.age;
                                        if (!importData.skills && aiResult.skills) importData.skills = Array.isArray(aiResult.skills) ? aiResult.skills.join(', ') : aiResult.skills;
                                        if (!importData.work_history && aiResult.experience) importData.work_history = Array.isArray(aiResult.experience) ? aiResult.experience.join('\n') : aiResult.experience;
                                        if (!importData.academic_background && aiResult.education) importData.academic_background = Array.isArray(aiResult.education) ? aiResult.education.join('\n') : aiResult.education;
                                        if (!importData.desired_job_type && aiResult.desired_job_type) importData.desired_job_type = Array.isArray(aiResult.desired_job_type) ? aiResult.desired_job_type.join(', ') : aiResult.desired_job_type;
                                        if (!importData.desired_location && aiResult.desired_location) importData.desired_location = Array.isArray(aiResult.desired_location) ? aiResult.desired_location.join(', ') : aiResult.desired_location;
                                    }
                                }
                            } catch (e) { console.error('AI error:', e); }
                            setImportStepStatus('ai', 'done');
                        }

                        if (currentImportType === 'jobs') {
                            if (!importData.title) throw new Error('Ê±Ç‰∫∫„Çø„Ç§„Éà„É´„ÅØÂøÖÈ†à„Åß„Åô');
                            if (!importData.company) throw new Error('‰ºÅÊ•≠Âêç„ÅØÂøÖÈ†à„Åß„Åô');

                            setImportStepStatus('db', 'active');
                            // ‰ºÅÊ•≠ID„ÅÆËß£Ê±∫
                            let companyId = null;
                            const { data: existingCompany } = await supabase
                                .from('companies')
                                .select('id')
                                .eq('organization_id', currentUser.organization_id)
                                .eq('name', importData.company)
                                .maybeSingle();

                            if (existingCompany) {
                                companyId = existingCompany.id;
                            } else {
                                const { data: newCompany, error: createError } = await supabase
                                    .from('companies')
                                    .insert({
                                        organization_id: currentUser.organization_id,
                                        name: importData.company,
                                        location: importData.location || 'Êú™ÂÆö'
                                    })
                                    .select()
                                    .single();
                                if (createError) throw new Error(`‰ºÅÊ•≠‰ΩúÊàê„Ç®„É©„Éº: ${createError.message}`);
                                companyId = newCompany.id;
                            }
                            importData.company_id = companyId;
                            if (!importData.status) {
                                importData.status = 'active';
                            }

                            if (importData.industry) {
                                let val = importData.industry;
                                if (typeof masterIndustries !== 'undefined') {
                                    const match = masterIndustries.find(label => label === val);
                                    if (match) val = match;
                                }
                                importData.industry_category = val;
                                delete importData.industry;
                            }

                            if (importData.job_category) {
                                let val = importData.job_category;
                                if (typeof masterJobCategories !== 'undefined') {
                                    const match = masterJobCategories.find(label => label === val);
                                    if (match) val = match;
                                }
                                importData.job_category = val;
                            }

                            // ÈáçË§áÁñë„ÅÑ„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
                            if (!isUpsert) {
                                const { data: existingJobs } = await supabase
                                    .from('jobs')
                                    .select('id, job_code, title, company, job_category, location, salary_min, salary_max, description, requirements, welcome_requirements, qualifications, work_hours, holidays, benefits, interview_process, employment_type, is_remote, job_experience_ok, industry_experience_ok, pdf_url, pdf_filename, status')
                                    .eq('organization_id', currentUser.organization_id)
                                    .is('deleted_at', null)
                                    .limit(500);

                                const duplicate = existingJobs?.find(j => isJobDuplicate(importData, j));

                                if (duplicate) {
                                    suspectedDuplicates.push({
                                        row: displayRowNumber,
                                        importData: importData,
                                        existingJob: duplicate,
                                        duplicate_id: duplicate.id,
                                        company: importData.company,
                                        title: importData.title,
                                        location: importData.location,
                                        reasons: duplicate._duplicateReasons,
                                        score: duplicate._duplicateScore
                                    });
                                    skipCount++;
                                    skips.push(displayRowNumber);
                                    continue;
                                }
                            }

                            // „Ç¢„ÉÉ„Éó„Çµ„Éº„ÉàÂá¶ÁêÜ
                            if (isUpsert && upsertKey && importData[upsertKey]) {
                                const { data: existingRecord } = await supabase
                                    .from('jobs')
                                    .select('*')
                                    .eq('organization_id', currentUser.organization_id)
                                    .eq(upsertKey, importData[upsertKey])
                                    .is('deleted_at', null)
                                    .maybeSingle();

                                if (existingRecord) {
                                    const updatePayload = mergeJobData(importData, existingRecord);
                                    const { error } = await supabase.from('jobs').update(updatePayload).eq('id', existingRecord.id);
                                    if (error) throw error;
                                } else {
                                    const { error } = await supabase.from('jobs').insert(importData);
                                    if (error) throw error;
                                }
                            } else {
                                const { error } = await supabase.from('jobs').insert(importData);
                                if (error) throw error;
                            }

                        } else if (currentImportType === 'companies') {
                            if (!importData.name) throw new Error('‰ºÅÊ•≠Âêç„ÅØÂøÖÈ†à„Åß„Åô');

                            if (isUpsert && upsertKey && importData[upsertKey]) {
                                const { data: existingRecord } = await supabase
                                    .from('companies')
                                    .select('id')
                                    .eq('organization_id', currentUser.organization_id)
                                    .eq(upsertKey, importData[upsertKey])
                                    .maybeSingle();

                                if (existingRecord) {
                                    const { error } = await supabase.from('companies').update(importData).eq('id', existingRecord.id);
                                    if (error) throw error;
                                } else {
                                    const { error } = await supabase.from('companies').insert(importData);
                                    if (error) throw error;
                                }
                            } else {
                                const { error } = await supabase.from('companies').insert(importData);
                                if (error) throw error;
                            }

                        } else if (currentImportType === 'users') {
                            if (!importData.role) importData.role = 'candidate';
                            let emailRequired = true;
                            if (importData.role === 'candidate' && currentUser.organizations?.settings?.candidate_email_required === false) {
                                emailRequired = false;
                            }

                            if (!importData.email) {
                                if (emailRequired) throw new Error('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅØÂøÖÈ†à„Åß„Åô');
                                importData.email = `candidate-${Date.now()}-${crypto.randomUUID().substring(0, 8)}@placeholder.local`;
                            }
                            if (!importData.name) throw new Error('Ê∞èÂêç„ÅØÂøÖÈ†à„Åß„Åô');

                            if (isUpsert && upsertKey && importData[upsertKey]) {
                                const { data: existingRecord } = await supabase
                                    .from('users')
                                    .select('id')
                                    .eq('organization_id', currentUser.organization_id)
                                    .eq(upsertKey, importData[upsertKey])
                                    .maybeSingle();

                                if (existingRecord) {
                                    const { error } = await supabase.from('users').update(importData).eq('id', existingRecord.id);
                                    if (error) throw error;
                                } else {
                                    const { error } = await supabase.from('users').insert(importData);
                                    if (error) throw error;
                                }
                            } else {
                                const { data: existingUser } = await supabase.from('users').select('id').eq('email', importData.email).maybeSingle();
                                if (existingUser) throw new Error(`Êó¢„Å´Â≠òÂú®„Åô„Çã„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Åß„Åô: ${importData.email}`);

                                const { error } = await supabase.from('users').insert(importData);
                                if (error) throw error;
                            }

                        } else if (currentImportType === 'candidates') {
                            importData.role = 'candidate';

                            if (!currentUser.organizations || !currentUser.organizations.settings || currentUser.role === 'super_admin') {
                                try {
                                    const { data: freshOrg } = await supabase.from('organizations').select('settings').eq('id', currentUser.organization_id).single();
                                    if (freshOrg) {
                                        if (!currentUser.organizations) currentUser.organizations = {};
                                        currentUser.organizations.settings = freshOrg.settings;
                                    }
                                } catch (e) { console.warn('Failed to refresh org settings before import', e); }
                            }

                            const orgSettings = getOrgSettings();
                            const emailRequired = orgSettings.candidate_email_required !== false;
                            const passwordRequired = orgSettings.candidate_password_required !== false;

                            if (!importData.email || importData.email.trim() === '') {
                                if (emailRequired) throw new Error('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅØÂøÖÈ†à„Åß„Åô');
                                importData.email = `candidate-${Date.now()}-${Math.random().toString(36).substring(2, 10)}@placeholder.local`;
                            }
                            if (!importData.password || importData.password.trim() === '') {
                                if (passwordRequired) throw new Error('„Éë„Çπ„ÉØ„Éº„Éâ„ÅØÂøÖÈ†à„Åß„Åô');
                                importData.password = `dummyPass${Math.random().toString(36).substring(2, 15)}`;
                            }
                            if (!importData.name || importData.name.trim() === '') throw new Error('Ê∞èÂêç„ÅØÂøÖÈ†à„Åß„Åô');

                            const { data, error } = await supabase.functions.invoke('create-user', {
                                body: {
                                    email: importData.email,
                                    password: importData.password,
                                    name: importData.name,
                                    role: 'candidate',
                                    organizationId: currentUser.organization_id,
                                    upsert: isUpsert,
                                    userCode: importData.user_code || null,
                                    profileData: {
                                        user_code: importData.user_code || null,
                                        age: importData.age || null,
                                        desired_job_type: importData.desired_job_type ?
                                            (typeof importData.desired_job_type === 'string' ? importData.desired_job_type.split(/[,„ÄÅ\uff0c\uff0f\s„ÄÄ]+/).map(s => s.trim()).filter(Boolean) : importData.desired_job_type) : null,
                                        desired_location: importData.desired_location ?
                                            (typeof importData.desired_location === 'string' ? importData.desired_location.split(/[,„ÄÅ\uff0c\uff0f\s„ÄÄ]+/).map(s => s.trim()).filter(Boolean) : importData.desired_location) : null,
                                        desired_salary: importData.desired_salary || null,
                                        skills: importData.skills || null,
                                        work_history: importData.work_history || null,
                                        academic_background: importData.academic_background || importData.education || null,
                                        languages: importData.languages || null,
                                        certifications: importData.certifications || null,
                                        matching_info: importData.matching_info || null,
                                        internal_info: importData.internal_info || null,
                                        other_info: importData.other_info || null
                                    }
                                }
                            });

                            if (error || !data.success) throw new Error(error?.message || data?.error || '„É¶„Éº„Ç∂„Éº‰ΩúÊàêÂ§±Êïó');
                        }

                        successCount++;
                        setImportStepStatus('db', 'done');

                    } catch (err) {
                        console.error(`Row ${displayRowNumber} error:`, err);
                        failedCount++;
                        errors.push({ row: displayRowNumber, data: row, error: err.message || JSON.stringify(err) });
                    }
                }

                await supabase.from('csv_imports').insert({
                    organization_id: currentUser.organization_id,
                    user_id: currentUser.id,
                    import_type: currentImportType,
                    file_name: 'import.csv',
                    total_rows: currentCSVData.length,
                    success_rows: successCount,
                    failed_rows: failedCount,
                    errors: errors
                });

                closeCSVMappingModal();
                hideImportProgress();
                let message = `„Ç§„É≥„Éù„Éº„ÉàÂÆå‰∫Ü\nÊàêÂäü: ${successCount}‰ª∂\nÂ§±Êïó: ${failedCount}‰ª∂\n„Çπ„Ç≠„ÉÉ„Éó: ${skipCount}‰ª∂`;

                if (failedCount > 0) {
                    message += `\n\n„Ç®„É©„Éº„Å®„Å™„Å£„ÅüCSVË°å:\n` + errors.map(e => `${e.row}Ë°åÁõÆ`).join(', ');
                    if (errors.length > 5) {
                        message += `\n(„Ç®„É©„ÉºÂÜÖÂÆπ [ÊúÄÂàù„ÅÆ5‰ª∂]: ` + errors.slice(0, 5).map(e => `${e.row}Ë°åÁõÆ: ${e.error}`).join('\n') + `)`;
                    } else {
                        message += `\n(„Ç®„É©„ÉºÂÜÖÂÆπ: ` + errors.map(e => `${e.row}Ë°åÁõÆ: ${e.error}`).join('\n') + `)`;
                    }
                }

                if (skipCount > 0) {
                    message += `\n\nÈáçË§áÁñë„ÅÑ„Åß„Çπ„Ç≠„ÉÉ„Éó„Åó„ÅüCSVË°å:\n` + skips.join(', ');
                }

                alert(message);

                if (suspectedDuplicates.length > 0) {
                    const tbody = $('#suspected-duplicates-tbody');
                    tbody.empty();
                    suspectedDuplicates.forEach((item, index) => {
                        const row = `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <input type="checkbox" class="duplicate-row-check rounded text-indigo-600" value="${index}">
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-gray-500 font-medium">${item.row}</td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-3 mb-2">
                                        ${(item.score === 4) ? `
                                            <div class="text-red-700 font-bold text-xs bg-red-100 px-2 py-0.5 rounded border border-red-200">„Çπ„Ç≠„ÉÉ„ÉóÊé®Â•®</div>
                                        ` : (item.score === 3) ? `
                                            <div class="text-red-600 font-bold text-xs bg-orange-100 px-2 py-0.5 rounded border border-orange-200">Ë¶ÅÁ¢∫Ë™ç</div>
                                        ` : `
                                            <div class="text-teal-600 font-bold text-xs bg-teal-100 px-2 py-0.5 rounded border border-teal-200">ÁôªÈå≤ÂØæË±°</div>
                                        `}
                                        <div class="text-[10px] text-gray-500 font-medium truncate">
                                            <i class="fas fa-database mr-1"></i>ÈáçË§áÂÄôË£ú: ${item.existingJob.company} / ${item.existingJob.title}
                                        </div>
                                    </div>
                                    ${renderJobComparisonTable(item.importData, item.existingJob)}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex flex-col gap-1.5">
                                        <label class="inline-flex items-center text-xs cursor-pointer">
                                            <input type="radio" name="duplicate-action-${index}" value="update" checked class="form-radio h-3 w-3 text-indigo-600">
                                            <span class="ml-1.5 font-medium text-gray-700">Êó¢Â≠ò„ÇíÊõ¥Êñ∞</span>
                                        </label>
                                        <label class="inline-flex items-center text-xs cursor-pointer">
                                            <input type="radio" name="duplicate-action-${index}" value="insert" class="form-radio h-3 w-3 text-indigo-600">
                                            <span class="ml-1.5 font-medium text-gray-700">Êñ∞Ë¶èÁôªÈå≤</span>
                                        </label>
                                    </div>
                                </td>
                            </tr>
                        `;
                        tbody.append(row);
                    });
                    $('#suspected-duplicates-modal').removeClass('hidden');
                }

                if (currentImportType === 'jobs') { if (typeof loadAdminJobs === 'function') loadAdminJobs(); }
                else if (currentImportType === 'companies') { if (typeof loadCompanies === 'function') loadCompanies(); }
                else if (currentImportType === 'users' || currentImportType === 'candidates') { if (typeof loadAdminUsers === 'function') loadAdminUsers(); }
                if (typeof loadCSVHistory === 'function') loadCSVHistory();

            } catch (err) {
                console.error('Import process error:', err);
                alert('„Ç§„É≥„Éù„Éº„ÉàÂá¶ÁêÜ‰∏≠„Å´Ëá¥ÂëΩÁöÑ„Å™„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + err.message);
            } finally {
                hideImportProgress();
            }

        };


        async function loadCSVHistory() {
            try {
                const orgSettings = (Array.isArray(currentUser.organizations) ? currentUser.organizations[0]?.settings : currentUser.organizations?.settings) || {};
                const driveImportEnabled = orgSettings.drive_import_enabled === true;
                $('#admin-drive-import-section').toggleClass('hidden', !driveImportEnabled);
                $('#admin-job-drive-import-btn').toggleClass('hidden', !driveImportEnabled);

                const { data: history, error } = await supabase
                    .from('csv_imports')
                    .select('*')
                    .eq('organization_id', currentUser.organization_id)
                    .order('created_at', { ascending: false })
                    .limit(10)

                if (error) throw error

                const container = $('#csv-history-container')
                container.empty()

                if (history.length === 0) {
                    container.html('<p class="text-gray-500 text-sm">Â±•Ê≠¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>')
                    return
                }

                const html = history.map(h => `
                    <div class="border-b py-3 last:border-0">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-medium text-sm">${h.file_name}</span>
                            <span class="text-xs text-gray-500">${new Date(h.created_at).toLocaleString('ja-JP')}</span>
                        </div>
                        <div class="text-xs flex gap-4">
                            <span class="text-green-600">ÊàêÂäü: ${h.success_rows}</span>
                            <span class="text-red-600">Â§±Êïó: ${h.failed_rows}</span>
                            <span class="text-gray-600">„Çø„Ç§„Éó: ${h.import_type}</span>
                        </div>
                    </div>
                `).join('')

                container.html(html)
            } catch (error) {
                console.error('Load CSV history error:', error)
            }
        }

        // ========================
        // Admin: Audit Logs
        // ========================
        async function logAction(action, entityType, entityId, details = {}) {
            if (!currentUser) return

            try {
                await supabase.from('audit_logs').insert({
                    organization_id: currentUser.organization_id,
                    user_id: currentUser.id,
                    action: action,
                    entity_type: entityType,
                    entity_id: entityId,
                    details: details,
                    user_agent: navigator.userAgent
                })
            } catch (error) {
                console.error('Log action error:', error)
            }
        }

        window.loadAuditLogs = async function () {
            if (!currentUser) return

            showLoading()
            try {
                let query = supabase
                    .from('audit_logs')
                    .select('*, users(name)')
                    .eq('organization_id', currentUser.organization_id)
                    .order('created_at', { ascending: false })
                    .limit(50)

                const filterAction = $('#log-filter-action').val()
                if (filterAction) {
                    query = query.eq('action', filterAction)
                }

                const { data: logs, error } = await query

                if (error) throw error

                const container = $('#audit-logs-container')
                container.empty()

                if (logs.length === 0) {
                    container.html('<p class="text-gray-500 text-center py-8">„É≠„Ç∞„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>')
                    return
                }

                const actionLabels = {
                    'create': { label: '‰ΩúÊàê', color: 'bg-green-100 text-green-800' },
                    'update': { label: 'Êõ¥Êñ∞', color: 'bg-blue-100 text-blue-800' },
                    'delete': { label: 'ÂâäÈô§', color: 'bg-red-100 text-red-800' },
                    'login': { label: '„É≠„Ç∞„Ç§„É≥', color: 'bg-gray-100 text-gray-800' },
                    'logout': { label: '„É≠„Ç∞„Ç¢„Ç¶„Éà', color: 'bg-gray-100 text-gray-800' },
                    'apply': { label: 'ÂøúÂãü', color: 'bg-indigo-100 text-indigo-800' },
                    'recommend': { label: 'AIÊé®Ëñ¶', color: 'bg-purple-100 text-purple-800' },
                    'bulk_recommend': { label: '‰∏ÄÊã¨AIÊé®Ëñ¶', color: 'bg-purple-100 text-purple-800' },
                    'csv_import': { label: 'CSV„Ç§„É≥„Éù„Éº„Éà', color: 'bg-yellow-100 text-yellow-800' }
                }

                const html = logs.map(log => {
                    const action = actionLabels[log.action] || { label: log.action, color: 'bg-gray-100 text-gray-800' }
                    const details = log.details ? JSON.stringify(log.details, null, 2) : 'Ë©≥Á¥∞„Å™„Åó';
                    const targetType = log.resource_type || log.target_type || log.entity_type || '‰∏çÊòé';

                    return `
                        <div class="bg-white border border-gray-200 rounded-lg p-4 mb-3 text-sm">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center gap-2">
                                    <span class="px-2 py-1 rounded text-xs font-medium ${action.color}">${action.label}</span>
                                    <span class="font-bold text-gray-900">${log.users?.name || '‰∏çÊòé„Å™„É¶„Éº„Ç∂„Éº'}</span>
                                    <span class="text-gray-500">„Åå ${targetType} „ÇíÊìç‰Ωú„Åó„Åæ„Åó„Åü</span>
                                </div>
                                <span class="text-xs text-gray-400">${new Date(log.created_at).toLocaleString('ja-JP')}</span>
                            </div>
                            <details class="mt-2">
                                <summary class="cursor-pointer text-xs text-indigo-600 hover:text-indigo-800">Ë©≥Á¥∞„ÇíË°®Á§∫</summary>
                                <pre class="mt-2 p-2 bg-gray-50 rounded text-xs overflow-x-auto">${details}</pre>
                            </details>
                        </div>
                    `
                }).join('')

                container.html(html)
            } catch (error) {
                console.error('Load audit logs error:', error)
                $('#audit-logs-container').html('<p class="text-red-500">„É≠„Ç∞„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>')
            } finally {
                hideLoading()
            }
        }



        // ========================
        // Admin: Prompt Settings
        // ========================
        // ========================
        // Multi-tenant: Organization Switching
        // ========================
        window.showOrgSelectModalForSwitch = async function () {
            if (!currentUser) return;
            showLoading('ÊâÄÂ±ûÁµÑÁπî„ÇíÂèñÂæó‰∏≠...');
            try {
                // user_id„Å†„Åë„Åß„Å™„Åè„ÄÅÂøµ„ÅÆ„Åü„ÇÅ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Åå‰∏ÄËá¥„Åô„ÇãÂÖ®ÊâÄÂ±û„ÇíÂèñÂæó
                // ‚Äª organization_members „Å´ email „Ç´„É©„É†„ÅØ„Å™„ÅÑ„Åü„ÇÅ„ÄÅusers„ÉÜ„Éº„Éñ„É´„ÇíÁµåÁî±„Åó„Å¶ÂèñÂæó
                const { data: memberships, error } = await supabase
                    .from('organization_members')
                    .select('organization_id, role, organizations(name, code), users!inner(email)')
                    .eq('users.email', currentUser.email);

                console.log('Switch Modal Debug: All memberships for email', currentUser.email, ':', memberships);

                if (error) {
                    console.error('Switch Modal Debug: Error fetching memberships:', error);
                    throw error;
                }

                if (!memberships || memberships.length === 0) {
                    console.warn('Switch Modal Debug: No memberships found for user', currentUser.id);
                }

                const modal = $('#org-select-modal');
                const list = $('#org-select-list');
                list.empty();

                memberships.forEach(m => {
                    const org = m.organizations;
                    const isCurrent = m.organization_id === currentUser.organization_id;
                    const btn = $(`
                        <button class="w-full text-left px-4 py-3 ${isCurrent ? 'bg-indigo-600 text-white' : 'bg-gray-50 text-gray-900 hover:bg-indigo-50'} border rounded-lg transition items-center flex justify-between group">
                            <div>
                                <div class="font-bold">${org.name} ${isCurrent ? '<span class="text-[10px] ml-2 font-normal">(ÁèæÂú®ÈÅ∏Êäû‰∏≠)</span>' : ''}</div>
                                <div class="text-xs ${isCurrent ? 'text-indigo-200' : 'text-gray-500'}">Role: ${m.role}</div>
                            </div>
                            <i class="fas fa-chevron-right ${isCurrent ? 'text-white' : 'text-gray-300'}"></i>
                        </button>
                    `);
                    btn.on('click', async (e) => {
                        e.preventDefault();
                        if (isCurrent) {
                            modal.addClass('hidden');
                            return;
                        }
                        await switchOrganization(m.organization_id, m.role, org.name);
                        modal.addClass('hidden');
                    });
                    list.append(btn);
                });

                hideLoading();
                modal.removeClass('hidden');
            } catch (error) {
                console.error('Fetch memberships error:', error);
                alert('ÁµÑÁπîÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                hideLoading();
            }
        };

        async function switchOrganization(orgId, role, orgName) {
            showLoading(`${orgName} „Å´Âàá„ÇäÊõø„Åà‰∏≠...`);
            try {
                // 1. „É¶„Éº„Ç∂„Éº„ÅÆÁèæÂú®„ÅÆ„Éá„Éï„Ç©„É´„ÉàÁµÑÁπî„ÇíÊõ¥Êñ∞
                await supabase.from('users').update({
                    organization_id: orgId,
                    role: role // Êó¢Â≠ò„É≠„Ç∏„ÉÉ„ÇØ‰∫íÊèõ„ÅÆ„Åü„ÇÅusers„ÅÆrole„ÇÇ‰∏ÄÂøúÊõ¥Êñ∞ÔºàRLS„ÅåÈÄö„ÇãÂ†¥Âêà„ÅÆ„ÅøÔºâ
                }).eq('id', currentUser.id);

                // 2. „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„ÇíÊõ¥Êñ∞
                currentUser.organization_id = orgId;
                currentUser.role = role;
                currentUser.organizations = { name: orgName };
                window.currentUser = currentUser;

                // 3. UI„ÅÆË°®Á§∫„ÇíÂàùÊúüÂåñ
                $('#user-role').text(getRoleLabel(role));
                $('#org-name').text(orgName);
                $('#org-code-display').text(''); // ÁµÑÁπî„Ç≥„Éº„Éâ„ÅØÂæå„ÅßÊõ¥Êñ∞„Åï„Çå„Çã

                // „É°„Éã„É•„Éº„ÅÆÂÜçÊßãÁØâÔºàÂΩπÂâ≤„Å´Âøú„Åò„Å¶Ë°®Á§∫/ÈùûË°®Á§∫Ôºâ
                loadedPages.clear(); // „Ç≠„É£„ÉÉ„Ç∑„É•„Çí„ÇØ„É™„Ç¢
                updateMenuVisibility(role);

                // 4. „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å∏Êàª„Çã
                await loadDashboard();
                showAppContent('dashboard-content');
                $('.nav-link').removeClass('bg-indigo-50 text-indigo-600');
                $('.nav-link[data-page="dashboard"]').addClass('bg-indigo-50 text-indigo-600');

                alert(`${orgName} „Å´Âàá„ÇäÊõø„Åà„Åæ„Åó„Åü`);
            } catch (error) {
                console.error('Switch organization error:', error);
                alert('Âàá„ÇäÊõø„Åà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            } finally {
                hideLoading();
            }
        }

        function updateMenuVisibility(role) {
            const adminRoles = ['org_admin', 'admin', 'super_admin'];
            const staffRoles = ['org_admin', 'admin', 'coach', 'ca', 'ra', 'super_admin'];

            if (adminRoles.includes(role)) $('#admin-menu').removeClass('hidden');
            else $('#admin-menu').addClass('hidden');

            if (role === 'super_admin') $('#super-admin-menu').removeClass('hidden');
            else $('#super-admin-menu').addClass('hidden');

            if (staffRoles.includes(role)) {
                $('#coach-menu').removeClass('hidden');
                $('#ai-scout-link').removeClass('hidden');
                $('#nav-candidate-search').removeClass('hidden');
            } else {
                $('#coach-menu').addClass('hidden');
                $('#ai-scout-link').addClass('hidden');
                $('#nav-candidate-search').addClass('hidden');
            }

            if (role === 'candidate') $('#nav-dashboard').addClass('hidden');
            else $('#nav-dashboard').removeClass('hidden');
        }

        // ========================
        // Super Admin: Organization Management
        // ========================
        let superAdminOrgsCache = [];

        async function loadSuperAdminOrganizations() {
            console.log('--- loadSuperAdminOrganizations START ---');
            if (!currentUser) {
                console.error('loadSuperAdminOrganizations: currentUser is missing');
                return;
            }
            console.log('Current user role:', currentUser.role);
            if (currentUser.role !== 'super_admin') {
                console.warn('loadSuperAdminOrganizations: User is not super_admin');
                return;
            }

            showLoading();
            try {
                console.log('Fetching organizations from Supabase...');
                const { data: orgs, error } = await supabase
                    .from('organizations')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Supabase fetch error:', error);
                    throw error;
                }

                console.log('Orgs fetched:', orgs ? orgs.length : 0);
                superAdminOrgsCache = orgs || [];
                renderSuperAdminOrganizations(superAdminOrgsCache);
            } catch (error) {
                console.error('Load organizations error:', error);
                const $errContainer = $('#super-admin-organizations-container');
                if ($errContainer.length) {
                    $errContainer.html('<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message + '</td></tr>');
                } else {
                    console.error('Error container NOT FOUND');
                }
            } finally {
                hideLoading();
                console.log('--- loadSuperAdminOrganizations END ---');
            }
        }

        function renderSuperAdminOrganizations(orgs) {
            console.log('renderSuperAdminOrganizations called with', orgs.length, 'orgs');
            const container = $('#super-admin-organizations-container');
            console.log('Container found:', container.length);

            if (container.length === 0) {
                console.error('CRITICAL: #super-admin-organizations-container NOT FOUND IN DOM');
                return;
            }

            container.empty();

            if (orgs.length === 0) {
                console.log('No orgs to display.');
                container.html('<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">ÁµÑÁπî„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</td></tr>');
                return;
            }

            const html = orgs.map(org => {
                const statusColors = {
                    'active': 'bg-green-100 text-green-800',
                    'suspended': 'bg-red-100 text-red-800',
                    'cancelled': 'bg-gray-100 text-gray-800'
                };
                const statusLabel = {
                    'active': 'ÊúâÂäπ',
                    'suspended': 'ÂÅúÊ≠¢‰∏≠',
                    'cancelled': 'Ëß£Á¥ÑÊ∏à'
                };
                const planLabel = {
                    'free': 'Free',
                    'standard': 'Standard',
                    'premium': 'Premium'
                };

                return `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${org.name}</div>
                        <div class="text-xs text-gray-500">ID: ${org.id}</div>
                        <div class="text-xs text-indigo-600 font-mono mt-1">Code: ${org.code || '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                            ${planLabel[org.plan_type] || org.plan_type || 'Free'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColors[org.status] || 'bg-gray-100 text-gray-800'}">
                            ${statusLabel[org.status] || org.status || 'Active'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${org.max_users || 5}Âêç
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${org.valid_until ? new Date(org.valid_until).toLocaleDateString('ja-JP') : '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="showOrganizationModal('${org.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">
                            <i class="fas fa-edit"></i> Á∑®ÈõÜ
                        </button>
                        <button onclick="generateInvitationForOrg('${org.id}')" class="text-green-600 hover:text-green-900">
                            <i class="fas fa-user-plus"></i> ÊãõÂæÖURLÁô∫Ë°å
                        </button>
                    </td>
                </tr>
                `;
            }).join('');

            container.html(html);
        }

        // „É°„Éº„É´ÈÄöÁü•Èô§Â§ñÁî®„Çπ„ÉÜ„Éº„Çø„Çπ„É™„Çπ„Éà„ÅÆÁîüÊàê
        window.populateEmailStatusList = async function (excludedStatuses = []) {
            const $list = $('#email-status-exclude-list');
            try {
                // master_data„Åã„Çâ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂèñÂæó
                const { data: masters, error } = await supabase
                    .from('master_data')
                    .select('label, value')
                    .eq('type', 'application_status')
                    .eq('is_active', true)
                    .order('sort_order', { ascending: true });

                if (error) throw error;

                if (!masters || masters.length === 0) {
                    $list.html('<div class="text-xs text-gray-400 py-2 text-center col-span-2">„Çπ„ÉÜ„Éº„Çø„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</div>');
                    return;
                }

                const html = masters.map(m => `
                    <label class="flex items-center p-1.5 hover:bg-gray-50 rounded transition-colors cursor-pointer border border-transparent hover:border-indigo-100">
                        <input type="checkbox" class="email-status-exclude-checkbox form-checkbox h-3 w-3 text-red-500 rounded border-gray-300" 
                            value="${m.value}" ${excludedStatuses.includes(m.value) ? 'checked' : ''}>
                        <span class="ml-2 text-[11px] text-gray-600 truncate">${m.label}</span>
                    </label>
                `).join('');
                $list.html(html);
            } catch (e) {
                console.error('Failed to populate email status list:', e);
                $list.html('<div class="text-xs text-red-400 py-2 text-center col-span-2">Ë™≠„ÅøËæº„ÅøÂ§±Êïó</div>');
            }
        }

        // ÁÆ°ÁêÜÁîªÈù¢Áî®Ôºö„É°„Éº„É´ÈÄöÁü•Èô§Â§ñÁî®„Çπ„ÉÜ„Éº„Çø„Çπ„É™„Çπ„Éà„ÅÆÁîüÊàê
        window.populateAdminEmailStatusList = async function (excludedStatuses = []) {
            const $list = $('#admin-email-status-exclude-list');
            try {
                const { data: masters, error } = await supabase
                    .from('master_data')
                    .select('label, value')
                    .eq('type', 'application_status')
                    .eq('is_active', true)
                    .order('sort_order', { ascending: true });

                if (error) throw error;

                if (!masters || masters.length === 0) {
                    $list.html('<div class="text-xs text-gray-400 py-2 text-center col-span-full">„Çπ„ÉÜ„Éº„Çø„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</div>');
                    return;
                }

                const html = masters.map(m => `
                    <label class="flex items-center p-2 hover:bg-indigo-50 rounded transition-colors cursor-pointer border border-gray-100 hover:border-indigo-200 bg-white">
                        <input type="checkbox" class="admin-email-status-exclude-checkbox form-checkbox h-3.5 w-3.5 text-red-500 rounded border-gray-300" 
                            value="${m.value}" ${excludedStatuses.includes(m.value) ? 'checked' : ''}>
                        <span class="ml-2 text-xs text-gray-700 truncate font-medium">${m.label}</span>
                    </label>
                `).join('');
                $list.html(html);
            } catch (e) {
                console.error('Failed to populate admin email status list:', e);
                $list.html('<div class="text-xs text-red-400 py-2 text-center col-span-full">Ë™≠„ÅøËæº„ÅøÂ§±Êïó</div>');
            }
        }

        window.showOrganizationModal = function (orgId = null) {
            console.log('showOrganizationModal called with ID:', orgId);
            try {
                const form = $('#organization-form')[0];
                if (!form) {
                    console.error('Organization form not found');
                    return;
                }
                form.reset();
                $('#org-id').val('');

                if (orgId) {
                    const org = superAdminOrgsCache.find(o => o.id === orgId);
                    if (org) {
                        $('#org-modal-title').text('ÁµÑÁπîÁ∑®ÈõÜ');
                        $('#org-id').val(org.id);
                        $('#org-name-input').val(org.name);
                        $('#org-plan').val(org.plan_type || 'free');
                        $('#org-status').val(org.status || 'active');
                        $('#org-max-users').val(org.max_users || 5);
                        if (org.valid_until) {
                            $('#org-valid-until').val(new Date(org.valid_until).toISOString().split('T')[0]);
                        }
                        // Á∑®ÈõÜÊôÇ„ÅØÂàùÊúüÁÆ°ÁêÜËÄÖÂÖ•ÂäõÊ¨Ñ„ÇíÈö†„Åô
                        $('#org-initial-admin-fields').addClass('hidden');
                        $('#org-admin-name').removeAttr('required');
                        $('#org-admin-email').removeAttr('required');

                        // Ë®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø
                        const settings = org.settings || {};
                        $('#org-setting-email-required').prop('checked', settings.candidate_email_required !== false); // „Éá„Éï„Ç©„É´„Éàtrue
                        $('#org-setting-password-required').prop('checked', settings.candidate_password_required !== false); // „Éá„Éï„Ç©„É´„Éàtrue
                        $('#org-setting-limit-agent-view').prop('checked', settings.limit_agent_view === true); // „Éá„Éï„Ç©„É´„Éàfalse

                        // Google Drive Ë®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø
                        const driveEnabled = settings.drive_transfer_enabled === true;
                        $('#org-setting-drive-transfer-enabled').prop('checked', driveEnabled);
                        $('#org-setting-drive-gas-url').val(settings.drive_gas_url || '');
                        $('#org-setting-drive-column').val(settings.drive_column || 'pdf_url');
                        $('#drive-transfer-settings-container').toggleClass('hidden', !driveEnabled);

                        // Google Drive „Ç§„É≥„Éù„Éº„ÉàË®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø
                        const driveImportEnabled = settings.drive_import_enabled === true;
                        $('#org-setting-drive-import-enabled').prop('checked', driveImportEnabled);
                        $('#org-setting-drive-import-gas-url').val(settings.drive_import_gas_url || '');
                        $('#org-setting-drive-import-column').val(settings.drive_import_column || 'pdf_url');
                        $('#drive-import-settings-container').toggleClass('hidden', !driveImportEnabled);

                        // Ê±Ç‰∫∫ÈáçË§á‰∏ÄÊã¨Á¢∫Ë™çË®≠ÂÆö
                        $('#org-setting-bulk-duplicate-confirm').prop('checked', settings.bulk_duplicate_confirm_enabled === true);

                        // Ê±ÇËÅ∑ËÄÖ„Å∏„ÅÆ„É°„Éº„É´ÈÄöÁü•Ë®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø
                        const emailSettings = settings.email_notification_settings || { candidate_notifications: {} };
                        const candNotifs = emailSettings.candidate_notifications || {};

                        $('#org-setting-email-all-off').prop('checked', candNotifs.all_off === true).trigger('change');
                        $('#org-setting-email-application').prop('checked', candNotifs.application_submitted !== false);
                        $('#org-setting-email-scout').prop('checked', candNotifs.scout !== false);
                        $('#org-setting-email-recommendation').prop('checked', candNotifs.recommendation !== false);
                        $('#org-setting-email-status-enabled').prop('checked', candNotifs.status_changed_enabled !== false).trigger('change');

                        populateEmailStatusList(candNotifs.status_changed_excluded_statuses || []);

                        // „É≠„Éº„É´ÂêçÁß∞„ÅÆË™≠„ÅøËæº„Åø
                        const roleLabels = settings.role_labels || {};
                        $('#org-role-label-org_admin').val(roleLabels.org_admin || '');
                        $('#org-role-label-admin').val(roleLabels.admin || '');
                        $('#org-role-label-coach').val(roleLabels.coach || '');
                        $('#org-role-label-candidate').val(roleLabels.candidate || '');
                    } else {
                        console.warn(`Organization with ID ${orgId} not found in cache.`);
                    }
                } else {
                    $('#org-modal-title').text('Êñ∞Ë¶èÁµÑÁπî‰ΩúÊàê');
                    $('#org-plan').val('free');
                    $('#org-status').val('active');
                    $('#org-max-users').val(5);
                    // Êñ∞Ë¶èÊôÇ„ÅØÂàùÊúüÁÆ°ÁêÜËÄÖÂÖ•ÂäõÊ¨Ñ„ÇíË°®Á§∫
                    $('#org-initial-admin-fields').removeClass('hidden');
                    $('#org-admin-name').attr('required', 'required');
                    $('#org-admin-email').attr('required', 'required');

                    // „Éá„Éï„Ç©„É´„ÉàË®≠ÂÆö
                    $('#org-setting-email-required').prop('checked', true);
                    $('#org-setting-password-required').prop('checked', true);

                    // „É°„Éº„É´ÈÄöÁü•Ë®≠ÂÆö„ÅÆ„Éá„Éï„Ç©„É´„Éà
                    $('#org-setting-email-all-off').prop('checked', false).trigger('change');
                    $('#org-setting-email-application').prop('checked', true);
                    $('#org-setting-email-scout').prop('checked', true);
                    $('#org-setting-email-recommendation').prop('checked', true);
                    $('#org-setting-email-status-enabled').prop('checked', true).trigger('change');
                    populateEmailStatusList([]);
                }

                console.log('Toggling modal visibility...');
                const $modal = $('#organization-modal');
                console.log('Modal found:', $modal.length);
                if ($modal.length > 0) {
                    $modal.removeClass('hidden').css('z-index', '1000000');
                    console.log('Modal hidden class removed. Current display:', $modal.css('display'));
                } else {
                    console.error('CRITICAL: #organization-modal NOT FOUND IN DOM');
                }
            } catch (error) {
                console.error('Error in showOrganizationModal:', error);
                alert('„É¢„Éº„ÉÄ„É´„ÅÆË°®Á§∫‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }

        window.closeOrganizationModal = function () {
            $('#organization-modal').addClass('hidden');
        }

        // ÁµÑÁπî‰øùÂ≠òÂá¶ÁêÜ
        $('#organization-form').on('submit', async function (e) {
            e.preventDefault();
            if (!currentUser || currentUser.role !== 'super_admin') return;

            const orgId = $('#org-id').val();
            const orgData = {
                name: $('#org-name-input').val().trim(),
                plan_type: $('#org-plan').val(),
                status: $('#org-status').val(),
                max_users: parseInt($('#org-max-users').val()),
                valid_until: $('#org-valid-until').val() ? new Date($('#org-valid-until').val()).toISOString() : null,
                updated_at: new Date().toISOString()
            };

            // slug„ÅÆÊâ±„ÅÑ
            if (!orgId) {
                orgData.slug = 'org-' + Date.now().toString(36) + '-' + Math.random().toString(36).substring(2, 7);
                // „Ç≥„Éº„ÉâÁîüÊàê (8Ê°Å„ÅÆ„É©„É≥„ÉÄ„É†„Å™Ëã±Êï∞Â≠ó)
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let code = '';
                for (let i = 0; i < 8; i++) {
                    code += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                orgData.code = code;
            }

            // ÁèæÂú®„ÅÆË®≠ÂÆö„ÇíÂèñÂæó„Åó„Å¶„Éû„Éº„Ç∏
            let currentSettings = {};
            if (orgId && typeof superAdminOrgsCache !== 'undefined') {
                const existingOrg = superAdminOrgsCache.find(o => o.id === orgId);
                if (existingOrg && existingOrg.settings) {
                    currentSettings = existingOrg.settings;
                }
            }

            orgData.settings = {
                ...currentSettings,
                candidate_email_required: $('#org-setting-email-required').is(':checked'),
                candidate_password_required: $('#org-setting-password-required').is(':checked'),
                limit_agent_view: $('#org-setting-limit-agent-view').is(':checked'),
                drive_transfer_enabled: $('#org-setting-drive-transfer-enabled').is(':checked'),
                drive_gas_url: $('#org-setting-drive-gas-url').val().trim() || null,
                drive_column: $('#org-setting-drive-column').val().trim() || 'pdf_url',
                drive_import_enabled: $('#org-setting-drive-import-enabled').is(':checked'),
                drive_import_gas_url: $('#org-setting-drive-import-gas-url').val().trim() || null,
                drive_import_column: $('#org-setting-drive-import-column').val().trim() || 'pdf_url',
                bulk_duplicate_confirm_enabled: $('#org-setting-bulk-duplicate-confirm').is(':checked'),
                email_notification_settings: {
                    candidate_notifications: {
                        all_off: $('#org-setting-email-all-off').is(':checked'),
                        application_submitted: $('#org-setting-email-application').is(':checked'),
                        scout: $('#org-setting-email-scout').is(':checked'),
                        recommendation: $('#org-setting-email-recommendation').is(':checked'),
                        status_changed_enabled: $('#org-setting-email-status-enabled').is(':checked'),
                        status_changed_excluded_statuses: $('.email-status-exclude-checkbox:checked').map(function () { return $(this).val(); }).get()
                    }
                },
                role_labels: {
                    org_admin: $('#org-role-label-org_admin').val().trim() || null,
                    admin: $('#org-role-label-admin').val().trim() || null,
                    coach: $('#org-role-label-coach').val().trim() || null,
                    candidate: $('#org-role-label-candidate').val().trim() || null
                }
            };

            // ÂàùÊúüÁÆ°ÁêÜËÄÖÊÉÖÂ†±ÔºàÊñ∞Ë¶è‰ΩúÊàêÊôÇ„ÅÆ„ÅøÔºâ
            const adminName = $('#org-admin-name').val().trim();
            const adminEmail = $('#org-admin-email').val().trim();

            showLoading();
            try {
                if (orgId) {
                    // Êõ¥Êñ∞ (Direct DB Update)
                    const { error } = await supabase
                        .from('organizations')
                        .update(orgData)
                        .eq('id', orgId);

                    if (error) throw error;

                    alert('‰øùÂ≠ò„Åó„Åæ„Åó„Åü');

                    // „Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÊõ¥Êñ∞
                    if (typeof superAdminOrgsCache !== 'undefined') {
                        const idx = superAdminOrgsCache.findIndex(o => o.id === orgId);
                        if (idx !== -1) {
                            superAdminOrgsCache[idx] = { ...superAdminOrgsCache[idx], ...orgData };
                        }
                    }

                    // ÁèæÂú®„ÅÆÁµÑÁπîÊÉÖÂ†±„ÇíÊõ¥Êñ∞
                    if (currentUser && currentUser.organization_id === orgId) {
                        currentUser.organizations = { ...currentUser.organizations, ...orgData };
                    }

                } else {
                    // Êñ∞Ë¶è‰ΩúÊàê (Direct DB Insert)
                    const { data: newOrgData, error: createError } = await supabase
                        .from('organizations')
                        .insert(orgData)
                        .select()
                        .single();

                    if (createError) throw createError;

                    const newOrg = newOrgData;

                    // ÊãõÂæÖÁä∂„ÅÆ‰ΩúÊàê
                    const token = crypto.randomUUID();
                    const expiresAt = new Date();
                    expiresAt.setDate(expiresAt.getDate() + 7); // 7Êó•ÈñìÊúâÂäπ

                    const { error: inviteError } = await supabase
                        .from('invitations')
                        .insert({
                            organization_id: newOrg.id,
                            email: adminEmail,
                            role: 'org_admin',
                            token: token,
                            expires_at: expiresAt.toISOString()
                        });

                    if (inviteError) {
                        console.error('Invitation error:', inviteError);
                        alert('ÁµÑÁπî„ÅØ‰ΩúÊàê„Åï„Çå„Åæ„Åó„Åü„Åå„ÄÅÊãõÂæÖÁä∂„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + inviteError.message);
                    } else {
                        const inviteUrl = `https://rightjob2025.github.io/matching/index-supabase.html?token=${token}`;

                        // „É°„Éº„É´ÈÄÅ‰ø° (Client Side Mock/Impl)
                        await sendEmail('invitation', adminEmail, {
                            organizationName: newOrg.name,
                            invitationUrl: inviteUrl
                        });

                        // „É¢„Éº„ÉÄ„É´„ÅßÊãõÂæÖURL„ÇíË°®Á§∫
                        showInvitationUrlModal(newOrg.name, adminEmail, inviteUrl);
                    }
                }

                if (!($('#invitation-url-modal').hasClass('hidden') === false)) {
                    // ÊãõÂæÖURL„É¢„Éº„ÉÄ„É´„ÅåÂá∫„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÈñâ„Åò„Çã
                    closeOrganizationModal();
                }

                loadSuperAdminOrganizations();

            } catch (error) {
                console.error('Save organization error:', error);
                alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            } finally {
                hideLoading();
            }
        });

        // ÊãõÂæÖURL„É¢„Éº„ÉÄ„É´Èñ¢ÈÄ£„ÅÆÈñ¢Êï∞
        function showInvitationUrlModal(orgName, email, url) {
            $('#invite-org-name').text(orgName);
            $('#invite-admin-email').text(email);
            $('#invitation-url-display').val(url);
            $('#invitation-url-modal').removeClass('hidden');
        }

        window.closeInvitationUrlModal = function () {
            $('#invitation-url-modal').addClass('hidden');
        }

        window.copyInvitationUrl = function () {
            const urlInput = document.getElementById('invitation-url-display');
            urlInput.select();
            urlInput.setSelectionRange(0, 99999); // „É¢„Éê„Ç§„É´ÂØæÂøú

            navigator.clipboard.writeText(urlInput.value).then(() => {
                alert('URL„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            });
        }

        window.sendInvitationEmail = async function () {
            const email = $('#invite-admin-email').text();
            const url = $('#invitation-url-display').val();
            const orgName = $('#invite-org-name').text();

            if (!confirm('ÊãõÂæÖ„É°„Éº„É´„ÇíÂÜçÈÄÅ‰ø°„Åó„Åæ„Åô„ÅãÔºü')) return;

            showLoading();
            try {
                const success = await sendEmail('invitation', email, {
                    organizationName: orgName,
                    invitationUrl: url
                });

                if (success) {
                    alert('ÊãõÂæÖ„É°„Éº„É´„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü');
                } else {
                    alert('„É°„Éº„É´ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                console.error('Resend invitation error:', error);
                alert('ÈÄÅ‰ø°„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            } finally {
                hideLoading();
            }
        }

        // Êó¢Â≠òÁµÑÁπî„Å∏„ÅÆÊãõÂæÖURLÁô∫Ë°å
        window.generateInvitationForOrg = async function (orgId) {
            const org = superAdminOrgsCache.find(o => o.id === orgId);
            if (!org) {
                alert('ÁµÑÁπîÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }

            const adminName = prompt('ÁÆ°ÁêÜËÄÖ„ÅÆÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
            if (!adminName || !adminName.trim()) return;

            const adminEmail = prompt('ÁÆ°ÁêÜËÄÖ„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
            if (!adminEmail || !adminEmail.trim()) return;

            // „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅÆÁ∞°Êòì„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
            if (!adminEmail.includes('@')) {
                alert('ÊúâÂäπ„Å™„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            showLoading();
            try {
                // Êó¢Â≠ò„ÅÆÊãõÂæÖ„ÇíÂâäÈô§ÔºàÂêå„ÅòÁµÑÁπî„Å®„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅÆÁµÑ„ÅøÂêà„Çè„ÅõÔºâ
                await supabase
                    .from('invitations')
                    .delete()
                    .eq('organization_id', orgId)
                    .eq('email', adminEmail.trim());

                const token = crypto.randomUUID();
                const expiresAt = new Date();
                expiresAt.setDate(expiresAt.getDate() + 7); // 7Êó•ÈñìÊúâÂäπ

                const { error: inviteError } = await supabase
                    .from('invitations')
                    .insert({
                        organization_id: orgId,
                        email: adminEmail.trim(),
                        role: 'org_admin',
                        token: token,
                        expires_at: expiresAt.toISOString()
                    });

                if (inviteError) throw inviteError;

                const inviteUrl = `https://rightjob2025.github.io/matching/index-supabase.html?token=${token}`;

                // „É°„Éº„É´ÈÄÅ‰ø°
                await sendEmail('invitation', adminEmail.trim(), {
                    organizationName: org.name,
                    invitationUrl: inviteUrl
                });

                showInvitationUrlModal(org.name, adminEmail.trim(), inviteUrl);

            } catch (error) {
                console.error('Invitation creation failed:', error);
                alert('ÊãõÂæÖURL„ÅÆÁô∫Ë°å„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            } finally {
                hideLoading();
            }
        }



        window.showPromptForm = function () {
            $('#prompt-modal-title').text('„Éó„É≠„É≥„Éó„Éà‰ΩúÊàê')
            $('#prompt-form')[0].reset()
            $('#prompt-id').val('')
            $('#prompt-is-active').prop('checked', true)

            // Global option is only for super_admin
            if (currentUser.role === 'super_admin') {
                $('#prompt-is-global').parent().show()
                $('#prompt-is-global').prop('checked', false)
            } else {
                $('#prompt-is-global').parent().hide()
                $('#prompt-is-global').prop('checked', false)
            }

            // Enable inputs
            $('#prompt-name').prop('disabled', false)
            $('#prompt-template').prop('disabled', false)
            $('#prompt-is-active').prop('disabled', false)
            $('#prompt-is-global').prop('disabled', false)
            $('#prompt-submit-btn').show()

            $('#prompt-modal').removeClass('hidden')
        }

        window.editPrompt = function (prompt) {
            $('#prompt-modal-title').text('„Éó„É≠„É≥„Éó„ÉàÁ∑®ÈõÜ')
            $('#prompt-id').val(prompt.id)
            $('#prompt-name').val(prompt.name)
            $('#prompt-template').val(prompt.prompt_template)
            $('#prompt-is-active').prop('checked', prompt.is_active)
            $('#prompt-is-global').prop('checked', prompt.is_global)

            // Global option visibility
            if (currentUser.role === 'super_admin') {
                $('#prompt-is-global').parent().show()
            } else {
                $('#prompt-is-global').parent().hide()
            }

            // Enable inputs
            $('#prompt-name').prop('disabled', false)
            $('#prompt-template').prop('disabled', false)
            $('#prompt-is-active').prop('disabled', false)
            $('#prompt-is-global').prop('disabled', false)
            $('#prompt-submit-btn').show()

            $('#prompt-modal').removeClass('hidden')
        }

        window.viewPrompt = function (prompt) {
            $('#prompt-modal-title').text('„Éó„É≠„É≥„Éó„ÉàÈñ≤Ë¶ß')
            $('#prompt-id').val(prompt.id)
            $('#prompt-name').val(prompt.name)
            $('#prompt-template').val(prompt.prompt_template)
            $('#prompt-is-active').prop('checked', prompt.is_active)
            $('#prompt-is-global').prop('checked', prompt.is_global)

            // Global option visibility
            if (currentUser.role === 'super_admin') {
                $('#prompt-is-global').parent().show()
            } else {
                $('#prompt-is-global').parent().hide()
            }

            // Disable inputs
            $('#prompt-name').prop('disabled', true)
            $('#prompt-template').prop('disabled', true)
            $('#prompt-is-active').prop('disabled', true)
            $('#prompt-is-global').prop('disabled', true)
            $('#prompt-submit-btn').hide()

            $('#prompt-modal').removeClass('hidden')
        }

        window.closePromptModal = function () {
            $('#prompt-modal').addClass('hidden')
            $('#prompt-form')[0].reset()
        }

        $('#prompt-form').on('submit', async function (e) {
            e.preventDefault()
            showLoading()

            const promptId = $('#prompt-id').val()
            const isGlobal = $('#prompt-is-global').is(':checked')

            // If not super admin, force is_global to false and set organization_id
            let orgId = null
            if (currentUser.role === 'super_admin') {
                orgId = isGlobal ? null : currentUser.organization_id // Or maybe super admin can create for specific org? For now, if not global, assign to their org (which might be null or a system org)
                // Actually, if super admin creates a non-global prompt, it should probably be global or assigned to a specific org. 
                // For simplicity, super admin creates global prompts by default or "system" prompts.
                // If isGlobal is false, let's set it to null (global) or current org.
                // Let's stick to: isGlobal -> orgId = null. !isGlobal -> orgId = currentUser.organization_id
            } else {
                orgId = currentUser.organization_id
            }

            const promptData = {
                name: $('#prompt-name').val(),
                prompt_template: $('#prompt-template').val(),
                is_active: $('#prompt-is-active').is(':checked'),
                is_global: isGlobal,
                organization_id: orgId,
                updated_at: new Date().toISOString()
            }

            if (!promptId) {
                promptData.created_by = currentUser.id
            }

            try {
                if (promptId) {
                    const { error } = await supabase
                        .from('ai_prompts')
                        .update(promptData)
                        .eq('id', promptId)
                    if (error) throw error
                    alert('„Éó„É≠„É≥„Éó„Éà„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü')
                } else {
                    const { error } = await supabase
                        .from('ai_prompts')
                        .insert(promptData)
                    if (error) throw error
                    alert('„Éó„É≠„É≥„Éó„Éà„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü')
                }

                closePromptModal()
                loadPrompts()
            } catch (error) {
                console.error('Save prompt error:', error)
                alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message)
            } finally {
                hideLoading()
            }
        })

        // ========================
        // Admin: Master Data
        // ========================
        window.switchMasterTab = function (type) {
            $('#master-filter-type').val(type);

            // Update tab styles
            $('.master-tab').each(function () {
                const onclick = $(this).attr('onclick');
                if (onclick.includes(`'${type}'`)) {
                    $(this).removeClass('border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300')
                        .addClass('border-indigo-500 text-indigo-600');
                } else {
                    $(this).removeClass('border-indigo-500 text-indigo-600')
                        .addClass('border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300');
                }
            });

            loadMasterData();
        }

        window.updateMasterSortOrder = async function (id, direction) {
            if (!currentUser) return;

            try {
                // Get current item
                const { data: currentItem, error: fetchError } = await supabase
                    .from('master_data')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (fetchError) throw fetchError;

                // Find adjacent item
                let query = supabase
                    .from('master_data')
                    .select('*')
                    .eq('type', currentItem.type);

                if (currentItem.organization_id) {
                    query = query.eq('organization_id', currentItem.organization_id);
                } else {
                    query = query.is('organization_id', null);
                }

                if (direction === 'up') {
                    // Find item with smaller sort_order (closest)
                    query = query.lt('sort_order', currentItem.sort_order).order('sort_order', { ascending: false }).limit(1);
                } else {
                    // Find item with larger sort_order (closest)
                    query = query.gt('sort_order', currentItem.sort_order).order('sort_order', { ascending: true }).limit(1);
                }

                const { data: adjacentItems, error: adjError } = await query;

                if (adjError) throw adjError;

                if (adjacentItems.length === 0) return; // No item to swap with

                const adjacentItem = adjacentItems[0];

                // Swap sort_order
                const { error: update1 } = await supabase
                    .from('master_data')
                    .update({ sort_order: adjacentItem.sort_order })
                    .eq('id', currentItem.id);

                if (update1) throw update1;

                const { error: update2 } = await supabase
                    .from('master_data')
                    .update({ sort_order: currentItem.sort_order })
                    .eq('id', adjacentItem.id);

                if (update2) throw update2;

                loadMasterData();

            } catch (error) {
                console.error('Sort update error:', error);
                alert('‰∏¶„Å≥È†Ü„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }
        async function loadMasterOrganizations() {
            try {
                const { data: orgs, error } = await supabase
                    .from('organizations')
                    .select('id, name')
                    .order('name');

                if (error) throw error;

                const select = $('#master-filter-org');
                const currentVal = select.val();
                select.html('<option value="">ÂÖ®„Å¶„ÅÆÁµÑÁπî„ÇíË°®Á§∫</option>');

                if (orgs) {
                    orgs.forEach(org => {
                        select.append(`<option value="${org.id}">${org.name}</option>`);
                    });
                }
                if (currentVal) select.val(currentVal);
            } catch (e) {
                console.error('Failed to load organizations for filter:', e);
            }
        }

        window.loadMasterData = async function () {
            // Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØ
            if (!currentUser || !['super_admin', 'org_admin', 'admin'].includes(currentUser.role)) {
                alert('Ê®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                showPage('dashboard');
                return;
            }

            // „Çπ„Éº„Éë„ÉºÁÆ°ÁêÜËÄÖ„ÅÆÂ†¥Âêà„ÄÅÁµÑÁπî„É™„Çπ„Éà„ÇíË°®Á§∫„Éª„É≠„Éº„Éâ
            if (currentUser.role === 'super_admin') {
                $('#master-org-filter-container').removeClass('hidden');
                // Êó¢„Å´„É≠„Éº„ÉâÊ∏à„Åø„Åß„Å™„Åë„Çå„Å∞„É≠„Éº„Éâ (option„Åå1„Å§‰ª•‰∏ã„Å™„Çâ)
                if ($('#master-filter-org option').length <= 1) {
                    await loadMasterOrganizations();
                }
            } else {
                $('#master-org-filter-container').addClass('hidden');
            }

            showLoading()
            try {
                let query = supabase
                    .from('master_data')
                    .select('*, organizations(name)')
                    .order('type', { ascending: true })
                    .order('sort_order', { ascending: true })

                const filterType = $('#master-filter-type').val()
                if (filterType) {
                    query = query.eq('type', filterType)
                }

                // ÁµÑÁπî„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
                if (currentUser.role === 'super_admin') {
                    const orgFilter = $('#master-filter-org').val();
                    if (orgFilter) {
                        query = query.eq('organization_id', orgFilter);
                    }
                } else {
                    // ‰∏ÄËà¨ÁÆ°ÁêÜËÄÖ: Ëá™ÁµÑÁπî „Åæ„Åü„ÅØ „Ç∞„É≠„Éº„Éê„É´
                    query = query.or(`organization_id.eq.${currentUser.organization_id},organization_id.is.null`);
                }

                const { data: masters, error } = await query

                if (error) throw error

                const container = $('#master-data-container')
                container.empty()

                if (masters.length === 0) {
                    container.html('<p class="text-gray-500 text-center py-8">„Éû„Çπ„Çø„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>')
                    return
                }

                const typeLabels = {
                    'employment_type': 'ÈõáÁî®ÂΩ¢ÊÖã',
                    'job_category': 'ËÅ∑Á®Æ„Ç´„ÉÜ„Ç¥„É™',
                    'industry_category': 'Ê•≠Á®Æ„Ç´„ÉÜ„Ç¥„É™',
                    'selection_status': 'ÈÄ≤Êçó„Çπ„ÉÜ„Éº„Çø„Çπ'
                }

                const html = masters.map(m => {
                    const isGlobal = m.organization_id === null
                    const isMyOrg = m.organization_id === currentUser.organization_id
                    // „Çπ„Éº„Éë„ÉºÁÆ°ÁêÜËÄÖ„ÅØÂÖ®„Å¶Á∑®ÈõÜÂèØËÉΩ„ÄÇÁµÑÁπîÁÆ°ÁêÜËÄÖ„ÅØËá™ÁµÑÁπî„ÅÆ„ÇÇ„ÅÆ„ÅÆ„ÅøÁ∑®ÈõÜÂèØËÉΩ„ÄÇ
                    const canEdit = currentUser.role === 'super_admin' || (isMyOrg && ['org_admin', 'admin'].includes(currentUser.role))

                    let badge = ''
                    let orgName = ''

                    if (isGlobal) {
                        badge = '<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">„Ç∞„É≠„Éº„Éê„É´</span>'
                    } else {
                        orgName = m.organizations ? m.organizations.name : 'Unknown Org';
                        if (isMyOrg) {
                            badge = `<span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded">Ëá™Á§æÁî®</span>`
                        } else {
                            badge = `<span class="px-2 py-1 bg-gray-100 text-gray-800 text-xs rounded">${orgName}</span>`
                        }
                    }

                    return `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 mb-3 flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            ${canEdit ? `
                            <div class="flex flex-col gap-1">
                                <button onclick="updateMasterSortOrder('${m.id}', 'up')" class="text-gray-400 hover:text-indigo-600 p-1 hover:bg-gray-100 rounded transition">
                                    <i class="fas fa-chevron-up text-xs"></i>
                                </button>
                                <button onclick="updateMasterSortOrder('${m.id}', 'down')" class="text-gray-400 hover:text-indigo-600 p-1 hover:bg-gray-100 rounded transition">
                                    <i class="fas fa-chevron-down text-xs"></i>
                                </button>
                            </div>
                            ` : ''}
                            <div>
                                <div class="flex items-center gap-3 mb-1">
                                    <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded">${typeLabels[m.type] || m.type}</span>
                                    <span class="font-bold text-gray-900">${m.label}</span>
                                    <span class="text-sm text-gray-500">(${m.value})</span>
                                    ${!m.is_active ? '<span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded">ÁÑ°Âäπ</span>' : ''}
                                    ${badge}
                                </div>
                                <div class="flex gap-2 text-xs text-gray-400">
                                    <span>Ë°®Á§∫È†Ü: ${m.sort_order}</span>
                                    ${m.organization_id ? `<span>ÁµÑÁπî: ${orgName}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            ${canEdit ? `
                            <button onclick='editMaster(${JSON.stringify(m).replace(/'/g, "&#39;")})' class="text-indigo-600 hover:text-indigo-800 text-sm px-3 py-1">
                                <i class="fas fa-edit mr-1"></i>Á∑®ÈõÜ
                            </button>
                            <button onclick="deleteMaster('${m.id}')" class="text-red-600 hover:text-red-800 text-sm px-3 py-1">
                                <i class="fas fa-trash mr-1"></i>ÂâäÈô§
                            </button>
                            ` : `
                            <span class="text-gray-400 text-xs px-3 py-1"><i class="fas fa-lock mr-1"></i>Á∑®ÈõÜ‰∏çÂèØ</span>
                            `}
                        </div>
                    </div>
                `}).join('')

                container.html(html)
            } catch (error) {
                console.error('Load master data error:', error)
                $('#master-data-container').html('<p class="text-red-500">„Éû„Çπ„Çø„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>')
            } finally {
                hideLoading()
            }
        }

        window.showMasterForm = function () {
            $('#master-modal-title').text('„Éû„Çπ„Çø„Éá„Éº„Çø‰ΩúÊàê')
            $('#master-form')[0].reset()
            $('#master-id').val('')
            $('#master-organization-id').val('')
            $('#master-is-active').prop('checked', true)

            // Global option
            if (currentUser.role === 'super_admin') {
                $('#master-is-global-container').show()
                $('#master-is-global').prop('checked', false)
            } else {
                $('#master-is-global-container').hide()
                $('#master-is-global').prop('checked', false)
            }

            $('#master-modal').removeClass('hidden')
        }

        window.editMaster = function (master) {
            $('#master-modal-title').text('„Éû„Çπ„Çø„Éá„Éº„ÇøÁ∑®ÈõÜ')
            $('#master-id').val(master.id)
            $('#master-organization-id').val(master.organization_id || '')
            $('#master-type').val(master.type)
            $('#master-label').val(master.label)
            $('#master-value').val(master.value)
            $('#master-sort').val(master.sort_order)
            $('#master-is-active').prop('checked', master.is_active)

            const isGlobal = master.organization_id === null
            $('#master-is-global').prop('checked', isGlobal)

            // Global option visibility
            if (currentUser.role === 'super_admin') {
                $('#master-is-global-container').show()
            } else {
                $('#master-is-global-container').hide()
            }

            $('#master-modal').removeClass('hidden')
        }

        window.closeMasterModal = function () {
            $('#master-modal').addClass('hidden')
            $('#master-form')[0].reset()
        }

        window.deleteMaster = async function (id) {
            if (!confirm('Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return

            showLoading()
            try {
                const { error } = await supabase
                    .from('master_data')
                    .delete()
                    .eq('id', id)

                if (error) throw error
                loadMasterData()
            } catch (error) {
                console.error('Delete master error:', error)
                alert('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message)
            } finally {
                hideLoading()
            }
        }

        $('#master-form').on('submit', async function (e) {
            e.preventDefault()
            showLoading()

            const id = $('#master-id').val()
            const isGlobal = $('#master-is-global').is(':checked')

            // Logic for organization_id
            // Logic for organization_id
            let orgId = null
            if (currentUser.role === 'super_admin') {
                if (isGlobal) {
                    orgId = null
                } else {
                    const currentOrgId = $('#master-organization-id').val()
                    const filterOrgId = $('#master-filter-org').val()

                    if (id && currentOrgId) {
                        // Á∑®ÈõÜÊôÇ„Åã„Å§„ÄÅÂÖÉ„ÄÖÁµÑÁπîID„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÁ∂≠ÊåÅ
                        orgId = currentOrgId
                    } else if (filterOrgId && !id) { // Êñ∞Ë¶è‰ΩúÊàêÊôÇ„Åß„Éï„Ç£„É´„Çø„Åå„ÅÇ„ÇãÂ†¥Âêà
                        orgId = filterOrgId
                    } else if (!id) {
                        // Êñ∞Ë¶è‰ΩúÊàêÊôÇ„Åß„Éï„Ç£„É´„Çø„ÇÇ„Å™„ÅÑÂ†¥Âêà„ÄÅ„Å®„Çä„ÅÇ„Åà„ÅöËá™ÁµÑÁπîÔºà„Åì„Çå„ÅØÈÅãÁî®„Å´„Çà„Çã„ÅåÔºâ
                        orgId = currentUser.organization_id
                    } else {
                        // Á∑®ÈõÜÊôÇ„Å†„ÅåÂÖÉ„ÅåGlobal„Å†„Å£„ÅüÂ†¥Âêà„Åß„ÄÅGlobal„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂ§ñ„Åó„Åü„Ç±„Éº„Çπ„Å™„Å©
                        // -> „Åì„Åì„ÅØÈõ£„Åó„ÅÑ„Åå„ÄÅ‰∏ÄÊó¶Ëá™„É¶„Éã„Éº„ÇØÁµÑÁπîID„Å´„Åô„Çã„Åã„ÄÅ„Ç®„É©„Éº„Å´„Åô„Çã„Åã„ÄÇ
                        // ÁèæÁä∂„ÅØËá™ÁµÑÁπîID„Å´„Åô„Çã
                        orgId = currentUser.organization_id
                    }
                }
            } else {
                orgId = currentUser.organization_id
            }

            const data = {
                type: $('#master-type').val(),
                label: $('#master-label').val(),
                value: $('#master-value').val(),
                sort_order: parseInt($('#master-sort').val()) || 0,
                is_active: $('#master-is-active').is(':checked'),
                organization_id: orgId,
                updated_at: new Date().toISOString()
            }

            try {
                if (id) {
                    const { error } = await supabase
                        .from('master_data')
                        .update(data)
                        .eq('id', id)
                    if (error) throw error
                } else {
                    const { error } = await supabase
                        .from('master_data')
                        .insert(data)
                    if (error) throw error
                }

                closeMasterModal()
                loadMasterData()
            } catch (error) {
                console.error('Save master error:', error)
                alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message)
            } finally {
                hideLoading()
            }
        })
        async function loadNotifications() {
            if (!currentUser) return

            try {
                const { data: notifications, error } = await supabase
                    .from('notifications')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(20)

                if (error) throw error

                const unreadCount = notifications.filter(n => !n.read).length

                if (unreadCount > 0) {
                    $('#notification-badge').text(unreadCount).removeClass('hidden')
                } else {
                    $('#notification-badge').addClass('hidden')
                }

                renderNotifications(notifications)
            } catch (error) {
                console.error('Load notifications error:', error)
            }
        }

        function renderNotifications(notifications) {
            const container = $('#notification-list')
            container.empty()

            if (notifications.length === 0) {
                container.html('<p class="p-4 text-gray-500 text-center text-sm">ÈÄöÁü•„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>')
                return
            }

            const html = notifications.map(notif => {
                const metadata = notif.metadata || {};
                const hasLink = !!metadata.page;

                return `
                <div class="p-4 border-b hover:bg-gray-50 cursor-pointer ${notif.read ? 'bg-white' : 'bg-blue-50'} transition-colors" 
                     onclick="markAsRead('${notif.id}', ${JSON.stringify(metadata).replace(/"/g, '&quot;')})">
                    <div class="flex justify-between items-start mb-1">
                        <h4 class="font-bold text-sm text-gray-900">${notif.title}</h4>
                        <div class="flex items-center gap-2">
                             ${!notif.read ? '<span class="w-2.5 h-2.5 bg-indigo-600 rounded-full shadow-sm shadow-indigo-200"></span>' : ''}
                        </div>
                    </div>
                    <p class="text-xs text-gray-600 leading-relaxed">${notif.message}</p>
                    <div class="flex justify-between items-center mt-2">
                        <p class="text-[10px] text-gray-400 font-medium">${new Date(notif.created_at).toLocaleString('ja-JP')}</p>
                        ${hasLink ? '<span class="text-[10px] font-bold text-indigo-600 flex items-center gap-1">Ë©≥Á¥∞„ÇíË¶ã„Çã <i class="fas fa-chevron-right text-[8px]"></i></span>' : ''}
                    </div>
                </div>
            `;
            }).join('')

            container.html(html)
        }

        window.markAsRead = async function (notificationId, metadata = null) {
            try {
                // ÂÖà„Å´„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞ÔºàUIÂèçÊò†„ÇíÂÑ™ÂÖàÔºâ
                const { error } = await supabase
                    .from('notifications')
                    .update({ read: true })
                    .eq('id', notificationId)

                if (error) throw error;

                // „Éê„ÉÉ„Ç∏„ÅÆÂç≥ÊôÇÊõ¥Êñ∞
                loadNotifications()

                // „É°„Çø„Éá„Éº„Çø„Åå„ÅÇ„Çå„Å∞ÈÅ∑Áßª
                if (metadata && metadata.page) {
                    console.log('Redirecting to:', metadata.page);
                    showPage(metadata.page);

                    // „É¢„Éº„ÉÄ„É´„ÅåÈñ¢ÈÄ£„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÈñã„ÅèÔºà‰ªªÊÑèÔºâ
                    if (metadata.application_id && metadata.page === 'admin-applicants') {
                        // Ê§úÁ¥¢„Éï„Ç£„É´„Çø„Éº„ÇíÈÅ©Áî®„Åó„Åü„Çä„ÄÅÁâπÂÆö„ÅÆÈ†ÖÁõÆ„Çí„Éè„Ç§„É©„Ç§„Éà„Åô„Çã„Å™„Å©„ÅÆÂá¶ÁêÜ„ÇÇÂèØËÉΩ
                    }
                }

                // „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíÈñâ„Åò„Çã
                $('#notification-dropdown').addClass('hidden');

            } catch (error) {
                console.error('Mark as read error:', error)
            }
        }

        // ========================
        // PDF & AI Analysis
        // ========================
        async function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        async function transferFileToGoogleDrive(file, gasUrl) {
            try {
                console.log('Transferring file to Drive:', file.name, 'Size:', file.size);
                const base64 = await fileToBase64(file);
                const payload = {
                    action: 'upload',
                    filename: file.name,
                    base64: base64,
                    mimeType: file.type || 'application/pdf'
                };

                const response = await fetch(gasUrl, {
                    method: 'POST',
                    mode: 'cors',
                    body: JSON.stringify(payload),
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    }
                });

                if (!response.ok) throw new Error(`Network response was not ok (${response.status})`);

                const result = await response.json();
                console.log('Drive transfer response:', result);
                if (result.status === 'success') {
                    return result.url;
                } else {
                    throw new Error(result.message || 'Unknown error from GAS');
                }
            } catch (err) {
                console.error('transferFileToGoogleDrive error:', err);
                throw err;
            }
        }

        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer()
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise
            let fullText = ''

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i)
                const textContent = await page.getTextContent()
                const pageText = textContent.items.map(item => item.str).join(' ')
                fullText += pageText + '\n'
            }

            return fullText
        }

        async function analyzeDocumentWithAI(text, type, options = {}) {
            // Edge Function 'analyze-document' „ÇíÂëº„Å≥Âá∫„Åô
            // type: 'resume' | 'job_description'
            const { data, error } = await supabase.functions.invoke('analyze-document', {
                body: { text, type, options }
            })

            if (error) throw error
            return data
        }

        // ÊñáÂ≠óÂàó„ÅÆÈ°û‰ººÂ∫¶„ÇíË®àÁÆóÔºà„É¨„Éº„Éô„É≥„Ç∑„É•„Çø„Ç§„É≥Ë∑ùÈõ¢„Éô„Éº„ÇπÔºâ
        function calculateSimilarity(str1, str2) {
            if (!str1 || !str2) return 0;

            const s1 = str1.toLowerCase().trim();
            const s2 = str2.toLowerCase().trim();

            // ÂÆåÂÖ®‰∏ÄËá¥
            if (s1 === s2) return 1.0;

            // ÈÉ®ÂàÜ‰∏ÄËá¥„ÉÅ„Çß„ÉÉ„ÇØ
            if (s1.includes(s2) || s2.includes(s1)) return 0.8;

            // „É¨„Éº„Éô„É≥„Ç∑„É•„Çø„Ç§„É≥Ë∑ùÈõ¢„ÇíË®àÁÆó
            const matrix = [];
            for (let i = 0; i <= s1.length; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= s2.length; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= s1.length; i++) {
                for (let j = 1; j <= s2.length; j++) {
                    if (s1.charAt(i - 1) === s2.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }

            const distance = matrix[s1.length][s2.length];
            const maxLength = Math.max(s1.length, s2.length);
            return 1 - (distance / maxLength);
        }

        // „Éû„Çπ„ÇøÂÄ§„Åã„ÇâÊúÄ„ÇÇÈ°û‰ºº„Åó„ÅüÂÄ§„ÇíË¶ã„Å§„Åë„Çã
        function findClosestMasterValue(extractedValue, masterValues) {
            if (!extractedValue || !masterValues || masterValues.length === 0) {
                return null;
            }

            let bestMatch = null;
            let bestScore = 0;

            for (const masterValue of masterValues) {
                const score = calculateSimilarity(extractedValue, masterValue);
                if (score > bestScore) {
                    bestScore = score;
                    bestMatch = masterValue;
                }
            }

            // È°û‰ººÂ∫¶„Åå0.3‰ª•‰∏ä„ÅÆÂ†¥Âêà„ÅÆ„ÅøÊé°Áî®Ôºà„ÅÇ„Åæ„Çä„Å´„ÇÇÈÅï„ÅÜÂ†¥Âêà„ÅØ null „ÇíËøî„ÅôÔºâ
            return bestScore >= 0.3 ? bestMatch : null;
        }

        // --- ÈáçË§áÂà§ÂÆö„Éª‰∏ÄÊã¨Êõ¥Êñ∞„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ ---

        const PREFECTURES = ["ÂåóÊµ∑ÈÅì", "ÈùíÊ£ÆÁúå", "Â≤©ÊâãÁúå", "ÂÆÆÂüéÁúå", "ÁßãÁî∞Áúå", "Â±±ÂΩ¢Áúå", "Á¶èÂ≥∂Áúå", "Ëå®ÂüéÁúå", "Ê†ÉÊú®Áúå", "Áæ§È¶¨Áúå", "ÂüºÁéâÁúå", "ÂçÉËëâÁúå", "Êù±‰∫¨ÈÉΩ", "Á•ûÂ•àÂ∑ùÁúå", "Êñ∞ÊΩüÁúå", "ÂØåÂ±±Áúå", "Áü≥Â∑ùÁúå", "Á¶è‰∫ïÁúå", "Â±±Ê¢®Áúå", "Èï∑ÈáéÁúå", "Â≤êÈòúÁúå", "ÈùôÂ≤°Áúå", "ÊÑõÁü•Áúå", "‰∏âÈáçÁúå", "ÊªãË≥ÄÁúå", "‰∫¨ÈÉΩÂ∫ú", "Â§ßÈò™Â∫ú", "ÂÖµÂ∫´Áúå", "Â•àËâØÁúå", "ÂíåÊ≠åÂ±±Áúå", "È≥•ÂèñÁúå", "Â≥∂Ê†πÁúå", "Â≤°Â±±Áúå", "Â∫ÉÂ≥∂Áúå", "Â±±Âè£Áúå", "Âæ≥Â≥∂Áúå", "È¶ôÂ∑ùÁúå", "ÊÑõÂ™õÁúå", "È´òÁü•Áúå", "Á¶èÂ≤°Áúå", "‰ΩêË≥ÄÁúå", "Èï∑Â¥éÁúå", "ÁÜäÊú¨Áúå", "Â§ßÂàÜÁúå", "ÂÆÆÂ¥éÁúå", "ÈπøÂÖêÂ≥∂Áúå", "Ê≤ñÁ∏ÑÁúå"];

        function getPrefecture(loc) {
            if (!loc) return null;
            for (const pref of PREFECTURES) {
                if (loc.includes(pref)) return pref;
            }
            // Áü≠Á∏ÆÂΩ¢ (Êù±‰∫¨, Â§ßÈò™)
            const shortPrefs = PREFECTURES.map(p => p.replace(/[ÈÉΩÂ∫úÁúå]$/, ''));
            for (let i = 0; i < shortPrefs.length; i++) {
                if (loc.includes(shortPrefs[i])) return PREFECTURES[i];
            }
            return null;
        }

        function isJobDuplicate(newJob, oldJob) {
            let score = 0;
            const reasons = [];

            // 0. Ê±Ç‰∫∫ÁÆ°ÁêÜID (‰∏ÄËá¥„Åô„Çå„Å∞ÈáçË§áÁ¢∫ÂÆö)
            if (newJob.job_code && oldJob.job_code && newJob.job_code === oldJob.job_code) {
                score += 5;
                reasons.push({ label: 'ÁÆ°ÁêÜID', value: newJob.job_code });
            }

            // 1. ‰ºÅÊ•≠Âêç (‰∏ÄËá¥ÂøÖÈ†à)
            const newCompany = (newJob.company || '').trim();
            const oldCompany = (oldJob.company || '').trim();
            if (newCompany && oldCompany && newCompany === oldCompany) {
                score++;
                reasons.push({ label: '‰ºÅÊ•≠Âêç', value: newCompany });
            } else {
                // ‰ºÅÊ•≠Âêç„Åå‰∏ÄËá¥„Åó„Å™„ÅÑÂ†¥Âêà„ÅØÈáçË§á„Å®„Åø„Å™„Åï„Å™„ÅÑ
                // „Åü„Å†„Åó„ÄÅÊ±Ç‰∫∫ÁÆ°ÁêÜID„Åå‰∏ÄËá¥„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÁâπÂà•„Å´Á∂öË°å
                if (!(newJob.job_code && oldJob.job_code && newJob.job_code === oldJob.job_code)) {
                    return false;
                }
            }

            // 2. ËÅ∑Á®ÆÂàÜÈ°û (Âêå‰∏Ä‰ºÅÊ•≠„Åß„ÇÇËÅ∑ËÉΩ„ÅåÁï∞„Å™„Çå„Å∞Âà•Ê±Ç‰∫∫„Å®„Åó„Å¶Êâ±„ÅÜ)
            if (newJob.job_category && oldJob.job_category) {
                if (newJob.job_category !== oldJob.job_category) {
                    return false; // ËÅ∑Á®Æ„Ç´„ÉÜ„Ç¥„É™„ÅåÊòéÁ¢∫„Å´Áï∞„Å™„ÇãÂ†¥Âêà„ÅØÈáçË§á„Å®„Åø„Å™„Åï„Å™„ÅÑ
                }
                score++;
                let catLabel = newJob.job_category;
                if (typeof masterJobCategories !== 'undefined') {
                    const match = masterJobCategories.find(m => m.value === newJob.job_category || m.label === newJob.job_category);
                    if (match) catLabel = match.label;
                }
                reasons.push({ label: 'ËÅ∑Á®Æ', value: catLabel });
            }

            // 3. Âã§ÂãôÂú∞ (ÂêåÈÉΩÈÅìÂ∫úÁúå)
            const newPref = getPrefecture(newJob.location);
            const oldPref = getPrefecture(oldJob.location);
            if (newPref && oldPref && newPref === oldPref) {
                score++;
                reasons.push({ label: 'Âã§ÂãôÂú∞', value: newPref });
            }

            // 4. Âπ¥Âèé (‰∏äÈôê„Å®‰∏ãÈôê„Åå+-50‰∏á‰ª•ÂÜÖ)
            const isMatchSalary = (v1, v2) => {
                if (v1 === null || v1 === undefined || v2 === null || v2 === undefined) return false;
                const n1 = parseFloat(v1);
                const n2 = parseFloat(v2);
                if (isNaN(n1) || isNaN(n2)) return false;
                return Math.abs(n1 - n2) <= 500000;
            };
            if (isMatchSalary(newJob.salary_min, oldJob.salary_min) && isMatchSalary(newJob.salary_max, oldJob.salary_max)) {
                score++;
                const sMin = newJob.salary_min ? (newJob.salary_min / 10000) + '‰∏á' : '';
                const sMax = newJob.salary_max ? (newJob.salary_max / 10000) + '‰∏á' : '';
                reasons.push({ label: 'Áµ¶‰∏é', value: `${sMin}ÔΩû${sMax}` });
            }

            // Âà§ÂÆö: ‰ºÅÊ•≠Âêç(1ÁÇπ) + „Åù„ÅÆ‰ªñ1„Å§‰ª•‰∏ä(1ÁÇπ„Äú) = 2ÁÇπ‰ª•‰∏ä„ÅßÈáçË§áÂÄôË£ú
            if (score >= 2) {
                oldJob._duplicateReasons = reasons;
                oldJob._duplicateScore = score;
                return true;
            }
            return false;
        }

        function formatDuplicateReasons(reasons) {
            if (!reasons || reasons.length === 0) return '';
            return `<div class="mt-2 text-[10px] space-y-0.5 border-t border-red-100 pt-1.5">` +
                reasons.map(r => {
                    let val = String(r.value || '-');
                    if (val.length > 30) val = val.substring(0, 27) + '...';
                    return `<div class="flex items-start">
                        <span class="font-bold text-red-700 w-[55px] shrink-0 opacity-70">${r.label}:</span>
                        <span class="text-red-600 truncate">${val}</span>
                    </div>`;
                }).join('') + `</div>`;
        }

        function renderJobComparisonTable(newJob, oldJob) {
            const getCatLabel = (val) => {
                if (!val) return '-';
                if (typeof masterJobCategories !== 'undefined') {
                    const match = masterJobCategories.find(m => m.value === val || m.label === val);
                    if (match) return match.label;
                }
                return val;
            };

            const formatSal = (min, max) => {
                if (!min && !max) return '-';
                const sMin = min ? (min / 10000).toFixed(0) + '‰∏á' : '';
                const sMax = max ? (max / 10000).toFixed(0) + '‰∏á' : '';
                return `${sMin}ÔΩû${sMax}`;
            };

            const rows = [
                { label: '‰ºÅÊ•≠Âêç', new: newJob.company, old: oldJob.company },
                { label: 'ËÅ∑Á®Æ', new: getCatLabel(newJob.job_category), old: getCatLabel(oldJob.job_category) },
                { label: 'Âã§ÂãôÂú∞', new: newJob.location, old: oldJob.location },
                { label: 'Áµ¶‰∏é', new: formatSal(newJob.salary_min, newJob.salary_max), old: formatSal(oldJob.salary_min, oldJob.salary_max) }
            ];

            return `
                <div class="mt-2 overflow-hidden border border-gray-200 rounded-md bg-white shadow-sm">
                    <table class="min-w-full divide-y divide-gray-200 text-[10px] leading-tight">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-2 py-1 text-left font-bold text-gray-500 w-12">È†ÖÁõÆ</th>
                                <th class="px-2 py-1 text-left font-bold text-indigo-600">ÁôªÈå≤„Éá„Éº„ÇøÂÅ¥</th>
                                <th class="px-2 py-1 text-left font-bold text-red-600">„Ç∑„Çπ„ÉÜ„É†ÂÜÖ„Éá„Éº„Çø</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            ${rows.map(row => {
                let isMatch = false;
                if (row.label === '‰ºÅÊ•≠Âêç') {
                    isMatch = (row.new || '').trim() === (row.old || '').trim();
                } else if (row.label === 'ËÅ∑Á®Æ') {
                    isMatch = (newJob.job_category === oldJob.job_category);
                } else if (row.label === 'Âã§ÂãôÂú∞') {
                    const p1 = typeof getPrefecture === 'function' ? getPrefecture(row.new) : null;
                    const p2 = typeof getPrefecture === 'function' ? getPrefecture(row.old) : null;
                    isMatch = (p1 && p2 && p1 === p2);
                } else if (row.label === 'Áµ¶‰∏é') {
                    const isMatchSalary = (v1, v2) => {
                        if (v1 == null || v2 == null) return false;
                        return Math.abs(parseFloat(v1) - parseFloat(v2)) <= 500000;
                    };
                    isMatch = isMatchSalary(newJob.salary_min, oldJob.salary_min) && isMatchSalary(newJob.salary_max, oldJob.salary_max);
                }

                return `
                                <tr class="${isMatch ? 'bg-red-50/50' : ''}">
                                    <td class="px-2 py-1 font-medium text-gray-500 whitespace-nowrap">${row.label}</td>
                                    <td class="px-2 py-1 text-gray-700">${row.new || '-'}</td>
                                    <td class="px-2 py-1 ${isMatch ? 'text-red-700 font-bold' : 'text-gray-700'}">${row.old || '-'}</td>
                                </tr>
                                `;
            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function mergeJobData(newJob, oldJob) {
            const updatePayload = {};
            // Êõ¥Êñ∞ÂØæË±°Â§ñ„Å®„Åô„Çã„Ç≠„Éº
            const skipKeys = ['id', 'created_at', 'organization_id', 'deleted_at'];

            for (const key in newJob) {
                if (skipKeys.includes(key)) continue;
                // Êñ∞„ÅÆÊñπ„Å´ÂÄ§„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÊõ¥Êñ∞ÂØæË±°„Å´Âê´„ÇÅ„Çã
                // null, undefined, Á©∫ÊñáÂ≠ó„Åß„Å™„ÅÑÂ†¥Âêà„Å´Êõ¥Êñ∞
                if (newJob[key] !== null && newJob[key] !== undefined && newJob[key] !== '') {
                    updatePayload[key] = newJob[key];
                }
            }
            return updatePayload;
        }

        window.handleResumeUpload = async function (input) {
            if (input.files.length === 0) return

            if (!confirm('PDF„ÇíËß£Êûê„Åó„Å¶„Éó„É≠„Éï„Ç£„Éº„É´„Å´Ëá™ÂãïÂÖ•Âäõ„Åó„Åæ„Åô„ÅãÔºü\n‚ÄªÊó¢Â≠ò„ÅÆÂÖ•ÂäõÂÜÖÂÆπ„ÅØ‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇ')) {
                input.value = ''
                return
            }

            showLoading()
            try {
                let combinedText = ''
                for (let i = 0; i < input.files.length; i++) {
                    const text = await extractTextFromPDF(input.files[i])
                    combinedText += `--- File ${i + 1} ---\n${text}\n`
                }

                let result = await analyzeDocumentWithAI(combinedText, 'resume');

                // ÈÖçÂàó„ÅßËøî„Å£„Å¶„Åç„ÅüÂ†¥Âêà„ÅØÊúÄÂàù„ÅÆË¶ÅÁ¥†„Çí‰Ωø„ÅÜ
                if (Array.isArray(result)) {
                    result = result[0] || {};
                }

                console.log('Resume Analysis Result:', result);

                // --- „Éï„Ç©„Éº„É†„Å∏„ÅÆÂèçÊò† ---

                // ÂêçÂâç„ÅØreadonly„Å†„Åå„ÄÅ„Åµ„Çä„Åå„Å™„Å™„Å©„ÅØÂèçÊò†
                if (result.furigana || result.kana) $('#profile-furigana').val(result.furigana || result.kana);
                if (result.email) $('#profile-email').val(result.email);
                if (result.phone) $('#profile-phone').val(result.phone);
                if (result.age) $('#profile-age').val(result.age);

                // Â≠¶Ê≠¥
                if (result.education || result.academic_background) {
                    $('#profile-academic').val(result.education || result.academic_background);
                }

                // „Çπ„Ç≠„É´
                if (result.skills) {
                    $('#profile-skills').val(result.skills);
                }

                // ËÅ∑Ê≠¥Ê¶ÇË¶Å
                if (result.work_history) {
                    $('#profile-history').val(result.work_history);
                }

                // ËÅ∑ÂãôÁµåÊ≠¥ (Ë©≥Á¥∞„ÉÜ„Ç≠„Çπ„Éà)
                if (result.work_history_detail) {
                    $('#profile-work-history-detail').val(result.work_history_detail);
                }

                // Êé®ÂÆöÂπ¥Âèé (‰∏áÂÜÜÂçò‰Ωç)
                if (result.current_salary) {
                    $('#profile-current-salary').val(result.current_salary / 10000);
                }

                // ÊßãÈÄ†Âåñ„Åï„Çå„ÅüËÅ∑Ê≠¥ (Ë©≥Á¥∞ËÅ∑Ê≠¥)
                if (result.work_history_structured && Array.isArray(result.work_history_structured)) {
                    $('#profile-work-history-list').empty();
                    result.work_history_structured.forEach(item => addWorkHistoryItemToContainer('#profile-work-history-list', item));
                    updateJobChangeCountInContainer('#profile-work-history-list', '#profile-job-change-count');
                }

                // „Éû„Çπ„Çø„Éá„Éº„Çø„Å®„ÅÆ„Éû„ÉÉ„ÉÅ„É≥„Ç∞ (ËÅ∑Á®Æ„ÉªÊ•≠Áïå)
                if (result.desired_job_type) {
                    const extractedJobs = [result.desired_job_type].flat().filter(Boolean);
                    const matchedJobs = [];
                    extractedJobs.forEach(val => {
                        const match = findClosestMasterValue(val, masterJobCategories);
                        if (match && !matchedJobs.includes(match)) matchedJobs.push(match);
                    });
                    if (matchedJobs.length > 0) {
                        $('#profile-job-type').val(matchedJobs).trigger('change');
                    }
                }

                if (result.desired_industry) {
                    const extractedIndustries = [result.desired_industry].flat().filter(Boolean);
                    const matchedIndustries = [];
                    extractedIndustries.forEach(val => {
                        const match = findClosestMasterValue(val, masterIndustries);
                        if (match && !matchedIndustries.includes(match)) matchedIndustries.push(match);
                    });
                    if (matchedIndustries.length > 0) {
                        $('#profile-industry').val(matchedIndustries).trigger('change');
                    }
                }

                alert('PDF„ÅÆËß£Êûê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ\nÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç„Éª‰øÆÊ≠£„Åó„Åü‰∏ä„Åß‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            } catch (error) {
                console.error('Resume analysis error:', error)
                alert('Ëß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message)
            } finally {
                hideLoading()
                input.value = ''
            }
        }

        window.handleJobPdfUpload = async function (input) {
            if (input.files.length === 0) return

            const fileCount = input.files.length;
            const confirmMsg = fileCount > 1
                ? `${fileCount}‰ª∂„ÅÆPDF„Éï„Ç°„Ç§„É´„ÇíÂá¶ÁêÜ„Åó„Åæ„Åô„ÄÇ\n„Åù„Çå„Åû„ÇåËß£Êûê„Åó„ÄÅÂÄãÂà•„ÅÆÊ±Ç‰∫∫„Å®„Åó„Å¶ÁôªÈå≤„Åó„Åæ„Åô„ÅãÔºü`
                : 'PDF„ÇíËß£Êûê„Åó„Å¶Ê±Ç‰∫∫„Éï„Ç©„Éº„É†„Å´Ëá™ÂãïÂÖ•Âäõ„Åó„Åæ„Åô„ÅãÔºü\n‚ÄªÊó¢Â≠ò„ÅÆÂÖ•ÂäõÂÜÖÂÆπ„ÅØ‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇ';

            if (!confirm(confirmMsg)) {
                input.value = ''
                return
            }

            const isBulkMode = fileCount > 1;
            showImportProgress(
                isBulkMode ? '‰∏ÄÊã¨PDFÊ±Ç‰∫∫Ëß£Êûê' : 'PDFÊ±Ç‰∫∫Ëß£Êûê',
                `${fileCount}‰ª∂„ÅÆ„Éï„Ç°„Ç§„É´„ÇíÈ†ÜÁï™„Å´Âá¶ÁêÜ„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ`
            );
            addImportStep('extract', 'PDF„ÉÜ„Ç≠„Çπ„ÉàÊäΩÂá∫');
            addImportStep('analyze', 'AIÊ±Ç‰∫∫ÂÜÖÂÆπËß£Êûê', 'fa-magic');
            addImportStep('duplicate', 'ÈáçË§áÂà§ÂÆö');
            addImportStep('drive', 'Google„Éâ„É©„Ç§„ÉñÈÄ£Âãï', 'fa-google-drive');
            addImportStep('register', '„Éá„Éº„Çø„Éô„Éº„ÇπÁôªÈå≤');

            importResultSuccessFiles = [];
            importResultErrorFiles = [];

            try {
                const options = {
                    job_categories: typeof masterJobCategories !== 'undefined' ? masterJobCategories : [],
                    industry_categories: typeof masterIndustries !== 'undefined' ? masterIndustries : []
                };

                const orgSettings = getOrgSettings();
                const bulkConfirmEnabled = orgSettings.bulk_duplicate_confirm_enabled === true;

                for (let i = 0; i < fileCount; i++) {
                    const file = input.files[i];
                    console.log(`Processing file ${i + 1}/${fileCount}: ${file.name}`);

                    $('#import-progress-subtitle').text(`${i + 1}/${fileCount}‰ª∂ÁõÆ„ÅÆ„Éï„Ç°„Ç§„É´„ÇíÂá¶ÁêÜ‰∏≠: ${file.name}`);
                    updateImportProgress((i / fileCount) * 100, i, fileCount);

                    // „Çπ„ÉÜ„ÉÉ„Éó„É™„Çª„ÉÉ„Éà
                    setImportStepStatus('extract', 'active');
                    setImportStepStatus('analyze', 'pending');
                    setImportStepStatus('duplicate', 'pending');
                    setImportStepStatus('drive', 'pending');
                    setImportStepStatus('register', 'pending');

                    try {
                        const text = await extractTextFromPDF(file);
                        setImportStepStatus('extract', 'done');

                        if (!text || text.trim().length === 0) {
                            throw new Error('„ÉÜ„Ç≠„Çπ„Éà„ÇíÊäΩÂá∫„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ');
                        }

                        await processParsedJobText(text, file, options, isBulkMode, (step, status) => {
                            setImportStepStatus(step, status);
                        });

                        if (isBulkMode && !bulkConfirmEnabled) {
                            importResultSuccessFiles.push(file.name);
                        }
                    } catch (err) {
                        console.error(`Error processing ${file.name}:`, err);
                        importResultErrorFiles.push({ name: file.name, message: err.message });
                    }
                }

                updateImportProgress(100, fileCount, fileCount);
                setTimeout(() => {
                    hideImportProgress();
                    if (isBulkMode) {
                        if (bulkConfirmEnabled && pendingBulkJobs.length > 0) {
                            renderBulkConfirmList();
                            $('#job-bulk-confirm-modal').removeClass('hidden');
                        } else {
                            showImportResult(importResultSuccessFiles, importResultErrorFiles);
                            closeJobModal();
                            loadAdminJobs();
                        }
                    } else if (importResultErrorFiles.length > 0) {
                        showImportResult([], importResultErrorFiles);
                    }
                }, 500);

            } catch (error) {
                console.error('Job analysis error:', error)
                hideImportProgress();
                alert('Ëß£ÊûêÂá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message)
            } finally {
                input.value = ''
            }
        }

        // Common logic for processing job text
        async function processParsedJobText(text, file, options, isBulkMode, onStepUpdate) {
            if (onStepUpdate) onStepUpdate('analyze', 'active');
            let result = await analyzeDocumentWithAI(text, 'job_description', options);
            if (Array.isArray(result)) result = result[0] || {};
            if (onStepUpdate) onStepUpdate('analyze', 'done');

            if (!result.title || !result.company) {
                throw new Error(`„Éï„Ç°„Ç§„É´„Äå${file.name}„Äç„Åã„Çâ„Çø„Ç§„Éà„É´„Åæ„Åü„ÅØ‰ºöÁ§æÂêç„ÇíÁâπÂÆö„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ`);
            }

            // --- Âπ¥Âèé„ÅÆÂçò‰ΩçË£úÊ≠£ (ÂÜÜÂçò‰Ωç„Å´Áµ±‰∏Ä) ---
            const normalizeSalary = (val) => {
                if (val === null || val === undefined || val === '') return null;
                let n = parseFloat(String(val).replace(/,/g, ''));
                if (isNaN(n)) return null;
                // AI„Åå„Äå400„Äç„Å™„Å©„ÅÆ‰∏áÂÜÜÂçò‰Ωç„ÅßËøî„Åó„Å¶„Åè„Çã„Åì„Å®„ÅåÂ§ö„ÅÑ„Åü„ÇÅË£úÊ≠£
                // Êó•Êú¨„ÅÆÂπ¥Âèé„Åß10‰∏áÊú™Ê∫Ä(100,000ÂÜÜÊú™Ê∫Ä)„ÅØÈÄöÂ∏∏„ÅÇ„ÇäÂæó„Å™„ÅÑ„Åü„ÇÅ„ÄÅ‰∏áÂÜÜÂçò‰Ωç„Å®Âà§ÂÆö
                if (n > 0 && n < 100000) {
                    return Math.round(n * 10000);
                }
                return Math.round(n);
            };

            result.salary_min = normalizeSalary(result.salary_min);
            result.salary_max = normalizeSalary(result.salary_max);

            const orgSettings = getOrgSettings();
            const bulkConfirmEnabled = orgSettings.bulk_duplicate_confirm_enabled === true;

            if (onStepUpdate) onStepUpdate('duplicate', 'active');
            // Check duplicates
            const { data: existingJobs } = await supabase
                .from('jobs')
                .select('id, title, company, job_category, location, salary_min, salary_max, description, requirements, welcome_requirements, work_hours, holidays, benefits, interview_process, employment_type, is_remote, job_experience_ok, industry_experience_ok, pdf_filename, status')
                .eq('organization_id', currentUser.organization_id)
                .is('deleted_at', null)
                .or(`title.eq."${result.title}", company.eq."${result.company}"`) // Áµû„ÇäËæº„Åø„ÅÆ„Åü„ÇÅ„Å´title„Åæ„Åü„ÅØcompany‰∏ÄËá¥„Çí‰∏ÄÊó¶ÂèñÂæó
                .limit(20);

            // Âº∑Âåñ„Åï„Çå„ÅüÈáçË§áÂà§ÂÆö„ÇíÂÆüË°å
            const duplicateJob = existingJobs?.find(j => isJobDuplicate(result, j));
            const duplicates = duplicateJob ? [duplicateJob] : [];
            if (onStepUpdate) onStepUpdate('duplicate', 'done');

            let companyId = null;
            const { data: ec } = await supabase.from('companies').select('id').eq('organization_id', currentUser.organization_id).eq('name', result.company).maybeSingle();
            if (ec) {
                companyId = ec.id;
            } else {
                const { data: nc } = await supabase.from('companies').insert({ organization_id: currentUser.organization_id, name: result.company, location: result.location }).select().maybeSingle();
                if (nc) companyId = nc.id;
            }

            const jobData = {
                organization_id: currentUser.organization_id,
                title: result.title,
                company_id: companyId,
                company: result.company,
                location: result.location || 'Êú™ÂÆö',
                salary_min: result.salary_min || null,
                salary_max: result.salary_max || null,
                description: result.description || '',
                requirements: result.requirements || '',
                welcome_requirements: result.welcome_requirements || '',
                work_hours: result.work_hours || null,
                holidays: result.holidays || null,
                benefits: result.benefits || null,
                interview_process: result.interview_process || null,
                employment_type: result.employment_type || 'Ê≠£Á§æÂì°',
                is_remote: result.is_remote || false,
                job_experience_ok: result.job_experience_ok ? 'ÂèØ' : '‰∏çÂèØ',
                industry_experience_ok: result.industry_experience_ok ? 'ÂèØ' : '‰∏çÂèØ',
                job_category: findClosestMasterValue(result.job_category, masterJobCategories),
                industry_category: findClosestMasterValue(result.industry_category, masterIndustries),
                pdf_filename: file.name,
                status: 'active'
            };

            if (isBulkMode && bulkConfirmEnabled) {
                pendingBulkJobs.push({ file, result, jobData, duplicates: duplicates || [] });
                if (onStepUpdate) onStepUpdate('register', 'done');
                return;
            }

            if (onStepUpdate) onStepUpdate('drive', 'active');
            // Transfer to Drive if enabled (or use existing driveUrl from Drive import)
            let driveCol = orgSettings.drive_column || 'pdf_url';
            // „Äåpdf„Äç„Ç´„É©„É†„ÅØÂ≠òÂú®„Åó„Å™„ÅÑ„Åü„ÇÅ„Äåpdf_url„Äç„Å´„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
            if (driveCol === 'pdf' || driveCol === 'url') driveCol = 'pdf_url';
            if (file.driveUrl) {
                jobData[driveCol] = file.driveUrl;
            } else if (orgSettings.drive_transfer_enabled && orgSettings.drive_gas_url && file.size) {
                try {
                    const driveUrl = await transferFileToGoogleDrive(file, orgSettings.drive_gas_url);
                    if (driveUrl) {
                        jobData[driveCol] = driveUrl;
                    }
                } catch (e) { console.error('Drive transfer failed:', e); }
            }
            if (onStepUpdate) onStepUpdate('drive', 'done');

            if (onStepUpdate) onStepUpdate('register', 'active');
            if (!isBulkMode) {
                // Fill form
                $('#job-title').val(result.title);
                $('#job-company-select').val(companyId).trigger('change');

                $('#job-location').val(result.location || '');
                $('#job-salary-min').val(result.salary_min ? result.salary_min / 10000 : '');
                $('#job-salary-max').val(result.salary_max ? result.salary_max / 10000 : '');
                $('#job-description').val(result.description || '');
                $('#job-requirements').val(result.requirements || '');
                $('#job-welcome-requirements').val(result.welcome_requirements || '');
                $('#job-work-hours').val(result.work_hours || '');
                $('#job-holidays').val(result.holidays || '');
                $('#job-benefits').val(result.benefits || '');
                $('#job-interview-process').val(result.interview_process || '');
                $('#job-category').val(jobData.job_category);
                $('#job-industry-category').val(jobData.industry_category);
                $('#job-employment-type').val(result.employment_type || 'Ê≠£Á§æÂì°');
                $('#job-is-remote').prop('checked', !!result.is_remote);
                $('#job-experience-ok').prop('checked', !!result.job_experience_ok);
                $('#job-industry-experience-ok').prop('checked', !!result.industry_experience_ok);

                if (jobData[orgSettings.drive_column || 'pdf_url']) {
                    const finalUrl = jobData[orgSettings.drive_column || 'pdf_url'];
                    $('#job-drive-pdf-url').val(finalUrl);
                    // „É¶„Éº„Ç∂„Éº„Å´Ë¶ã„Åà„Çã„ÄåÊ±Ç‰∫∫URL„Äç„Éï„Ç£„Éº„É´„Éâ„Å´„ÇÇÂèçÊò†
                    if (!$('#job-url').val()) {
                        $('#job-url').val(finalUrl);
                    }
                }
                $('#job-pdf-filename').val(file.name);

                alert('PDF„ÅÆËß£Êûê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            } else {
                const { error } = await supabase.from('jobs').insert(jobData);
                if (error) throw error;
            }
            if (onStepUpdate) onStepUpdate('register', 'done');
        }

        window.closeDriveImportModal = function () {
            $('#drive-import-modal').addClass('hidden').attr('style', '');
        }

        // Google Drive Import functions
        window.driveFilesCache = [];

        window.openDriveImportModal = async function () {
            console.log('DEBUG: openDriveImportModal called');
            const user = window.currentUser || currentUser;
            const orgSettings = getOrgSettings(user);
            if (!orgSettings.drive_import_enabled || !orgSettings.drive_import_gas_url) {
                console.warn('DEBUG: Drive import settings missing:', orgSettings);
                alert('Google„Éâ„É©„Ç§„Éñ„Ç§„É≥„Éù„Éº„ÉàË®≠ÂÆö„ÅåÊú™ÂÆå‰∫Ü„Åß„Åô„ÄÇÁÆ°ÁêÜËÄÖË®≠ÂÆöÔºàÁµÑÁπîË®≠ÂÆöÔºâ„ÅßGAS URL„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            const $modal = $('#drive-import-modal');
            // Ë¶ÅÁ¥†„Çíbody„Å∏ÁßªÂãï
            $modal.appendTo('body');
            $modal.removeClass('hidden').attr('style', 'display: flex !important; z-index: 100000 !important;');
            console.log('DEBUG: Drive modal shown/forced');

            // „Éï„Ç£„É´„Çø„Éº„ÅÆ„É™„Çª„ÉÉ„Éà
            $('#drive-filter-search').val('');
            $('#drive-filter-date-from').val('');
            $('#drive-filter-sort').val('newest');

            $('#drive-file-list').empty();
            $('#drive-import-count').text('0‰ª∂ÈÅ∏Êäû');
            $('#execute-drive-import-btn').prop('disabled', true);
            $('#drive-import-status').attr('class', 'mb-4 p-4 bg-blue-50 text-blue-700 rounded-lg flex items-center gap-3 border border-blue-100')
                .html('<i class="fas fa-spinner fa-spin"></i><p class="text-sm">Google„Éâ„É©„Ç§„Éñ„Çí„Çπ„Ç≠„É£„É≥‰∏≠...</p>');

            try {
                const response = await fetch(orgSettings.drive_import_gas_url, {
                    method: 'POST', mode: 'cors', body: JSON.stringify({ action: 'list_files' }),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                });
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);

                window.driveFilesCache = result.files || [];
                if (window.driveFilesCache.length === 0) {
                    $('#drive-import-status').attr('class', 'mb-4 p-4 bg-amber-50 text-amber-700 rounded-lg flex items-center gap-3 border border-amber-100')
                        .html('<i class="fas fa-exclamation-triangle"></i><p class="text-sm">„Ç§„É≥„Éù„Éº„ÉàÂèØËÉΩ„Å™Ê±Ç‰∫∫PDF„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</p>');
                    return;
                }

                $('#drive-import-status').attr('class', 'mb-4 p-4 bg-green-50 text-green-700 rounded-lg flex items-center gap-3 border border-green-100')
                    .html('<i class="fas fa-check-circle"></i><p class="text-sm">' + window.driveFilesCache.length + '‰ª∂„ÅÆ„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü„ÄÇ</p>');

                $('#drive-file-select-all').prop('checked', false);
                applyDriveFileFilters();
            } catch (err) {
                $('#drive-import-status').attr('class', 'mb-4 p-4 bg-red-50 text-red-700 rounded-lg flex items-center gap-3 border border-red-100').html(`<i class="fas fa-times-circle"></i><p class="text-sm">„Ç®„É©„Éº: ${err.message}</p>`);
            }
        };

        // Ê§úÁ¥¢„ÇÑÂêåÊúü„ÅÆ„Åü„ÇÅ„ÅÆÈ†ëÂÅ•„Å™Ê≠£Ë¶èÂåñÔºàÂÖ®ËßíÂçäËßí„Éª„Çπ„Éö„Éº„Çπ„Éª„Ç´„Çø„Ç´„ÉäÁ≠âÔºâ
        function robustNormalize(str) {
            if (!str) return '';
            return str.toString()
                .trim()
                .toLowerCase()
                .replace(/[ÔºÅ-ÔΩû]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)) // ÂÖ®ËßíËã±Êï∞‚ÜíÂçäËßí
                .replace(/[\u3000\s]+/g, '') // ÂÖ®„Å¶„ÅÆÁ©∫ÁôΩ„ÇíÈô§Âéª
                .normalize('NFC');
        }

        window.syncDriveFileUrls = async function () {
            if (!confirm('Google„Éâ„É©„Ç§„Éñ„ÅÆ„Éï„Ç°„Ç§„É´Âêç„Å®Ê±Ç‰∫∫„ÅÆ„Éï„Ç°„Ç§„É´Âêç„ÇíÁÖßÂêà„Åó„ÄÅURL„ÅåÊú™ÁôªÈå≤„ÅÆÊ±Ç‰∫∫„Å´URL„ÇíËá™ÂãïÂèçÊò†„Åó„Åæ„Åô„ÄÇÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü')) {
                return;
            }

            const targetUser = window.currentUser || currentUser;
            const orgSettings = getOrgSettings(targetUser);
            // „Ç§„É≥„Éù„Éº„ÉàË®≠ÂÆöÂÅ¥„ÅÆ‰øùÂ≠òÂÖà„Ç´„É©„É†„ÇíÂÑ™ÂÖà
            let driveCol = (orgSettings.drive_import_column || orgSettings.drive_column || 'pdf_url').toString().trim();

            // „Äåpdf„Äç„ÇÑ„Äåurl„Äç„Å®„ÅÑ„ÅÜ„Ç´„É©„É†Âêç„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅÂÆüÈöõ„ÅÆ‰øùÂ≠òÂÖà„Åß„ÅÇ„Çã„Äåpdf_url„Äç„Å´„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
            if (driveCol === 'pdf' || driveCol === 'url') {
                console.warn(`ÁµÑÁπîË®≠ÂÆö„ÅÆ„Ç´„É©„É†Âêç„Åå„Äå${driveCol}„Äç„Å´„Å™„Å£„Å¶„ÅÑ„Åæ„Åô„Åå„ÄÅÊ±Ç‰∫∫PDF„ÅÆ‰øùÂ≠ò„Å´„ÅØ„Äåpdf_url„Äç„Çí‰ΩøÁî®„Åó„Åæ„Åô„ÄÇ`);
                driveCol = 'pdf_url';
            }

            // „Ç§„É≥„Éù„Éº„ÉàÁî®„ÅÆË®≠ÂÆö„ÇíÂÑ™ÂÖà„Åô„Çã„Åå„ÄÅ„Å™„Åë„Çå„Å∞Ëª¢ÈÄÅÁî®„ÅÆË®≠ÂÆö„Çí‰∫àÂÇô(fallback)„Å®„Åó„Å¶‰Ωø„ÅÜ
            const gasUrl = orgSettings.drive_import_gas_url || orgSettings.drive_gas_url;
            const isImportEnabled = orgSettings.drive_import_enabled || orgSettings.drive_transfer_enabled;

            if (!isImportEnabled || !gasUrl) {
                alert('Google„Éâ„É©„Ç§„ÉñË®≠ÂÆö„ÅåÊú™ÂÆå‰∫Ü„Åß„Åô„ÄÇÁÆ°ÁêÜËÄÖË®≠ÂÆöÔºàÁµÑÁπîË®≠ÂÆöÔºâ„ÅßGAS URL„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n\n‚Äª„ÄåGoogle„Éâ„É©„Ç§„ÉñÊ±Ç‰∫∫PDF„Ç§„É≥„Éù„Éº„ÉàË®≠ÂÆö„Äç„Åæ„Åü„ÅØ„ÄåGoogle„Éâ„É©„Ç§„ÉñPDFËª¢ÈÄÅË®≠ÂÆö„Äç„ÅÆ„ÅÑ„Åö„Çå„Åã„ÅßURL„ÅÆË®≠ÂÆö„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ');
                return;
            }

            showLoading();
            try {
                // 1. Google Drive„Åã„Çâ„Éï„Ç°„Ç§„É´‰∏ÄË¶ß„ÇíÂèñÂæó
                const response = await fetch(gasUrl, {
                    method: 'POST', mode: 'cors', body: JSON.stringify({ action: 'list_files' }),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                });
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);

                const driveFiles = result.files || [];
                if (driveFiles.length === 0) {
                    alert('Google„Éâ„É©„Ç§„Éñ„Å´„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ');
                    return;
                }

                // 2. Ê±Ç‰∫∫„ÇíDB„Åã„ÇâÂèñÂæó („Éï„Ç°„Ç§„É´Âêç„Åå„ÅÇ„Çã„ÇÇ„ÅÆ„ÄÇURL„ÅåÁ©∫„Åã„ÅØÂæå„Åß„Éï„Ç£„É´„Çø)
                const { data: jobs, error } = await supabase
                    .from('jobs')
                    .select(`id, pdf_filename, ${driveCol}, url`)
                    .eq('organization_id', targetUser.organization_id)
                    .is('deleted_at', null)
                    .not('pdf_filename', 'is', null)
                    .neq('pdf_filename', '');

                if (error) throw error;

                // URL„ÅåÊú™ÁôªÈå≤Ôºànull „Åæ„Åü„ÅØ Á©∫ÊñáÂ≠óÔºâ„ÅÆ„ÇÇ„ÅÆ„Å´ÈôêÂÆö
                const targetJobs = (jobs || []).filter(j => !j[driveCol]);

                if (targetJobs.length === 0) {
                    alert('URL„ÇíÂêåÊúü„Åß„Åç„ÇãÂØæË±°„ÅÆÊ±Ç‰∫∫„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ\n\nÁ¢∫Ë™ç„Éù„Ç§„É≥„Éà:\n„Éª„Äå„Éï„Ç°„Ç§„É´Âêç„Äç„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÅãÔºü\n„Éª„ÄåÊ±Ç‰∫∫URLÔºàpdf_urlÔºâ„Äç„ÅåÊó¢„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÅãÔºüÔºàÁ©∫Ê¨Ñ„ÅÆ„ÇÇ„ÅÆ„ÅÆ„Åø„ÅåÂØæË±°„Åß„ÅôÔºâ');
                    return;
                }

                // 3. „Éû„ÉÉ„ÉÅ„É≥„Ç∞Âá¶ÁêÜ
                const updates = [];
                let matchCount = 0;
                const driveFilesMapped = driveFiles.map(f => ({
                    ...f,
                    normName: robustNormalize(f.name),
                    normNameNoExt: robustNormalize(f.name.replace(/\.pdf$/i, ''))
                }));

                console.log(`Matching start: ${targetJobs.length} jobs to scan against ${driveFiles.length} drive files.`);

                for (const job of targetJobs) {
                    const dbName = robustNormalize(job.pdf_filename);
                    if (!dbName) continue;
                    const dbNameNoExt = robustNormalize(job.pdf_filename.replace(/\.pdf$/i, ''));

                    const matchedFile = driveFilesMapped.find(f => {
                        return f.normName === dbName ||
                            f.normNameNoExt === dbName ||
                            f.normName === dbNameNoExt ||
                            f.normNameNoExt === dbNameNoExt;
                    });

                    if (matchedFile) {
                        const updateData = {
                            id: job.id
                        };
                        updateData[driveCol] = matchedFile.url;
                        updates.push(updateData);
                        matchCount++;
                        console.log(`Match Found: "${job.pdf_filename}" -> "${matchedFile.name}"`);
                    } else {
                        if (matchCount < 10) {
                            console.log(`No match: DB="${dbName}" (original: "${job.pdf_filename}")`);
                        }
                    }
                }

                if (updates.length === 0) {
                    console.warn('Sync aborted: No files matched.', {
                        db_samples: targetJobs.slice(0, 5).map(j => j.pdf_filename),
                        drive_samples: driveFiles.slice(0, 5).map(f => f.name)
                    });
                    alert('Google„Éâ„É©„Ç§„ÉñÂÜÖ„Å´‰∏ÄËá¥„Åô„Çã„Éï„Ç°„Ç§„É´Âêç„ÅÆPDF„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ\n\nÁ¢∫Ë™ç„Éù„Ç§„É≥„Éà:\n1. Ê±Ç‰∫∫„Å´ÁôªÈå≤„Åï„Çå„Åü„Äå„Éï„Ç°„Ç§„É´Âêç„Äç„Å®Drive„ÅÆ„Éï„Ç°„Ç§„É´Âêç„ÅåÂÆåÂÖ®„Å´‰∏ÄËá¥„Åó„Å¶„ÅÑ„Çã„ÅãÔºàÊã°ÂºµÂ≠ê.pdf„ÅÆÊúâÁÑ°„ÅØËá™ÂãïË£úÂÆå„Åï„Çå„Åæ„ÅôÔºâ„ÄÇ\n2. Ë©≤ÂΩì„Åô„ÇãÊ±Ç‰∫∫„ÅÆ„ÄåÊ±Ç‰∫∫URL„Äç„ÅåÊó¢„Å´Âüã„Åæ„Å£„Å¶„ÅÑ„Å™„ÅÑ„ÅãÔºàURL„ÅåÁ©∫„ÅÆ„ÇÇ„ÅÆ„ÅÆ„ÅøÂêåÊúü„Åï„Çå„Åæ„ÅôÔºâ„ÄÇ\n\nË©≥Á¥∞„ÅØÈñãÁô∫ËÄÖ„ÉÑ„Éº„É´„ÅÆ„Ç≥„É≥„ÇΩ„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }

                // 4. ÂÄãÂà•„Å´Êõ¥Êñ∞
                console.log(`DEBUG: Starting sync for ${updates.length} jobs using column: ${driveCol}`);
                let successCount = 0;
                let failCount = 0;
                let lastError = null;

                for (const update of updates) {
                    const { id, ...data } = update;
                    // organization_id„ÅØÊõ¥Êñ∞ÂØæË±°„Åã„ÇâÂ§ñ„ÅôÔºàRLS„ÅÆUSINGÂè•„Å´„ÅØÊÆã„Çã„Åå„ÄÅupdateÂØæË±°„Å´Âê´„ÇÅ„Å™„ÅÑÊñπ„ÅåÂÆâÂÖ®„Å™Â†¥Âêà„Åå„ÅÇ„ÇãÔºâ
                    delete data.organization_id;

                    const { error: updateError } = await supabase
                        .from('jobs')
                        .update(data)
                        .eq('id', id);

                    if (updateError) {
                        console.error(`Update failed for job ${id}:`, updateError);
                        lastError = updateError;
                        failCount++;
                    } else {
                        successCount++;
                    }
                }

                if (successCount > 0) {
                    alert(`${successCount}‰ª∂„ÅÆÊ±Ç‰∫∫„Å´„Éï„Ç°„Ç§„É´URL„ÇíÂêåÊúü„Åó„Åæ„Åó„Åü„ÄÇ${failCount > 0 ? `\nÔºà${failCount}‰ª∂„ÅØ„Ç®„É©„Éº„Å´„Çà„ÇäÊõ¥Êñ∞„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„Ç≥„É≥„ÇΩ„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ` : ''}`);
                    if (typeof loadAdminJobs === 'function') {
                        loadAdminJobs(window.currentAdminJobPage || 1);
                    }
                } else if (failCount > 0) {
                    const errorMsg = lastError?.message || '';
                    if (errorMsg.includes('column') && errorMsg.includes('does not exist')) {
                        alert(`„Ç®„É©„Éº: „Éá„Éº„Çø„Éô„Éº„Çπ„Å´„Ç´„É©„É†„Äå${driveCol}„Äç„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ\n\nÁêÜÁî±: ÁµÑÁπîË®≠ÂÆö„ÅÆ„Äå‰øùÂ≠òÂÖà„Ç´„É©„É†Âêç„Äç„Åå„Äå${driveCol}„Äç„Å´Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„Åå„ÄÅDB„Å´„ÅØÂ≠òÂú®„Åó„Åæ„Åõ„Çì„ÄÇ\nÂØæÁ≠ñ: 1.ÁµÑÁπîË®≠ÂÆö„Çí„Äåpdf_url„Äç„Å´Â§âÊõ¥„Åô„Çã„ÄÅ„Åæ„Åü„ÅØ 2.DB„Å´„Äå${driveCol}„Äç„Ç´„É©„É†„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                    } else {
                        alert(`ÂêåÊúü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ‰ª•Ââç„ÅÆ„Ç®„É©„Éº: ${errorMsg}`);
                    }
                }

            } catch (err) {
                console.error('Sync Drive URL Error:', err);
                const msg = err.message || '‰∏çÊòé„Å™„Ç®„É©„Éº';
                if (msg.includes('column') && msg.includes('does not exist')) {
                    alert(`„Ç®„É©„Éº: „Éá„Éº„Çø„Éô„Éº„Çπ„Å´„Ç´„É©„É†„Äå${driveCol}„Äç„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇÁµÑÁπîË®≠ÂÆö„ÅßÊ≠£„Åó„ÅÑ„Ç´„É©„É†Âêç„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                } else {
                    alert(`ÂêåÊúüÂá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${msg}`);
                }
            } finally {
                hideLoading();
            }
        };

        window.applyDriveFileFilters = function () {
            const searchText = $('#drive-filter-search').val().toLowerCase();
            const dateFrom = $('#drive-filter-date-from').val();
            const sortType = $('#drive-filter-sort').val();

            let filtered = [...window.driveFilesCache];

            // 1. „ÉÜ„Ç≠„Çπ„ÉàÊ§úÁ¥¢
            if (searchText) {
                filtered = filtered.filter(f => f.name.toLowerCase().includes(searchText));
            }

            // 2. Êó•‰ªòÊ§úÁ¥¢ (Êõ¥Êñ∞Êó•„ÅåÊåáÂÆöÊó•‰ª•Èôç„ÅÆ„ÇÇ„ÅÆ)
            if (dateFrom) {
                const fromTs = new Date(dateFrom).getTime();
                filtered = filtered.filter(f => new Date(f.modified).getTime() >= fromTs);
            }

            // 3. „ÇΩ„Éº„Éà
            if (sortType === 'newest') {
                filtered.sort((a, b) => new Date(b.modified) - new Date(a.modified));
            } else if (sortType === 'oldest') {
                filtered.sort((a, b) => new Date(a.modified) - new Date(b.modified));
            } else if (sortType === 'name') {
                filtered.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
            }

            renderDriveFileList(filtered);
            updateDriveImportCount();

            // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞Âæå„ÅÆÂÖ®ÈÅ∏ÊäûÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
            $('#drive-file-select-all').prop('checked', false);
        };

        window.toggleDriveAllCheckboxes = function (checked) {
            $('input[name="drive-file-item"]:visible').prop('checked', checked);
            updateDriveImportCount();
        };

        function renderDriveFileList(files) {
            const container = $('#drive-file-list');
            container.empty();
            $('#drive-file-list-count').text(`${files.length}‰ª∂„ÅÆ„Éï„Ç°„Ç§„É´`);
            files.forEach(file => {
                container.append(`
                    <div class="bg-white border rounded-lg p-3 flex items-center gap-3 hover:border-blue-400 cursor-pointer transition">
                        <input type="checkbox" name="drive-file-item" data-id="${file.id}" data-name="${file.name}" class="h-5 w-5 text-blue-600" onchange="updateDriveImportCount()">
                        <div class="flex-1 min-w-0" onclick="$(this).siblings('input').click()">
                            <div class="font-bold text-gray-900 truncate text-sm">${file.name}</div>
                            <div class="flex items-center gap-2 mt-0.5">
                                <span class="text-[10px] text-blue-600 font-medium bg-blue-50 px-1.5 rounded border border-blue-100">
                                    <i class="far fa-calendar-alt mr-1"></i>${new Date(file.modified).toLocaleDateString()}
                                </span>
                                <span class="text-[10px] text-gray-500">
                                    <i class="far fa-file mr-1"></i>${(file.size / 1024).toFixed(0)} KB
                                </span>
                            </div>
                        </div>
                        <a href="${file.url}" target="_blank" class="text-gray-400 hover:text-blue-600"><i class="fas fa-external-link-alt text-xs"></i></a>
                    </div>
                `);
            });
        }

        window.updateDriveImportCount = function () {
            const count = $('input[name="drive-file-item"]:checked').length;
            $('#drive-import-count').text(`${count}‰ª∂ÈÅ∏Êäû`);
            $('#execute-drive-import-btn').prop('disabled', count === 0);
        };

        window.executeDriveImport = async function () {
            const selected = [];
            $('input[name="drive-file-item"]:checked').each(function () { selected.push({ id: $(this).data('id'), name: $(this).data('name') }); });
            if (selected.length === 0) return;
            if (!confirm(`${selected.length}‰ª∂„ÅÆ„Éï„Ç°„Ç§„É´„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åô„ÅãÔºü`)) return;

            const orgSettings = getOrgSettings();
            showLoading('Google„Éâ„É©„Ç§„Éñ„Åã„Çâ„Ç§„É≥„Éù„Éº„Éà‰∏≠...');

            importResultSuccessFiles = [];
            importResultErrorFiles = [];
            pendingBulkJobs = [];

            try {
                const options = { job_categories: typeof masterJobCategories !== 'undefined' ? masterJobCategories : [], industry_categories: typeof masterIndustries !== 'undefined' ? masterIndustries : [] };
                const bulkConfirmEnabled = orgSettings.bulk_duplicate_confirm_enabled === true;

                for (let i = 0; i < selected.length; i++) {
                    const f = selected[i];
                    $('#drive-import-status p').text(`„Äê${i + 1}/${selected.length}„ÄëËß£Êûê‰∏≠: ${f.name}`);
                    try {
                        const res = await fetch(orgSettings.drive_import_gas_url, { method: 'POST', mode: 'cors', body: JSON.stringify({ action: 'get_file', fileId: f.id }), headers: { 'Content-Type': 'text/plain;charset=utf-8' } });
                        const data = await res.json();
                        if (data.status !== 'success') throw new Error(data.message);

                        const bin = atob(data.base64);
                        const bytes = new Uint8Array(bin.length);
                        for (let j = 0; j < bin.length; j++) bytes[j] = bin.charCodeAt(j);
                        const pdf = await pdfjsLib.getDocument({ data: bytes }).promise;
                        let text = '';
                        for (let p = 1; p <= pdf.numPages; p++) {
                            const pg = await pdf.getPage(p);
                            const tc = await pg.getTextContent();
                            text += tc.items.map(it => it.str).join(' ') + '\n';
                        }
                        if (!text.trim()) throw new Error('PDF„Åã„Çâ„ÉÜ„Ç≠„Çπ„Éà„ÇíÊäΩÂá∫„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„ÅüÔºà„Çπ„Ç≠„É£„É≥ÁîªÂÉè„Å™„Å©„ÅÆÂèØËÉΩÊÄßÔºâ');

                        const fakeFile = { name: f.name, size: bytes.length, driveUrl: data.url };
                        await processParsedJobText(text, fakeFile, options, true);

                        if (!bulkConfirmEnabled) {
                            importResultSuccessFiles.push(f.name);
                        }
                    } catch (e) {
                        console.error(e);
                        importResultErrorFiles.push({ name: f.name, message: e.message });
                    }
                }
                $('#drive-import-modal').addClass('hidden');
                if (bulkConfirmEnabled && pendingBulkJobs.length > 0) {
                    renderBulkConfirmList();
                    $('#job-bulk-confirm-modal').removeClass('hidden');
                }
                else {
                    showImportResult(importResultSuccessFiles, importResultErrorFiles);
                    loadAdminJobs();
                }
            } catch (err) { alert('„Ç®„É©„Éº: ' + err.message); } finally { hideLoading(); }
        }

        // --- Ê±Ç‰∫∫‰∏ÄÊã¨„Ç§„É≥„Éù„Éº„ÉàÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´Áî®Èñ¢Êï∞ ---
        window.closeJobBulkConfirmModal = function () {
            if (pendingBulkJobs.length > 0 && !confirm('Á¢∫Ë™çÂæÖ„Å°„ÅÆÊ±Ç‰∫∫„Åå„ÅÇ„Çä„Åæ„Åô„Åå„ÄÅËß£Èô§„Åó„Åæ„Åô„ÅãÔºü')) {
                return;
            }
            $('#job-bulk-confirm-modal').addClass('hidden');
            pendingBulkJobs = [];
        }

        window.renderBulkConfirmList = function () {
            const container = $('#job-bulk-list');
            container.empty();

            pendingBulkJobs.forEach((item, index) => {
                const duplicates = item.duplicates || [];
                const maxScore = duplicates.length > 0 ? Math.max(...duplicates.map(d => d._duplicateScore || 0)) : 0;
                const hasDuplicate = maxScore >= 3;

                let cardClass = "bg-white border rounded-lg p-4 shadow-sm hover:border-indigo-300 transition";
                let badgeHtml = '<span class="px-2 py-0.5 bg-green-100 text-green-700 text-[10px] rounded font-bold">Ëß£ÊûêÂÆå‰∫Ü</span>';

                if (maxScore === 4) {
                    cardClass = "border-red-300 bg-red-50 p-4 rounded-lg shadow-sm transition";
                    badgeHtml = '<span class="px-2 py-0.5 bg-red-600 text-white text-[10px] rounded font-bold">„Çπ„Ç≠„ÉÉ„ÉóÊé®Â•®</span>';
                } else if (maxScore === 3) {
                    cardClass = "border-orange-300 bg-orange-50 p-4 rounded-lg shadow-sm transition";
                    badgeHtml = '<span class="px-2 py-0.5 bg-red-500 text-white text-[10px] rounded font-bold">Ë¶ÅÁ¢∫Ë™ç</span>';
                } else if (maxScore === 2) {
                    cardClass = "border-teal-300 bg-teal-50 p-4 rounded-lg shadow-sm transition";
                    badgeHtml = '<span class="px-2 py-0.5 bg-teal-600 text-white text-[10px] rounded font-bold">ÁôªÈå≤ÂØæË±°</span>';
                }

                const dupHtml = hasDuplicate
                    ? item.duplicates.map(d => `
                        <div class="mb-4 last:mb-0">
                            <div class="text-red-600 font-bold text-xs flex items-center gap-1">
                                <i class="fas fa-database opacity-70"></i>
                                ÈáçË§áÂÄôË£ú: ${d.company} / ${d.title}
                            </div>
                            ${renderJobComparisonTable(item.result, d)}
                        </div>
                    `).join('')
                    : '';

                const html = `
                    <div class="${cardClass}">
                        <label class="flex items-start cursor-pointer">
                            <input type="checkbox" name="bulk-job-item" data-index="${index}" class="form-checkbox h-5 w-5 text-indigo-600 rounded mt-1 mr-4" onchange="updateBulkSelectCount()" ${!hasDuplicate ? 'checked' : ''}>
                            <div class="flex-1">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex items-center gap-2">
                                        <h4 class="font-bold text-gray-900 overflow-hidden text-ellipsis">${item.result.company} / ${item.result.title}</h4>
                                        ${badgeHtml}
                                    </div>
                                    <div class="flex items-center gap-2">
                                        ${item.file.driveUrl ? `<a href="${item.file.driveUrl}" target="_blank" class="text-blue-600 hover:text-blue-800 text-xs"><i class="fab fa-google-drive mr-1"></i>Drive</a>` : ''}
                                        <span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded truncate ml-2">üìÑ ${item.file.name}</span>
                                    </div>
                                </div>
                                <div class="text-xs text-gray-500 space-y-1">
                                    <div><i class="fas fa-map-marker-alt mr-1"></i>${item.result.location || '-'}</div>
                                    ${hasDuplicate ? `
                                    <div class="mt-3 pt-3 border-t border-dashed border-red-200">
                                        <p class="font-bold text-red-600 text-[10px] mb-2">
                                            <i class="fas fa-exclamation-triangle mr-1"></i>„Ç∑„Çπ„ÉÜ„É†ÂÜÖ„Å´È°û‰ºº„Åó„ÅüÊ±Ç‰∫∫„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü:
                                        </p>
                                        <div class="mt-1">
                                            ${dupHtml}
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                                ${hasDuplicate ? `
                                <div class="mt-3 p-3 bg-gray-50 rounded-lg border border-gray-100 flex items-center justify-between">
                                    <span class="text-xs font-bold text-gray-700">ÁôªÈå≤ÊñπÊ≥ï„ÇíÈÅ∏Êäû:</span>
                                    <div class="flex gap-4">
                                        <label class="flex items-center gap-1.5 cursor-pointer">
                                            <input type="radio" name="bulk-job-action-${index}" value="update" checked class="form-radio h-4 w-4 text-indigo-600">
                                            <span class="text-xs font-medium text-gray-600">Êó¢Â≠ò„ÇíÊõ¥Êñ∞</span>
                                        </label>
                                        <label class="flex items-center gap-1.5 cursor-pointer">
                                            <input type="radio" name="bulk-job-action-${index}" value="insert" class="form-radio h-4 w-4 text-indigo-600">
                                            <span class="text-xs font-medium text-gray-600">Êñ∞Ë¶èÁôªÈå≤</span>
                                        </label>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </label>
                    </div>
                `;
                container.append(html);
            });
            updateBulkSelectCount();
        }

        window.updateBulkSelectCount = function () {
            const count = $('input[name="bulk-job-item"]:checked').length;
            const total = pendingBulkJobs.length;
            $('#job-bulk-count').text(`${total}‰ª∂‰∏≠ ${count}‰ª∂ÈÅ∏Êäû`);
            $('#job-bulk-select-all').prop('checked', count === total && total > 0);
        }

        window.toggleAllBulkJobs = function (checked) {
            $('input[name="bulk-job-item"]').prop('checked', checked);
            updateBulkSelectCount();
        }

        window.executeBulkJobImport = async function () {
            const selectedIndexes = [];
            $('input[name="bulk-job-item"]:checked').each(function () {
                selectedIndexes.push(parseInt($(this).data('index')));
            });

            if (selectedIndexes.length === 0) {
                alert('ÁôªÈå≤„Åô„ÇãÊ±Ç‰∫∫„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            if (!confirm(`${selectedIndexes.length}‰ª∂„ÅÆÊ±Ç‰∫∫„ÇíÁôªÈå≤„Åó„Åæ„Åô„ÅãÔºü`)) return;

            // showLoading('ÈÅ∏Êäû„Åó„ÅüÊ±Ç‰∫∫„ÇíÁôªÈå≤‰∏≠...'); // ÊóßË°®Á§∫
            showImportProgress('Ê±Ç‰∫∫„ÅÆÁôªÈå≤Âá¶ÁêÜ', `${selectedIndexes.length}‰ª∂„ÅÆÊ±Ç‰∫∫„ÇíÁôªÈå≤„Åó„Å¶„ÅÑ„Åæ„Åô...`);
            addImportStep('bulk-reg', 'Ê±Ç‰∫∫„Éá„Éº„Çø„ÅÆÁôªÈå≤');
            setImportStepStatus('bulk-reg', 'active');

            try {
                let processedCount = 0;
                const totalCount = selectedIndexes.length;

                for (const idx of selectedIndexes) {
                    const item = pendingBulkJobs[idx];
                    const { result, file, jobData: precalcJobData } = item;

                    // ÈÄ≤ÊçóË°®Á§∫„ÅÆÊõ¥Êñ∞
                    const currentPercent = (processedCount / totalCount) * 100;
                    updateImportProgress(currentPercent, processedCount, totalCount);
                    $('#import-progress-subtitle').text(`${totalCount}‰ª∂‰∏≠ ${processedCount + 1}‰ª∂ÁõÆ„ÇíÂá¶ÁêÜ„Åó„Å¶„ÅÑ„Åæ„Åô...`);
                    processedCount++;

                    let jobData = precalcJobData;
                    if (!jobData) {
                        // ÂæåÊñπ‰∫íÊèõÊÄß„Åæ„Åü„ÅØÂÆâÂÖ®Á≠ñÔºöÂÜçË®àÁÆó„Åæ„Åü„ÅØ‰ª•Ââç„ÅÆ„É≠„Ç∏„ÉÉ„ÇØ
                        let companyId = null;
                        const { data: existingCompany } = await supabase
                            .from('companies')
                            .select('id')
                            .eq('organization_id', currentUser.organization_id)
                            .eq('name', result.company)
                            .maybeSingle();

                        if (existingCompany) {
                            companyId = existingCompany.id;
                        } else {
                            const { data: newCompany } = await supabase
                                .from('companies')
                                .insert({
                                    organization_id: currentUser.organization_id,
                                    name: result.company,
                                    location: result.location
                                })
                                .select()
                                .maybeSingle();
                            if (newCompany) companyId = newCompany.id;
                        }

                        jobData = {
                            organization_id: currentUser.organization_id,
                            title: result.title,
                            company_id: companyId,
                            company: result.company,
                            location: result.location || 'Êú™ÂÆö',
                            salary_min: result.salary_min || null,
                            salary_max: result.salary_max || null,
                            description: result.description || '',
                            requirements: result.requirements || '',
                            welcome_requirements: result.welcome_requirements || '',
                            employment_type: result.employment_type || 'Ê≠£Á§æÂì°',
                            is_remote: result.is_remote || false,
                            pdf_filename: file.name,
                            status: 'active'
                        };
                    }

                    // Google Drive Ëª¢ÈÄÅÔºàË®≠ÂÆö„Åå„ÅÇ„Çå„Å∞„ÄÅÊó¢Â≠òURL„Åå„Å™„Åë„Çå„Å∞Ôºâ
                    const orgSettings = getOrgSettings();
                    let driveCol = orgSettings.drive_column || 'pdf_url';
                    // „Äåpdf„Äç„ÇÑ„Äåurl„Äç„Å™„Å©„ÅÆÂè§„ÅÑÂêçÁß∞„ÇíÊúÄÊñ∞„ÅÆ„Äåpdf_url„Äç„Å´Áµ±‰∏Ä
                    if (driveCol === 'pdf' || driveCol === 'url') driveCol = 'pdf_url';

                    let driveUrl = file.driveUrl || null;
                    if (!driveUrl && orgSettings.drive_transfer_enabled && orgSettings.drive_gas_url) {
                        try {
                            console.log(`[Bulk] Transferring ${file.name} to Drive...`);
                            driveUrl = await transferFileToGoogleDrive(file, orgSettings.drive_gas_url);
                        } catch (e) {
                            console.error('Drive transfer failed in bulk confirm:', e);
                        }
                    }

                    if (driveUrl) {
                        console.log(`[Bulk] setting ${driveCol} to ${driveUrl}`);
                        jobData[driveCol] = driveUrl;
                    }

                    // ÈáçË§áÁñë„ÅÑ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„Ç¢„ÉÉ„Éó„Çµ„Éº„ÉàÂà§ÂÆö
                    const action = $(`input[name="bulk-job-action-${idx}"]:checked`).val() || 'insert';
                    const duplicateId = (item.duplicates && item.duplicates.length > 0 && action === 'update') ? item.duplicates[0].id : null;

                    if (duplicateId) {
                        // Êó¢Â≠òÊ±Ç‰∫∫„ÅÆÂèñÂæó
                        const { data: existingJob, error: fetchError } = await supabase
                            .from('jobs')
                            .select('*')
                            .eq('id', duplicateId)
                            .single();

                        if (fetchError) {
                            console.error('Failed to fetch existing job for update:', fetchError);
                            importResultErrorFiles.push({ name: file.name, message: `Êó¢Â≠òÊ±Ç‰∫∫„ÅÆÂèñÂæó„Å´Â§±Êïó: ${fetchError.message}` });
                            continue;
                        }

                        // „Éû„Éº„Ç∏Âá¶ÁêÜ (Êõ¥Êñ∞Áî®„Éö„Ç§„É≠„Éº„Éâ„ÅÆ‰ΩúÊàê)
                        const updatePayload = mergeJobData(jobData, existingJob);
                        const { error: updateError } = await supabase
                            .from('jobs')
                            .update(updatePayload)
                            .eq('id', duplicateId);

                        if (updateError) {
                            console.error('Update error for job:', result.title, updateError);
                            importResultErrorFiles.push({ name: file.name, message: updateError.message });
                        } else {
                            importResultSuccessFiles.push(file.name);
                        }
                    } else {
                        // Êñ∞Ë¶èÁôªÈå≤
                        const { error } = await supabase.from('jobs').insert(jobData);
                        if (error) {
                            console.error('Bulk import error for job:', result.title, error);
                            importResultErrorFiles.push({ name: file.name, message: error.message });
                        } else {
                            importResultSuccessFiles.push(file.name);
                        }
                    }
                }

                // ÊúÄÁµÇÈÄ≤ÊçóÊõ¥Êñ∞
                updateImportProgress(100, totalCount, totalCount);
                setImportStepStatus('bulk-reg', 'done');

                // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÁµêÊûúË°®Á§∫
                await new Promise(resolve => setTimeout(resolve, 500));

                showImportResult(importResultSuccessFiles, importResultErrorFiles);
                pendingBulkJobs = [];
                $('#job-bulk-confirm-modal').addClass('hidden');
                loadAdminJobs();
            } catch (err) {
                console.error('executeBulkJobImport error:', err);
                alert('‰∏ÄÊã¨ÁôªÈå≤‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            } finally {
                // hideLoading();
                hideImportProgress();
            }
        }



        // Dashboard
        // ========================
        let dashboardChartInstances = {};
        let currentDashboardPeriod = 'month';

        async function loadDashboard() {
            if (!currentUser) return

            // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíË°®Á§∫
            $('#user-name').text(currentUser.name)
            $('#user-role').text(getRoleLabel(currentUser.role))
            $('#org-name').text(currentUser.organizations?.name || '')
            $('#org-code-display').text(currentUser.organizations?.code ? `„Ç≥„Éº„Éâ: ${currentUser.organizations.code}` : '')

            const contentArea = $('#dashboard-content');
            contentArea.empty(); // ÂÖ®‰Ωì„Çí„ÇØ„É™„Ç¢„Åó„Å¶ÂÜçÊßãÁØâ

            // 1. KPI Stats Area
            const statsGrid = $('<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" id="dashboard-stats"></div>');
            contentArea.append(statsGrid);

            // 2. Charts Area (Agent only)
            const isAgent = ['super_admin', 'org_admin', 'admin', 'coach', 'ca', 'ra'].includes(currentUser.role);
            if (isAgent) {
                const controlsHtml = `
                    <div class="flex flex-wrap justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800"><i class="fas fa-chart-line mr-2"></i>ÈÄ≤Êçó„ÉªÊ≠©Áïô„Åæ„ÇäÂàÜÊûê</h3>
                        <div class="flex gap-2 bg-gray-100 p-1 rounded-lg">
                            <button onclick="changeDashboardPeriod('day')" class="px-4 py-1 rounded-md text-sm font-medium transition ${currentDashboardPeriod === 'day' ? 'bg-white text-indigo-600 shadow' : 'text-gray-500 hover:text-gray-700'}">Êó•Ê¨°</button>
                            <button onclick="changeDashboardPeriod('week')" class="px-4 py-1 rounded-md text-sm font-medium transition ${currentDashboardPeriod === 'week' ? 'bg-white text-indigo-600 shadow' : 'text-gray-500 hover:text-gray-700'}">ÈÄ±Ê¨°</button>
                            <button onclick="changeDashboardPeriod('month')" class="px-4 py-1 rounded-md text-sm font-medium transition ${currentDashboardPeriod === 'month' ? 'bg-white text-indigo-600 shadow' : 'text-gray-500 hover:text-gray-700'}">ÊúàÊ¨°</button>
                            <button onclick="changeDashboardPeriod('year')" class="px-4 py-1 rounded-md text-sm font-medium transition ${currentDashboardPeriod === 'year' ? 'bg-white text-indigo-600 shadow' : 'text-gray-500 hover:text-gray-700'}">Âπ¥Ê¨°</button>
                        </div>
                    </div>
                `;
                contentArea.append(controlsHtml);

                const chartGrid = $(`
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8" id="dashboard-charts">
                        <div class="bg-white rounded-lg shadow p-6">
                            <h4 class="font-bold text-gray-700 mb-4">Â∑•Á®ãÂà• Ê≠©Áïô„Åæ„Çä („Éï„Ç°„Éç„É´)</h4>
                            <canvas id="funnelChart"></canvas>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <h4 class="font-bold text-gray-700 mb-4">Á¥ØÁ©çÊé®Áßª („Éà„É¨„É≥„Éâ)</h4>
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                `);
                contentArea.append(chartGrid);
            }

            // Load Data & Render
            try {
                // --- KPI Cards Logic (Same as before) ---
                if (['super_admin', 'org_admin', 'admin'].includes(currentUser.role)) {
                    const { count: jobCount } = await supabase.from('jobs').select('*', { count: 'exact', head: true }).eq('organization_id', currentUser.organization_id).eq('status', 'active');
                    const { count: userCount } = await supabase.from('users').select('*', { count: 'exact', head: true }).eq('organization_id', currentUser.organization_id).eq('role', 'user');
                    const { count: appCount } = await supabase.from('applications').select('*', { count: 'exact', head: true }).eq('organization_id', currentUser.organization_id);

                    renderDashboardCards(statsGrid, [
                        { label: 'ÊúâÂäπÊ±Ç‰∫∫‰ª∂Êï∞', value: jobCount || 0, icon: 'fa-briefcase', color: 'indigo' },
                        { label: 'ÁôªÈå≤Ê±ÇËÅ∑ËÄÖÊï∞', value: userCount || 0, icon: 'fa-users', color: 'green' },
                        { label: 'Á∑èÂøúÂãüÊï∞', value: appCount || 0, icon: 'fa-file-alt', color: 'purple' }
                    ]);
                } else if (['coach', 'ca', 'ra'].includes(currentUser.role)) {
                    const { data: assignedUsers } = await supabase.from('users').select('id').eq('coach_id', currentUser.id);
                    const assignedUserIds = assignedUsers?.map(u => u.id) || [];
                    let candidateAppCount = 0;
                    if (assignedUserIds.length > 0) {
                        const { count } = await supabase.from('applications').select('*', { count: 'exact', head: true }).in('user_id', assignedUserIds);
                        candidateAppCount = count || 0;
                    }
                    const { count: aiRecoCount } = await supabase.from('recommendations').select('*', { count: 'exact', head: true }).eq('created_by', currentUser.id);
                    renderDashboardCards(statsGrid, [
                        { label: 'ÊãÖÂΩìÊ±ÇËÅ∑ËÄÖÊï∞', value: assignedUserIds.length, icon: 'fa-user-friends', color: 'indigo' },
                        { label: 'ÊãÖÂΩìËÄÖ„ÅÆÂøúÂãüÊï∞', value: candidateAppCount, icon: 'fa-file-contract', color: 'green' },
                        { label: 'AIÊé®Ëñ¶ÂÆüÊñΩÊï∞', value: aiRecoCount || 0, icon: 'fa-robot', color: 'pink' }
                    ]);
                } else {
                    const { count: appCount } = await supabase.from('applications').select('*', { count: 'exact', head: true }).eq('user_id', currentUser.id);
                    const { count: recoCount } = await supabase.from('recommendations').select('*', { count: 'exact', head: true }).eq('user_id', currentUser.id);
                    renderDashboardCards(statsGrid, [
                        { label: 'ÂøúÂãü‰∏≠„ÅÆÊ±Ç‰∫∫', value: appCount || 0, icon: 'fa-file-alt', color: 'indigo' },
                        { label: '„ÅÇ„Å™„Åü„Å∏„ÅÆAIÊé®Ëñ¶', value: recoCount || 0, icon: 'fa-star', color: 'purple' },
                        { label: 'Èñ≤Ë¶ß„Åó„ÅüÊ±Ç‰∫∫', value: '-', icon: 'fa-eye', color: 'gray' }
                    ]);
                }

                // --- Charts Rendering Logic ---
                if (isAgent) {
                    await renderDashboardCharts();
                    // --- Agent Specific Sections (Interviews & Yomi) ---
                    await renderAgentDashboardSections(contentArea);
                }

            } catch (error) {
                console.error('Dashboard load error:', error);
                statsGrid.html('<p class="col-span-3 text-red-500 text-center py-4">„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>');
            }
        }

        window.changeDashboardPeriod = (period) => {
            currentDashboardPeriod = period;
            loadDashboard(); // Reload (Optimally should only reload charts, but strict implementation needs clean state)
        };

        async function renderDashboardCharts() {
            // Êó¢Â≠ò„ÉÅ„É£„Éº„Éà„ÅÆÁ†¥Ê£Ñ
            if (dashboardChartInstances.funnel) dashboardChartInstances.funnel.destroy();
            if (dashboardChartInstances.trend) dashboardChartInstances.trend.destroy();

            // Safety Check
            if (typeof Chart === 'undefined') {
                console.error('Dashboard: Chart.js library is not loaded');
                return;
            }
            if (!document.getElementById('funnelChart') || !document.getElementById('trendChart')) {
                console.error('Dashboard: Chart canvas elements not found');
                return;
            }

            // 1. „Éû„Çπ„Çø„Éá„Éº„ÇøÂèñÂæó (ÈÄ≤Êçó„Çπ„ÉÜ„Éº„Çø„Çπ)
            let { data: statusMasters } = await supabase
                .from('master_data')
                .select('*')
                .eq('type', 'application_status')
                .order('sort_order', { ascending: true });

            // „Éû„Çπ„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
            if (!statusMasters || statusMasters.length === 0) {
                statusMasters = [
                    { label: 'Êõ∏È°ûÈÅ∏ËÄÉ', value: 'Êõ∏È°ûÈÅ∏ËÄÉ‰∏≠', sort_order: 10 },
                    { label: '‰∏ÄÊ¨°Èù¢Êé•', value: '‰∏ÄÊ¨°Èù¢Êé•‰∫àÂÆö', sort_order: 40 },
                    { label: '‰∫åÊ¨°Èù¢Êé•', value: '‰∫åÊ¨°Èù¢Êé•‰∫àÂÆö', sort_order: 60 },
                    { label: 'ÊúÄÁµÇÈù¢Êé•', value: 'ÊúÄÁµÇÈù¢Êé•‰∫àÂÆö', sort_order: 80 },
                    { label: 'ÂÜÖÂÆö', value: 'ÂÜÖÂÆö', sort_order: 100 }
                ];
            }
            // ÁµÑÁπî„Éï„Ç£„É´„Çø„Éª„Ç∞„É≠„Éº„Éê„É´Èô§Â§ñ„Å™„Å©„ÅÆ„É≠„Ç∏„ÉÉ„ÇØ„ÅØÁ∞°ÊòìÂåñÔºàÂÖ®ÂèñÂæóÊ∏à„Éá„Éº„Çø„Çí‰ΩøÁî®Ôºâ
            // ÁµÑÁπîID„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞„Åô„ÇãÂ†¥Âêà„ÅØ .eq('organization_id', currentUser.organization_id) ÂøÖË¶Å„Å†„Åå„ÄÅ
            // ‰∏äË®ò„ÇØ„Ç®„É™„Åß„ÅØ„Ç∞„É≠„Éº„Éê„É´„ÇÇÂèñ„Å£„Å¶„Åè„ÇãÂøÖË¶Å„Åå„ÅÇ„Çã„ÅÆ„Åß„ÄÅJSÂÅ¥„Åß„Éï„Ç£„É´„Çø„ÅåÂÆâÂÖ®„ÄÇ
            statusMasters = statusMasters.filter(m => m.organization_id === currentUser.organization_id || m.is_global);


            // 2. ÂøúÂãü„Éá„Éº„ÇøÂèñÂæó (ÂÖ®ÈáèÂèñÂæó„Åó„Å¶JSÈõÜË®à - „Éá„Éº„ÇøÈáè„ÅåÂ§ö„ÅÑÂ†¥Âêà„ÅØRPCÊé®Â•®)
            // 'created_at' does not exist in applications table, using 'applied_at' instead.
            let query = supabase.from('applications').select('applied_at, status, updated_at');

            if (currentUser.role === 'coach' || currentUser.role === 'ca') {
                // „Ç≥„Éº„ÉÅ„ÅÆÂ†¥Âêà„ÅØÊãÖÂΩì„É¶„Éº„Ç∂„Éº„ÅÆ„Åø
                const { data: assignedUsers } = await supabase.from('users').select('id').eq('coach_id', currentUser.id);
                const ids = assignedUsers?.map(u => u.id) || [];
                if (ids.length > 0) query = query.in('user_id', ids);
                else query = query.eq('id', '00000000-0000-0000-0000-000000000000'); // No hits
            } else {
                query = query.eq('organization_id', currentUser.organization_id);
            }

            // ÊúüÈñì„Éï„Ç£„É´„Çø
            const now = new Date();
            let startDate = new Date();
            if (currentDashboardPeriod === 'day') startDate.setDate(now.getDate() - 7); // Áõ¥Ëøë7Êó•
            else if (currentDashboardPeriod === 'week') startDate.setMonth(now.getMonth() - 1); // Áõ¥Ëøë4ÈÄ±
            else if (currentDashboardPeriod === 'month') startDate.setMonth(now.getMonth() - 6); // Áõ¥Ëøë6„É∂Êúà
            else if (currentDashboardPeriod === 'year') startDate.setFullYear(now.getFullYear() - 1); // Áõ¥Ëøë1Âπ¥

            query = query.gte('applied_at', startDate.toISOString());

            const { data: applications, error } = await query;

            if (error) {
                console.error('Dashboard: Applications fetch error:', error);
                $('#dashboard-charts').prepend('<div class="col-span-2 text-red-500 bg-red-50 p-4 rounded">„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº: ' + error.message + '</div>');
                // „Ç®„É©„ÉºË©≥Á¥∞„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆ„Éí„É≥„Éà„ÇíËøΩÂä†
                if (error.code === '42703') { // Undefined column
                    $('#dashboard-charts').prepend('<div class="col-span-2 text-yellow-600 bg-yellow-50 p-2 rounded text-sm mt-2">„Éí„É≥„Éà: „Ç´„É©„É†„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇDB„Çπ„Ç≠„Éº„Éû„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</div>');
                }
                return;
            }

            if (!applications || applications.length === 0) {
                console.log('Dashboard: No applications data found for this period');
                // „Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„Åß„ÇÇÁ©∫„ÅÆ„ÉÅ„É£„Éº„Éà„ÇíË°®Á§∫„Åô„Çã„Åã„ÄÅ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫„Åô„Çã
                // „Åì„Åì„Åß„ÅØÂá¶ÁêÜ„ÇíÁ∂öË°å„Åó„Å¶Á©∫„ÅÆ„ÉÅ„É£„Éº„Éà„ÇíË°®Á§∫„Åï„Åõ„ÇãÔºà0‰ª∂„ÅÆÁ¢∫Ë™ç„ÅÆ„Åü„ÇÅÔºâ
            } else {
                console.log('Dashboard: Applications loaded:', applications.length);
            }

            // ÂÆâÂÖ®Á≠ñ: null„ÅÆÂ†¥Âêà„ÅØÁ©∫ÈÖçÂàó„Å´„Åô„Çã
            const validApplications = applications || [];

            // --- ÈõÜË®à„É≠„Ç∏„ÉÉ„ÇØ ---

            // A. „Éï„Ç°„Éç„É´ÈõÜË®à (ÂçòÁ¥î„Å™„Çπ„ÉÜ„Éº„Çø„Çπ„Ç´„Ç¶„É≥„Éà„Åã„Çâ„ÅÆÁ¥ØÁ©çÊé®Ë®à)
            // „Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆsort_orderÈ†Ü„Å´‰∏¶„Åπ„Çã
            statusMasters.sort((a, b) => a.sort_order - b.sort_order);

            // „Çπ„ÉÜ„Éº„Çø„Çπ„Åî„Å®„ÅÆ‰ª∂Êï∞
            const statusCounts = {};
            validApplications.forEach(app => {
                // ÈÉ®ÂàÜ‰∏ÄËá¥„Å™„Å©„ÅßÊüîËªü„Å´„Éû„ÉÉ„ÉÅ„É≥„Ç∞
                const match = statusMasters.find(m => app.status === m.value || app.status?.includes(m.value));
                const key = match ? match.label : '„Åù„ÅÆ‰ªñ';
                statusCounts[key] = (statusCounts[key] || 0) + 1;
            });

            // Á¥ØÁ©çË®àÁÆó (Á∞°Êòì„É≠„Ç∏„ÉÉ„ÇØ: sort_order„ÅåÂæå„Çç„ÅÆ„ÇÇ„ÅÆ„ÅØÂâç„ÅÆ„ÇÇ„ÅÆ„ÇÇÈÄöÈÅé„Åó„Åü„Å®‰ªÆÂÆö)
            // ‚ÄªÊ≥®ÊÑè: '‰∏çÂêàÊ†º' 'ËæûÈÄÄ' „Å™„Å©„ÅÆ„Éç„Ç¨„ÉÜ„Ç£„Éñ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÈô§Â§ñ„Åô„Çã„Åã„ÄÅ„Åù„Çå„Çâ„Çí 'Âà∞ÈÅî„Åó„ÅüÊúÄÈ´ò„Éï„Çß„Éº„Ç∫' „Å®„Åó„Å¶Êâ±„ÅÜ„Åã„ÄÇ
            // „Åì„Åì„Åß„ÅØ„Ç∑„É≥„Éó„É´„Å´‰∏ªË¶Å„Éï„Çß„Éº„Ç∫„ÇíË°®Á§∫ÂØæË±°„Å®„Åô„Çã„ÄÇ
            const displayPhases = statusMasters.filter(m => m.sort_order <= 120); // ÂÖ•Á§æÁ¢∫Ë™ç„Åæ„Åß
            const funnelLabels = displayPhases.map(m => m.label);
            const funnelData = displayPhases.map((phase, idx) => {
                // „Åì„ÅÆ„Éï„Çß„Éº„Ç∫‰ª•Èôç„ÅÆ„Åô„Åπ„Å¶„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆÂêàË®à („Åì„ÅÆ„Éï„Çß„Éº„Ç∫„Å´Âà∞ÈÅî„Åó„ÅüÁ∑èÊï∞)
                // ÂÆüÈöõ„Å´„ÅØ„Äå‰∏çÂêàÊ†º„Äç„Å™„Å©„ÇÇËÄÉÊÖÆ„Åô„Åπ„Åç„Å†„Åå„ÄÅ‰∏çÂêàÊ†º„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆsort_order„Åå200Áï™Âè∞„Å™„Çâ„ÄÅ
                // Êõ∏È°û‰∏çÂêàÊ†º(200)„ÅØÊõ∏È°ûÈÄöÈÅé(30)„Å´Âê´„Åæ„Çå„Å™„ÅÑ„ÄÇ
                // Á∞°ÊòìÁöÑ„Å´„ÄåÁ¥ØÁ©ç„Äç„Å®„Åó„Å¶„ÉÅ„É£„Éº„Éà„Å´„Åô„Çã„ÄÇ

                // „Åì„Åì„Åß„ÅØ„ÄåÁèæÂú®„Åù„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„Å´„ÅÇ„ÇãÊï∞„Äç„Çí„Åæ„ÅöÂá∫„Åô
                // const count = applications.filter(a => a.status === phase.value).length;
                // return count;

                // Ë¶Å‰ª∂„ÅØ„ÄåÂ∑•Á®ã„Åî„Å®„ÅÆÊ≠©Áïô„Åæ„Çä„Äç„Å™„ÅÆ„Åß„ÄÅ„ÄåÈÄöÈÅéÊï∞„Äç„Éô„Éº„Çπ„ÅåÊúõ„Åæ„Åó„ÅÑ„ÄÇ
                // Á∞°Êòì„É≠„Ç∏„ÉÉ„ÇØ: sort_order„ÅåËá™ÂàÜ‰ª•‰∏ä„ÅÆ„É¨„Ç≥„Éº„ÉâÊï∞„ÇíÂêàË®à„Åô„Çã
                const passedCount = validApplications.filter(a => {
                    const m = statusMasters.find(mst => mst.value === a.status);
                    return m && m.sort_order >= phase.sort_order;
                }).length;
                return passedCount;
            });

            // Ê≠©Áïô„Åæ„ÇäÁéáË®àÁÆó (Áõ¥Ââç„Å®ÊØîËºÉ)
            // const yieldRates = funnelData.map((val, i) => i === 0 ? '100%' : Math.round((val / funnelData[i-1])*100) + '%');

            dashboardChartInstances.funnel = new Chart(document.getElementById('funnelChart'), {
                type: 'bar',
                data: {
                    labels: funnelLabels,
                    datasets: [{
                        label: 'Âà∞ÈÅîÊï∞(Á¥ØÁ©ç)',
                        data: funnelData,
                        backgroundColor: 'rgba(79, 70, 229, 0.6)',
                        borderColor: 'rgb(79, 70, 229)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterLabel: function (context) {
                                    const val = context.raw;
                                    const prev = context.dataset.data[context.dataIndex - 1]; // Ââç„ÅÆ„Éï„Çß„Éº„Ç∫
                                    if (context.dataIndex === 0 || !prev) return 'ÈñãÂßã';
                                    const rate = Math.round((val / prev) * 100);
                                    return `Ê≠©Áïô„Åæ„Çä: ${rate}%`;
                                }
                            }
                        }
                    }
                }
            });

            // B. „Éà„É¨„É≥„ÉâÈõÜË®à (ÊúàÊ¨°/ÈÄ±Ê¨° Êé®Áßª)
            // ÊúüÈñì„Åî„Å®„ÅÆ„É©„Éô„É´ÁîüÊàê
            const trendLabels = [];
            const trendDataMap = { 'all': [] }; // Á∑èÂøúÂãüÊï∞Êé®Áßª
            // ‰∏ªË¶Å„Éï„Çß„Éº„Ç∫„Åî„Å®„ÅÆÊé®Áßª„ÇÇÂá∫„Åó„Åü„ÅÑ„Åå„ÄÅ„É≠„Ç∞„Åå„Å™„ÅÑ„ÅÆ„Åß„Äå„ÅÑ„Å§Â§â„Çè„Å£„Åü„Åã„Äç‰∏çÊòé„ÄÇ
            // „Åó„Åü„Åå„Å£„Å¶„Éà„É¨„É≥„Éâ„ÅØ„ÄåÂøúÂãüÁô∫ÁîüÊó•„Éô„Éº„Çπ„ÅÆÂøúÂãüÊï∞„Äç„ÅÆ„ÅøÊ≠£Á¢∫„Å´Âá∫„Åõ„Çã„ÄÇ

            // Âçò‰Ωç„Åî„Å®„ÅÆÈõÜË®à
            const dateMap = {};
            validApplications.forEach(app => {
                // Use applied_at for date calculation
                const d = new Date(app.applied_at || app.updated_at); // Fallback to updated_at if applied_at is null
                let key = '';
                if (currentDashboardPeriod === 'day') key = `${d.getMonth() + 1}/${d.getDate()}`;
                else if (currentDashboardPeriod === 'week') {
                    // ÈÄ±Áï™Âè∑„Å™„Å© (Á∞°ÊòìÁöÑ„Å´Êúà/ÈÄ±)
                    const week = Math.ceil(d.getDate() / 7);
                    key = `${d.getMonth() + 1}ÊúàÁ¨¨${week}ÈÄ±`;
                }
                else if (currentDashboardPeriod === 'month') key = `${d.getFullYear()}/${d.getMonth() + 1}`;
                else if (currentDashboardPeriod === 'year') key = `${d.getFullYear()}`;

                dateMap[key] = (dateMap[key] || 0) + 1;
            });

            // ÊôÇÈñìÈ†Ü„Å´„ÇΩ„Éº„Éà„Åó„Å¶ÈÖçÂàóÂåñ
            const sortedKeys = Object.keys(dateMap).sort(); // ÊñáÂ≠óÂàó„ÇΩ„Éº„Éà„Å†„ÅåYYYY/MMÁ≥ª„Å™„ÇâÊ¶Ç„Å≠OK
            // ‚ÄªÊó•‰ªòÈ†Ü„ÇΩ„Éº„Éà„ÅØÂé≥ÂØÜ„Å´„ÅØDate„Éë„Éº„Çπ„ÅåÂøÖË¶Å„Å†„ÅåÁúÅÁï•

            dashboardChartInstances.trend = new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: {
                    labels: sortedKeys,
                    datasets: [{
                        label: 'Êñ∞Ë¶èÂøúÂãüÊï∞',
                        data: sortedKeys.map(k => dateMap[k]),
                        borderColor: 'rgb(16, 185, 129)',
                        tension: 0.1,
                        fill: true,
                        backgroundColor: 'rgba(16, 185, 129, 0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        async function renderAgentDashboardSections(container) {
            // Èù¢Êé•‰∫àÂÆö„Çª„ÇØ„Ç∑„Éß„É≥
            const interviewSection = $(`
                <div class="mb-10">
                    <h3 class="text-xl font-bold text-gray-800 mb-5 flex items-center">
                        <i class="far fa-calendar-check mr-3 text-orange-500 text-2xl"></i>Áõ¥Ëøë„ÅÆÈù¢Êé•‰∫àÂÆö
                    </h3>
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-100">
                                <thead class="bg-gray-50/50">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-[11px] font-bold text-gray-400 uppercase tracking-wider">Êó•Á®ã</th>
                                        <th class="px-6 py-4 text-left text-[11px] font-bold text-gray-400 uppercase tracking-wider">Ê±ÇËÅ∑ËÄÖÂêç</th>
                                        <th class="px-6 py-4 text-left text-[11px] font-bold text-gray-400 uppercase tracking-wider">Ê±Ç‰∫∫ / ‰ºÅÊ•≠</th>
                                        <th class="px-6 py-4 text-left text-[11px] font-bold text-gray-400 uppercase tracking-wider">ÈÅ∏ËÄÉÊÉÖÂ†±„Éª„É°„É¢</th>
                                        <th class="px-6 py-4 text-right text-[11px] font-bold text-gray-400 uppercase tracking-wider">Ë©≥Á¥∞</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-50" id="dashboard-interview-list">
                                    <tr><td colspan="5" class="px-6 py-12 text-center text-gray-400">
                                        <div class="flex flex-col items-center">
                                            <i class="fas fa-circle-notch fa-spin text-2xl mb-3 text-indigo-200"></i>
                                            <span class="text-sm">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</span>
                                        </div>
                                    </td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `);
            container.append(interviewSection);

            // „É®„Éü„Éª„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÊ°à‰ª∂„Çª„ÇØ„Ç∑„Éß„É≥
            const yomiSection = $(`
                <div class="mb-10">
                    <div class="flex justify-between items-end mb-5">
                        <h3 class="text-xl font-bold text-gray-800 flex items-center">
                            <i class="fas fa-funnel-dollar mr-3 text-indigo-500 text-2xl"></i>„Éû„Ç§„Éª„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÊ°à‰ª∂ („É®„ÉüÁÆ°ÁêÜ)
                        </h3>
                        <div class="flex gap-4">
                            <div class="text-right">
                                <p class="text-[10px] font-bold text-gray-400 uppercase">ÊãÖÂΩìÂàÜ Ë¶ãËæº„ÅøÂ£≤‰∏ä</p>
                                <p class="text-lg font-bold text-indigo-600" id="dashboard-my-yomi-revenue">¬•0</p>
                            </div>
                        </div>
                    </div>
                    <div id="dashboard-yomi-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Loading placeholder -->
                        <div class="col-span-full bg-gray-50 rounded-2xl border-2 border-dashed border-gray-100 p-12 text-center text-gray-400">
                             <i class="fas fa-spinner fa-spin text-xl mb-2"></i><br>
                             Ë™≠„ÅøËæº„Åø‰∏≠...
                        </div>
                    </div>
                </div>
            `);
            container.append(yomiSection);

            try {
                // „Éá„Éº„Çø„ÅÆÂèñÂæó
                // 1. ÊãÖÂΩìÊ±ÇËÅ∑ËÄÖ„ÅÆID„É™„Çπ„Éà„ÇíÂèñÂæó
                const { data: assignedUsers } = await supabase.from('users').select('id').eq('coach_id', currentUser.id);
                const assignedUserIds = assignedUsers?.map(u => u.id) || [];

                if (assignedUserIds.length === 0) {
                    $('#dashboard-interview-list').html('<tr><td colspan="5" class="px-6 py-12 text-center text-gray-400">ÁèæÂú®„ÅÆÊãÖÂΩìÊ±ÇËÅ∑ËÄÖ„ÅØ„ÅÑ„Åæ„Åõ„Çì</td></tr>');
                    $('#dashboard-yomi-content').html('<div class="col-span-full bg-gray-50 rounded-2xl border-2 border-dashed border-gray-100 p-12 text-center text-gray-400">„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™Ê°à‰ª∂„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>');
                    return;
                }

                // 2. Ê°à‰ª∂„Éá„Éº„Çø„ÅÆÂèñÂæó (ÊãÖÂΩìËÄÖ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞)
                const { data: apps, error } = await supabase
                    .from('applications')
                    .select(`
                        id, 
                        status, 
                        expected_revenue, 
                        probability_rate, 
                        interview_scheduled_at, 
                        selection_info,
                        jobs (title, company),
                        users!applications_user_id_fkey (name)
                    `)
                    .in('user_id', assignedUserIds)
                    .not('status', 'ilike', 'ÈÅ∏ËÄÉÁµÇ‰∫Ü%')
                    .not('status', 'eq', 'ËæûÈÄÄ')
                    .not('status', 'eq', '‰∏çÂêàÊ†º')
                    .not('status', 'eq', 'ÂÖ•Á§æÁ¢∫Ë™çÊ∏à')
                    .not('status', 'eq', 'NG')
                    .order('interview_scheduled_at', { ascending: true });

                if (error) {
                    console.error('Supabase query error:', error);
                    throw error;
                }

                // --- Èù¢Êé•„É™„Çπ„Éà„ÅÆÊèèÁîª ---
                const interviews = apps.filter(a => a.interview_scheduled_at).sort((a, b) => new Date(a.interview_scheduled_at) - new Date(b.interview_scheduled_at));
                const interviewListBody = $('#dashboard-interview-list');
                if (interviews.length === 0) {
                    interviewListBody.html('<tr><td colspan="5" class="px-6 py-12 text-center text-gray-400">‰∫àÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÈù¢Êé•„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</td></tr>');
                } else {
                    interviewListBody.empty();
                    interviews.forEach(app => {
                        const d = new Date(app.interview_scheduled_at);
                        const dateStr = d.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric', weekday: 'short' });
                        const timeStr = d.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

                        const row = `
                            <tr class="hover:bg-indigo-50/30 transition-colors">
                                <td class="px-6 py-4">
                                    <div class="flex flex-col">
                                        <span class="text-sm font-bold text-gray-900">${dateStr}</span>
                                        <span class="text-xs font-medium text-indigo-600">${timeStr}</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm font-bold text-gray-800">${app.users.name}</div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm font-bold text-gray-700 truncate max-w-[180px]" title="${app.jobs.title}">${app.jobs.title}</div>
                                    <div class="text-[11px] text-gray-400 truncate max-w-[180px]">${app.jobs.company}</div>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-xs text-gray-600 line-clamp-2 max-w-[220px]" title="${app.selection_info || ''}">
                                        ${app.selection_info ? `<i class="fas fa-info-circle text-indigo-300 mr-1"></i>${app.selection_info}` : '<span class="text-gray-300">Êú™ÂÖ•Âäõ</span>'}
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <button onclick="openProgressModal('${app.id}')" class="inline-flex items-center px-3 py-1.5 border border-indigo-100 text-xs font-bold rounded-lg text-indigo-600 bg-indigo-50 hover:bg-indigo-100 transition-colors">
                                        ÁÆ°ÁêÜ
                                    </button>
                                </td>
                            </tr>
                        `;
                        interviewListBody.append(row);
                    });
                }

                // --- „É®„ÉüÁä∂Ê≥Å„ÅÆÊèèÁîª ---
                const yomiContent = $('#dashboard-yomi-content');
                let totalExpectedRevenue = 0;

                if (apps.length === 0) {
                    yomiContent.html('<div class="col-span-full bg-gray-50 rounded-2xl border-2 border-dashed border-gray-100 p-12 text-center text-gray-400">ÁèæÂú®„ÄÅÂãï„ÅÑ„Å¶„ÅÑ„ÇãÊ°à‰ª∂„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>');
                } else {
                    yomiContent.empty();
                    apps.forEach(app => {
                        const rev = app.expected_revenue || 0;
                        const prob = app.probability_rate || 0;
                        totalExpectedRevenue += (rev * prob / 100);

                        const revStr = new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(rev);
                        const statusLabel = getSelectionStatusLabel(app.status || 'applied');

                        // „Çπ„ÉÜ„Éº„Çø„Çπ„Å´Âøú„Åò„ÅüËâ≤ (Tailwind safe classes)
                        let statusColorClass = 'bg-gray-50 text-gray-600 border-gray-100';
                        if (app.status?.includes('Èù¢Êé•')) statusColorClass = 'bg-orange-50 text-orange-600 border-orange-100';
                        else if (app.status?.includes('Êõ∏È°û')) statusColorClass = 'bg-blue-50 text-blue-600 border-blue-100';
                        else if (app.status?.includes('ÂÜÖÂÆö')) statusColorClass = 'bg-green-50 text-green-600 border-green-100';

                        const card = `
                            <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md hover:border-indigo-100 transition-all group cursor-pointer" onclick="openProgressModal('${app.id}')">
                                <div class="flex justify-between items-start mb-4">
                                    <span class="text-[10px] font-bold px-2 py-0.5 rounded-full ${statusColorClass} border">
                                        ${statusLabel}
                                    </span>
                                    <div class="text-right">
                                        <p class="text-[9px] font-bold text-gray-300 uppercase tracking-tighter">Á®ºÂÉçÁ¢∫Â∫¶</p>
                                        <p class="text-sm font-bold text-indigo-500">${prob}%</p>
                                    </div>
                                </div>
                                <h4 class="font-bold text-gray-800 text-base mb-1 group-hover:text-indigo-600 transition-colors">${app.users.name}</h4>
                                <div class="text-[11px] text-gray-500 truncate mb-4">${app.jobs.company} / ${app.jobs.title}</div>
                                
                                <div class="flex items-center justify-between pt-4 border-t border-gray-50">
                                    <div>
                                        <p class="text-[9px] font-bold text-gray-300 uppercase">Ë¶ãËæº„ÅøÂ£≤‰∏ä</p>
                                        <p class="text-sm font-bold text-gray-700">${revStr}</p>
                                    </div>
                                    <i class="fas fa-chevron-right text-gray-200 group-hover:text-indigo-300 transition-colors"></i>
                                </div>
                            </div>
                        `;
                        yomiContent.append(card);
                    });
                }

                $('#dashboard-my-yomi-revenue').text(new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(totalExpectedRevenue));

            } catch (err) {
                console.error('Agent dashboard load error:', err);
                $('#dashboard-interview-list').html('<tr><td colspan="5" class="px-6 py-12 text-center text-red-500">„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</td></tr>');
            }
        }

        // „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Ç´„Éº„ÉâÊèèÁîª„Éò„É´„Éë„ÉºÈñ¢Êï∞ (Â§âÊõ¥„Å™„Åó)
        function renderDashboardCards(container, cards) {
            const html = cards.map(c => `
                <div class="bg-white rounded-lg shadow p-6 transform transition hover:-translate-y-1 duration-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">${c.label}</p>
                            <p class="text-3xl font-bold text-${c.color}-600 mt-2">${c.value}</p>
                        </div>
                        <div class="w-12 h-12 bg-${c.color}-100 rounded-full flex items-center justify-center">
                            <i class="fas ${c.icon} text-${c.color}-600 text-xl"></i>
                        </div>
                    </div>
                </div>
            `).join('');

            container.html(html);
        }



        // ========================
        // Event Handlers
        // ========================
        // ========================
        // ÂØæË±°„É¶„Éº„Ç∂„ÉºÈÅ∏ÊäûÊ©üËÉΩ
        // ========================
        // Ê±ÇËÅ∑ËÄÖÈÅ∏Êäû„É¢„Éº„ÉÄ„É´Èñ¢ÈÄ£
        // ========================

        window.openCandidateSelectionModal = async function () {
            if (allCandidateUsers.length === 0) {
                await loadCandidateUsers();
            }
            renderModalCandidateList();
            $('#candidate-selection-modal').removeClass('hidden');
        };

        window.closeCandidateSelectionModal = function () {
            $('#candidate-selection-modal').addClass('hidden');
        };

        function renderModalCandidateList(filter = '') {
            const container = $('#modal-candidate-list');
            const users = allCandidateUsers.filter(u =>
                u.name.toLowerCase().includes(filter.toLowerCase()) ||
                (u.email && u.email.toLowerCase().includes(filter.toLowerCase()))
            );

            if (users.length === 0) {
                container.html('<p class="text-center py-4 text-gray-500 text-sm">Ë©≤ÂΩì„Åô„Çã„É¶„Éº„Ç∂„Éº„ÅØ„ÅÑ„Åæ„Åõ„Çì</p>');
                return;
            }

            const html = users.map(u => `
                <div onclick="selectCandidateFromModal('${u.id}', '${escapeHtml(u.name)}', '${escapeHtml(u.email)}')"
                    class="p-3 bg-white border rounded hover:border-indigo-500 hover:bg-indigo-50 cursor-pointer transition-colors flex justify-between items-center">
                    <div>
                        <div class="font-bold text-gray-900">${u.name}</div>
                        <div class="text-xs text-gray-500">${u.email || ''}</div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300"></i>
                </div>
            `).join('');
            container.html(html);
        }

        $('#modal-candidate-search').on('input', function () {
            renderModalCandidateList($(this).val());
        });

        window.selectCandidateFromModal = function (userId, userName, userEmail) {
            selectTargetUser(userId, userName, userEmail);
            closeCandidateSelectionModal();

            // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÊú¨Êù•„ÅÆÁ¥π‰ªã„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
            if (currentRecommendJobId) {
                setTimeout(() => {
                    openRecommendJobModal(currentRecommendJobId);
                }, 100);
            }
        };

        function escapeHtml(str) {
            if (!str) return '';
            return str
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // ÂÄôË£ú„É¶„Éº„Ç∂„Éº„É™„Çπ„Éà„ÇíË™≠„ÅøËæº„ÇÄ
        async function loadCandidateUsers() {
            if (!window.currentUser) return; // currentUser„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ

            try {
                let query = supabase
                    .from('users')
                    .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                    .eq('organization_id', window.currentUser.organization_id)
                    .in('role', ['candidate', 'user'])
                    .order('name', { ascending: true });

                // „Ç≥„Éº„ÉÅ„ÅÆÂ†¥Âêà„ÅØÊãÖÂΩì„É¶„Éº„Ç∂„Éº„ÅÆ„Åø„Å´Áµû„ÇäËæº„Åø
                if (window.currentUser.role === 'coach') {
                    query = query.eq('coach_id', window.currentUser.id);
                }

                const { data: users, error } = await query;

                if (error) throw error;

                // „Éï„É©„ÉÉ„ÉàÂåñ (candidate_profiles„ÅÆ‰∏≠Ë∫´„Çí„Éà„ÉÉ„Éó„É¨„Éô„É´„Å´„Éû„Éº„Ç∏)
                const flattenedUsers = (users || []).map(u => {
                    const profile = Array.isArray(u.candidate_profiles) ? u.candidate_profiles[0] : u.candidate_profiles;
                    const combined = { ...u, ...profile };
                    // ID„ÅØusers„ÅÆ„ÇÇ„ÅÆ„ÇíÂÑ™ÂÖà
                    combined.id = u.id;
                    return combined;
                });

                allCandidateUsers = flattenedUsers;
                targetUsersCache = flattenedUsers; // Êó¢Â≠ò„É≠„Ç∏„ÉÉ„ÇØ„Å®„ÅÆ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅ
                shouldReloadCandidates = false; // „Ç≠„É£„ÉÉ„Ç∑„É•Êõ¥Êñ∞ÂÆå‰∫Ü
                console.log('Loaded candidate users:', allCandidateUsers.length);
            } catch (error) {
                console.error('Failed to load candidate users:', error);
            }
        }

        // „É¶„Éº„Ç∂„Éº„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞„Åó„Å¶„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„Å´Ë°®Á§∫
        function filterAndShowTargetUsers(searchTerm, type = 'jobs') {
            const filtered = allCandidateUsers.filter(user => {
                if (user.status === 'suspended') return false;
                const name = (user.name || '').toLowerCase();
                const email = (user.email || '').toLowerCase();
                return name.includes(searchTerm) || email.includes(searchTerm);
            });

            const dropdownId = type === 'rec' ? '#rec-target-user-dropdown' :
                type === 'applicant' ? '#applicant-target-user-dropdown' :
                    '#target-user-dropdown';
            const dropdown = $(dropdownId);

            if (filtered.length === 0) {
                dropdown.html('<div class="p-3 text-gray-500 text-sm">Ë©≤ÂΩì„Åô„Çã„É¶„Éº„Ç∂„Éº„Åå„ÅÑ„Åæ„Åõ„Çì</div>').removeClass('hidden');
                return;
            }

            const html = filtered.map(user => `
                <div class="target-user-option" data-user-id="${user.id}">
                    <div class="user-name font-medium text-gray-800">${user.name || 'No Name'}</div>
                    <div class="user-email text-sm text-gray-500">${user.email || 'No Email'}</div>
                </div>
            `).join('');

            dropdown.html(html).removeClass('hidden');
        }

        // ÂØæË±°„É¶„Éº„Ç∂„Éº„ÇíÈÅ∏Êäû
        async function selectTargetUser(userId, userName, userEmail) {
            selectedTargetUserId = userId;
            selectedTargetUserName = userName;
            selectedTargetUserEmail = userEmail;

            // Global Header UI
            $('#global-selected-user-name').text(userName);

            // Jobs Page UI (Restored)
            $('#selected-user-name').html(`
                ${userName} 
                <button onclick="event.stopPropagation(); showAdminUserModal('${userId}')" class="ml-2 text-indigo-600 hover:text-indigo-800 text-xs bg-indigo-50 px-2 py-1 rounded border border-indigo-200 transition-colors">
                    <i class="fas fa-address-card mr-1"></i>Ë©≥Á¥∞
                </button>
            `);
            $('#selected-user-email').text(userEmail);
            $('#selected-user-display').removeClass('hidden');
            $('#target-user-dropdown').addClass('hidden');
            $('#target-user-search').val('');
            $('#target-user-input-wrapper').addClass('hidden');

            // Banners on other pages (Omitted for Recommendations as per user request)
            // $('#rec-selected-user-name-banner').text(userName);
            // $('#rec-selected-user-email-banner').text(userEmail);
            // $('#rec-selected-user-info-banner').removeClass('hidden');

            // --- Additional Actions ---
            $('#exclude-filters-container').removeClass('hidden');
            $('#exclude-matched-container').removeClass('hidden');
            $('#exclude-applied-container').removeClass('hidden');
            $('#select-top-30-btn').removeClass('hidden');

            // ÊúÄÊñ∞„ÅÆ„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Å¶Ê§úÁ¥¢Êù°‰ª∂„Å´„Çª„ÉÉ„Éà
            showLoading();
            try {
                const { data: userData, error } = await supabase
                    .from('users')
                    .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                    .eq('id', userId)
                    .single();

                if (userData) {
                    const profile = Array.isArray(userData.candidate_profiles) ? userData.candidate_profiles[0] : userData.candidate_profiles;
                    const user = { ...userData, ...profile };

                    console.log('Setting search filters from fresh user profile:', user);

                    // „Éï„Ç©„Éº„É†„Çí‰∏ÄÊó¶„É™„Çª„ÉÉ„Éà
                    $('#search-keyword').val('').trigger('input');
                    $('#tags-keyword').empty();
                    $('#search-location').val('');
                    $('#search-salary-min').val('');
                    $('#search-job-category').val(null).trigger('change');
                    $('#search-industry-category').val(null).trigger('change');
                    $('#search-employment-type').val(null).trigger('change');
                    $('#search-prefecture').val(null).trigger('change');
                    $('#search-job-experience-ok').prop('checked', false);
                    $('#search-industry-experience-ok').prop('checked', false);

                    // --- „É¶„Éº„Ç∂„Éº„ÅÆÂ∏åÊúõÊù°‰ª∂„Çí„Çª„ÉÉ„Éà ---

                    // „Éï„É™„Éº„ÉØ„Éº„ÉâÔºà„Ç≠„Éº„ÉØ„Éº„ÉâÔºâ„Çí„Çø„Ç∞„Å®„Åó„Å¶Â±ïÈñã
                    if (user.desired_freewords) {
                        const words = user.desired_freewords.split(/[,„ÄÅ\s]+/).map(s => s.trim()).filter(s => s.length > 0);
                        words.forEach(word => {
                            if (window.addKeywordTag) window.addKeywordTag(word);
                        });
                        $('#search-keyword').val(''); // ÂÖ•ÂäõÊ¨Ñ„ÅØÁ©∫„Å´„Åô„Çã
                    }

                    // AND/ORÊ§úÁ¥¢„É¢„Éº„ÉâÂèçÊò†
                    if (user.desired_freewords_condition) {
                        const cond = user.desired_freewords_condition.toUpperCase();
                        const $radio = $(`input[name="search-keyword-mode"][value="${cond}"]`);
                        if ($radio.length) {
                            $radio.prop('checked', true).trigger('change');
                            $radio.closest('label').click(); // Ë¶ã„ÅüÁõÆÊõ¥Êñ∞
                        }
                    }

                    // ËÅ∑Á®Æ
                    if (user.desired_job_type) {
                        const rawVals = window.safeParseList(user.desired_job_type);
                        // „Éû„Çπ„Çø„Éá„Éº„Çø„Å®„ÅÆ„ÅÇ„ÅÑ„Åæ„ÅÑ‰∏ÄËá¥„ÇíË©¶„Åø„Çã
                        const matchedVals = [];
                        rawVals.forEach(v => {
                            const match = typeof findClosestMasterValue === 'function' ? findClosestMasterValue(v, masterJobCategories) : null;
                            matchedVals.push(match || v);
                        });
                        const uniqueMatched = [...new Set(matchedVals)].filter(Boolean);
                        $('#search-job-category').val(uniqueMatched).trigger('change');
                    }

                    // Ê•≠Áïå
                    if (user.desired_industry) {
                        const rawVals = window.safeParseList(user.desired_industry);
                        const matchedVals = [];
                        rawVals.forEach(v => {
                            const match = typeof findClosestMasterValue === 'function' ? findClosestMasterValue(v, masterIndustries) : null;
                            matchedVals.push(match || v);
                        });
                        const uniqueMatched = [...new Set(matchedVals)].filter(Boolean);
                        $('#search-industry-category').val(uniqueMatched).trigger('change');
                    }

                    // ÈõáÁî®ÂΩ¢ÊÖã
                    if (user.desired_employment_type) {
                        const vals = window.safeParseList(user.desired_employment_type);
                        $('#search-employment-type').val(vals).trigger('change');
                    }

                    // Âã§ÂãôÂú∞
                    if (user.desired_location) {
                        const locs = window.safeParseList(user.desired_location);
                        const foundPrefs = [];
                        locs.forEach(loc => {
                            if (!loc) return;
                            // ÈÉΩÈÅìÂ∫úÁúå„Éû„Çπ„Çø„Å®„ÅÆÁÖßÂêàÔºàÈÉΩÈÅìÂ∫úÁúå„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Çã„Åã„ÄÅ„Åæ„Åü„ÅØÈÉΩÈÅìÂ∫úÁúåÂêç„Å´‰∏ÄËá¥„Åô„Çã„ÅãÔºâ
                            const pref = (window.prefectures || []).find(p =>
                                loc.includes(p) ||
                                p.includes(loc.replace(/[ÈÉΩÂ∫úÁúå]$/, ''))
                            );
                            if (pref) foundPrefs.push(pref);
                        });

                        if (foundPrefs.length > 0) {
                            const uniquePrefs = [...new Set(foundPrefs)];
                            $('#search-prefecture').val(uniquePrefs).trigger('change');
                            $('#search-location').val('');
                        }
                    }

                    // ÊúÄ‰ΩéÂπ¥Âèé
                    if (user.desired_salary) {
                        $('#search-salary-min').val(Math.floor(user.desired_salary / 10000));
                    }

                    // Êú™ÁµåÈ®ìOKÊù°‰ª∂
                    $('#search-job-experience-ok').prop('checked', !!user.desired_job_experience_ok);
                    $('#search-industry-experience-ok').prop('checked', !!user.desired_industry_experience_ok);
                }

                // Â∞ë„ÅóÂæÖÊ©ü„Åó„Å¶„Åã„ÇâÊ§úÁ¥¢ÂÆüË°å
                setTimeout(() => {
                    if (typeof executeSearch === 'function') {
                        executeSearch();
                    } else {
                        searchJobs();
                    }
                }, 100);

            } catch (err) {
                console.error('Error fetching fresh user profile:', err);
                searchJobs();
            } finally {
                hideLoading();
            }

            console.log('Selected target user:', userName, userId);
            updateBulkRecommendBar(); // „Éú„Çø„É≥Áä∂ÊÖãÊõ¥Êñ∞
        }

        // ÂØæË±°„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢
        function clearTargetUserSelection() {
            selectedTargetUserId = null;
            selectedTargetUserName = null;
            selectedTargetUserEmail = null;

            // Global Header UI
            $('#global-selected-user-name').text('ÂØæË±°„É¶„Éº„Ç∂„Éº„ÇíÈÅ∏Êäû');

            // Jobs Page (Restored)
            $('#selected-user-display').addClass('hidden');
            $('#target-user-input-wrapper').removeClass('hidden');
            $('#target-user-search').val('');

            // Hide banners (Omitted for Recommendations as per user request)
            // $('#rec-selected-user-info-banner').addClass('hidden');

            $('#select-top-30-btn').addClass('hidden');
            $('#search-exclude-matched').prop('checked', false);

            // Ê§úÁ¥¢„ÇíÂÜçÂÆüË°åÔºàÁèæÂú®„ÅÆ„Éö„Éº„Ç∏„Å´Âøú„Åò„Å¶Ôºâ
            if ($('#jobs-content').hasClass('active')) searchJobs();
            if ($('#recommendations-content').hasClass('active')) loadRecommendations();
            if ($('#admin-applicants-content').hasClass('active')) loadAdminApplicants();

            console.log('Cleared target user selection across all pages');
            updateBulkRecommendBar();
        }

        window.selectTargetUserAndGoToJobs = function (userId, userName, userEmail) {
            selectTargetUser(userId, userName, userEmail);
            showAppContent('jobs-content');
            // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„ÅÆË¶ã„ÅüÁõÆ„ÇÇÊõ¥Êñ∞
            $('.nav-link').removeClass('bg-indigo-50 text-indigo-600');
            $('.nav-link[data-page="jobs"]').addClass('bg-indigo-50 text-indigo-600');
        };

        // „Çπ„Éº„Éë„ÉºÁÆ°ÁêÜËÄÖÁî®ÔºöÁµÑÁπîÂàá„ÇäÊõø„ÅàÊ©üËÉΩ
        async function initOrgSwitcher() {
            try {
                // ÂÖ®ÁµÑÁπî„ÇíÂèñÂæó
                const { data: orgs, error } = await supabase
                    .from('organizations')
                    .select('id, name')
                    .order('name');

                if (error) throw error;

                const switcher = $('#org-switcher');
                switcher.empty();

                // Ëá™ÂàÜ„ÅÆÊâÄÂ±ûÁµÑÁπîÔºà„Éá„Éï„Ç©„É´„ÉàÔºâ„ÇÇÈÅ∏ÊäûËÇ¢„Å´Âê´„ÇÅ„Çã„Åã„ÄÅ„ÅÇ„Çã„ÅÑ„ÅØ„ÄåÈÅ∏ÊäûËß£Èô§„Äç„ÅßÊàª„Çã„Åã
                // „Åì„Åì„Åß„ÅØ„Ç∑„É≥„Éó„É´„Å´ÂÖ®ÁµÑÁπî„É™„Çπ„Éà„ÇíË°®Á§∫„Åó„ÄÅÁèæÂú®„ÅÆorganization_id„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„Çã

                orgs.forEach(org => {
                    const option = $('<option>').val(org.id).text(org.name);
                    if (org.id === currentUser.organization_id) {
                        option.prop('selected', true);
                    }
                    switcher.append(option);
                });

                // Ë°®Á§∫
                $('#org-switcher-container').removeClass('hidden');

                // Select2„ÇíÈÅ©Áî®
                switcher.select2({
                    width: '300px',
                    placeholder: 'ÁµÑÁπî„ÇíÈÅ∏Êäû...',
                    allowClear: false,
                    dropdownAutoWidth: true,
                    language: {
                        noResults: function () {
                            return "Ë¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì";
                        }
                    }
                });

                // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
                switcher.off('change').on('change', function () {
                    const newOrgId = $(this).val();
                    if (newOrgId) {
                        localStorage.setItem('super_admin_target_org_id', newOrgId);
                    } else {
                        localStorage.removeItem('super_admin_target_org_id');
                    }
                    // „É™„É≠„Éº„Éâ„Åó„Å¶Ë®≠ÂÆö„ÇíÂèçÊò†
                    location.reload();
                });

            } catch (error) {
                console.error('Failed to init org switcher:', error);
            }
        }

        $(document).ready(function () {
            // „É¢„Éº„ÉÄ„É´„ÅåÈùûË°®Á§∫„ÅÆË¶™Ë¶ÅÁ¥†ÂÜÖ„Å´Èñâ„ÅòËæº„ÇÅ„Çâ„Çå„Çã„ÅÆ„ÇíÈò≤„Åê„Åü„ÇÅ„ÄÅbodyÁõ¥‰∏ã„Å∏ÁßªÂãï
            $('#admin-job-csv-modal, #admin-user-csv-modal, #admin-company-csv-modal, #drive-import-modal, #data-merge-modal').appendTo('body');

            // Organization Code Validation
            $('#check-org-code').on('click', async function () {
                const code = $('#signup-org-code').val().trim();
                const errorEl = $('#org-code-error');
                const nameEl = $('#org-name-display');
                const inputEl = $('#signup-org-code');

                if (!code) {
                    errorEl.text('„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ').removeClass('hidden');
                    nameEl.addClass('hidden');
                    inputEl.removeClass('border-green-500 bg-green-50');
                    return;
                }

                try {
                    errorEl.addClass('hidden');
                    const { data, error } = await supabase.rpc('get_organization_name_by_code', { org_code: code });

                    if (error) throw error;

                    if (data && data.length > 0) {
                        nameEl.text(`ÂèÇÂä†ÁµÑÁπî: ${data[0].name}`).removeClass('hidden');
                        inputEl.addClass('border-green-500 bg-green-50');
                    } else {
                        errorEl.text('ÁÑ°Âäπ„Å™ÁµÑÁπî„Ç≥„Éº„Éâ„Åß„Åô').removeClass('hidden');
                        nameEl.addClass('hidden');
                        inputEl.removeClass('border-green-500 bg-green-50');
                    }
                } catch (err) {
                    console.error('Check Error:', err);
                    errorEl.text('Á¢∫Ë™ç‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü').removeClass('hidden');
                }
            });

            // „É≠„Ç∞„Ç§„É≥„Éï„Ç©„Éº„É†
            $('#login-form').on('submit', async function (e) {
                e.preventDefault()
                const email = $('#login-email').val().trim()
                const password = $('#login-password').val()
                await login(email, password)
            })

            // ÁôªÈå≤„Éï„Ç©„Éº„É†
            $('#signup-form').on('submit', async function (e) {
                e.preventDefault()
                const name = $('#signup-name').val().trim()
                const furigana = $('#signup-furigana').val().trim()
                const email = $('#signup-email').val().trim()
                const password = $('#signup-password').val()
                const token = $('#invitation-token').val()
                const orgCode = $('#signup-org-code').val().trim()
                await signup(name, furigana, email, password, token, orgCode)
            })


            // „É≠„Ç∞„Ç¢„Ç¶„Éà
            $('#logout-btn').on('click', logout)

            // ÈÄöÁü•„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥
            $('#notification-btn').on('click', function (e) {
                e.stopPropagation()
                $('#notification-dropdown').toggleClass('hidden')
                loadNotifications()
            })

            // „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
            $(document).on('click', function () {
                $('#notification-dropdown').addClass('hidden')
            })

            $('#notification-dropdown').on('click', function (e) {
                e.stopPropagation()
            })

            // Prevent admin user modal from closing when clicking inside
            $('#admin-user-modal').on('click', function (e) {
                // Only close if clicking on the backdrop (the modal itself, not its children)
                if (e.target === this) {
                    // Don't close automatically - user must click the X button or Cancel
                    e.stopPropagation();
                }
            });

            // Prevent clicks inside modal content from bubbling
            $('#admin-user-modal > div').on('click', function (e) {
                e.stopPropagation();
            });

            // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥
            $('#show-signup').on('click', function (e) {
                e.preventDefault()
                showPage('signup-page')
            })

            $('#show-login').on('click', function (e) {
                e.preventDefault()
                showPage('login-page')
            })

            // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥
            $('.nav-link').on('click', function (e) {
                e.preventDefault()
                const page = $(this).data('page')
                if (!page) return; // openFAQModal„Å™„Å©„ÅÆonclick‰ΩµÁî®„Éú„Çø„É≥„ÇíÁÑ°Ë¶ñ

                $('.nav-link').removeClass('bg-indigo-50 text-indigo-600')
                $(this).addClass('bg-indigo-50 text-indigo-600')

                showAppContent(`${page}-content`)
                $(document).trigger('page-switched', [page])

                if (page === 'jobs') {
                    // ‰øùÂ≠ò„Åï„Çå„ÅüÊ§úÁ¥¢Êù°‰ª∂„ÇíÈÅ©Áî®
                    const savedFilters = loadSearchFilters();
                    if (savedFilters) {
                        applySearchFilters(savedFilters);
                        loadJobs(savedFilters);
                    } else {
                        loadJobs();
                    }

                    // ÁÆ°ÁêÜËÄÖ„Éª„Ç≥„Éº„ÉÅ„ÅÆÂ†¥Âêà„ÄÅÂØæË±°„É¶„Éº„Ç∂„ÉºÈÅ∏ÊäûUI„ÇíË°®Á§∫
                    if (window.currentUser && ['org_admin', 'admin', 'super_admin', 'coach', 'ca'].includes(window.currentUser.role)) {
                        $('#global-target-user-nav').hide(); // „Ç∏„Éß„ÉñÁîªÈù¢„Åß„ÅØÈö†„Åô
                        if (allCandidateUsers.length === 0 || shouldReloadCandidates) {
                            loadCandidateUsers();
                        }

                        // „Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„Éº„ÅÆÁôªÈå≤ÔºàÂæìÊù•„ÅÆ„Éú„ÉÉ„ÇØ„ÇπÁî®Ôºâ
                        $('#target-user-search').off('input focus click').on('input focus click', function () {
                            const searchTerm = $(this).val().toLowerCase();
                            filterAndShowTargetUsers(searchTerm);
                        });

                        // „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥‰ª•Â§ñ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Åü„ÇâÈñâ„Åò„Çã
                        $(document).on('click', function (e) {
                            if (!$(e.target).closest('#target-user-input-wrapper').length && !$(e.target).closest('#target-user-dropdown').length) {
                                $('#target-user-dropdown').addClass('hidden');
                            }
                        });

                        $('#clear-user-selection').off('click').on('click', function () {
                            clearTargetUserSelection();
                        });

                        $(document).off('click', '.target-user-option').on('click', '.target-user-option', function () {
                            const userId = $(this).data('user-id');
                            const userName = $(this).find('.user-name').text();
                            const userEmail = $(this).find('.user-email').text();
                            selectTargetUser(userId, userName, userEmail);
                        });
                    }
                } else if (page === 'applications') {
                    loadApplications()
                } else if (page === 'recommendations') {
                    loadRecommendations()
                    if (window.currentUser && ['org_admin', 'admin', 'super_admin', 'coach', 'ca', 'ra'].includes(window.currentUser.role)) {
                        $('#global-target-user-nav').hide(); // „Åä„Åô„Åô„ÇÅÁîªÈù¢„Åß„ÅØÈö†„ÅôÔºà„É¶„Éº„Ç∂„Éº„ÅÆË¶ÅÊúõÔºâ
                    }
                } else if (page === 'admin-applicants') {
                    loadAdminApplicants()
                    if (window.currentUser && ['org_admin', 'admin', 'super_admin', 'coach', 'ca', 'ra'].includes(window.currentUser.role)) {
                        $('#global-target-user-nav').css('display', 'flex');
                        if (allCandidateUsers.length === 0) loadCandidateUsers();
                    }
                } else if (page === 'profile') {
                    loadProfile()
                } else if (page === 'admin-jobs') {
                    loadAdminJobs()
                } else if (page === 'admin-companies') {
                    loadCompanies()
                } else if (page === 'admin-applicants') {
                    loadAdminApplicants()
                } else if (page === 'admin-candidates') {
                    loadAdminCandidates()
                } else if (page === 'admin-users') {
                    loadAdminUsers()
                } else if (page === 'admin-csv') {
                    loadCSVHistory()
                } else if (page === 'admin-logs') {
                    loadAuditLogs()
                } else if (page === 'admin-settings') {
                    loadAdminSettings()
                } else if (page === 'admin-prompts') {
                    loadPrompts()
                } else if (page === 'admin-master') {
                    loadMasterData()
                } else if (page === 'super-admin-organizations') {
                    loadSuperAdminOrganizations()
                } else if (page === 'coach-students') {
                    loadCoachStudents()
                } else if (page === 'candidate-search') {
                    loadCandidateSearch()
                } else if (page === 'kpi-dashboard') {
                    loadKPIDashboard()
                } else if (page === 'ai-scout') {
                    // AI„Çπ„Ç´„Ç¶„Éà„Éö„Éº„Ç∏„ÅÆÂàùÊúüÂåñ
                    switchProfileAnalysisTab('new');
                }

                const titles = {
                    'dashboard': '„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ',
                    'jobs': 'Ê±Ç‰∫∫Ê§úÁ¥¢',
                    'ai-scout': 'AI„Çπ„Ç´„Ç¶„Éà',
                    'applications': 'ÂøúÂãü„ÉªÈÅ∏ËÄÉÁä∂Ê≥Å',
                    'recommendations': '„Åä„Åô„Åô„ÇÅÊ±Ç‰∫∫',
                    'profile': '„Éó„É≠„Éï„Ç£„Éº„É´',
                    'admin-jobs': 'Ê±Ç‰∫∫ÁÆ°ÁêÜ',
                    'admin-companies': '‰ºÅÊ•≠ÁÆ°ÁêÜ',
                    'admin-applicants': 'ÂøúÂãüËÄÖÁÆ°ÁêÜ',
                    'admin-candidates': 'Ê±ÇËÅ∑ËÄÖÁÆ°ÁêÜ',
                    'admin-users': '„É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ',
                    'admin-csv': 'CSV„Ç§„É≥„Éù„Éº„Éà',
                    'admin-logs': 'Êìç‰Ωú„É≠„Ç∞',
                    'admin-prompts': 'AI„Éó„É≠„É≥„Éó„ÉàË®≠ÂÆö',
                    'admin-master': '„Éû„Çπ„Çø„Éá„Éº„ÇøÁÆ°ÁêÜ',
                    'super-admin-organizations': 'ÁµÑÁπîÁÆ°ÁêÜ',
                    'coach-students': 'ÊãÖÂΩìÊ±ÇËÅ∑ËÄÖÁÆ°ÁêÜ',
                    'candidate-search': 'Ê±ÇËÅ∑ËÄÖÊ§úÁ¥¢',
                    'kpi-dashboard': 'KPI„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ',
                    'admin-settings': 'ÁµÑÁπî„ÉªÈÄöÁü•Ë®≠ÂÆö',
                    'admin-faqs': 'FAQ„Éª„Éû„Éã„É•„Ç¢„É´ÁÆ°ÁêÜ'
                }
                $('#page-title').text(titles[page] || page)
            })

            // „É¢„Éê„Ç§„É´„É°„Éã„É•„Éº
            // „É¢„Éê„Ç§„É´„É°„Éã„É•„ÉºÂà∂Âæ°
            function toggleSidebar() {
                $('.sidebar').toggleClass('open');
                $('#sidebar-overlay').toggleClass('active');
            }

            $('#mobile-menu-btn').on('click', function (e) {
                e.stopPropagation();
                toggleSidebar();
            });

            $('#sidebar-overlay').on('click', function () {
                toggleSidebar();
            });

            // „É°„Éã„É•„ÉºÈ†ÖÁõÆ„ÇØ„É™„ÉÉ„ÇØÊôÇ„Å´Èñâ„Åò„ÇãÔºà„É¢„Éê„Ç§„É´„ÅÆ„ÅøÔºâ
            $('.nav-link').on('click', function () {
                if ($(window).width() < 768) {
                    $('.sidebar').removeClass('open');
                    $('#sidebar-overlay').removeClass('active');
                }
            });

            // URL„Éë„É©„É°„Éº„Çø„Åã„ÇâÊãõÂæÖ„Éà„Éº„ÇØ„É≥„ÇíÂèñÂæó
            const urlParams = new URLSearchParams(window.location.search)
            const token = urlParams.get('token')
            if (token) {
                $('#invitation-token').val(token)
                showPage('signup-page')
            }

            // „Çª„ÉÉ„Ç∑„Éß„É≥„ÉÅ„Çß„ÉÉ„ÇØ
            supabase.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    // „Çª„ÉÉ„Ç∑„Éß„É≥„Åå„ÅÇ„ÇãÂ†¥Âêà„ÄÅ„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Å¶„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å∏
                    supabase
                        .from('users')
                        .select('*, organizations(*)')
                        .eq('id', session.user.id)
                        .single()
                        .then(async ({ data }) => {
                            if (data) {
                                // ÂøÖË¶Å„Å™„Éá„Éº„Çø„ÅØÊó¢„Å´users„ÉÜ„Éº„Éñ„É´„Å´„ÅÇ„Çã„Åü„ÇÅ„ÄÅËøΩÂä†„ÅÆ„Ç∏„Éß„Ç§„É≥„ÅØ‰∏çË¶Å
                            }

                            if (data) {
                                currentUser = data
                                window.currentUser = data;
                                console.log('Session restored for:', currentUser.name, 'Role:', currentUser.role);

                                // „Çπ„Éº„Éë„ÉºÁÆ°ÁêÜËÄÖ„ÅÆÂ†¥Âêà„ÄÅÁµÑÁπîÂàá„ÇäÊõø„Åà„É≠„Ç∏„ÉÉ„ÇØ„ÇíÈÅ©Áî®
                                if (currentUser.role === 'super_admin') {
                                    const targetOrgId = localStorage.getItem('super_admin_target_org_id');
                                    if (targetOrgId && targetOrgId !== currentUser.organization_id) {
                                        // Âàá„ÇäÊõø„ÅàÂÖà„ÅÆÁµÑÁπîÊÉÖÂ†±„ÇíÂèñÂæó
                                        const { data: targetOrg } = await supabase
                                            .from('organizations')
                                            .select('*')
                                            .eq('id', targetOrgId)
                                            .single();

                                        if (targetOrg) {
                                            // ÁµÑÁπîID„Å®ÁµÑÁπîÊÉÖÂ†±„Çí‰∏äÊõ∏„ÅçÔºà„É°„É¢„É™‰∏ä„ÅÆ„ÅøÔºâ
                                            currentUser.organization_id = targetOrgId;
                                            currentUser.organizations = targetOrg;
                                            console.log('Super Admin: Switched to organization', targetOrg.name, targetOrgId);
                                        }
                                    }
                                    // ÁµÑÁπîÂàá„ÇäÊõø„ÅàUI„ÅÆÂàùÊúüÂåñ
                                    initOrgSwitcher();
                                }

                                // UIÂèçÊò†
                                $('#user-name').text(currentUser.name);
                                $('#user-role').text(getRoleLabel(currentUser.role));
                                $('#org-name').text(currentUser.organizations ? currentUser.organizations.name : '');
                                $('#org-code-display').text(currentUser.organizations?.code ? `„Ç≥„Éº„Éâ: ${currentUser.organizations.code}` : '');

                                // „É°„Éã„É•„ÉºË°®Á§∫„ÅÆÊõ¥Êñ∞
                                updateMenuVisibility(currentUser.role);

                                // „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å∏

                                // loadDashboard„ÅÆÂëº„Å≥Âá∫„Åó„Çí„É≠„Éº„É´„ÅßÂàÜÂ≤ê
                                if (currentUser.role === 'candidate') {
                                    await loadJobs();
                                    showAppContent('jobs-content');
                                    // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„ÅÆ„Éè„Ç§„É©„Ç§„Éà
                                    $('.nav-link').removeClass('bg-indigo-50 text-indigo-600');
                                    $('.nav-link[data-page="jobs"]').addClass('bg-indigo-50 text-indigo-600');
                                } else {
                                    loadDashboard();
                                    // ÈÄöÂ∏∏„ÅÆ„Éï„É≠„Éº„Åß„ÅØshowPage('app-page')„Åß„Éá„Éï„Ç©„É´„Éà„ÅÆ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„ÅåË°®Á§∫„Åï„Çå„Çã„Åå„ÄÅÂøµ„ÅÆ„Åü„ÇÅ
                                    $('.nav-link[data-page="dashboard"]').addClass('bg-indigo-50 text-indigo-600');
                                }

                                loadNotifications()
                                initMasterDataDropdowns(); // „Éû„Çπ„Çø„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
                                showPage('app-page')
                                isInitialLoad = false;
                            }
                        })
                }
            })
        })
    </script>

    <!-- Scout Settings Modal -->
    <div id="scout-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
        style="z-index: 10001;">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-magic mr-2 text-indigo-600"></i>AI„Çπ„Ç´„Ç¶„ÉàÊñá‰ΩìË®≠ÂÆö
                </h2>
                <button onclick="closeScoutSettingsModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-6">
                <!-- Activation Toggle -->
                <div class="bg-indigo-50 border border-indigo-100 rounded-lg p-4 flex items-center justify-between">
                    <div>
                        <h3 class="font-bold text-indigo-900">Ëá™ÂàÜ„ÅÆÊñá‰Ωì„ÇíÈÅ©Áî®„Åô„Çã</h3>
                        <p class="text-xs text-indigo-700 mt-1">ON„Å´„Åô„Çã„Å®„ÄÅ„ÅÇ„Å™„Åü„ÅÆÊôÆÊÆµ„ÅÆ„É°„Éº„É´„ÇÑÈÅéÂéª„ÅÆ„Çπ„Ç´„Ç¶„ÉàÊñá„ÇíÂ≠¶Áøí„Åó„ÄÅAI„Åå„Äå„ÅÇ„Å™„Åü„Çâ„Åó„ÅÑ„ÄçÊñáÈù¢„ÇíÁîüÊàê„Åó„Åæ„Åô„ÄÇ
                        </p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="scout-style-active" class="sr-only peer">
                        <div
                            class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600">
                        </div>
                    </label>
                </div>

                <!-- Style Analysis Section -->
                <div>
                    <h3 class="font-bold text-gray-800 mb-2">ÊôÆÊÆµ„ÅÆ„É°„Éº„É´„Åã„ÇâÊñá‰Ωì„ÇíÂàÜÊûê„ÉªËá™ÂãïÁîüÊàê</h3>
                    <p class="text-sm text-gray-600 mb-4">
                        ÈÅéÂéª„Å´ÈÄÅ„Å£„Åü„Çπ„Ç´„Ç¶„Éà„É°„Éº„É´„ÇÑ„ÄÅÊôÆÊÆµ„ÅÆÊ•≠ÂãôÈÄ£Áµ°„Å™„Å©„Çí3‰ª∂‰ª•‰∏äÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„ÅÇ„Å™„Åü„ÅÆÂè£Ë™ø„ÄÅ‰∏ÅÂØß„Åï„ÅÆÂ∫¶Âêà„ÅÑ„ÄÅÊîπË°å„ÅÆ„ÇØ„Çª„Å™„Å©„ÇíAI„ÅåÂàÜÊûê„Åó„Åæ„Åô„ÄÇ
                    </p>

                    <div id="scout-examples-area" class="space-y-3 mb-4">
                        <textarea class="scout-example-input w-full border rounded p-2 text-sm h-20"
                            placeholder="‰æãÊñá1: „ÅØ„Åò„ÇÅ„Åæ„Åó„Å¶„ÄÅÊ†™Âºè‰ºöÁ§æ„Äá„Äá„ÅÆÁî∞‰∏≠„Å®Áî≥„Åó„Åæ„Åô..."></textarea>
                        <textarea class="scout-example-input w-full border rounded p-2 text-sm h-20"
                            placeholder="‰æãÊñá2: ÂÖàÊó•„ÅØ„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åó„Åü„ÄÇÊ¨°Âõû„ÅÆ‰ª∂„Åß„Åô„Åå..."></textarea>
                        <textarea class="scout-example-input w-full border rounded p-2 text-sm h-20"
                            placeholder="‰æãÊñá3: ÔºàÂøÖÈ†à„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„Åå„ÄÅÂ§ö„ÅÑ„Åª„Å©Á≤æÂ∫¶„Åå‰∏ä„Åå„Çä„Åæ„ÅôÔºâ"></textarea>
                    </div>
                    <button id="analyze-examples-btn" onclick="analyzeScoutExamples()"
                        class="w-full bg-white border-2 border-indigo-600 text-indigo-600 font-bold py-2 rounded hover:bg-indigo-50 transition">
                        <i class="fas fa-microscope mr-2"></i>ÂàÜÊûê„Åó„Å¶„Çπ„Çø„Ç§„É´„ÇíÁîüÊàê
                    </button>
                </div>

                <div class="border-t pt-6">
                    <label class="block font-bold text-gray-800 mb-2">
                        ÁîüÊàê„Åï„Çå„Åü„Çπ„Çø„Ç§„É´„Éó„É≠„É≥„Éó„ÉàÔºàÁ∑®ÈõÜÂèØÔºâ
                    </label>
                    <textarea id="scout-style-prompt" rows="6"
                        class="w-full border border-gray-300 rounded-lg p-3 text-sm font-mono bg-gray-50 focus:bg-white transition"
                        placeholder="ÂàÜÊûêÁµêÊûú„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇÊâãÂãï„ÅßÂÖ•Âäõ„Éª‰øÆÊ≠£„ÇÇÂèØËÉΩ„Åß„Åô„ÄÇ"></textarea>
                </div>
            </div>
            <div class="p-6 border-t bg-gray-50 flex justify-end gap-3 rounded-b-lg">
                <button onclick="closeScoutSettingsModal()"
                    class="px-4 py-2 text-gray-600 hover:text-gray-800">„Ç≠„É£„É≥„Çª„É´</button>
                <button onclick="saveScoutSettings()"
                    class="px-6 py-2 bg-indigo-600 text-white font-bold rounded shadow hover:bg-indigo-700 transition">
                    Ë®≠ÂÆö„Çí‰øùÂ≠ò
                </button>
            </div>
        </div>
    </div>

    <!-- Favorites Modal -->
    <div id="favorites-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg w-full max-w-2xl mx-4 max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-heart text-pink-500 mr-2"></i>„ÅäÊ∞ó„Å´ÂÖ•„ÇäÊ±Ç‰∫∫
                </h3>
                <button onclick="closeFavoritesModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="favorites-list" class="p-6 overflow-y-auto flex-1">
                <!-- Favorites will be rendered here -->
            </div>
            <div class="p-4 border-t border-gray-200 bg-gray-50 rounded-b-lg text-right">
                <button onclick="closeFavoritesModal()"
                    class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    Èñâ„Åò„Çã
                </button>
            </div>
        </div>
    </div>

    <div id="recommendation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
        style="z-index: 10002;">
        <div class="bg-white rounded-lg w-full max-w-3xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-file-alt text-indigo-600 mr-2"></i>‰ºÅÊ•≠„Å∏„ÅÆÊé®Ëñ¶Êñá‰ΩúÊàê
                </h3>
                <button onclick="closeRecommendationModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="mb-6">
                <p class="text-gray-600 mb-4">
                    AI„ÅåÊ±ÇËÅ∑ËÄÖ„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´„Å®Ê±Ç‰∫∫ÊÉÖÂ†±„ÇíÂàÜÊûê„Åó„ÄÅ‰∫∫‰∫ãÊãÖÂΩìËÄÖ„Å´Èüø„ÅèÊé®Ëñ¶Êñá„ÇíËá™ÂãïÁîüÊàê„Åó„Åæ„Åô„ÄÇ
                    ÁîüÊàê„Åï„Çå„ÅüÊñáÁ´†„ÅØËá™Áî±„Å´Á∑®ÈõÜ„Åß„Åç„Åæ„Åô„ÄÇ
                </p>

                <div class="flex justify-end mb-4">
                    <button onclick="generateRecommendation()" id="generate-recommendation-btn"
                        class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 flex items-center gap-2">
                        <i class="fas fa-magic"></i>
                        <span>AI„ÅßÊé®Ëñ¶Êñá„ÇíÁîüÊàê„Åô„Çã</span>
                    </button>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Êé®Ëñ¶Êñá</label>
                    <textarea id="recommendation-text" rows="15"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        placeholder="„Åì„Åì„Å´Êé®Ëñ¶Êñá„ÅåÁîüÊàê„Åï„Çå„Åæ„Åô..."></textarea>
                </div>
            </div>

            <div class="flex justify-end gap-3 pt-4 border-t">
                <button onclick="closeRecommendationModal()"
                    class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded">„Ç≠„É£„É≥„Çª„É´</button>
                <button onclick="saveRecommendation()"
                    class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                    <i class="fas fa-save mr-2"></i>‰øùÂ≠ò„Åô„Çã
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentRecommendationAppId = null;

        // Êé®Ëñ¶Êñá„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        window.openRecommendationModal = async function (applicationId) {
            console.log('openRecommendationModal called with ID:', applicationId);
            currentRecommendationAppId = applicationId;

            // Êó¢Â≠ò„ÅÆÊé®Ëñ¶Êñá„ÇíÂèñÂæó
            try {
                if (!window.supabase) {
                    throw new Error('Supabase client is not initialized');
                }

                const { data: app, error } = await window.supabase
                    .from('applications')
                    .select('recommendation_text')
                    .eq('id', applicationId)
                    .single();

                if (error) throw error;

                console.log('Fetched application data:', app);

                const modal = $('#recommendation-modal');
                console.log('Modal element found:', modal.length > 0);

                // „É¢„Éº„ÉÄ„É´„Çíbody„ÅÆÊúÄÂæå„Å´ÁßªÂãï„Åó„Å¶„ÄÅË¶™Ë¶ÅÁ¥†„ÅÆÂΩ±Èüø„ÇíÂèó„Åë„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã
                $('body').append(modal);

                $('#recommendation-text').val(app.recommendation_text || '');

                // Âº∑Âà∂ÁöÑ„Å´Ë°®Á§∫
                modal.removeClass('hidden');
                modal.attr('style', 'display: flex !important; z-index: 99999 !important;');

                console.log('Modal moved to body end and forced to display');
                // alert('Êé®Ëñ¶Êñá„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åç„Åæ„Åó„Åü'); // „Éá„Éê„ÉÉ„Ç∞Áî®„Ç¢„É©„Éº„Éà

            } catch (error) {
                console.error('Failed to fetch recommendation:', error);
                alert('„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (error.message || error));
            }
        }

        // Êé®Ëñ¶Êñá„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        window.closeRecommendationModal = function () {
            // „Ç§„É≥„É©„Ç§„É≥„Çπ„Çø„Ç§„É´„Çí‰∏äÊõ∏„Åç„Åó„Å¶ÈùûË°®Á§∫„Å´„Åô„Çã
            $('#recommendation-modal').addClass('hidden').css('display', 'none');
            currentRecommendationAppId = null;
        }

        // AI„ÅßÊé®Ëñ¶Êñá„ÇíÁîüÊàê
        window.generateRecommendation = async function () {
            console.log('generateRecommendation called');
            if (!currentRecommendationAppId) {
                console.error('No currentRecommendationAppId set');
                return;
            }

            const btn = $('#generate-recommendation-btn');
            const originalHtml = btn.html();
            btn.html('<i class="fas fa-spinner fa-spin mr-2"></i>ÁîüÊàê‰∏≠...').prop('disabled', true);

            try {
                if (!window.supabase) throw new Error('Supabase client not initialized');

                console.log('Invoking generate-recommendation-letter for:', currentRecommendationAppId);
                const { data, error } = await window.supabase.functions.invoke('generate-recommendation-letter', {
                    body: { applicationId: currentRecommendationAppId }
                });

                if (error) throw error;
                if (!data.success) throw new Error(data.error || 'ÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');

                console.log('Generation success:', data);
                $('#recommendation-text').val(data.text);

            } catch (error) {
                console.error('Failed to generate recommendation:', error);
                alert('Êé®Ëñ¶Êñá„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (error.message || error));
            } finally {
                btn.html(originalHtml).prop('disabled', false);
            }
        }


        // ========================================
        // ËÅ∑ÂãôÁµåÊ≠¥Êõ∏„ÉªÊé®Ëñ¶Áä∂„Éó„É¨„Éì„É•„Éº„É¢„Éº„ÉÄ„É´Ê©üËÉΩ
        // ========================================

        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentDocumentApplicationId = null;
        let currentDocumentType = null;
        let currentDocumentData = null;


        // ËÅ∑ÂãôÁµåÊ≠¥Êõ∏„ÉªÊé®Ëñ¶Áä∂„ÇíÁîüÊàêÔºà„É¢„Éº„ÉÄ„É´Ë°®Á§∫ÁâàÔºâ
        window.generateDocument = async function (applicationId, type) {
            console.log('generateDocument called:', { applicationId, type });

            currentDocumentApplicationId = applicationId;
            currentDocumentType = type;

            console.log('About to call modal function for type:', type);

            if (type === 'resume') {
                console.log('Calling window.openResumePreviewModal');
                window.openResumePreviewModal(applicationId);
            } else {
                console.log('Calling window.openRecommendationDocPreviewModal');
                window.openRecommendationDocPreviewModal(applicationId);
            }

            console.log('Modal function called');
        }

        // ËÅ∑ÂãôÁµåÊ≠¥Êõ∏„Éó„É¨„Éì„É•„Éº„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        window.openResumePreviewModal = async function (applicationId) {
            console.log('openResumePreviewModal START, applicationId:', applicationId);

            const modal = $('#resume-preview-modal');
            console.log('Modal element found:', modal.length);

            // „É¢„Éº„ÉÄ„É´„Çíbody„ÅÆÁõ¥‰∏ã„Å´ÁßªÂãïÔºàË¶™Ë¶ÅÁ¥†„ÅÆÂΩ±Èüø„ÇíÂèó„Åë„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„ÇãÔºâ
            modal.appendTo('body');

            modal.removeClass('hidden').css('display', 'flex');
            console.log('Modal display set to flex');

            // ÁîüÊàê‰∏≠Ë°®Á§∫
            $('#resume-generating').show();
            $('#resume-preview-content').hide();
            $('#resume-error').hide();
            console.log('Loading state shown');

            try {
                console.log('Calling Edge Function...');
                // Edge Function„ÇíÂëº„Å≥Âá∫„Åó„Å¶AIÁîüÊàê
                const { data, error } = await window.supabase.functions.invoke('generate-application-document', {
                    body: {
                        applicationId: applicationId,
                        type: 'resume'
                    },
                    headers: {
                        'x-user-id': currentUser?.id || ''
                    }
                });

                console.log('Edge Function response:', { data, error });

                if (error) throw error;
                if (!data.success) throw new Error(data.error);

                currentDocumentData = data.documentData;
                console.log('Document data received:', currentDocumentData);

                // „Éó„É¨„Éì„É•„Éº„Å´Ë°®Á§∫
                $('#resume-summary').val(data.documentData.summary || '');
                $('#resume-work-history').val(formatWorkHistory(data.documentData.work_history));
                $('#resume-strengths').val(formatList(data.documentData.strengths || data.documentData.match_highlights));
                $('#resume-skills').val(formatSkills(data.documentData.skills));
                $('#resume-self-pr').val(data.documentData.self_pr || '');
                $('#resume-motivation').val(data.documentData.motivation || 'ÂøóÊúõÂãïÊ©ü„ÇíË®òÂÖ•„Åó„Å¶„Åè„Å†„Åï„ÅÑ');

                console.log('Form fields populated');

                // „Éó„É¨„Éì„É•„ÉºË°®Á§∫
                $('#resume-generating').hide();
                $('#resume-preview-content').show();
                console.log('Preview content shown');

            } catch (error) {
                console.error('Resume generation error:', error);
                $('#resume-generating').hide();
                $('#resume-error-message').text(error.message || 'ÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                $('#resume-error').show();
            }
        }

        // Êé®Ëñ¶Áä∂„Éó„É¨„Éì„É•„Éº„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        window.openRecommendationDocPreviewModal = async function (applicationId) {
            const modal = $('#recommendation-doc-preview-modal');

            // „É¢„Éº„ÉÄ„É´„Çíbody„ÅÆÁõ¥‰∏ã„Å´ÁßªÂãïÔºàË¶™Ë¶ÅÁ¥†„ÅÆÂΩ±Èüø„ÇíÂèó„Åë„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„ÇãÔºâ
            modal.appendTo('body');

            modal.removeClass('hidden').css('display', 'flex');

            // ÁîüÊàê‰∏≠Ë°®Á§∫
            $('#recommendation-doc-generating').show();
            $('#recommendation-doc-preview-content').hide();
            $('#recommendation-doc-error').hide();

            try {
                // Edge Function„ÇíÂëº„Å≥Âá∫„Åó„Å¶AIÁîüÊàê
                const { data, error } = await window.supabase.functions.invoke('generate-application-document', {
                    body: {
                        applicationId: applicationId,
                        type: 'recommendation'
                    },
                    headers: {
                        'x-user-id': currentUser?.id || ''
                    }
                });

                if (error) throw error;
                if (!data.success) throw new Error(data.error);

                currentDocumentData = data.documentData;

                // Êé®Ëñ¶Áä∂„ÇíÊï¥ÂΩ¢„Åó„Å¶Ë°®Á§∫
                const formattedText = formatRecommendationLetter(data.documentData);
                $('#recommendation-doc-full-text').val(formattedText);

                // „Éó„É¨„Éì„É•„ÉºË°®Á§∫
                $('#recommendation-doc-generating').hide();
                $('#recommendation-doc-preview-content').show();

            } catch (error) {
                console.error('Recommendation generation error:', error);
                $('#recommendation-doc-generating').hide();
                $('#recommendation-doc-error-message').text(error.message || 'ÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                $('#recommendation-doc-error').show();
            }
        }

        // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        window.closeResumePreviewModal = function () {
            $('#resume-preview-modal').addClass('hidden').css('display', 'none');
            currentDocumentApplicationId = null;
            currentDocumentData = null;
        }

        window.closeRecommendationDocPreviewModal = function () {
            $('#recommendation-doc-preview-modal').addClass('hidden').css('display', 'none');
            currentDocumentApplicationId = null;
            currentDocumentData = null;
        }

        // ÂÜçÁîüÊàê
        window.regenerateResume = async function () {
            if (currentDocumentApplicationId) {
                await openResumePreviewModal(currentDocumentApplicationId);
            }
        }

        window.regenerateRecommendationDoc = async function () {
            if (currentDocumentApplicationId) {
                await openRecommendationDocPreviewModal(currentDocumentApplicationId);
            }
        }

        // WordÂá∫Âäõ
        window.downloadResumeWord = async function () {
            showLoading('WordÊñáÊõ∏„ÇíÁîüÊàê‰∏≠...');

            try {
                // Á∑®ÈõÜ„Åï„Çå„ÅüÂÜÖÂÆπ„ÇíÂèñÂæó
                const editedData = {
                    summary: $('#resume-summary').val(),
                    work_history_text: $('#resume-work-history').val(),
                    strengths_text: $('#resume-strengths').val(),
                    skills_text: $('#resume-skills').val(),
                    self_pr: $('#resume-self-pr').val(),
                    motivation: $('#resume-motivation').val()
                };

                // HTML„Éô„Éº„Çπ„ÅÆWordÊñáÊõ∏„ÇíÁîüÊàêÔºàÁîªÂÉè„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÇíÂÜçÁèæÔºâ
                const today = new Date();
                const dateStr = `${today.getFullYear()}Âπ¥${today.getMonth() + 1}Êúà${today.getDate()}Êó•ÁèæÂú®`;

                const htmlContent = `
<!DOCTYPE html>
<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
<head>
    <meta charset='utf-8'>
    <title>ËÅ∑ÂãôÁµåÊ≠¥Êõ∏</title>
    <style>
        @page {
            size: A4;
            margin: 20mm;
        }
        body { 
            font-family: 'MS Gothic', 'MS Mincho', 'Meiryo', sans-serif; 
            font-size: 10.5pt;
            line-height: 1.6; 
            margin: 0;
            padding: 20px;
        }
        .header {
            position: relative;
            margin-bottom: 20px;
        }
        .title { 
            text-align: center; 
            font-size: 16pt; 
            font-weight: bold;
            letter-spacing: 8px;
            margin-bottom: 10px;
        }
        .date-name {
            text-align: right;
            font-size: 10pt;
            line-height: 1.8;
        }
        .section-title {
            font-size: 11pt;
            font-weight: bold;
            margin-top: 15px;
            margin-bottom: 8px;
            padding-left: 2px;
        }
        .section-title::before {
            content: '‚ñ†';
            margin-right: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 10pt;
        }
        th, td {
            border: 1px solid #000;
            padding: 6px 8px;
            vertical-align: top;
            line-height: 1.7;
        }
        th {
            background-color: #ffffff;
            font-weight: normal;
            text-align: left;
        }
        .work-history-table th {
            width: 15%;
        }
        .work-history-table td {
            width: 85%;
        }
        .skill-table th {
            width: 25%;
            font-weight: normal;
        }
        .skill-table td {
            width: 75%;
        }
        .content {
            white-space: pre-wrap;
            line-height: 1.7;
        }
        .subsection {
            font-weight: bold;
            margin-top: 8px;
            margin-bottom: 4px;
        }
        .indent {
            padding-left: 1em;
        }
        p {
            margin: 8px 0;
            line-height: 1.8;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">ËÅ∑ÂãôÁµåÊ≠¥Êõ∏</div>
        <div class="date-name">
            ${dateStr}<br>
            Ê∞èÂêç„ÄÄ${currentUser?.user_metadata?.full_name || ''}
        </div>
    </div>
    
    <div class="section-title">ËÅ∑ÂãôË¶ÅÁ¥Ñ</div>
    <p class="content">${editedData.summary.replace(/\n/g, '<br>')}</p>
    
    <div class="section-title">ËÅ∑ÂãôÁµåÊ≠¥</div>
    <table class="work-history-table">
        <tr>
            <td colspan="2" class="content">${editedData.work_history_text.replace(/\n/g, '<br>')}</td>
        </tr>
    </table>
    
    <div class="section-title">PC„Çπ„Ç≠„É´</div>
    <table class="skill-table">
        ${editedData.skills_text.split('\n').filter(line => line.trim()).map(line => {
                    const parts = line.split(/[Ôºö:]/);
                    if (parts.length >= 2) {
                        return `<tr><th>${parts[0].trim()}</th><td>${parts.slice(1).join(':').trim()}</td></tr>`;
                    } else {
                        return `<tr><td colspan="2">${line}</td></tr>`;
                    }
                }).join('\n        ')}
    </table>
    
    <div class="section-title">Ëá™Â∑±PR</div>
    <p class="content">${editedData.self_pr.replace(/\n/g, '<br>')}</p>
    
    <div class="section-title">ÂøóÊúõÂãïÊ©ü</div>
    <p class="content">${editedData.motivation.replace(/\n/g, '<br>')}</p>
    
    <div style="text-align: right; margin-top: 30px;">‰ª•‰∏ä</div>
</body>
</html>`;

                // Blob„Çí‰ΩúÊàê„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                const blob = new Blob(['\ufeff', htmlContent], {
                    type: 'application/msword'
                });

                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ËÅ∑ÂãôÁµåÊ≠¥Êõ∏_${currentDocumentApplicationId}.doc`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
                closeResumePreviewModal();

                alert('ËÅ∑ÂãôÁµåÊ≠¥Êõ∏„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü!');

            } catch (error) {
                console.error('Word generation error:', error);
                alert(`„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        window.downloadRecommendationDocWord = async function () {
            showLoading('WordÊñáÊõ∏„ÇíÁîüÊàê‰∏≠...');

            try {
                const content = $('#recommendation-doc-full-text').val();

                // HTML„Éô„Éº„Çπ„ÅÆWordÊñáÊõ∏„ÇíÁîüÊàê
                const htmlContent = `
<!DOCTYPE html>
<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
<head>
    <meta charset='utf-8'>
    <title>Êé®Ëñ¶Áä∂</title>
    <style>
        body { font-family: 'MS Gothic', 'Meiryo', sans-serif; line-height: 1.8; margin: 40px; }
        h1 { text-align: center; font-size: 24px; margin-bottom: 30px; }
        p { margin: 10px 0; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>Êé®Ëñ¶Áä∂</h1>
    <p>${content.replace(/\n/g, '<br>')}</p>
</body>
</html>`;

                // Blob„Çí‰ΩúÊàê„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                const blob = new Blob(['\ufeff', htmlContent], {
                    type: 'application/msword'
                });

                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Êé®Ëñ¶Áä∂_${currentDocumentApplicationId}.doc`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
                closeRecommendationDocPreviewModal();

                alert('Êé®Ëñ¶Áä∂„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü!');

            } catch (error) {
                console.error('Word generation error:', error);
                alert(`„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // „Éï„Ç©„Éº„Éû„ÉÉ„ÉàÈñ¢Êï∞
        window.formatWorkHistory = function (workHistory) {
            if (!Array.isArray(workHistory)) return '';

            return workHistory.map((item, index) => {
                let text = `${index + 1}.${item.period || ''}\n`;
                text += `   ${item.company || ''} - ${item.position || ''}\n`;
                text += `   ${item.description || ''}\n`;
                if (item.skills_used && item.skills_used.length > 0) {
                    text += `   ‰ΩøÁî®„Çπ„Ç≠„É´: ${item.skills_used.join(', ')}\n`;
                }
                return text;
            }).join('\n');
        }

        window.formatList = function (items) {
            if (Array.isArray(items)) {
                return items.map((s, i) => `‚Ä¢ ${s}`).join('\n');
            }
            return items || '';
        }

        window.formatSkills = function (skills) {
            if (!skills) return '';

            let text = '';
            if (skills.technical && Array.isArray(skills.technical)) {
                text += `ÊäÄË°ì„Çπ„Ç≠„É´: ${skills.technical.join(', ')}\n`;
            }
            if (skills.business && Array.isArray(skills.business)) {
                text += `„Éì„Ç∏„Éç„Çπ„Çπ„Ç≠„É´: ${skills.business.join(', ')}\n`;
            }
            if (skills.certifications && Array.isArray(skills.certifications)) {
                text += `Ë≥áÊ†º: ${skills.certifications.join(', ')}`;
            }
            return text;
        }

        window.formatRecommendationLetter = function (data) {
            let text = `${data.date || new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' })}ÁèæÂú®\n\n`;
            text += `${data.recipient || 'Êé°Áî®„ÅîÊãÖÂΩìËÄÖÊßò'}\n\n`;
            text += `‰ª∂Âêç: ${data.subject || 'ÂÄôË£úËÄÖÊé®Ëñ¶„ÅÆ‰ª∂'}\n\n`;
            text += `${data.greeting || 'ÊãùÂïì ÊôÇ‰∏ã„Åæ„Åô„Åæ„Åô„ÅîÊ∏ÖÊ†Ñ„ÅÆ„Åì„Å®„Å®„ÅäÊÖ∂„Å≥Áî≥„Åó‰∏ä„Åí„Åæ„Åô„ÄÇ'}\n\n`;
            text += `${data.introduction || ''}\n\n`;

            if (data.candidate_overview) {
                text += `„ÄêÂÄôË£úËÄÖÊ¶ÇË¶Å„Äë\n${data.candidate_overview}\n\n`;
            }

            if (data.match_points && Array.isArray(data.match_points)) {
                text += `„Äê„Éû„ÉÉ„ÉÅ„É≥„Ç∞„Éù„Ç§„É≥„Éà„Äë\n`;
                data.match_points.forEach((point, index) => {
                    if (typeof point === 'object') {
                        text += `\n${index + 1}. ${point.title || ''} \n`;
                        text += `${point.description || ''} \n`;
                    } else {
                        text += `${index + 1}. ${point} \n`;
                    }
                });
                text += `\n`;
            }

            if (data.strengths && Array.isArray(data.strengths)) {
                text += `„ÄêÂÄôË£úËÄÖ„ÅÆÂº∑„Åø„Äë\n`;
                data.strengths.forEach((strength, index) => {
                    text += `${index + 1}. ${strength} \n`;
                });
                text += `\n`;
            }

            if (data.why_recommend) {
                text += `„ÄêÊé®Ëñ¶ÁêÜÁî±„Äë\n${data.why_recommend} \n\n`;
            }

            text += `${data.closing || '‰ΩïÂçí„ÅîÊ§úË®é„ÅÆ„Åª„Å©„ÄÅ„Çà„Çç„Åó„Åè„ÅäÈ°ò„ÅÑÁî≥„Åó‰∏ä„Åí„Åæ„Åô„ÄÇ'} \n\n`;
            text += `${data.signature || 'Êï¨ÂÖ∑'} `;

            return text;
        }


        // Êé®Ëñ¶Êñá„Çí‰øùÂ≠ò
        window.saveRecommendation = async function () {
            if (!currentRecommendationAppId) return;

            const text = $('#recommendation-text').val();
            if (!text) {
                alert('Êé®Ëñ¶Êñá„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            showLoading();
            try {
                if (!window.supabase) throw new Error('Supabase client not initialized');

                const { error } = await window.supabase
                    .from('applications')
                    .update({
                        recommendation_text: text,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentRecommendationAppId);

                if (error) throw error;

                alert('Êé®Ëñ¶Êñá„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
                closeRecommendationModal();

                // „É™„Çπ„Éà„ÇíÊõ¥Êñ∞ (Â≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅÆ„Åø)
                if (typeof loadAdminApplicants === 'function') {
                    loadAdminApplicants();
                } else if (typeof loadApplications === 'function') {
                    loadApplications();
                }

            } catch (error) {
                console.error('Failed to save recommendation:', error);
                alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (error.message || error));
            } finally {
                hideLoading();
            }
        }

        // ========================
        // Êñ∞Ê©üËÉΩ: „ÅäÊ∞ó„Å´ÂÖ•„ÇäË¶ãÈÄÅ„Çä & „Éó„É≠„Éï„Ç£„Éº„É´Ê§úÁ¥¢
        // ========================

        // „Åä„Åô„Åô„ÇÅÊ±Ç‰∫∫„ÇíË¶ãÈÄÅ„ÇãÔºàÊúÄ‰∏ãÈÉ®„Å∏ÁßªÂãïÔºÜ„Ç∞„É¨„Éº„Ç¢„Ç¶„ÉàÔºâ
        // „Åä„Åô„Åô„ÇÅÊ±Ç‰∫∫„ÇíË¶ãÈÄÅ„ÇãÔºàÊúÄ‰∏ãÈÉ®„Å∏ÁßªÂãïÔºÜ„Ç∞„É¨„Éº„Ç¢„Ç¶„ÉàÔºâ
        window.dismissRecommendation = function (jobId) {
            if (!window.currentUser) return;

            // Ë¶ñË¶öÁöÑ„Å™Âç≥ÊôÇ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÔºà„ÇØ„É™„ÉÉ„ÇØ„Åó„Åü„Ç´„Éº„Éâ„Çí„Ç∞„É¨„Éº„Ç¢„Ç¶„ÉàÔºâ
            const card = $(`.rec-card[data-job-id="${jobId}"]`);
            if (card.length > 0) {
                card.css({
                    'opacity': '0.3',
                    'filter': 'grayscale(100%)',
                    'pointer-events': 'none',
                    'transition': 'all 0.4s ease'
                });
            }

            const key = `dismissed_recs_${window.currentUser.id}`;
            let dismissed = JSON.parse(localStorage.getItem(key) || '[]');

            if (!dismissed.includes(jobId)) {
                dismissed.push(jobId);
                localStorage.setItem(key, JSON.stringify(dismissed));

                // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÂÜçÊèèÁîªÔºà„Ç∞„É¨„Éº„Ç¢„Ç¶„Éà„ÇíË¶ã„Åõ„Çã„Åü„ÇÅÔºâ
                setTimeout(() => {
                    if (typeof renderRecommendations === 'function') {
                        renderRecommendations();
                    }
                }, 400);
            }
        }

        // „Éó„É≠„Éï„Ç£„Éº„É´Êù°‰ª∂„ÅßÊ§úÁ¥¢
        window.searchByProfile = async function () {
            const user = (typeof currentUser !== 'undefined' ? currentUser : window.currentUser);
            if (!user || user.role !== 'candidate') {
                console.warn('searchByProfile: Invalid user or role', user);
                return;
            }

            if (window.showLoading) window.showLoading();

            try {
                // ÊúÄÊñ∞„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´ÊÉÖÂ†±„ÇíÂèñÂæó (currentUser„ÅåÂè§„ÅÑÂèØËÉΩÊÄß„Åå„ÅÇ„Çã„Åü„ÇÅ)
                const { data: profileData, error: profileError } = await window.supabase
                    .from('candidate_profiles')
                    .select('*')
                    .eq('user_id', user.id)
                    .maybeSingle();

                if (profileError) throw profileError;

                // „Éó„É≠„Éï„Ç£„Éº„É´„Åå„Å™„ÅÑÂ†¥Âêà„ÅØË≠¶Âëä
                if (!profileData) {
                    alert('„Éó„É≠„Éï„Ç£„Éº„É´ÊÉÖÂ†±„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Åü„ÇÅ„ÄÅÊù°‰ª∂„ÇíËá™Âãï„Çª„ÉÉ„Éà„Åß„Åç„Åæ„Åõ„Çì„ÄÇÂÖà„Å´„Éó„É≠„Éï„Ç£„Éº„É´„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }

                // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„Å®„Éó„É≠„Éï„Ç£„Éº„É´ÊÉÖÂ†±„Çí„Éû„Éº„Ç∏
                const fullUser = { ...user, ...profileData };

                // „Éû„Çπ„Çø„Éá„Éº„ÇøÂèñÂæó (ID„Å®Label„ÅÆÂØæÂøú„ÅåÂøÖË¶Å„Å™„Åü„ÇÅ)
                const { data: masters } = await window.supabase
                    .from('master_data')
                    .select('type, label, value, organization_id')
                    .in('type', ['job_category', 'industry_category', 'employment_type'])
                    .eq('is_active', true);

                // Ëá™Á§æ„Åæ„Åü„ÅØÂÖ±ÈÄö„Éû„Çπ„Çø
                const validMasters = masters ? masters.filter(m =>
                    m.organization_id === null || m.organization_id === user.organization_id
                ) : [];

                const mapToLabel = (inputStr, type) => {
                    if (inputStr === null || inputStr === undefined || inputStr === '') return [];

                    // JSONÈÖçÂàó„ÄÅ„Ç´„É≥„ÉûÂå∫Âàá„ÇäÊñáÂ≠óÂàó„ÄÅ„ÅÇ„Çã„ÅÑ„ÅØÂçò‰∏Ä„ÅÆÂÄ§„ÇíÂá¶ÁêÜ
                    let inputs = [];
                    if (Array.isArray(inputStr)) {
                        inputs = inputStr;
                    } else if (typeof inputStr === 'string') {
                        if (inputStr.startsWith('[') && inputStr.endsWith(']')) {
                            try { inputs = JSON.parse(inputStr); } catch (e) { inputs = [inputStr]; }
                        } else {
                            inputs = inputStr.split(',').map(s => s.trim()).filter(Boolean);
                        }
                    } else {
                        inputs = [inputStr];
                    }

                    const typeMasters = validMasters.filter(m => m.type === type);

                    return inputs.map(val => {
                        // value (ID) „ÅßÊ§úÁ¥¢ (Á∑©„ÅÑÊØîËºÉ)
                        const byId = typeMasters.find(m => m.value == val);
                        if (byId) return byId.label;

                        // label „ÅßÊ§úÁ¥¢
                        const byLabel = typeMasters.find(m => m.label == val);
                        if (byLabel) return byLabel.label;

                        // „Éû„ÉÉ„ÉÅ„Åó„Å™„Åë„Çå„Å∞„Åù„ÅÆ„Åæ„ÅæËøî„Åô
                        return val;
                    });
                };

                // ÊúÄ‰ΩéÂπ¥Âèé„ÅÆÊï¥ÂΩ¢
                let salaryMin = '';
                if (fullUser.desired_salary) {
                    let salaryVal = fullUser.desired_salary;
                    // ÊñáÂ≠óÂàó„Å™„ÇâÊï∞ÂÄ§„ÅÆ„ÅøÊäΩÂá∫
                    if (typeof salaryVal === 'string') {
                        salaryVal = parseInt(salaryVal.replace(/[^0-9]/g, '')) || 0;
                    }
                    // 1‰∏áÂÄçÔºà‰æã: 500‰∏áÔºâ‰ª•‰∏ä„Å™„Çâ1‰∏á„ÅßÂâ≤„Çã
                    if (salaryVal >= 10000) {
                        salaryMin = Math.floor(salaryVal / 10000);
                    } else {
                        salaryMin = salaryVal;
                    }
                }

                const filters = {
                    jobCategory: mapToLabel(fullUser.desired_job_type, 'job_category'),
                    industryCategory: mapToLabel(fullUser.desired_industry, 'industry_category'),
                    prefecture: fullUser.desired_location ?
                        (Array.isArray(fullUser.desired_location) ? fullUser.desired_location :
                            String(fullUser.desired_location).startsWith('[') ? JSON.parse(fullUser.desired_location) :
                                String(fullUser.desired_location).split(/[,„ÄÅ]/).map(s => s.trim()))
                        : [],
                    employmentType: mapToLabel(fullUser.desired_employment_type, 'employment_type'),
                    salaryMin: salaryMin,
                    jobExperienceOk: !!fullUser.desired_job_experience_ok,
                    industryExperienceOk: !!fullUser.desired_industry_experience_ok,
                    isRemote: false // „Éó„É≠„Éï„Ç£„Éº„É´„Å´È†ÖÁõÆ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Éá„Éï„Ç©„É´„Éà
                };

                console.log('Searching by profile (mapped):', filters);

                // Ê§úÁ¥¢„Éë„É©„É°„Éº„ÇøË®≠ÂÆö
                if (window.applySearchFilters) {
                    window.applySearchFilters(filters);
                } else if (typeof applySearchFilters === 'function') {
                    applySearchFilters(filters);
                }

                // Ê§úÁ¥¢ÂÆüË°å
                if (typeof searchJobsImmediate === 'function') {
                    searchJobsImmediate();
                } else if (typeof loadJobs === 'function') {
                    loadJobs(filters);
                }

            } catch (e) {
                console.error('Search by profile error:', e);
                alert('Ê§úÁ¥¢Êù°‰ª∂„ÅÆÈÅ©Áî®„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (e.message || e));
            } finally {
                if (window.hideLoading) window.hideLoading();
            }
        }

        /* ============================================================ */
        /*  Scout Management & Specific Job Scout Generation Logic      */
        /* ============================================================ */

        window.loadScoutManagement = async function () {
            if (!currentUser) return;
            const container = $('#scout-management-list');
            container.html('<div class="text-center py-12"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto"></div></div>');

            try {
                // 1. ÁµÑÁπîË®≠ÂÆö„ÅÆÂèñÂæó
                const { data: orgData } = await supabase
                    .from('organizations')
                    .select('settings')
                    .eq('id', currentUser.organization_id)
                    .single();
                const visibility = orgData?.settings?.scout_history_visibility || 'all';

                // 2. Áµ±Ë®à„Éá„Éº„Çø„ÅÆÂèñÂæó („Çπ„Ç´„Ç¶„ÉàÈÄÅ‰ø°Êï∞: sent/replied/interview/hired/rejected)
                // Note: „Çπ„ÉÜ„Éº„Çø„Çπ„Åå 'generated' (‰∏ãÊõ∏„Åç) „ÅØÈô§Â§ñ„Åô„Çã„ÅÆ„Åå‰∏ÄËà¨ÁöÑ„Å†„Åå„ÄÅÂ±•Ê≠¥„Å®„Åó„Å¶Âê´„ÇÅ„Å¶„ÇÇËâØ„ÅÑ„ÄÇ„Åì„Åì„Åß„ÅØ 'generated' ‰ª•Â§ñ„Çí„Ç´„Ç¶„É≥„Éà„Å®„Åô„Çã„Åã„ÄÅÂÖ®ÈÉ®Âê´„ÇÄ„Åã„ÄÇ
                // ‰∏ÄËà¨ÁöÑ„Å´„ÄåÂ±•Ê≠¥„Äç„ÅØÈÄÅ‰ø°Ê∏à„Åø„ÇíÊåá„Åô„Åì„Å®„ÅåÂ§ö„ÅÑ„ÄÇ
                const validStatuses = ['sent', 'replied', 'interview', 'rejected', 'hired'];

                // ÂÄã‰∫∫
                const { count: myCount } = await supabase
                    .from('scout_messages')
                    .select('*', { count: 'exact', head: true })
                    .eq('organization_id', currentUser.organization_id)
                    .eq('created_by', currentUser.id)
                    .in('status', validStatuses);

                // ÂÖ®‰Ωì
                const { count: orgCount } = await supabase
                    .from('scout_messages')
                    .select('*', { count: 'exact', head: true })
                    .eq('organization_id', currentUser.organization_id)
                    .in('status', validStatuses);


                // 3. ÂÄôË£úËÄÖ„Éá„Éº„Çø„ÅÆÂèñÂæó
                const { data: candidates, error: cError } = await supabase
                    .from('external_candidates')
                    .select('*')
                    .eq('organization_id', currentUser.organization_id)
                    .order('created_at', { ascending: false });

                if (cError) {
                    if (cError.code === '42P01') {
                        container.html('<div class="text-center py-8 text-gray-500">Ê©üËÉΩÊ∫ñÂÇô‰∏≠Ôºà„ÉÜ„Éº„Éñ„É´Êú™‰ΩúÊàêÔºâ</div>');
                        return;
                    }
                    throw cError;
                }

                // 4. „É°„ÉÉ„Çª„Éº„Ç∏„Éá„Éº„Çø„ÅÆÂèñÂæó
                let messages = [];
                // Check if candidates exist
                if (candidates && candidates.length > 0) {
                    const candidateIds = candidates.map(c => c.id);
                    try {
                        let msgQuery = supabase
                            .from('scout_messages')
                            .select('*, jobs(title, companies(name))')
                            .in('external_candidate_id', candidateIds)
                            .order('created_at', { ascending: false });

                        // VisibilityÂà∂Âæ°
                        if (visibility === 'personal') {
                            msgQuery = msgQuery.eq('created_by', currentUser.id);
                        }

                        const { data: msgs, error: mError } = await msgQuery;
                        if (!mError) {
                            messages = msgs;

                            // „É¶„Éº„Ç∂„ÉºÂêç„ÅÆÂèñÂæó (‰ΩúÊàêËÄÖË°®Á§∫Áî®)
                            if (messages.length > 0) {
                                const userIds = [...new Set(messages.map(m => m.created_by).filter(id => id))];
                                if (userIds.length > 0) {
                                    const { data: users } = await supabase
                                        .from('users')
                                        .select('id, name')
                                        .in('id', userIds);

                                    const userMap = {};
                                    if (users) users.forEach(u => userMap[u.id] = u.name);

                                    messages.forEach(m => {
                                        m.sender_name = userMap[m.created_by] || '-';
                                    });
                                }
                            }
                        }
                    } catch (e) { console.warn('scout_messages fetch failed', e); }
                }

                // 5. Áµ±Ë®àUI„ÅÆË°®Á§∫„Å®„É™„Çπ„Éà„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞
                const statsHtml = `
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-indigo-50 rounded-lg p-4 text-center border border-indigo-100">
                            <p class="text-xs text-gray-500 font-bold mb-1">Ëá™ÂàÜ„ÅÆ„Çπ„Ç´„Ç¶„ÉàÈÄÅ‰ø°Êï∞</p>
                            <p class="text-2xl font-bold text-indigo-700">${myCount || 0}<span class="text-sm font-normal text-gray-500 ml-1">‰ª∂</span></p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 text-center border border-gray-200">
                            <p class="text-xs text-gray-500 font-bold mb-1">ÁµÑÁπîÂÖ®‰Ωì„ÅÆ„Çπ„Ç´„Ç¶„ÉàÈÄÅ‰ø°Êï∞</p>
                            <p class="text-2xl font-bold text-gray-700">${orgCount || 0}<span class="text-sm font-normal text-gray-500 ml-1">‰ª∂</span></p>
                        </div>
                    </div>
                `;

                if (!candidates || candidates.length === 0) {
                    container.html(statsHtml + '<div class="text-center py-8 text-gray-500">ÁôªÈå≤„Åï„Çå„ÅüÂÄôË£úËÄÖ„ÅØ„ÅÑ„Åæ„Åõ„Çì</div>');
                    return;
                }

                container.html(statsHtml + '<div class="space-y-4" id="scout-list-content"></div>');

                // „É™„Çπ„Éà„ÅÆ‰∏≠Ë∫´„ÇíÂà•„ÅÆÈñ¢Êï∞„ÅßÊèèÁîª„Åô„Çã„Å™„Å©„ÄÅ„ÅÇ„Çã„ÅÑ„ÅØ„Åì„Åì„ÅßÁõ¥Êé•Âëº„Å≥Âá∫„Åó
                // Êó¢Â≠ò„ÅÆ renderScoutManagementList „ÅØ container.html() „Çí‰∏äÊõ∏„Åç„Åó„Å¶„Åó„Åæ„ÅÜ„ÅÆ„Åß„ÄÅ
                // container „ÅÆ‰∏≠„ÅÆ div „Çí„Çø„Éº„Ç≤„ÉÉ„Éà„Å´„Åô„Çã„Çà„ÅÜ„Å´Ë™øÊï¥„ÅåÂøÖË¶Å„ÄÇ
                // „Åó„Åã„Åó renderScoutManagementList „ÅØ windowÈñ¢Êï∞„Å®„Åó„Å¶ÂÆöÁæ©„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ
                // „Åì„Åì„ÅßÂëº„Å≥Âá∫„ÅôÈöõ„Å´„ÄÅtarget„ÇíÂ§â„Åà„Çã„Åã„ÄÅrenderScoutManagementList „Çí‰øÆÊ≠£„Åô„Çã„ÄÇ
                // ‰øÆÊ≠£„Åô„Çã„ÅÆ„ÅåÊó©„ÅÑ„ÄÇ

                // Êó¢Â≠òÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åô„Åå„ÄÅ„Çø„Éº„Ç≤„ÉÉ„Éà Element ID „ÅåÂõ∫ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã ('scout-management-list')„ÄÇ
                // „Åì„Çå„Å†„Å® STATS „ÅåÊ∂à„Åà„Å¶„Åó„Åæ„ÅÜ„ÄÇ
                // Ëß£Ê±∫Á≠ñ: renderScoutManagementList „Å´„Çø„Éº„Ç≤„ÉÉ„Éà„Ç≥„É≥„ÉÜ„Éä„ÇíÊ∏°„Åõ„Çã„Çà„ÅÜ„Å´„Åô„Çã„ÄÅ„ÇÇ„Åó„Åè„ÅØ
                // renderScoutManagementList „ÅÆ‰∏≠Ë∫´„Çí„Åì„Åì„Å´„Ç§„É≥„É©„Ç§„É≥Âåñ/„É™„Éï„Ç°„ÇØ„Çø„Åô„Çã„ÄÇ
                // „Åì„Åì„Åß„ÅØÂÆâÁõ¥„Å´„ÄÅrenderScoutManagementList „ÇíÂëº„Å≥Âá∫„Åó„ÅüÂæå„Åß„ÄÅSTATS „Çí prepend „Åô„Çã„ÅÆ„ÅØ„Å°„Çâ„Å§„Åè„ÄÇ
                // renderScoutManagementList „Çí‰øÆÊ≠£„Åó„Çà„ÅÜ„ÄÇ

                renderScoutManagementList(candidates, messages || [], '#scout-list-content');

            } catch (e) {
                console.error('Load Scout Management Error:', e);
                container.html('<div class="text-center py-8 text-red-500">Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>');
            }
        };

        window.renderScoutManagementList = function (candidates, messages, targetSelector = '#scout-management-list') {
            const container = $(targetSelector);

            if (!candidates || candidates.length === 0) {
                container.html('<div class="text-center py-8 text-gray-500">ÁôªÈå≤„Åï„Çå„ÅüÂÄôË£úËÄÖ„ÅØ„ÅÑ„Åæ„Åõ„Çì</div>');
                return;
            }

            const rows = candidates.map(c => {
                const cMessages = messages.filter(m => m.external_candidate_id === c.id);
                const lastMsg = cMessages.length > 0 ? cMessages[0] : null;
                const currentStatus = lastMsg ? lastMsg.status : (c.status || 'new');

                const jobTitle = lastMsg?.jobs?.title || '-';
                const companyName = lastMsg?.jobs?.companies?.name || '';
                const lastJobTitle = lastMsg ? (companyName ? `${companyName} ${jobTitle} ` : jobTitle) : '-';
                const lastScoutDate = lastMsg ? new Date(lastMsg.created_at).toLocaleDateString() : '-';
                const senderName = lastMsg ? (lastMsg.sender_name || '‰∏çÊòé') : '-';

                // Status Dropdown
                const statusOptions = [
                    { val: 'new', label: 'Êñ∞Ë¶è' },
                    { val: 'generated', label: 'ÊñáÈù¢‰ΩúÊàêÊ∏à' },
                    { val: 'sent', label: 'ÈÄÅ‰ø°Ê∏à' },
                    { val: 'replied', label: 'Ëøî‰ø°„ÅÇ„Çä' },
                    { val: 'interview', label: 'Èù¢Ë´áË®≠ÂÆö' },
                    { val: 'rejected', label: 'ËæûÈÄÄ/‰∏çÊé°Áî®' },
                    { val: 'hired', label: 'Êé°Áî®Ê±∫ÂÆö' }
                ];

                const statusChangeHandler = lastMsg
                    ? `onchange="updateScoutStatus('${lastMsg.id}', this.value)"`
                    : `disabled title="„Çπ„Ç´„Ç¶„Éà„Çí‰ΩúÊàê„Åô„Çã„Å®„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂ§âÊõ¥„Åß„Åç„Åæ„Åô"`;

                const statusSelect = `
                    <select ${statusChangeHandler} class="text-xs border border-gray-300 rounded px-2 py-1 bg-white text-gray-700 w-28">
                    ${statusOptions.map(opt => `<option value="${opt.val}" ${currentStatus === opt.val ? 'selected' : ''}>${opt.label}</option>`).join('')}
                    </select>
                `;

                // Title display
                const displayTitle = c.custom_title || 'ÂêçÁß∞Êú™Ë®≠ÂÆö';
                const subText = c.custom_title
                    ? (c.parsed_data?.candidate_summary ? c.parsed_data.candidate_summary.substring(0, 30) + '...' : (c.profile_text || '').substring(0, 30) + '...')
                    : (c.profile_text || '').substring(0, 30) + '...';

                return `
                    <tr>
                        <td class="px-6 py-4">
                            <div class="text-sm font-bold text-gray-900 truncate" style="max-width: 250px;" title="${c.profile_text}">
                                ${displayTitle}
                            </div>
                            <div class="text-xs text-gray-500">
                                ${subText}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${new Date(c.created_at).toLocaleDateString()}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            ${senderName}
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900 truncate" style="max-width: 200px;" title="${lastJobTitle}">${lastJobTitle}</div>
                            <div class="text-xs text-gray-500">${lastScoutDate}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${statusSelect}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="viewExternalCandidateDetail('${c.id}')" class="text-indigo-600 hover:text-indigo-900 bg-indigo-50 hover:bg-indigo-100 px-3 py-1 rounded transition">
                                <i class="fas fa-file-alt mr-1"></i>Ë©≥Á¥∞„ÉªÂ±•Ê≠¥
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            const tableHtml = `
                    <div class="overflow-x-auto border border-gray-200 rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÂÄôË£úËÄÖ / ÁÆ°ÁêÜID</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÁôªÈå≤Êó•</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÂÆüË°åËÄÖ</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Áõ¥Ëøë„Çπ„Ç´„Ç¶„Éà</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${rows}
                        </tbody>
                    </table>
                </div>
                `;

            container.html(tableHtml);
        }

        window.viewExternalCandidateDetail = async function (candidateId) {
            try {
                const { data: candidate, error } = await supabase
                    .from('external_candidates')
                    .select('*')
                    .eq('id', candidateId)
                    .single();

                if (error) throw error;

                if (!candidate.parsed_data) {
                    alert("Ëß£Êûê„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì");
                    return;
                }

                window.currentExternalCandidateId = candidate.id;

                switchProfileAnalysisTab('new');

                if (candidate.profile_text) {
                    $('#profile-text-input').val(candidate.profile_text);
                }

                // Set custom title
                if (candidate.custom_title) {
                    $('#candidate-title-input').val(candidate.custom_title);
                } else {
                    $('#candidate-title-input').val('');
                }

                renderAnalysisResults(candidate.parsed_data);

                document.getElementById('analysis-results').scrollIntoView({ behavior: 'smooth' });

            } catch (e) {
                console.error('View detail error:', e);
                alert("Ë©≥Á¥∞„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
            }
        }

        window.updateScoutStatus = async function (scoutId, newStatus) {
            if (!confirm(`„Çπ„ÉÜ„Éº„Çø„Çπ„Çí„Äå${newStatus}„Äç„Å´Â§âÊõ¥„Åó„Åæ„Åô„ÅãÔºü`)) {
                loadScoutManagement(); // Revert selection UI by reloading
                return;
            }

            try {
                // Update scout_messages
                const { error: msgError } = await supabase
                    .from('scout_messages')
                    .update({ status: newStatus, updated_at: new Date().toISOString() })
                    .eq('id', scoutId);

                if (msgError) throw msgError;

                // Also update external_candidates status for consistency if needed
                // For now, mainly tracking scout message status.

                alert('„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
                loadScoutManagement(); // Reload list
            } catch (e) {
                console.error('Status update failed:', e);
                alert('Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        window.fetchActiveJobs = async function () {
            const { data } = await supabase
                .from('jobs')
                .select('id, title')
                .eq('organization_id', currentUser.organization_id)
                .eq('status', 'active')
                .order('created_at', { ascending: false })
                .limit(20);
            return data;
        }

        // Job Selector Modal Logic
        let scoutJobSelectorInitialized = false;

        window.openJobSelectorForScout = function () {
            $('#job-selection-modal').removeClass('hidden');

            // Initialize Prefectures if needed
            if (!scoutJobSelectorInitialized && window.prefectures) {
                const select = $('#selector-search-prefecture');
                window.prefectures.forEach(p => {
                    select.append(`< option value = "${p}" > ${p}</option > `);
                });
                scoutJobSelectorInitialized = true;
            }

            // Reset results if empty
            if ($('#selector-job-results').children().length === 0) {
                $('#selector-job-results').html('<div class="text-center py-8 text-gray-400">Ê§úÁ¥¢Êù°‰ª∂„ÇíÂÖ•Âäõ„Åó„Å¶Ê§úÁ¥¢„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>');
            }
        };

        window.closeJobSelectorForScout = function () {
            $('#job-selection-modal').addClass('hidden');
        };

        window.searchJobsForScout = async function () {
            if (!currentUser) return;

            const company = $('#selector-search-company').val().trim();
            const prefecture = $('#selector-search-prefecture').val();
            const keyword = $('#selector-search-keyword').val().trim();

            const container = $('#selector-job-results');
            container.html('<div class="text-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto"></div></div>');

            try {
                let query = supabase
                    .from('jobs')
                    .select('id, title, company, location, description, updated_at')
                    .eq('organization_id', currentUser.organization_id)
                    .eq('status', 'active');

                if (company) {
                    query = query.ilike('company', `%${company}%`);
                }

                if (prefecture) {
                    query = query.ilike('location', `%${prefecture}%`);
                }

                if (keyword) {
                    // search title and description
                    query = query.or(`title.ilike.%${keyword}%, description.ilike.%${keyword}%`);
                }

                query = query.order('updated_at', { ascending: false }).limit(50);

                const { data, error } = await query;

                if (error) throw error;

                if (!data || data.length === 0) {
                    container.html('<div class="text-center py-8 text-gray-500">Êù°‰ª∂„Å´‰∏ÄËá¥„Åô„ÇãÊ±Ç‰∫∫„ÅØË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</div>');
                    return;
                }

                const html = data.map(job => `
                <div class="bg-gray-50 hover:bg-gray-100 p-3 rounded border border-gray-200 flex justify-between items-center transition">
                        <div class="flex-1 min-w-0 mr-4">
                            <h5 class="font-bold text-gray-800 truncate">${job.title}</h5>
                            <p class="text-xs text-gray-600 truncate">
                                <i class="fas fa-building mr-1"></i>${job.company || '‰ºöÁ§æÂêç„Å™„Åó'}
                                <span class="mx-2 text-gray-300">|</span>
                                <i class="fas fa-map-marker-alt mr-1"></i>${job.location || 'Âã§ÂãôÂú∞„Å™„Åó'}
                            </p>
                            <p class="text-xs text-gray-400 mt-1 truncate">${(job.description || '').substring(0, 50)}...</p>
                        </div>
                        <button onclick="selectJobForScout('${job.id}')" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold py-2 px-4 rounded whitespace-nowrap">
                            ÈÅ∏Êäû
                        </button>
                    </div>
                `).join('');

                container.html(html);

            } catch (e) {
                console.error('Job search error:', e);
                container.html('<div class="text-center py-8 text-red-500">Ê§úÁ¥¢„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</div>');
            }
        }

        window.selectJobForScout = async function (jobId) {
            // Close modal
            closeJobSelectorForScout();

            // Fetch full job details (reuse existing query or just simple fetch)
            // generateScoutForSelectedJob expects {id, title} at minimum
            try {
                const { data: job, error } = await supabase.from('jobs').select('id, title').eq('id', jobId).single();
                if (error || !job) {
                    alert('Ê±Ç‰∫∫ÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    return;
                }
                generateScoutForSelectedJob(job);
            } catch (e) {
                console.error(e);
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            }
        }

        window.generateScoutForSelectedJob = async function (job) {
            const instruction = `‰ª•‰∏ã„ÅÆÁâπÂÆö„ÅÆÊ±Ç‰∫∫„Å´ÂØæ„Åô„Çã„Çπ„Ç´„Ç¶„ÉàÊñáÈù¢„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n(‰ªñ„ÅÆÊ±Ç‰∫∫„ÅØÁÑ°Ë¶ñ„Åó„Å¶„ÄÅ„Åì„ÅÆÊ±Ç‰∫∫„Å´Áµû„Å£„Å¶ÊèêÊ°à„Åó„Å¶„Åè„Å†„Åï„ÅÑ) \n\n„Äê„Çø„Éº„Ç≤„ÉÉ„ÉàÊ±Ç‰∫∫ÊÉÖÂ†±„Äë\nÊ±Ç‰∫∫Âêç: ${job.title} \nÊ±Ç‰∫∫ID: ${job.id} `;
            $('#scout-instruction-text').val(instruction);
            analyzeProfile(instruction, job.id);
        }
        window.resetProfileAnalysis = function () {
            uploadedFiles = [];
            $('#profile-file-input').val('');
            $('#file-list').empty();
            $('#profile-text-input').val('');
            $('#candidate-title-input').val(''); // Clear title
            $('#scout-instruction-text').val('');
            $('#scout-instruction-container').addClass('hidden');
            $('#analysis-placeholder').removeClass('hidden');
            $('#analysis-loading').addClass('hidden');
            $('#analysis-results').addClass('hidden');
            $('#suggested-jobs-container').empty();
            window.currentAnalysisHistoryId = null;
            window.currentExternalCandidateId = null; // Clear candidate ID
            if ($('#current-analysis-history-id').length) $('#current-analysis-history-id').val('');
        }

        /* ... existing analyzeProfile ... */

        window.saveExternalCandidateProfile = async function (analysisData) {
            try {
                const customTitle = $('#candidate-title-input').val().trim();
                const payload = {
                    organization_id: currentUser.organization_id,
                    profile_text: analysisData.candidate_summary,
                    parsed_data: analysisData,
                    status: 'new',
                    custom_title: customTitle || null,
                    updated_at: new Date().toISOString()
                };

                // DEBUG: Check payload
                console.log('Saving External Candidate. Payload:', payload);
                console.log('Current User Org ID:', currentUser?.organization_id);
                if (!currentUser?.organization_id) {
                    alert('„Ç®„É©„Éº: ÁµÑÁπîID„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇÂÜç„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }

                // DEBUG: Check RLS Function result
                try {
                    const { data: dbOrgId, error: rpcError } = await supabase.rpc('get_my_org_id');
                    console.log('RPC get_my_org_id result:', dbOrgId, rpcError);

                    if (dbOrgId !== currentUser.organization_id) {
                        alert(`„ÄêÈáçË¶Å„ÄëID‰∏ç‰∏ÄËá¥Ê§úÂá∫\nDB‰∏ä„ÅÆÁµÑÁπîID: ${dbOrgId} \n„Ç¢„Éó„É™‰∏ä„ÅÆÁµÑÁπîID: ${currentUser.organization_id} \n\n„Åì„Çå„ÅåÂéüÂõ†„Åß‰øùÂ≠ò„ÅåÊãíÂê¶„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ`);
                    } else {
                        console.log('Org IDs match confirmed.');
                    }
                } catch (e) {
                    console.error('RPC Error:', e);
                }

                let resultData, resultError;

                if (window.currentExternalCandidateId) {
                    // Update existing
                    const { data, error } = await supabase
                        .from('external_candidates')
                        .update(payload)
                        .eq('id', window.currentExternalCandidateId)
                        .select();
                    resultData = data;
                    resultError = error;
                } else {
                    // Insert new
                    const { data, error } = await supabase
                        .from('external_candidates')
                        .insert(payload)
                        .select();
                    resultData = data;
                    resultError = error;
                }

                if (resultData && resultData[0]) {
                    window.currentExternalCandidateId = resultData[0].id; // Ensure ID is set
                }

                // „Çø„Éñ„Åå„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Çâ„É™„É≠„Éº„Éâ
                if (!$('#profile-scout_management-tab-content').hasClass('hidden')) {
                    loadScoutManagement();
                }
            } catch (e) {
                console.error('Failed to save to external_candidates', e);
            }
        }

        window.saveScoutMessage = async function (btn, jobId) {
            const container = $(btn).closest('.bg-white'); // Card container
            const subject = (container.find('.scout-subject-input').val() || container.find('p:contains("‰ª∂Âêç:")').text().replace('‰ª∂Âêç: ', '') || '').trim();
            const body = (container.find('.scout-body-textarea').val() || container.find('.scout-body-text').text() || '').trim();

            if (!subject || !body) {
                alert('„Çπ„Ç´„Ç¶„ÉàÊñáÈù¢„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
                return;
            }

            if (!confirm('„Åì„ÅÆ„Çπ„Ç´„Ç¶„ÉàÊñáÈù¢„Çí„ÄåÈÄÅ‰ø°Ê∏à„Åø„Äç„Å®„Åó„Å¶ÁôªÈå≤„Åó„Åæ„Åô„ÅãÔºü')) return;

            if (!window.currentExternalCandidateId) {
                // Not yet saved to DB. Save profile first.
                if (window.analysisResultsData && window.saveExternalCandidateProfile) {
                    try {
                        await window.saveExternalCandidateProfile(window.analysisResultsData);
                    } catch (e) {
                        console.error('Failed to save profile before scout:', e);
                    }
                }
            }

            if (!window.currentExternalCandidateId) {
                alert("ÂÄôË£úËÄÖÊÉÖÂ†±„ÅÆ‰øùÂ≠ò„ÅåÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ\nDB„Å∏„ÅÆ‰øùÂ≠ò„ÅåÂ§±Êïó„Åó„Å¶„ÅÑ„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ\n(migration_scout_features.sql„ÅåÊ≠£„Åó„ÅèÂÆüË°å„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ)");
                return;
            }

            try {
                // Insert into scout_messages
                const { error } = await supabase.from('scout_messages').insert({
                    organization_id: currentUser.organization_id,
                    external_candidate_id: window.currentExternalCandidateId,
                    job_id: jobId,
                    subject: subject,
                    message_body: body,
                    status: 'sent',
                    sent_at: new Date().toISOString(),
                    created_by: currentUser.id
                });

                if (error) throw error;

                alert('„Çπ„Ç´„Ç¶„Éà„ÇíÁôªÈå≤„Åó„Åæ„Åó„Åü');
                $(btn).removeClass('text-gray-400').addClass('text-green-600').text('ÈÄÅ‰ø°Ê∏à').prop('disabled', true);

                if (!$('#profile-scout_management-tab-content').hasClass('hidden')) {
                    loadScoutManagement();
                }

            } catch (e) {
                console.error('Save scout error:', e);
                alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        /* ---------------------------------------------------- */
        /*  Analytics Logic                                     */
        /* ---------------------------------------------------- */

        window.loadScoutAnalytics = async function () {
            if (!currentUser) return;
            const userStatsContainer = $('#analytics-user-stats');
            const orgStatsContainer = $('#analytics-org-stats');
            const detailsContainer = $('#analytics-details-container');

            try {
                // Fetch ALL messages for the organization
                // We need status and created_by
                const { data: messages, error } = await supabase
                    .from('scout_messages')
                    .select('id, status, created_by, created_at')
                    .eq('organization_id', currentUser.organization_id);

                if (error) throw error;

                if (!messages || messages.length === 0) {
                    userStatsContainer.html('<div class="col-span-2 text-center text-gray-500">„Éá„Éº„Çø„Å™„Åó</div>');
                    orgStatsContainer.html('<div class="col-span-2 text-center text-gray-500">„Éá„Éº„Çø„Å™„Åó</div>');
                    return;
                }

                // --- Calculate Stats ---
                const calculateStats = (msgs) => {
                    const totalSent = msgs.filter(m => ['sent', 'replied', 'interview', 'rejected', 'hired'].includes(m.status)).length;
                    const replied = msgs.filter(m => ['replied', 'interview', 'rejected', 'hired'].includes(m.status)).length;
                    const interview = msgs.filter(m => ['interview', 'hired'].includes(m.status)).length;

                    const replyRate = totalSent > 0 ? ((replied / totalSent) * 100).toFixed(1) : '0.0';
                    const interviewRate = totalSent > 0 ? ((interview / totalSent) * 100).toFixed(1) : '0.0';

                    return { totalSent, replied, interview, replyRate, interviewRate };
                };

                const orgStats = calculateStats(messages);
                const userData = messages.filter(m => m.created_by === currentUser.id);
                const userStats = calculateStats(userData);

                // --- Render Stats ---
                const renderStatItem = (label, value, unit = '', subText = '') => `
                <div class="bg-indigo-50 rounded p-3 text-center">
                        <div class="text-xs text-gray-500 font-bold mb-1">${label}</div>
                        <div class="text-2xl font-bold text-indigo-700">${value}<span class="text-sm font-normal text-gray-600 ml-1">${unit}</span></div>
                        ${subText ? `<div class="text-xs text-gray-400 mt-1">${subText}</div>` : ''}
                    </div>
                `;

                orgStatsContainer.html(`
                    ${renderStatItem('Á∑èÈÄÅ‰ø°Êï∞', orgStats.totalSent, '‰ª∂')}
                    ${renderStatItem('Ëøî‰ø°Êï∞', orgStats.replied, '‰ª∂', `Ëøî‰ø°Áéá: ${orgStats.replyRate}%`)}
                    ${renderStatItem('Èù¢Ë´áË®≠ÂÆöÊï∞', orgStats.interview, '‰ª∂', `Èù¢Ë´áÁéá: ${orgStats.interviewRate}%`)}
            `);

                userStatsContainer.html(`
                    ${renderStatItem('Á∑èÈÄÅ‰ø°Êï∞', userStats.totalSent, '‰ª∂')}
                    ${renderStatItem('Ëøî‰ø°Êï∞', userStats.replied, '‰ª∂', `Ëøî‰ø°Áéá: ${userStats.replyRate}%`)}
                    ${renderStatItem('Èù¢Ë´áË®≠ÂÆöÊï∞', userStats.interview, '‰ª∂', `Èù¢Ë´áÁéá: ${userStats.interviewRate}%`)}
            `);

                // --- Render Details Table (Org Wide) ---
                // Shows breakdown by status
                const statuses = ['sent', 'replied', 'interview', 'rejected', 'hired'];
                const statusLabels = { sent: 'ÈÄÅ‰ø°Ê∏à(Êú™Ë™≠/Êú™Ëøî‰ø°)', replied: 'Ëøî‰ø°„ÅÇ„Çä', interview: 'Èù¢Ë´áË®≠ÂÆö', rejected: 'ËæûÈÄÄ/‰∏çÊé°Áî®', hired: 'Êé°Áî®Ê±∫ÂÆö' };

                const rows = statuses.map(s => {
                    const count = messages.filter(m => m.status === s).length;
                    const rate = orgStats.totalSent > 0 ? ((count / orgStats.totalSent) * 100).toFixed(1) : '0.0';
                    return `
                <tr>
                            <td class="px-6 py-4 text-sm text-gray-900">${statusLabels[s]}</td>
                            <td class="px-6 py-4 text-sm text-gray-900 text-right">${count} ‰ª∂</td>
                            <td class="px-6 py-4 text-sm text-gray-500 text-right">${rate} %</td>
                        </tr>
                `;
                }).join('');

                detailsContainer.html(`
                <table class="min-w-full divide-y divide-gray-200 border border-gray-200 rounded">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">‰ª∂Êï∞</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">ÊßãÊàêÊØî</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${rows}
                        </tbody>
                    </table>
                `);

            } catch (e) {
                console.error("Analytics Error:", e);
                userStatsContainer.html('<p class="text-red-500">Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº</p>');
            }
        }
        // ========================
        // Admin Settings
        // ========================
        window.loadAdminSettings = async function () {
            if (!currentUser) return;

            try {
                // ÁµÑÁπîÊÉÖÂ†±„ÇíÂèñÂæó
                const { data: org, error } = await supabase
                    .from('organizations')
                    .select('settings')
                    .eq('id', currentUser.organization_id)
                    .single();

                if (error) throw error;

                // Ë®≠ÂÆöÂÄ§„Çí„Éï„Ç©„Éº„É†„Å´ÂèçÊò†
                const settings = org.settings || {};
                const visibility = settings.analysis_history_visibility || 'all';
                const scoutVisibility = settings.scout_history_visibility || 'all';

                $('input[name="setting-history-visibility"][value="' + visibility + '"]').prop('checked', true);
                $('input[name="setting-scout-visibility"][value="' + scoutVisibility + '"]').prop('checked', true);

                // Ê±Ç‰∫∫„Ç§„É≥„Éù„Éº„ÉàË®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø
                $('#admin-setting-bulk-duplicate-confirm').prop('checked', settings.bulk_duplicate_confirm_enabled === true);

                // „É°„Éº„É´ÈÄöÁü•Ë®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø
                const emailSettings = settings.email_notification_settings || { candidate_notifications: {} };
                const candNotifs = emailSettings.candidate_notifications || {};

                $('#admin-setting-email-all-off').prop('checked', candNotifs.all_off === true).trigger('change');
                $('#admin-setting-email-application').prop('checked', candNotifs.application_submitted !== false);
                $('#admin-setting-email-scout').prop('checked', candNotifs.scout !== false);
                $('#admin-setting-email-recommendation').prop('checked', candNotifs.recommendation !== false);
                $('#admin-setting-email-status-enabled').prop('checked', candNotifs.status_changed_enabled !== false).trigger('change');

                // ÂÖ±ÈÄöÈÄöÁü•ÂÖà„ÅÆË®≠ÂÆöË™≠„ÅøËæº„Åø
                const commonEmails = emailSettings.common_notifications || [];
                $('#admin-setting-email-common').val(commonEmails.join(', '));

                populateAdminEmailStatusList(candNotifs.status_changed_excluded_statuses || []);

            } catch (error) {
                console.error('Load admin settings error:', error);
                alert('Ë®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        };

        window.saveAdminSettings = async function () {
            if (!currentUser) return;

            if (!confirm('Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) return;

            try {
                // 1. ÁèæÂú®„ÅÆË®≠ÂÆö„ÇíÂèñÂæóÔºà„Éû„Éº„Ç∏„Åô„Çã„Åü„ÇÅÔºâ
                const { data: currentOrg, error: fetchError } = await supabase
                    .from('organizations')
                    .select('settings')
                    .eq('id', currentUser.organization_id)
                    .single();

                if (fetchError) throw fetchError;

                let newSettings = currentOrg.settings || {};

                // 2. „Éï„Ç©„Éº„É†„Åã„ÇâÂÄ§„ÇíÂèñÂæó„Åó„Å¶Êõ¥Êñ∞
                const visibility = $('input[name="setting-history-visibility"]:checked').val();
                const scoutVisibility = $('input[name="setting-scout-visibility"]:checked').val();

                // Â§âÊõ¥„Åï„Çå„Åü„Éà„ÉÉ„Éó„É¨„Éô„É´„Ç≠„Éº„ÅÆ„Åø„ÇíÁ¢∫ÂÆü„Å´„Çª„ÉÉ„Éà
                newSettings.analysis_history_visibility = visibility;
                newSettings.scout_history_visibility = scoutVisibility;
                newSettings.bulk_duplicate_confirm_enabled = $('#admin-setting-bulk-duplicate-confirm').is(':checked');

                // ÂÖ±ÈÄöÈÄöÁü•ÂÖà„ÅÆË®≠ÂÆöÂèñÂæó
                const commonEmailsRaw = $('#admin-setting-email-common').val();
                const commonEmails = commonEmailsRaw ? commonEmailsRaw.split(/[\n,]+/).map(e => e.trim()).filter(e => e && e.includes('@')) : [];

                // Ê∑±„ÅÑÈöéÂ±§ (email_notification_settings) „ÇÇ„Éû„Éº„Ç∏„Åô„Çã„Çà„ÅÜ„Å´‰øÆÊ≠£
                if (!newSettings.email_notification_settings) {
                    newSettings.email_notification_settings = {};
                }

                // Êó¢Â≠ò„ÅÆ email_notification_settings „ÇíÁ†¥Â£ä„Åó„Å™„ÅÑ„Çà„ÅÜ„Å´„Éû„Éº„Ç∏
                newSettings.email_notification_settings = {
                    ...newSettings.email_notification_settings,
                    candidate_notifications: {
                        ...(newSettings.email_notification_settings.candidate_notifications || {}),
                        all_off: $('#admin-setting-email-all-off').is(':checked'),
                        application_submitted: $('#admin-setting-email-application').is(':checked'),
                        scout: $('#admin-setting-email-scout').is(':checked'),
                        recommendation: $('#admin-setting-email-recommendation').is(':checked'),
                        status_changed_enabled: $('#admin-setting-email-status-enabled').is(':checked'),
                        status_changed_excluded_statuses: $('.admin-email-status-exclude-checkbox:checked').map(function () { return $(this).val(); }).get()
                    },
                    common_notifications: commonEmails
                };

                // 3. ‰øùÂ≠ò (RPC„Çí‰ΩøÁî®)
                const { error: updateError } = await supabase
                    .rpc('update_organization_settings', { new_settings: newSettings });

                if (updateError) throw updateError;

                alert('Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');

            } catch (error) {
                console.error('Save admin settings error:', error);
                alert('Ë®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (error.message || error.details || JSON.stringify(error)));
            }
        };

        // ============================================
        // KPI Dashboard Logic
        // ============================================
        let kpiChartFunnel = null;
        let kpiChartActivity = null;

        async function loadKPIDashboard() {
            const currentUser = window.currentUser;
            const supabase = window.supabase;
            if (!currentUser || !currentUser.organization_id) return;

            window.showLoading('KPI„Éá„Éº„Çø„ÇíÈõÜË®à‰∏≠...');

            try {
                // 1. Get Filters
                const period = $('#kpi-filter-period').val();
                const userIdFilter = $('#kpi-filter-user').val();

                // 2. Fetch Data
                // Fetch Applications (with Job and User info)
                let query = supabase
                    .from('applications')
                    .select('*, jobs!inner(title, salary_min, salary_max, company), users!applications_user_id_fkey!inner(name, coach_id)')
                    .eq('jobs.organization_id', currentUser.organization_id);

                // Period Filter
                const now = new Date();
                let startDate;
                if (period === 'this_month') startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                else if (period === 'last_month') startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                else if (period === 'this_quarter') startDate = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
                else if (period === 'this_year') startDate = new Date(now.getFullYear(), 0, 1);

                if (startDate) {
                    query = query.gte('updated_at', startDate.toISOString());
                }

                if (userIdFilter) {
                    query = query.eq('users.coach_id', userIdFilter);
                }

                const { data: applications, error } = await query;
                if (error) throw error;

                // Load Coaches for Mapping and Filter
                const { data: allCoaches } = await window.supabase
                    .from('users')
                    .select('id, name')
                    .eq('organization_id', currentUser.organization_id)
                    .in('role', ['coach', 'admin', 'org_admin', 'super_admin']);

                const coachNameMap = {};
                if (allCoaches) {
                    allCoaches.forEach(c => {
                        coachNameMap[c.id] = c.name;
                        // Populate filter if empty (or missing)
                        if ($('#kpi-filter-user option[value="' + c.id + '"]').length === 0) {
                            $('#kpi-filter-user').append(`< option value = "${c.id}" > ${c.name}</option > `);
                        }
                    });
                }

                const summary = calculateKPISummary(applications || []);
                const funnelData = calculateKPIFunnel(applications || []);
                const activityData = calculateKPIActivity(applications || [], coachNameMap);
                const stagnantCases = identifyStagnantCases(applications || []);

                renderKPICards(summary);
                renderKPIFunnelChart(funnelData);
                renderKPIActivityChart(activityData);
                renderKPIStagnantTable(stagnantCases);

            } catch (e) {
                console.error('KPI Load Error:', e);
            } finally {
                window.hideLoading();
            }
        }

        function calculateKPISummary(apps) {
            let revenue = 0;
            let candidates = 0;
            let success = 0;
            const PROB = { 'pending': 0, 'applied': 0.1, 'interviewing': 0.3, 'offered': 0.8, 'rejected': 0, 'withdrawn': 0 };
            const FEE_RATE = 0.35;

            apps.forEach(app => {
                if (!['rejected', 'withdrawn', 'pending'].includes(app.status)) candidates++;
                if (app.status === 'offered') success++;
                const salary = app.jobs.salary_min || 4000000;
                const prob = PROB[app.status] || 0;
                revenue += (salary * FEE_RATE * prob);
            });
            return { revenue, candidates, success };
        }

        function calculateKPIFunnel(apps) {
            const counts = { 'applied': 0, 'interviewing': 0, 'offered': 0 };
            apps.forEach(app => {
                const s = app.status;
                if (['applied', 'interviewing', 'offered'].includes(s)) counts['applied']++;
                if (['interviewing', 'offered'].includes(s)) counts['interviewing']++;
                if (['offered'].includes(s)) counts['offered']++;
            });
            return counts;
        }

        function calculateKPIActivity(apps, nameMap) {
            const activity = {};
            apps.forEach(app => {
                const cid = app.users.coach_id;
                const name = cid ? (nameMap && nameMap[cid] ? nameMap[cid] : 'Unknown') : 'Êú™„Ç¢„Çµ„Ç§„É≥';

                if (!activity[name]) activity[name] = 0;
                activity[name]++;
            });
            return activity;
        }

        function identifyStagnantCases(apps) {
            const now = new Date();
            const thresholdDays = 5;
            const stagnant = [];
            apps.forEach(app => {
                if (['rejected', 'withdrawn', 'offered'].includes(app.status)) return;
                const lastUpdate = new Date(app.updated_at);
                const diffDays = Math.ceil(Math.abs(now - lastUpdate) / (1000 * 60 * 60 * 24));
                if (diffDays >= thresholdDays) stagnant.push({ ...app, days_stagnant: diffDays });
            });
            return stagnant;
        }

        function renderKPICards(summary) {
            $('#kpi-metric-revenue').text(`¬•${Math.floor(summary.revenue / 10000).toLocaleString()} ‰∏á`);
            $('#kpi-metric-candidates').text(summary.candidates);
            $('#kpi-metric-success').text(summary.success);
            fetchActiveJobs().then(jobs => { if (jobs) $('#kpi-metric-jobs').text(jobs.length); });
        }

        function renderKPIFunnelChart(data) {
            const ctx = document.getElementById('kpi-funnel-chart');
            if (!ctx) return;
            if (kpiChartFunnel) kpiChartFunnel.destroy();
            kpiChartFunnel = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Êõ∏È°ûÈÅ∏ËÄÉ/Êé®Ëñ¶', 'Èù¢Êé•‰∏≠', 'ÂÜÖÂÆö/ÊàêÁ¥Ñ'],
                    datasets: [{
                        label: 'ÂÄôË£úËÄÖÊï∞',
                        data: [data.applied, data.interviewing, data.offered],
                        backgroundColor: ['rgba(99, 102, 241, 0.5)', 'rgba(167, 139, 250, 0.5)', 'rgba(16, 185, 129, 0.5)'],
                        borderColor: ['rgb(99, 102, 241)', 'rgb(167, 139, 250)', 'rgb(16, 185, 129)'],
                        borderWidth: 1
                    }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function renderKPIActivityChart(activityData) {
            const ctx = document.getElementById('kpi-activity-chart');
            if (!ctx) return;
            if (kpiChartActivity) kpiChartActivity.destroy();
            kpiChartActivity = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: Object.keys(activityData),
                    datasets: [{ label: '„Ç¢„ÇØ„Ç∑„Éß„É≥Êï∞', data: Object.values(activityData), backgroundColor: 'rgba(59, 130, 246, 0.5)' }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }

        function renderKPIStagnantTable(cases) {
            const tbody = $('#kpi-stagnant-table-body');
            tbody.empty();
            $('#stagnant-cases-count').text(`${cases.length} ‰ª∂`);
            if (cases.length === 0) {
                tbody.html('<tr><td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">ÂÅúÊªû„Åó„Å¶„ÅÑ„ÇãÊ°à‰ª∂„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</td></tr>');
                return;
            }
            cases.forEach(c => {
                const tr = `<tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${c.users.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${c.jobs.title}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">${c.status}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(c.updated_at).toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">ID: ${c.users.coach_id || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><button class="text-indigo-600 hover:text-indigo-900">Ë©≥Á¥∞</button></td></tr>`;
                tbody.append(tr);
            });
        }

        // --- AI Search Agent Logic ---
        window.toggleAISearchChat = function () {
            const chat = $('#ai-search-agent-chat');
            const isVisible = chat.is(':visible');
            if (isVisible) {
                chat.fadeOut(200, () => chat.css('display', 'none'));
            } else {
                chat.css({
                    'display': 'flex',
                    'z-index': '1000000'
                }).hide().fadeIn(300);
                $('#ai-search-agent-trigger .notification-dot').hide();
                $('#ai-chat-input').focus();
            }
        };

        window.sendAIChatMessage = async function () {
            const input = $('#ai-chat-input');
            const text = input.val().trim();
            if (!text) return;

            // Clear input and add user bubble
            input.val('');
            addChatBubble('user', text);

            // Show typing indicator
            $('#chat-typing').show();
            scrollToBottom();

            let aiResponse = '';

            try {
                // Determine current context (what page am I on?)
                const currentPage = $('.nav-link.active').data('page') || 'dashboard';

                const { data, error } = await supabase.functions.invoke('ai-search-agent', {
                    body: {
                        prompt: text,
                        currentContext: currentPage
                    }
                });

                if (error) throw error;

                // Hide typing
                $('#chat-typing').hide();

                if (data.explanation) {
                    aiResponse = data.explanation;
                    addChatBubble('ai', data.explanation);
                }

                if (data.filters) {
                    applyAISearchFilters(data.searchType, data.filters);
                }

                // Log the inquiry
                if (window.currentUser) {
                    await supabase.from('support_inquiry_logs').insert({
                        user_id: currentUser.id,
                        organization_id: currentUser.organization_id,
                        message: text,
                        ai_response: aiResponse
                    });
                }

            } catch (error) {
                console.error('AI Search Error:', error);
                $('#chat-typing').hide();
                addChatBubble('ai', '„Åô„Åø„Åæ„Åõ„Çì„ÄÅÊ§úÁ¥¢Âá¶ÁêÜ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÊôÇÈñì„ÇíÁΩÆ„ÅÑ„Å¶ÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
            scrollToBottom();
        };

        function addChatBubble(role, text) {
            const container = $('#ai-chat-body');
            const bubble = $(`<div class="chat-bubble ${role}">${text}</div>`);
            container.append(bubble);
            scrollToBottom();
        }

        function scrollToBottom() {
            const container = $('#ai-chat-body');
            container.scrollTop(container[0].scrollHeight);
        }

        // Helper to match Select2 values by text label
        function setSelect2ByLabels($element, labels) {
            if (!labels || labels.length === 0) return;
            const values = [];
            $element.find('option').each(function () {
                const optText = $(this).text().trim();
                const optValue = $(this).val();
                if (labels.some(l => optText.includes(l) || l.includes(optText))) {
                    values.push(optValue);
                }
            });
            if (values.length > 0) {
                $element.val(values).trigger('change');
            }
        }

        async function applyAISearchFilters(type, filters) {
            console.log('Applying AI Filters:', type, filters);

            if (type === 'job') {
                // Switch to jobs page
                $(`.nav-link[data-page="jobs"]`).click();

                // Clear previous search if AI suggests it (Contextual behavior)
                if (filters.shouldClear !== false) { // Default to clear if not explicitly additive
                    if (window.clearSearch) window.clearSearch();
                }

                // Set keyword tags (split by spaces, tabs, or commas)
                if (filters.keyword) {
                    const words = filters.keyword.split(/[\s,„ÄÅ\t]+/).filter(w => w.length > 0);
                    const $input = $('#search-keyword');
                    words.forEach(word => {
                        $input.val(word);
                        const event = jQuery.Event("keypress");
                        event.which = 13;
                        $input.trigger(event);
                    });
                    // Clear the input after processing tags
                    $input.val('');

                    // Set mode if specified, default to AND
                    const mode = filters.keyword_mode || 'AND';
                    $(`input[name="search-keyword-mode"][value="${mode}"]`).prop('checked', true);
                }

                // Set location
                if (filters.location) {
                    const locations = filters.location.split(/[\s,„ÄÅ\t]+/).filter(l => l.length > 0);
                    const $locInput = $('#search-location');
                    locations.forEach(loc => {
                        $locInput.val(loc);
                        const event = jQuery.Event("keypress");
                        event.which = 13;
                        $locInput.trigger(event);
                    });
                    $locInput.val('');
                }

                // Set salary
                if (filters.salary_min) {
                    const salaryVal = filters.salary_min;
                    $('#search-salary-slider').val(salaryVal).trigger('input');
                    $('#search-salary-min').val(salaryVal);
                    // Update display text manually just in case trigger('input') doesn't catch it
                    $('#salary-display').text(salaryVal === '0' ? 'ÊåáÂÆö„Å™„Åó' : salaryVal + ' ‰∏áÂÜÜ‰ª•‰∏ä');
                }

                // Multi-selects (Select2)
                if (filters.prefectures && filters.prefectures.length > 0) {
                    setSelect2ByLabels($('#search-prefecture'), filters.prefectures);
                }
                if (filters.job_categories && filters.job_categories.length > 0) {
                    setSelect2ByLabels($('#search-job-category'), filters.job_categories);
                }
                if (filters.industry_categories && filters.industry_categories.length > 0) {
                    setSelect2ByLabels($('#search-industry-category'), filters.industry_categories);
                }
                if (filters.employment_types && filters.employment_types.length > 0) {
                    setSelect2ByLabels($('#search-employment-type'), filters.employment_types);
                }

                // Experience flags
                if (filters.job_experience_ok) {
                    $('#search-job-experience-ok').prop('checked', true);
                }
                if (filters.industry_experience_ok) {
                    $('#search-industry-experience-ok').prop('checked', true);
                }

                // Trigger search
                setTimeout(() => {
                    if (window.searchJobsImmediate) window.searchJobsImmediate();
                    else if (window.searchJobs) window.searchJobs();
                }, 800);

            } else if (type === 'candidate') {
                // Switch to candidate search page
                $(`.nav-link[data-page="candidate-search"]`).click();

                // Clear previous search if AI suggests it
                if (filters.shouldClear !== false) {
                    if (window.clearCandidateSearch) window.clearCandidateSearch();
                }

                // Set keyword tags
                if (filters.keyword) {
                    const words = filters.keyword.split(/[\s,„ÄÅ\t]+/).filter(w => w.length > 0);
                    const $input = $('#c-search-keyword');
                    words.forEach(word => {
                        $input.val(word);
                        const event = jQuery.Event("keypress");
                        event.which = 13;
                        $input.trigger(event);
                    });
                    $input.val('');

                    const mode = filters.keyword_mode || 'AND';
                    $(`input[name="c-search-keyword-mode"][value="${mode}"]`).prop('checked', true);
                }

                // Set location text
                if (filters.location) {
                    const locations = filters.location.split(/[\s,„ÄÅ\t]+/).filter(l => l.length > 0);
                    const $locInput = $('#c-search-location');
                    locations.forEach(loc => {
                        $locInput.val(loc);
                        const event = jQuery.Event("keypress");
                        event.which = 13;
                        $locInput.trigger(event);
                    });
                    $locInput.val('');
                }

                // Multi-selects
                if (filters.prefectures && filters.prefectures.length > 0) {
                    setSelect2ByLabels($('#c-search-prefecture'), filters.prefectures);
                }
                if (filters.job_categories && filters.job_categories.length > 0) {
                    setSelect2ByLabels($('#c-search-job-category'), filters.job_categories);
                }
                if (filters.industry_categories && filters.industry_categories.length > 0) {
                    setSelect2ByLabels($('#c-search-industry-category'), filters.industry_categories);
                }
                if (filters.employment_types && filters.employment_types.length > 0) {
                    setSelect2ByLabels($('#c-search-employment-type'), filters.employment_types);
                }
                if (filters.salary_min) {
                    const salaryVal = filters.salary_min;
                    $('#c-search-salary-slider').val(salaryVal).trigger('input');
                    $('#c-search-salary-min').val(salaryVal);
                    // Update display text
                    $('#c-salary-display').text(salaryVal === '0' ? 'ÊåáÂÆö„Å™„Åó' : salaryVal + ' ‰∏áÂÜÜ‰ª•‰∏ä');
                }

                // Trigger search
                setTimeout(() => {
                    if (window.searchCandidates) window.searchCandidates();
                }, 800);
            }
        }

        // FAQ Portal Logic (DB Driven)
        window.openFAQModal = async function () {
            console.log('Opening FAQ Modal...');
            try {
                const $modal = $('#faq-modal');
                if ($modal.length === 0) {
                    console.error('CRITICAL: #faq-modal not found in DOM!');
                    alert('„Ç∑„Çπ„ÉÜ„É†„Ç®„É©„ÉºÔºö„Éò„É´„Éó„Éù„Éº„Çø„É´„ÅÆÈÉ®ÂìÅ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }

                // Âº∑Âà∂ÁöÑ„Å´Ë°®Á§∫Áä∂ÊÖã„Å´„Åô„Çã
                $modal.removeClass('hidden').addClass('flex');

                // Âº∑Âà∂ÁöÑ„Å´Body„ÅÆÁõ¥‰∏ã„Å´ÁßªÂãïÔºàË¶™Ë¶ÅÁ¥†„ÅÆhiddenË®≠ÂÆö„ÇíÂõûÈÅø„Åô„Çã„Åü„ÇÅÔºâ
                if ($modal.parent().is('body') === false) {
                    $('body').append($modal);
                }

                $modal.css({
                    'display': 'flex',
                    'z-index': '999999',
                    'visibility': 'visible',
                    'opacity': '1',
                    'position': 'fixed',
                    'top': '0',
                    'left': '0',
                    'width': '100vw',
                    'height': '100vh'
                });

                console.log('Modal element state:', {
                    display: $modal.css('display'),
                    zIndex: $modal.css('z-index'),
                    visible: $modal.is(':visible'),
                    parent: $modal.parent().prop('tagName'),
                    parentVisible: $modal.parent().is(':visible'),
                    offset: $modal.offset()
                });

                await loadPortalFAQs();
                if (typeof switchFAQCategory === 'function') {
                    switchFAQCategory('all');
                }
            } catch (err) {
                console.error('Error opening FAQ Modal:', err);
                alert('„Éò„É´„Éó„Éù„Éº„Çø„É´„ÅÆË™≠„ÅøËæº„Åø‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        };

        window.closeFAQModal = function () {
            console.log('Closing FAQ Modal...');
            const $modal = $('#faq-modal');
            $modal.addClass('hidden').removeClass('flex');
            $modal.css({
                'display': 'none',
                'visibility': 'hidden',
                'opacity': '0'
            });
        };

        async function loadPortalFAQs() {
            console.log('loadPortalFAQs: starting...', { supabase: !!window.supabase, currentUser: !!currentUser });
            if (!window.supabase) return;
            if (!currentUser) {
                console.warn('loadPortalFAQs: currentUser is not defined');
                return;
            }
            const $container = $('#faq-content-area');
            if ($container.length === 0) {
                console.error('loadPortalFAQs: #faq-content-area not found');
                return;
            }
            $container.html('<div class="flex justify-center py-10"><div class="animate-spin rounded-full h-8 w-8 border-4 border-indigo-600 border-t-transparent"></div></div>');

            try {
                const orgId = currentUser.organization_id;
                console.log('loadPortalFAQs: fetching FAQs for org:', orgId);

                // Construct the OR filter carefully
                let filter = 'organization_id.is.null';
                if (orgId) {
                    filter = `organization_id.eq.${orgId},organization_id.is.null`;
                }

                const { data: faqs, error } = await supabase
                    .from('faqs')
                    .select('*')
                    .or(filter)
                    .eq('is_published', true)
                    .order('display_order', { ascending: true });

                if (error) {
                    console.error('Portal FAQ loading DB error:', error);
                    throw error;
                }

                if (!faqs || faqs.length === 0) {
                    $container.html('<div class="text-center py-10 text-slate-400">FAQ„ÅØ„Åæ„Å†ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ</div>');
                    return;
                }

                $container.empty();
                const categories = {
                    'start': { title: 'Â∞éÂÖ•„ÉªÂü∫Êú¨„Ç¨„Ç§„Éâ', icon: 'fa-rocket' },
                    'ai': { title: 'AI„Éû„ÉÉ„ÉÅ„É≥„Ç∞„ÅÆÊ¥ªÁî®', icon: 'fa-robot' },
                    'manage': { title: 'Ê±Ç‰∫∫„ÉªÈÄ≤ÊçóÁÆ°ÁêÜ', icon: 'fa-tasks' },
                    'trouble': { title: '„Éà„É©„Éñ„É´Ëß£Ê±∫', icon: 'fa-exclamation-triangle' }
                };

                Object.entries(categories).forEach(([key, info]) => {
                    const catFaqs = faqs.filter(f => f.category === key);
                    if (catFaqs.length === 0) return;

                    const $section = $(`
                            <div class="faq-category-section mb-10" data-category="${key}">
                                <h3 class="text-xl font-extrabold text-slate-800 mb-6 flex items-center gap-3 border-b-2 border-indigo-50 pb-3">
                                    <div class="w-10 h-10 rounded-xl bg-indigo-50 flex items-center justify-center">
                                        <i class="fas ${info.icon} text-indigo-600"></i>
                                    </div>
                                    ${info.title}
                                </h3>
                                <div class="space-y-4"></div>
                            </div>
                        `);

                    const $itemsContainer = $section.find('.space-y-4');
                    catFaqs.forEach(faq => {
                        const $item = $(`
                                <div class="faq-item group">
                                    <div class="faq-question cursor-pointer p-5 bg-white border border-slate-100 rounded-2xl hover:border-indigo-200 hover:shadow-md transition-all flex justify-between items-center"
                                         onclick="$(this).next().slideToggle().siblings('.faq-answer').slideUp()">
                                        <span class="font-bold text-slate-700 pr-8 line-clamp-2">${faq.question}</span>
                                        <i class="fas fa-chevron-down text-slate-300 group-hover:text-indigo-500 transition-transform"></i>
                                    </div>
                                    <div class="faq-answer hidden p-6 text-sm text-slate-600 bg-slate-50/50 border-x border-b rounded-b-2xl border-slate-100 leading-relaxed">
                                        ${faq.answer.replace(/\n/g, '<br>')}
                                        ${faq.image_url ? `<img src="${faq.image_url}" alt="FAQ Image" class="mt-4 rounded-xl border border-slate-200 shadow-sm max-w-full">` : ''}
                                    </div>
                                </div>
                            `);
                        $itemsContainer.append($item);
                    });
                    $container.append($section);
                });

            } catch (err) {
                console.error('Portal FAQ loading error:', err);
                $container.html('<div class="text-center py-10 text-red-500">FAQ„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ</div>');
            }
        }

        window.switchFAQCategory = function (cat) {
            $('.faq-nav-btn').removeClass('active bg-white shadow-sm').addClass('text-slate-600');
            $(`.faq-nav-btn[onclick*="${cat}"]`).addClass('active bg-white shadow-sm').removeClass('text-slate-600');

            if (cat === 'all') {
                $('.faq-category-section').show();
            } else {
                $('.faq-category-section').hide();
                $(`.faq-category-section[data-category="${cat}"]`).show();
            }
        };

        window.filterFAQ = function (query) {
            query = query.toLowerCase();
            $('.faq-item').each(function () {
                const text = $(this).text().toLowerCase();
                if (text.includes(query)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
            $('.faq-category-section').each(function () {
                const visibleItems = $(this).find('.faq-item:visible').length;
                if (visibleItems === 0) {
                    $(this).hide();
                } else {
                    $(this).show();
                }
            });
        };

        // --- Admin FAQ Management Logic ---
        window.switchAdminFAQTab = function (tab) {
            $('.admin-faq-tab').removeClass('border-indigo-600 text-indigo-600').addClass('border-transparent text-slate-500');
            $(`#admin-faq-tab-${tab}`).addClass('border-indigo-600 text-indigo-600').removeClass('border-transparent text-slate-500');

            if (tab === 'list') {
                $('#admin-faq-list-view').show();
                $('#admin-inquiry-logs-view').hide();
                loadAdminFAQs();
            } else {
                $('#admin-faq-list-view').hide();
                $('#admin-inquiry-logs-view').show();
                loadInquiryLogs();
            }
        };

        async function loadAdminFAQs() {
            if (!currentUser || !currentUser.organization_id) return;
            const $tbody = $('#admin-faq-table-body');
            $tbody.html('<tr><td colspan="4" class="px-6 py-12 text-center text-slate-400">Ë™≠„ÅøËæº„Åø‰∏≠...</td></tr>');

            try {
                const { data, error } = await supabase
                    .from('faqs')
                    .select('*')
                    .eq('organization_id', currentUser.organization_id) // Ensure only current org's FAQs are loaded
                    .order('display_order', { ascending: true });

                if (error) throw error;

                $tbody.empty();
                if (!data || data.length === 0) {
                    $tbody.html('<tr><td colspan="4" class="px-6 py-12 text-center text-slate-400">FAQ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„ÄåÂàùÊúü„Éá„Éº„Çø„ÇíÂêåÊúü„Äç„Éú„Çø„É≥„ÅßËøΩÂä†„Åß„Åç„Åæ„Åô„ÄÇ</td></tr>');
                    return;
                }

                data.forEach(faq => {
                    const row = $(`
                            <tr>
                                <td class="px-6 py-4">
                                    <span class="px-2 py-1 bg-slate-100 text-slate-600 rounded text-[10px] font-bold uppercase tracking-wider">${faq.category}</span>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm font-bold text-slate-800 mb-1">${faq.question}</div>
                                    <div class="text-xs text-slate-400 line-clamp-1">${faq.answer}</div>
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <span class="px-2 py-1 rounded text-[10px] font-bold ${faq.is_published ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-400'}">
                                        ${faq.is_published ? 'ÂÖ¨Èñã‰∏≠' : 'ÈùûÂÖ¨Èñã'}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <div class="flex justify-end gap-2">
                                        <button onclick="showFAQForm('${faq.id}')" class="text-slate-400 hover:text-indigo-600 p-2"><i class="fas fa-edit"></i></button>
                                        <button onclick="deleteFAQ('${faq.id}')" class="text-slate-400 hover:text-red-600 p-2"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </td>
                            </tr>
                        `);
                    $tbody.append(row);
                });
            } catch (err) {
                console.error('Load admin FAQs error:', err);
            }
        }

        window.showFAQForm = async function (id = null) {
            $('#faq-edit-form')[0].reset();
            $('#faq-id').val('');
            $('#faq-modal-title').text(id ? 'FAQ„ÅÆÁ∑®ÈõÜ' : 'Êñ∞Ë¶èFAQ‰ΩúÊàê');

            if (id) {
                const { data } = await supabase.from('faqs').select('*').eq('id', id).single();
                if (data) {
                    $('#faq-id').val(data.id);
                    $('#faq-category').val(data.category);
                    $('#faq-display-order').val(data.display_order);
                    $('#faq-question-input').val(data.question);
                    $('#faq-answer-input').val(data.answer);
                    $('#faq-image-url').val(data.image_url || '');
                    $('#faq-is-published').prop('checked', data.is_published);
                }
            }
            $('#faq-form-modal').removeClass('hidden').addClass('flex');
        };

        window.closeFAQForm = function () {
            $('#faq-form-modal').addClass('hidden').removeClass('flex');
        };

        window.saveFAQ = async function () {
            const id = $('#faq-id').val();
            const faqData = {
                category: $('#faq-category').val(),
                display_order: parseInt($('#faq-display-order').val()) || 0,
                question: $('#faq-question-input').val(),
                answer: $('#faq-answer-input').val(),
                image_url: $('#faq-image-url').val(),
                is_published: $('#faq-is-published').is(':checked'),
                organization_id: currentUser.organization_id
            };

            showLoading();
            try {
                let error;
                if (id) {
                    const { error: err } = await supabase.from('faqs').update(faqData).eq('id', id);
                    error = err;
                } else {
                    const { error: err } = await supabase.from('faqs').insert(faqData);
                    error = err;
                }

                if (error) throw error;
                closeFAQForm();
                loadAdminFAQs();
            } catch (err) {
                console.error('Save FAQ error:', err);
                alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            } finally {
                hideLoading();
            }
        };

        window.deleteFAQ = async function (id) {
            if (!confirm('„Åì„ÅÆFAQ„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) return;
            showLoading();
            try {
                const { error } = await supabase.from('faqs').delete().eq('id', id);
                if (error) throw error;
                loadAdminFAQs();
            } catch (err) {
                console.error('Delete FAQ error:', err);
            } finally {
                hideLoading();
            }
        };

        async function loadInquiryLogs() {
            if (!currentUser || !currentUser.id) return;
            const $tbody = $('#admin-inquiry-table-body');
            $tbody.html('<tr><td colspan="5" class="px-6 py-12 text-center text-slate-400">Ë™≠„ÅøËæº„Åø‰∏≠...</td></tr>');

            try {
                // Note: users(name) requires foreign key or profile relationship
                // If this fails with 400, ensure support_inquiry_logs table relates to users
                const { data, error } = await supabase
                    .from('support_inquiry_logs')
                    .select('*, users(name)')
                    .eq('organization_id', currentUser.organization_id) // Filter by organization
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) throw error;

                $tbody.empty();
                data.forEach(log => {
                    const row = $(`
                            <tr>
                                <td class="px-6 py-4 text-xs text-slate-400 whitespace-nowrap">${new Date(log.created_at).toLocaleString()}</td>
                                <td class="px-6 py-4 text-sm font-bold text-slate-800">${log.users?.name || '‰∏çÊòé'}</td>
                                <td class="px-6 py-4">
                                    <div class="text-sm text-slate-600 line-clamp-2">${log.message}</div>
                                </td>
                                <td class="px-6 py-4 text-center text-xs">
                                    <span class="px-2 py-1 rounded-full ${log.is_resolved ? 'bg-indigo-50 text-indigo-600' : 'bg-orange-50 text-orange-600'}">
                                        ${log.is_resolved ? 'FAQÂåñÊ∏à„Åø' : 'Êú™ÂØæÂøú'}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <button onclick="convertLogToFAQ('${log.id}')" class="text-indigo-600 text-xs font-bold hover:underline">FAQ„Å´ËøΩÂä†</button>
                                </td>
                            </tr>
                        `);
                    $tbody.append(row);
                });
            } catch (err) {
                console.error('Load inquiry logs error:', err);
            }
        }

        window.convertLogToFAQ = async function (logId) {
            const { data } = await supabase.from('support_inquiry_logs').select('*').eq('id', logId).single();
            if (data) {
                $('#faq-form-modal').removeClass('hidden').addClass('flex');
                $('#faq-question-input').val(data.message);
                $('#faq-answer-input').val(data.ai_response || '');
                // „Éû„Éº„Ç´„Éº„Å®„Åó„Å¶Êõ¥Êñ∞
                await supabase.from('support_inquiry_logs').update({ is_resolved: true }).eq('id', logId);
            }
        };

        window.syncHardcodedFAQsToDB = async function () {
            if (!confirm('ÁèæÂú®„ÅÆÂõ∫ÂÆö„Éá„Éº„Çø„ÇíDB„Å´ÂêåÊúü„Åó„Åæ„Åô„ÅãÔºüÔºàÈáçË§á„Åó„Å¶ÁôªÈå≤„Åï„Çå„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„ÅôÔºâ')) return;

            const currentFaqs = [
                { category: 'start', question: '„É≠„Ç∞„Ç§„É≥„Åß„Åç„Åæ„Åõ„ÇìÔºà„Éë„Çπ„ÉØ„Éº„ÉâÂøò„Çå„Å™„Å©Ôºâ', answer: '„É≠„Ç∞„Ç§„É≥ÁîªÈù¢„ÅÆ„Äå„Éë„Çπ„ÉØ„Éº„Éâ„Çí„ÅäÂøò„Çå„ÅÆÊñπ„Äç„É™„É≥„ÇØ„Åã„ÇâÂÜçË®≠ÂÆö„ÇíË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇËß£Ê±∫„Åó„Å™„ÅÑÂ†¥Âêà„ÅØÁÆ°ÁêÜËÄÖ„Åæ„Åü„ÅØ„Çµ„Éù„Éº„Éà„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ' },
                { category: 'start', question: 'Ê±ÇËÅ∑ËÄÖ„ÅØÂêå„ÅòÊ±Ç‰∫∫„Å´Ë§áÊï∞ÂõûÂøúÂãü„Åß„Åç„Åæ„Åô„ÅãÔºü', answer: '„ÅÑ„ÅÑ„Åà„ÄÅÂéüÂâá„Å®„Åó„Å¶1„Å§„ÅÆÊ±Ç‰∫∫„Å´ÂØæ„Åó„Å¶1Âõû„ÅÆÂøúÂãü„Å®„Å™„Çä„Åæ„Åô„ÄÇË™§„Å£„Å¶ËæûÈÄÄ„Åó„ÅüÂ†¥Âêà„Å™„Å©„ÅØÁÆ°ÁêÜÂÅ¥„Åß„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊàª„ÅôÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ' },
                { category: 'ai', question: '„Éû„ÉÉ„ÉÅ„É≥„Ç∞Á≤æÂ∫¶„Çí‰∏ä„Åí„Çã„Å´„ÅØÔºü', answer: 'Ê±ÇËÅ∑ËÄÖ„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´ÔºàÁâπ„Å´ËÅ∑ÂãôÁµåÊ≠¥Ôºâ„ÇíÂÖ∑‰ΩìÁöÑ„Å´Ë®òÂÖ•„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Åæ„Åü„ÄÅÊ±Ç‰∫∫„ÅÆ„ÄåÊ•≠ÂãôÂÜÖÂÆπ„Äç„Å®„ÄåÂøúÂãüË≥áÊ†º„Äç„ÇíË©≥Á¥∞„Å´Ë®òËºâ„Åô„Çã„Åì„Å®„ÅßAI„ÅÆÂàÜÊûêÁ≤æÂ∫¶„ÅåÂêë‰∏ä„Åó„Åæ„Åô„ÄÇ' },
                { category: 'ai', question: '„Çπ„Ç´„Ç¶„ÉàÊñáÈù¢„Åå‰ΩúÊàêÈÄî‰∏≠„ÅßÊ≠¢„Åæ„Å£„Å¶„Åó„Åæ„ÅÜ', answer: '„Éñ„É©„Ç¶„Ç∂„Çí„É™„É≠„Éº„Éâ„Åó„Å¶ÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇAI„ÅÆÂøúÁ≠îÂà∂Èôê„Å´ÈÅî„Åó„ÅüÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÈ†ªÁπÅ„Å´Áô∫Áîü„Åô„ÇãÂ†¥Âêà„ÅØ„Ç≥„É°„É≥„Éà„ÇíÂ∞ë„ÅóÁü≠„Åè„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ' },
                { category: 'trouble', question: 'CSV„Ç§„É≥„Éù„Éº„Éà„ÅßÂ§±Êïó„Åô„Çã', answer: '„Åæ„Åö„ÅØ„Éò„ÉÉ„ÉÄ„ÉºË°å„ÅåÊ≠£„Åó„ÅÑ„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Åæ„Åü„ÄÅÊñáÂ≠ó„Ç≥„Éº„Éâ„ÅåUTF-8„Åß„ÅÇ„Çã„Åì„Å®„ÄÅÂøÖÈ†àÈ†ÖÁõÆÔºàÂêçÂâç„ÄÅ„É°„Éº„É´„Ç¢„Éâ„É¨„ÇπÁ≠âÔºâ„ÅåÂüã„Åæ„Å£„Å¶„ÅÑ„Çã„Åã„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ' }
            ];

            showLoading('ÂêåÊúü‰∏≠...');
            try {
                for (const faq of currentFaqs) {
                    await supabase.from('faqs').insert({
                        ...faq,
                        organization_id: currentUser.organization_id,
                        is_published: true
                    });
                }
                alert('ÂêåÊúü„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü');
                loadAdminFAQs();
            } catch (err) {
                console.error('Sync error:', err);
            } finally {
                hideLoading();
            }
        };

        $(document).on('page-switched', function (e, pageId) {
            if (pageId === 'admin-faqs') {
                loadAdminFAQs();
            }
        });

        // ========================
        // Admin: Data Management (Duplicate Detection & Merge)
        // ========================
        let duplicateResultsCache = [];
        let currentMergeData = { type: '', recordA: null, recordB: null };

        window.loadDataCleanupSettings = async function () {
            if (!currentUser) return;
            try {
                // Get fresh organization settings
                const { data: org, error } = await supabase
                    .from('organizations')
                    .select('settings')
                    .eq('id', currentUser.organization_id)
                    .single();

                if (error) throw error;

                const settings = org.settings?.data_cleanup;
                if (!settings) return;

                // Restore company criteria
                if (settings.company) {
                    $('#criteria-company-name').prop('checked', settings.company.name);
                    $('#criteria-company-phone').prop('checked', settings.company.phone);
                    $('#criteria-company-domain').prop('checked', settings.company.domain);
                    $('#criteria-company-address').prop('checked', settings.company.address);
                }

                // Restore job criteria
                if (settings.job) {
                    $('#criteria-job-title').prop('checked', settings.job.title);
                    $('#criteria-job-company').prop('checked', settings.job.same_company);
                    $('#criteria-job-location').prop('checked', settings.job.location);
                    $('#criteria-job-salary').prop('checked', settings.job.salary);
                    $('#criteria-job-category').prop('checked', settings.job.category);
                    $('#criteria-job-employment').prop('checked', settings.job.employment);
                }
            } catch (err) {
                console.error('Load settings error:', err);
            }
        };

        window.saveDataCleanupSettings = async function () {
            if (!currentUser) return;
            showLoading();
            try {
                const settings = {
                    company: {
                        name: $('#criteria-company-name').is(':checked'),
                        phone: $('#criteria-company-phone').is(':checked'),
                        domain: $('#criteria-company-domain').is(':checked'),
                        address: $('#criteria-company-address').is(':checked')
                    },
                    job: {
                        title: $('#criteria-job-title').is(':checked'),
                        same_company: $('#criteria-job-company').is(':checked'),
                        location: $('#criteria-job-location').is(':checked'),
                        salary: $('#criteria-job-salary').is(':checked'),
                        category: $('#criteria-job-category').is(':checked'),
                        employment: $('#criteria-job-employment').is(':checked')
                    },
                    updated_at: new Date().toISOString()
                };

                const { error } = await supabase
                    .from('organizations')
                    .update({ settings: { ...currentUser.org_settings, data_cleanup: settings } })
                    .eq('id', currentUser.organization_id);

                if (error) throw error;
                alert('Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
            } catch (err) {
                console.error('Save settings error:', err);
                alert('Ë®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            } finally {
                hideLoading();
            }
        };

        window.detectDuplicates = async function () {
            const activeTab = $('.data-mgmt-tab.border-indigo-500').data('type');
            showLoading(activeTab === 'company' ? 'ÈáçË§á‰ºÅÊ•≠„ÇíÊ§úÁ¥¢‰∏≠...' : 'ÈáçË§áÊ±Ç‰∫∫„ÇíÊ§úÁ¥¢‰∏≠...');

            try {
                const resultsContainer = $('#data-mgmt-results');
                resultsContainer.html('<div class="text-center py-10"><i class="fas fa-spinner fa-spin text-3xl text-indigo-600"></i></div>');

                if (activeTab === 'company') {
                    await runCompanyDuplicateCheck();
                } else {
                    await runJobDuplicateCheck();
                }
            } catch (err) {
                console.error('Detection error:', err);
                alert('Ê§úÁ¥¢‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            } finally {
                hideLoading();
            }
        };

        async function runCompanyDuplicateCheck() {
            const checkName = $('#criteria-company-name').is(':checked');
            const checkPhone = $('#criteria-company-phone').is(':checked');
            const checkDomain = $('#criteria-company-domain').is(':checked');
            const checkAddress = $('#criteria-company-address').is(':checked');

            const { data: companies, error } = await supabase
                .from('companies')
                .select('*')
                .eq('organization_id', currentUser.organization_id)
                .order('created_at', { ascending: false }); // Êñ∞„Åó„ÅÑÈ†Ü„Å´ÂèñÂæó„Åó„Å¶Âà§ÂÆö„Åó„ÇÑ„Åô„Åè„Åô„Çã

            if (error) throw error;

            const duplicates = [];
            const seen = new Map();

            companies.forEach(co => {
                let key = '';
                if (checkName) key += co.name.replace(/\s+/g, '').toLowerCase();
                if (checkPhone && co.phone) key += '|' + co.phone.replace(/[-\s]/g, '');
                if (checkDomain && co.website) {
                    try {
                        const url = new URL(co.website.startsWith('http') ? co.website : 'http://' + co.website);
                        key += '|' + url.hostname.replace('www.', '');
                    } catch (e) { }
                }

                if (key && seen.has(key)) {
                    duplicates.push({ original: seen.get(key), duplicate: co });
                } else if (key) {
                    seen.set(key, co);
                }
            });

            renderDuplicateResults('company', duplicates);
        }

        async function runJobDuplicateCheck() {
            const checkTitle = $('#criteria-job-title').is(':checked');
            const checkCo = $('#criteria-job-company').is(':checked');
            const checkLoc = $('#criteria-job-location').is(':checked');
            const checkSalary = $('#criteria-job-salary').is(':checked');
            const checkCategory = $('#criteria-job-category').is(':checked');
            const checkEmployment = $('#criteria-job-employment').is(':checked');

            const { data: jobs, error } = await supabase
                .from('jobs')
                .select('*, companies(name)')
                .eq('organization_id', currentUser.organization_id)
                .is('deleted_at', null)
                .order('created_at', { ascending: false });

            if (error) throw error;

            const duplicates = [];
            const seen = new Map();

            jobs.forEach(job => {
                let key = '';
                if (checkTitle) key += job.title.replace(/\s+/g, '').toLowerCase();
                if (checkCo) key += '|' + (job.company_id || job.company);
                if (checkLoc && job.location) key += '|' + job.location.split(/[„ÄÅ\s]/)[0];
                if (checkSalary) key += '|' + (job.salary_min || 0) + '-' + (job.salary_max || 0);
                if (checkCategory) key += '|' + (job.job_category || '');
                if (checkEmployment) key += '|' + (job.employment_type || '');

                if (key && seen.has(key)) {
                    duplicates.push({ original: seen.get(key), duplicate: job });
                } else if (key) {
                    seen.set(key, job);
                }
            });

            renderDuplicateResults('job', duplicates);
        }

        function renderDuplicateResults(type, duplicates) {
            const container = $('#data-mgmt-results');
            duplicateResultsCache = duplicates;

            if (duplicates.length === 0) {
                container.html(`
                    <div class="text-center py-20 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                        <i class="fas fa-check-circle text-5xl text-green-400 mb-4"></i>
                        <p class="text-gray-600 font-medium">ÈáçË§á„ÅØË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</p>
                    </div>
                `);
                return;
            }

            let html = `
                <div class="mb-6 flex justify-between items-center bg-indigo-50 p-4 rounded-xl border border-indigo-100 shadow-sm">
                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <input type="checkbox" id="bulk-select-all" class="w-5 h-5 rounded text-indigo-600 focus:ring-indigo-500 border-gray-300" onchange="$('.duplicate-checkbox').prop('checked', this.checked)">
                            <span class="text-sm font-bold text-gray-700 group-hover:text-indigo-600">ÂÖ®ÈÅ∏Êäû (${duplicates.length} ÁµÑ)</span>
                        </label>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="executeBulkMerge('${type}')" class="px-5 py-2.5 bg-indigo-600 text-white rounded-lg text-sm font-bold hover:bg-indigo-700 shadow-sm transition-all hover:scale-[1.02] active:scale-[0.98]">
                            <i class="fas fa-layer-group mr-1.5"></i> ÈÅ∏Êäû„Åó„ÅüÈ†ÖÁõÆ„Çí‰∏ÄÊã¨Áµ±Âêà
                        </button>
                        <button onclick="ignoreSelectedDuplicates()" class="px-5 py-2.5 bg-white text-gray-600 border border-gray-200 rounded-lg text-sm font-bold hover:bg-gray-50 transition shadow-sm">
                            ‰∏ÄÊã¨ÁÑ°Ë¶ñ
                        </button>
                    </div>
                </div>
                <div class="space-y-4">
            `;

            duplicates.forEach((pair, idx) => {
                // ‰ΩúÊàêÊó•ÊôÇ„ÅßÊñ∞Êóß„ÇíÂà§ÂÆö
                const timeA = new Date(pair.original.created_at || 0).getTime();
                const timeB = new Date(pair.duplicate.created_at || 0).getTime();

                // Êñ∞„Åó„ÅÑÊñπ„Åå„ÄåÊñ∞„Äç„ÄÅÂè§„ÅÑÊñπ„Åå„ÄåÊóß„Äç
                const isANewer = timeA >= timeB;
                const labelA = `„É¨„Ç≥„Éº„ÉâA ${isANewer ? '<span class="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded ml-1">Êñ∞</span>' : '<span class="px-1.5 py-0.5 bg-gray-100 text-gray-600 rounded ml-1">Êóß</span>'}`;
                const labelB = `„É¨„Ç≥„Éº„ÉâB ${!isANewer ? '<span class="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded ml-1">Êñ∞</span>' : '<span class="px-1.5 py-0.5 bg-gray-100 text-gray-600 rounded ml-1">Êóß</span>'}`;
                const bgA = isANewer ? 'bg-blue-50/50' : 'bg-gray-50/50';
                const bgB = !isANewer ? 'bg-blue-50/50' : 'bg-gray-50/50';
                const borderA = isANewer ? 'border-blue-100' : 'border-gray-100';
                const borderB = !isANewer ? 'border-blue-100' : 'border-gray-100';

                html += `
                    <div class="bg-white border rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow group">
                        <div class="flex items-center p-4">
                            <div class="mr-4">
                                <input type="checkbox" class="duplicate-checkbox w-5 h-5 rounded text-indigo-600 border-gray-300" data-index="${idx}">
                            </div>
                            <div class="flex-1 grid grid-cols-2 gap-6">
                                <div class="p-3 ${bgA} rounded-lg border ${borderA}">
                                    <div class="flex justify-between items-center mb-1.5">
                                        <div class="text-[10px] font-black text-gray-500 uppercase flex items-center">${labelA}</div>
                                        <div class="text-[9px] text-gray-400 font-mono">${new Date(pair.original.created_at).toLocaleDateString()}</div>
                                    </div>
                                    <div class="font-bold text-gray-900">${type === 'company' ? pair.original.name : pair.original.title}</div>
                                    <div class="text-xs text-gray-500 mt-1">${type === 'company' ? (pair.original.industry || 'Ê•≠Á®Æ‰∏çÊòé') : (pair.original.companies?.name || pair.original.company)}</div>
                                </div>
                                <div class="p-3 ${bgB} rounded-lg border ${borderB}">
                                    <div class="flex justify-between items-center mb-1.5">
                                        <div class="text-[10px] font-black text-gray-500 uppercase flex items-center">${labelB}</div>
                                        <div class="text-[9px] text-gray-400 font-mono">${new Date(pair.duplicate.created_at).toLocaleDateString()}</div>
                                    </div>
                                    <div class="font-bold text-gray-900">${type === 'company' ? pair.duplicate.name : pair.duplicate.title}</div>
                                    <div class="text-xs text-gray-500 mt-1">${type === 'company' ? (pair.duplicate.industry || 'Ê•≠Á®Æ‰∏çÊòé') : (pair.duplicate.companies?.name || pair.duplicate.company)}</div>
                                </div>
                            </div>
                            <div class="ml-6 flex flex-col gap-2">
                                <button onclick="openMergeModal('${type}', ${idx})" class="px-4 py-2 bg-indigo-50 text-indigo-600 rounded-lg text-sm font-bold hover:bg-indigo-100 transition whitespace-nowrap">
                                    Ë©≥Á¥∞„ÉªÊâãÂãïÁµ±Âêà
                                </button>
                                <button onclick="$(this).closest('.rounded-xl').fadeOut()" class="px-4 py-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg text-sm transition">
                                    ÁÑ°Ë¶ñ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `</div>`;
            container.html(html);
        }

        window.ignoreSelectedDuplicates = function () {
            const count = $('.duplicate-checkbox:checked').length;
            if (count === 0) return;
            $('.duplicate-checkbox:checked').closest('.rounded-xl').fadeOut();
        };

        window.executeBulkMerge = async function (type) {
            const selectedIndices = $('.duplicate-checkbox:checked').map(function () { return $(this).data('index'); }).get();
            if (selectedIndices.length === 0) {
                alert('Áµ±Âêà„Åô„ÇãÈ†ÖÁõÆ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            if (!confirm(`${selectedIndices.length} ÁµÑ„ÅÆ„Éá„Éº„Çø„Çí‰∏ÄÊã¨Áµ±Âêà„Åó„Åæ„Åô„ÅãÔºü\n\n„ÄêÁµ±Âêà„É´„Éº„É´„Äë\n„ÉªÂè§„ÅÑÊñπ„ÅÆ„É¨„Ç≥„Éº„Éâ„ÇíÊÆã„Åó„ÄÅÈñ¢ÈÄ£„Éá„Éº„Çø„ÇíÂºï„ÅçÁ∂ô„Åé„Åæ„Åô\n„ÉªÊñ∞„Åó„ÅÑÊñπ„Å´„ÅÆ„ÅøÂ≠òÂú®„Åô„ÇãÈ†ÖÁõÆ„ÅØ„ÄÅÊÆã„Åô„É¨„Ç≥„Éº„Éâ„Å´Ë£úÂÆå„Åï„Çå„Åæ„Åô\n„ÉªÁµ±ÂêàÂæå„ÄÅÊñ∞„Åó„ÅÑÊñπ„ÅÆ„É¨„Ç≥„Éº„Éâ„ÅØÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ`)) return;

            showLoading(`${selectedIndices.length} ÁµÑ„ÅÆÁµ±Âêà„ÇíÂá¶ÁêÜ‰∏≠...`);
            let successContent = 0;
            let errors = 0;

            try {
                for (const idx of selectedIndices) {
                    const pair = duplicateResultsCache[idx];
                    const recordA = pair.original;
                    const recordB = pair.duplicate;

                    // ‰ΩúÊàêÊó•ÊôÇ„ÅßÂÆüÈöõ„ÅÆÊñ∞Êóß„ÇíÁâπÂÆö
                    const timeA = new Date(recordA.created_at || 0).getTime();
                    const timeB = new Date(recordB.created_at || 0).getTime();

                    const older = timeA <= timeB ? recordA : recordB;
                    const newer = timeA <= timeB ? recordB : recordA;

                    // Êõ¥Êñ∞Áî®„Éá„Éº„Çø„ÅÆ‰ΩúÊàê (Êñ∞„Åó„ÅÑÊñπ„ÅÆÂÄ§„ÇíÂÑ™ÂÖà„Åó„Å¶Ë£úÂÆå)
                    const updates = {};
                    const fields = type === 'company'
                        ? ['name', 'industry', 'location', 'website', 'phone', 'description']
                        : ['title', 'company', 'location', 'employment_type', 'salary_min', 'salary_max'];

                    fields.forEach(f => {
                        // Âè§„ÅÑÊñπ„ÅåÁ©∫„ÅßÊñ∞„Åó„ÅÑÊñπ„Å´„ÅÇ„ÇãÂ†¥Âêà„ÄÅ„Åæ„Åü„ÅØ‰∏°Êñπ„ÅÇ„Çã„ÅåÊñ∞„Åó„ÅÑÊñπ„ÅåÂÑ™ÂÖàÁöÑ„Å´Êâ±„Çè„Çå„Çã„Åπ„ÅçÂ†¥Âêà
                        updates[f] = newer[f] || older[f];
                    });

                    const targetTable = type === 'company' ? 'companies' : 'jobs';

                    // 1. Âè§„ÅÑÊñπÔºà„Éô„Éº„ÇπÔºâ„ÇíÊõ¥Êñ∞
                    const { error: updateError } = await supabase.from(targetTable).update(updates).eq('id', older.id);
                    if (updateError) { console.error('Update error:', updateError); errors++; continue; }

                    // 2. Èñ¢ÈÄ£„Éá„Éº„Çø„ÅÆÁ¥ê„Å•„ÅëÊõø„Åà (Êñ∞„Åó„ÅÑÊñπ„Å∏„ÅÆÁ¥ê„Å•„Åë„Çí„ÄÅÊÆã„ÅôÂè§„ÅÑÊñπ„Å∏ÁßªÂãï)
                    if (type === 'company') {
                        await supabase.from('jobs').update({ company_id: older.id }).eq('company_id', newer.id);
                    } else {
                        await supabase.from('applications').update({ job_id: older.id }).eq('job_id', newer.id);
                        await supabase.from('recommendations').update({ job_id: older.id }).eq('job_id', newer.id);
                        await supabase.from('favorites').update({ job_id: older.id }).eq('job_id', newer.id);
                    }

                    // 3. ÈáçË§áÂÅ¥„ÅÆÂâäÈô§
                    if (type === 'job') {
                        await supabase.from('jobs').update({ deleted_at: new Date().toISOString() }).eq('id', newer.id);
                    } else {
                        await supabase.from('companies').delete().eq('id', newer.id);
                    }
                    successContent++;
                }

                alert(`${successContent} ÁµÑ„ÅÆÁµ±Âêà„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü${errors > 0 ? ` (${errors}‰ª∂„ÅÆÂá¶ÁêÜ„ÅßÂïèÈ°å„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü)` : ''}`);
                detectDuplicates();
            } catch (err) {
                console.error('Bulk merge error:', err);
                alert('‰∏ÄÊã¨Áµ±Âêà‰∏≠„Å´‰∫àÊúü„Åõ„Å¨„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            } finally {
                hideLoading();
            }
        };

        window.openMergeModal = function (type, index) {
            const pair = duplicateResultsCache[index];
            currentMergeData = { type, recordA: pair.original, recordB: pair.duplicate };

            const container = $('#merge-fields-container');
            container.empty();

            let fields = [];
            if (type === 'company') {
                fields = [
                    { key: 'name', label: '‰ºÅÊ•≠Âêç' },
                    { key: 'industry', label: 'Ê•≠Á®Æ' },
                    { key: 'location', label: 'ÊâÄÂú®Âú∞' },
                    { key: 'website', label: '„Ç¶„Çß„Éñ„Çµ„Ç§„Éà' },
                    { key: 'phone', label: 'ÈõªË©±Áï™Âè∑' },
                    { key: 'description', label: '‰ºÅÊ•≠Ë™¨Êòé' }
                ];
            } else {
                fields = [
                    { key: 'title', label: 'Ê±Ç‰∫∫„Çø„Ç§„Éà„É´' },
                    { key: 'company', label: '‰ºÅÊ•≠Âêç(Snap)' },
                    { key: 'location', label: 'Âã§ÂãôÂú∞' },
                    { key: 'employment_type', label: 'ÈõáÁî®ÂΩ¢ÊÖã' },
                    { key: 'salary_min', label: 'ÊúÄ‰ΩéÂπ¥Âèé', format: v => v ? (v / 10000) + '‰∏á' : '-' },
                    { key: 'salary_max', label: 'ÊúÄÈ´òÂπ¥Âèé', format: v => v ? (v / 10000) + '‰∏á' : '-' }
                ];
            }

            fields.forEach(f => {
                const valA = currentMergeData.recordA[f.key];
                const valB = currentMergeData.recordB[f.key];
                const displayA = f.format ? f.format(valA) : (valA || '-');
                const displayB = f.format ? f.format(valB) : (valB || '-');

                const row = `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium text-gray-500 bg-gray-50/50">${f.label}</td>
                        <td class="px-4 py-3">
                            <label class="flex items-start gap-3 cursor-pointer group">
                                <input type="radio" name="merge_${f.key}" value="A" checked class="mt-1">
                                <span class="text-sm text-gray-800 group-hover:text-indigo-600 transition">${displayA}</span>
                            </label>
                        </td>
                        <td class="px-4 py-3">
                            <label class="flex items-start gap-3 cursor-pointer group">
                                <input type="radio" name="merge_${f.key}" value="B" class="mt-1">
                                <span class="text-sm text-gray-800 group-hover:text-indigo-600 transition">${displayB}</span>
                            </label>
                        </td>
                    </tr>
                `;
                container.append(row);
            });

            $('#data-merge-modal').removeClass('hidden');
        };

        window.selectAllMerge = function (side) {
            $(`#merge-fields-container input[value="${side}"]`).prop('checked', true);
        };

        window.closeDataMergeModal = function () {
            $('#data-merge-modal').addClass('hidden').attr('style', '');
        };

        window.executeMerge = async function () {
            if (!confirm('Áµ±Âêà„ÇíÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ')) return;

            showLoading('Áµ±ÂêàÂá¶ÁêÜ„ÇíÂÆüË°å‰∏≠...');
            try {
                const { type, recordA, recordB } = currentMergeData;
                const updates = {};

                // ÈÅ∏Êäû„Åï„Çå„ÅüÂÄ§„ÅÆÂèéÈõÜ
                $(`#merge-fields-container tr`).each(function () {
                    const row = $(this);
                    const radio = row.find('input[type="radio"]:checked');
                    if (radio.length) {
                        const fieldName = radio.attr('name').replace('merge_', '');
                        const side = radio.val();
                        updates[fieldName] = side === 'A' ? recordA[fieldName] : recordB[fieldName];
                    }
                });

                const targetTable = type === 'company' ? 'companies' : 'jobs';

                // 1. „É¨„Ç≥„Éº„ÉâA„ÇíÊõ¥Êñ∞
                const { error: updateError } = await supabase
                    .from(targetTable)
                    .update(updates)
                    .eq('id', recordA.id);

                if (updateError) throw updateError;

                // 2. Èñ¢ÈÄ£„Éá„Éº„Çø„ÅÆÁ¥ê„Å•„ÅëÊõø„Åà
                if (type === 'company') {
                    // Ê±Ç‰∫∫„ÅÆÁ¥ê„Å•„ÅëÊõø„Åà
                    await supabase.from('jobs').update({ company_id: recordA.id }).eq('company_id', recordB.id);
                } else {
                    // ÂøúÂãü„ÄÅÊé®Ëñ¶„ÄÅ„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅÆÁ¥ê„Å•„ÅëÊõø„Åà
                    await supabase.from('applications').update({ job_id: recordA.id }).eq('job_id', recordB.id);
                    await supabase.from('recommendations').update({ job_id: recordA.id }).eq('job_id', recordB.id);
                    await supabase.from('favorites').update({ job_id: recordA.id }).eq('job_id', recordB.id);
                }

                // 3. „É¨„Ç≥„Éº„ÉâB„ÇíÂâäÈô§ (Ë´ñÁêÜÂâäÈô§ÂèØËÉΩ„Å™Â†¥Âêà„ÅØË´ñÁêÜÂâäÈô§)
                if (type === 'job') {
                    await supabase.from('jobs').update({ deleted_at: new Date().toISOString() }).eq('id', recordB.id);
                } else {
                    await supabase.from('companies').delete().eq('id', recordB.id);
                }

                alert('Áµ±Âêà„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü');
                closeDataMergeModal();
                detectDuplicates(); // ÂÜçÊ§úÁ¥¢„Åó„Å¶Êõ¥Êñ∞

            } catch (err) {
                console.error('Merge execution error:', err);
                alert('Áµ±ÂêàÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + err.message);
            } finally {
                hideLoading();
            }
        };
        window.switchDataManagementTab = function (type) {
            $('.data-mgmt-tab').removeClass('border-indigo-500 text-indigo-600').addClass('border-transparent text-gray-500');
            $(`#data-mgmt-tab-${type}`).addClass('border-indigo-500 text-indigo-600').removeClass('border-transparent text-gray-500');

            if (type === 'companies') {
                $('#data-mgmt-criteria-companies').removeClass('hidden');
                $('#data-mgmt-criteria-jobs').addClass('hidden');
                $('#data-mgmt-tab-companies').attr('data-type', 'company'); // Used by detectDuplicates
            } else {
                $('#data-mgmt-criteria-companies').addClass('hidden');
                $('#data-mgmt-criteria-jobs').removeClass('hidden');
                $('#data-mgmt-tab-jobs').attr('data-type', 'job'); // Used by detectDuplicates
            }
            // Clear results when switching
            $('#data-mgmt-results').html(`
                <div class="text-center py-12 text-gray-500 border-2 border-dashed border-gray-200 rounded-lg">
                    <i class="fas fa-broom text-4xl mb-4"></i>
                    <p>Ë®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„ÄÅ„ÄåÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÈñãÂßã„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                </div>
            `);
        };

        // Initialize default tab metadata
        $(document).ready(() => {
            $('#data-mgmt-tab-companies').attr('data-type', 'company');
            $('#data-mgmt-tab-jobs').attr('data-type', 'job');
        });
        // ========================================
        // „É®„ÉüÁÆ°ÁêÜ„ÉªÈÄ≤Êçó„É¢„Éã„Çø„É™„É≥„Ç∞Ê©üËÉΩ
        // ========================================

        let yomiViewMode = 'board';
        let yomiData = [];

        window.switchYomiView = function (view) {
            yomiViewMode = view;
            $('.yomi-view-btn').removeClass('bg-white shadow-sm text-indigo-600').addClass('text-gray-600 hover:text-gray-900');
            $(`#yomi-view-${view}-btn`).addClass('bg-white shadow-sm text-indigo-600').removeClass('text-gray-600 hover:text-gray-900');

            $('.yomi-view-content').addClass('hidden');
            $(`#yomi-${view}-view`).removeClass('hidden');

            renderYomiContent();
        };

        window.loadYomiData = async function () {
            showLoading('„É®„Éü„Éá„Éº„Çø„ÇíÊõ¥Êñ∞‰∏≠...');
            try {
                if (!window.supabase) return;

                // 1. „ÉÅ„Éº„É†„Éá„Éº„Çø„ÅÆÂèñÂæó
                const { data: teams, error: teamError } = await window.supabase
                    .from('teams')
                    .select('*')
                    .eq('organization_id', currentUser.organization_id)
                    .order('display_order');

                if (!teamError && teams) {
                    const teamSelect = $('#yomi-filter-team');
                    const currentValue = teamSelect.val();
                    teamSelect.empty().append('<option value="">ÂÖ®„Å¶„ÅÆ„ÉÅ„Éº„É†</option>');
                    teams.forEach(t => {
                        const indent = '&nbsp;'.repeat((t.level - 1) * 4);
                        teamSelect.append(`<option value="${t.id}">${indent}${t.name}</option>`);
                    });
                    teamSelect.val(currentValue);
                }

                // 2. „Ç≥„Éº„ÉÅÔºàÊãÖÂΩìËÄÖÔºâ„Éá„Éº„Çø„ÅÆÂèñÂæó
                const { data: coaches, error: coachError } = await window.supabase
                    .from('users')
                    .select('id, name')
                    .eq('organization_id', currentUser.organization_id)
                    .in('role', ['coach', 'admin', 'org_admin']);

                if (!coachError && coaches) {
                    const coachSelect = $('#yomi-filter-coach');
                    const currentCoach = coachSelect.val();
                    coachSelect.empty().append('<option value="">ÂÖ®Âì°</option>');
                    coaches.forEach(c => {
                        coachSelect.append(`<option value="${c.id}">${c.name}</option>`);
                    });
                    coachSelect.val(currentCoach);
                }

                // „Éï„Ç£„É´„ÇøÂÄ§„ÅÆÂèñÂæó
                const teamId = $('#yomi-filter-team').val();
                const coachId = $('#yomi-filter-coach').val();
                const period = $('#yomi-filter-period').val();
                const probRate = $('#yomi-filter-probability').val();

                // 3. ÂøúÂãü„Éá„Éº„Çø„ÅÆÂèñÂæó („É®„ÉüÊÉÖÂ†±Âê´„ÇÄ)
                let usersSelector = 'users!applications_user_id_fkey(id, name, team_id, coach_id)';
                if (teamId || coachId) {
                    usersSelector = 'users!applications_user_id_fkey!inner(id, name, team_id, coach_id)';
                }

                let query = window.supabase
                    .from('applications')
                    .select(`
                        *,
                        ${usersSelector},
                        jobs(id, title, company, company_id)
                    `)
                    .eq('organization_id', currentUser.organization_id)
                    // Èùû„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÔºàÈÅ∏ËÄÉÁµÇ‰∫Ü„ÉªËæûÈÄÄ„Å™„Å©Ôºâ„ÇíÈô§Â§ñ
                    .not('status', 'ilike', 'ÈÅ∏ËÄÉÁµÇ‰∫Ü%')
                    .not('status', 'in', '("ËæûÈÄÄ","‰∏çÂêàÊ†º","ÂÖ•Á§æÁ¢∫Ë™çÊ∏à","NG")');

                // „Éï„Ç£„É´„ÇøÈÅ©Áî®
                if (teamId) {
                    query = query.eq('users.team_id', teamId);
                }

                if (coachId) {
                    query = query.eq('users.coach_id', coachId);
                }

                if (probRate) {
                    query = query.gte('probability_rate', parseInt(probRate));
                }

                if (period && period !== 'all') {
                    const today = new Date();
                    let start, end;
                    const formatDate = (date) => {
                        const y = date.getFullYear();
                        const m = String(date.getMonth() + 1).padStart(2, '0');
                        const d = String(date.getDate()).padStart(2, '0');
                        return `${y}-${m}-${d}`;
                    };

                    if (period === 'this_month') {
                        start = new Date(today.getFullYear(), today.getMonth(), 1);
                        end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    } else if (period === 'next_month') {
                        start = new Date(today.getFullYear(), today.getMonth() + 1, 1);
                        end = new Date(today.getFullYear(), today.getMonth() + 2, 0);
                    } else if (period === 'this_quarter') {
                        const q = Math.floor(today.getMonth() / 3);
                        start = new Date(today.getFullYear(), q * 3, 1);
                        end = new Date(today.getFullYear(), (q + 1) * 3, 0);
                    }

                    if (start && end) {
                        query = query.gte('expected_start_date', formatDate(start));
                        query = query.lte('expected_start_date', formatDate(end));
                    }
                }

                const { data, error } = await query;
                if (error) {
                    console.error('[Yomi] Fetch Error:', error);
                    throw error;
                }

                console.log('[Yomi] Data Received Count:', data?.length || 0);
                if (data && data.length > 0) console.log('[Yomi] Example Row:', data[0]);

                console.log('[Yomi] Result Data Count:', data?.length || 0);
                yomiData = data || [];
                updateYomiStats();
                renderYomiContent();

            } catch (err) {
                console.error('Failed to load yomi data:', err);
                alert('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            } finally {
                hideLoading();
            }
        };

        function updateYomiStats() {
            console.log('[Yomi] Updating Stats for:', yomiData.length, 'items');
            let totalRevenue = 0;
            let weightedRevenue = 0;
            let activeCount = yomiData.length;
            let totalProb = 0;

            yomiData.forEach(item => {
                const rev = item.expected_revenue || 0;
                const prob = item.probability_rate || 0;
                totalRevenue += rev;
                weightedRevenue += (rev * prob / 100);
                totalProb += prob;
            });

            $('#yomi-stat-total-revenue').text(new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(totalRevenue));
            $('#yomi-stat-weighted-revenue').text(new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(weightedRevenue));
            $('#yomi-stat-active-count').text(activeCount + '‰ª∂');
            $('#yomi-stat-avg-probability').text((activeCount > 0 ? Math.round(totalProb / activeCount) : 0) + '%');
        }

        function renderYomiContent() {
            if (yomiViewMode === 'board') renderYomiBoard();
            else if (yomiViewMode === 'list') renderYomiList();
            else if (yomiViewMode === 'forecast') renderYomiForecast();
        }

        async function renderYomiBoard() {
            console.log('[Yomi] Rendering Board...');
            const container = $('#yomi-kanban-container').empty();

            // „Çπ„ÉÜ„Éº„Çø„Çπ„ÉÜ„Éº„Éñ„É´„Åã„Çâ„Ç´„É©„É†„ÇíÁîüÊàê
            console.log('[Yomi] Fetching Master Data for statuses...');
            const { data: statuses } = await window.supabase
                .from('master_data')
                .select('*')
                .eq('type', 'application_status')
                .order('sort_order');

            if (!statuses) return;

            // ÂêÑ„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆ„Ç´„É©„É†„Çí‰ΩúÊàê
            console.log('[Yomi] Master Statuses:', statuses.map(s => s.value));
            if (yomiData.length > 0) {
                console.log('[Yomi] Sample Data Status:', yomiData[0].status);
            }

            statuses.forEach(status => {
                const columnData = yomiData.filter(d => {
                    const match = String(d.status).trim() === String(status.value).trim();
                    return match;
                });
                const colHtml = `
                    <div class="flex-shrink-0 w-80 bg-gray-50 rounded-xl flex flex-col max-h-[70vh]">
                        <div class="p-4 flex justify-between items-center border-b">
                            <h3 class="font-bold text-gray-700">${status.value} <span class="ml-2 text-xs text-gray-400 font-normal">${columnData.length}</span></h3>
                        </div>
                        <div class="flex-1 overflow-y-auto p-3 space-y-3 custom-scrollbar" ondragover="event.preventDefault()" ondrop="handleYomiDrop(event, '${status.value}')">
                            ${columnData.map(item => `
                                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 cursor-move hover:shadow-md transition-shadow" 
                                     draggable="true" ondragstart="handleYomiDragStart(event, '${item.id}')">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded">${item.probability_rate || 0}%</span>
                                        <span class="text-[10px] text-gray-400 font-mono">¬•${(item.expected_revenue || 0).toLocaleString()}</span>
                                    </div>
                                    <h4 class="font-bold text-gray-900 text-sm mb-1">${item.users?.name || '‰∏çÊòé'}</h4>
                                    <p class="text-[10px] text-gray-500 truncate mb-2">${item.jobs?.company || ''} / ${item.jobs?.title || ''}</p>
                                    <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-50">
                                        <span class="text-[10px] text-gray-400"><i class="far fa-calendar-alt mr-1"></i>${item.expected_start_date || '-'}</span>
                                        <button onclick="openProgressModal('${item.id}')" class="text-xs text-indigo-500 hover:text-indigo-700">Ë©≥Á¥∞</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.append(colHtml);
            });
        }

        function renderYomiList() {
            const container = $('#yomi-list-container').empty();
            yomiData.forEach(item => {
                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="font-bold text-gray-900">${item.users?.name || '‰∏çÊòé'}</div>
                            <div class="text-[10px] text-gray-400">ÊãÖÂΩìID: ${item.users?.coach_id || '-'}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">${item.jobs?.title || ''}</div>
                            <div class="text-xs text-gray-500">${item.jobs?.company || ''}</div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-[10px] font-bold rounded-full bg-blue-100 text-blue-700">${item.status}</span>
                        </td>
                        <td class="px-6 py-4">
                            <input type="number" value="${item.expected_revenue || 0}" 
                                   onchange="updateYomiField('${item.id}', 'expected_revenue', this.value)"
                                   class="w-24 border-gray-300 rounded text-sm text-right focus:ring-indigo-500">
                        </td>
                        <td class="px-6 py-4">
                            <select onchange="updateYomiField('${item.id}', 'probability_rate', this.value)"
                                    class="w-20 border-gray-300 rounded text-sm focus:ring-indigo-500">
                                ${[0, 20, 40, 60, 80, 100].map(v => `<option value="${v}" ${item.probability_rate == v ? 'selected' : ''}>${v}%</option>`).join('')}
                            </select>
                        </td>
                        <td class="px-6 py-4">
                            <input type="date" value="${item.expected_start_date || ''}" 
                                   onchange="updateYomiField('${item.id}', 'expected_start_date', this.value)"
                                   class="w-32 border-gray-300 rounded text-xs focus:ring-indigo-500">
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="openProgressModal('${item.id}')" class="text-indigo-600 hover:text-indigo-900 font-bold text-xs">Á∑®ÈõÜ</button>
                        </td>
                    </tr>
                `;
                container.append(row);
            });
        }

        let yomiForecastChart = null;
        let yomiDistributionChart = null;

        function renderYomiForecast() {
            const ctx1 = document.getElementById('yomi-forecast-chart').getContext('2d');
            const ctx2 = document.getElementById('yomi-distribution-chart').getContext('2d');

            if (yomiForecastChart) yomiForecastChart.destroy();
            if (yomiDistributionChart) yomiDistributionChart.destroy();

            // ÊúàÂà•ÈõÜË®à
            const monthlyData = {};
            yomiData.forEach(d => {
                if (d.expected_start_date) {
                    const month = d.expected_start_date.substring(0, 7);
                    monthlyData[month] = (monthlyData[month] || 0) + (d.expected_revenue * (d.probability_rate || 0) / 100);
                }
            });

            const sortedMonths = Object.keys(monthlyData).sort();

            yomiForecastChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: '‰∫àÊ∏¨Âà©Áõä („É®„ÉüÊèõÁÆó)',
                        data: sortedMonths.map(m => monthlyData[m]),
                        backgroundColor: 'rgba(79, 70, 229, 0.6)',
                        borderColor: 'rgb(79, 70, 229)',
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // „É®„ÉüÂà•ÂÜÖË®≥
            const dist = { '80%+': 0, '60%+': 0, '40%+': 0, '20%+': 0, '0%+': 0 };
            yomiData.forEach(d => {
                const p = d.probability_rate || 0;
                if (p >= 80) dist['80%+']++;
                else if (p >= 60) dist['60%+']++;
                else if (p >= 40) dist['40%+']++;
                else if (p >= 20) dist['20%+']++;
                else dist['0%+']++;
            });

            yomiDistributionChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(dist),
                    datasets: [{
                        data: Object.values(dist),
                        backgroundColor: ['#4f46e5', '#818cf8', '#c7d2fe', '#e0e7ff', '#f3f4f6']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        window.updateYomiField = async function (id, field, value) {
            try {
                const { error } = await window.supabase
                    .from('applications')
                    .update({ [field]: value })
                    .eq('id', id);

                if (error) throw error;

                // „Ç≠„É£„ÉÉ„Ç∑„É•Êõ¥Êñ∞
                const idx = yomiData.findIndex(d => d.id === id);
                if (idx !== -1) yomiData[idx][field] = value;

                updateYomiStats();
                renderYomiContent();
            } catch (err) {
                console.error('Update failed:', err);
            }
        };

        // „Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„ÉóÁî®
        let draggedApplicationId = null;
        window.handleYomiDragStart = function (e, id) {
            draggedApplicationId = id;
            e.dataTransfer.setData('text/plain', id);
        };

        window.handleYomiDrop = async function (e, newStatus) {
            e.preventDefault();
            const id = e.dataTransfer.getData('text/plain');
            if (!id) return;

            showLoading('„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞‰∏≠...');
            try {
                // Êõ¥Êñ∞Ââç„Å´ÁèæÂú®„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂèñÂæóÔºàÂ±•Ê≠¥Áî®Ôºâ
                const { data: currentApp } = await window.supabase
                    .from('applications')
                    .select('status, user_id')
                    .eq('id', id)
                    .single();

                const { error } = await window.supabase
                    .from('applications')
                    .update({
                        status: newStatus,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', id);

                if (error) throw error;

                // Â±•Ê≠¥„ÄÅÈÄöÁü•„ÄÅ„É°„Éº„É´ÈÄÅ‰ø°
                try {
                    const { data: appData } = await window.supabase
                        .from('applications')
                        .select('*, jobs(title, company), users!user_id(name, email, coach_id)')
                        .eq('id', id)
                        .single();

                    if (appData) {
                        const statusLabel = getSelectionStatusLabel(newStatus);

                        // 1. Â±•Ê≠¥Ë®òÈå≤
                        await window.supabase.from('progress_history').insert({
                            organization_id: appData.organization_id || currentUser.organization_id,
                            application_id: id,
                            user_id: appData.user_id,
                            old_status: currentApp?.status,
                            new_status: newStatus,
                            changed_by: currentUser.id,
                            changed_by_name: currentUser.name
                        });

                        // 2. Ê±ÇËÅ∑ËÄÖ„Å∏ÈÄöÁü•„É¨„Ç≥„Éº„Éâ
                        await window.supabase.from('notifications').insert({
                            user_id: appData.user_id,
                            title: 'ÈÅ∏ËÄÉ„Çπ„ÉÜ„Éº„Çø„Çπ„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü',
                            message: `„Äå${appData.jobs.company} / ${appData.jobs.title}„Äç„ÅÆÈÅ∏ËÄÉÁä∂Ê≥Å„Åå„Äå${statusLabel}„Äç„Å´Êõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü„ÄÇ`,
                            read: false,
                            metadata: { page: 'applications', application_id: id },
                            created_at: new Date().toISOString()
                        });

                        // 3. Ê±ÇËÅ∑ËÄÖ„Å∏„É°„Éº„É´
                        if (appData.users && appData.users.email) {
                            await sendEmail('status_changed', appData.users.email, {
                                userName: appData.users.name,
                                jobTitle: appData.jobs.title,
                                companyName: appData.jobs.company,
                                newStatus: statusLabel,
                                status: newStatus
                            });
                        }

                        // 4. ÊãÖÂΩì„Ç≥„Éº„ÉÅ„Å∏„É°„Éº„É´
                        if (appData.users.coach_id) {
                            const { data: coachData } = await window.supabase
                                .from('users')
                                .select('name, email')
                                .eq('id', appData.users.coach_id)
                                .single();

                            if (coachData && coachData.email) {
                                await sendEmail('ca_notification', coachData.email, {
                                    userName: coachData.name,
                                    candidateName: appData.users.name,
                                    jobTitle: appData.jobs.title,
                                    companyName: appData.jobs.company,
                                    body: `ÊãÖÂΩìÊ±ÇËÅ∑ËÄÖ„ÅÆ ${appData.users.name} Êßò„ÅÆÈÅ∏ËÄÉ„Çπ„ÉÜ„Éº„Çø„Çπ„Åå„Äå${statusLabel}„Äç„Å´Êõ¥Êñ∞ÔºàÁßªÂãïÔºâ„Åï„Çå„Åæ„Åó„Åü„ÄÇ`
                                });
                            }
                        }
                    }
                } catch (notifyErr) {
                    console.error('Yomi update notification failed:', notifyErr);
                }

                // ÂÜçË™≠„ÅøËæº„Åø
                await loadYomiData();
            } catch (err) {
                alert('Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            } finally {
                hideLoading();
            }
        };

        // „Éö„Éº„Ç∏Âàá„ÇäÊõø„ÅàÊôÇ„Å´„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
        $(document).on('page-switched', function (e, pageId) {
            if (pageId === 'admin-yomi-management') {
                loadYomiData();
            }
        });

        $(document).ready(() => {
            // Initial call if starting on yomi management
            if ($('#admin-yomi-management-content').hasClass('active')) {
                loadYomiData();
            }
        });

    </script>
    <!-- Job Detail Modal -->
    <div id="job-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
        style="z-index: 30000;">
        <div class="bg-white rounded-lg w-full max-w-6xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-900" id="job-detail-title">Ê±Ç‰∫∫Ë©≥Á¥∞</h3>
                <button onclick="closeJobDetailModal()"
                    class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <!-- „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="flex space-x-8">
                    <button onclick="switchJobDetailTab('details')" id="job-tab-details"
                        class="job-detail-tab py-4 px-1 border-b-2 border-indigo-600 font-medium text-sm text-indigo-600">
                        Ê±Ç‰∫∫ÊÉÖÂ†±
                    </button>
                    <button onclick="switchJobDetailTab('candidates')" id="job-tab-candidates"
                        class="job-detail-tab py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        „Éû„ÉÉ„ÉÅ„É≥„Ç∞ÂÄôË£úËÄÖ
                        <span id="job-candidates-count"
                            class="ml-2 bg-gray-100 text-gray-600 py-1 px-2 rounded-full text-xs"></span>
                    </button>
                </nav>
            </div>

            <!-- Ê±Ç‰∫∫Ë©≥Á¥∞„Çø„Éñ -->
            <div id="job-detail-tab-content" class="space-y-6">
                <!-- Job details will be loaded here -->
            </div>

            <!-- ÂÄôË£úËÄÖ„Éû„ÉÉ„ÉÅ„É≥„Ç∞„Çø„Éñ -->
            <div id="job-candidates-tab-content" class="hidden">
                <div class="mb-4 flex justify-between items-center">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900">AI„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÂÄôË£úËÄÖ</h4>
                        <p class="text-sm text-gray-600">„Åì„ÅÆÊ±Ç‰∫∫„Å´ÊúÄÈÅ©„Å™ÂÄôË£úËÄÖ„ÇíË°®Á§∫„Åó„Å¶„ÅÑ„Åæ„Åô</p>
                    </div>
                    <button onclick="runJobMatching()" id="run-matching-btn"
                        class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center gap-2">
                        <i class="fas fa-magic"></i>
                        <span>AI „Éû„ÉÉ„ÉÅ„É≥„Ç∞ÂÆüË°å</span>
                    </button>
                </div>

                <!-- „Éû„ÉÉ„ÉÅ„É≥„Ç∞ÂÄôË£úËÄÖ„É™„Çπ„Éà -->
                <div id="job-candidates-list" class="space-y-4">
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-users text-4xl mb-3"></i>
                        <p>„ÄåAI „Éû„ÉÉ„ÉÅ„É≥„Ç∞ÂÆüË°å„Äç„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÂÄôË£úËÄÖ„ÇíÊ§úÁ¥¢„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- „Çπ„Ç´„Ç¶„Éà‰ΩúÊàê„É¢„Éº„ÉÄ„É´ -->
    <div id="scout-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center hidden"
        style="z-index: 99999 !important; position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; background-color: rgba(0, 0, 0, 0.8) !important;">
        <div class="bg-white rounded-lg w-full max-w-2xl p-6" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-paper-plane text-indigo-600 mr-2"></i>„Çπ„Ç´„Ç¶„Éà„É°„ÉÉ„Çª„Éº„Ç∏‰ΩúÊàê
                </h3>
                <button onclick="closeScoutModal()"
                    class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="space-y-4">
                <!-- ÂÆõÂÖà -->
                <div class="bg-gray-50 p-3 rounded border">
                    <span class="text-gray-600 text-sm">ÂÆõÂÖà:</span>
                    <span id="scout-candidate-name" class="font-bold text-gray-900 ml-2"></span>
                </div>

                <!-- ‰ª∂Âêç -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‰ª∂Âêç</label>
                    <input type="text" id="scout-subject"
                        class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- Êú¨Êñá -->
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="block text-sm font-medium text-gray-700">Êú¨Êñá</label>
                        <button onclick="regenerateScoutMessage()"
                            class="text-xs text-indigo-600 hover:text-indigo-800 flex items-center">
                            <i class="fas fa-sync-alt mr-1"></i>AI„ÅßÂÜçÁîüÊàê
                        </button>
                    </div>
                    <textarea id="scout-body" rows="10"
                        class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>

                <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥ -->
                <div class="flex justify-end gap-3 pt-4 border-t">
                    <button onclick="closeScoutModal()"
                        class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded">„Ç≠„É£„É≥„Çª„É´</button>
                    <button onclick="sendScoutMessage()"
                        class="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 flex items-center">
                        <i class="fas fa-paper-plane mr-2"></i>ÈÄÅ‰ø°„Åô„Çã
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dynamic modal is injected here via JS -->
    <!-- ËÅ∑ÂãôÁµåÊ≠¥Êõ∏„Éó„É¨„Éì„É•„Éº„É¢„Éº„ÉÄ„É´ -->
    <div id="resume-preview-modal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center"
        style="z-index: 10003; width: 100vw; height: 100vh; top: 0; left: 0; display: none;">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-5xl max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b bg-gradient-to-r from-blue-600 to-indigo-600">
                <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                    <i class="fas fa-file-alt"></i>
                    ËÅ∑ÂãôÁµåÊ≠¥Êõ∏„Éó„É¨„Éì„É•„Éº
                </h2>
                <button onclick="closeResumePreviewModal()" class="text-white hover:text-gray-200">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 180px);">
                <!-- ÁîüÊàê‰∏≠Ë°®Á§∫ -->
                <div id="resume-generating" class="text-center py-16">
                    <i class="fas fa-spinner fa-spin text-6xl text-indigo-600 mb-6"></i>
                    <p class="text-xl text-gray-700 font-medium">AI„ÅåËÅ∑ÂãôÁµåÊ≠¥Êõ∏„ÇíÁîüÊàê‰∏≠...</p>
                    <p class="text-sm text-gray-500 mt-2">Ê±Ç‰∫∫ÊÉÖÂ†±„Å®„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÂàÜÊûê„Å´Âü∫„Å•„ÅÑ„Å¶ÊúÄÈÅ©„Å™ÂÜÖÂÆπ„Çí‰ΩúÊàê„Åó„Å¶„ÅÑ„Åæ„Åô</p>
                </div>

                <!-- „Éó„É¨„Éì„É•„ÉºË°®Á§∫ -->
                <div id="resume-preview-content" class="hidden space-y-4">
                    <div class="bg-blue-50 border-l-4 border-blue-600 p-4 mb-6">
                        <p class="text-sm text-blue-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            ÁîüÊàê„Åï„Çå„ÅüÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç„ÉªÁ∑®ÈõÜ„Åó„Å¶„Åã„Çâ„ÄåWordÂá∫Âäõ„Äç„Éú„Çø„É≥„Åß„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åß„Åç„Åæ„Åô
                        </p>
                    </div>

                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                                <i class="fas fa-user-circle text-indigo-600"></i>
                                ËÅ∑ÂãôË¶ÅÁ¥Ñ
                            </label>
                            <textarea id="resume-summary" rows="4"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                placeholder="ËÅ∑ÂãôË¶ÅÁ¥Ñ„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                                <i class="fas fa-briefcase text-indigo-600"></i>
                                ËÅ∑ÂãôÁµåÊ≠¥
                            </label>
                            <textarea id="resume-work-history" rows="10"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-mono text-sm"
                                placeholder="ËÅ∑ÂãôÁµåÊ≠¥„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô"></textarea>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                                    <i class="fas fa-star text-indigo-600"></i>
                                    Âº∑„Åø„ÉªÊ¥ª„Åã„Åõ„ÇãÁµåÈ®ì
                                </label>
                                <textarea id="resume-strengths" rows="6"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    placeholder="Âº∑„Åø„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô"></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                                    <i class="fas fa-laptop-code text-indigo-600"></i>
                                    PC„Çπ„Ç≠„É´„ÉªË≥áÊ†º
                                </label>
                                <textarea id="resume-skills" rows="6"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    placeholder="„Çπ„Ç≠„É´„ÉªË≥áÊ†º„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô"></textarea>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                                <i class="fas fa-comment-dots text-indigo-600"></i>
                                Ëá™Â∑±PR
                            </label>
                            <textarea id="resume-self-pr" rows="5"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                placeholder="Ëá™Â∑±PR„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                                <i class="fas fa-heart text-indigo-600"></i>
                                ÂøóÊúõÂãïÊ©ü
                            </label>
                            <textarea id="resume-motivation" rows="5"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                placeholder="ÂøóÊúõÂãïÊ©ü„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô"></textarea>
                        </div>
                    </div>
                </div>

                <!-- „Ç®„É©„ÉºË°®Á§∫ -->
                <div id="resume-error" class="hidden text-center py-16">
                    <i class="fas fa-exclamation-triangle text-6xl text-red-600 mb-6"></i>
                    <p class="text-xl text-red-600 font-medium" id="resume-error-message"></p>
                    <button onclick="regenerateResume()"
                        class="mt-6 px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        <i class="fas fa-redo mr-2"></i>ÂÜçË©¶Ë°å
                    </button>
                </div>
            </div>

            <div class="flex justify-end gap-3 p-6 border-t bg-gray-50">
                <button onclick="closeResumePreviewModal()"
                    class="px-6 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-100 font-medium">
                    „Ç≠„É£„É≥„Çª„É´
                </button>
                <button onclick="regenerateResume()"
                    class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 font-medium">
                    <i class="fas fa-sync"></i>
                    ÂÜçÁîüÊàê
                </button>
                <button onclick="downloadResumeWord()"
                    class="px-6 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center gap-2 font-medium">
                    <i class="fas fa-file-word"></i>
                    WordÂá∫Âäõ
                </button>
            </div>
        </div>
    </div>

    <!-- Êé®Ëñ¶Áä∂„Éó„É¨„Éì„É•„Éº„É¢„Éº„ÉÄ„É´ -->
    <div id="recommendation-doc-preview-modal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center"
        style="z-index: 10003; width: 100vw; height: 100vh; top: 0; left: 0; display: none;">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-4xl max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b bg-gradient-to-r from-purple-600 to-pink-600">
                <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                    <i class="fas fa-file-signature"></i>
                    Êé®Ëñ¶Áä∂„Éó„É¨„Éì„É•„Éº
                </h2>
                <button onclick="closeRecommendationDocPreviewModal()" class="text-white hover:text-gray-200">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 180px);">
                <!-- ÁîüÊàê‰∏≠Ë°®Á§∫ -->
                <div id="recommendation-doc-generating" class="text-center py-16">
                    <i class="fas fa-spinner fa-spin text-6xl text-purple-600 mb-6"></i>
                    <p class="text-xl text-gray-700 font-medium">AI„ÅåÊé®Ëñ¶Áä∂„ÇíÁîüÊàê‰∏≠...</p>
                    <p class="text-sm text-gray-500 mt-2">‰ºÅÊ•≠Âêë„Åë„ÅÆÊ≠£Âºè„Å™Êé®Ëñ¶Áä∂„Çí‰ΩúÊàê„Åó„Å¶„ÅÑ„Åæ„Åô</p>
                </div>

                <!-- „Éó„É¨„Éì„É•„ÉºË°®Á§∫ -->
                <div id="recommendation-doc-preview-content" class="hidden">
                    <div class="bg-purple-50 border-l-4 border-purple-600 p-4 mb-6">
                        <p class="text-sm text-purple-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            ÁîüÊàê„Åï„Çå„ÅüÊé®Ëñ¶Áä∂„ÇíÁ¢∫Ë™ç„ÉªÁ∑®ÈõÜ„Åó„Å¶„Åã„Çâ„ÄåWordÂá∫Âäõ„Äç„Éú„Çø„É≥„Åß„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åß„Åç„Åæ„Åô
                        </p>
                    </div>

                    <div class="bg-white border-2 border-gray-200 rounded-lg p-6">
                        <textarea id="recommendation-doc-full-text" rows="25"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent font-serif text-sm leading-relaxed"
                            placeholder="Êé®Ëñ¶Áä∂„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô"></textarea>
                    </div>
                </div>

                <!-- „Ç®„É©„ÉºË°®Á§∫ -->
                <div id="recommendation-doc-error" class="hidden text-center py-16">
                    <i class="fas fa-exclamation-triangle text-6xl text-red-600 mb-6"></i>
                    <p class="text-xl text-red-600 font-medium" id="recommendation-doc-error-message"></p>
                    <button onclick="regenerateRecommendationDoc()"
                        class="mt-6 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        <i class="fas fa-redo mr-2"></i>ÂÜçË©¶Ë°å
                    </button>
                </div>
            </div>

            <div class="flex justify-end gap-3 p-6 border-t bg-gray-50">
                <button onclick="closeRecommendationDocPreviewModal()"
                    class="px-6 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-100 font-medium">
                    „Ç≠„É£„É≥„Çª„É´
                </button>
                <button onclick="regenerateRecommendationDoc()"
                    class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 font-medium">
                    <i class="fas fa-sync"></i>
                    ÂÜçÁîüÊàê
                </button>
                <button onclick="downloadRecommendationDocWord()"
                    class="px-6 py-2.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center gap-2 font-medium">
                    <i class="fas fa-file-word"></i>
                    WordÂá∫Âäõ
                </button>
            </div>
        </div>
    </div>

    <!-- FAQ Edit/Add Modal -->
    <div id="faq-form-modal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center hidden"
        style="z-index: 100000;">
        <div
            class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl mx-4 overflow-hidden flex flex-col animate-fade-in-up">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h3 id="faq-modal-title" class="text-xl font-bold text-slate-800">Êñ∞Ë¶èFAQ‰ΩúÊàê</h3>
                <button onclick="closeFAQForm()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div class="p-8 overflow-y-auto max-h-[80vh]">
                <form id="faq-edit-form" class="space-y-6">
                    <input type="hidden" id="faq-id">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label
                                class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">„Ç´„ÉÜ„Ç¥„É™</label>
                            <select id="faq-category"
                                class="w-full px-4 py-3 bg-slate-50 border-none rounded-xl focus:ring-4 focus:ring-indigo-100 outline-none transition-all font-bold text-slate-700"
                                required>
                                <option value="start">Â∞éÂÖ•„ÉªÂü∫Êú¨Ë®≠ÂÆö</option>
                                <option value="ai">AI„Éû„ÉÉ„ÉÅ„É≥„Ç∞</option>
                                <option value="manage">Ê±Ç‰∫∫„ÉªÈÄ≤ÊçóÁÆ°ÁêÜ</option>
                                <option value="trouble">„Éà„É©„Éñ„É´Ëß£Ê±∫</option>
                            </select>
                        </div>
                        <div>
                            <label
                                class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Ë°®Á§∫È†Ü</label>
                            <input type="number" id="faq-display-order"
                                class="w-full px-4 py-3 bg-slate-50 border-none rounded-xl focus:ring-4 focus:ring-indigo-100 outline-none transition-all"
                                value="0">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Ë≥™Âïè
                            (Question)</label>
                        <input type="text" id="faq-question-input"
                            class="w-full px-4 py-3 bg-slate-50 border-none rounded-xl focus:ring-4 focus:ring-indigo-100 outline-none transition-all font-medium"
                            placeholder="„É¶„Éº„Ç∂„Éº„ÅåÂõ∞„Å£„Å¶„ÅÑ„ÇãÂÜÖÂÆπ„ÇíÂÖ•Âäõ..." required>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">ÂõûÁ≠î
                            (Answer)</label>
                        <textarea id="faq-answer-input" rows="6"
                            class="w-full px-4 py-3 bg-slate-50 border-none rounded-xl focus:ring-4 focus:ring-indigo-100 outline-none transition-all text-sm leading-relaxed"
                            placeholder="Ëß£Ê±∫Á≠ñ„ÇÑÊâãÈ†Ü„ÇíÂÖ•ÂäõÔºàÊîπË°å„ÇÇÂèçÊò†„Åï„Çå„Åæ„ÅôÔºâ..." required></textarea>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">ÂèÇÁÖßÁîªÂÉèURL
                            (‰ªªÊÑè)</label>
                        <input type="text" id="faq-image-url"
                            class="w-full px-4 py-3 bg-slate-50 border-none rounded-xl focus:ring-4 focus:ring-indigo-100 outline-none transition-all text-xs"
                            placeholder="https://... „Åæ„Åü„ÅØ ÁîªÈù¢„Ç≠„É£„Éó„ÉÅ„É£Ïùò „Éï„Ç°„Ç§„É´Âêç">
                    </div>

                    <div class="flex items-center gap-2 p-4 bg-slate-50 rounded-2xl">
                        <input type="checkbox" id="faq-is-published" checked class="w-5 h-5 accent-indigo-600">
                        <label for="faq-is-published" class="text-sm font-bold text-slate-600">„Åì„ÅÆÂÜÖÂÆπ„Çí‰ªä„Åô„ÅêÂÖ¨Èñã„Åô„Çã</label>
                    </div>
                </form>
            </div>
            <div class="p-6 bg-slate-50 border-t border-slate-100 flex justify-end gap-3">
                <button onclick="closeFAQForm()"
                    class="px-6 py-2.5 rounded-xl font-bold text-slate-500 hover:bg-slate-100 transition-all">„Ç≠„É£„É≥„Çª„É´</button>
                <button onclick="saveFAQ()"
                    class="bg-indigo-600 text-white px-8 py-2.5 rounded-xl font-bold hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-100">‰øùÂ≠ò„Åô„Çã</button>
            </div>
        </div>
    </div>

    <!-- FAQ Portal Modal -->
    <div id="faq-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
        style="z-index: 100001;">
        <div
            class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden flex flex-col animate-fade-in-up">
            <!-- Modal Header -->
            <div class="bg-indigo-600 p-6 flex justify-between items-center text-white shrink-0">
                <div class="flex items-center gap-3">
                    <div class="bg-white/20 p-2 rounded-lg">
                        <i class="fas fa-question-circle text-2xl"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold">RightJob „Éò„É´„Éó„Çª„É≥„Çø„Éº</h2>
                        <p class="text-xs text-indigo-100 uppercase tracking-widest font-medium">Support Hub</p>
                    </div>
                </div>
                <button onclick="closeFAQModal()" class="text-white/80 hover:text-white transition p-2">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 flex overflow-hidden">
                <!-- FAQ Sidebar -->
                <aside class="w-64 bg-slate-50 border-r border-slate-200 overflow-y-auto hidden md:block">
                    <div class="p-4">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4">
                            Categories
                        </p>
                        <nav class="space-y-1">
                            <button onclick="switchFAQCategory('all')"
                                class="faq-nav-btn active w-full text-left px-4 py-2.5 rounded-lg text-sm font-bold flex items-center gap-3 transition-colors text-slate-600 hover:bg-white hover:shadow-sm">
                                <i class="fas fa-th-large w-4"></i> ÂÖ®„Å¶„ÅÆ„Éò„É´„Éó
                            </button>
                            <button onclick="switchFAQCategory('start')"
                                class="faq-nav-btn w-full text-left px-4 py-2.5 rounded-lg text-sm font-bold flex items-center gap-3 transition-colors text-slate-600 hover:bg-white hover:shadow-sm">
                                <i class="fas fa-rocket w-4"></i> Â∞éÂÖ•„ÉªÂü∫Êú¨Ë®≠ÂÆö
                            </button>
                            <button onclick="switchFAQCategory('ai')"
                                class="faq-nav-btn w-full text-left px-4 py-2.5 rounded-lg text-sm font-bold flex items-center gap-3 transition-colors text-slate-600 hover:bg-white hover:shadow-sm">
                                <i class="fas fa-magic w-4"></i> AI„Éû„ÉÉ„ÉÅ„É≥„Ç∞
                            </button>
                            <button onclick="switchFAQCategory('manage')"
                                class="faq-nav-btn w-full text-left px-4 py-2.5 rounded-lg text-sm font-bold flex items-center gap-3 transition-colors text-slate-600 hover:bg-white hover:shadow-sm">
                                <i class="fas fa-tasks w-4"></i> Ê±Ç‰∫∫„ÉªÈÄ≤ÊçóÁÆ°ÁêÜ
                            </button>
                            <button onclick="switchFAQCategory('trouble')"
                                class="faq-nav-btn w-full text-left px-4 py-2.5 rounded-lg text-sm font-bold flex items-center gap-3 transition-colors text-slate-600 hover:bg-white hover:shadow-sm">
                                <i class="fas fa-exclamation-triangle w-4 text-orange-500"></i> „Éà„É©„Éñ„É´Ëß£Ê±∫
                            </button>
                        </nav>
                    </div>

                    <!-- Quick Contact -->
                    <div class="mt-auto p-4 border-t border-slate-200">
                        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                            <p class="text-xs font-bold text-indigo-900 mb-2">„ÅäÂõ∞„Çä„Åß„Åô„ÅãÔºü</p>
                            <a href="mailto:support@rightjob.com"
                                class="text-[11px] text-indigo-600 hover:underline flex items-center gap-2">
                                <i class="fas fa-envelope"></i> „É°„Éº„É´„Åß„ÅäÂïè„ÅÑÂêà„Çè„Åõ
                            </a>
                        </div>
                    </div>
                </aside>

                <!-- FAQ Content -->
                <main class="flex-1 bg-white overflow-y-auto custom-scrollbar p-6">
                    <!-- Search Box -->
                    <div class="relative mb-8">
                        <input type="text" id="faq-search-input" onkeyup="filterFAQ(this.value)"
                            placeholder="„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶Ê§úÁ¥¢Ôºà‰æãÔºö‰∏ÄÊã¨„ÄÅAI„ÄÅ„Ç®„É©„ÉºÔºâ"
                            class="w-full pl-12 pr-4 py-3 bg-slate-100 border-none rounded-xl focus:ring-4 focus:ring-indigo-100 focus:bg-white transition-all outline-none">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    </div>

                    <div id="faq-content-area" class="space-y-6">
                        <!-- FAQ content will be dynamically loaded from database -->
                        <div class="flex justify-center py-12">
                            <div
                                class="animate-spin rounded-full h-8 w-8 border-4 border-indigo-600 border-t-transparent">
                            </div>
                        </div>
                    </div>
                </main>
            </div>

            <div class="p-6 bg-slate-50 border-t border-slate-200 flex justify-center shrink-0">
                <div class="flex flex-col items-center">
                    <p class="text-sm text-slate-500 mb-3">Ëß£Ê±∫„Åó„Åæ„Åõ„Çì„Åß„Åó„Åü„ÅãÔºü</p>
                    <button onclick="toggleAISearchChat(); closeFAQModal();"
                        class="bg-indigo-600 text-white px-8 py-2.5 rounded-full font-bold shadow-lg hover:bg-indigo-700 transition-all flex items-center gap-2">
                        <i class="fas fa-comment-dots"></i> AI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Å´Áõ∏Ë´á„Åô„Çã
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>

</html>
