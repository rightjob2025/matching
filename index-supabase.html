<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RightJob マッチング - Supabase版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Chart.js for Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap');

        :root {
            --sidebar-width: 250px;
            --header-height: 64px;
            --primary: #4f46e5;
            --primary-dark: #4338ca;
        }

        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f8f9fa;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .spinner {
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Sidebar & Layout */
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0);
            }

            .main-content {
                margin-left: var(--sidebar-width);
            }
        }

        /* Custom Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }

        input[type=range]:focus {
            outline: none;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.2);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #ddd;
            border-radius: 5px;
        }

        /* AI Result Tabs */
        .ai-result-tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 1.5rem;
        }

        .ai-result-tab {
            flex: 1;
            padding: 12px 16px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .ai-result-tab:hover {
            color: #4f46e5;
            background-color: #f8fafc;
        }

        .ai-result-tab.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
            background-color: #f8fafc;
        }

        .ai-result-content {
            display: none;
        }

        .ai-result-content.active {
            display: block;
        }

        /* Diagnosis Page Styles */
        .result-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .strength-ranking-header,
        .job-recommendation-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .strength-ranking-title,
        .job-recommendation-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .strength-ranking-subtitle,
        .job-recommendation-subtitle {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
            margin-top: 8px;
        }

        .result-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 40px;
        }

        .result-card-content {
            padding: 16px;
        }

        .rank-badge {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
            margin-right: 12px;
        }

        .rank-badge.gold {
            background-color: #ffd700;
        }

        .rank-badge.silver {
            background-color: #c0c0c0;
        }

        .rank-badge.bronze {
            background-color: #cd7f32;
        }

        .rank-badge.blue {
            background-color: #4a90e2;
        }

        /* Job recommendation styles */
        .job-container {
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .job-container.job-engineer {
            border-color: #4a90e2;
        }

        .job-container.job-designer {
            border-color: #d0021b;
        }

        .job-container.job-marketer {
            border-color: #f5a623;
        }

        .job-rank-badge {
            text-align: center;
            padding: 4px 0;
            border-radius: 20px;
            color: white;
            font-size: 12px;
            margin: 0 auto 16px;
            max-width: 250px;
        }

        .job-rank-badge.badge-engineer {
            background: #4a90e2;
        }

        .job-rank-badge.badge-designer {
            background: #d0021b;
        }

        .job-rank-badge.badge-marketer {
            background: #f5a623;
        }

        .job-name {
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 24px;
        }

        .job-section {
            margin-top: 24px;
        }

        .job-section-title {
            font-weight: bold;
            margin-bottom: 8px;
            border-left: 4px solid #4a90e2;
            padding-left: 8px;
        }

        .job-skill-tag {
            background: #eef5ff;
            color: #4a90e2;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
        }

        /* Sidebar Styles (Mobile Optimized) */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: #1e1b4b;
            /* Indigo-950 */
            color: #e2e8f0;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 50;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            box-shadow: 10px 0 15px -3px rgba(0, 0, 0, 0.1);
        }

        .sidebar .nav-link {
            color: #94a3b8;
            margin-bottom: 4px;
        }

        .sidebar .nav-link:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .sidebar .nav-link.active {
            background: white !important;
            color: #4f46e5 !important;
            font-weight: 700;
        }

        .main-content {
            margin-left: 0;
            /* Default no margin */
            min-height: 100vh;
            transition: margin-left 0.3s;
        }

        /* Sidebar Overlay */
        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 45;
            display: none;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Desktop Override */
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0) !important;
            }

            .main-content {
                margin-left: var(--sidebar-width) !important;
            }

            .sidebar-overlay {
                display: none !important;
            }
        }

        /* Mobile UI Refinements */
        @media (max-width: 767px) {
            header {
                position: sticky;
                top: 0;
                z-index: 40;
                backdrop-filter: blur(8px);
                background-color: rgba(255, 255, 255, 0.9) !important;
            }
        }

        /* Open State (Mobile) */
        .sidebar.open {
            transform: translateX(0);
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .app-content {
            animation: fadeIn 0.3s ease-out;
        }

        /* Smooth transitions */
        button,
        a,
        .nav-link {
            transition: all 0.2s ease;
        }

        /* Card hover effects */
        .hover\:shadow-md {
            transition: box-shadow 0.3s ease;
        }

        /* AI推薦対象ハイライト */
        .job-card {
            position: relative;
            transition: all 0.3s ease;
        }

        .job-card-highlighted {
            border: 3px solid #6366f1 !important;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1) !important;
            background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%) !important;
        }

        .job-card-highlighted::before {
            content: "AI紹介対象";
            position: absolute;
            top: -12px;
            right: 16px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
            z-index: 10;
        }

        /* AI推薦結果モーダル用タブスタイル */
        .ai-result-tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 1.5rem;
        }

        .ai-result-tab {
            flex: 1;
            padding: 12px 16px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .ai-result-tab:hover {
            color: #4f46e5;
            background-color: #f8fafc;
        }

        .ai-result-tab.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
            background-color: #f8fafc;
        }

        .ai-result-content {
            display: none;
        }

        .ai-result-content.active {
            display: block;
        }

        .ai-result-item {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .ai-result-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .ai-result-item.excluded {
            background-color: #f8fafc;
            border-color: #cbd5e1;
        }

        /* 対象ユーザー選択ドロップダウン */
        .target-user-dropdown {
            position: absolute;
            z-index: 50;
            width: 100%;
            margin-top: 4px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            max-height: 256px;
            overflow-y: auto;
        }

        .target-user-option {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: background-color 0.2s;
        }

        .target-user-option:hover {
            background-color: #eff6ff;
        }

        .target-user-option:last-child {
            border-bottom: none;
        }

        /* --- HIGH VISIBILITY SCROLLBAR --- */
        .custom-scrollbar {
            overflow-y: scroll !important;
            scrollbar-width: thin !important;
            scrollbar-color: #4f46e5 #f1f5f9 !important;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 12px !important;
            display: block !important;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9 !important;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #4f46e5 !important;
            border-radius: 6px !important;
            border: 2px solid #f1f5f9 !important;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #312e81 !important;
        }

        /* Modal Animation */
        .animate-fade-in-up {
            animation: fadeInUp 0.3s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Utility overrides */
        /* Candidate Detail Tabs */
        .candidate-tab-btn.active {
            border-bottom-color: #4f46e5 !important;
            color: #4f46e5 !important;
        }


        /* Print Styles */
        @media print {
            @page {
                margin: 5mm;
                /* 余白をさらに縮小 */
                size: landscape;
            }

            body {
                background-color: white;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                overflow: visible !important;
            }

            /* 全ての要素を一旦非表示に */
            body>* {
                display: none !important;
            }

            /* アプリケーションコンテナのみ表示 */
            body>#app-page {
                display: block !important;
                position: static !important;
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
            }

            /* サイドバーとヘッダーを非表示 */
            .sidebar,
            header,
            .no-print,
            #loading-overlay {
                display: none !important;
            }

            /* メインコンテンツの設定 */
            .main-content {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                position: static !important;
                display: block !important;
            }

            /* 全てのコンテンツページを非表示 */
            .app-content {
                display: none !important;
            }

            /* 現在アクティブな（hiddenクラスがない）コンテンツのみ表示し、絶対配置で上部に固定 */
            .app-content:not(.hidden) {
                display: block !important;
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* カードのスタイル調整 */
            .shadow-sm,
            .shadow-md,
            .shadow-lg,
            .shadow {
                box-shadow: none !important;
                border: 1px solid #ccc !important;
            }

            /* テキストエリアの調整 */
            textarea {
                height: auto !important;
                min-height: 50px;
                resize: none !important;
                border: 1px solid #ddd !important;
                page-break-inside: avoid;
            }

            /* 改ページ制御 */
            .bg-white {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }

        /* --- PREMIUM SEARCH UI --- */
        .search-card {
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            padding: 24px;
            border: 1px solid #f1f5f9;
        }

        .filter-group-label {
            font-size: 0.875rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .admin-badge {
            background: #6366f1;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.625rem;
            font-weight: 700;
            display: inline-block;
            vertical-align: middle;
        }

        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
            min-height: 24px;
        }

        /* Mobile adjustments */
        @media (max-width: 640px) {
            .filter-group-label {
                font-size: 11px;
                margin-bottom: 6px;
                color: #64748b;
            }

            .premium-tag {
                font-size: 10px;
                padding: 2px 8px;
            }

            .search-card {
                padding: 1.25rem !important;
            }

            .count-badge-premium {
                padding: 8px 16px !important;
                gap: 8px !important;
            }

            .count-number-premium {
                font-size: 1.5rem !important;
            }

            .premium-slider-container {
                padding: 4px 0;
            }
        }

        .premium-tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .tag-blue {
            background: #eff6ff !important;
            color: #2563eb !important;
            border: 1px solid #dbeafe !important;
        }

        .tag-blue:hover {
            background: #dbeafe !important;
        }

        .tag-amber {
            background: #fffbeb !important;
            color: #d97706 !important;
            border: 1px solid #fef3c7 !important;
        }

        .tag-indigo {
            background: #f5f3ff !important;
            color: #4f46e5 !important;
            border: 1px solid #ede9fe !important;
        }

        .tag-indigo:hover {
            background: #ede9fe !important;
        }

        .tag-remove {
            margin-left: 6px;
            cursor: pointer;
            opacity: 0.6;
        }

        .tag-remove:hover {
            opacity: 1;
        }

        /* Custom Slider */
        .premium-slider-container {
            padding: 10px 0;
        }

        .premium-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            outline: none;
        }

        .premium-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #6366f1;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .count-badge-premium {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .count-number-premium {
            font-size: 1.75rem;
            font-weight: 800;
            color: #4f46e5;
            font-family: 'Inter', sans-serif;
        }

        .ai-search-btn {
            background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
            transition: all 0.2s;
        }

        .ai-search-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.3);
        }

        .toggle-link {
            color: #6366f1;
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }

        .toggle-link:hover {
            text-decoration: underline;
        }

        /* Select2 Customization */
        .select2-container--default .select2-selection--single,
        .select2-container--default .select2-selection--multiple {
            border: 1px solid #e2e8f0 !important;
            border-radius: 8px !important;
            min-height: 42px !important;
            padding: 4px 8px !important;
        }

        .select2-container--default.select2-container--focus .select2-selection--single,
        .select2-container--default.select2-container--focus .select2-selection--multiple {
            border-color: #6366f1 !important;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1) !important;
        }

        .select2-selection__choice {
            background: #eff6ff !important;
            border: 1px solid #dbeafe !important;
            border-radius: 4px !important;
            color: #1d4ed8 !important;
            font-size: 0.75rem !important;
            font-weight: 500 !important;
        }

        /* Checkbox styling */
        .candidate-select-checkbox:checked,
        .job-checkbox:checked {
            background-color: #2563eb !important;
            border-color: #2563eb !important;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e") !important;
        }

        /* Hide internal Select2 tags in search cards to avoid duplication */
        .search-card .select2-selection__choice {
            display: none !important;
        }

        /* Ensure placeholder is visible even when items are selected if needed */
        .search-card .select2-search__field {
            width: 100% !important;
        }
    </style>

</head>

<body>
    <!-- Loading Spinner -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
        style="z-index: 20000;">
        <div class="bg-white rounded-lg p-6 flex flex-col items-center">
            <div class="spinner border-4 border-gray-200 rounded-full w-16 h-16 mb-4"></div>
            <p id="loading-message" class="text-gray-700 font-medium">読み込み中...</p>
        </div>
    </div>

    <!-- Organization Selection Modal -->
    <div id="org-select-modal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">所属組織を選択</h3>
                <div id="org-select-list" class="space-y-3 max-h-60 overflow-y-auto">
                    <!-- Org Buttons provided by JS -->
                </div>
                <div class="mt-4">
                    <button onclick="logout()" class="text-sm text-gray-500 hover:text-gray-700 underline">
                        ログアウトして戻る
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Organization Modal -->
    <div id="organization-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
        style="z-index: 100000;">
        <div class="bg-white rounded-lg w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900" id="org-modal-title">組織編集</h3>
                <button onclick="closeOrganizationModal()"
                    class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="organization-form" class="space-y-4">
                <input type="hidden" id="org-id">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">組織名 <span
                            class="text-red-500">*</span></label>
                    <input type="text" id="org-name-input" required
                        class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-50">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">プラン</label>
                        <select id="org-plan"
                            class="w-full border border-gray-300 rounded px-3 py-2 bg-white focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="free">Free</option>
                            <option value="standard">Standard</option>
                            <option value="premium">Premium</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ステータス</label>
                        <select id="org-status"
                            class="w-full border border-gray-300 rounded px-3 py-2 bg-white focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="active">有効</option>
                            <option value="suspended">停止中</option>
                            <option value="cancelled">解約済</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">最大ユーザー数</label>
                        <input type="number" id="org-max-users" min="1"
                            class="w-full border border-gray-300 rounded px-3 py-2 bg-white focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">有効期限</label>
                        <input type="date" id="org-valid-until"
                            class="w-full border border-gray-300 rounded px-3 py-2 bg-white focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <!-- 初期管理者設定（新規作成時のみ表示） -->
                <div id="org-initial-admin-fields" class="border-t pt-4 mt-4 hidden">
                    <h4 class="text-sm font-bold text-gray-700 mb-3">初期管理者設定</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">管理者名 <span
                                    class="text-red-500">*</span></label>
                            <input type="text" id="org-admin-name"
                                class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">管理者メール <span
                                    class="text-red-500">*</span></label>
                            <input type="email" id="org-admin-email"
                                class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <p class="text-xs text-gray-500 mt-1">※このアドレスに招待メールが送信されます</p>
                        </div>
                    </div>
                </div>
                <!-- 組織設定 -->
                <div class="border-t pt-4 mt-4">
                    <h4 class="text-sm font-bold text-gray-700 mb-2">組織・セキュリティ設定</h4>
                    <div class="space-y-2 mb-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="org-setting-email-required"
                                class="form-checkbox h-4 w-4 text-indigo-600">
                            <span class="ml-2 text-sm text-gray-700">求職者のメールアドレス入力を必須にする</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="org-setting-password-required"
                                class="form-checkbox h-4 w-4 text-indigo-600">
                            <span class="ml-2 text-sm text-gray-700">求職者のパスワード設定を必須にする</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="org-setting-limit-agent-view"
                                class="form-checkbox h-4 w-4 text-indigo-600">
                            <span class="ml-2 text-sm text-gray-700">エージェント閲覧制限(担当求職者のみ表示)</span>
                        </label>
                    </div>

                    <h4 class="text-sm font-bold text-gray-700 mb-2">役割の表示名称設定</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">組織管理者</label>
                            <input type="text" id="org-role-label-org_admin" placeholder="組織管理者"
                                class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">管理者</label>
                            <input type="text" id="org-role-label-admin" placeholder="管理者"
                                class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">CA・RA (スタッフ)</label>
                            <input type="text" id="org-role-label-coach" placeholder="CA・RA"
                                class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">求職者</label>
                            <input type="text" id="org-role-label-candidate" placeholder="求職者"
                                class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">※未入力の場合はデフォルト名称が使用されます</p>
                </div>

                <div class="flex justify-end pt-4 gap-3">
                    <button type="button" onclick="closeOrganizationModal()"
                        class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded">キャンセル</button>
                    <button type="submit"
                        class="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 shadow-sm">保存する</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Invitation URL Modal -->
    <div id="invitation-url-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
        style="z-index: 100010;">
        <div class="bg-white rounded-lg w-full max-w-md p-6">
            <div class="text-center mb-6">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                    <i class="fas fa-check text-green-600 text-xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900">招待URLを発行しました</h3>
                <p class="text-sm text-gray-500 mt-2">
                    <span id="invite-org-name" class="font-bold"></span> の管理者として<br>
                    <span id="invite-admin-email" class="font-bold"></span> を招待しました。
                </p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">招待URL</label>
                    <div class="flex gap-2">
                        <input type="text" id="invitation-url-display" readonly
                            class="w-full bg-gray-50 border border-gray-300 rounded px-3 py-2 text-sm text-gray-600">
                        <button onclick="copyInvitationUrl()"
                            class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-700" title="コピー">
                            <i class="far fa-copy"></i>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">※メール送信に失敗した場合などは、このURLを直接管理者に伝えてください。</p>
                </div>

                <div class="flex flex-col gap-2 mt-6">
                    <button onclick="sendInvitationEmail()"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none sm:text-sm">
                        <i class="fas fa-paper-plane mr-2 pt-1"></i> メールを再送信
                    </button>
                    <button onclick="closeInvitationUrlModal()"
                        class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:text-sm">
                        閉じる
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="page active">
        <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-100 to-purple-100 px-4">
            <div class="max-w-md w-full bg-white rounded-2xl shadow-xl p-8">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">RightJob マッチング</h1>
                    <p class="text-gray-600">ログインしてください</p>
                </div>

                <form id="login-form" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">メールアドレス</label>
                        <input type="email" id="login-email" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">パスワード</label>
                        <input type="password" id="login-password" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>

                    <div id="login-error" class="text-red-600 text-sm hidden"></div>

                    <button type="submit"
                        class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">
                        ログイン
                    </button>
                </form>

                <div class="mt-6 text-center">
                    <a href="#" id="show-signup" class="text-indigo-600 hover:text-indigo-700 text-sm">
                        アカウントをお持ちでない方はこちら
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Signup Page -->
    <div id="signup-page" class="page">
        <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-100 to-purple-100 px-4">
            <div class="max-w-md w-full bg-white rounded-2xl shadow-xl p-8">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">新規登録</h1>
                    <p class="text-gray-600">組織コードを入力して登録してください</p>
                </div>

                <form id="signup-form" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">組織コード <span
                                class="text-xs text-gray-500 font-normal">（担当者から配布されたコード）</span></label>
                        <div class="flex gap-2">
                            <input type="text" id="signup-org-code" required placeholder="例: A1B2C3D4"
                                class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent uppercase">
                            <button type="button" id="check-org-code"
                                class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition text-sm font-medium whitespace-nowrap">
                                確認
                            </button>
                        </div>
                        <p id="org-name-display" class="mt-2 text-sm text-green-600 font-bold hidden"></p>
                        <p id="org-code-error" class="mt-1 text-sm text-red-500 hidden"></p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">お名前</label>
                        <input type="text" id="signup-name" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ふりがな</label>
                        <input type="text" id="signup-furigana"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">メールアドレス</label>
                        <input type="email" id="signup-email" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">パスワード</label>
                        <input type="password" id="signup-password" required minlength="6"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>

                    <input type="hidden" id="invitation-token">

                    <div id="signup-error" class="text-red-600 text-sm hidden"></div>

                    <button type="submit"
                        class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">
                        登録する
                    </button>
                </form>

                <div class="mt-6 text-center">
                    <a href="#" id="show-login" class="text-indigo-600 hover:text-indigo-700 text-sm">
                        ログインページに戻る
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-page" class="page">
        <!-- Sidebar -->
        <aside class="sidebar flex flex-col">
            <div class="p-6 flex-shrink-0">
                <h2 class="text-2xl font-bold text-white">RightJob</h2>
                <div class="flex items-center gap-2 mt-1">
                    <div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>
                    <p id="org-name" class="text-sm text-indigo-300"></p>
                </div>
                <p id="org-code-display"
                    class="text-[10px] text-indigo-200 mt-2 font-mono bg-white/5 px-2 py-1 rounded inline-block border border-white/10 uppercase tracking-widest">
                </p>
            </div>

            <nav class="px-3 space-y-1 flex-1 overflow-y-auto custom-scrollbar">
                <a href="#" id="nav-dashboard" data-page="dashboard"
                    class="nav-link flex items-center px-4 py-3 rounded-lg transition active">
                    <i class="fas fa-home w-5"></i>
                    <span class="ml-3">ダッシュボード</span>
                </a>
                <a href="#" data-page="jobs" class="nav-link flex items-center px-4 py-3 rounded-lg transition">
                    <i class="fas fa-briefcase w-5"></i>
                    <span class="ml-3">求人検索</span>
                </a>
                <a href="#" id="nav-candidate-search" data-page="candidate-search"
                    class="nav-link hidden flex items-center px-4 py-3 rounded-lg transition">
                    <i class="fas fa-users w-5"></i>
                    <span class="ml-3">求職者検索</span>
                </a>

                <a href="#" data-page="ai-scout" id="ai-scout-link"
                    class="nav-link hidden flex items-center px-4 py-3 rounded-lg transition">
                    <i class="fas fa-robot w-5"></i>
                    <span class="ml-3">AIスカウト</span>
                </a>

                <a href="#" data-page="applications" class="nav-link flex items-center px-4 py-3 rounded-lg transition">
                    <i class="fas fa-file-alt w-5"></i>
                    <span class="ml-3">応募・選考状況</span>
                </a>
                <a href="#" data-page="recommendations"
                    class="nav-link flex items-center px-4 py-3 rounded-lg transition">
                    <i class="fas fa-robot w-5"></i>
                    <span class="ml-3">おすすめ求人</span>
                </a>
                <a href="#" data-page="profile" class="nav-link flex items-center px-4 py-3 rounded-lg transition">
                    <i class="fas fa-user w-5"></i>
                    <span class="ml-3">プロフィール</span>
                </a>

                <!-- Coach Menu (visible only for coach) -->
                <div id="coach-menu" class="hidden mt-6 pt-6 border-t border-white/10">
                    <p class="px-4 text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-3">CA・RAメニュー</p>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="coach-students">
                        <i class="fas fa-user-graduate w-5"></i>
                        <span class="ml-3">担当求職者</span>
                    </a>
                </div>

                <!-- Admin Menu (visible only for org_admin and admin) -->
                <div id="admin-menu" class="hidden mt-6 pt-6 border-t border-white/10">
                    <p class="px-4 text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-3">管理者メニュー</p>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-jobs">
                        <i class="fas fa-briefcase w-5"></i>
                        <span class="ml-3">求人管理</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-companies">
                        <i class="fas fa-building w-5"></i>
                        <span class="ml-3">企業管理</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-applicants">
                        <i class="fas fa-users w-5"></i>
                        <span class="ml-3">応募者管理</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-candidates">
                        <i class="fas fa-user-graduate w-5"></i>
                        <span class="ml-3">求職者管理</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-users">
                        <i class="fas fa-user-cog w-5"></i>
                        <span class="ml-3">ユーザー管理</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-csv">
                        <i class="fas fa-file-upload w-5"></i>
                        <span class="ml-3">CSVインポート</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-logs">
                        <i class="fas fa-history w-5"></i>
                        <span class="ml-3">操作ログ</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="kpi-dashboard">
                        <i class="fas fa-chart-line w-5"></i>
                        <span class="ml-3">KPI管理</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-templates">
                        <i class="fas fa-file-invoice w-5"></i>
                        <span class="ml-3">テンプレート管理</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-settings">
                        <i class="fas fa-cog w-5"></i>
                        <span class="ml-3">AIスカウト設定</span>
                    </a>

                </div>

                <!-- Super Admin Menu (visible only for super_admin) -->
                <div id="super-admin-menu" class="hidden mt-6 pt-6 border-t border-gray-200">
                    <p class="px-4 text-xs font-semibold text-red-400 uppercase tracking-wider mb-3">スーパー管理者</p>
                    <a href="#"
                        class="nav-link flex items-center px-4 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600 rounded-lg transition"
                        data-page="super-admin-organizations">
                        <i class="fas fa-building w-5"></i>
                        <span class="ml-3">組織管理</span>
                    </a>
                    <a href="#"
                        class="nav-link flex items-center px-4 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600 rounded-lg transition"
                        data-page="admin-prompts">
                        <i class="fas fa-cog w-5"></i>
                        <span class="ml-3">プロンプト設定</span>
                    </a>
                    <a href="#"
                        class="nav-link flex items-center px-4 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600 rounded-lg transition"
                        data-page="admin-master">
                        <i class="fas fa-database w-5"></i>
                        <span class="ml-3">マスタデータ管理</span>
                    </a>
                </div>
            </nav>

            <div class="p-4 border-t border-white/10 flex-shrink-0 bg-transparent">
                <div class="flex items-center mb-3">
                    <div class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-indigo-300"></i>
                    </div>
                    <div class="ml-3">
                        <p id="user-name" class="text-sm font-medium text-white"></p>
                        <p id="user-role" class="text-xs text-indigo-200 mb-1"></p>
                        <button onclick="showOrgSelectModalForSwitch()"
                            class="hidden text-[10px] text-indigo-300 hover:text-indigo-100 font-bold flex items-center gap-1">
                            <i class="fas fa-exchange-alt"></i> 組織を切り替える
                        </button>
                    </div>
                </div>
                <button id="logout-btn"
                    class="w-full px-4 py-2 text-sm text-red-400 hover:bg-red-400/10 rounded-lg transition">
                    <i class="fas fa-sign-out-alt mr-2"></i>ログアウト
                </button>
            </div>
        </aside>
        <!-- Sidebar Overlay -->
        <div id="sidebar-overlay" class="sidebar-overlay"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="bg-white border-b border-gray-200 px-4 sm:px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <button id="mobile-menu-btn"
                            class="md:hidden w-10 h-10 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded-lg shadow-sm active:scale-95 transition">
                            <i class="fas fa-bars text-xl"></i>
                        </button>
                        <h1 id="page-title"
                            class="text-xl sm:text-2xl font-bold text-gray-900 truncate max-w-[150px] sm:max-w-none">
                            ダッシュボード</h1>
                    </div>
                    <div class="flex items-center gap-2 sm:gap-4">
                        <!-- Organization Switcher (Super Admin only) -->
                        <div id="org-switcher-container" class="hidden">
                            <select id="org-switcher"
                                class="border border-red-300 rounded-md px-3 py-1 text-xs sm:text-sm focus:outline-none focus:ring-2 focus:ring-red-500 bg-red-50 text-red-900 font-medium max-w-[100px] sm:max-w-none">
                                <option value="">組織を選択...</option>
                            </select>
                        </div>

                        <!-- Notification Bell -->
                        <div class="relative">
                            <button id="notification-btn"
                                class="relative p-2 text-gray-600 hover:text-gray-900 bg-gray-50 rounded-lg">
                                <i class="fas fa-bell text-lg sm:text-xl"></i>
                                <span id="notification-badge"
                                    class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[10px] rounded-full min-w-[18px] h-[18px] flex items-center justify-center px-1">0</span>
                            </button>
                            <!-- Notification Dropdown -->
                            <div id="notification-dropdown"
                                class="hidden absolute right-0 mt-2 w-72 sm:w-80 bg-white rounded-lg shadow-xl border z-50">
                                <div class="p-4 border-b">
                                    <h3 class="font-semibold text-sm sm:text-base">通知</h3>
                                </div>
                                <div id="notification-list" class="max-h-96 overflow-y-auto">
                                    <!-- Notifications will be rendered here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Dashboard Page -->
            <div id="dashboard-content" class="app-content p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Stats Cards -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">応募中</p>
                                <p id="stat-applications" class="text-3xl font-bold text-indigo-600 mt-2">0</p>
                            </div>
                            <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-file-alt text-indigo-600 text-xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">AI紹介</p>
                                <p id="stat-recommendations" class="text-3xl font-bold text-purple-600 mt-2">0</p>
                            </div>
                            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-star text-purple-600 text-xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">閲覧した求人</p>
                                <p id="stat-views" class="text-3xl font-bold text-green-600 mt-2">0</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-eye text-green-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6 border-b">
                        <h2 class="text-lg font-semibold text-gray-900">最近のアクティビティ</h2>
                    </div>
                    <div id="recent-activity" class="p-6">
                        <p class="text-gray-500 text-center py-8">アクティビティがありません</p>
                    </div>
                </div>
            </div>

            <!-- Jobs Page -->
            <div id="jobs-content" class="app-content p-6 hidden">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <div class="flex items-center gap-4">
                        <h2 class="text-2xl font-bold text-gray-900">求人検索</h2>
                    </div>
                </div>

                <div class="search-card mb-8">
                    <!-- Admin/Coach: User Selection (Integrated) -->
                    <div id="admin-job-search-tools" class="mb-6 pb-6 border-b border-slate-100 hidden">
                        <div class="filter-group-label">
                            <i class="fas fa-user-circle text-indigo-500"></i> 対象ユーザー <span
                                class="admin-badge ml-2">管理者専用</span>
                        </div>
                        <div class="relative">
                            <div id="target-user-input-wrapper">
                                <input type="text" id="target-user-search" placeholder="ユーザー名またはメールアドレスで検索..."
                                    class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all" />
                                <i class="fas fa-search absolute right-3 top-3 text-slate-400"></i>
                            </div>
                            <div id="target-user-dropdown"
                                class="hidden absolute w-full bg-white border border-slate-200 rounded-lg shadow-xl mt-1 z-50 max-h-60 overflow-y-auto">
                            </div>
                            <div id="selected-user-display"
                                class="hidden mt-2 p-3 bg-indigo-50 border border-indigo-100 rounded-lg flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold"
                                        id="selected-user-avatar">?</div>
                                    <div>
                                        <div class="font-bold text-slate-900" id="selected-user-name"></div>
                                        <div class="text-xs text-slate-500" id="selected-user-email"></div>
                                    </div>
                                </div>
                                <button id="clear-user-selection"
                                    class="text-slate-400 hover:text-red-500 transition-colors">
                                    <i class="fas fa-times-circle text-xl"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                        <!-- Col 1: Keyword & Salary -->
                        <div class="space-y-4">
                            <div>
                                <label class="filter-group-label">キーワード</label>
                                <div class="relative">
                                    <input type="text" id="search-keyword" placeholder="営業、エンジニア、東京など..."
                                        class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                                    <i class="fas fa-search absolute right-3 top-3 text-slate-400"></i>
                                </div>
                                <div id="tags-keyword" class="tag-container mt-2"></div>
                                <div class="flex gap-4 text-[10px] sm:text-xs text-slate-500 mt-2 px-1">
                                    <label class="flex items-center cursor-pointer hover:text-indigo-600 transition">
                                        <input type="radio" name="search-keyword-mode" value="OR" checked
                                            class="mr-1 accent-indigo-600"> OR検索
                                    </label>
                                    <label class="flex items-center cursor-pointer hover:text-indigo-600 transition">
                                        <input type="radio" name="search-keyword-mode" value="AND"
                                            class="mr-1 accent-indigo-600"> AND検索
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="filter-group-label">希望年収</label>
                                <div class="premium-slider-container">
                                    <input type="range" id="search-salary-slider" min="0" max="2000" step="50" value="0"
                                        class="premium-slider"
                                        oninput="$('#salary-display').text(this.value === '0' ? '指定なし' : this.value + ' 万円以上')">
                                    <div class="flex justify-between mt-2">
                                        <span class="text-[10px] text-slate-400">0</span>
                                        <span id="salary-display" class="text-sm font-bold text-indigo-600">指定なし</span>
                                        <span class="text-[10px] text-slate-400">2000万</span>
                                    </div>
                                    <input type="hidden" id="search-salary-min" value="0">
                                </div>
                            </div>
                        </div>

                        <!-- Col 2: Industry & Occupation -->
                        <div class="space-y-4">
                            <div>
                                <label class="filter-group-label">業種</label>
                                <select id="search-industry-category" class="w-full select2"
                                    multiple="multiple"></select>
                                <div id="tags-industry" class="tag-container mt-1"></div>
                            </div>
                            <div>
                                <label class="filter-group-label">職種</label>
                                <select id="search-job-category" class="w-full select2" multiple="multiple"></select>
                                <div id="tags-job" class="tag-container mt-1"></div>
                            </div>
                        </div>

                        <!-- Col 3: Location & Employment -->
                        <div class="space-y-4">
                            <div>
                                <label class="filter-group-label">勤務地</label>
                                <select id="search-prefecture" class="w-full select2" multiple="multiple"></select>
                                <div id="tags-prefecture" class="tag-container mt-1"></div>
                            </div>
                            <div>
                                <label class="filter-group-label">雇用形態</label>
                                <select id="search-employment-type" class="w-full select2" multiple="multiple"></select>
                                <div id="tags-employment" class="tag-container mt-1"></div>
                            </div>
                        </div>
                    </div>

                    <div
                        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8 pt-6 border-t border-slate-50">
                        <!-- Col 1: Freeword -->
                        <div>
                            <label class="filter-group-label">フリーワード（地名、駅名など）</label>
                            <div class="relative">
                                <input type="text" id="search-location" placeholder="特定の地名、駅名など..."
                                    class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                                <i class="fas fa-map-marked-alt absolute right-3 top-3 text-slate-400"></i>
                            </div>
                            <div id="tags-freeword" class="tag-container mt-1"></div>
                        </div>

                        <!-- Col 2: Experience OK -->
                        <div>
                            <label class="filter-group-label">募集条件</label>
                            <div class="flex flex-wrap gap-x-6 gap-y-3">
                                <label class="flex items-center gap-2 cursor-pointer group">
                                    <input type="checkbox" id="search-job-experience-ok"
                                        class="w-5 h-5 accent-indigo-600 border-slate-300 rounded">
                                    <span class="text-sm text-slate-600 group-hover:text-slate-900">職種未経験OK</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer group">
                                    <input type="checkbox" id="search-industry-experience-ok"
                                        class="w-5 h-5 accent-indigo-600 border-slate-300 rounded">
                                    <span class="text-sm text-slate-600 group-hover:text-slate-900">業界未経験OK</span>
                                </label>
                            </div>
                        </div>

                        <!-- Col 3: Favorites & Display -->
                        <div>
                            <label class="filter-group-label">表示設定</label>
                            <div class="flex flex-wrap gap-x-6 gap-y-3">
                                <label class="flex items-center gap-2 cursor-pointer group"
                                    id="exclude-matched-container" style="display: none;">
                                    <input type="checkbox" id="search-exclude-matched"
                                        class="w-5 h-5 accent-purple-600 border-slate-300 rounded">
                                    <span
                                        class="text-sm text-purple-700 font-medium group-hover:text-purple-900">AIマッチ済みを除く</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer group">
                                    <input type="checkbox" id="search-favorites-only"
                                        class="w-5 h-5 accent-pink-500 border-slate-300 rounded">
                                    <span
                                        class="text-sm text-pink-600 font-medium group-hover:text-pink-900">お気に入りのみ</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex flex-wrap gap-6 justify-between items-center pt-6 border-t border-slate-100">
                        <div class="flex gap-4 items-center">
                            <button onclick="searchJobsImmediate()"
                                class="bg-indigo-600 text-white px-10 py-2.5 rounded-lg hover:bg-white hover:text-indigo-600 border border-transparent hover:border-indigo-600 font-bold transition shadow-md hover:shadow-lg flex items-center">
                                <i class="fas fa-search mr-2"></i>検索
                            </button>
                            <button onclick="clearSearch()"
                                class="px-8 py-2.5 border border-slate-200 text-slate-600 rounded-lg hover:bg-slate-50 font-medium transition">
                                クリア
                            </button>

                            <div id="job-count-display-premium" class="hidden count-badge-premium ml-4">
                                <i class="fas fa-briefcase text-indigo-400 text-xl"></i>
                                <div class="flex flex-col leading-none">
                                    <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Matched
                                        Jobs</span>
                                    <div class="flex items-baseline gap-1">
                                        <span id="job-count-number" class="count-number-premium">0</span>
                                        <span class="text-xs text-slate-500 font-bold">件</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-6 items-center">
                            <div class="flex flex-col items-end">
                                <select id="saved-searches-select" onchange="loadSavedSearch(this.value)"
                                    class="px-4 py-1.5 border border-slate-200 rounded-lg text-sm bg-slate-50 hover:bg-white transition hidden">
                                    <option value="">保存した検索条件</option>
                                </select>
                                <button onclick="saveSearchConditions()"
                                    class="text-indigo-600 hover:text-indigo-800 text-sm font-bold flex items-center mt-1">
                                    <i class="fas fa-bookmark mr-1.5"></i>この条件を保存
                                </button>
                            </div>
                            <button onclick="selectTop30Jobs()" id="select-top-30-btn"
                                class="px-4 py-2 bg-purple-50 text-purple-700 rounded-lg hover:bg-purple-100 border border-purple-100 font-bold text-sm hidden transition">
                                <i class="fas fa-check-double mr-1.5"></i>上位30件を選択
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 一括推薦/AIマッチング診断バー -->
                <!-- 一括推薦/AIマッチング診断バー -->
                <div id="bulk-recommend-bar"
                    class="fixed bottom-6 left-1/2 md:left-[calc(50%+128px)] transform -translate-x-1/2 z-50 bg-white border border-indigo-100 rounded-full shadow-2xl px-4 sm:px-8 py-3 sm:py-4 hidden flex items-center justify-between gap-3 sm:gap-8 transition-all duration-300 w-[92vw] sm:w-auto max-w-[600px]">
                    <div class="flex items-center">
                        <div
                            class="bg-indigo-100 text-indigo-600 rounded-full w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center mr-2 sm:mr-3 shrink-0">
                            <i class="fas fa-check text-xs sm:text-base"></i>
                        </div>
                        <div class="leading-tight">
                            <span class="font-bold text-gray-800 block text-[10px] sm:text-sm">選択状況</span>
                            <span class="text-indigo-600 font-bold"><span id="selected-jobs-count"
                                    class="text-base sm:text-xl">0</span> <span
                                    class="text-[10px] sm:text-sm text-gray-500">件</span></span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 sm:gap-3">
                        <button onclick="clearAllSelectedJobs()"
                            class="bg-gray-100 text-gray-600 px-3 sm:px-4 py-2 sm:py-3 rounded-full hover:bg-gray-200 font-bold shadow hover:shadow-md transition flex items-center text-xs sm:text-sm">
                            <i class="fas fa-times sm:mr-2"></i><span class="hidden sm:inline">全解除</span>
                        </button>
                        <button onclick="openBulkRecommendModal()"
                            class="bar-button bg-indigo-600 text-white px-4 sm:px-8 py-2 sm:py-3 rounded-full hover:bg-indigo-700 font-bold shadow-lg hover:shadow-xl transition flex items-center transform hover:-translate-y-0.5 text-xs sm:text-sm">
                            <i class="fas fa-paper-plane mr-1 sm:mr-2"></i>AIマッチ<span
                                class="hidden sm:inline">を実行</span>
                        </button>
                    </div>
                </div>

                <div id="jobs-container">
                    <!-- Jobs will be rendered here -->
                </div>
            </div>

            <!-- Applications Page -->
            <!-- 求職者検索ページ（新規追加） -->
            <div id="candidate-search-content" class="app-content p-6 hidden">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <div class="flex items-center gap-4">
                        <h2 class="text-2xl font-bold text-gray-900">求職者検索</h2>
                    </div>
                </div>

                <div class="search-card mb-8">
                    <!-- Target Job Selection (AI Matching) -->
                    <div id="admin-candidate-search-tools" class="mb-6 pb-6 border-b border-slate-100">
                        <div class="filter-group-label">
                            <i class="fas fa-briefcase text-indigo-500"></i> 対象求人を選択 <span
                                class="admin-badge ml-2">AIマッチング用</span>
                        </div>
                        <div class="relative">
                            <div id="target-job-input-wrapper">
                                <input type="text" id="target-job-search" placeholder="求人タイトルまたは企業名で検索..."
                                    class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all" />
                                <i class="fas fa-search absolute right-3 top-3 text-slate-400"></i>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
                                <select id="t-job-category" class="w-full select2" multiple="multiple"></select>
                                <select id="t-industry" class="w-full select2" multiple="multiple"></select>
                                <select id="t-location" class="w-full select2" multiple="multiple"></select>
                            </div>

                            <!-- 検索結果ドロップダウン -->
                            <div id="target-job-dropdown"
                                class="hidden absolute w-full bg-white border border-slate-200 rounded-lg shadow-xl mt-1 z-50 max-h-60 overflow-y-auto">
                            </div>

                            <!-- 選択済み求人表示 -->
                            <div id="selected-job-display"
                                class="hidden mt-3 p-3 bg-indigo-50 border border-indigo-100 rounded-lg flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold"
                                        id="selected-job-avatar"><i class="fas fa-building"></i></div>
                                    <div>
                                        <div class="font-bold text-slate-900" id="selected-job-title"></div>
                                        <div class="text-xs text-slate-500" id="selected-job-company"></div>
                                    </div>
                                </div>
                                <button id="clear-job-selection"
                                    class="text-slate-400 hover:text-red-500 transition-colors">
                                    <i class="fas fa-times-circle text-xl"></i>
                                </button>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button onclick="runJobToCandidateMatching()" id="job-ai-match-btn"
                                class="bg-indigo-600 text-white px-8 py-2 rounded-lg hover:bg-white hover:text-indigo-600 border border-transparent hover:border-indigo-600 font-bold transition shadow-md flex items-center"
                                disabled>
                                <i class="fas fa-robot mr-2"></i>AIマッチングを実行
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <!-- Col 1: Keyword & Salary -->
                        <div class="space-y-4">
                            <div>
                                <label class="filter-group-label">キーワード</label>
                                <div class="relative">
                                    <input type="text" id="c-search-keyword" placeholder="スキル、経歴、資格など..."
                                        class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                                    <i class="fas fa-search absolute right-3 top-3 text-slate-400"></i>
                                </div>
                                <div id="c-tags-keyword" class="tag-container mt-2"></div>
                            </div>
                            <div>
                                <label class="filter-group-label">希望最低年収</label>
                                <div class="premium-slider-container">
                                    <input type="range" id="c-search-salary-slider" min="0" max="2000" step="50"
                                        value="0" class="premium-slider"
                                        oninput="$('#c-salary-display').text(this.value === '0' ? '指定なし' : this.value + ' 万円以上')">
                                    <div class="flex justify-between mt-2">
                                        <span class="text-[10px] text-slate-400">0</span>
                                        <span id="c-salary-display"
                                            class="text-sm font-bold text-indigo-600">指定なし</span>
                                        <span class="text-[10px] text-slate-400">2000万</span>
                                    </div>
                                    <input type="hidden" id="c-search-salary-min" value="0">
                                </div>
                            </div>
                        </div>

                        <!-- Col 2: Job Category & Employment Type -->
                        <div class="space-y-4">
                            <div>
                                <label class="filter-group-label">希望職種</label>
                                <select id="c-search-job-category" class="w-full select2" multiple="multiple"></select>
                                <div id="c-tags-job" class="tag-container mt-1"></div>
                            </div>
                            <div>
                                <label class="filter-group-label">希望雇用形態</label>
                                <select id="c-search-employment-type" class="w-full select2"
                                    multiple="multiple"></select>
                                <div id="c-tags-employment" class="tag-container mt-1"></div>
                            </div>
                        </div>

                        <!-- Col 3: Industry & Status -->
                        <div class="space-y-4">
                            <div>
                                <label class="filter-group-label">希望業界</label>
                                <select id="c-search-industry-category" class="w-full select2"
                                    multiple="multiple"></select>
                                <div id="c-tags-industry" class="tag-container mt-1"></div>
                            </div>
                            <div>
                                <label class="filter-group-label">管理ステータス</label>
                                <select id="c-search-management-status"
                                    class="w-full px-4 py-2 border border-slate-200 rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="all">すべて</option>
                                    <option value="active" selected>活動中</option>
                                    <option value="inactive">活動終了</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Details (Always Visible) -->
                    <div
                        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8 pt-6 border-t border-slate-50">
                        <div>
                            <label class="filter-group-label">希望勤務地</label>
                            <select id="c-search-prefecture" class="w-full select2" multiple="multiple"></select>
                            <div id="c-tags-prefecture" class="tag-container mt-1"></div>
                        </div>
                        <div>
                            <label class="filter-group-label">フリーワード（詳細勤務地など）</label>
                            <div class="relative">
                                <input type="text" id="c-search-location" placeholder="横浜、大阪、リモートなど..."
                                    class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                                <i class="fas fa-map-marked-alt absolute right-3 top-3 text-slate-400"></i>
                            </div>
                            <div id="c-tags-location" class="tag-container mt-1"></div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex flex-wrap gap-6 justify-between items-center pt-6 border-t border-slate-100">
                        <div class="flex gap-4 items-center">
                            <button onclick="searchCandidatesImmediate()"
                                class="bg-indigo-600 text-white px-10 py-2.5 rounded-lg hover:bg-white hover:text-indigo-600 border border-transparent hover:border-indigo-600 font-bold transition shadow-md flex items-center">
                                <i class="fas fa-search mr-2"></i>求職者検索
                            </button>
                            <button onclick="clearCandidateSearch()"
                                class="px-8 py-2.5 border border-slate-200 text-slate-600 rounded-lg hover:bg-slate-50 font-medium transition">
                                クリア
                            </button>

                            <div id="candidate-count-display-premium" class="hidden count-badge-premium ml-4">
                                <i class="fas fa-user text-indigo-400 text-xl"></i>
                                <div class="flex flex-col leading-none">
                                    <span
                                        class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Candidates
                                        Found</span>
                                    <div class="flex items-baseline gap-1">
                                        <span id="candidate-count-number" class="count-number-premium">0</span>
                                        <span class="text-xs text-slate-500 font-bold">名</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <select id="c-search-sort"
                                class="px-4 py-2 border border-slate-200 rounded-lg text-sm bg-slate-50 hover:bg-white transition cursor-pointer">
                                <option value="created_at-desc">登録日（新しい順）</option>
                                <option value="age-asc">年齢（若い順）</option>
                                <option value="age-desc">年齢（高い順）</option>
                                <option value="salary-desc">希望年収が高い順</option>
                                <option value="salary-asc">希望年収が低い順</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 結果一覧 -->
                <div id="candidate-results-container" class="space-y-4">
                    <!-- Candidates will be rendered here -->
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-search text-4xl mb-3"></i>
                        <p>条件を指定して検索してください</p>
                    </div>
                </div>
                <div id="load-more-candidates-container" class="text-center mt-8 hidden">
                    <button onclick="loadMoreCandidates()"
                        class="bg-white border border-gray-300 text-gray-700 px-6 py-3 rounded-xl hover:bg-gray-50 transition">
                        もっと見る
                    </button>
                </div>
            </div>

            <div id="applications-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6 flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-semibold mb-2">応募・選考履歴</h2>
                        <p class="text-gray-600">応募・選考中の求人の一覧です。</p>
                    </div>
                    <button onclick="exportApplicationsCsv()" id="export-applications-btn"
                        class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 hidden">
                        <i class="fas fa-download mr-2"></i>CSVエクスポート
                    </button>
                </div>
                <div id="applications-container">
                    <!-- Applications will be rendered here -->
                </div>
            </div>

            <!-- Recommendations Page -->
            <div id="recommendations-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-2">おすすめ求人</h2>
                    <p class="text-gray-600">あなたのプロフィールに基づいて、AIが最適な求人を提案します。</p>
                </div>

                <!-- タブナビゲーション -->
                <div class="bg-white rounded-lg shadow mb-6">
                    <div class="border-b border-gray-200">
                        <nav class="flex -mb-px">
                            <button onclick="switchRecommendationTab('matches')" id="rec-tab-matches"
                                class="rec-tab px-6 py-3 text-sm font-medium border-b-2 border-indigo-600 text-indigo-600">
                                <i class="fas fa-check-circle mr-2"></i>提案 (50%以上)
                            </button>
                            <button onclick="switchRecommendationTab('unmatches')" id="rec-tab-unmatches"
                                class="rec-tab px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                <i class="fas fa-times-circle mr-2"></i>アンマッチ (49%以下)
                            </button>
                        </nav>
                    </div>
                </div>

                <div id="recommendations-container">
                    <!-- Recommendations will be rendered here -->
                </div>

                <!-- 推薦メッセージ作成モーダル -->
                <div id="recommendation-message-modal"
                    class="fixed inset-0 bg-black bg-opacity-50 z-[100] hidden flex items-center justify-center p-4">
                    <div
                        class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                        <div class="p-6 border-b flex justify-between items-center bg-indigo-50">
                            <div>
                                <h3 class="text-xl font-bold text-indigo-900"><i class="fas fa-magic mr-2"></i>推薦メッセージ生成
                                </h3>
                                <p class="text-xs text-indigo-600 mt-1">選択した求人の内容を元に、メッセージを自動構成します</p>
                            </div>
                            <button onclick="closeRecommendationMessageModal()"
                                class="text-gray-400 hover:text-gray-600 transition-colors">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-6 space-y-6">
                            <!-- テンプレート選択 -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">テンプレート選択</label>
                                    <select id="message-template-select" onchange="applyMessageTemplate(this.value)"
                                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <!-- Loaded dynamically -->
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button onclick="generateRecommendationMessage()"
                                        class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 font-bold transition flex items-center justify-center gap-2">
                                        <i class="fas fa-sync-alt"></i> メッセージを生成/更新
                                    </button>
                                </div>
                            </div>

                            <!-- メッセージ本文 -->
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">
                                    メッセージ本文
                                    <span class="text-xs font-normal text-gray-500 ml-2">(必要に応じて手動で調整してください)</span>
                                </label>
                                <textarea id="recommendation-message-body" rows="15"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm font-mono focus:ring-2 focus:ring-indigo-500 bg-gray-50"></textarea>
                            </div>
                        </div>
                        <div class="p-6 border-t bg-gray-50 flex justify-between items-center">
                            <div class="flex gap-2">
                                <button onclick="copyRecommendationMessage()"
                                    class="px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium transition flex items-center gap-2">
                                    <i class="fas fa-copy"></i> クリップボードにコピー
                                </button>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="closeRecommendationMessageModal()"
                                    class="px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium transition">
                                    キャンセル
                                </button>
                                <button id="send-recommendation-email-btn" onclick="sendRecommendationEmail()"
                                    class="px-8 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold shadow-lg transition flex items-center gap-2">
                                    <i class="fas fa-paper-plane"></i> 候補者へメール送信
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profile-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 max-w-2xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold">プロフィール編集</h2>
                        <div class="relative">
                            <input type="file" id="resume-upload" accept=".pdf" multiple class="hidden"
                                onchange="handleResumeUpload(this)">
                            <button onclick="$('#resume-upload').click()"
                                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm flex items-center">
                                <i class="fas fa-file-pdf mr-2"></i>PDFから自動入力
                            </button>
                        </div>
                    </div>
                    <form id="profile-form" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">お名前</label>
                            <input type="text" id="profile-name" class="w-full px-4 py-2 border rounded-lg bg-gray-50"
                                readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ふりがな</label>
                            <input type="text" id="profile-furigana"
                                class="w-full px-4 py-2 border rounded-lg bg-gray-50">
                            <p class="text-xs text-gray-500 mt-1">※お名前は管理者にお問い合わせください</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">メールアドレス</label>
                                <input type="email" id="profile-email" class="w-full px-4 py-2 border rounded-lg"
                                    required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">電話番号</label>
                                <input type="tel" id="profile-phone" class="w-full px-4 py-2 border rounded-lg"
                                    placeholder="例: 090-0000-0000">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">生年月日</label>
                                <input type="date" id="profile-birth-date" class="w-full px-4 py-2 border rounded-lg"
                                    onchange="calculateAge(this.value, '#profile-age')">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">年齢</label>
                                <input type="number" id="profile-age" class="w-full px-4 py-2 border rounded-lg"
                                    min="0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">性別</label>
                                <select id="profile-gender" class="w-full px-4 py-2 border rounded-lg">
                                    <option value="">選択してください</option>
                                    <option value="男性">男性</option>
                                    <option value="女性">女性</option>
                                    <option value="その他">その他</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">現住所（都道府県）</label>
                            <select id="profile-current-location"
                                class="w-full px-4 py-2 border rounded-lg select2-prefecture">
                                <option value="">都道府県を選択</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">希望職種</label>
                                <select id="profile-job-type" class="w-full px-4 py-2 border rounded-lg select2"
                                    multiple style="width: 100%">
                                    <!-- Options will be loaded dynamically -->
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">希望業界</label>
                                <select id="profile-industry" class="w-full px-4 py-2 border rounded-lg select2"
                                    multiple style="width: 100%">
                                    <!-- Options will be loaded dynamically -->
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">希望勤務地</label>
                                <div class="flex gap-2">
                                    <select id="profile-prefecture" class="w-1/3 px-2 py-2 border rounded-lg select2"
                                        multiple="multiple">
                                        style="width: 40%">
                                        <option value="">都道府県</option>
                                    </select>
                                    <input type="text" id="profile-city" placeholder="市区町村（例: 渋谷区）"
                                        class="w-2/3 px-4 py-2 border rounded-lg" style="width: 60%">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">希望雇用形態</label>
                                <select id="profile-employment-type" class="w-full px-4 py-2 border rounded-lg select2"
                                    multiple style="width: 100%">
                                    <!-- Options will be loaded dynamically -->
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">希望最低年収（万円）</label>
                                <input type="number" id="profile-salary" placeholder="例: 400" min="0"
                                    class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">フリーワード</label>
                                <input type="text" id="profile-freewords" placeholder="検索用キーワード"
                                    class="w-full px-4 py-2 border rounded-lg">
                            </div>
                        </div>

                        <div class="flex gap-6">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="profile-job-experience-ok"
                                    class="w-4 h-4 text-indigo-600 rounded">
                                <span class="text-sm text-gray-700">職種未経験可</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="profile-industry-experience-ok"
                                    class="w-4 h-4 text-indigo-600 rounded">
                                <span class="text-sm text-gray-700">業界未経験可</span>
                            </label>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">スキル</label>
                            <input type="text" id="profile-skills" placeholder="例: React, TypeScript, Figma"
                                class="w-full px-4 py-2 border rounded-lg">
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">現在の年収（万円）</label>
                                <input type="number" id="profile-current-salary" placeholder="例: 400" min="0"
                                    class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">最終学歴</label>
                                <input type="text" id="profile-academic" placeholder="例: 〇〇大学 経済学部 卒"
                                    class="w-full px-4 py-2 border rounded-lg">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">語学力</label>
                                <input type="text" id="profile-languages" placeholder="例: TOEIC 800点, 日常会話レベルの英語"
                                    class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">資格</label>
                                <input type="text" id="profile-certifications" placeholder="例: 基本情報技術者, AWS SAA"
                                    class="w-full px-4 py-2 border rounded-lg">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">勤務開始可能日</label>
                            <input type="date" id="profile-start-date" class="w-full px-4 py-2 border rounded-lg">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">職歴・自己PR（概要）</label>
                            <textarea id="profile-history" rows="6" placeholder="これまでの経験や得意なことを詳しく教えてください"
                                class="w-full px-4 py-2 border rounded-lg"></textarea>
                        </div>

                        <!-- 構造化された職歴 (New) -->
                        <div class="mb-6 border-t border-gray-200 pt-6">
                            <div class="flex justify-between items-center mb-4">
                                <label class="block text-sm font-bold text-gray-700">詳細職歴 (最大10社)</label>
                                <button type="button"
                                    onclick="addWorkHistoryItemToContainer('#profile-work-history-list')"
                                    class="text-sm text-indigo-600 hover:text-indigo-800 flex items-center font-medium">
                                    <i class="fas fa-plus-circle mr-1"></i>職歴を追加
                                </button>
                            </div>
                            <div id="profile-work-history-list" class="space-y-4 mb-2">
                                <!-- JSで動的に追加 -->
                            </div>

                            <div class="flex items-center gap-4 mt-2 mb-4">
                                <label class="text-xs text-gray-500">過去転職回数 (自動計算):</label>
                                <input type="number" id="profile-job-change-count"
                                    class="w-20 px-2 py-1 border rounded bg-gray-50 text-center text-sm" readonly>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">職務経歴 (詳細テキスト)</label>
                            <textarea id="profile-work-history-detail" rows="10"
                                class="w-full px-4 py-2 border rounded-lg text-sm font-mono bg-gray-50 focus:bg-white transition"
                                placeholder="職務経歴の詳細テキストをこちらに貼り付けてください"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">履歴情報</label>
                            <textarea id="profile-history-info" rows="6"
                                class="w-full px-4 py-2 border rounded-lg text-sm bg-gray-50 focus:bg-white transition"
                                placeholder="履歴情報の補足や詳細をこちらに入力してください"></textarea>
                        </div>

                        <!-- 社内用情報 (管理者・コーチのみ表示) -->
                        <div id="internal-profile-info"
                            class="hidden border-t-2 border-dashed border-indigo-200 pt-6 mt-8 space-y-6">
                            <h3 class="text-lg font-bold text-indigo-900 flex items-center">
                                <i class="fas fa-lock mr-2"></i>社内用情報（求職者には非表示）
                            </h3>

                            <div class="grid grid-cols-1 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Google Drive URL</label>
                                    <input type="url" id="profile-drive-url" class="w-full px-4 py-2 border rounded-lg"
                                        placeholder="https://drive.google.com/...">
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">NotebookLM
                                            URL</label>
                                        <input type="url" id="profile-notebooklm-url"
                                            class="w-full px-4 py-2 border rounded-lg"
                                            placeholder="https://notebooklm.google.com/...">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">LINE URL</label>
                                        <input type="url" id="profile-line-url"
                                            class="w-full px-4 py-2 border rounded-lg"
                                            placeholder="https://line.me/...">
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">社内マッチング情報</label>
                                <textarea id="profile-resume-detail" rows="10"
                                    class="w-full px-4 py-2 border rounded-lg text-sm font-mono bg-gray-50 focus:bg-white transition"
                                    placeholder="社内マッチング情報（スキル、経験、希望の補足など）"></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">社内メモ・共有事項</label>
                                <textarea id="profile-notes" rows="6"
                                    class="w-full px-4 py-2 border rounded-lg text-sm bg-gray-50 focus:bg-white transition"
                                    placeholder="社内メモ、面談記録、共有事項など"></textarea>
                            </div>
                        </div>

                        <div class="flex justify-end pt-4">
                            <button type="submit"
                                class="bg-indigo-600 text-white px-8 py-2 rounded-lg hover:bg-indigo-700 transition font-medium">
                                保存する
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- AIスカウトページ -->
            <!-- AIスカウトページ -->
            <div id="ai-scout-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg w-full p-6 shadow min-h-[600px]">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-900">
                            <i class="fas fa-robot text-indigo-600 mr-2"></i>AIスカウト
                        </h3>
                    </div>

                    <!-- タブナビゲーション -->
                    <div class="border-b border-gray-200 mb-4">
                        <nav class="flex space-x-8">
                            <button onclick="switchProfileAnalysisTab('new')" id="profile-tab-new"
                                class="profile-analysis-tab py-3 px-1 border-b-2 border-indigo-600 font-medium text-sm text-indigo-600">
                                新規解析
                            </button>
                            <button onclick="switchProfileAnalysisTab('history')" id="profile-tab-history"
                                class="profile-analysis-tab py-3 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                解析履歴
                            </button>
                            <button onclick="switchProfileAnalysisTab('scout_management')"
                                id="profile-tab-scout_management"
                                class="profile-analysis-tab py-3 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                スカウト管理
                            </button>
                            <button onclick="switchProfileAnalysisTab('analytics')" id="profile-tab-analytics"
                                class="profile-analysis-tab py-3 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                効果測定
                            </button>
                        </nav>
                    </div>

                    <!-- 新規解析タブ -->
                    <div id="profile-new-tab-content" class="flex-1 overflow-y-auto flex gap-6">
                        <!-- 左側: 入力エリア -->
                        <!-- 左側: 入力エリア -->
                        <div class="w-1/3 flex flex-col gap-6">

                            <!-- STEP 1: Basic Information -->
                            <div
                                class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm transition hover:shadow-md">
                                <!-- 1. Candidate Info Header -->
                                <div class="flex items-center justify-between mb-4">
                                    <h5 class="font-bold text-gray-700 flex items-center">
                                        <span
                                            class="bg-indigo-100 text-indigo-600 rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2">1</span>
                                        候補者情報の入力
                                        <div class="group relative inline-block ml-2 align-middle">
                                            <i
                                                class="fas fa-question-circle text-gray-400 hover:text-indigo-500 cursor-help transition-colors"></i>
                                            <div
                                                class="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none z-50 leading-relaxed text-left font-normal">
                                                <div
                                                    class="absolute top-[-6px] left-1/2 transform -translate-x-1/2 w-3 h-3 bg-gray-800 rotate-45">
                                                </div>
                                                候補者の氏名やIDを入力します。これは履歴管理のために使用され、AIの解析結果には影響しません。
                                            </div>
                                        </div>
                                    </h5>
                                    <button onclick="openScoutSettingsModal()"
                                        class="text-xs text-indigo-600 hover:text-indigo-800 flex items-center transition-colors">
                                        <i class="fas fa-cog mr-1"></i>設定
                                        <div class="group relative inline-block ml-1 align-middle">
                                            <div
                                                class="absolute right-0 bottom-full mb-2 w-48 p-2 bg-gray-800 text-white text-xs rounded shadow opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-50 text-center font-normal">
                                                文体やスタイルをカスタマイズ
                                            </div>
                                        </div>
                                    </button>
                                </div>

                                <div class="mb-4">
                                    <label class="block text-xs font-bold text-gray-700 mb-1.5">
                                        候補者名 / 管理ID <span class="font-normal text-gray-400 ml-1">(任意)</span>
                                    </label>
                                    <input type="text" id="candidate-title-input"
                                        class="w-full border border-gray-200 bg-gray-50 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all"
                                        placeholder="例: BizReach 123456">
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-gray-700 mb-1.5 flex items-center">
                                        テキスト情報入力 <span class="font-normal text-gray-400 ml-1">(補足情報など)</span>
                                        <div class="group relative inline-block ml-2 align-middle">
                                            <i
                                                class="fas fa-question-circle text-gray-400 hover:text-indigo-500 cursor-help transition-colors"></i>
                                            <div
                                                class="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 w-72 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none z-50 leading-relaxed font-normal">
                                                <div
                                                    class="absolute top-[-6px] left-1/2 transform -translate-x-1/2 w-3 h-3 bg-gray-800 rotate-45">
                                                </div>
                                                職務経歴書のテキストを直接貼り付けるか、「年収〇〇万円以上希望」「フルリモート希望」などの補足条件を入力してください。AIがこれを考慮してマッチングします。
                                            </div>
                                        </div>
                                    </label>
                                    <textarea id="profile-text-input" rows="4"
                                        class="w-full border border-gray-200 bg-gray-50 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all resize-none"
                                        placeholder="候補者の経歴、スキル、希望条件などを入力..."></textarea>
                                </div>
                            </div>

                            <!-- STEP 2: File Upload -->
                            <div
                                class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm transition hover:shadow-md relative">
                                <div class="mb-3">
                                    <h5 class="font-bold text-gray-700 flex items-center">
                                        <span
                                            class="bg-indigo-100 text-indigo-600 rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2">2</span>
                                        資料アップロード
                                        <div class="group relative inline-block ml-2 align-middle">
                                            <i
                                                class="fas fa-question-circle text-gray-400 hover:text-indigo-500 cursor-help transition-colors"></i>
                                            <div
                                                class="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none z-50 leading-relaxed font-normal">
                                                <div
                                                    class="absolute top-[-6px] left-1/2 transform -translate-x-1/2 w-3 h-3 bg-gray-800 rotate-45">
                                                </div>
                                                履歴書・職務経歴書のPDFや画像をアップロードしてください。匿名公開されているプロフィールのスクリーンショットも解析可能です。
                                            </div>
                                        </div>
                                    </h5>
                                </div>

                                <div id="file-drop-area"
                                    class="border-2 border-dashed border-indigo-300 bg-indigo-50 rounded-xl p-8 text-center hover:bg-indigo-100 transition-colors cursor-pointer relative">

                                    <div class="mb-3 transform group-hover:scale-110 transition-transform duration-300">
                                        <div
                                            class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center mx-auto text-indigo-500">
                                            <i class="fas fa-cloud-upload-alt text-xl"></i>
                                        </div>
                                    </div>

                                    <p class="text-sm font-bold text-gray-700 mb-1">クリックまたはドラッグ</p>
                                    <p class="text-xs text-gray-500">PDF, 画像 (履歴書/職務経歴書)</p>
                                    <input type="file" id="profile-file-input" class="hidden"
                                        accept="image/*,application/pdf" multiple>
                                </div>
                                <div id="file-list" class="mt-3 space-y-1"></div>
                            </div>

                            <!-- Action -->
                            <div class="relative group">
                                <button id="analyze-profile-btn" onclick="analyzeProfile()"
                                    class="w-full bg-gradient-to-r from-indigo-600 to-violet-600 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:shadow-xl hover:from-indigo-700 hover:to-violet-700 transform hover:-translate-y-0.5 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                                    <i class="fas fa-magic mr-2"></i>AI解析を実行
                                </button>
                                <div
                                    class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-max px-3 py-1 bg-gray-800 text-white text-xs rounded shadow opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all pointer-events-none">
                                    約30〜60秒で解析が完了します
                                </div>
                            </div>

                            <div class="text-center">
                                <button onclick="resetProfileAnalysis()"
                                    class="text-xs text-gray-400 hover:text-gray-600 underline">
                                    入力内容をリセット
                                </button>
                            </div>

                            <!-- スカウト修正指示エリア (Hidden) -->
                            <div id="scout-instruction-container"
                                class="hidden mt-2 bg-yellow-50 p-4 rounded-xl border border-yellow-100">
                                <label class="block text-xs font-bold text-yellow-800 mb-2">
                                    <i class="fas fa-pen-fancy mr-1"></i>修正指示・再生成
                                </label>
                                <textarea id="scout-instruction-text" rows="3"
                                    class="w-full border border-yellow-200 bg-white rounded-lg px-3 py-2 text-sm focus:ring-yellow-500 mb-2"
                                    placeholder="例: 文面をもっとカジュアルに..."></textarea>
                                <button id="regenerate-scout-btn" onclick="regenerateScoutsWithInstruction()"
                                    class="w-full bg-white text-yellow-700 border border-yellow-300 py-2 rounded-lg font-bold text-sm hover:bg-yellow-50 transition">
                                    <i class="fas fa-sync-alt mr-2"></i>指示を反映して再生成
                                </button>
                            </div>
                        </div>

                        <!-- 右側: 解析結果エリア -->
                        <div
                            class="w-2/3 bg-gray-50/50 rounded-xl p-6 overflow-y-auto border border-gray-200/60 shadow-inner min-h-[500px] flex flex-col relative">
                            <div id="analysis-placeholder" class="text-center m-auto max-w-sm">
                                <div
                                    class="w-20 h-20 bg-white rounded-full shadow-md flex items-center justify-center mx-auto mb-6">
                                    <i class="fas fa-magic text-3xl text-indigo-500 animate-pulse-slow"></i>
                                </div>
                                <h4 class="text-lg font-bold text-gray-800 mb-2">AIスカウトを開始</h4>
                                <p class="text-sm text-gray-500 leading-relaxed mb-6">
                                    左側のフォームから履歴書・職務経歴書をアップロードしてください。<br>
                                    AIが経験・スキルを解析し、最適な求人提案とスカウト文面を自動生成します。
                                </p>
                                <div class="flex justify-center gap-4 text-xs text-gray-400">
                                    <span class="flex items-center"><i class="fas fa-check mr-1"></i>PDF対応</span>
                                    <span class="flex items-center"><i class="fas fa-check mr-1"></i>画像対応</span>
                                </div>
                            </div>

                            <div id="analysis-loading" class="hidden text-center py-20">
                                <div
                                    class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4">
                                </div>
                                <p class="text-indigo-600 font-bold">AIが画像を解析中...</p>
                                <p class="text-sm text-gray-500 mt-2">経歴の抽出と求人マッチングを行っています</p>
                            </div>

                            <div id="analysis-results" class="hidden space-y-6">
                                <!-- 候補者サマリー -->
                                <div class="bg-white p-4 rounded-lg shadow-sm border border-indigo-100">
                                    <h4 class="font-bold text-indigo-900 mb-2"><i
                                            class="fas fa-user-circle mr-2"></i>候補者プロフィール要約</h4>
                                    <p id="candidate-summary-text" class="text-gray-700 text-sm leading-relaxed"></p>
                                </div>

                                <h4 class="font-bold text-gray-900 border-b pb-2">提案求人 & スカウト文面</h4>
                                <div id="suggested-jobs-container" class="space-y-6">
                                    <!-- ここに結果が挿入される -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 解析履歴タブ -->
                    <div id="profile-history-tab-content" class="hidden flex-1 overflow-y-auto">
                        <div class="mb-4 flex justify-between items-center">
                            <h4 class="text-lg font-semibold text-gray-900">過去の解析履歴</h4>
                            <button onclick="loadProfileAnalysisHistory()"
                                class="text-sm text-indigo-600 hover:text-indigo-800">
                                <i class="fas fa-sync-alt mr-1"></i>更新
                            </button>
                        </div>
                        <div id="history-list" class="space-y-4">
                            <div class="text-center py-12 text-gray-500">
                                <i class="fas fa-history text-4xl mb-3"></i>
                                <p>履歴を読み込んでいます...</p>
                            </div>
                        </div>
                    </div>

                    <!-- スカウト管理タブ -->
                    <div id="profile-scout_management-tab-content" class="hidden flex-1 overflow-y-auto">
                        <div class="mb-4 flex justify-between items-center">
                            <h4 class="text-lg font-semibold text-gray-900">スカウト送信・返信状況</h4>
                            <button onclick="loadScoutManagement()"
                                class="text-sm text-indigo-600 hover:text-indigo-800">
                                <i class="fas fa-sync-alt mr-1"></i>更新
                            </button>
                        </div>
                        <div id="scout-management-list" class="space-y-4">
                            <div class="text-center py-12 text-gray-500">
                                <i class="fas fa-inbox text-4xl mb-3"></i>
                                <p>データを読み込んでいます...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Tab 4: Analytics -->
                    <div id="profile-analytics-tab-content" class="flex-1 overflow-y-auto hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 mt-4">
                            <!-- User Stats -->
                            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                                <h4 class="font-bold text-lg text-gray-900 mb-4 flex items-center">
                                    <i class="fas fa-user mr-2 text-indigo-600"></i>個人の成績
                                </h4>
                                <div id="analytics-user-stats" class="grid grid-cols-2 gap-4">
                                    <!-- Stats injected here -->
                                    <div class="text-center p-4 bg-gray-50 rounded">読み込み中...</div>
                                </div>
                            </div>

                            <!-- Organization Stats -->
                            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                                <h4 class="font-bold text-lg text-gray-900 mb-4 flex items-center">
                                    <i class="fas fa-building mr-2 text-indigo-600"></i>組織全体の成績
                                </h4>
                                <div id="analytics-org-stats" class="grid grid-cols-2 gap-4">
                                    <!-- Stats injected here -->
                                    <div class="text-center p-4 bg-gray-50 rounded">読み込み中...</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm mb-4">
                            <h4 class="font-bold text-lg text-gray-900 mb-4">ステータス詳細推移</h4>
                            <p class="text-sm text-gray-500 mb-4">※ 送信済みスカウトを母数とした各ステータスの内訳です。</p>
                            <div id="analytics-details-container">
                                <div class="text-center p-4 bg-gray-50 rounded">読み込み中...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 個別求人推薦モーダル -->
            <div id="recommend-job-modal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
                style="z-index: 10002;">
                <div class="bg-white rounded-lg w-full max-w-2xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-900">
                            <i class="fas fa-star text-yellow-500 mr-2"></i>求人を紹介
                        </h3>
                        <button onclick="closeRecommendJobModal()"
                            class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>

                    <div class="space-y-4">
                        <!-- 求人情報 -->
                        <div class="bg-gray-50 p-4 rounded border">
                            <p class="text-sm text-gray-600 mb-1">紹介する求人:</p>
                            <p id="recommend-job-title" class="font-bold text-gray-900"></p>
                        </div>

                        <!-- 紹介先 -->
                        <div class="bg-gray-50 p-4 rounded border">
                            <p class="text-sm text-gray-600 mb-1">紹介先:</p>
                            <p id="recommend-target-user" class="font-bold text-gray-900"></p>
                        </div>

                        <!-- おすすめ理由 -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-medium text-gray-700">おすすめ理由</label>
                                <div class="flex items-center gap-2">
                                    <select id="generate-reason-type"
                                        class="text-xs border border-gray-300 rounded px-2 py-1">
                                        <option value="reason">紹介理由</option>
                                        <option value="scout">スカウト文</option>
                                    </select>
                                    <button onclick="generateRecommendReason()"
                                        class="text-xs text-indigo-600 hover:text-indigo-800 flex items-center">
                                        <i class="fas fa-magic mr-1"></i>AIで生成
                                    </button>
                                </div>
                            </div>
                            <textarea id="recommend-reason" rows="6"
                                class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500"
                                placeholder="この求人をおすすめする理由を入力してください..."></textarea>
                        </div>

                        <!-- アクション -->
                        <div class="flex justify-end gap-3 pt-4 border-t">
                            <button onclick="closeRecommendJobModal()"
                                class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded">キャンセル</button>
                            <button onclick="submitRecommendation()"
                                class="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                                <i class="fas fa-check mr-2"></i>紹介する
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI詳細分析モーダル -->
            <div id="ai-detail-modal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
                style="z-index: 10010;">
                <div class="bg-white rounded-lg w-full max-w-2xl p-6 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-900">
                            <i class="fas fa-chart-bar text-indigo-600 mr-2"></i>AI詳細分析
                        </h3>
                        <button onclick="closeAIDetailModal()"
                            class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    <div id="ai-detail-modal-content">
                        <!-- Content will be injected here -->
                    </div>
                    <div class="mt-6 text-right">
                        <button onclick="closeAIDetailModal()"
                            class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                            閉じる
                        </button>
                    </div>
                </div>
            </div>

            <!-- 一括推薦モーダル -->
            <div id="bulk-recommend-modal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
                style="z-index: 10002;">
                <div class="bg-white rounded-lg w-full max-w-3xl p-6 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="bulk-recommend-modal-title" class="text-xl font-bold text-gray-900">
                            <i class="fas fa-star text-yellow-500 mr-2"></i>複数求人を一括紹介
                        </h3>
                        <button onclick="closeBulkRecommendModal()"
                            class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>

                    <div class="space-y-4">
                        <!-- 紹介先 -->
                        <div class="bg-gray-50 p-4 rounded border">
                            <p class="text-sm text-gray-600 mb-1">紹介先:</p>
                            <p id="bulk-recommend-target-user" class="font-bold text-gray-900"></p>
                        </div>

                        <!-- 選択した求人リスト -->
                        <div>
                            <p class="text-sm font-medium text-gray-700 mb-2">選択した求人 (<span
                                    id="bulk-job-count">0</span>件)</p>
                            <div id="bulk-jobs-list"
                                class="space-y-2 max-h-60 overflow-y-auto border rounded p-3 bg-gray-50">
                                <!-- 求人リストが表示される -->
                            </div>
                        </div>

                        <!-- アクション -->
                        <div class="flex justify-end gap-3 pt-4 border-t">
                            <button onclick="closeBulkRecommendModal()"
                                class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded">キャンセル</button>
                            <button onclick="submitBulkRecommendation()"
                                class="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                                <i class="fas fa-check mr-2"></i>AIマッチングする
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 求職者選択モーダル（個別紹介用） -->
            <div id="candidate-selection-modal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
                style="z-index: 10005;">
                <div class="bg-white rounded-lg w-full max-w-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-900">紹介先ユーザーを選択</h3>
                        <button onclick="closeCandidateSelectionModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="mb-4">
                        <div class="relative">
                            <input type="text" id="modal-candidate-search" placeholder="ユーザー名で絞り込み..."
                                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                        </div>
                    </div>
                    <div id="modal-candidate-list"
                        class="space-y-2 max-h-80 overflow-y-auto border rounded p-2 bg-gray-50">
                        <!-- ここに求職者リストが表示される -->
                    </div>
                    <div class="mt-6 text-right">
                        <button onclick="closeCandidateSelectionModal()"
                            class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded">閉じる</button>
                    </div>
                </div>
            </div>



            <!-- Super Admin: Master Data Page -->
            <div id="admin-master-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-xl font-semibold mb-2">マスタデータ管理</h2>
                            <p class="text-gray-600">システム全体の選択肢（雇用形態、職種など）を管理します</p>
                        </div>
                        <button onclick="showMasterForm()"
                            class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">
                            <i class="fas fa-plus mr-2"></i>新規作成
                        </button>
                        <button onclick="updateJobCategoriesMaster()"
                            class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 ml-2">
                            <i class="fas fa-sync mr-2"></i>職種マスタ初期化
                        </button>
                        <button onclick="updateIndustryCategoriesMaster()"
                            class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 ml-2">
                            <i class="fas fa-sync mr-2"></i>業種マスタ初期化
                        </button>
                        <button onclick="updateSelectionStatusMaster()"
                            class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 ml-2">
                            <i class="fas fa-sync mr-2"></i>進捗ステータス初期化
                        </button>
                        <button onclick="updatePromptMaster()"
                            class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 ml-2">
                            <i class="fas fa-sync mr-2"></i>プロンプト初期化
                        </button>
                    </div>
                    <div id="master-org-filter-container" class="mb-4 hidden">
                        <select id="master-filter-org" onchange="loadMasterData()"
                            class="w-full md:w-1/3 px-3 py-2 border rounded-lg text-sm bg-gray-50">
                            <option value="">全ての組織を表示</option>
                        </select>
                    </div>
                    <div class="border-b border-gray-200 mb-4">
                        <nav class="-mb-px flex space-x-8" id="master-tabs">
                            <button onclick="switchMasterTab('')"
                                class="master-tab border-indigo-500 text-indigo-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                全ての種別
                            </button>
                            <button onclick="switchMasterTab('employment_type')"
                                class="master-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                雇用形態
                            </button>
                            <button onclick="switchMasterTab('job_category')"
                                class="master-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                職種カテゴリ
                            </button>
                            <button onclick="switchMasterTab('industry_category')"
                                class="master-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                業種カテゴリ
                            </button>
                            <button onclick="switchMasterTab('selection_status')"
                                class="master-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                進捗ステータス
                            </button>
                        </nav>
                        <input type="hidden" id="master-filter-type" value="">
                    </div>
                </div>
                <div id="master-data-container"></div>
            </div>

            <!-- Admin: Job Management Page -->
            <div id="admin-jobs-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-600 mb-2">求人の作成・編集・削除ができます。</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="showJobCsvImportModal()"
                                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                                <i class="fas fa-file-csv mr-2"></i>CSVインポート
                            </button>
                            <button onclick="exportJobsCsv()"
                                class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                                <i class="fas fa-download mr-2"></i>CSVエクスポート
                            </button>
                            <button onclick="showJobForm()"
                                class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition font-medium">
                                <i class="fas fa-plus mr-2"></i>新規作成
                            </button>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 mb-6">
                    <input type="text" id="admin-job-search" placeholder="求人タイトル、会社名で検索..."
                        class="w-full px-4 py-2 border rounded-lg" onkeyup="filterAdminJobs()">
                </div>
                <div id="admin-jobs-container">
                    <!-- Jobs will be rendered here -->
                </div>
            </div>

            <!-- Admin: Applicant Management Page -->
            <div id="admin-applicants-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <p class="text-gray-600 mb-2">応募者のステータスを管理できます。</p>
                </div>
                <div class="bg-white rounded-lg shadow p-4 mb-6">
                    <input type="text" id="admin-applicant-search" placeholder="応募者名、求人名で検索..."
                        class="w-full px-4 py-2 border rounded-lg" onkeyup="filterAdminApplicants()">
                </div>
                <div id="admin-applicants-container">
                    <!-- Applicants will be rendered here -->
                </div>
            </div>


            <!-- Admin: Candidate Management Page -->
            <div id="admin-candidates-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6 flex justify-between items-center">
                    <div>
                        <p class="text-gray-600 mb-2">登録されている求職者の情報を管理できます。</p>
                    </div>
                    <button onclick="showUserRegistrationModal('candidate')"
                        class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                        <i class="fas fa-plus mr-2"></i>新規登録
                    </button>
                </div>
                <div class="bg-white rounded-lg shadow p-4 mb-6">
                    <input type="text" id="admin-candidate-search" placeholder="名前、メール、希望職種で検索..."
                        class="w-full px-4 py-2 border rounded-lg" onkeyup="filterAdminCandidates()">
                </div>
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    名前 / メール</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    希望条件</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ステータス</th>
                                <th
                                    class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    操作</th>
                            </tr>
                        </thead>
                        <tbody id="admin-candidates-container" class="bg-white divide-y divide-gray-200">
                            <!-- Candidates will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Admin: User Management Page -->
            <div id="admin-users-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6 flex justify-between items-center">
                    <div>
                        <p class="text-gray-600 mb-2">システム利用者のアカウントと権限を管理できます。</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="showUserCsvImportModal()"
                            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                            <i class="fas fa-file-csv mr-2"></i>CSVインポート
                        </button>
                        <button onclick="exportUsersCsv()"
                            class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                            <i class="fas fa-download mr-2"></i>CSVエクスポート
                        </button>
                        <button onclick="showUserRegistrationModal('admin')"
                            class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                            <i class="fas fa-plus mr-2"></i>新規登録
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 mb-6">
                    <input type="text" id="admin-user-search" placeholder="名前、メールで検索..."
                        class="w-full px-4 py-2 border rounded-lg" onkeyup="filterAdminUsers()">
                </div>
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    名前 / メール</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ロール</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    登録日</th>
                                <th
                                    class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    操作</th>
                            </tr>
                        </thead>
                        <tbody id="admin-users-container" class="bg-white divide-y divide-gray-200">
                            <!-- Users will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Admin: CSV Import Page -->
            <div id="admin-csv-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <!-- Title removed -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- 求人インポート -->
                        <div class="border rounded-lg p-6">
                            <h3 class="font-semibold mb-3 flex items-center">
                                <i class="fas fa-briefcase mr-2 text-indigo-600"></i>求人データ
                            </h3>
                            <input type="file" id="csv-jobs-file" accept=".csv" class="mb-3 w-full">
                            <button onclick="importJobsCSV()"
                                class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 w-full">
                                <i class="fas fa-upload mr-2"></i>インポート
                            </button>
                            <p class="text-xs text-gray-500 mt-2">
                                形式: title, company, location, employment_type, salary_min, salary_max, description
                            </p>
                        </div>

                        <!-- 求職者インポート -->
                        <div class="border rounded-lg p-6">
                            <h3 class="font-semibold mb-3 flex items-center">
                                <i class="fas fa-user-tie mr-2 text-green-600"></i>求職者データ
                            </h3>
                            <p class="text-sm text-gray-600 mb-4">
                                求職者情報をCSVファイルから一括登録できます。
                            </p>
                            <button onclick="openUserCsvImportModal()"
                                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 w-full">
                                <i class="fas fa-file-csv mr-2"></i>求職者CSVインポート
                            </button>
                            <p class="text-xs text-gray-500 mt-2">
                                ※ ロールは自動的に「求職者」に設定されます
                            </p>
                        </div>
                    </div>
                </div>

                <!-- インポート履歴 -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="font-semibold mb-4">インポート履歴</h3>
                    <div id="csv-history-container"></div>
                </div>
            </div>

            <!-- Admin: Audit Logs Page -->
            <div id="admin-logs-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <!-- Title removed -->
                    <div class="flex gap-4 mb-4">
                        <select id="log-filter-action" class="px-4 py-2 border rounded-lg">
                            <option value="">全てのアクション</option>
                            <option value="create">作成</option>
                            <option value="update">更新</option>
                            <option value="delete">削除</option>
                            <option value="login">ログイン</option>
                            <option value="csv_upload">CSVアップロード</option>
                        </select>
                        <button onclick="loadAuditLogs()"
                            class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">
                            <i class="fas fa-search mr-2"></i>検索
                        </button>
                    </div>
                </div>
                <div id="audit-logs-container"></div>
            </div>

            <!-- KPI Dashboard Content -->
            <div id="kpi-dashboard-content" class="app-content p-6 hidden">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 md:px-8 py-6">
                    <h1 class="text-2xl font-semibold text-gray-900">KPIダッシュボード</h1>
                    <p class="text-gray-500 text-sm mb-6">組織全体の進捗状況、歩留まり、売上予測を可視化します。</p>

                    <!-- Filter Bar -->
                    <div
                        class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-6 flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">期間</label>
                            <select id="kpi-filter-period" class="border border-gray-300 rounded px-3 py-1.5 text-sm">
                                <option value="this_month">今月</option>
                                <option value="last_month">先月</option>
                                <option value="this_quarter" selected>今四半期</option>
                                <option value="this_year">今年度</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">担当者</label>
                            <select id="kpi-filter-user"
                                class="border border-gray-300 rounded px-3 py-1.5 text-sm w-40">
                                <option value="">全員</option>
                            </select>
                        </div>
                        <div>
                            <button onclick="loadKPIDashboard()"
                                class="bg-indigo-600 text-white px-4 py-1.5 rounded text-sm font-bold hover:bg-indigo-700">
                                <i class="fas fa-sync-alt mr-1"></i>更新
                            </button>
                        </div>
                    </div>

                    <!-- KPI Cards (Feature B & D) -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white rounded-lg shadow-sm p-5 border border-gray-200">
                            <p class="text-xs font-bold text-gray-400 uppercase">売上予測 (ヨミ)</p>
                            <h3 class="text-2xl font-bold text-gray-800 mt-1" id="kpi-metric-revenue">¥0</h3>
                            <p class="text-xs text-green-600 mt-1"><i class="fas fa-arrow-up mr-1"></i>前月比 --%</p>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm p-5 border border-gray-200">
                            <p class="text-xs font-bold text-gray-400 uppercase">有効求人数</p>
                            <h3 class="text-2xl font-bold text-gray-800 mt-1" id="kpi-metric-jobs">0</h3>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm p-5 border border-gray-200">
                            <p class="text-xs font-bold text-gray-400 uppercase">選考中候補者</p>
                            <h3 class="text-2xl font-bold text-gray-800 mt-1" id="kpi-metric-candidates">0</h3>
                        </div>
                        <div class="bg-white rounded-lg shadow-sm p-5 border border-gray-200">
                            <p class="text-xs font-bold text-gray-400 uppercase">成約数</p>
                            <h3 class="text-2xl font-bold text-gray-800 mt-1" id="kpi-metric-success">0</h3>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <!-- Feature A: Funnel Analysis -->
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h4 class="font-bold text-gray-800 mb-4">選考歩留まり (ファネル)</h4>
                            <div class="relative h-64">
                                <canvas id="kpi-funnel-chart"></canvas>
                            </div>
                        </div>

                        <!-- Feature D: Activity Analysis -->
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h4 class="font-bold text-gray-800 mb-4">担当者別アクティビティ</h4>
                            <div class="relative h-64">
                                <canvas id="kpi-activity-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Feature C: Stagnant Cases -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                            <h4 class="font-bold text-gray-800"><i
                                    class="fas fa-exclamation-circle text-amber-500 mr-2"></i>停滞案件アラート (5日以上変動なし)</h4>
                            <span class="bg-amber-100 text-amber-800 text-xs font-bold px-2 py-1 rounded-full"
                                id="stagnant-cases-count">0件</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            候補者</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            求人</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            現在のフェーズ</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            最終更新日</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            担当者</th>
                                        <th
                                            class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            アクション</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="kpi-stagnant-table-body">
                                    <tr>
                                        <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">データ読み込み中...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin: Organization Settings Page -->
            <div id="admin-settings-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h3 class="text-xl font-bold mb-4">AIスカウト設定</h3>
                    <p class="text-gray-600 mb-6">AIスカウト機能の動作に関する設定を管理します。</p>

                    <div class="space-y-6">
                        <!-- 解析履歴の公開範囲設定 -->
                        <div class="border-b border-gray-200 pb-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-2">外部プロフィール解析履歴の公開範囲</h4>
                            <p class="text-sm text-gray-500 mb-4">
                                「外部プロフィール解析」で作成された履歴を、組織内の他のユーザーが閲覧できるかどうかを制御します。
                            </p>

                            <div class="bg-gray-50 p-4 rounded-lg">
                                <label class="flex items-start mb-3 cursor-pointer">
                                    <input type="radio" name="setting-history-visibility" value="all"
                                        class="mt-1 mr-3 h-4 w-4 text-indigo-600">
                                    <div>
                                        <div class="font-bold text-gray-900">全員に公開 (標準)</div>
                                        <div class="text-sm text-gray-600">
                                            組織内のすべてのユーザーが、他のユーザーが作成した解析履歴・求人提案内容を閲覧できます。共有知としての活用に適しています。</div>
                                    </div>
                                </label>

                                <label class="flex items-start cursor-pointer">
                                    <input type="radio" name="setting-history-visibility" value="personal"
                                        class="mt-1 mr-3 h-4 w-4 text-indigo-600">
                                    <div>
                                        <div class="font-bold text-gray-900">作成者のみ閲覧 (プライベート)</div>
                                        <div class="text-sm text-gray-600">
                                            ユーザーは自分が実行した解析履歴のみ閲覧できます。ただし、組織全体の集計数値などは表示される場合があります。</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- スカウト履歴の公開範囲設定 -->
                        <div class="border-b border-gray-200 pb-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-2">スカウト履歴の公開範囲</h4>
                            <p class="text-sm text-gray-500 mb-4">
                                「スカウト管理」で表示される候補者および送信履歴を、組織内の他のユーザーが閲覧できるかどうかを制御します。
                            </p>

                            <div class="bg-gray-50 p-4 rounded-lg">
                                <label class="flex items-start mb-3 cursor-pointer">
                                    <input type="radio" name="setting-scout-visibility" value="all"
                                        class="mt-1 mr-3 h-4 w-4 text-indigo-600">
                                    <div>
                                        <div class="font-bold text-gray-900">全員に公開 (標準)</div>
                                        <div class="text-sm text-gray-600">
                                            組織内のすべてのユーザーが、他のユーザーが送信したスカウト履歴・候補者ステータスを閲覧できます。重複スカウトの防止に適しています。</div>
                                    </div>
                                </label>

                                <label class="flex items-start cursor-pointer">
                                    <input type="radio" name="setting-scout-visibility" value="personal"
                                        class="mt-1 mr-3 h-4 w-4 text-indigo-600">
                                    <div>
                                        <div class="font-bold text-gray-900">作成者のみ閲覧 (プライベート)</div>
                                        <div class="text-sm text-gray-600">ユーザーは自分がスカウトを送った候補者およびその履歴のみ閲覧できます。</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- 保存ボタン -->
                        <div class="flex justify-end pt-4">
                            <button onclick="saveAdminSettings()"
                                class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition shadow-sm">
                                <i class="fas fa-save mr-2"></i>設定を保存
                            </button>
                        </div>
                    </div>
                </div>

                <!-- テンプレート管理 Page -->
                <div id="admin-templates-content" class="app-content p-6 hidden">
                    <div class="bg-white rounded-lg shadow p-6 mb-6">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-xl font-bold">推薦メール・メッセージテンプレート</h2>
                                <p class="text-gray-600 mt-1">候補者へ送る推薦メッセージの定型文を管理します。</p>
                            </div>
                            <button onclick="openEmailTemplateModal()"
                                class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition flex items-center gap-2">
                                <i class="fas fa-plus"></i> 新規作成
                            </button>
                        </div>

                        <div id="email-templates-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Templates will be rendered here -->
                            <div class="animate-pulse bg-gray-100 h-32 rounded-lg"></div>
                        </div>
                    </div>

                    <!-- メールテンプレート編集モーダル -->
                    <div id="email-template-modal"
                        class="fixed inset-0 bg-black bg-opacity-50 z-[110] hidden flex items-center justify-center p-4">
                        <div
                            class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                            <div class="p-6 border-b bg-indigo-50 flex justify-between items-center">
                                <h3 class="text-xl font-bold text-indigo-900" id="template-modal-title">テンプレート編集</h3>
                                <button onclick="closeEmailTemplateModal()" class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times text-2xl"></i>
                                </button>
                            </div>
                            <div class="flex-1 overflow-y-auto p-6 space-y-4">
                                <input type="hidden" id="template-id">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-1">テンプレート名</label>
                                    <input type="text" id="template-name"
                                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"
                                        placeholder="例: 標準推薦メール, LinkedIn用など">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-1">メール件名 (任意)</label>
                                    <input type="text" id="template-subject"
                                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"
                                        placeholder="候補者へ送信する際の標準件名">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-1">本文テンプレート</label>
                                    <div class="bg-blue-50 p-3 rounded text-xs text-blue-700 mb-2 leading-relaxed">
                                        <i class="fas fa-info-circle mr-1"></i>以下の変数を使用できます：<br>
                                        <code>{{userName}}</code>：候補者名、
                                        <code>{{agentName}}</code>：担当エージェント名、
                                        <code>{{jobDetails}}</code>：求人情報の詳細リスト（おすすめ理由含む）、
                                        <code>{{recommendationReason}}</code>：1件目のおすすめ理由
                                    </div>
                                    <textarea id="template-body" rows="12"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm font-mono focus:ring-2 focus:ring-indigo-500"></textarea>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="template-is-default"
                                        class="w-4 h-4 text-indigo-600 rounded">
                                    <label for="template-is-default"
                                        class="ml-2 text-sm text-gray-700">デフォルトに設定する</label>
                                </div>
                            </div>
                            <div class="p-6 border-t bg-gray-50 flex justify-end gap-3">
                                <button onclick="closeEmailTemplateModal()"
                                    class="px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition font-medium">
                                    キャンセル
                                </button>
                                <button onclick="saveEmailTemplate()"
                                    class="px-8 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold shadow-lg transition">
                                    保存する
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Super Admin: Prompt Settings Page -->
                <!-- Super Admin: Organization Management Page -->
                <div id="super-admin-organizations-content" class="app-content p-6 hidden">
                    <div class="bg-white rounded-lg shadow p-6 mb-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-600 mb-2">利用組織（テナント）の契約プランやステータスを管理します。</p>
                            </div>
                            <button onclick="showOrganizationModal()"
                                class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">
                                <i class="fas fa-plus mr-2"></i>新規組織作成
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        組織名
                                    </th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        プラン
                                    </th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        ステータス
                                    </th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        ユーザー数
                                    </th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        有効期限
                                    </th>
                                    <th
                                        class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        操作
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="super-admin-organizations-container" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
                                        データを読み込み中...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Admin: User Edit Modal -->
                <div id="admin-user-modal"
                    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
                    style="z-index: 30000;">
                    <div class="bg-white rounded-lg w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold" id="admin-user-modal-title">ユーザー編集</h3>
                            <button onclick="closeAdminUserModal()"
                                class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                        <form id="admin-user-form">
                            <!-- PDF Parsing Area -->
                            <div class="mb-6 p-4 bg-indigo-50 border border-dashed border-indigo-300 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="text-sm font-bold text-indigo-900 mb-1">
                                            <i class="fas fa-file-pdf mr-2"></i>履歴書/職務経歴書から自動入力
                                        </h4>
                                        <p class="text-xs text-indigo-700">
                                            PDFをアップロードすると、AIが氏名・スキル・経歴などを解析してフォームに入力します。
                                        </p>
                                    </div>
                                    <div>
                                        <label for="admin-user-pdf-upload"
                                            class="cursor-pointer bg-white text-indigo-600 border border-indigo-600 px-3 py-1.5 rounded text-sm font-medium hover:bg-indigo-50 transition shadow-sm">
                                            <i class="fas fa-upload mr-1"></i>PDFを選択
                                        </label>
                                        <input type="file" id="admin-user-pdf-upload" accept="application/pdf"
                                            class="hidden" onchange="handleAdminUserPdfUpload(this)">
                                    </div>
                                </div>
                            </div>

                            <input type="hidden" id="admin-user-id">

                            <!-- 基本情報 -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">名前 *</label>
                                <input type="text" id="admin-user-name" required
                                    class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ふりがな</label>
                                <input type="text" id="admin-user-furigana" class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">メールアドレス *</label>
                                <input type="email" id="admin-user-email" required
                                    class="w-full px-4 py-2 border rounded-lg">
                            </div>

                            <!-- パスワード変更（新規追加） -->
                            <div class="mt-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
                                <label class="block text-sm font-medium text-gray-700 mb-1">パスワードの変更</label>
                                <div class="flex gap-2">
                                    <input type="password" id="admin-user-new-password" placeholder="新しいパスワード"
                                        class="flex-1 px-4 py-2 border rounded-lg text-sm">
                                    <button type="button" onclick="updateUserPassword()"
                                        class="bg-gray-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-gray-700 transition shadow-sm whitespace-nowrap">
                                        パスワード更新
                                    </button>
                                </div>
                                <p class="text-[10px] text-gray-500 mt-1">※ パスワードを上書きします。空のまま「更新」をクリックしても変更されません。</p>
                            </div>

                            <!-- 権限（管理者のみ変更可） -->
                            <div id="admin-user-role-container">
                                <label class="block text-sm font-medium text-gray-700 mb-1">権限</label>
                                <select id="admin-user-role" class="w-full px-4 py-2 border rounded-lg">
                                    <option value="org_admin">組織管理者</option>
                                    <option value="admin">管理者</option>
                                    <option value="coach">CA・RA</option>
                                    <option value="candidate">求職者</option>
                                </select>
                            </div>

                            <!-- ステータス -->
                            <div class="grid grid-cols-2 gap-4 mt-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">利用ステータス</label>
                                    <select id="admin-user-status" class="w-full px-4 py-2 border rounded-lg">
                                        <option value="active">利用中</option>
                                        <option value="suspended">停止</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">管理ステータス</label>
                                    <select id="admin-user-management-status"
                                        class="w-full px-4 py-2 border rounded-lg">
                                        <option value="active">活動中</option>
                                        <option value="inactive">活動終了</option>
                                    </select>
                                </div>
                            </div>

                            <!-- 求職者用フィールド -->
                            <div id="admin-candidate-fields" class="hidden space-y-4 border-t pt-4 mt-4">
                                <h4 class="font-medium text-gray-900">求職者情報</h4>

                                <!-- 担当コーチ（管理者のみ変更可） -->
                                <div id="admin-user-coach-container">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">担当CA・RA</label>
                                    <select id="admin-user-coach" class="w-full px-4 py-2 border rounded-lg">
                                        <option value="">未設定</option>
                                        <!-- コーチ一覧をJSで挿入 -->
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">希望職種</label>
                                    <select id="admin-user-job-type" class="w-full px-4 py-2 border rounded-lg select2"
                                        multiple style="width: 100%">
                                        <!-- Options will be loaded dynamically -->
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">希望業界</label>
                                    <select id="admin-user-industry" class="w-full px-4 py-2 border rounded-lg select2"
                                        multiple style="width: 100%">
                                        <!-- Options will be loaded dynamically -->
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">希望勤務地</label>
                                    <div class="flex gap-2">
                                        <select id="admin-user-prefecture"
                                            class="w-1/3 px-2 py-2 border rounded-lg select2" multiple="multiple"
                                            style="width: 40%">
                                        </select>
                                        <input type="text" id="admin-user-city" placeholder="市区町村"
                                            class="w-2/3 px-4 py-2 border rounded-lg" style="width: 60%">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">希望雇用形態</label>
                                    <select id="admin-user-employment-type"
                                        class="w-full px-4 py-2 border rounded-lg select2" multiple style="width: 100%">
                                        <!-- Options will be loaded dynamically -->
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">希望年収 (万円)</label>
                                    <input type="number" id="admin-user-salary"
                                        class="w-full px-4 py-2 border rounded-lg" min="0">
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">生年月日</label>
                                        <input type="date" id="admin-user-birth-date"
                                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 transition-all"
                                            onchange="calculateAge(this.value, '#admin-user-age')">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">年齢</label>
                                        <input type="number" id="admin-user-age"
                                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 transition-all font-mono"
                                            min="0">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">性別</label>
                                        <select id="admin-user-gender" class="w-full px-4 py-2 border rounded-lg">
                                            <option value="">選択</option>
                                            <option value="男性">男性</option>
                                            <option value="女性">女性</option>
                                            <option value="その他">その他</option>
                                        </select>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">現住所（居住地）</label>
                                    <select id="admin-user-current-location" class="w-full px-4 py-2 border rounded-lg">
                                        <option value="">都道府県を選択</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">学歴</label>
                                    <textarea id="admin-user-education" rows="2"
                                        class="w-full px-4 py-2 border rounded-lg"
                                        placeholder="例: 〇〇大学 〇〇学部 卒業"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">スキル</label>
                                    <textarea id="admin-user-skills" rows="3"
                                        class="w-full px-4 py-2 border rounded-lg"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">職歴概要</label>
                                    <textarea id="admin-user-history" rows="3"
                                        class="w-full px-4 py-2 border rounded-lg"></textarea>
                                </div>

                                <!-- 追加詳細フィールド -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">電話番号</label>
                                    <input type="tel" id="admin-user-phone" class="w-full px-4 py-2 border rounded-lg">
                                </div>

                                <div class="flex gap-6 py-2">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="admin-user-job-exp-ok"
                                            class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 mr-2">
                                        <span class="text-sm text-gray-700">職種未経験OK</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="admin-user-industry-exp-ok"
                                            class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 mr-2">
                                        <span class="text-sm text-gray-700">業界未経験OK</span>
                                    </label>
                                </div>

                                <!-- 構造化された職歴 (New) -->
                                <div class="mb-6 border-t border-gray-200 pt-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="block text-sm font-medium text-gray-700">詳細職歴 (最大10社)</label>
                                        <button type="button" onclick="addWorkHistoryItem()"
                                            class="text-sm text-indigo-600 hover:text-indigo-800 flex items-center font-medium">
                                            <i class="fas fa-plus-circle mr-1"></i>職歴を追加
                                        </button>
                                    </div>
                                    <div id="work-history-list" class="space-y-4 mb-2">
                                        <!-- JSで動的に追加 -->
                                    </div>

                                    <div class="flex items-center gap-4 mt-2 mb-4">
                                        <label class="text-xs text-gray-500">過去転職回数 (自動計算):</label>
                                        <input type="number" id="admin-user-job-change-count"
                                            class="w-20 px-2 py-1 border rounded bg-gray-50 text-center text-sm"
                                            readonly>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">職務経歴書 (詳細テキスト)</label>
                                    <textarea id="admin-user-work-history-detail" rows="10"
                                        class="w-full px-4 py-2 border rounded-lg text-sm font-mono bg-gray-50 focus:bg-white transition"
                                        placeholder="職務経歴の詳細テキスト"></textarea>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">履歴情報</label>
                                    <textarea id="admin-user-history-info" rows="6"
                                        class="w-full px-4 py-2 border rounded-lg text-sm bg-gray-50 focus:bg-white transition"
                                        placeholder="履歴情報の補足など"></textarea>
                                </div>

                                <!-- 外部連携URL -->
                                <div class="border-t border-gray-200 pt-4 mt-4">
                                    <h5 class="text-sm font-bold text-gray-700 mb-3">外部連携URL</h5>
                                    <div class="grid grid-cols-1 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Google Drive
                                                URL</label>
                                            <input type="url" id="admin-user-drive-url"
                                                class="w-full px-4 py-2 border rounded-lg"
                                                placeholder="https://drive.google.com/...">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">NotebookLM
                                                URL</label>
                                            <input type="url" id="admin-user-notebooklm-url"
                                                class="w-full px-4 py-2 border rounded-lg"
                                                placeholder="https://notebooklm.google.com/...">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">LINE URL</label>
                                            <input type="url" id="admin-user-line-url"
                                                class="w-full px-4 py-2 border rounded-lg"
                                                placeholder="https://line.me/...">
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">社内マッチング情報</label>
                                    <textarea id="admin-user-resume-detail" rows="6"
                                        class="w-full px-4 py-2 border rounded-lg text-sm font-mono bg-gray-50 focus:bg-white transition"
                                        placeholder="社内マッチング情報（スキル、経験、希望の補足など）"></textarea>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">社内メモ・共有事項</label>
                                    <textarea id="admin-user-notes" rows="6"
                                        class="w-full px-4 py-2 border rounded-lg text-sm bg-gray-50 focus:bg-white transition"
                                        placeholder="社内メモ、面談記録、共有事項など"></textarea>
                                </div>
                            </div>

                            <div class="flex justify-end gap-3 pt-4 border-t">
                                <button type="button" onclick="closeAdminUserModal()"
                                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                    キャンセル
                                </button>
                                <button type="submit"
                                    class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                                    保存
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Admin: User CSV Import Modal -->
                <div id="admin-user-csv-modal"
                    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                    <div class="bg-white rounded-lg w-full max-w-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">求職者CSVインポート</h3>
                            <button onclick="closeUserCsvImportModal()"
                                class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <div class="bg-blue-50 p-4 rounded-lg text-sm text-blue-800">
                                <p class="font-bold mb-2">CSVフォーマットについて</p>
                                <p>以下のカラムを持つCSVファイルを作成してください：</p>
                                <ul class="list-disc list-inside ml-2 mt-1">
                                    <li>name (必須): 氏名</li>
                                    <li>email (組織設定により必須/任意): メールアドレス</li>
                                    <li>age (任意): 年齢</li>
                                    <li>desired_job_type (任意): 希望職種</li>
                                    <li>desired_location (任意): 希望勤務地</li>
                                    <li>desired_salary (任意): 希望年収（万円）</li>
                                    <li>skills (任意): スキル</li>
                                </ul>
                                <p class="mt-2 text-xs">※ ロールは自動的に「求職者」に設定されます</p>
                                <div class="mt-3">
                                    <a href="#" onclick="downloadCandidateCsvTemplate(event)"
                                        class="text-blue-600 hover:underline">
                                        <i class="fas fa-download mr-1"></i>テンプレートをダウンロード
                                    </a>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">CSVファイルを選択</label>
                                <input type="file" id="user-csv-file" accept=".csv"
                                    class="w-full border rounded-lg p-2">
                            </div>

                            <div id="user-csv-preview"
                                class="hidden max-h-40 overflow-y-auto border rounded p-2 text-xs">
                                <!-- プレビュー表示エリア -->
                            </div>

                            <div class="flex justify-end gap-3 pt-4 border-t">
                                <button onclick="closeUserCsvImportModal()"
                                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                    キャンセル
                                </button>
                                <button onclick="processUserCsvImport()"
                                    class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                                    インポート実行
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Admin: Job CSV Import Modal -->
                <div id="admin-job-csv-modal"
                    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                    <div class="bg-white rounded-lg w-full max-w-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">求人CSVインポート</h3>
                            <button onclick="closeJobCsvImportModal()"
                                class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <div class="bg-blue-50 p-4 rounded-lg text-sm text-blue-800">
                                <p class="font-bold mb-2">CSVフォーマットについて</p>
                                <p>以下のカラムを持つCSVファイルを作成してください：</p>
                                <ul class="list-disc list-inside ml-2 mt-1">
                                    <li>title (必須): 求人タイトル</li>
                                    <li>company (必須): 会社名</li>
                                    <li>salary_min (必須): 最低年収(数値)</li>
                                    <li>salary_max (必須): 最高年収(数値)</li>
                                    <li>location (必須): 勤務地</li>
                                    <li>description: 仕事内容</li>
                                </ul>
                                <div class="mt-3">
                                    <a href="#" onclick="downloadJobCsvTemplate(event)"
                                        class="text-blue-600 hover:underline">
                                        <i class="fas fa-download mr-1"></i>テンプレートをダウンロード
                                    </a>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">CSVファイルを選択</label>
                                <input type="file" id="job-csv-file" accept=".csv" class="w-full border rounded-lg p-2">
                            </div>

                            <div id="job-csv-preview"
                                class="hidden max-h-40 overflow-y-auto border rounded p-2 text-xs">
                                <!-- プレビュー表示エリア -->
                            </div>

                            <div class="flex justify-end gap-3 pt-4 border-t">
                                <button onclick="closeJobCsvImportModal()"
                                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                    キャンセル
                                </button>
                                <button onclick="processJobCsvImport()"
                                    class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                                    インポート実行
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Admin: Company CSV Import Modal -->
                <div id="admin-company-csv-modal"
                    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                    <div class="bg-white rounded-lg w-full max-w-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">企業CSVインポート</h3>
                            <button onclick="closeCompanyCsvImportModal()"
                                class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <div class="bg-blue-50 p-4 rounded-lg text-sm text-blue-800">
                                <p class="font-bold mb-2">CSVフォーマットについて</p>
                                <p>以下のカラムを持つCSVファイルを作成してください：</p>
                                <ul class="list-disc list-inside ml-2 mt-1">
                                    <li>name (必須): 企業名</li>
                                    <li>industry (任意): 業界</li>
                                    <li>location (任意): 所在地</li>
                                    <li>website (任意): WebサイトURL</li>
                                    <li>description (任意): 企業説明</li>
                                </ul>
                                <div class="mt-3">
                                    <a href="#" onclick="downloadCompanyCsvTemplate(event)"
                                        class="text-blue-600 hover:underline">
                                        <i class="fas fa-download mr-1"></i>テンプレートをダウンロード
                                    </a>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">CSVファイルを選択</label>
                                <input type="file" id="company-csv-file" accept=".csv"
                                    class="w-full border rounded-lg p-2">
                            </div>

                            <div id="company-csv-preview"
                                class="hidden max-h-40 overflow-y-auto border rounded p-2 text-xs">
                                <!-- プレビュー表示エリア -->
                            </div>

                            <div class="flex justify-end gap-3 pt-4 border-t">
                                <button onclick="closeCompanyCsvImportModal()"
                                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                    キャンセル
                                </button>
                                <button onclick="processCompanyCsvImport()"
                                    class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                                    インポート実行
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Coach: My Students Page -->
                <div id="coach-students-content" class="app-content p-6 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <!-- Title removed -->
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            ユーザー</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            登録日</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            進捗状況</th>
                                        <th
                                            class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            操作</th>
                                    </tr>
                                </thead>
                                <tbody id="coach-students-container" class="bg-white divide-y divide-gray-200">
                                    <!-- Users will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>


                <!-- 候補者プレビューモーダル -->
                <div id="candidate-preview-modal"
                    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
                    style="z-index: 30000;">
                    <div
                        class="bg-white rounded-2xl w-full max-w-7xl mx-4 h-[92vh] flex flex-col shadow-2xl overflow-hidden animate-fade-in">
                        <!-- ヘッダー (固定) -->
                        <div class="flex-none flex justify-between items-center px-8 py-5 border-b bg-white">
                            <div class="flex items-center gap-4">
                                <div id="candidate-avatar-header"
                                    class="w-12 h-12 bg-indigo-600 rounded-full flex items-center justify-center text-white text-xl font-bold shadow-inner">
                                    ?
                                </div>
                                <div>
                                    <h3 class="text-2xl font-bold text-gray-900 leading-tight flex items-center gap-3">
                                        <span id="candidate-detail-title">候補者詳細</span>
                                        <span id="candidate-header-meta"
                                            class="text-sm font-normal text-gray-500 bg-gray-100 px-3 py-1 rounded-full"></span>
                                    </h3>
                                    <p id="candidate-email-header" class="text-sm text-gray-500"></p>
                                </div>
                                <div id="candidate-status-badge-header" class="ml-4">
                                    <!-- Status badge will be injected here -->
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="showAdminUserModal($('#interview-candidate-id').val())"
                                    class="px-4 py-2 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 text-sm font-bold flex items-center transition-all">
                                    <i class="fas fa-edit mr-2 text-gray-400"></i>情報を編集
                                </button>
                                <button onclick="closeCandidatePreview()"
                                    class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-500 transition-all">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                        </div>

                        <!-- メインコンテンツ (集約画面) -->
                        <div class="flex-1 min-h-0 bg-gray-50 flex flex-col lg:flex-row overflow-hidden">

                            <!-- 左カラム: プロフィール詳細 (スクロール可) -->
                            <div id="candidate-preview-content"
                                class="w-full lg:w-[42%] h-full bg-white border-r overflow-y-scroll custom-scrollbar p-8 space-y-8 pb-32">
                                <!-- Profile details will be loaded here -->
                            </div>

                            <!-- 右カラム: 管理情報 (スクロール可) -->
                            <div
                                class="w-full lg:w-[58%] h-full bg-gray-50 overflow-y-scroll custom-scrollbar p-8 space-y-8 pb-32">
                                <!-- 選考進捗セクション -->
                                <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm">
                                    <div class="flex justify-between items-center mb-6">
                                        <h4 class="font-bold text-lg text-gray-900 flex items-center">
                                            <i
                                                class="fas fa-tasks mr-2 text-indigo-600 bg-indigo-50 p-2 rounded-lg"></i>
                                            エントリー中の案件 / 選考状況
                                        </h4>
                                    </div>
                                    <div id="selection-progress-container" class="space-y-4">
                                        <!-- Selection list will be rendered here -->
                                    </div>
                                </div>

                                <!-- 面談履歴セクション -->
                                <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm flex flex-col">
                                    <div class="flex justify-between items-center mb-6">
                                        <h4 class="font-bold text-lg text-gray-900 flex items-center">
                                            <i class="fas fa-comments mr-2 text-blue-600 bg-blue-50 p-2 rounded-lg"></i>
                                            面談履歴・対応メモ
                                        </h4>
                                        <button onclick="openInterviewRecordModal()"
                                            class="bg-indigo-600 text-white px-5 py-2.5 rounded-xl hover:bg-indigo-700 text-sm font-bold flex items-center transition-all shadow-md transform hover:-translate-y-0.5">
                                            <i class="fas fa-plus mr-2"></i>履歴を記録
                                        </button>
                                    </div>
                                    <div id="interview-list-container" class="space-y-4">
                                        <!-- Interviews will be rendered here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- 面談履歴記録モーダル -->
                <div id="interview-record-modal"
                    class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden"
                    style="z-index: 31000;">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 animate-fade-in-up">
                        <div class="flex justify-between items-center mb-6 border-b pb-4">
                            <h3 class="text-xl font-bold text-gray-900 flex items-center">
                                <i class="fas fa-clipboard-list text-indigo-600 mr-2"></i>面談履歴を保存
                            </h3>
                            <button onclick="closeInterviewRecordModal()"
                                class="text-gray-400 hover:text-gray-600 transition-colors">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                        <form id="interview-record-form" class="space-y-5">
                            <input type="hidden" id="interview-candidate-id">
                            <input type="hidden" id="interview-id">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-1">実施日</label>
                                    <input type="date" id="interview-date"
                                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 transition-all"
                                        required>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-1">面談種別</label>
                                    <select id="interview-type"
                                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 transition-all">
                                        <option value="初回面談">初回面談</option>
                                        <option value="フォロー面談">フォロー面談</option>
                                        <option value="カジュアル面談">カジュアル面談</option>
                                        <option value="模擬面接">模擬面接</option>
                                        <option value="電話連絡">電話連絡</option>
                                        <option value="その他">その他</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">内容・メモ</label>
                                <textarea id="interview-content" rows="8"
                                    class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 transition-all text-sm leading-relaxed"
                                    placeholder="話した内容、印象、懸念点などを入力してください" required></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">ネクストアクション</label>
                                <input type="text" id="interview-next-action"
                                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 transition-all text-sm"
                                    placeholder="例: 〇〇社の求人を案内する、来週月曜日に進捗確認など">
                            </div>
                            <div class="flex justify-end gap-3 pt-4 border-t">
                                <button type="button" onclick="closeInterviewRecordModal()"
                                    class="px-6 py-2 border rounded-lg hover:bg-gray-50 transition-all text-sm font-bold text-gray-600">
                                    キャンセル
                                </button>
                                <button type="submit"
                                    class="bg-indigo-600 text-white px-8 py-2 rounded-lg hover:bg-indigo-700 transition-all text-sm font-bold shadow-md transform hover:-translate-y-0.5">
                                    履歴を保存する
                                </button>
                            </div>
                        </form>
                    </div>
                </div>


            </div>
    </div>

    <!-- 求人選択モーダル -->
    <div id="job-selection-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
        style="z-index: 11000;">
        <div class="bg-white rounded-lg w-full max-w-2xl p-6 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-search-plus text-indigo-600 mr-2"></i>スカウト求人を選択
                </h3>
                <button onclick="closeJobSelectorForScout()"
                    class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-4 space-y-3">
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">企業名</label>
                    <input type="text" id="selector-search-company"
                        class="w-full border border-gray-300 rounded px-3 py-2 text-sm" placeholder="企業名で検索...">
                </div>
                <div class="flex gap-4">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-600 mb-1">勤務地（都道府県）</label>
                        <select id="selector-search-prefecture"
                            class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
                            <option value="">指定なし</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-600 mb-1">職務内容・職種</label>
                        <input type="text" id="selector-search-keyword"
                            class="w-full border border-gray-300 rounded px-3 py-2 text-sm" placeholder="キーワード...">
                    </div>
                </div>
                <div class="text-right">
                    <button onclick="searchJobsForScout()"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded shadow transition">
                        <i class="fas fa-search mr-2"></i>検索
                    </button>
                </div>
            </div>

            <div id="selector-job-results" class="flex-1 overflow-y-auto space-y-2 border-t pt-4">
                <div class="text-center py-8 text-gray-400">
                    検索条件を入力して検索してください
                </div>
            </div>
        </div>
    </div>

    <!-- 外部プロフィール解析モーダル -->
    <!-- Admin: AI Prompts -->
    <div id="admin-prompts-content" class="app-content p-2 hidden">
        <div class="max-w-full mx-auto">
            <div class="flex justify-between items-center mb-2 px-2">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">AIプロンプト設定</h2>
                </div>
                <button onclick="savePrompts()"
                    class="bg-indigo-600 text-white px-4 py-1.5 rounded hover:bg-indigo-700 shadow-sm transition-all flex items-center text-sm font-medium">
                    <i class="fas fa-save mr-1.5"></i>保存
                </button>
            </div>

            <!-- ① スコアリング -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 mb-3">
                <div class="mb-2 border-b border-gray-100 pb-2 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span
                            class="bg-indigo-50 text-indigo-700 px-2 py-0.5 rounded text-xs font-bold border border-indigo-100">分析</span>
                        <h3 class="text-base font-bold text-gray-800">マッチングスコアリング</h3>
                        <span class="text-xs text-gray-500">マッチング詳細分析・スコア算出用</span>
                    </div>
                </div>
                <textarea id="prompt-scoring"
                    class="w-full h-64 px-3 py-2 bg-gray-50 border border-gray-200 rounded font-mono text-xs text-gray-800 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all leading-relaxed resize-y"
                    placeholder="プロンプトを入力してください..."></textarea>
            </div>

            <!-- ② 紹介理由 -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 mb-3">
                <div class="mb-2 border-b border-gray-100 pb-2 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span
                            class="bg-green-50 text-green-700 px-2 py-0.5 rounded text-xs font-bold border border-green-100">生成</span>
                        <h3 class="text-base font-bold text-gray-800">紹介理由コメント</h3>
                        <span class="text-xs text-gray-500">求職者向け紹介理由（100文字程度）用</span>
                    </div>
                </div>
                <textarea id="prompt-reason"
                    class="w-full h-32 px-3 py-2 bg-gray-50 border border-gray-200 rounded font-mono text-xs text-gray-800 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all leading-relaxed resize-y"
                    placeholder="プロンプトを入力してください..."></textarea>
            </div>

            <!-- ③ 推薦文 -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 mb-3">
                <div class="mb-2 border-b border-gray-100 pb-2 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span
                            class="bg-blue-50 text-blue-700 px-2 py-0.5 rounded text-xs font-bold border border-blue-100">書類</span>
                        <h3 class="text-base font-bold text-gray-800">推薦文（紹介状）</h3>
                        <span class="text-xs text-gray-500">求職者への推薦文生成用</span>
                    </div>
                </div>
                <textarea id="prompt-recommendation-letter"
                    class="w-full h-48 px-3 py-2 bg-gray-50 border border-gray-200 rounded font-mono text-xs text-gray-800 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all leading-relaxed resize-y"
                    placeholder="プロンプトを入力してください..."></textarea>
            </div>

            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 mb-3">
                <div class="mb-2 border-b border-gray-100 pb-2 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span
                            class="bg-orange-50 text-orange-700 px-2 py-0.5 rounded text-xs font-bold border border-orange-100">送信</span>
                        <h3 class="text-base font-bold text-gray-800">スカウトメッセージ</h3>
                        <span class="text-xs text-gray-500">企業から求職者へのスカウト文生成用</span>
                    </div>
                </div>
                <textarea id="prompt-scout-message"
                    class="w-full h-48 px-3 py-2 bg-gray-50 border border-gray-200 rounded font-mono text-xs text-gray-800 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all leading-relaxed resize-y"
                    placeholder="プロンプトを入力してください..."></textarea>
            </div>

            <!-- ⑤ 求人解析 (System Prompt) -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 mb-3">
                <div class="mb-2 border-b border-gray-100 pb-2 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span
                            class="bg-purple-50 text-purple-700 px-2 py-0.5 rounded text-xs font-bold border border-purple-100">解析</span>
                        <h3 class="text-base font-bold text-gray-800">求人解析 (System)</h3>
                        <span class="text-xs text-gray-500">CSVインポート時の求人情報解析用</span>
                    </div>
                </div>
                <textarea id="prompt-job-description"
                    class="w-full h-64 px-3 py-2 bg-gray-50 border border-gray-200 rounded font-mono text-xs text-gray-800 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all leading-relaxed resize-y"
                    placeholder="解析ロジック（JSON定義など）..."></textarea>
            </div>

            <!-- ⑥ CSVマッピング (System Prompt) -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 mb-3">
                <div class="mb-2 border-b border-gray-100 pb-2 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span
                            class="bg-purple-50 text-purple-700 px-2 py-0.5 rounded text-xs font-bold border border-purple-100">解析</span>
                        <h3 class="text-base font-bold text-gray-800">CSVマッピング (System)</h3>
                        <span class="text-xs text-gray-500">CSVヘッダーの自動マップ用</span>
                    </div>
                </div>
                <textarea id="prompt-csv-mapping"
                    class="w-full h-48 px-3 py-2 bg-gray-50 border border-gray-200 rounded font-mono text-xs text-gray-800 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all leading-relaxed resize-y"
                    placeholder="マッピングロジック..."></textarea>
            </div>

            <!-- ⑦ 外部プロフィール解析 (System Prompt) -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 mb-3">
                <div class="mb-2 border-b border-gray-100 pb-2 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span
                            class="bg-purple-50 text-purple-700 px-2 py-0.5 rounded text-xs font-bold border border-purple-100">解析</span>
                        <h3 class="text-base font-bold text-gray-800">外部プロフィール解析 (System)</h3>
                        <span class="text-xs text-gray-500">PDF/画像アップロード時の解析用</span>
                    </div>
                </div>
                <textarea id="prompt-external-profile-analysis"
                    class="w-full h-80 px-3 py-2 bg-gray-50 border border-gray-200 rounded font-mono text-xs text-gray-800 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all leading-relaxed resize-y"
                    placeholder="解析プロンプト..."></textarea>
            </div>
        </div>
    </div>

    <!-- Admin: Company Management Page -->
    <div id="admin-companies-content" class="app-content p-6 hidden">
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">企業管理</h2>
                    <p class="text-gray-600 text-sm mt-1">登録されている企業の一覧と管理</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="showCompanyCsvImportModal()"
                        class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                        <i class="fas fa-file-csv mr-2"></i>CSVインポート
                    </button>
                    <button onclick="showCompanyForm()"
                        class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                        <i class="fas fa-plus mr-2"></i>新規企業登録
                    </button>
                </div>
            </div>
            <div class="mb-4">
                <input type="text" id="company-search" placeholder="企業名、業界、所在地で検索..."
                    class="w-full px-4 py-2 border rounded-lg" onkeyup="filterCompanies()">
            </div>
        </div>
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200" id="companies-table">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            企業名</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            業界</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            所在地</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Webサイト</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            操作</th>
                    </tr>
                </thead>
                <tbody id="companies-container" class="bg-white divide-y divide-gray-200">
                    <!-- Companies will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
    </main>
    </div>

    <!-- Company Form Modal -->
    <div id="company-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 id="company-modal-title" class="text-xl font-bold">企業登録</h2>
                <button onclick="closeCompanyModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <form id="company-form" onsubmit="handleCompanySubmit(event)">
                    <input type="hidden" id="company-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">会社名 <span
                                    class="text-red-500">*</span></label>
                            <input type="text" id="company-name" required class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">業界</label>
                            <select id="company-industry" class="w-full border rounded-lg px-3 py-2">
                                <option value="">選択してください</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">所在地</label>
                            <input type="text" id="company-location" class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">WebサイトURL</label>
                            <input type="url" id="company-website" class="w-full border rounded-lg px-3 py-2"
                                placeholder="https://...">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">会社概要</label>
                            <textarea id="company-description" rows="4"
                                class="w-full border rounded-lg px-3 py-2"></textarea>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="closeCompanyModal()"
                            class="px-4 py-2 border rounded-lg hover:bg-gray-50">キャンセル</button>
                        <button type="submit"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Master Data Modal -->
    <div id="master-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 id="master-modal-title" class="text-xl font-bold">マスタデータ作成</h2>
                <button onclick="closeMasterModal()"
                    class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="master-form" class="p-6 space-y-4">
                <input type="hidden" id="master-id">
                <input type="hidden" id="master-organization-id">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">種別 *</label>
                    <select id="master-type" required class="w-full px-4 py-2 border rounded-lg">
                        <option value="employment_type">雇用形態</option>
                        <option value="job_category">職種カテゴリ</option>
                        <option value="industry_category">業種カテゴリ</option>
                        <option value="selection_status">進捗ステータス</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">表示名 (Label) *</label>
                    <input type="text" id="master-label" required class="w-full px-4 py-2 border rounded-lg">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">保存値 (Value) *</label>
                    <input type="text" id="master-value" required class="w-full px-4 py-2 border rounded-lg">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">表示順</label>
                    <input type="number" id="master-sort" value="0" class="w-full px-4 py-2 border rounded-lg">
                </div>

                <div class="flex items-center gap-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="master-is-active" class="w-4 h-4 text-indigo-600 rounded" checked>
                        <span class="text-sm text-gray-700">有効にする</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer" id="master-is-global-container">
                        <input type="checkbox" id="master-is-global" class="w-4 h-4 text-indigo-600 rounded">
                        <span class="text-sm text-gray-700">グローバル設定</span>
                    </label>
                </div>

                <!-- AI自動補完オプション -->
                <div class="mb-6 bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                    <label class="flex items-start gap-3 cursor-pointer">
                        <input type="checkbox" id="csv-ai-augment" class="w-5 h-5 text-indigo-600 rounded mt-0.5">
                        <div>
                            <span class="font-bold text-gray-900">AIによる自動補完を行う</span>
                            <p class="text-xs text-gray-600 mt-1">
                                職種カテゴリ、業界カテゴリ、リモートワーク可否などの項目が空欄の場合、<br>
                                求人詳細などのテキスト情報からAIが自動的に推測して補完します。<br>
                                <span class="text-red-500">※処理に時間がかかる場合があります。</span>
                            </p>
                        </div>
                    </label>
                </div>

                <div class="flex justify-end gap-3 pt-4 border-t">
                    <button type="button" onclick="closeMasterModal()"
                        class="px-6 py-2 border rounded-lg hover:bg-gray-50">
                        キャンセル
                    </button>
                    <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">
                        保存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Progress Management Modal -->
    <div id="progress-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold">進捗管理</h2>
                <button onclick="closeProgressModal()"
                    class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="p-6">
                <input type="hidden" id="progress-application-id">

                <!-- Application Info -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="font-semibold text-lg mb-2" id="progress-job-title"></h3>
                    <p class="text-gray-600 text-sm" id="progress-company-name"></p>
                    <p class="text-gray-600 text-sm" id="progress-user-name"></p>
                </div>

                <!-- Status Update Form -->
                <div class="bg-white border rounded-lg p-4 mb-6">
                    <h4 class="font-semibold mb-3">ステータス更新</h4>
                    <form id="progress-update-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">現在のステータス</label>
                                <input type="text" id="progress-current-status" readonly
                                    class="w-full px-4 py-2 border rounded-lg bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">新しいステータス *</label>
                                <select id="progress-new-status" required class="w-full px-4 py-2 border rounded-lg">
                                    <option value="">選択してください</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">メモ・コメント</label>
                            <textarea id="progress-notes" rows="3" class="w-full px-4 py-2 border rounded-lg"
                                placeholder="ステータス変更の理由や詳細を記入してください"></textarea>
                        </div>
                        <div class="flex justify-end">
                            <button type="submit"
                                class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">
                                <i class="fas fa-save mr-2"></i>ステータスを更新
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Progress Timeline -->
                <div class="bg-white border rounded-lg p-4">
                    <h4 class="font-semibold mb-4">進捗履歴</h4>
                    <div id="progress-timeline" class="space-y-4">
                        <!-- Timeline will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Job Form Modal -->
    <div id="job-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 id="job-modal-title" class="text-xl font-bold">求人作成</h2>
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <input type="file" id="job-pdf-upload" accept=".pdf" multiple class="hidden"
                            onchange="handleJobPdfUpload(this)">
                        <button onclick="$('#job-pdf-upload').click()"
                            class="bg-green-600 text-white px-3 py-1.5 rounded hover:bg-green-700 text-xs flex items-center">
                            <i class="fas fa-file-pdf mr-1"></i>PDF読込
                        </button>
                    </div>
                    <button onclick="closeJobModal()"
                        class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
            </div>
            <form id="job-form" class="p-6 space-y-4">
                <input type="hidden" id="job-id">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">求人タイトル *</label>
                    <input type="text" id="job-title" required class="w-full px-4 py-2 border rounded-lg">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">会社名 *</label>
                    <div class="flex gap-2">
                        <select id="job-company-select"
                            class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                            onchange="handleCompanySelect(this.value)">
                            <option value="">企業を選択してください</option>
                            <option value="new">+ 新規企業を作成</option>
                        </select>
                        <input type="hidden" id="job-company-id">
                        <input type="hidden" id="job-company-name-hidden">
                        <!-- For backward compatibility or display -->
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">勤務地 *</label>
                        <input type="text" id="job-location" required class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">雇用形態 *</label>
                        <select id="job-employment-type" required class="w-full px-4 py-2 border rounded-lg">
                            <option value="正社員">正社員</option>
                            <option value="契約社員">契約社員</option>
                            <option value="派遣社員">派遣社員</option>
                            <option value="業務委託">業務委託</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">最低年収（万円）</label>
                        <input type="number" id="job-salary-min" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">最高年収（万円）</label>
                        <input type="number" id="job-salary-max" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">職種カテゴリ</label>
                        <select id="job-category" class="w-full px-4 py-2 border rounded-lg">
                            <option value="">選択してください</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">業界カテゴリ</label>
                        <select id="job-industry-category" class="w-full px-4 py-2 border rounded-lg">
                            <option value="">選択してください</option>
                        </select>
                    </div>
                </div>

                <div class="flex gap-6">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="job-experience-ok" class="w-4 h-4 text-indigo-600 rounded">
                        <span class="text-sm text-gray-700">職種未経験可</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="job-industry-experience-ok" class="w-4 h-4 text-indigo-600 rounded">
                        <span class="text-sm text-gray-700">業界未経験可</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="job-is-remote" class="w-4 h-4 text-indigo-600 rounded">
                        <span class="text-sm text-gray-700">リモートワーク可</span>
                    </label>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">勤務時間</label>
                        <input type="text" id="job-work-hours" placeholder="例: 9:00 - 18:00"
                            class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">休日休暇</label>
                        <input type="text" id="job-holidays" placeholder="例: 完全週休2日制（土日祝）"
                            class="w-full px-4 py-2 border rounded-lg">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">福利厚生</label>
                    <textarea id="job-benefits" rows="3" placeholder="例: 社会保険完備、交通費支給"
                        class="w-full px-4 py-2 border rounded-lg"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">選考フロー</label>
                    <textarea id="job-interview-process" rows="3" placeholder="例: 書類選考 → 一次面接 → 最終面接"
                        class="w-full px-4 py-2 border rounded-lg"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">求人URL</label>
                    <input type="url" id="job-url" placeholder="https://example.com/job/..."
                        class="w-full px-4 py-2 border rounded-lg">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">担当者1</label>
                        <select id="job-pic-user-1" class="w-full px-4 py-2 border rounded-lg">
                            <option value="">選択してください</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">担当者2</label>
                        <select id="job-pic-user-2" class="w-full px-4 py-2 border rounded-lg">
                            <option value="">選択してください</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">求人詳細 *</label>
                    <textarea id="job-description" required rows="6" placeholder="仕事内容、業務の詳細など"
                        class="w-full px-4 py-2 border rounded-lg"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">必須要件</label>
                    <textarea id="job-requirements" rows="4" placeholder="必須スキル、経験年数、資格など"
                        class="w-full px-4 py-2 border rounded-lg"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">尚可要件（歓迎スキル）</label>
                    <textarea id="job-welcome-requirements" rows="4" placeholder="あると望ましいスキル、経験など"
                        class="w-full px-4 py-2 border rounded-lg"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ステータス</label>
                    <select id="job-status" class="w-full px-4 py-2 border rounded-lg">
                        <option value="active">公開中</option>
                        <option value="draft">下書き</option>
                        <option value="closed">募集終了</option>
                    </select>
                </div>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeJobModal()"
                        class="px-6 py-2 border rounded-lg hover:bg-gray-50">
                        キャンセル
                    </button>
                    <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">
                        保存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Prompt Form Modal -->
    <div id="prompt-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 id="prompt-modal-title" class="text-xl font-bold">プロンプト編集</h2>
                <button onclick="closePromptModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="prompt-form" class="p-6 space-y-4">
                <input type="hidden" id="prompt-id">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">プロンプト名 *</label>
                    <input type="text" id="prompt-name" required class="w-full px-4 py-2 border rounded-lg"
                        placeholder="例: エンジニア向け推薦プロンプト">
                </div>

                <div class="flex items-center gap-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="prompt-is-active" class="w-4 h-4 text-indigo-600 rounded">
                        <span class="text-sm text-gray-700">有効にする</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="prompt-is-global" class="w-4 h-4 text-indigo-600 rounded">
                        <span class="text-sm text-gray-700">グローバル設定（全組織に適用）</span>
                    </label>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">プロンプトテンプレート *</label>
                    <p class="text-xs text-gray-500 mb-2">
                        利用可能な変数: {user_profile}, {jobs}<br>
                        ※JSON形式での出力を維持してください
                    </p>
                    <textarea id="prompt-template" required rows="15"
                        class="w-full px-4 py-2 border rounded-lg font-mono text-sm bg-gray-50"></textarea>
                </div>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closePromptModal()"
                        class="px-6 py-2 border rounded-lg hover:bg-gray-50">
                        キャンセル
                    </button>
                    <button type="submit" id="prompt-submit-btn"
                        class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">
                        保存
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- Job Smart Import Modal (Text/Image) -->



    <!-- CSV Mapping Modal -->
    <div id="csv-mapping-modal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-5xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">CSVインポート設定</h3>
                <button onclick="closeCSVMappingModal()" class="text-gray-400 hover:text-gray-500">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-2">CSVファイルの列とシステムの項目を対応付けてください。</p>

                <!-- 設定保存・読み込みエリア -->
                <div class="bg-gray-50 p-4 rounded-lg mb-4 border border-gray-200">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="flex-1">
                            <label
                                class="block text-xs font-bold text-gray-700 mb-1 uppercase tracking-wide">保存済み設定を適用</label>
                            <div class="flex gap-2">
                                <select id="saved-mapping-select" onchange="applySavedMapping(this.value)"
                                    class="flex-1 border-gray-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="">-- 設定を選択 --</option>
                                </select>
                                <button onclick="deleteSavedMapping()"
                                    class="px-2 py-1 text-red-500 hover:text-red-700 border border-transparent hover:border-red-200 rounded"
                                    title="選択した設定を削除">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex-1">
                            <label
                                class="block text-xs font-bold text-gray-700 mb-1 uppercase tracking-wide">現在の設定を保存</label>
                            <div class="flex gap-2">
                                <input type="text" id="new-mapping-name" placeholder="設定名を入力 (例: 求人サイトA)"
                                    class="flex-1 border-gray-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <button onclick="saveCurrentMapping()"
                                    class="px-3 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-100 text-sm font-medium shadow-sm">
                                    保存
                                </button>
                            </div>
                        </div>
                    </div>
                </div>



                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700">
                                最初の5行をプレビューとして表示しています。<br>
                                必須項目がマッピングされていない場合、インポートできません。
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-4 flex justify-end">
                <button onclick="autoMapWithAI()"
                    class="px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg hover:from-purple-700 hover:to-indigo-700 shadow-sm text-sm font-medium flex items-center transition-all duration-200 mr-2">
                    <i class="fas fa-magic mr-2"></i>AIで自動マッピング
                </button>
                <button onclick="previewAIAnalysis()"
                    class="px-4 py-2 bg-white border border-purple-200 text-purple-700 rounded-lg hover:bg-purple-50 shadow-sm text-sm font-medium flex items-center transition-all duration-200">
                    <i class="fas fa-eye mr-2"></i>1件目をAI解析プレビュー
                </button>
            </div>

            <!-- Upsert Mode Settings -->
            <div class="bg-indigo-50 p-4 rounded-lg mb-4 border border-indigo-200">
                <h4 class="text-sm font-bold text-indigo-900 mb-2">更新設定</h4>
                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="csv-upsert-mode" onchange="toggleUpsertKey()"
                            class="rounded text-indigo-600 focus:ring-indigo-500 mr-2">
                        <span class="text-sm text-gray-700">重複レコードを更新する（アップサート）</span>
                    </label>
                    <div id="csv-upsert-key-container" class="hidden flex items-center gap-2">
                        <span class="text-sm text-gray-600 font-medium">更新キー:</span>
                        <select id="csv-upsert-key"
                            class="text-sm border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 min-w-[150px]">
                            <!-- JSで動的に追加 -->
                        </select>
                    </div>
                </div>
                <p class="text-[10px] text-indigo-500 mt-2">
                    ※ 更新キーが一致する既存レコードがある場合、その情報を更新（上書き）します。一致しない場合は新規登録します。
                    <br>
                    ※ システム項目にマッピングした項目からのみキーを選択できます。
                </p>
            </div>

            <!-- Salary Unit Settings -->
            <div class="bg-blue-50 p-4 rounded-lg mb-6 border border-blue-200">
                <h4 class="text-sm font-bold text-blue-900 mb-2">年収データの単位設定</h4>
                <div class="flex flex-wrap gap-x-6 gap-y-2">
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="csv-salary-unit" value="auto" checked
                            class="text-blue-600 focus:ring-blue-500 mr-2">
                        <span class="text-sm text-gray-700">自動判定 (1万未満なら万円単位とみなす)</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="csv-salary-unit" value="man"
                            class="text-blue-600 focus:ring-blue-500 mr-2">
                        <span class="text-sm text-gray-700">常に万円単位 (例: 500)</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="csv-salary-unit" value="yen"
                            class="text-blue-600 focus:ring-blue-500 mr-2">
                        <span class="text-sm text-gray-700">常に円単位 (例: 5000000)</span>
                    </label>
                </div>
                <p class="text-[10px] text-blue-500 mt-2">
                    ※ インポート後のデータはシステム内で「●●万円」として統一して扱われます。
                </p>
            </div>

            <div class="overflow-x-auto mb-6">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                style="width: 20%;">
                                システム項目
                            </th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                style="width: 40%; min-width: 250px; resize: horizontal; overflow: auto;">
                                CSV列の選択
                            </th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                style="width: 40%;">
                                プレビュー (1行目)
                            </th>
                        </tr>
                    </thead>
                    <tbody id="csv-mapping-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Mapping rows will be inserted here -->
                    </tbody>
                </table>
            </div>

            <div class="flex justify-end gap-3">
                <button onclick="closeCSVMappingModal()"
                    class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                    キャンセル
                </button>
                <button onclick="executeCSVImport()"
                    class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow-md">
                    インポート実行
                </button>
            </div>
        </div>
    </div>

    <!-- User Registration Modal -->
    <div id="user-registration-modal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900" id="user-reg-title">新規ユーザー登録</h3>
                <button onclick="closeUserRegistrationModal()"
                    class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="user-registration-form" onsubmit="handleUserRegistration(event)">
                <input type="hidden" id="reg-role">

                <!-- Basic Info -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">名前 *</label>
                        <input type="text" id="reg-name" required class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ふりがな</label>
                        <input type="text" id="reg-furigana" placeholder="例: やまだ たろう"
                            class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">メールアドレス *</label>
                        <input type="email" id="reg-email" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">パスワード *</label>
                    <input type="password" id="reg-password" minlength="6" class="w-full px-4 py-2 border rounded-lg">
                </div>

                <!-- Role Selection (for User Management) -->
                <div id="reg-role-section" class="mb-4 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ロール *</label>
                    <select id="reg-role-select" class="w-full px-4 py-2 border rounded-lg">
                        <option value="admin">管理者</option>
                        <option value="coach">CA・RA</option>
                        <option value="candidate">求職者</option>
                    </select>
                </div>

                <!-- Candidate Specific Fields -->
                <div id="reg-candidate-fields" class="hidden border-t pt-4 mt-4">
                    <h4 class="text-md font-medium text-gray-900 mb-3">プロフィール情報</h4>

                    <!-- PDF Upload -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">履歴書/職務経歴書PDFから自動入力</label>
                        <div class="flex gap-2">
                            <input type="file" accept=".pdf" multiple class="hidden" id="reg-resume-upload"
                                onchange="handleRegResumeUpload(this)">
                            <button type="button" onclick="$('#reg-resume-upload').click()"
                                class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition">
                                <i class="fas fa-file-upload mr-2"></i>PDFを選択
                            </button>
                            <span id="reg-resume-filename" class="text-sm text-gray-500 flex items-center"></span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">希望職種</label>
                            <select id="reg-job-type" class="w-full px-4 py-2 border rounded-lg select2" multiple
                                style="width: 100%">
                                <!-- Options will be loaded dynamically -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">希望業界</label>
                            <select id="reg-industry" class="w-full px-4 py-2 border rounded-lg select2" multiple
                                style="width: 100%">
                                <!-- Options will be loaded dynamically -->
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">希望勤務地</label>
                            <div class="flex gap-2">
                                <select id="reg-prefecture" class="w-1/3 px-2 py-2 border rounded-lg select2" multiple
                                    style="width: 40%">
                                </select>
                                <input type="text" id="reg-city" placeholder="市区町村"
                                    class="w-2/3 px-4 py-2 border rounded-lg" style="width: 60%">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">希望雇用形態</label>
                                <select id="reg-employment-type" class="w-full px-4 py-2 border rounded-lg select2"
                                    multiple style="width: 100%">
                                    <!-- Options will be loaded dynamically -->
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">希望年収（万円）</label>
                                <input type="number" id="reg-salary" class="w-full px-4 py-2 border rounded-lg">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">スキル</label>
                            <textarea id="reg-skills" rows="3" class="w-full px-4 py-2 border rounded-lg"></textarea>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">職歴・自己PR</label>
                            <textarea id="reg-history" rows="4" class="w-full px-4 py-2 border rounded-lg"></textarea>
                        </div>

                        <!-- 構造化された職歴 -->
                        <div class="mb-4 border-t border-gray-200 pt-4">
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-medium text-gray-700">詳細職歴</label>
                                <button type="button" onclick="addRegWorkHistoryItem()"
                                    class="text-sm text-indigo-600 hover:text-indigo-800 flex items-center">
                                    <i class="fas fa-plus-circle mr-1"></i>追加
                                </button>
                            </div>
                            <div id="reg-work-history-list" class="space-y-4 mb-2"></div>
                            <div class="flex items-center gap-4 mt-2">
                                <label class="text-xs text-gray-500">過去転職回数:</label>
                                <input type="number" id="reg-job-change-count"
                                    class="w-20 px-2 py-1 border rounded bg-gray-50 text-center text-sm" readonly
                                    value="0">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">職務経歴書 (詳細テキスト)</label>
                            <textarea id="reg-work-history-detail" rows="10"
                                class="w-full px-4 py-2 border rounded-lg text-sm font-mono bg-gray-50 focus:bg-white transition"
                                placeholder="職務経歴の詳細テキスト"></textarea>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">社内マッチング情報</label>
                            <textarea id="reg-resume-detail" rows="6"
                                class="w-full px-4 py-2 border rounded-lg text-sm font-mono bg-gray-50 focus:bg-white transition"
                                placeholder="社内マッチング情報（スキル、経験、希望の補足など）"></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" onclick="closeUserRegistrationModal()"
                            class="px-4 py-2 border rounded-lg hover:bg-gray-50">キャンセル</button>
                        <button type="submit"
                            class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">登録</button>
                    </div>
            </form>
        </div>
    </div>

    <script type="module">
        // ========================
        // Supabase Configuration
        // ========================
        // 環境判定とSupabase設定
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.hostname === '';

        // 本番環境 (Production)
        const PROD_CONFIG = {
            url: 'https://npjsmoxxzlqkpopzjyyz.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5wanNtb3h4emxxa3BvcHpqeXl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzOTQ5MzYsImV4cCI6MjA3Njk3MDkzNn0.SInkweULu_GTr33JV7RCVtj4HBUfNFfK0_yrZghd38o' // (既存のキー)
        };

        // 開発環境 (Development)
        const DEV_CONFIG = {
            url: 'https://sgkhqtqdnyiliqpksiej.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNna2hxdHFkbnlpbGlxcGtzaWVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5NjU1MjIsImV4cCI6MjA4MDU0MTUyMn0.gx_E7OWW0mFwb4gCXh1NrU7pp0d-5vlL3PPSXUe-ZWE'
        };

        // 現在の環境に合わせて設定を選択
        // 現在の環境に合わせて設定を選択
        const config = isLocal ? DEV_CONFIG : PROD_CONFIG;

        // Supabaseクライアントの初期化
        const { createClient } = supabase
        const supabaseClient = createClient(config.url, config.key)

        // 開発環境の場合はコンソールに表示（わかりやすくするため）
        if (isLocal) {
            console.log('%c[Dev Mode] Connected to Development Supabase', 'color: #4f46e5; font-weight: bold; background: #e0e7ff; padding: 4px 8px; border-radius: 4px;');
        }

        // グローバルに公開
        window.supabase = supabaseClient

        // currentUserをグローバル変数として定義
        let currentUser = null;
        let isModalLoading = false;
        let isAImatchingResultView = false;
        let aiResultCache = {}; // userId_jobId -> details
        window.prefectures = [
            "北海道", "青森県", "岩手県", "宮城県", "秋田県", "山形県", "福島県",
            "茨城県", "栃木県", "群馬県", "埼玉県", "千葉県", "東京都", "神奈川県",
            "新潟県", "富山県", "石川県", "福井県", "山梨県", "長野県", "岐阜県",
            "静岡県", "愛知県", "三重県", "滋賀県", "京都府", "大阪府", "兵庫県",
            "奈良県", "和歌山県", "鳥取県", "島根県", "岡山県", "広島県", "山口県",
            "徳島県", "香川県", "愛媛県", "高知県", "福岡県", "佐賀県", "長崎県",
            "熊本県", "大分県", "宮崎県", "鹿児島県", "沖縄県"
        ];

        // AI推薦対象ユーザー関連
        let selectedTargetUserId = null;
        let selectedTargetUserName = null;
        let selectedTargetUserEmail = null;
        let allCandidateUsers = []; // 候補ユーザーリスト（管理者・コーチ用）
        let shouldReloadCandidates = false; // キャッシュ更新フラグ


        // ========================
        // Master Data Logic with Caching
        // ========================
        let masterIndustries = [];
        let masterJobCategories = [];
        let masterSelectionStatuses = [];

        // マスターデータキャッシュ
        const masterDataCache = {
            employmentTypes: null,
            industries: null,
            jobCategories: null,
            selectionStatuses: null,
            lastUpdated: null,
            cacheDuration: 30 * 60 * 1000, // 30分

            // キャッシュが有効かチェック
            isValid() {
                if (!this.lastUpdated) return false;
                const now = Date.now();
                return (now - this.lastUpdated) < this.cacheDuration;
            },

            // キャッシュをクリア
            clear() {
                this.employmentTypes = null;
                this.industries = null;
                this.jobCategories = null;
                this.selectionStatuses = null;
                this.lastUpdated = null;
                console.log('Master data cache cleared');
            },

            // キャッシュを更新
            update(data) {
                this.employmentTypes = data.employmentTypes;
                this.industries = data.industries;
                this.jobCategories = data.jobCategories;
                this.selectionStatuses = data.selectionStatuses;
                this.lastUpdated = Date.now();
                console.log('Master data cache updated');
            }
        };

        async function initMasterDataDropdowns() {
            if (!currentUser) {
                console.warn('initMasterDataDropdowns called but currentUser is null');
                return;
            }

            try {
                // キャッシュが有効な場合は再利用
                if (masterDataCache.isValid()) {
                    console.log('Using cached master data');
                    masterIndustries = masterDataCache.industries;
                    masterJobCategories = masterDataCache.jobCategories;
                    masterSelectionStatuses = masterDataCache.selectionStatuses;
                } else {
                    console.log('Fetching master data from database');

                    // master_data テーブルから業界と職種を取得
                    const { data: masters, error } = await supabase
                        .from('master_data')
                        .select('type, label, value, organization_id, sort_order') // 必要なカラムのみ取得
                        .in('type', ['industry_category', 'job_category', 'selection_status'])
                        .eq('is_active', true)
                        .order('sort_order');

                    if (error) throw error;

                    // フィルタリング（グローバル または 自社用）
                    const validMasters = masters.filter(m =>
                        m.organization_id === null || m.organization_id === currentUser.organization_id
                    );

                    // 業界マスタ
                    masterIndustries = [...new Set(validMasters
                        .filter(m => m.type === 'industry_category')
                        .map(m => m.label))];

                    // 職種マスタ
                    masterJobCategories = [...new Set(validMasters
                        .filter(m => m.type === 'job_category')
                        .map(m => m.label))];

                    // 進捗ステータスマスタ
                    masterSelectionStatuses = validMasters
                        .filter(m => m.type === 'selection_status');

                    // キャッシュを更新
                    masterDataCache.update({
                        industries: masterIndustries,
                        jobCategories: masterJobCategories,
                        selectionStatuses: masterSelectionStatuses
                    });
                }

                // 各プルダウンの初期化（検索画面など、常に表示されているもの）
                populateSelectOptions('search-industry-category', masterIndustries);
                populateSelectOptions('search-job-category', masterJobCategories);

                // プロフィール画面などのプルダウンも初期化（存在すれば）
                populateSelectOptions('profile-industry', masterIndustries);
                populateSelectOptions('profile-job-type', masterJobCategories);
                populateSelectOptions('company-industry', masterIndustries);
                populateSelectOptions('job-industry-category', masterIndustries);
                populateSelectOptions('job-category', masterJobCategories);

                // 管理者用モーダルのプルダウンも更新
                populateSelectOptions('admin-user-industry', masterIndustries);
                populateSelectOptions('admin-user-job-type', masterJobCategories);

                // Select2の適用・再適用（検索フォーム用）
                // closeOnSelect: false により、複数選択時に閉じなくする
                const searchSelects = $('#search-job-category, #search-industry-category, #search-employment-type, #search-prefecture');
                searchSelects.each(function () {
                    if ($(this).hasClass("select2-hidden-accessible")) {
                        $(this).select2('destroy');
                    }
                });
                searchSelects.select2({
                    closeOnSelect: false,
                    width: '100%',
                    allowClear: true,
                    placeholder: '選択してください'
                });

            } catch (error) {
                console.error('Error loading master data:', error);
            }
        }

        // 職種マスタ一括更新用関数
        window.updateJobCategoriesMaster = async function () {
            if (!currentUser || !currentUser.organization_id) {
                alert('組織情報が取得できませんでした。');
                return;
            }
            if (currentUser.role !== 'super_admin') {
                alert('この操作はスーパー管理者のみ可能です。');
                return;
            }
            if (!confirm('自組織の職種マスタを初期化して、新しいリストで更新しますか？\n既存の職種カテゴリは全て削除されます。')) return;

            const newJobCategories = [
                "その他営業系",
                "法人営業 (BtoB)",
                "個人営業 (BtoC)",
                "海外営業",
                "代理店営業",
                "MR (医薬情報担当者)",
                "営業企画・営業アシスタント",
                "その他企画・マーケティング系",
                "経営企画・事業企画",
                "商品企画・サービス企画",
                "マーケティング・販促",
                "広報・PR・IR",
                "Webマーケティング・デジタルマーケティング",
                "その他事務・管理系",
                "人事・労務",
                "経理・財務・会計",
                "法務・コンプライアンス",
                "総務",
                "秘書・受付",
                "一般事務・営業事務",
                "その他ITエンジニア系",
                "システムエンジニア (SE)",
                "プログラマー (PG)",
                "Webエンジニア（フロントエンド/バックエンド）",
                "インフラエンジニア（サーバー/ネットワーク）",
                "社内SE",
                "データサイエンティスト・アナリスト",
                "プロジェクトマネージャー (PM)",
                "ITコンサルタント",
                "品質管理・テストエンジニア",
                "その他クリエイティブ系",
                "Webデザイナー・UI/UXデザイナー",
                "グラフィックデザイナー",
                "Webディレクター・プロデューサー",
                "編集・ライター・コピーライター",
                "ゲームクリエイター（プランナー/デザイナー/シナリオライター）",
                "映像・音響クリエイター",
                "その他技術・製造系",
                "研究・開発 (R&D)",
                "設計・開発（機械/電気/電子）",
                "生産技術・製造技術",
                "品質管理・品質保証",
                "生産管理・工程管理",
                "購買・調達",
                "その他販売・サービス系",
                "販売・接客スタッフ",
                "店長・エリアマネージャー",
                "スーパーバイザー (SV)",
                "カスタマーサポート・コールセンター",
                "ホテル・旅行関連スタッフ",
                "飲食店スタッフ",
                "その他コンサルタント・専門職系",
                "戦略コンサルタント",
                "ITコンサルタント",
                "財務・会計コンサルタント",
                "人事コンサルタント",
                "金融専門職（アナリスト、ファンドマネージャー等）",
                "士業（弁護士、会計士、税理士、弁理士など）",
                "その他医療・福祉・教育系",
                "医師・看護師・薬剤師",
                "医療技術者（臨床検査技師など）",
                "介護福祉士・ケアマネージャー",
                "教師・講師・インストラクター",
                "キャリアアドバイザー",
                "キャリアコーディネーター",
                "人材系営業",
                "キャリアコーチ",
                "その他"
            ];

            try {
                // 1. 既存の職種カテゴリを削除 (自組織のみ対象)
                const { error: deleteError } = await supabase
                    .from('master_data')
                    .delete()
                    .eq('type', 'job_category')
                    .eq('organization_id', currentUser.organization_id);

                if (deleteError) throw deleteError;

                // 2. 新しい職種カテゴリを追加
                const insertData = newJobCategories.map((label, index) => ({
                    type: 'job_category',
                    label: label,
                    value: label,
                    sort_order: (index + 1) * 10,
                    is_active: true,
                    organization_id: currentUser.organization_id
                }));

                const { error: insertError } = await supabase
                    .from('master_data')
                    .insert(insertData);

                if (insertError) throw insertError;

                alert('職種マスタを更新しました。画面をリロードしてください。');
                location.reload();

            } catch (error) {
                console.error('Error updating job categories:', error);
                alert('エラーが発生しました: ' + error.message);
            }
        }

        // 進捗ステータスマスタ一括更新用関数
        window.updateSelectionStatusMaster = async function () {
            if (!currentUser || !currentUser.organization_id) {
                alert('組織情報が取得できませんでした。');
                return;
            }
            if (currentUser.role !== 'super_admin') {
                alert('この操作はスーパー管理者のみ可能です。');
                return;
            }
            if (!confirm('自組織の進捗ステータスマスタを初期化して、デフォルト値で更新しますか？\n既存のステータス設定は全て削除されます。')) return;

            // デフォルトのステータス定義
            const defaultStatuses = [
                { value: 'pending', label: '書類選考中', sort_order: 10 },
                { value: 'screening', label: '書類選考中(審査中)', sort_order: 20 },
                { value: 'interview', label: '面接予定', sort_order: 30 },
                { value: 'offered', label: '内定', sort_order: 40 },
                { value: 'rejected', label: '不合格', sort_order: 50 },
                { value: 'withdrawn', label: '辞退', sort_order: 60 }
            ];

            try {
                // 1. 既存のステータスを削除 (自組織のみ対象)
                const { error: deleteError } = await supabase
                    .from('master_data')
                    .delete()
                    .eq('type', 'selection_status')
                    .eq('organization_id', currentUser.organization_id);

                if (deleteError) throw deleteError;

                // 2. 新しいステータスを追加
                const insertData = defaultStatuses.map(status => ({
                    type: 'selection_status',
                    label: status.label,
                    value: status.value,
                    sort_order: status.sort_order,
                    is_active: true,
                    organization_id: currentUser.organization_id
                }));

                const { error: insertError } = await supabase
                    .from('master_data')
                    .insert(insertData);

                if (insertError) throw insertError;

                alert('進捗ステータスマスタを更新しました。画面をリロードしてください。');
                location.reload();

            } catch (error) {
                console.error('Error updating selection statuses:', error);
                alert('エラーが発生しました: ' + error.message);
            }
        }

        // プロンプトマスタ一括更新用関数
        window.updatePromptMaster = async function () {
            if (!currentUser || !currentUser.organization_id) {
                alert('組織情報が取得できませんでした。');
                return;
            }
            if (currentUser.role !== 'super_admin') {
                alert('この操作はスーパー管理者のみ可能です。');
                return;
            }
            if (!confirm('自組織のプロンプトマスタを初期化して、デフォルト値で更新しますか？\n既存のプロンプト設定は全て削除されます。')) return;

            // デフォルトのプロンプト定義（loadPromptsからコピー）
            const defaultScoring = `
あなたは温かみのある転職支援のプロフェッショナルであり、企業文化と人材のフィット分析の専門家です。
以下の求人と求職者情報から、マッチ度を分析し、**指定されたフォーマットのみ**で回答してください。
分析の詳細プロセス（「1.職務経歴のマッチ度」など）は一切出力せず、結果のみを記述してください。

【求職者情報】
- 基本情報: 年齢 \${userData.age} / 希望年収 \${userData.desired_salary}
- 希望条件: \${userData.desired_industry} / \${userData.desired_job_type} / \${userData.desired_location}
- 未経験OKの希望: 職種[\${userProfile.desired_job_experience_ok ? 'はい' : 'いいえ'}] / 業種[\${userProfile.desired_industry_experience_ok ? 'はい' : 'いいえ'}]
- スキル・PR・備考: \${userData.notes}
- 履歴書/経歴書: \${userData.resume}
- 職務経歴詳細: \${userData.work_history}
- 社内マッチング情報: \${userData.matching_info}
- 社内メモ・共有事項: \${userData.internal_info}
- その他補足: \${userData.other_info}

【求人情報】
- 企業名: \${jobDetails.company}
- 職種: \${jobDetails.title}
- 業種: \${jobDetails.industrycategory}
- 職種カテゴリ: \${jobDetails.jobcategory}
- 給与: \${jobDetails.salary}
- 勤務地: \${jobDetails.location}
- 雇用形態: \${jobDetails.employment_type}
- 業務内容: \${jobDetails.description}
- 必須スキル: \${jobDetails.qualifications}
- 企業文化・特徴: \${jobDetails.company_info}

【重要：企業文化の分析について】
・企業情報の不足や深い分析が必要な場合は、企業名（\${jobDetails.company}）に基づき、Web検索機能を活用して実際のクチコミや経営理念を補完してください。

---
【出力における絶対遵守の制約】
1. 分析の詳細プロセス（「1.職務経歴のマッチ度」などの区分けや説明）は絶対に書き出さないでください。
2. 指定されたラベル（「評価: 」「理由: 」等）以外で始まる文章を出力しないでください。
3. Markdown記号（#、*、**、> 等）は使用禁止です。
4. 各項目の文字数制限を1文字でも超えないでください。
5. 理由とアドバイスは改行せず、それぞれ1文（80文字以内/60文字以内）で記述してください。

回答形式：

評価: [ランクA-Eを1文字]
理由: [80文字以内で簡潔に。改行せず1文で記述]

総合評価: [数値]点

マッチする点
・[要点。30文字以内]
・[要点。30文字以内]

今後のさらなる成長・挑戦が期待される点
・[要点。30文字以内]
・[要点。30文字以内]

アドバイス
[60文字以内。改行せず1文で記述]
`;

            const defaultReason = `
あなたは温かみのあるキャリアアドバイザーです。
以下の求職者に対して、この求人を紹介する理由を300文字程度で作成してください。
求職者のこれまでの経験や強みを尊重し、それらが求人の特徴や企業の魅力とどのように結びつくかを、ポジティブかつ魅力的に伝えてください。

【求職者情報】
- 基本情報: 年齢 \${userData.age} / 希望年収 \${userData.desired_salary}
- 希望条件: \${userData.desired_industry} / \${userData.desired_job_type}
- スキル・PR: \${userData.notes}
- 履歴書/経歴書: \${userData.resume}
- 職務経歴詳細: \${userData.work_history}
- 社内マッチング情報: \${userData.matching_info}

【求人情報】
- 企業名: \${jobDetails.company}
- 職種: \${jobDetails.title}
- 魅力・業務内容: \${jobDetails.description}

構成:
1. 挨拶と紹介の意図
2. 求職者の強みと求人の接点
3. この求人に挑戦するメリット・成長可能性
4. 温かい応援メッセージ
`;

            const defaultRecommendationLetter = `
あなたは人材紹介会社のエージェントです。以下の求職者を企業に推薦するための推薦文を作成してください。
400-600文字程度で、以下の構成で作成してください。

【求職者情報】
- 氏名: \${userData.name}
- 年齢: \${userData.age}
- 現職: \${userData.current_position || 'N/A'}
- スキル・経験: \${userData.notes}
- アピールポイント: \${userData.self_pr || 'N/A'}

【応募先企業・求人】
- 企業名: \${jobDetails.company}
- 職種: \${jobDetails.title}

構成:
1. 冒頭の挨拶
2. 求職者の強みと実績
3. 求人とのマッチング理由
4. 推薦の結び
`;

            const defaultScoutMessage = `
あなたは企業の採用担当者です。以下の求職者に対して、魅力的なスカウトメッセージを作成してください。

【求職者情報】
- 氏名: \${candidateName}
- 現職: \${currentPosition}
- スキル・経験: \${skills}
- 希望条件: \${desiredConditions}

【自社・求人情報】
- 企業名: \${companyName}
- 職種: \${jobTitle}
- 業務内容: \${jobDescription}
- 魅力: \${companyStrengths}
- 待遇: \${benefits}

以下の構成で、300-500文字程度のスカウトメッセージを作成してください：

1. 求職者への敬意と関心の表明
2. 自社・求人の魅力
3. 求職者のスキルとのマッチング
4. 面談・応募への誘導
`;

            const prompts = [
                { key: 'ai_matching_scoring', label: defaultScoring.trim() },
                { key: 'ai_recommendation_reason', label: defaultReason.trim() },
                { key: 'recommendation_letter', label: defaultRecommendationLetter.trim() },
                { key: 'scout_message', label: defaultScoutMessage.trim() }
            ];

            try {
                // 1. 既存のシステムプロンプトを取得（あれば上書き）
                const { data: systemPrompts } = await supabase
                    .from('system_prompts')
                    .select('*')
                    .in('key', prompts.map(p => p.key));

                if (systemPrompts && systemPrompts.length > 0) {
                    systemPrompts.forEach(sp => {
                        const target = prompts.find(p => p.key === sp.key);
                        if (target) {
                            target.label = sp.content; // system_promptsの内容を優先
                        }
                    });
                }

                // 2. 既存のプロンプトマスタを削除 (自組織のみ対象)
                const { error: deleteError } = await supabase
                    .from('master_data')
                    .delete()
                    .eq('type', 'prompt')
                    .eq('organization_id', currentUser.organization_id);

                if (deleteError) throw deleteError;

                // 3. 新しいプロンプトを追加
                const insertData = prompts.map((p, index) => ({
                    type: 'prompt',
                    label: p.label, // プロンプト本文
                    value: p.key,   // プロンプトキー
                    sort_order: (index + 1) * 10,
                    is_active: true,
                    organization_id: currentUser.organization_id
                }));

                const { error: insertError } = await supabase
                    .from('master_data')
                    .insert(insertData);

                if (insertError) throw insertError;

                alert('プロンプトマスタを更新しました。画面をリロードしてください。');
                location.reload();

            } catch (error) {
                console.error('Error updating prompts:', error);
                alert('エラーが発生しました: ' + error.message);
            }
        }



        function populateSelectOptions(elementId, options, selectedValue = null) {
            const select = document.getElementById(elementId);
            if (!select) return;

            const currentVal = selectedValue || select.value;

            // 既存のオプション（最初の1つ目＝デフォルト選択肢など）を保持するか、
            // あるいは data-default-text 属性などで管理するか。
            // ここではシンプルに、最初のオプション（value=""のもの）だけ残して他を削除する
            const defaultOption = select.querySelector('option[value=""]');
            select.innerHTML = '';
            if (defaultOption) {
                select.appendChild(defaultOption);
            } else {
                // デフォルトがない場合は追加しておく
                const opt = document.createElement('option');
                opt.value = "";
                opt.text = "選択してください";
                select.appendChild(opt);
            }

            // マスタデータの追加
            options.forEach(optVal => {
                const opt = document.createElement('option');
                opt.value = optVal;
                opt.text = optVal;
                select.appendChild(opt);
            });

            // 選択値のセット
            if (currentVal) {
                // マスタにない値の場合、一時的に追加する
                if (!options.includes(currentVal)) {
                    const opt = document.createElement('option');
                    opt.value = currentVal;
                    opt.text = currentVal; // (未登録) などをつけてもいいが、そのまま表示
                    select.appendChild(opt);
                }
                select.value = currentVal;
            }
        }

        // Select2初期化管理
        const select2InitializedElements = new Set();

        function initializeSelect2(selector, options = {}) {
            const $element = $(selector);
            if ($element.length === 0) return;

            const elementId = $element.attr('id') || selector;

            // 既に初期化済みの場合はスキップ
            if (select2InitializedElements.has(elementId)) {
                return;
            }

            const defaultOptions = {
                language: "ja",
                width: 'resolve',
                ...options
            };

            $element.select2(defaultOptions);
            select2InitializedElements.add(elementId);
        }

        function destroySelect2(selector) {
            const $element = $(selector);
            if ($element.length === 0) return;

            const elementId = $element.attr('id') || selector;

            if (select2InitializedElements.has(elementId)) {
                $element.select2('destroy');
                select2InitializedElements.delete(elementId);
            }
        }

        function reinitializeSelect2(selector, options = {}) {
            destroySelect2(selector);
            initializeSelect2(selector, options);
        }

        function showLoading(message = '読み込み中...') {
            $('#loading-message').text(message);
            $('#loading-overlay').removeClass('hidden')
        }
        window.showLoading = showLoading;

        function hideLoading() {
            $('#loading-overlay').addClass('hidden')
        }
        window.hideLoading = hideLoading;

        function showError(elementId, message) {
            $(`#${elementId}`).text(message).removeClass('hidden')
        }

        function hideError(elementId) {
            $(`#${elementId}`).addClass('hidden')
        }

        // ========================
        // Lazy Loading Management
        // ========================
        const loadedPages = new Set();

        // 画像のLazy Loading
        function initImageLazyLoading() {
            // Intersection Observer を使用した画像の遅延読み込み
            if ('IntersectionObserver' in window) {
                const imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            const src = img.getAttribute('data-src');
                            if (src) {
                                img.src = src;
                                img.removeAttribute('data-src');
                                observer.unobserve(img);
                            }
                        }
                    });
                });

                // data-src属性を持つすべての画像を監視
                document.querySelectorAll('img[data-src]').forEach(img => {
                    imageObserver.observe(img);
                });
            } else {
                // Intersection Observer 非対応の場合は即座に読み込み
                document.querySelectorAll('img[data-src]').forEach(img => {
                    const src = img.getAttribute('data-src');
                    if (src) {
                        img.src = src;
                        img.removeAttribute('data-src');
                    }
                });
            }
        }

        function showPage(pageId) {
            $('.page').removeClass('active')
            $(`#${pageId}`).addClass('active')
        }

        async function showAppContent(contentId) {
            $('.app-content').addClass('hidden')
            const $target = $(`#${contentId}`);
            $target.removeClass('hidden')

            // 管理者系ページ（ヘッダー重複・余白対策が必要なページ）のリスト
            const adminPages = [
                'admin-prompts-content',
                'admin-jobs-content',
                'admin-companies-content',
                'admin-applicants-content',
                'admin-candidates-content',
                'admin-users-content',
                'admin-csv-content',
                'admin-log-content',
                'admin-master-content',
                'admin-settings-content',
                'admin-templates-content',
                'super-admin-organizations-content',
                'coach-students-content'
            ];

            // 管理者系ページの場合はヘッダーを隠し、要素を最上部に移動
            if (adminPages.includes(contentId)) {
                $('header').addClass('hidden');
                // 強制的にmain-contentの先頭に移動（見えない要素による余白排除）
                $('.main-content').prepend($target);
            } else {
                $('header').removeClass('hidden');
            }

            // ページ遷移時にフロートバーを非表示にし、余白をリセット
            $('#bulk-recommend-bar, #candidate-float-bar').addClass('hidden translate-y-full').removeClass('translate-y-0');
            $('#jobs-grid, #candidate-results-container').css('padding-bottom', '0');

            // 求人検索ページが表示された場合、保存された検索条件を適用
            if (contentId === 'jobs-content') {
                // loadSearchFilters関数が定義されているか確認（初期化前対策）
                // loadSearchFilters関数が定義されているか確認（初期化前対策）
                if (typeof loadSearchFilters === 'function' && typeof applySearchFilters === 'function') {
                    // マスタデータがロード済みの場合のみ適用（未ロードの場合はloadJobs内で適用される）
                    if (isSearchMasterLoaded) {
                        const savedFilters = loadSearchFilters();
                        if (savedFilters) {
                            console.log('Auto-applying saved filters for jobs page (Master loaded)');
                            applySearchFilters(savedFilters);
                        }
                    }
                }
                // 注意: ここでloadJobsを呼ぶと、ナビゲーションクリック時のloadJobsと重複して2回呼ばれる可能性があるため、
                // フィルタの適用（UIへのセット）のみを行う。
                // 実際の検索実行は呼び出し元（ナビゲーションクリックなど）に任せるか、
                // あるいはここでフラグをチェックして実行する。

                // しかし、ナビゲーションクリック以外（例: 戻る操作）で来た場合、loadJobsが呼ばれない可能性がある。
                // そのため、loadJobsがまだ呼ばれていない（リストが空など）場合に呼ぶのが安全だが、
                // 簡易的には、UIにセットするだけで、ユーザーが「検索」ボタンを押せばよい状態にするだけでも「条件保存」の要件は満たせる。
                // もし自動検索まで望むなら、呼び出し元を整理する必要がある。
            }

            // テンプレート管理ページが表示された場合
            if (contentId === 'admin-templates-content') {
                if (typeof loadEmailTemplates === 'function') {
                    loadEmailTemplates();
                }
            }

            // 遅延ロード: 初回アクセス時のみデータを読み込む
            if (!loadedPages.has(contentId)) {
                console.log(`Lazy loading data for: ${contentId}`);

                try {
                    switch (contentId) {
                        case 'recommendations-content':
                            // 推薦一覧は初回のみロード
                            if (typeof loadRecommendations === 'function') {
                                await loadRecommendations();
                            }
                            break;

                        case 'admin-users-content':
                            // ユーザー管理は初回のみロード
                            if (typeof loadUsers === 'function') {
                                await loadUsers();
                            }
                            break;

                        case 'admin-companies-content':
                            // 企業管理は初回のみロード
                            if (typeof loadCompanies === 'function') {
                                await loadCompanies();
                            }
                            break;

                        case 'coach-students-content':
                            if (typeof loadCoachStudents === 'function') {
                                await loadCoachStudents();
                            }
                            break;

                        // 他のページも必要に応じて追加
                    }

                    loadedPages.add(contentId);
                } catch (error) {
                    console.error(`Error lazy loading ${contentId}:`, error);
                }
            } else {
                console.log(`Using cached data for: ${contentId}`);
            }
        }

        // ========================
        // Audit Log Helper
        // ========================
        /**
         * 操作ログを記録する
         * @param {string} action - 操作の種類
         * @param {string} targetType - 対象のタイプ
         * @param {string} targetId - 対象のID
         * @param {object} details - 詳細情報
         * @param {object} user - 実行ユーザー（省略時はwindow.currentUserを使用）
         */
        async function logAuditAction(action, targetType, targetId, details = {}, user = null) {
            try {
                const actor = user || window.currentUser;

                if (!actor) {
                    console.warn('Cannot log action: user is null');
                    return;
                }

                const logEntry = {
                    user_id: actor.id,
                    organization_id: actor.organization_id,
                    action: action,
                    resource_type: targetType, // 正しいカラム名: resource_type
                    resource_id: targetId,     // 正しいカラム名: resource_id (推測)
                    // details: details,       // カラムが存在しないため除外
                    ip_address: null,
                    user_agent: navigator.userAgent,
                    created_at: new Date().toISOString()
                };

                // 非同期でログを記録
                const { error } = await supabase
                    .from('audit_logs')
                    .insert(logEntry);

                if (error) {
                    console.error('Audit log insert error:', error);
                }

            } catch (error) {
                console.error('Failed to log audit action:', error);
            }
        }

        // よく使う操作のショートカット関数
        const auditLog = {
            // ユーザー関連
            userCreated: (userId, details) => logAuditAction('create', 'user', userId, details),
            userUpdated: (userId, details) => logAuditAction('update', 'user', userId, details),
            userDeleted: (userId, details) => logAuditAction('delete', 'user', userId, details),

            // 求人関連
            jobCreated: (jobId, details) => logAuditAction('create', 'job', jobId, details),
            jobUpdated: (jobId, details) => logAuditAction('update', 'job', jobId, details),
            jobDeleted: (jobId, details) => logAuditAction('delete', 'job', jobId, details),

            // 応募関連
            applicationSubmitted: (applicationId, details) => logAuditAction('apply', 'application', applicationId, details),

            // AI推薦関連
            recommendationCreated: (recommendationId, details) => logAuditAction('recommend', 'recommendation', recommendationId, details),
            bulkRecommendationExecuted: (count, details) => logAuditAction('bulk_recommend', 'recommendation', null, { count, ...details }),

            // 認証関連（ユーザー情報を明示的に渡す）
            userLoggedIn: (user) => logAuditAction('login', 'auth', user?.id || 'unknown', { email: user?.email }, user),
            userLoggedOut: () => logAuditAction('logout', 'auth', window.currentUser?.id || 'unknown', { email: window.currentUser?.email }),

            // 企業関連
            companyCreated: (companyId, details) => logAuditAction('create', 'company', companyId, details),
            companyUpdated: (companyId, details) => logAuditAction('update', 'company', companyId, details),
            companyDeleted: (companyId, details) => logAuditAction('delete', 'company', companyId, details),

            // CSV関連
            csvImported: (type, count, details) => logAuditAction('csv_import', type, null, { count, ...details }),

            // プロンプト関連
            promptUpdated: (promptKey, details) => logAuditAction('update', 'prompt', promptKey, details)
        };


        // ========================
        // Authentication
        // ========================
        async function login(email, password) {
            showLoading()
            hideError('login-error')

            try {
                // Supabase Auth でログイン
                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                    email,
                    password
                })

                if (authError) throw authError

                const userId = authData.user.id;

                // ---------------------------------------------------------
                // 組織所属情報の確認 (Multi-tenant check)
                // ---------------------------------------------------------
                const { data: memberships, error: memError } = await supabase
                    .from('organization_members')
                    .select('organization_id, organizations(name, code, status)')
                    .eq('user_id', userId);

                console.log('Login Debug: User ID', userId);
                console.log('Login Debug: Memberships found', memberships);
                if (memError) console.error('Login Debug: Membership Error', memError);

                if (memError) {
                    console.error('Membership fetch error:', memError);
                    throw new Error('所属組織情報の取得に失敗しました');
                }

                if (!memberships || memberships.length === 0) {
                    // 所属がない場合 (通常ありえないが、不整合対策)
                    throw new Error('所属する組織が見つかりません');
                }

                // ユーザープロファイルを取得 (Base Profile)
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', userId)
                    .maybeSingle();

                if (userError || !userData) {
                    throw new Error('ユーザー情報の取得に失敗しました');
                }

                let targetOrgId = userData.organization_id; // Default to current setting
                let targetOrgName = '';

                // 複数組織に所属している場合、または現在の設定が無効な場合
                if (memberships.length > 1) {
                    // 選択モーダルを表示してユーザーに選ばせる
                    // ここで一旦処理を中断し、ユーザー入力を待つ必要があるため、Promiseでラップする実装にするか、
                    // あるいはシンプルなUI表示切り替えで実装する。
                    // ここでは「モーダルを表示し、選択されたら後続処理を実行する」関数に切り分けるのが適切だが、
                    // login関数内で完結させるため、一時的にUIを表示してコールバックを待つ形をとる。

                    hideLoading(); // ローディング一旦解除

                    // 組織選択ロジック (Promise wrapper)
                    const selectedOrg = await new Promise((resolve) => {
                        const modal = $('#org-select-modal');
                        const list = $('#org-select-list');
                        list.empty();

                        memberships.forEach(m => {
                            const org = m.organizations;
                            // 停止中の組織は除外するなど可能だが、一旦すべて表示
                            const btn = $(`
                                <button class="w-full text-left px-4 py-3 bg-indigo-50 hover:bg-indigo-100 border border-indigo-200 rounded-lg transition items-center flex justify-between group">
                                    <div>
                                        <div class="font-bold text-indigo-900">${org.name}</div>
                                        <div class="text-xs text-indigo-500">${org.code || ''}</div>
                                    </div>
                                    <i class="fas fa-chevron-right text-indigo-300 group-hover:text-indigo-600"></i>
                                </button>
                            `);
                            btn.on('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                modal.addClass('hidden');
                                resolve({ id: m.organization_id, name: org.name });
                            });

                            list.append(btn);
                        });

                        modal.removeClass('hidden');
                    });

                    showLoading('ログイン処理中...'); // ローディング再開
                    targetOrgId = selectedOrg.id;
                    targetOrgName = selectedOrg.name;

                    // ユーザーのデフォルト組織を更新しておく（次回ログイン時の優先候補として）
                    // ※ RLSエラーになる可能性があるため、失敗しても無視する
                    await supabase.from('users').update({ organization_id: targetOrgId }).eq('id', userId);

                } else {
                    // 1つだけの場合、それを確定
                    targetOrgId = memberships[0].organization_id;
                    // targetOrgName = memberships[0].organizations.name; // selectの構造による
                }

                // currentUserオブジェクトを構築
                // userDataには古い organization_id が入っている可能性があるため上書き
                currentUser = {
                    ...userData,
                    organization_id: targetOrgId,
                    organizations: { // 擬似的に結合情報を更新
                        name: targetOrgName || memberships.find(m => m.organization_id === targetOrgId)?.organizations?.name
                    }
                };
                window.currentUser = currentUser;

                // ステータスチェック (利用停止中の場合はログアウト)
                if (userData.status === 'suspended') {
                    await supabase.auth.signOut();
                    currentUser = null;
                    window.currentUser = null;
                    throw new Error('このアカウントは利用が停止されています。管理者にお問い合わせください。');
                }

                // ログイン履歴を記録
                await supabase
                    .from('login_history')
                    .insert({
                        organization_id: currentUser.organization_id,
                        user_id: currentUser.id,
                        name: currentUser.name,
                        email: currentUser.email,
                        user_agent: navigator.userAgent
                    })

                // 管理者メニューの表示制御
                if (userData.role === 'org_admin' || userData.role === 'admin' || userData.role === 'super_admin') {
                    $('#admin-menu').removeClass('hidden')
                } else {
                    $('#admin-menu').addClass('hidden')
                }

                // スーパー管理者メニューの表示制御
                if (userData.role === 'super_admin') {
                    $('#super-admin-menu').removeClass('hidden')
                } else {
                    $('#super-admin-menu').addClass('hidden')
                }

                // コーチメニューの表示制御
                if (userData.role === 'coach') {
                    $('#coach-menu').removeClass('hidden')
                } else {
                    $('#coach-menu').addClass('hidden')
                }

                // 外部プロフィール解析メニューの表示制御
                if (['org_admin', 'admin', 'super_admin', 'coach'].includes(userData.role)) {
                    $('#ai-scout-link').removeClass('hidden')
                } else {
                    $('#ai-scout-link').addClass('hidden')
                }

                // サイドバーのユーザー情報を更新
                $('#user-name').text(currentUser.name)
                $('#user-role').text(getRoleLabel(currentUser.role))
                $('#org-name').text(currentUser.organizations?.name || '')
                $('#org-code-display').text(currentUser.organizations?.code ? `コード: ${currentUser.organizations.code}` : '')

                // ダッシュボードメニューの表示制御（求職者は非表示）
                if (userData.role === 'candidate') {
                    $('#nav-dashboard').addClass('hidden')
                } else {
                    $('#nav-dashboard').removeClass('hidden')
                }

                // ログイン後の初期画面を設定
                if (userData.role === 'candidate') {
                    // 求職者の場合は求人検索画面を表示
                    await loadJobs()
                    showAppContent('jobs-content')
                    $('.nav-link[data-page="jobs"]').addClass('bg-indigo-50 text-indigo-600')
                } else {
                    // その他のユーザーはダッシュボードを表示
                    await loadDashboard()
                    $('.nav-link[data-page="dashboard"]').addClass('bg-indigo-50 text-indigo-600')
                }

                loadNotifications()
                showPage('app-page')

                // ログイン操作を記録（ユーザーデータを渡す）
                await auditLog.userLoggedIn(currentUser);



            } catch (error) {
                console.error('Login error:', error)
                showError('login-error', error.message || 'ログインに失敗しました')
            } finally {
                hideLoading()
            }
        }

        async function signup(name, furigana, email, password, invitationToken, orgCode) {
            showLoading()
            hideError('signup-error')

            try {
                let organizationId = null;
                let role = 'candidate'; // Default role for public signup is Candidate
                let invitationId = null;

                // 1. 招待トークンがある場合の検証
                if (invitationToken) {
                    const { data: invitation, error: invError } = await supabase
                        .rpc('get_invitation_by_token', { token_input: invitationToken })
                        .single()

                    if (invError || !invitation) {
                        throw new Error('無効な招待リンクです')
                    }
                    if (new Date(invitation.expires_at) < new Date()) {
                        throw new Error('招待リンクの有効期限が切れています')
                    }
                    if (invitation.accepted_at) {
                        throw new Error('この招待リンクは既に使用されています')
                    }
                    organizationId = invitation.organization_id;
                    role = invitation.role;
                    invitationId = invitation.id;
                }
                // 2. 組織コードがある場合の検証
                else if (orgCode) {
                    const { data: orgData, error: orgError } = await supabase
                        .rpc('get_organization_name_by_code', { org_code: orgCode })

                    if (orgError || !orgData || orgData.length === 0) {
                        throw new Error('無効な組織コードです');
                    }
                    organizationId = orgData[0].id;
                    // role はデフォルトで 'user'
                } else {
                    throw new Error('招待リンクまたは組織コードが必要です');
                }

                console.log('Attempting signup with:', { email, name, organizationId, role })

                // 3. Supabase Authでサインアップ
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            name: name,
                            // メタデータとして保存しておくが、実際の所属はusers/organization_membersテーブルで管理
                            organization_id: organizationId
                        }
                    }
                });

                if (authError) throw authError;

                if (authData.user) {
                    console.log('Auth user created:', authData.user.id);

                    // 4. Usersテーブルにレコード作成
                    // NOTE: RLSにより、自分自身のIDでのみINSERT可能
                    const { error: insertError } = await supabase
                        .from('users')
                        .insert({
                            id: authData.user.id,
                            email: email,
                            name: name,
                            furigana: furigana,
                            role: role,
                            organization_id: organizationId, // レガシー互換
                            is_active: true
                        });

                    if (insertError) {
                        // 既にユーザーレコードが存在する場合（メールアドレス重複など）
                        if (insertError.code === '23505') {
                            console.log('User already exists in DB. Resolving ID and linking to this org...');

                            const { data: finalUserId, error: rpcError } = await supabase
                                .rpc('get_user_id_by_email', { target_email: email });

                            if (rpcError || !finalUserId) {
                                console.error('Failed to resolve existing user via RPC:', rpcError);
                                throw new Error('既存のアカウント情報を取得できませんでした。');
                            }

                            console.log('Target User ID resolved:', finalUserId);

                            const { error: memberError } = await supabase
                                .from('organization_members')
                                .insert({
                                    organization_id: organizationId,
                                    user_id: finalUserId,
                                    role: role
                                });

                            if (memberError) {
                                if (memberError.code === '23505') {
                                    console.log('User is already a member of this organization.');
                                } else {
                                    console.error('Failed to add existing user to members:', memberError);
                                    throw new Error('組織への加入に失敗しました: ' + memberError.message);
                                }
                            } else {
                                console.log('Successfully added existing user to organization_members.');
                            }
                        } else {
                            console.error('Unexpected DB insert error:', insertError);
                            throw new Error('ユーザー情報の保存中にエラーが発生しました: ' + insertError.message);
                        }
                    }
                    else {
                        // 新しくユーザーレコードが作成された場合、トリガーが自動的に members に入れるか、
                        // または手動で（トリガーがない環境の場合）追加を確認
                        console.log('New user record created successfully.');
                    }

                    // 5. 招待コードを使用した場合は使用済みに更新
                    if (invitationId) {
                        await supabase
                            .from('invitations')
                            .update({ accepted_at: new Date().toISOString() })
                            .eq('id', invitationId);
                    }

                    alert('登録が完了しました。ログインしてください。');
                    showPage('login-page');
                } else {
                    // メール確認待ち等のケース
                    alert('確認メールが送信されました。メール内のリンクをクリックして登録を完了してください。');
                }
            } catch (error) {

                console.error('Signup error:', error)
                showError('signup-error', error.message || '登録に失敗しました')
            } finally {
                hideLoading()
            }
        }


        async function logout() {
            showLoading()
            try {
                // ログアウト操作を記録
                await auditLog.userLoggedOut();

                await supabase.auth.signOut()
                currentUser = null
                window.currentUser = null;
                showPage('login-page')
            } catch (error) {
                console.error('Logout error:', error)
                alert('ログアウトに失敗しました')
            } finally {
                hideLoading()
            }
        }

        // ========================
        // Jobs & Applications
        // ========================
        // ターゲットユーザーのキャッシュ
        let targetUsersCache = []
        // 選択された求人IDを保持するSet
        const selectedJobIds = new Set()
        // マスタデータロード済みフラグ
        let isSearchMasterLoaded = false
        // お気に入り求人ID
        let favoriteJobIds = new Set()
        // 保存された検索条件
        let savedSearches = []

        async function loadMasterDataForSearch() {
            if (isSearchMasterLoaded) return;
            if (!currentUser || !currentUser.organization_id) {
                console.warn('loadMasterDataForSearch: currentUser or organization_id is missing');
                return;
            }

            try {
                console.log('Loading master data for search...');

                // 都道府県
                const prefSelect = $('#search-prefecture');
                if (prefSelect.hasClass("select2-hidden-accessible")) {
                    prefSelect.select2('destroy');
                }
                prefSelect.empty();
                window.prefectures.forEach(pref => {
                    prefSelect.append(`<option value="${pref}">${pref}</option>`);
                });
                prefSelect.select2({
                    placeholder: "勤務地（都道府県）",
                    allowClear: true,
                    width: '100%',
                    closeOnSelect: false
                });

                // 雇用形態、職種カテゴリ、業界カテゴリを取得
                const { data: masters, error } = await supabase
                    .from('master_data')
                    .select('*')
                    .in('type', ['employment_type', 'job_category', 'industry_category'])
                    .eq('is_active', true)
                    .order('sort_order');

                if (error) {
                    console.error('Supabase master_data fetch error:', error);
                    throw error;
                }

                // フィルタリング（グローバル または 自社用）
                const validMasters = masters.filter(m =>
                    m.organization_id === null || m.organization_id === currentUser.organization_id
                );

                if (validMasters.length === 0) {
                    console.warn('No valid master data found for organization:', currentUser.organization_id);
                }

                // 雇用形態
                const empSelect = $('#search-employment-type');
                if (empSelect.hasClass("select2-hidden-accessible")) {
                    empSelect.select2('destroy');
                }
                empSelect.empty();
                const uniqueEmps = [...new Set(validMasters.filter(m => m.type === 'employment_type').map(m => m.label))];
                uniqueEmps.forEach(label => {
                    empSelect.append(`<option value="${label}">${label}</option>`);
                });
                empSelect.select2({
                    placeholder: "雇用形態（全て）",
                    allowClear: true,
                    width: '100%',
                    closeOnSelect: false
                });

                // 職種カテゴリ
                const catSelect = $('#search-job-category');
                if (catSelect.hasClass("select2-hidden-accessible")) {
                    catSelect.select2('destroy');
                }
                catSelect.empty();
                const uniqueCats = [...new Set(validMasters.filter(m => m.type === 'job_category').map(m => m.label))];
                uniqueCats.forEach(label => {
                    catSelect.append(`<option value="${label}">${label}</option>`);
                });
                catSelect.select2({
                    placeholder: "職種カテゴリ（全て）",
                    allowClear: true,
                    width: '100%',
                    closeOnSelect: false
                });

                // 業界カテゴリ
                const indSelect = $('#search-industry-category');
                if (indSelect.hasClass("select2-hidden-accessible")) {
                    indSelect.select2('destroy');
                }
                indSelect.empty();
                const uniqueInds = [...new Set(validMasters.filter(m => m.type === 'industry_category').map(m => m.label))];
                uniqueInds.forEach(label => {
                    indSelect.append(`<option value="${label}">${label}</option>`);
                });
                indSelect.select2({
                    placeholder: "業界カテゴリ（全て）",
                    allowClear: true,
                    width: '100%',
                    closeOnSelect: false
                });

                isSearchMasterLoaded = true
            } catch (error) {
                console.error('Load search master error:', error)
            }
        }

        // ========================
        // AI Matching Features
        // ========================

        async function loadTargetUsers() {
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('organization_id', currentUser.organization_id)
                    .neq('role', 'super_admin') // スーパー管理者は除外
                    .order('name', { ascending: true })

                if (error) throw error

                targetUsersCache = users || [];
                const select = $('#target-user-select');
                select.html('<option value="">ユーザーを選択してください</option>');

                targetUsersCache.forEach(user => {
                    select.append(`<option value="${user.id}">${user.name} (${user.email})</option>`);
                });

            } catch (error) {
                console.error('Load target users error:', error);
            }
        }

        window.onTargetUserChange = function () {
            const userId = $('#target-user-select').val();
            updateBatchAiButton(); // ボタン状態更新

            if (!userId) return;

            const user = targetUsersCache.find(u => u.id === userId);
            if (!user) return;

            // フォームをリセット (以前の値をクリア)
            $('#search-keyword').val('');
            $('#search-location').val(''); // 詳細エリアを確実にクリア
            $('#search-prefecture').val([]).trigger('change');
            $('#search-employment-type').val([]).trigger('change');
            $('#search-job-category').val([]).trigger('change');
            $('#search-industry-category').val([]).trigger('change');
            $('#search-salary-min').val('');
            $('#search-job-experience-ok').prop('checked', false);
            $('#search-industry-experience-ok').prop('checked', false);
            $('#search-is-remote').prop('checked', false);
            $('#search-exclude-matched').prop('checked', false);
            $('#search-favorites-only').prop('checked', false);

            // ユーザーの希望条件を検索フォームにセット
            // ユーザーの希望条件を検索フォームにセット
            if (user.desired_job_type) $('#search-job-category').val(user.desired_job_type).trigger('change');
            if (user.desired_location) {
                // 配列なら都道府県プルダウンへセット。文字列（詳細）の場合はセットしない
                // ユーザー要望: 勤務地(詳細)の項目はセットしない
                if (Array.isArray(user.desired_location)) {
                    $('#search-prefecture').val(user.desired_location).trigger('change');
                    // 副作用対策: トリガーによってセットされてしまった場合は即座にクリア
                    $('#search-location').val('');
                }
            }
            if (user.desired_employment_type) $('#search-employment-type').val(user.desired_employment_type).trigger('change');
            if (user.desired_salary) $('#search-salary-min').val(Math.floor(user.desired_salary / 10000)); // 万円単位

            // チェックボックス系
            $('#search-job-experience-ok').prop('checked', user.desired_job_experience_ok);
            $('#search-industry-experience-ok').prop('checked', user.desired_industry_experience_ok);

            // 自動的に検索を実行
            searchJobs();
        }

        window.toggleJobSelection = function (jobId) {
            if (selectedJobIds.has(jobId)) {
                selectedJobIds.delete(jobId);
            } else {
                selectedJobIds.add(jobId);
            }
            updateBatchAiButton();
            updateCandidateAiButton();
        }

        function updateBatchAiButton() {
            const btn = $('#batch-ai-btn');
            const count = selectedJobIds.size;
            const userId = $('#target-user-select').val();

            if (count > 0 && userId) {
                btn.prop('disabled', false).removeClass('opacity-50 cursor-not-allowed');
                btn.html(`<i class="fas fa-magic mr-2"></i>選択した求人(${count}件)でAI紹介を実行`);
            } else {
                btn.prop('disabled', true).addClass('opacity-50 cursor-not-allowed');
                btn.html(`<i class="fas fa-magic mr-2"></i>選択した求人でAI紹介を実行`);
            }
        }

        // ========================
        // AI推薦用の匿名化処理
        // ========================

        /**
         * テキストから個人情報を除去・匿名化
         * @param {string} text - 元のテキスト
         * @returns {string} - 匿名化されたテキスト
         */
        function anonymizeText(text) {
            if (!text) return '';

            let anonymized = text;

            // 匿名化ロジックを一時的に無効化（情報不足判定の原因調査のため）
            // 必要な情報まで置換されてしまっている可能性を排除
            return text;

            // 具体的な部署名や役職を一般化（オプション）
            // anonymized = anonymized
            //     .replace(/第[0-9一二三四五六七八九十]+[営業開発製造]部/g, '所属部署');

            return anonymized;
        }

        /**
         * ユーザープロフィールを匿名化してAI用のテキストを生成
         * @param {object} user - ユーザーオブジェクト
         * @returns {string} - 匿名化されたプロフィールテキスト
         */
        function createAnonymizedUserProfile(user) {
            const safeString = (val) => {
                if (!val) return '未設定';
                if (typeof val === 'object') {
                    try { return JSON.stringify(val, null, 2); } catch (e) { return String(val); }
                }
                return String(val);
            };

            return `
                希望職種: ${safeString(user.desired_job_type)}
                希望勤務地: ${safeString(user.desired_location)}
                スキル: ${safeString(user.skills)}
                職歴・自己PR: ${safeString(user.work_history)}
                希望年収: ${user.desired_salary ? user.desired_salary + '円' : '未設定'}
                学歴: ${safeString(user.academic_background)}
                言語スキル: ${safeString(user.languages)}
                資格: ${safeString(user.certifications)}
            `.trim();
        }

        window.runBatchAIRecommendation = async function () {
            // グローバル変数 selectedTargetUserId を優先、なければ従来のselect値
            let userId = typeof selectedTargetUserId !== 'undefined' ? selectedTargetUserId : $('#target-user-select').val();

            if (!userId) {
                alert('対象ユーザーを選択してください');
                return;
            }
            if (selectedJobIds.size === 0) {
                alert('求人を選択してください');
                return;
            }

            showLoading();
            try {
                // 1. 最新のユーザー情報を直接取得 (キャッシュ回避)
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                    .eq('id', userId)
                    .single();

                if (userError || !userData) {
                    console.error('User fetch error:', userError);
                    throw new Error('ユーザー情報の取得に失敗しました');
                }

                // プロフィールデータのフラット化
                const profile = Array.isArray(userData.candidate_profiles) ? userData.candidate_profiles[0] : userData.candidate_profiles;
                const user = { ...userData, ...profile }; // usersとprofilesを結合

                console.log('Fresh User Data fetched:', user);

                // デバッグ用アラート
                alert('【確認用】AIへ送信するデータ(冒頭):\n' + userProfile.substring(0, 500));

                // 2. 選択された求人データを取得
                const { data: selectedJobs, error: jobsError } = await supabase
                    .from('jobs')
                    .select('*')
                    .in('id', Array.from(selectedJobIds));

                if (jobsError) throw jobsError;

                // ユーザープロフィール情報を匿名化して構築
                const userProfile = createAnonymizedUserProfile(user);
                console.log('User Data for AI:', user);
                console.log('Anonymized Profile Text:', userProfile);

                // Edge Function 呼び出し
                const { data: recommendations, error: functionError } = await supabase.functions.invoke('score-ai-recommendations', {
                    body: {
                        userProfile,
                        jobs: selectedJobs.map(j => ({ id: j.id, title: j.title, description: j.description }))
                    }
                });

                if (functionError) throw functionError;

                if (!recommendations || recommendations.length === 0) {
                    throw new Error('AIからの応答がありませんでした');
                }

                // 結果を保存
                for (const rec of recommendations) {
                    // 既存のレコメンデーションがあれば削除してから挿入
                    await supabase.from('recommendations')
                        .delete()
                        .eq('user_id', userId)
                        .eq('job_id', rec.job_id);

                    await supabase.from('recommendations').insert({
                        organization_id: currentUser.organization_id,
                        user_id: userId,
                        job_id: rec.job_id,
                        score: rec.score,
                        reason: rec.reason
                    });
                }

                alert(`${recommendations.length}件のマッチング分析が完了しました！\n「AI紹介」メニューから結果を確認できます。`);
                selectedJobIds.clear();
                updateBatchAiButton();
                // チェックボックスの表示を更新
                $('input[type="checkbox"][onchange^="toggleJobSelection"]').prop('checked', false);
                // 求人リストを再読み込みしてAI推薦済みバッジを表示
                searchJobs();

            } catch (error) {
                console.error('Batch AI error:', error);
                alert('AI分析に失敗しました: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // 求職者用セルフAIマッチング
        window.runCandidateSelfAIMatching = async function () {
            if (!currentUser || currentUser.role !== 'candidate') {
                alert('この機能は求職者のみ利用できます');
                return;
            }
            if (selectedJobIds.size === 0) {
                alert('求人を選択してください（チェックボックスにチェックを入れてください）');
                return;
            }

            showLoading();
            try {
                // 選択された求人データを取得
                const { data: selectedJobs, error: jobsError } = await supabase
                    .from('jobs')
                    .select('*')
                    .in('id', Array.from(selectedJobIds));

                if (jobsError) throw jobsError;

                // 自分のプロフィール情報を匿名化して構築
                const userProfile = createAnonymizedUserProfile(currentUser);

                // Edge Function 呼び出し
                const { data: recommendations, error: functionError } = await supabase.functions.invoke('score-ai-recommendations', {
                    body: {
                        userProfile,
                        jobs: selectedJobs.map(j => ({ id: j.id, title: j.title, description: j.description }))
                    }
                });

                if (functionError) throw functionError;

                if (!recommendations || recommendations.length === 0) {
                    throw new Error('AIからの応答がありませんでした');
                }

                // 結果を保存
                for (const rec of recommendations) {
                    // 既存のレコメンデーションがあれば削除してから挿入
                    await supabase.from('recommendations')
                        .delete()
                        .eq('user_id', currentUser.id)
                        .eq('job_id', rec.job_id);

                    await supabase.from('recommendations').insert({
                        organization_id: currentUser.organization_id,
                        user_id: currentUser.id,
                        job_id: rec.job_id,
                        score: rec.score,
                        reason: rec.reason
                    });
                }

                alert(`${recommendations.length}件のマッチング分析が完了しました！\n「AI推薦」メニューから結果を確認できます。`);
                selectedJobIds.clear();
                updateCandidateAiButton();
                // チェックボックスの表示を更新
                $('input[type="checkbox"][onchange^="toggleJobSelection"]').prop('checked', false);
                // 求人リストを再読み込みしてAI推薦済みバッジを表示
                searchJobs();

            } catch (error) {
                console.error('Candidate AI matching error:', error);
                alert('AI分析に失敗しました: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // 求職者用AIボタンの有効/無効を更新
        function updateCandidateAiButton() {
            const btn = $('#candidate-ai-btn');
            if (selectedJobIds.size > 0) {
                btn.prop('disabled', false);
            } else {
                btn.prop('disabled', true);
            }
        }

        // ========================
        // Job Detail Modal
        // ========================
        window.showJobDetailModal = async function (jobId) {
            if (isModalLoading) return;
            console.log('--- showJobDetailModal Triggered ---', jobId);

            if (!jobId) {
                console.error('Error: jobId is undefined or null');
                return;
            }

            console.log('Step 1: check client');
            const client = window.supabase;
            console.log('Step 2: check user');
            const user = window.currentUser;
            console.log('Step 3: show loading');
            showLoading();
            isModalLoading = true;
            console.log('Step 4: entering try');
            try {
                console.log('Fetching job details for:', jobId);
                let { data: job, error } = await client
                    .from('jobs')
                    .select(`
                        *,
                        companies (
                            name,
                            industry,
                            website
                        )
                    `)
                    .eq('id', jobId)
                    .single();

                if (error) {
                    console.log('Fetch error, trying fallback:', error);
                    const fallback = await client.from('jobs').select('*').eq('id', jobId).single();
                    job = fallback.data;
                    error = fallback.error;
                }

                if (error || !job) {
                    console.log('Final fetch error or no job:', error, job);
                    alert('求人情報の取得に失敗したか、見つかりませんでした');
                    return;
                }

                console.log('Job details fetched:', job.title);
                $('#job-detail-title').text(job.title);

                if (user && (user.role === 'candidate' || user.role === 'user')) {
                    $('#job-tab-candidates').addClass('hidden');
                } else {
                    $('#job-tab-candidates').removeClass('hidden');
                }

                const companyName = job.companies ? job.companies.name : (job.company || '不明');
                const companyIndustry = job.companies?.industry || job.industry_category || '未設定';
                const companyWebsite = job.companies?.website || '';

                const content = `
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-bold text-lg mb-3 text-gray-900">
                            <i class="fas fa-building mr-2 text-indigo-600"></i>企業情報
                        </h4>
                        <div class="space-y-2">
                            <p class="text-gray-800"><span class="font-semibold">企業名:</span> ${companyName}</p>
                            <p class="text-gray-800"><span class="font-semibold">業界:</span> ${companyIndustry}</p>
                            ${companyWebsite ? `<p class="text-gray-800"><span class="font-semibold">Webサイト:</span> <a href="${companyWebsite}" target="_blank" class="text-indigo-600 hover:underline">${companyWebsite}</a></p>` : ''}
                        </div>
                    </div>

                    <div>
                        <h4 class="font-bold text-lg mb-3 text-gray-900">
                            <i class="fas fa-info-circle mr-2 text-indigo-600"></i>求人情報
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><p class="text-sm text-gray-600">職種カテゴリ</p><p class="font-medium text-gray-900">${job.job_category || '未設定'}</p></div>
                            <div><p class="text-sm text-gray-600">業界カテゴリ</p><p class="font-medium text-gray-900">${job.industry_category || '未設定'}</p></div>
                            <div><p class="text-sm text-gray-600">勤務地</p><p class="font-medium text-gray-900"><i class="fas fa-map-marker-alt mr-1 text-gray-500"></i>${job.location || '未設定'}</p></div>
                            <div><p class="text-sm text-gray-600">雇用形態</p><p class="font-medium text-gray-900">${job.employment_type || '未設定'}</p></div>
                            ${job.salary_min && job.salary_max ? `<div><p class="text-sm text-gray-600">想定年収</p><p class="font-medium text-gray-900 text-lg">¥${(job.salary_min / 10000).toLocaleString()}万 - ${(job.salary_max / 10000).toLocaleString()}万</p></div>` : ''}
                            <div class="md:col-span-2">
                                <p class="text-sm text-gray-600">求人URL</p>
                                <p class="font-medium text-gray-900 truncate">
                                    ${job.url ? `
                                    <a href="${job.url}" target="_blank" class="text-indigo-600 hover:underline flex items-center gap-1">
                                        <i class="fas fa-external-link-alt text-xs"></i>
                                        <span class="truncate">${job.url}</span>
                                    </a>
                                    ` : '<span class="text-gray-400">未設定</span>'}
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6">
                        <h4 class="font-bold text-lg mb-3 text-gray-900"><i class="fas fa-clipboard-list mr-2 text-indigo-600"></i>職務内容</h4>
                        <div class="bg-white border border-gray-200 rounded-lg p-4"><p class="text-gray-800 whitespace-pre-wrap">${job.description || '詳細は企業にお問い合わせください'}</p></div>
                    </div>

                    ${job.requirements ? `<div class="mt-6"><h4 class="font-bold text-lg mb-3 text-gray-900"><i class="fas fa-check-circle mr-2 text-indigo-600"></i>必須要件</h4><div class="bg-white border border-gray-200 rounded-lg p-4"><p class="text-gray-800 whitespace-pre-wrap">${job.requirements}</p></div></div>` : ''}

                    <div class="mt-6 bg-blue-50 rounded-lg p-4">
                        <h4 class="font-bold text-lg mb-3 text-gray-900"><i class="fas fa-user-check mr-2 text-indigo-600"></i>経験条件</h4>
                        <div class="flex gap-4">
                            <div class="flex items-center"><i class="fas ${job.job_experience_ok === '可' ? 'fa-check-circle text-green-600' : 'fa-times-circle text-red-600'} mr-2"></i><span class="text-gray-800">職種未経験: ${job.job_experience_ok === '可' ? '可' : '不可'}</span></div>
                            <div class="flex items-center"><i class="fas ${job.industry_experience_ok === '可' ? 'fa-check-circle text-green-600' : 'fa-times-circle text-red-600'} mr-2"></i><span class="text-gray-800">業界未経験: ${job.industry_experience_ok === '可' ? '可' : '不可'}</span></div>
                        </div>
                    </div>

                    <div class="flex gap-3 pt-6 mt-6 border-t">
                        <button id="modal-fav-btn-${job.id}" onclick="toggleFavorite('${job.id}')" class="flex-1 px-6 py-3 border-2 ${typeof favoriteJobIds !== 'undefined' && favoriteJobIds.has(job.id) ? 'border-pink-500 text-pink-600' : 'border-gray-300 text-gray-700'} rounded-lg hover:bg-gray-50 font-medium transition"><i class="fas fa-heart mr-2"></i>${typeof favoriteJobIds !== 'undefined' && favoriteJobIds.has(job.id) ? 'お気に入り登録済み' : 'お気に入りに追加'}</button>
                        ${user && (user.role === 'candidate' || user.role === 'user') ? `<button onclick="applyForJob('${job.id}')" class="flex-1 bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 font-medium transition"><i class="fas fa-paper-plane mr-2"></i>応募する</button>` : ''}
                    </div>
                `;

                console.log('Final step: Rendering to modal and forcing visibility.');
                $('#job-detail-tab-content').html(content);
                window.currentJobId = jobId;

                const modal = $('#job-detail-modal');
                if (modal.length === 0) {
                    console.error('CRITICAL: #job-detail-modal not found in DOM!');
                    alert('エラー: モーダル要素が見つかりませんでした');
                    return;
                }

                // Move to body root to avoid parent clipping/z-index issues
                $('body').append(modal);

                console.log('Updating modal visibility...');
                modal.removeClass('hidden').attr('style', 'display: flex !important; z-index: 99999 !important; visibility: visible !important; opacity: 1 !important;');

                switchJobDetailTab('details');
                console.log('Modal show process complete - z-index 99999 applied');

            } catch (error) {
                console.error('Load job detail error:', error);
                alert('求人詳細の取得に失敗しました: ' + error.message);
            } finally {
                isModalLoading = false;
                hideLoading();
            }
        }

        window.closeJobDetailModal = function () {
            console.log('--- closeJobDetailModal Triggered ---');
            $('#job-detail-modal').addClass('hidden').attr('style', 'display: none !important;');
        }

        // ============================================
        // 求人推薦機能（エージェント用）
        // ============================================

        let currentRecommendJobId = null;
        let currentRecommendTargetUserId = null;

        // チェックボックス選択時の処理を更新
        window.toggleJobSelection = function (jobId) {
            const checkbox = $(`input[type="checkbox"][onclick*="toggleJobSelection('${jobId}')"]`);
            const card = checkbox.closest('.job-card');

            if (selectedJobIds.has(jobId)) {
                selectedJobIds.delete(jobId);
                if (card.length) card.removeClass('job-card-highlighted');
            } else {
                selectedJobIds.add(jobId);
                if (card.length) card.addClass('job-card-highlighted');
            }
            updateBulkRecommendBar();
        }

        // 上位30件を一括選択
        window.selectTop30Jobs = function () {
            const checkboxes = $('.job-card input[type="checkbox"]:not(:disabled)').slice(0, 30);

            checkboxes.each(function () {
                const jobId = $(this).attr('onchange').match(/'([^']+)'/)[1];
                if (!selectedJobIds.has(jobId)) {
                    $(this).prop('checked', true);
                    selectedJobIds.add(jobId);
                    $(this).closest('.job-card').addClass('job-card-highlighted');
                }
            });

            updateBulkRecommendBar();

            // 通知
            const count = checkboxes.length;
            if (count > 0) {
                // 簡易的な通知（トーストがあればそれが良いが、なければアラート等は避ける）
                console.log(`${count} 件の求人を選択しました`);
            }
        }

        window.clearAllSelectedJobs = function () {
            selectedJobIds.clear();
            $('.job-checkbox').prop('checked', false);
            $('.job-card').removeClass('job-card-highlighted');
            updateBulkRecommendBar();
        }

        function updateBulkRecommendBar() {
            const count = selectedJobIds.size;
            $('#selected-jobs-count').text(count);

            // 修正: selectedTargetUserId を使用
            const targetUserId = selectedTargetUserId;
            const isAgent = currentUser && ['org_admin', 'admin', 'coach', 'ca', 'super_admin'].includes(currentUser.role);
            const isCandidate = currentUser && currentUser.role === 'candidate';

            // 上部のボタンの制御を追加
            const batchAiBtn = $('#batch-ai-btn');
            if (count > 0 && (isCandidate || (isAgent && targetUserId))) {
                batchAiBtn.prop('disabled', false).removeClass('opacity-50 cursor-not-allowed');
            } else {
                batchAiBtn.prop('disabled', true).addClass('opacity-50 cursor-not-allowed');
            }

            // 下部のバーの制御
            if (count > 0) {
                if (isAgent && targetUserId) {
                    // エージェントの場合: 推薦バーを表示
                    $('#bulk-recommend-bar').removeClass('hidden');
                    $('#bulk-recommend-bar .bar-title').text('AIマッチ');
                    $('#bulk-recommend-bar .bar-button').text('AIマッチを実行');
                } else if (isCandidate) {
                    // 求職者の場合: AIマッチング診断バーを表示
                    $('#bulk-recommend-bar').removeClass('hidden');
                    $('#bulk-recommend-bar .bar-title').text('AIマッチング診断');
                    $('#bulk-recommend-bar .bar-button').text('AIマッチングする');
                } else {
                    // エージェントだがユーザー未選択の場合
                    $('#bulk-recommend-bar').addClass('hidden');
                }
            } else {
                $('#bulk-recommend-bar').addClass('hidden');
            }
        }

        window.openRecommendJobModal = async function (jobId) {
            currentRecommendJobId = jobId;

            if (!selectedTargetUserId) {
                // ユーザーが選択されていない場合は選択モーダルを開く
                openCandidateSelectionModal();
                return;
            }

            const targetUserId = selectedTargetUserId;
            currentRecommendTargetUserId = targetUserId;

            // 求人情報を取得
            try {
                const { data: job, error } = await supabase
                    .from('jobs')
                    .select('*, companies(name)')
                    .eq('id', jobId)
                    .single();

                if (error) throw error;

                $('#recommend-job-title').text(job.title);

                // ユーザー情報を取得
                const { data: user, error: userError } = await supabase
                    .from('users')
                    .select('name, email')
                    .eq('id', targetUserId)
                    .single();

                if (userError) throw userError;

                $('#recommend-target-user').text(`${user.name} (${user.email})`);
                $('#recommend-reason').val('');

                $('#recommend-job-modal').removeClass('hidden');

            } catch (error) {
                console.error('Failed to load job/user:', error);
                alert('求人情報の取得に失敗しました');
            }
        }

        window.closeRecommendJobModal = function () {
            $('#recommend-job-modal').addClass('hidden');
            currentRecommendJobId = null;
            currentRecommendTargetUserId = null;
        }

        // AI自動生成
        window.generateRecommendReason = async function () {
            if (!currentRecommendJobId || !currentRecommendTargetUserId) return;

            const btn = event.target.closest('button');
            const originalHtml = $(btn).html();
            $(btn).html('<i class="fas fa-spinner fa-spin mr-1"></i>生成中...').prop('disabled', true);

            const type = $('#generate-reason-type').val() || 'recommendation';

            try {
                // Edge Functionを呼び出して推薦文を生成
                const { data, error } = await supabase.functions.invoke('generate-recommendation-letter', {
                    body: {
                        jobId: currentRecommendJobId,
                        candidateId: currentRecommendTargetUserId,
                        type: type
                    }
                });

                if (error) throw error;

                if (data && data.success) {
                    $('#recommend-reason').val(data.text);
                } else {
                    throw new Error(data?.error || '生成に失敗しました');
                }

            } catch (error) {
                console.error('Failed to generate reason:', error);

                // 失敗時は簡易ロジックにフォールバック、またはエラー表示
                // ここでは簡易ロジックを試みる
                try {
                    const { data: job } = await supabase.from('jobs').select('*').eq('id', currentRecommendJobId).single();
                    const { data: user } = await supabase.from('users').select('*').eq('id', currentRecommendTargetUserId).single();
                    const reason = generateSimpleReason(job, user);
                    $('#recommend-reason').val(reason);
                    alert('AI生成に失敗したため、簡易テンプレートを使用しました');
                } catch (e) {
                    alert('おすすめ理由の生成に失敗しました');
                }
            } finally {
                $(btn).html(originalHtml).prop('disabled', false);
            }
        }

        function generateSimpleReason(job, user) {
            const reasons = [];

            if (user.desired_job_category && job.job_category === user.desired_job_category) {
                reasons.push(`ご希望の職種「${job.job_category}」に合致しています`);
            }

            if (user.desired_location && job.location.includes(user.desired_location)) {
                reasons.push(`ご希望の勤務地「${user.desired_location}」に該当します`);
            }

            if (user.desired_salary_min && job.salary_max >= user.desired_salary_min) {
                reasons.push(`ご希望年収${user.desired_salary_min / 10000} 万円以上の条件を満たしています`);
            }

            if (job.is_remote && user.desired_remote) {
                reasons.push('リモートワーク可能な求人です');
            }

            if (reasons.length === 0) {
                return `${user.name} 様のご経験やスキルを活かせる求人としてご紹介いたします。${job.title} のポジションは、キャリアアップの良い機会となると考えております。`;
            }

            return reasons.join('。') + '。ぜひご検討ください。';
        }

        // 推薦を送信
        window.submitRecommendation = async function () {
            const reason = $('#recommend-reason').val().trim();

            if (!reason) {
                alert('おすすめ理由を入力してください');
                return;
            }

            try {
                console.log('Submitting recommendation:', {
                    organization_id: currentUser.organization_id,
                    user_id: currentRecommendTargetUserId,
                    job_id: currentRecommendJobId,
                    reason: reason,
                    score: 85,
                    recommended_by: currentUser.id
                });

                const { data, error } = await supabase
                    .from('recommendations')
                    .insert({
                        organization_id: currentUser.organization_id,
                        user_id: currentRecommendTargetUserId,
                        job_id: currentRecommendJobId,
                        reason: reason,
                        score: 85,
                        recommended_by: currentUser.id
                    })
                    .select();

                if (error) {
                    console.error('Supabase error details:', error);
                    throw error;
                }

                console.log('Recommendation created:', data);
                alert('求人を紹介しました');
                closeRecommendJobModal();
                searchJobs(); // 求人リストを更新

            } catch (error) {
                console.error('Failed to submit recommendation:', error);
                alert(`推薦の送信に失敗しました: ${error.message || JSON.stringify(error)} `);
            }
        }

        // 一括推薦/AIマッチング診断モーダルを開く
        window.openBulkRecommendModal = async function () {
            // 求職者の場合、自動的に自分を対象ユーザーにセット
            if (currentUser && currentUser.role === 'candidate') {
                selectedTargetUserId = currentUser.id;
            }
            const isAgent = currentUser && ['org_admin', 'admin', 'coach', 'ca', 'super_admin'].includes(currentUser.role);
            const isCandidate = currentUser && currentUser.role === 'candidate';

            if (selectedJobIds.size === 0) {
                alert('求人を選択してください');
                return;
            }

            // エージェントの場合: 対象ユーザーが必要
            // 求職者の場合: 自分自身が対象
            let targetUserId;
            if (isAgent) {
                targetUserId = selectedTargetUserId;
                if (!targetUserId) {
                    alert('推薦先のユーザーを選択してください');
                    return;
                }
            } else if (isCandidate) {
                targetUserId = currentUser.id;
            } else {
                alert('この機能を利用する権限がありません');
                return;
            }

            currentRecommendTargetUserId = targetUserId;

            try {
                // ユーザー情報を取得
                const { data: user, error: userError } = await supabase
                    .from('users')
                    .select('name, email')
                    .eq('id', targetUserId)
                    .single();

                if (userError) throw userError;

                // モーダルのタイトルとメッセージを設定
                if (isCandidate) {
                    $('#bulk-recommend-modal-title').text('AIマッチング診断');
                    $('#bulk-recommend-target-user').text(`あなた(${user.name})`);
                } else {
                    $('#bulk-recommend-modal-title').text('AIマッチ');
                    $('#bulk-recommend-target-user').text(`${user.name} (${user.email})`);
                }

                $('#bulk-job-count').text(selectedJobIds.size);

                // 選択した求人リストを表示
                const jobIds = Array.from(selectedJobIds);
                const { data: jobs, error: jobsError } = await supabase
                    .from('jobs')
                    .select('id, title, companies(name)')
                    .in('id', jobIds);

                if (jobsError) throw jobsError;

                const jobsHtml = jobs.map(job => `
                    <div class="flex items-center justify-between p-2 bg-white rounded border">
                        <span class="text-sm text-gray-900">${job.title}</span>
                        <span class="text-xs text-gray-500">${job.companies?.name || ''}</span>
                    </div>
                `).join('');

                $('#bulk-jobs-list').html(jobsHtml);
                $('#bulk-recommend-modal').removeClass('hidden');

            } catch (error) {
                console.error('Failed to load data:', error);
                alert('データの取得に失敗しました');
            }
        }

        window.closeBulkRecommendModal = function () {
            $('#bulk-recommend-modal').addClass('hidden');
        }

        // AI推薦結果モーダルを表示
        function showAIResultModal(recommended, excluded, targetUserName) {
            const modalHtml = `
                <div class="ai-result-tabs">
                    <div class="ai-result-tab active" data-tab="recommended">
                        紹介 (${recommended.length}件)
                    </div>
                    <div class="ai-result-tab" data-tab="excluded">
                        対象外 (${excluded.length}件)
                    </div>
                </div>

                <div class="ai-result-content active" data-content="recommended">
                    ${recommended.length === 0 ? '<p class="text-gray-500 text-center py-8">紹介する求人がありません</p>' : ''}
                    ${recommended.map(r => renderAIResultItem(r, false)).join('')}
                </div>

                <div class="ai-result-content" data-content="excluded">
                    ${excluded.length === 0 ? '<p class="text-gray-500 text-center py-8">対象外の求人がありません</p>' : ''}
                    ${excluded.map(r => renderAIResultItem(r, true)).join('')}
                </div>
        `;

            // モーダルを表示（既存のモーダル表示ロジックを使用）
            // ここでは簡易的に既存のbulk-recommend-modalの中身を書き換えて再利用するか、新しいモーダルを作る
            // 既存のモーダル構造を利用して中身を差し替える
            $('#bulk-recommend-modal h3').text(`${targetUserName} さんへのAI紹介結果`);
            $('#bulk-recommend-modal .modal-body').html(modalHtml); // .modal-bodyクラスが必要

            // もし.modal-bodyがない場合は、適切なセレクタを探す必要がありますが、
            // ここでは一旦、bulk-recommend-modalの中身を直接書き換えるアプローチをとります。
            // ただし、閉じるボタンなどの機能は維持したいので、モーダルの中身を動的に生成する方が安全です。

            // 新しいモーダルHTMLをbodyに追加（まだ存在しない場合）
            if ($('#ai-result-modal').length === 0) {
                $('body').append(`
                    <div id="ai-result-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" style="z-index: 10003;">
                        <div class="bg-white rounded-lg w-full max-w-3xl p-6 max-h-[90vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-gray-900">AI紹介結果</h3>
                                <button onclick="$('#ai-result-modal').addClass('hidden')" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div id="ai-result-modal-content"></div>
                            <div class="flex justify-end mt-4 pt-4 border-t">
                                <button onclick="$('#ai-result-modal').addClass('hidden')" class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700">閉じる</button>
                            </div>
                        </div>
                    </div>
                `);
            }

            // AI詳細分析モーダルを追加（まだ存在しない場合）
            if ($('#ai-detail-modal').length === 0) {
                $('body').append(`
                    <div id="ai-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" style="z-index: 10010;">
                        <div class="bg-white rounded-lg w-full max-w-4xl p-6 max-h-[90vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-gray-900">📊 AI詳細分析</h3>
                                <button onclick="closeAIDetailModal()" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div id="ai-detail-modal-content"></div>
                            <div class="flex justify-end mt-4 pt-4 border-t">
                                <button onclick="closeAIDetailModal()" class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700">閉じる</button>
                            </div>
                        </div>
                    </div>
                `);
            }

            $('#ai-result-modal h3').text(`${targetUserName} さんへのAI推薦結果`);
            $('#ai-result-modal-content').html(modalHtml);
            $('#ai-result-modal').removeClass('hidden');

            $('.ai-result-tab').off('click').on('click', function () {
                const tab = $(this).data('tab');
                $('.ai-result-tab').removeClass('active');
                $(this).addClass('active');
                $('.ai-result-content').removeClass('active');
                $(`.ai-result-content[data-content="${tab}"]`).addClass('active');
            });
        }

        function renderAIResultItem(result, isExcluded) {
            const itemClass = isExcluded ? 'ai-result-item excluded' : 'ai-result-item';
            const hasDetails = result.details && result.details.trim().length > 0;

            // 一意のIDを生成
            const itemId = `ai-result-${result.job_id}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

            // detailsをグローバルに保存（後でアクセスできるように）
            if (hasDetails) {
                if (!window.aiResultDetails) window.aiResultDetails = {};
                window.aiResultDetails[itemId] = {
                    jobId: result.job_id,
                    jobTitle: result.job_title,
                    company: result.company,
                    score: result.score,
                    details: result.details
                };
            }

            return `
            <div class="${itemClass}">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-gray-900">${result.job_title}</h4>
                        <span class="text-sm font-bold ${isExcluded ? 'text-gray-600' : 'text-indigo-600'}">
                            マッチ度: ${result.score}%
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">${result.company}</p>
                    <p class="text-sm text-gray-700 mb-3">${result.reason}</p>
                    <div class="flex gap-3 items-center">
                        <button 
                            class="text-xs text-blue-600 hover:text-blue-800 underline font-medium"
                            onclick="event.stopPropagation(); window.showJobDetailModal('${result.job_id}')"
                        >
                            <i class="fas fa-file-alt mr-1"></i>求人詳細を見る
                        </button>
                        ${hasDetails ? `
                            <button 
                                class="ai-detail-btn text-xs text-indigo-600 hover:text-indigo-800 underline"
                                data-item-id="${itemId}"
                                onclick="event.stopPropagation(); window.openAIDetail('${itemId}')"
                           >
                                📊 詳細分析を見る
                            </button>
                        ` : ''
                }
                    </div>
                </div>
            `;
        }

        // 詳細ボタンのクリックイベントハンドラ
        window.openAIDetail = function (itemId) {
            console.log('openAIDetail called with itemId:', itemId);
            console.log('Current aiResultDetails:', window.aiResultDetails);

            const data = window.aiResultDetails ? window.aiResultDetails[itemId] : null;
            if (data) {
                console.log('Found detail data:', data);
                showAIDetailModal(data.jobId, data.jobTitle, data.company, data.score, data.details);
            } else {
                console.error('AI detail data not found for itemId:', itemId);
                alert('詳細データが見つかりません');
            }
        };

        // AI詳細分析モーダルを表示
        window.showAIDetailModal = function (jobId, jobTitle, company, score, details) {
            const modalHtml = `
            <div class="mb-4">
                    <h4 class="text-lg font-bold text-gray-900 mb-1">${jobTitle}</h4>
                    <p class="text-sm text-gray-600 mb-2">${company}</p>
                    <div class="inline-block bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-bold">
                        マッチ度: ${score}%
                    </div>
                </div>
            <div class="bg-gray-50 p-4 rounded-lg">
                <pre class="whitespace-pre-wrap text-sm text-gray-800 font-sans">${details}</pre>
            </div>
        `;

            $('#ai-detail-modal-content').html(modalHtml);
            $('#ai-detail-modal').removeClass('hidden');
        }

        window.closeAIDetailModal = function () {
            $('#ai-detail-modal').addClass('hidden');
        }

        // 一括推薦/AIマッチング診断を送信
        // 一括推薦/AIマッチング診断を送信
        window.submitBulkRecommendation = async function () {
            const btn = event.target.closest('button');
            const originalHtml = $(btn).html();
            $(btn).html('<i class="fas fa-spinner fa-spin mr-2"></i>処理中...').prop('disabled', true);

            const isCandidate = currentUser && currentUser.role === 'candidate';

            // 対象ユーザーIDの決定
            let targetUserId;
            let targetUserName;

            if (isCandidate) {
                targetUserId = currentUser.id;
                targetUserName = currentUser.name;
            } else {
                // 管理者・コーチの場合
                if (!selectedTargetUserId) {
                    alert('AI紹介対象ユーザーを選択してください');
                    $(btn).html(originalHtml).prop('disabled', false);
                    return;
                }
                targetUserId = selectedTargetUserId;
                targetUserName = selectedTargetUserName;
            }

            try {
                // ユーザー情報を取得
                const { data: userData, error: userFetchError } = await supabase
                    .from('users')
                    .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                    .eq('id', targetUserId)
                    .single();

                if (userFetchError) throw userFetchError;

                // プロフィールデータのフラット化 (AI-Matching関数へ渡すため)
                const profile = Array.isArray(userData.candidate_profiles) ? userData.candidate_profiles[0] : userData.candidate_profiles;
                const user = { ...userData, ...profile };
                console.log('Sending User to AI-Matching:', user);

                // 各求人に対して推薦を作成
                const jobIds = Array.from(selectedJobIds);
                const { data: jobs } = await supabase
                    .from('jobs')
                    .select('*, companies(*)')
                    .in('id', jobIds);

                // AI分析APIを呼び出す
                let recommendations = [];
                try {
                    const { data: aiResults, error: aiError } = await supabase.functions.invoke('ai-matching', {
                        body: { user, jobs }
                    });

                    if (aiError) throw aiError;

                    recommendations = aiResults.map(result => {
                        const job = jobs.find(j => j.id === result.job_id);
                        // ルールベースのスコアを計算（AIスコアが取得できなかった場合のフォールバック用）
                        const ruleBased = calculateClientSideMatchScores(job, user);

                        return {
                            organization_id: currentUser.organization_id,
                            user_id: targetUserId,
                            job_id: result.job_id,
                            reason: result.recommendation_reason || result.reason || 'AIマッチング',
                            score: result.match_score || ruleBased.match_score || 0,
                            recommended_by: currentUser.id,
                            job_title: job ? job.title : '',
                            company: job ? (job.companies?.name || job.company) : '',
                            details: result.details, // 詳細分析結果
                            culture_score: result.culture_match_score || ruleBased.culture_match_score || 0
                        };
                    });
                } catch (e) {
                    console.warn('AI Matching Function failed, falling back to dummy logic:', e);
                    // フォールバック（ダミーロジック）
                    recommendations = jobs.map(job => {
                        const score = Math.floor(Math.random() * 65) + 30;
                        return {
                            organization_id: currentUser.organization_id,
                            user_id: targetUserId,
                            job_id: job.id,
                            reason: generateSimpleReason(job, user),
                            score: score,
                            recommended_by: currentUser.id,
                            job_title: job.title,
                            company: job.company
                        };
                    });
                }

                // DBに保存（detailsとculture_scoreも含める）
                const dbRecommendations = recommendations.map(r => {
                    const { job_title, company, ...dbRecord } = r;
                    return dbRecord;
                });

                const { error } = await supabase
                    .from('recommendations')
                    .insert(dbRecommendations);

                if (error) throw error;

                // ログ記録
                await auditLog.bulkRecommendationExecuted(recommendations.length, {
                    target_user_id: targetUserId,
                    job_ids: Array.from(selectedJobIds)
                });

                // 結果を分類
                const recommended = recommendations.filter(r => r.score >= 50);
                const excluded = recommendations.filter(r => r.score < 50);

                // モーダルを閉じる
                closeBulkRecommendModal();

                // 結果モーダルを表示
                showAIResultModal(recommended, excluded, targetUserName);

                selectedJobIds.clear();
                updateBulkRecommendBar();
                searchJobs(); // 求人リストを更新

            } catch (error) {
                console.error('Failed to submit bulk recommendations:', error);
                alert('一括推薦の送信に失敗しました');
            } finally {
                $(btn).html(originalHtml).prop('disabled', false);
            }
        }

        // ============================================
        // 求人起点マッチング機能
        // ============================================

        // グローバル変数
        window.currentJobId = null;
        window.jobMatchesCache = [];

        // タブ切り替え機能
        window.switchJobDetailTab = function (tab) {
            // タブボタンのスタイル更新
            $('.job-detail-tab').each(function () {
                $(this).removeClass('border-indigo-600 text-indigo-600');
                $(this).addClass('border-transparent text-gray-500');
            });

            if (tab === 'details') {
                $('#job-tab-details').removeClass('border-transparent text-gray-500');
                $('#job-tab-details').addClass('border-indigo-600 text-indigo-600');
                $('#job-detail-tab-content').removeClass('hidden');
                $('#job-candidates-tab-content').addClass('hidden');
            } else if (tab === 'candidates') {
                $('#job-tab-candidates').removeClass('border-transparent text-gray-500');
                $('#job-tab-candidates').addClass('border-indigo-600 text-indigo-600');
                $('#job-detail-tab-content').addClass('hidden');
                $('#job-candidates-tab-content').removeClass('hidden');

                // 候補者タブを開いたときに、まだマッチングを実行していなければ既存データを読み込み
                if (jobMatchesCache.length === 0) {
                    loadJobMatches();
                }
            }
        }

        // マッチング実行
        // マッチング実行 (クライアントサイド予備実装)
        window.runJobMatching = async function () {
            if (!window.currentJobId || !currentUser) {
                alert('求人情報が取得できません');
                return;
            }

            const btn = $('#run-matching-btn');
            const originalHtml = btn.html();

            try {
                // ボタンを無効化
                btn.prop('disabled', true);
                btn.html('<i class="fas fa-spinner fa-spin mr-2"></i>マッチング中...');

                console.log('Running job matching (Client-Side) for job:', window.currentJobId);

                // 1. 求人情報を取得
                const { data: job, error: jobError } = await window.supabase
                    .from('jobs')
                    .select('*')
                    .eq('id', window.currentJobId)
                    .single();

                if (jobError) throw jobError;

                // 2. 候補者を取得（プロフィール結合）
                const { data: candidates, error: candError } = await window.supabase
                    .from('users')
                    .select('*, candidate_profiles(*)')
                    .eq('organization_id', currentUser.organization_id)
                    .eq('role', 'candidate');

                if (candError) throw candError;

                console.log(`Found ${candidates.length} candidates`);

                // 3. マッチングスコア計算
                const matches = candidates.map(user => {
                    // プロフィールデータの結合
                    const profile = Array.isArray(user.candidate_profiles) ? (user.candidate_profiles[0] || {}) : (user.candidate_profiles || {});
                    const candidate = { ...user, ...profile };

                    // スコア計算
                    const scores = calculateClientSideMatchScores(job, candidate);

                    return {
                        job_id: window.currentJobId,
                        candidate_id: user.id,
                        organization_id: currentUser.organization_id,
                        candidate: candidate, // Ensure candidate object is passed for rendering
                        ...scores,
                        recommendation_reason: generateClientSideRecommendationReason(job, candidate, scores),
                        recommendation_details: {
                            job_requirements: extractClientSideJobRequirements(job),
                            candidate_strengths: extractClientSideCandidateStrengths(candidate),
                            match_points: identifyClientSideMatchPoints(job, candidate, scores)
                        },
                        matched_at: new Date().toISOString()
                    };
                });

                // 4. スコアでソート & フィルタリング
                matches.sort((a, b) => b.match_score - a.match_score);
                const limit = 30;
                const topMatches = matches.filter(m => m.match_score >= 20).slice(0, limit); // 少し緩めに20点以上

                console.log(`Top ${topMatches.length} matches calculated`);

                // 5. データベースに保存
                // DBに存在しないカラム (candidateなど) を除外して保存用データを作成
                const upsertData = topMatches.map(({ candidate, ...rest }) => rest);

                const { error: insertError } = await window.supabase
                    .from('job_candidate_matches')
                    .upsert(upsertData, {
                        onConflict: 'job_id,candidate_id',
                        ignoreDuplicates: false
                    });

                if (insertError) throw insertError;

                // 4. 結果表示（共通関数を使用）
                renderMatchingResults(matches, '#job-candidates-list');

                alert(`${matches.length} 件の候補者が見つかりました（マッチ: ${matches.filter(m => m.match_score > 49).length} 件）`);

            } catch (error) {
                console.error('Job matching error:', error);
                alert('マッチングに失敗しました: ' + (error.message || '不明なエラー'));
            } finally {
                // ボタンを元に戻す
                btn.prop('disabled', false);
                btn.html(originalHtml);
            }
        }

        // ============================================
        // クライアントサイドマッチングロジック
        // ============================================

        const CRITICAL_KEYWORDS = [
            '税務', '法務', '経理', '財務', '会計', '人事', '労務', '採用',
            'エンジニア', 'プログラマー', 'SE', '開発', 'インフラ', 'フロントエンド', 'バックエンド', ,
            '医師', '看護師', '薬剤師', '弁護士', '会計士', '税理士',
            '営業', 'セールス', 'マーケティング', '広報'
        ];
        const WELCOME_KEYWORDS = ['未経験', 'ポテンシャル', '不問', '挑戦', '初心者', '第二新卒'];

        function calculateClientSideMatchScores(job, candidate) {
            let skillScore = 50;
            let experienceScore = 50;
            let locationScore = 50;
            let salaryScore = 50;
            let cultureScore = 50;

            const jobReqs = extractClientSideSkills(job.requirements);
            const candSkills = extractClientSideSkills(candidate.skills);

            // Skill
            if (jobReqs.length > 0) {
                const matchCount = jobReqs.filter(js => candSkills.some(cs => cs.includes(js) || js.includes(cs))).length;
                skillScore = Math.min(100, (matchCount / jobReqs.length) * 100 + 20);
            } else {
                skillScore = candSkills.length > 0 ? 60 : 40;
            }

            // Experience (Title match)
            const jobTitle = (job.title || '').toLowerCase();
            const workHistory = (candidate.work_history || '').toLowerCase();
            if (workHistory.includes(jobTitle) || jobTitle.includes(candidate.desired_job_type || '#####')) {
                experienceScore = 80;
            } else if (workHistory.length > 10) {
                experienceScore = 60;
            }

            // Salary
            // Salary
            if (candidate.desired_salary) {
                // If candidate wants more than Job Max (and Max is set), it's a mismatch
                if (job.salary_max && candidate.desired_salary > job.salary_max) {
                    salaryScore = 20;
                } else if (job.salary_min) {
                    // If candidate matches Min or is reasonably within range
                    if (candidate.desired_salary <= job.salary_min * 1.2) salaryScore = 80;
                    else if (candidate.desired_salary <= job.salary_min * 1.5) salaryScore = 60;
                    else salaryScore = 40;
                }
            }

            // Keyword Count for Penalty
            const requirementsText = (job.requirements || '').toLowerCase();
            const candidateText = JSON.stringify(candidate).toLowerCase();
            const isUnskilledWelcome = WELCOME_KEYWORDS.some(w => (job.title + requirementsText).includes(w));

            let match_score = (skillScore * 0.4 + experienceScore * 0.3 + salaryScore * 0.3);

            // Simple Penalty
            if (!isUnskilledWelcome && match_score < 40) match_score *= 0.8;

            return {
                match_score: Math.round(match_score),
                skill_match_score: Math.round(skillScore),
                experience_match_score: Math.round(experienceScore),
                location_match_score: Math.round(locationScore),
                salary_match_score: Math.round(salaryScore),
                culture_match_score: Math.round(cultureScore)
            };
        }

        function extractClientSideSkills(text) {
            if (!text) return [];
            return text.split(/[,、\n\s]/).map(s => s.trim().toLowerCase()).filter(s => s.length > 1);
        }

        function generateClientSideRecommendationReason(job, candidate, scores) {
            if (scores.match_score >= 60) return '条件が概ね一致しており、有力な候補です。';
            if (scores.skill_match_score >= 70) return 'スキルセットがマッチしていますが、他の条件で調整が必要です。';
            return '一部要件を満たしていませんが、ポテンシャル採用として検討可能です。'
        }

        function extractClientSideJobRequirements(job) {
            return { title: job.title, skills: extractClientSideSkills(job.requirements || '') };
        }
        function extractClientSideCandidateStrengths(candidate) {
            return { name: candidate.name, skills: extractClientSideSkills(candidate.skills || '') };
        }
        function identifyClientSideMatchPoints(job, candidate, scores) {
            const pts = [];
            if (scores.skill_match_score >= 60) pts.push('スキル');
            if (scores.experience_match_score >= 60) pts.push('経験');
            return pts;
        }

        // 既存のマッチング結果を読み込み
        async function loadJobMatches() {
            if (!window.currentJobId || !currentUser) return;

            try {
                const { data, error } = await window.supabase
                    .from('job_candidate_matches')
                    .select('*, users(*)')
                    .eq('job_id', window.currentJobId)
                    .eq('organization_id', currentUser.organization_id)
                    .gte('match_score', 50)
                    .order('match_score', { ascending: false })
                    .limit(30);

                if (error) throw error;

                jobMatchesCache = data || [];

                // 候補者数を表示
                $('#job-candidates-count').text(jobMatchesCache.length);

                if (jobMatchesCache.length > 0) {
                    renderJobCandidates(jobMatchesCache);
                }

            } catch (error) {
                console.error('Load matches error:', error);
            }
        }

        // 共通マッチング結果レンダリング関数
        function renderMatchingResults(matches, containerSelector) {
            const container = $(containerSelector);
            container.empty();

            if (!matches || matches.length === 0) {
                container.html(`
            <div class="text-center py-12 text-gray-500 shadow-sm border rounded-lg bg-white">
                        <i class="fas fa-search text-4xl mb-3"></i>
                        <p>マッチする候補者が見つかりませんでした</p>
                    </div>
            `);
                return;
            }

            const okMatches = matches.filter(m => m.match_score > 49);
            const ngMatches = matches.filter(m => m.match_score <= 49);

            const containerId = containerSelector.replace('#', '');

            const headerHtml = `
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden mb-6">
                <div class="flex border-b border-gray-100 items-center">
                    <button onclick="switchMatchTab('${containerSelector}', 'ok')"
                        id="${containerId}-tab-ok"
                        class="flex-1 py-4 px-6 text-sm font-bold border-b-2 border-green-500 text-green-600 transition-all hover:bg-green-50">
                        <i class="fas fa-check-circle mr-2"></i>マッチ: ${okMatches.length}件
                    </button>
                    <button onclick="switchMatchTab('${containerSelector}', 'ng')"
                        id="${containerId}-tab-ng"
                        class="flex-1 py-4 px-6 text-sm font-bold border-b-2 border-transparent text-gray-400 transition-all hover:bg-gray-50">
                        <i class="fas fa-times-circle mr-2"></i>NG: ${ngMatches.length}件
                    </button>
                    <div class="px-4 border-l border-gray-100">
                        <button onclick="$('${containerSelector}').html('<div class=\\'text-center py-12 text-gray-500 rounded-lg border bg-white shadow-sm\\'><i class=\\'fas fa-search text-4xl mb-3\\'></i><p>条件を指定して検索してください</p></div>')"
                            class="text-xs text-gray-400 hover:text-red-500 flex flex-col items-center gap-1 transition-colors">
                            <i class="fas fa-trash-alt"></i>
                            <span>クリア</span>
                        </button>
                    </div>
                </div>
                </div>

                <div id="${containerId}-pane-ok" class="space-y-4">
                    ${okMatches.length > 0 ? okMatches.map(m => renderCandidateCard(m)).join('') : `
                        <div class="text-center py-16 bg-white border border-dashed border-gray-300 rounded-lg text-gray-400">
                            <i class="fas fa-info-circle mb-2 text-2xl"></i>
                            <p>マッチする候補者は見つかりませんでした</p>
                        </div>
                    `}
                </div>
                <div id="${containerId}-pane-ng" class="space-y-4 hidden">
                    ${ngMatches.length > 0 ? ngMatches.map(m => renderCandidateCard(m)).join('') : `
                        <div class="text-center py-16 bg-white border border-dashed border-gray-300 rounded-lg text-gray-400">
                            <i class="fas fa-info-circle mb-2 text-2xl"></i>
                            <p>NG候補者はいません</p>
                        </div>
                    `}
                </div>
        `;

            container.html(headerHtml);
        }

        window.switchMatchTab = function (containerSelector, tab) {
            const containerId = containerSelector.replace('#', '');
            const tabOk = $(`#${containerId}-tab-ok`);
            const tabNg = $(`#${containerId}-tab-ng`);
            const paneOk = $(`#${containerId}-pane-ok`);
            const paneNg = $(`#${containerId}-pane-ng`);

            if (tab === 'ok') {
                tabOk.addClass('border-green-500 text-green-600').removeClass('border-transparent text-gray-400');
                tabNg.addClass('border-transparent text-gray-400').removeClass('border-red-500 text-red-600'); // red-500 if we want NG to be red, but image shows gray
                // Applying gray style for non-active as default in HTML, so here just toggle
                tabNg.addClass('border-transparent text-gray-400').removeClass('border-gray-600 text-gray-800');

                paneOk.removeClass('hidden');
                paneNg.addClass('hidden');
            } else {
                tabNg.addClass('border-gray-600 text-gray-800').removeClass('border-transparent text-gray-400');
                tabOk.addClass('border-transparent text-gray-400').removeClass('border-green-500 text-green-600');

                paneNg.removeClass('hidden');
                paneOk.addClass('hidden');
            }
        }

        // 候補者リストを表示 (Deprecated: use renderMatchingResults)
        function renderJobCandidates(matches) {
            renderMatchingResults(matches, '#job-candidates-list');
        }

        // 候補者カードを生成
        function renderCandidateCard(match) {
            const candidate = match.users || match.candidate || {};
            const matchScore = match.match_score || 0;
            const skillScore = match.skill_match_score || 0;
            const expScore = match.experience_match_score || 0;
            const locScore = match.location_match_score || 0;
            const salScore = match.salary_match_score || 0;
            const culScore = match.culture_match_score || 0;

            // スコアに応じた色
            // スコアに応じた色
            const getScoreColor = (score) => {
                if (score >= 80) return 'text-green-600 bg-green-50';
                if (score >= 60) return 'text-blue-600 bg-blue-50';
                if (score >= 50) return 'text-yellow-600 bg-yellow-50';
                return 'text-gray-500 bg-gray-100 border border-gray-200'; // NG (<= 49)
            };

            const getScoreBarColor = (score) => {
                if (score >= 80) return 'bg-green-500';
                if (score >= 60) return 'bg-blue-500';
                if (score >= 50) return 'bg-yellow-500';
                return 'bg-gray-300';
            };

            const renderScoreBar = (label, score, colorClass) => {
                return `
            <div class="text-center">
                        <div class="text-xs text-gray-500 mb-1">${label}</div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mb-1">
                            <div class="${colorClass} h-2 rounded-full transition-all" style="width: ${score}%"></div>
                        </div>
                        <div class="text-xs font-semibold text-gray-700">${score.toFixed(0)}%</div>
                    </div>
            `;
            };

            return `
            <div class="border rounded-lg p-6 hover:shadow-lg transition bg-white">
                <div class="flex justify-between items-start gap-4">
                    <div class="mr-2 pt-1 flex flex-col items-center">
                        <input type="checkbox"
                            class="candidate-select-checkbox h-5 w-5 rounded border-gray-300 focus:ring-indigo-500 cursor-pointer ${candidate.status === 'suspended' ? 'text-gray-400 bg-gray-100 cursor-not-allowed opacity-50' : 'text-indigo-600'}"
                            value="${candidate.id}"
                            ${candidate.status === 'suspended' ? 'disabled' : ''}>
                            ${candidate.status === 'suspended' ? '<span class="text-[10px] text-red-500 font-bold mt-1 nowrap">停止中</span>' : ''}
                    </div>
                    <div class="flex-1">
                        <!-- ヘッダー -->
                        <div class="flex items-center gap-3 mb-3">
                            <h4 class="font-semibold text-lg text-gray-900">${candidate.name || '名前未設定'}</h4>
                            <span class="px-3 py-1 ${getScoreColor(matchScore)} rounded-full text-sm font-medium">
                                マッチ度: ${matchScore.toFixed(1)}%
                            </span>
                            <span class="px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full ${candidate.management_status === 'inactive' ? 'bg-gray-200 text-gray-700' : 'bg-blue-100 text-blue-800'}">
                                ${candidate.management_status === 'inactive' ? '活動終了' : '活動中'}
                            </span>
                        </div>

                        <!-- 基本情報 -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-4 text-sm text-gray-600">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-briefcase text-gray-400"></i>
                                <span>${window.formatArrayValue(candidate.desired_job_type)}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-map-marker-alt text-gray-400"></i>
                                <span>${window.formatArrayValue(candidate.desired_location)}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-yen-sign text-gray-400"></i>
                                <span>${window.formatSalaryValue(candidate.desired_salary)}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-envelope text-gray-400"></i>
                                <span class="text-xs">${candidate.email || ''}</span>
                            </div>
                        </div>

                        <!-- マッチング詳細スコア -->
                        <div class="mb-4">
                            <div class="text-xs text-gray-500 mb-2">詳細スコア</div>
                            <div class="grid grid-cols-5 gap-2">
                                ${renderScoreBar('スキル', skillScore, getScoreBarColor(skillScore))}
                                ${renderScoreBar('経験', expScore, getScoreBarColor(expScore))}
                                ${renderScoreBar('勤務地', locScore, getScoreBarColor(locScore))}
                                ${renderScoreBar('年収', salScore, getScoreBarColor(salScore))}
                                ${renderScoreBar('文化', culScore, getScoreBarColor(culScore))}
                            </div>
                        </div>

                        <!-- AI評価理由 -->
                        ${match.recommendation_reason ? `
                            <div class="${matchScore >= 50 ? 'bg-blue-50 border-blue-400' : 'bg-gray-50 border-gray-400'} border-l-4 p-3 mb-3">
                                <div class="flex items-start gap-2">
                                    <i class="fas ${matchScore >= 50 ? 'fa-lightbulb text-blue-600' : 'fa-clipboard-list text-gray-500'} mt-1"></i>
                                    <div class="flex-1">
                                        <p class="text-sm ${matchScore >= 50 ? 'text-blue-800' : 'text-gray-700'} font-medium">AI評価理由</p>
                                        <p class="text-sm ${matchScore >= 50 ? 'text-blue-700' : 'text-gray-600'}">${match.recommendation_reason}</p>
                                    </div>
                                </div>
                            </div>
                            ` : ''}

                        <!-- スキル -->
                        ${candidate.skills ? `
                            <div class="text-sm">
                                <span class="text-gray-600">スキル:</span>
                                <span class="text-gray-800">${window.formatArrayValue(candidate.skills)}</span>
                            </div>
                            ` : ''}
                    </div>

                    <!-- アクションボタン -->
                    <div class="flex flex-col gap-2">
                        <button onclick="viewCandidateProfile('${candidate.id}')" class="px-4 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 text-sm whitespace-nowrap">
                            <i class="fas fa-user mr-1"></i>詳細
                        </button>
                        <button onclick="showAdminUserModal('${candidate.id}')" class="px-4 py-2 bg-amber-50 text-amber-700 border border-amber-200 rounded hover:bg-amber-100 text-sm whitespace-nowrap">
                            <i class="fas fa-edit mr-1"></i>ユーザー編集
                        </button>
                        <button onclick="openScoutModal('${match.id || ''}', '${candidate.id}')" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm whitespace-nowrap shadow-sm">
                            <i class="fas fa-magic mr-1"></i>スカウト作成
                        </button>
                        <button onclick="updateMatchStatus('${match.id || ''}', 'not_interested', '${candidate.id}')"
                            class="px-4 py-2 bg-red-100 text-red-700 rounded hover:bg-red-200 text-sm whitespace-nowrap">
                            <i class="fas fa-times mr-1"></i>対象外
                        </button>
                    </div>
                </div>
                </div>
            `;
        }

        // スカウトモーダル関連の変数
        let currentScoutMatchId = null;
        let currentScoutCandidateId = null;

        // スカウトモーダルを開く（AI生成実行）
        window.openScoutModal = async function (matchId, candidateId) {
            console.log('openScoutModal called:', { matchId, candidateId });

            let actualJobId = window.selectedTargetJobId || window.currentJobId;
            if (!actualJobId) {
                alert('対象の求人が選択されていません');
                return;
            }

            let targetMatchId = (matchId && matchId !== 'undefined') ? matchId : null;

            // マッチレコードがない場合は作成を試みる
            if (!targetMatchId) {
                showLoading('準備中...');
                try {
                    // 既存のマッチレコードを確認
                    const { data: existing, error: checkError } = await window.supabase
                        .from('job_candidate_matches')
                        .select('id')
                        .eq('job_id', actualJobId)
                        .eq('candidate_id', candidateId)
                        .maybeSingle();

                    if (checkError) throw checkError;

                    if (existing) {
                        targetMatchId = existing.id;
                    } else {
                        // 新規作成
                        const { data, error } = await window.supabase
                            .from('job_candidate_matches')
                            .insert({
                                job_id: actualJobId,
                                candidate_id: candidateId,
                                status: 'draft',
                                organization_id: currentUser.organization_id
                            })
                            .select('id')
                            .single();

                        if (error) throw error;
                        targetMatchId = data.id;
                    }
                } catch (e) {
                    console.error('Failed to create match for scout:', e);
                    alert('準備に失敗しました: ' + e.message);
                    hideLoading();
                    return;
                } finally {
                    hideLoading();
                }
            }

            console.log('Match ID obtained:', targetMatchId);
            currentScoutMatchId = targetMatchId;
            currentScoutCandidateId = candidateId;

            // 候補者名を表示
            let candidateName = '候補者';
            // キャッシュから探す
            if (typeof jobMatchesCache !== 'undefined') {
                const m = jobMatchesCache.find(m => m.id === targetMatchId || (m.candidate && m.candidate.id === candidateId) || (m.users && m.id === targetMatchId));
                if (m) candidateName = (m.users ? m.users.name : (m.candidate ? m.candidate.name : '候補者'));
            }
            if (candidateName === '候補者') {
                // さらに詳細ボタン等から取得を試みる
                candidateName = $(`button[onclick *= "'${candidateId}'"]`).closest('.border').find('h3, .text-lg.font-bold').first().text().trim() || '候補者';
            }

            console.log('Candidate name:', candidateName);
            $('#scout-candidate-name').text(candidateName);

            // モーダルを表示（ローディング状態）
            console.log('Opening scout modal...');
            $('#scout-subject').val('生成中...');
            $('#scout-body').val('AIがスカウト文面を生成しています...\n少々お待ちください。');

            // スクロールを最上部に移動
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // モーダルをbodyの直下に移動（親要素のhiddenクラスの影響を受けないようにする）
            const modal = document.getElementById('scout-modal');
            if (modal && modal.parentElement.id !== 'body') {
                document.body.appendChild(modal);
            }

            // モーダルを表示
            $('#scout-modal').removeClass('hidden').css('display', 'flex');

            // モーダルが表示されているか確認
            const isVisible = !$('#scout-modal').hasClass('hidden');
            const displayStyle = $('#scout-modal').css('display');
            console.log('Modal visibility after opening:', isVisible);
            console.log('Modal display style:', displayStyle);
            console.log('Modal element:', $('#scout-modal')[0]);

            // モーダルにフォーカスを当てる
            $('#scout-modal').focus();

            console.log('Calling generateScoutMessage...');
            await generateScoutMessage(actualJobId, currentScoutCandidateId, currentScoutMatchId);
            console.log('generateScoutMessage completed');

            // モーダルがまだ表示されているか確認
            setTimeout(() => {
                const stillVisible = !$('#scout-modal').hasClass('hidden');
                console.log('Modal still visible after 100ms:', stillVisible);
                if (!stillVisible) {
                    console.error('Modal was closed unexpectedly!');
                }
            }, 100);
        }

        // スカウト文面生成（再生成）
        window.regenerateScoutMessage = async function () {
            if (!currentScoutMatchId) return;
            const actualJobId = window.selectedTargetJobId || window.currentJobId;

            $('#scout-body').val('AIがスカウト文面を再生成しています...');
            await generateScoutMessage(actualJobId, currentScoutCandidateId, currentScoutMatchId);
        }

        // Edge Functionを呼び出して文面生成
        async function generateScoutMessage(jobId, candidateId, matchId) {
            console.log('generateScoutMessage called with:', { jobId, candidateId, matchId });

            if (!jobId || !candidateId) {
                console.error('generateScoutMessage: Missing jobId or candidateId', { jobId, candidateId });
                throw new Error('job_id and candidate_id are required');
            }
            try {
                console.log('Calling Edge Function: generate-scout-message');
                const { data, error } = await window.supabase.functions.invoke('generate-scout-message', {
                    body: {
                        job_id: jobId,
                        candidate_id: candidateId,
                        match_id: matchId
                    }
                });

                console.log('Edge Function response:', { data, error });

                if (error) throw error;

                if (data.success) {
                    console.log('Scout message generated successfully');
                    $('#scout-subject').val(data.subject);
                    // エスケープされた改行文字を実際の改行に変換
                    const bodyWithNewlines = data.body.replace(/\\n/g, '\n');
                    $('#scout-body').val(bodyWithNewlines);
                } else {
                    throw new Error(data.error || '生成に失敗しました');
                }

            } catch (error) {
                console.error('Scout generation error:', error);
                alert('スカウト文面の生成に失敗しました: ' + error.message);
                $('#scout-body').val('生成に失敗しました。手動で入力してください。');
            }
        }

        // スカウトモーダルを閉じる
        window.closeScoutModal = function () {
            console.log('closeScoutModal called');
            console.trace('Stack trace:');
            $('#scout-modal').addClass('hidden').css('display', 'none');
            currentScoutMatchId = null;
            currentScoutCandidateId = null;
        }

        // スカウト送信処理
        window.sendScoutMessage = async function () {
            if (!currentScoutMatchId) return;

            const subject = $('#scout-subject').val();
            const body = $('#scout-body').val();

            if (!subject || !body) {
                alert('件名と本文を入力してください');
                return;
            }

            if (!confirm('この内容でスカウトを送信しますか？')) {
                return;
            }

            try {
                showLoading('スカウト送信中...');

                // 1. ステータスを更新
                await updateMatchStatus(currentScoutMatchId, 'contacted');

                // 2. 候補者のメールアドレスを取得
                const { data: candidate, error: userError } = await supabase
                    .from('users')
                    .select('email, name')
                    .eq('id', currentScoutCandidateId)
                    .single();

                if (userError || !candidate) {
                    console.warn('候補者情報の取得失敗:', userError);
                    alert('ステータスは更新されましたが、候補者のメールアドレスが取得できなかったためメールは送信されませんでした。');
                } else if (!candidate.email) {
                    alert('ステータスは更新されましたが、候補者のメールアドレスが未登録のためメールは送信されませんでした。');
                } else {
                    // 3. メール送信Function呼び出し (Resend)
                    const { data: emailData, error: emailError } = await supabase.functions.invoke('send-email', {
                        body: {
                            type: 'scout',
                            to: candidate.email,
                            data: {
                                userName: candidate.name || '求職者',
                                subject: subject,
                                body: body,
                                scoutUrl: window.location.origin // ログインページなどのURL
                            }
                        }
                    });

                    if (emailError) {
                        console.error('Email sending failed:', emailError);
                        alert('ステータスは更新されましたが、メール送信APIの呼び出しに失敗しました。\n(Resend API Keyの設定等をご確認ください)');
                    } else {
                        console.log('Email sent successfully:', emailData);
                        alert('スカウトを送信しました！\n(候補者へメール通知を行いました)');
                    }
                }

                closeScoutModal();

            } catch (error) {
                console.error('Send scout error:', error);
                alert('送信処理に失敗しました: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // マッチングステータス更新
        window.updateMatchStatus = async function (matchId, status, candidateId) {
            let targetMatchId = (matchId && matchId !== 'undefined' && matchId !== '') ? matchId : null;
            let jobId = (typeof selectedTargetJobId !== 'undefined' ? selectedTargetJobId : null) || window.selectedTargetJobId || window.currentJobId;

            try {
                if (!targetMatchId) {
                    if (!jobId || !candidateId) {
                        alert('対象の求人または候補者を特定できません');
                        return;
                    }

                    const { data, error } = await window.supabase
                        .from('job_candidate_matches')
                        .upsert({
                            job_id: jobId,
                            candidate_id: candidateId,
                            status: status,
                            organization_id: currentUser.organization_id
                        }, { onConflict: 'job_id, candidate_id' })
                        .select('id')
                        .single();

                    if (error) throw error;
                    targetMatchId = data.id;
                } else {
                    const { error } = await window.supabase
                        .from('job_candidate_matches')
                        .update({ status: status })
                        .eq('id', targetMatchId);

                    if (error) throw error;
                }

                // 画面上の表示を更新
                if (status === 'not_interested') {
                    // 対象外の場合はカードをグレーアウトしてボタンを無効化
                    // セレクタを柔軟に（IDがある場合とない場合両方対応）
                    let selector = `button[onclick *= "'${targetMatchId}', 'not_interested'"]`;
                    if (candidateId) selector += `, button[onclick *= "'${candidateId}')"]`;

                    const card = $(selector).closest('.border');
                    card.addClass('opacity-50 bg-gray-100');
                    card.find('button').prop('disabled', true);
                    card.find('.status-badge').remove();
                    card.find('.flex.justify-between').append('<span class="status-badge px-2 py-1 bg-red-100 text-red-800 text-xs rounded">対象外</span>');
                }

            } catch (error) {
                console.error('Update match status error:', error);
                alert('ステータスの更新に失敗しました');
                throw error;
            }
        }
        // ヘルパー関数: JSON配列文字列かもしれない値をパースして配列または文字列として返す
        window.safeParseList = function (val) {
            if (!val) return null;
            if (Array.isArray(val)) return val;
            if (typeof val === 'string') {
                val = val.trim();
                if (val.startsWith('[') && val.endsWith(']')) {
                    try {
                        return JSON.parse(val);
                    } catch (e) {
                        // シングルクォートの場合や、不正なJSONの場合のリカバリ
                        try {
                            // シングルクォートをダブルクォートに置換して再トライ
                            return JSON.parse(val.replace(/'/g, '"'));
                        } catch (e2) {
                            return val;
                        }
                    }
                }
            }
            return val;
        }

        // ヘルパー関数: 配列または文字列を表示用にフォーマット
        window.formatArrayValue = function (val) {
            const parsed = window.safeParseList(val);
            if (Array.isArray(parsed)) {
                return parsed.join(' / ');
            }
            return parsed || '-';
        }

        // ヘルパー関数: 年収を表示用にフォーマット (万円単位)
        window.formatSalaryValue = function (val) {
            if (!val) return '-';
            // 数値以外を除去
            const strVal = String(val).replace(/[^0-9]/g, '');
            if (!strVal) return val; // 数値が含まれない場合はそのまま返す

            let num = parseInt(strVal);
            if (isNaN(num)) return val;

            // 10万円以上の場合は円単位とみなして10000で割る
            if (num >= 100000) {
                num = Math.round(num / 10000);
            }
            return num.toLocaleString() + '万円';
        }

        // 候補者プロフィール表示（プレビュー専用）
        window.viewCandidateProfile = async function (candidateId) {
            if (!candidateId) {
                alert('候補者IDが取得できません');
                return;
            }

            $('#interview-candidate-id').val(candidateId);
            showLoading();

            showLoading();
            try {
                // 候補者情報を取得
                const { data: userData, error } = await window.supabase
                    .from('users')
                    .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                    .eq('id', candidateId)
                    .single();

                if (error) throw error;
                if (!userData) {
                    alert('候補者情報が見つかりませんでした');
                    return;
                }

                // プロフィールデータを結合（フラット化）
                const profile = Array.isArray(userData.candidate_profiles) ? userData.candidate_profiles[0] : (userData.candidate_profiles || {});
                const candidate = { ...userData, ...profile };

                $('#candidate-detail-title').text(candidate.name || '名前未設定');
                $('#candidate-email-header').text(candidate.email || '');
                $('#candidate-avatar-header').text(candidate.name ? candidate.name.charAt(0) : '?');

                // ヘッダーメタ情報 (年齢、性別、居住地)
                const metaParts = [];
                if (candidate.age) metaParts.push(`${candidate.age}歳`);
                if (candidate.gender) metaParts.push(candidate.gender);
                if (candidate.current_location) metaParts.push(candidate.current_location);

                if (metaParts.length > 0) {
                    $('#candidate-header-meta').text(metaParts.join(' / ')).show();
                } else {
                    $('#candidate-header-meta').hide();
                }

                // プレビューコンテンツを生成 (ヘッダー情報を除いた詳細)
                const content = `
                    <!-- 1. 希望条件 -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-star mr-2 text-yellow-500"></i>希望条件
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600 mb-1">希望職種</p>
                                <p class="font-medium text-gray-900">${window.formatArrayValue(candidate.desired_job_type)}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-1">希望勤務地</p>
                                <p class="font-medium text-gray-900">${window.formatArrayValue(candidate.desired_location)}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-1">希望年収</p>
                                <p class="font-medium text-gray-900 text-lg text-indigo-600">
                                    ${window.formatSalaryValue(candidate.desired_salary)}
                                </p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-1">雇用形態</p>
                                <p class="font-medium text-gray-900">${window.formatArrayValue(candidate.desired_employment_type)}</p>
                            </div>
                            <div class="col-span-1 md:col-span-2">
                                <p class="text-sm text-gray-600 mb-2">こだわり条件</p>
                                <div class="flex flex-wrap gap-2">
                                    ${candidate.desired_job_experience_ok ? '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">職種未経験OK</span>' : ''}
                                    ${candidate.desired_industry_experience_ok ? '<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">業界未経験OK</span>' : ''}
                                    ${!candidate.desired_job_experience_ok && !candidate.desired_industry_experience_ok ? '<span class="text-gray-400 text-sm">-</span>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. スキル -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-code mr-2 text-blue-500"></i>スキル
                        </h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-gray-800 whitespace-pre-wrap text-sm leading-relaxed">${candidate.skills || '-'}</p>
                        </div>
                    </div>

                    <!-- 3. 職歴概要 -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-briefcase mr-2 text-green-500"></i>職歴概要
                        </h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-gray-800 whitespace-pre-wrap text-sm leading-relaxed">${candidate.work_history || '-'}</p>
                        </div>
                    </div>

                    <!-- 4. 履歴情報 -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-history mr-2 text-indigo-500"></i>履歴情報
                        </h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-gray-800 whitespace-pre-wrap text-sm leading-relaxed">${candidate.history_info || '-'}</p>
                        </div>
                    </div>

                    <!-- 5. 社内マッチング情報 -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-file-alt mr-2 text-gray-500"></i>社内マッチング情報
                        </h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-gray-800 whitespace-pre-wrap text-sm leading-relaxed">${candidate.resume || '-'}</p>
                        </div>
                    </div>

                    <!-- 6. 社内メモ・共有事項 -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-user-circle mr-2 text-pink-500"></i>社内メモ・共有事項
                        </h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-gray-800 whitespace-pre-wrap text-sm leading-relaxed">${candidate.notes || candidate.self_pr || '-'}</p>
                        </div>
                    </div>

                    <!-- その他基本情報 (必要最低限) -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-info-circle mr-2 text-gray-500"></i>基本情報
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600 mb-1">年齢</p>
                                <p class="font-medium text-gray-900">${candidate.age ? candidate.age + '歳' : '-'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-1">学歴</p>
                                <p class="font-medium text-gray-900">${candidate.education || '-'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-1">電話番号</p>
                                <p class="font-medium text-gray-900">${candidate.phone || '-'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-1">登録日</p>
                                <p class="font-medium text-gray-900">${new Date(candidate.created_at).toLocaleDateString('ja-JP')}</p>
                            </div>
                        </div>
                    </div>
                `;

                console.log('Final step: Rendering to candidate preview and forcing visibility.');
                $('#candidate-preview-content').html(content);

                const modal = $('#candidate-preview-modal');
                if (modal.length === 0) {
                    console.error('CRITICAL: #candidate-preview-modal not found!');
                    return;
                }
                // Move to body to avoid parent clipping/z-index issues
                $('body').append(modal);

                console.log('Updating candidate preview visibility...');
                modal.removeClass('hidden').attr('style', 'display: flex !important; z-index: 40000 !important; visibility: visible !important; opacity: 1 !important;');

                // 集約画面用のデータロード
                loadInterviewHistory(candidateId);
                loadSelectionProgress(candidateId);

                console.log('viewCandidateProfile process complete');

            } catch (error) {
                console.error('Load candidate error:', error);
                alert('候補者情報の取得に失敗しました');
            } finally {
                hideLoading();
            }
        }

        // 候補者プレビューを閉じる
        window.closeCandidatePreview = function () {
            console.log('--- closeCandidatePreview Triggered ---');
            $('#candidate-preview-modal').addClass('hidden').attr('style', 'display: none !important;');
        }

        // --- 候補者詳細タブ切り替え ---
        window.switchCandidateDetailTab = function (tab) {
            $('.candidate-tab-content').addClass('hidden');
            $('.candidate-tab-btn').removeClass('active border-indigo-500 text-indigo-600').addClass('border-transparent text-gray-500');

            $(`#tab-content-${tab}`).removeClass('hidden');
            $(`#btn-tab-${tab}`).addClass('active border-indigo-500 text-indigo-600').removeClass('border-transparent text-gray-500');

            const candidateId = $('#interview-candidate-id').val();
            if (candidateId) {
                if (tab === 'interviews') loadInterviewHistory(candidateId);
                if (tab === 'progress') loadSelectionProgress(candidateId);
            }
        }

        // --- 面談履歴機能 ---
        window.openInterviewRecordModal = function () {
            const candidateId = $('#interview-candidate-id').val() || $('#admin-user-id').val();
            console.log('Opening interview record modal for candidate:', candidateId);
            if (!candidateId) {
                alert('候補者が特定できません');
                return;
            }

            const modal = $('#interview-record-modal');
            $('body').append(modal); // Ensure it's at body level

            $('#interview-id').val('');
            $('#interview-candidate-id').val(candidateId);
            $('#interview-date').val(new Date().toISOString().split('T')[0]);
            $('#interview-content').val('');
            $('#interview-next-action').val('');

            modal.removeClass('hidden').attr('style', 'display: flex !important; z-index: 50000 !important;');
        }

        window.closeInterviewRecordModal = function () {
            console.log('Closing interview record modal');
            const modal = $('#interview-record-modal');
            modal.addClass('hidden').attr('style', 'display: none !important;');

            // 状態リセット
            $('#interview-id').val('');
            $('#interview-content').val('');
            $('#interview-next-action').val('');
        }

        window.editInterviewRecord = async function (interviewId) {
            showLoading();
            try {
                const { data, error } = await supabase
                    .from('candidate_interviews')
                    .select('*')
                    .eq('id', interviewId)
                    .single();

                if (error) throw error;

                const modal = $('#interview-record-modal');
                $('body').append(modal);

                $('#interview-id').val(data.id);
                $('#interview-candidate-id').val(data.candidate_id);
                $('#interview-date').val(data.interview_date);
                $('#interview-type').val(data.interview_type);
                $('#interview-content').val(data.content);
                $('#interview-next-action').val(data.next_action);

                modal.removeClass('hidden').attr('style', 'display: flex !important; z-index: 50000 !important;');
            } catch (err) {
                console.error('Edit interview error:', err);
                alert('面談詳細の取得に失敗しました');
            } finally {
                hideLoading();
            }
        }

        // 面談履歴保存 (委譲を使用してイベントを確実にする)
        $(document).off('submit', '#interview-record-form').on('submit', '#interview-record-form', async function (e) {
            e.preventDefault();
            console.log('Submitting interview record form');

            const candidateId = $('#interview-candidate-id').val();
            const interviewId = $('#interview-id').val();
            const date = $('#interview-date').val();
            const type = $('#interview-type').val();
            const content = $('#interview-content').val();
            const nextAction = $('#interview-next-action').val();

            if (!currentUser) {
                alert('ユーザー情報が取得できません。再度ログインしてください。');
                return;
            }
            if (!candidateId) {
                alert('候補者情報が取得できません');
                return;
            }

            showLoading('保存中...');
            try {
                const interviewData = {
                    organization_id: currentUser.organization_id,
                    candidate_id: candidateId,
                    interviewer_id: currentUser.id,
                    interview_date: date,
                    interview_type: type,
                    content: content,
                    next_action: nextAction
                };

                let result;
                if (interviewId) {
                    result = await supabase
                        .from('candidate_interviews')
                        .update(interviewData)
                        .eq('id', interviewId);
                } else {
                    result = await supabase
                        .from('candidate_interviews')
                        .insert(interviewData);
                }

                if (result.error) throw result.error;

                alert('面談履歴を保存しました');
                closeInterviewRecordModal();
                loadInterviewHistory(candidateId);
            } catch (err) {
                console.error('Save interview history error:', err);
                alert('保存に失敗しました: ' + err.message);
            } finally {
                hideLoading();
            }
        });

        // 面談履歴ロード
        async function loadInterviewHistory(candidateId) {
            const container = $('#interview-list-container');
            container.html('<div class="text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>読み込み中...</div>');

            try {
                const { data, error } = await supabase
                    .from('candidate_interviews')
                    .select('*, users!interviewer_id(name)')
                    .eq('candidate_id', candidateId)
                    .order('interview_date', { ascending: false });

                if (error) throw error;

                if (!data || data.length === 0) {
                    container.html('<div class="text-center py-8 text-gray-500"><i class="fas fa-comments text-3xl mb-2 block"></i><p>面談履歴はありません</p></div>');
                    return;
                }

                const html = data.map(item => `
                    <div class="bg-white border border-gray-200 rounded-lg p-5 shadow-sm hover:shadow-md transition-shadow group">
                        <div class="flex justify-between items-start mb-3">
                            <span class="px-3 py-1 bg-indigo-50 text-indigo-700 text-xs font-bold rounded-full">${item.interview_type}</span>
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-500 font-medium">${new Date(item.interview_date).toLocaleDateString('ja-JP')}</span>
                                <button onclick="editInterviewRecord('${item.id}')" class="text-gray-400 hover:text-indigo-600 transition-colors opacity-0 group-hover:opacity-100">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                        <div class="text-sm text-gray-800 whitespace-pre-wrap leading-relaxed mb-4">${item.content}</div>
                        ${item.next_action ? `
                        <div class="bg-amber-50 border-l-4 border-amber-400 p-3 text-sm">
                            <p class="font-bold text-amber-800 mb-1"><i class="fas fa-bolt mr-2"></i>ネクストアクション</p>
                            <p class="text-amber-700">${item.next_action}</p>
                        </div>
                        ` : ''}
                        <div class="mt-4 pt-3 border-t flex justify-end">
                            <span class="text-xs text-gray-400">担当: ${item.users?.name || '不明'}</span>
                        </div>
                    </div>
                `).join('');

                container.html(html);
            } catch (err) {
                console.error('Load interview history error:', err);
                container.html('<div class="text-center py-8 text-red-500">履歴の取得に失敗しました</div>');
            }
        }

        // --- 選考進捗機能 ---
        async function loadSelectionProgress(candidateId) {
            const container = $('#selection-progress-container');
            container.html('<div class="text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>読み込み中...</div>');

            try {
                const { data, error } = await supabase
                    .from('applications')
                    .select('*, jobs(*, companies(name))')
                    .eq('user_id', candidateId)
                    .order('updated_at', { ascending: false });

                if (error) throw error;

                // ステータスマスタを取得
                const { data: statusMasters } = await supabase
                    .from('master_data')
                    .select('label, value')
                    .eq('type', 'application_status')
                    .order('sort_order');

                const statuses = statusMasters && statusMasters.length > 0
                    ? statusMasters.map(m => m.label)
                    : ['書類選考中', '書類選考通過', '一次面接予定', '一次面接完了', '二次面接予定', '二次面接完了', '最終面接予定', '最終面接完了', '内定', '内定承諾', '入社確認済', '選考終了（書類）', '選考終了（面接）', '選考終了（内定辞退）', '選考終了（充足クローズ）', '選考終了（その他）'];

                if (!data || data.length === 0) {
                    container.html('<div class="text-center py-8 text-gray-500"><i class="fas fa-tasks text-3xl mb-2 block"></i><p>進行中の選考はありません</p></div>');
                    return;
                }

                const html = data.map(app => {
                    const job = app.jobs;
                    const companyName = job?.companies?.name || job?.company || '不明';

                    return `
                    <div class="bg-white border rounded-lg p-5 shadow-sm">
                        <div class="flex justify-between items-start gap-4 mb-4">
                            <div>
                                <h5 class="font-bold text-lg text-gray-900">${job?.title || '不明な求人'}</h5>
                                <p class="text-sm text-gray-600">${companyName}</p>
                            </div>
                            <div class="bg-indigo-50 text-indigo-700 px-4 py-2 rounded-lg font-bold">
                                ${app.status}
                            </div>
                        </div>
                        
                        <div class="pt-4 border-t space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wider">選考ステータスの変更</label>
                                <div class="flex gap-2">
                                    <select onchange="updateCandidateSelectionStatus('${app.id}', this.value, '${candidateId}')" 
                                        class="flex-1 px-4 py-2 border rounded-lg text-sm bg-indigo-50 border-indigo-200 focus:ring-2 focus:ring-indigo-500">
                                        <option value="">ステータスを変更...</option>
                                        ${statuses.map(s => `<option value="${s}" ${app.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                }).join('');

                container.html(html);
            } catch (err) {
                console.error('Load selection progress error:', err);
                container.html('<div class="text-center py-8 text-red-500">進捗情報の取得に失敗しました</div>');
            }
        }

        // 選考ステータス更新
        window.updateCandidateSelectionStatus = async function (applicationId, newStatus, candidateId) {
            if (!newStatus) return;

            showLoading('更新中...');
            try {
                // 現在のステータスを取得（履歴用）
                const { data: currentApp } = await supabase
                    .from('applications')
                    .select('status')
                    .eq('id', applicationId)
                    .single();

                const oldStatus = currentApp?.status;

                // ステータス更新
                const { error } = await supabase
                    .from('applications')
                    .update({ status: newStatus, updated_at: new Date().toISOString() })
                    .eq('id', applicationId);

                if (error) throw error;

                // 履歴に追加 (progress_historyテーブルがあれば)
                try {
                    await supabase.from('progress_history').insert({
                        organization_id: currentUser.organization_id,
                        application_id: applicationId,
                        user_id: candidateId,
                        old_status: oldStatus,
                        new_status: newStatus,
                        changed_by: currentUser.id,
                        changed_by_name: currentUser.name
                    });
                } catch (histErr) {
                    console.warn('Failed to record progress history:', histErr);
                }

                alert('選考ステータスを更新しました');
                loadSelectionProgress(candidateId);
            } catch (err) {
                console.error('Update selection status error:', err);
                alert('更新に失敗しました: ' + err.message);
            } finally {
                hideLoading();
            }
        }

        // ============================================
        // 外部プロフィール解析機能
        // ============================================

        let uploadedFiles = [];
        let currentAnalysisHistoryId = null; // Store history ID for feedback

        window.openProfileAnalysisModal = function () {
            $('#profile-scout_management-tab-content').addClass('hidden');
            $('.profile-analysis-tab').removeClass('border-indigo-600 text-indigo-600').addClass('border-transparent text-gray-500');
            $('#profile-tab-new').removeClass('border-transparent text-gray-500').addClass('border-indigo-600 text-indigo-600');

            // イベントリスナーを設定
            setTimeout(() => {
                setupFileUploadHandlers();
            }, 100);
        }

        window.closeProfileAnalysisModal = function () {
            $('#profile-analysis-modal').addClass('hidden');
        }

        // ============================================
        // Scout Settings Modal Logic
        // ============================================

        window.openScoutSettingsModal = async function () {
            console.log('openScoutSettingsModal called');
            if (!currentUser) return;

            const modal = $('#scout-settings-modal');
            // Ensure modal is strict child of body for z-index to work
            if (modal.parent().get(0) !== document.body) {
                $('body').append(modal);
            }

            modal.removeClass('hidden').css('z-index', 10001);

            // Load current settings
            try {
                const { data, error } = await supabase
                    .from('user_scout_settings')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                if (data) {
                    $('#scout-style-active').prop('checked', data.is_active);
                    $('#scout-style-prompt').val(data.style_prompt || '');
                } else {
                    // No settings yet, reset to default
                    $('#scout-style-active').prop('checked', false);
                    $('#scout-style-prompt').val('');
                }
            } catch (e) {
                console.error('Error loading scout settings:', e);
            }
        }

        // タブ切り替え
        window.switchProfileAnalysisTab = function (tab) {
            // タブボタンのスタイル更新
            $('.profile-analysis-tab').removeClass('border-indigo-600 text-indigo-600').addClass('border-transparent text-gray-500');
            $(`#profile-tab-${tab}`).removeClass('border-transparent text-gray-500').addClass('border-indigo-600 text-indigo-600');

            // コンテンツの表示切り替え
            $('#profile-new-tab-content').addClass('hidden');
            $('#profile-history-tab-content').addClass('hidden');
            $('#profile-scout_management-tab-content').addClass('hidden');
            $('#profile-analytics-tab-content').addClass('hidden');

            if (tab === 'new') {
                $('#profile-new-tab-content').removeClass('hidden');
                setTimeout(() => {
                    setupFileUploadHandlers();
                }, 0);
            } else if (tab === 'history') {
                $('#profile-history-tab-content').removeClass('hidden');
                loadProfileAnalysisHistory();
            } else if (tab === 'scout_management') {
                $('#profile-scout_management-tab-content').removeClass('hidden');
                loadScoutManagement();
            } else if (tab === 'analytics') {
                $('#profile-analytics-tab-content').removeClass('hidden');
                loadScoutAnalytics();
            }
        }

        // 履歴読み込み
        window.loadProfileAnalysisHistory = async function () {
            if (!currentUser) return;

            $('#history-list').html(`
            <div class="text-center py-12 text-gray-500">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                    <p>履歴を読み込んでいます...</p>
                </div>
            `);

            try {
                // 1. 組織設定の取得
                const { data: orgData, error: orgError } = await window.supabase
                    .from('organizations')
                    .select('settings')
                    .eq('id', currentUser.organization_id)
                    .single();

                if (orgError) console.error('Org settings fetch error:', orgError); // Non-blocking

                const visibility = orgData?.settings?.analysis_history_visibility || 'all'; // Default to 'all'

                // 2. 統計データの取得 (個人 & 全体)
                // Note: RLSがOpenな状態前提。StrictなRLSの場合は別途RPCが必要になるが、現在はOpenModeと想定。
                const { count: myCount, error: myCountError } = await window.supabase
                    .from('profile_analysis_history')
                    .select('*', { count: 'exact', head: true })
                    .eq('organization_id', currentUser.organization_id)
                    .eq('analyzed_by', currentUser.id);

                const { count: orgCount, error: orgCountError } = await window.supabase
                    .from('profile_analysis_history')
                    .select('*', { count: 'exact', head: true })
                    .eq('organization_id', currentUser.organization_id);

                // 3. リストデータの取得
                let query = window.supabase
                    .from('profile_analysis_history')
                    .select('*')
                    .eq('organization_id', currentUser.organization_id)
                    .order('created_at', { ascending: false })
                    .limit(50);

                // Visibility制御: 'personal'なら自分のデータのみに絞る
                if (visibility === 'personal') {
                    query = query.eq('analyzed_by', currentUser.id);
                }

                const { data, error } = await query;

                if (error) throw error;

                // --- UI Rendering ---

                // 統計表示コンポーネント
                const statsHtml = `
            <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-indigo-50 rounded-lg p-4 text-center border border-indigo-100">
                            <p class="text-xs text-gray-500 font-bold mb-1">自分の解析数</p>
                            <p class="text-2xl font-bold text-indigo-700">${myCount || 0}<span class="text-sm font-normal text-gray-500 ml-1">件</span></p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 text-center border border-gray-200">
                            <p class="text-xs text-gray-500 font-bold mb-1">組織全体の解析数</p>
                            <p class="text-2xl font-bold text-gray-700">${orgCount || 0}<span class="text-sm font-normal text-gray-500 ml-1">件</span></p>
                        </div>
                    </div>
            `;

                if (!data || data.length === 0) {
                    $('#history-list').html(statsHtml + `
            <div class="text-center py-12 text-gray-500 border-t border-gray-100 mt-4">
                            <i class="fas fa-inbox text-4xl mb-3"></i>
                            <p>表示できる解析履歴がありません</p>
                        </div>
            `);
                    return;
                }

                // リスト表示
                $('#history-list').html(statsHtml + '<div class="space-y-4">' + renderHistoryListHtml(data) + '</div>');

            } catch (error) {
                console.error('Load history error:', error);
                $('#history-list').html(`
            <div class="text-center py-12 text-red-500">
                        <i class="fas fa-exclamation-triangle text-4xl mb-3"></i>
                        <p>履歴の読み込みに失敗しました</p>
                    </div>
            `);
            }
        }

        // ヘルパー関数: HTML生成部分を分離
        function renderHistoryListHtml(historyData) {
            return historyData.map(item => {
                const date = new Date(item.created_at).toLocaleString('ja-JP');
                let matches = item.matches;
                if (typeof matches === 'string') {
                    try { matches = JSON.parse(matches); } catch (e) { }
                }

                let matchCount = 0;
                if (matches && !Array.isArray(matches) && typeof matches === 'object') {
                    matchCount = (matches.skill?.length || 0) + (matches.industry?.length || 0) + (matches.mindset?.length || 0);
                } else if (Array.isArray(matches)) {
                    matchCount = matches.length;
                } else if (item.analysis_results) {
                    let ar = item.analysis_results;
                    if (typeof ar === 'string') { try { ar = JSON.parse(ar); } catch (e) { } }
                    matchCount = (ar.matches_skill?.length || 0) + (ar.matches_industry?.length || 0) + (ar.matches_mindset?.length || 0) + (ar.matches?.length || 0);
                }

                return `
            <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition cursor-pointer" onclick="viewHistoryDetail('${item.id}')">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1">
                        <p class="font-bold text-gray-900">${(item.title || item.candidate_summary || '候補者情報').substring(0, 60)}...</p>
                        <p class="text-xs text-gray-500 mt-1">
                            <i class="far fa-clock mr-1"></i>${date}
                        </p>
                    </div>
                    <span class="px-2 py-1 bg-indigo-50 text-indigo-600 text-xs font-semibold rounded">
                        ${matchCount}件の求人提案
                    </span>
                </div>
                </div>
            `;
            }).join('');
        }




        window.viewHistoryDetail = async function (historyId) {
            try {
                const { data, error } = await window.supabase
                    .from('profile_analysis_history')
                    .select('*')
                    .eq('id', historyId)
                    .single();

                if (error) throw error;

                // 新規解析タブに切り替えて結果を表示
                switchProfileAnalysisTab('new');

                // データの正規化
                let matches = data.matches;
                if (typeof matches === 'string') {
                    try { matches = JSON.parse(matches); } catch (e) { }
                }

                let renderData = {
                    candidate_summary: data.candidate_summary,
                    title: data.title, // 追加
                    history_id: data.id,
                    success: true
                };

                // matchesデータの形状に合わせて変換
                if (matches && !Array.isArray(matches) && typeof matches === 'object') {
                    // 新形式 { skill: [], ... } -> { matches_skill: [], ... }
                    renderData.matches_skill = matches.skill;
                    renderData.matches_industry = matches.industry;
                    renderData.matches_mindset = matches.mindset;
                } else if (Array.isArray(matches)) {
                    // 旧形式
                    renderData.matches = matches;
                } else if (data.analysis_results) {
                    // 予備で analysis_results も見る
                    let ar = data.analysis_results;
                    if (typeof ar === 'string') { try { ar = JSON.parse(ar); } catch (e) { } }
                    Object.assign(renderData, ar);
                }

                renderAnalysisResults(renderData);

            } catch (error) {
                console.error('View history detail error:', error);
                alert('履歴の詳細表示に失敗しました');
            }
        }

        function setupFileUploadHandlers() {
            // 既存のイベントリスナーを削除
            $('#file-drop-area').off('click dragover dragleave drop');
            $('#profile-file-input').off('change');

            // ファイル選択のハンドリング
            $('#file-drop-area').on('click', function (e) {
                // input要素自体のクリックは無視
                if ($(e.target).is('#profile-file-input')) {
                    return;
                }
                e.preventDefault();
                e.stopPropagation();
                $('#profile-file-input')[0].click(); // DOM要素として直接クリック
            });

            $('#profile-file-input').on('change', function (e) {
                e.stopPropagation(); // イベント伝播を停止
                if (e.target.files && e.target.files.length > 0) {
                    handleFileUpload(Array.from(e.target.files));
                }
            });

            // ドラッグ＆ドロップのハンドリング
            $('#file-drop-area').on('dragover', function (e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).addClass('bg-indigo-50');
            });

            $('#file-drop-area').on('dragleave', function (e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).removeClass('bg-indigo-50');
            });

            $('#file-drop-area').on('drop', function (e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).removeClass('bg-indigo-50');
                if (e.originalEvent.dataTransfer.files.length > 0) {
                    handleFileUpload(Array.from(e.originalEvent.dataTransfer.files));
                }
            });

            // Paste event handling
            $(document).on('paste', function (e) {
                const items = (e.originalEvent.clipboardData || e.clipboardData).items;
                const files = [];
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        const file = items[i].getAsFile();
                        if (file) {
                            // Create a dummy name if not present (often 'image.png' from clipboard)
                            if (!file.name || file.name === 'image.png') {
                                const ext = items[i].type.split('/')[1];
                                const timestamp = new Date().getTime();
                                // Create a new File object with a custom name
                                const newFile = new File([file], `pasted_image_${timestamp}.${ext}`, { type: file.type });
                                files.push(newFile);
                            } else {
                                files.push(file);
                            }
                        }
                    }
                }
                if (files.length > 0) {
                    handleFileUpload(files);
                    // Optional: Provide visual feedback that a paste occurred
                    $('#file-drop-area').addClass('bg-indigo-50');
                    setTimeout(() => $('#file-drop-area').removeClass('bg-indigo-50'), 200);
                }
            });
        }

        function handleFileUpload(files) {
            uploadedFiles = files;
            const fileListHtml = files.map((file, index) => `
            <div class="flex items-center justify-between bg-gray-100 px-2 py-1 rounded">
                    <span class="text-gray-700 truncate flex-1">
                        <i class="fas ${file.type.includes('pdf') ? 'fa-file-pdf text-red-500' : 'fa-image text-blue-500'} mr-1"></i>
                        ${file.name}
                    </span>
                    <span class="text-gray-500 text-xs ml-2">${(file.size / 1024).toFixed(1)}KB</span>
                </div>
            `).join('');
            $('#file-list').html(fileListHtml);
        }

        window.resetProfileAnalysis = function () {
            uploadedFiles = [];
            $('#profile-file-input').val('');
            $('#file-list').empty();
            $('#profile-text-input').val('');
            $('#scout-instruction-text').val(''); // 追加: 指示テキストもクリア
            $('#scout-instruction-container').addClass('hidden'); // 追加: 指示エリアを隠す
            $('#analysis-placeholder').removeClass('hidden');
            $('#analysis-loading').addClass('hidden');
            $('#analysis-results').addClass('hidden');
            $('#suggested-jobs-container').empty();
        }

        window.analyzeProfile = async function (instruction = null, targetJobId = null) {
            if (!currentUser) return;

            // 初回解析（指示がない場合）は新規扱いとしてIDとタイトルをリセット
            if (!instruction) {
                window.currentExternalCandidateId = null;
                // $('#candidate-title-input').val(''); // 削除: 入力されたタイトルを維持する
            }

            const textInput = $('#profile-text-input').val().trim();

            if (uploadedFiles.length === 0 && !textInput) {
                alert('ファイルまたはテキスト情報を入力してください');
                return;
            }

            // UI更新
            $('#analyze-profile-btn').prop('disabled', true);
            $('#regenerate-scout-btn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>再生成中...'); // 再生成ボタンの状態更新

            // 初回解析時はプレースホルダーを隠してローディングを表示
            if (!instruction) {
                $('#analysis-placeholder').addClass('hidden');
                // $('#analysis-loading').removeClass('hidden'); // 全画面ローディングを使用するためコメントアウト
                showLoading('プロフィールを解析中...');
                $('#analysis-results').addClass('hidden');
            } else {
                // 再生成時は結果エリアを半透明にするなどのフィードバックがあると良いが、今回はローディング表示に切り替える
                $('#analysis-results').addClass('opacity-50');
                showLoading('指示に基づいて再生成中...');
            }

            try {
                // 最初のファイルをBase64に変換（画像またはPDF）
                let base64Image = null;
                let mimeType = null;
                if (uploadedFiles.length > 0) {
                    const file = uploadedFiles[0];
                    if (file.type.startsWith('image/')) {
                        base64Image = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result);
                            reader.readAsDataURL(file);
                        });
                        mimeType = file.type;
                    } else if (file.type === 'application/pdf') {
                        // PDFを画像(JPEG)に変換
                        try {

                            const arrayBuffer = await file.arrayBuffer();
                            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                            const page = await pdf.getPage(1); // 1ページ目のみ
                            const viewport = page.getViewport({ scale: 2.0 });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;

                            await page.render({ canvasContext: context, viewport: viewport }).promise;
                            base64Image = canvas.toDataURL('image/jpeg');
                            mimeType = 'image/jpeg';
                        } catch (e) {
                            console.error('PDF conversion error:', e);
                            alert('PDFの処理に失敗しました。画像ファイルを使用してください。');
                            throw e;
                        }
                    }
                }

                // Edge Function呼び出し
                // Base64ヘッダーを除去して送信
                const cleanBase64 = base64Image ? base64Image.replace(/^data:(.*);base64,/, '') : null;

                const { data, error } = await window.supabase.functions.invoke('analyze-external-profile', {
                    body: {
                        image: cleanBase64,
                        mime_type: mimeType || 'image/jpeg', // MIMEタイプも明示的に送信
                        text_input: textInput || null,
                        title: $('#candidate-title-input').val().trim() || null, // 追加: タイトルを送信
                        organization_id: currentUser.organization_id,
                        user_id: currentUser.id,
                        instruction: instruction, // 追加: 修正指示
                        target_job_id: targetJobId
                    }
                });

                if (error) throw error;
                console.log('Analysis response data:', data); // Debug log

                if (data && data.success) {
                    renderAnalysisResults(data);

                    // Save result here (only on analysis, not on view)
                    // Removed to prevent auto-save: User must explicitly save via Scout or Register button
                    // if (window.saveExternalCandidateProfile) {
                    //     saveExternalCandidateProfile(data);
                    // }
                } else {
                    throw new Error(data.error || '解析に失敗しました');
                }

            } catch (error) {
                console.error('Analysis error:', error);
                alert('解析に失敗しました: ' + error.message);
                if (!instruction) {
                    $('#analysis-loading').addClass('hidden');
                    $('#analysis-placeholder').removeClass('hidden');
                }
            } finally {
                $('#analyze-profile-btn').prop('disabled', false);
                $('#regenerate-scout-btn').prop('disabled', false).html('<i class="fas fa-sync-alt mr-2"></i>指示を反映して再生成');
                $('#analysis-results').removeClass('opacity-50');
                hideLoading();
            }
        }

        // 再生成ボタンのハンドラ
        window.regenerateScoutsWithInstruction = function () {
            const instruction = $('#scout-instruction-text').val().trim();
            if (!instruction) {
                alert('修正指示を入力してください');
                return;
            }
            analyzeProfile(instruction);
        }

        let currentAnalysisMatches = [];
        let currentAnalysisOffset = 0;
        let analysisResultsData = null; // 全データを保持
        const ANALYSIS_BATCH_SIZE = 3;

        window.renderAnalysisResults = function (data) {
            $('#analysis-loading').addClass('hidden');
            $('#analysis-results').removeClass('hidden');
            $('#scout-instruction-container').removeClass('hidden');

            // タイトルを反映（既存の入力がある場合は上書きせず、空の場合や履歴表示の場合のみ反映させたいが、
            // 履歴表示時はdata.titleに値が入っているはず。解析直後もdata.titleに反映するようにすると一貫性が出る。
            if (data.title !== undefined) {
                $('#candidate-title-input').val(data.title || '');
            }

            window.currentAnalysisHistoryId = data.history_id || null;

            // Auto Save to External Candidates (New Feature)
            // Auto Save Removed from here to prevent duplicate on view
            // if (window.saveExternalCandidateProfile) {
            //     saveExternalCandidateProfile(data);
            // }
            currentAnalysisHistoryId = window.currentAnalysisHistoryId;

            if (!window.currentAnalysisHistoryId && data.save_error) {
                console.error('History ID is missing. Save error:', data.save_error);
                const errorDetail = typeof data.save_error === 'object' ? JSON.stringify(data.save_error, null, 2) : String(data.save_error);
                alert('【エラー】履歴の保存に失敗しました。\n詳細: ' + errorDetail);
            } else if (!window.currentAnalysisHistoryId) {
                console.warn('History ID is missing but no save error reported.');
            } else {
                console.log('Set GLOBAL history ID:', window.currentAnalysisHistoryId);
            }

            // Persist in DOM to be absolutely sure
            if ($('#current-analysis-history-id').length === 0) {
                $('#analysis-results').append('<input type="hidden" id="current-analysis-history-id">');
            }
            $('#current-analysis-history-id').val(window.currentAnalysisHistoryId || '');

            // サマリー表示
            $('#candidate-summary-text').text(data.candidate_summary || '解析結果なし');

            const container = $('#suggested-jobs-container');
            container.empty();

            // 任意の求人選択ボタンを追加
            container.append(`
            <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4 mb-6 flex items-center justify-between">
                    <div>
                        <h5 class="font-bold text-indigo-900">
                            <i class="fas fa-search-plus mr-2"></i>その他の求人でスカウトを作成
                        </h5>
                        <p class="text-sm text-indigo-700">おすすめ求人以外の求人を指定してスカウト文面を作成できます。</p>
                    </div>
                    <button onclick="openJobSelectorForScout()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded shadow transition">
                        求人を選択
                    </button>
                </div>
            `);

            // Debug log removed: console.log('Analysis results:', data);

            analysisResultsData = data; // データ保存
            window.analysisResultsData = data; // グローバルアクセス用に公開

            // Debug log removed: console.log('Data keys:', Object.keys(data));
            // Debug log removed: console.log('Matches lengths:', {
            //     skill: data.matches_skill ? data.matches_skill.length : 'undefined',
            //     industry: data.matches_industry ? data.matches_industry.length : 'undefined',
            //     mindset: data.matches_mindset ? data.matches_mindset.length : 'undefined',
            //     legacy: data.matches ? data.matches.length : 'undefined'
            // });

            // 構造化データ（matches_skill等）がある場合は、それを優先して統合・使用する
            const hasStructuredMatches = (Array.isArray(data.matches_skill) && data.matches_skill.length > 0) ||
                (Array.isArray(data.matches_industry) && data.matches_industry.length > 0) ||
                (Array.isArray(data.matches_mindset) && data.matches_mindset.length > 0);

            // Debug log removed: console.log('Has structured matches:', hasStructuredMatches);

            if (hasStructuredMatches) {
                // 新形式レスポンス対応: matches_skill, matches_industry, matches_mindset を統合
                data.matches = [
                    ...(data.matches_skill || []).map(m => ({ ...m, category: 'skill' })),
                    ...(data.matches_industry || []).map(m => ({ ...m, category: 'industry' })),
                    ...(data.matches_mindset || []).map(m => ({ ...m, category: 'mindset' }))
                ];
                // Update global data reference
                analysisResultsData = data;
                // Debug log removed: console.log('Merged matches from structured data:', data.matches);
            }

            // カテゴリ情報が含まれているかチェック (データがあれば強制的にカテゴリありとみなす)
            const hasCategories = hasStructuredMatches || (data.matches && data.matches.length > 0 && data.matches.some(m => m.category));

            if (hasCategories) {
                // タブUIのレンダリング
                const tabsHtml = `
            <div class="flex border-b border-gray-200 mb-4">
                        <button onclick="switchAnalysisTab('skill')" id="tab-skill" class="ai-result-tab flex-1 py-3 px-2 text-center text-sm font-bold border-b-2 transition-colors duration-200 text-indigo-600 border-indigo-600">
                            <i class="fas fa-tools mr-1"></i>スキル・経験
                            <span class="group relative inline-block ml-1 text-left font-normal" onclick="event.stopPropagation()">
                                <i class="fas fa-question-circle text-gray-400 hover:text-indigo-500 cursor-help transition-colors"></i>
                                <div class="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none z-50 leading-relaxed font-normal">
                                    <div class="absolute top-[-6px] left-1/2 transform -translate-x-1/2 w-3 h-3 bg-gray-800 rotate-45"></div>
                                    具体的なスキルセットや実務経験など、「即戦力」としての適合度が高い求人です。
                                </div>
                            </span>
                        </button>
                        <button onclick="switchAnalysisTab('industry')" id="tab-industry" class="ai-result-tab flex-1 py-3 px-2 text-center text-sm font-bold border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            <i class="fas fa-building mr-1"></i>業界・ドメイン
                            <span class="group relative inline-block ml-1 text-left font-normal" onclick="event.stopPropagation()">
                                <i class="fas fa-question-circle text-gray-400 hover:text-indigo-500 cursor-help transition-colors"></i>
                                <div class="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none z-50 leading-relaxed font-normal">
                                    <div class="absolute top-[-6px] left-1/2 transform -translate-x-1/2 w-3 h-3 bg-gray-800 rotate-45"></div>
                                    業界知識や商流の理解など、バックグラウンドの経験が活かせる求人です。
                                </div>
                            </span>
                        </button>
                        <button onclick="switchAnalysisTab('mindset')" id="tab-mindset" class="ai-result-tab flex-1 py-3 px-2 text-center text-sm font-bold border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            <i class="fas fa-heart mr-1"></i>志向性
                            <span class="group relative inline-block ml-1 text-left font-normal" onclick="event.stopPropagation()">
                                <i class="fas fa-question-circle text-gray-400 hover:text-indigo-500 cursor-help transition-colors"></i>
                                <div class="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none z-50 leading-relaxed font-normal">
                                    <div class="absolute top-[-6px] left-1/2 transform -translate-x-1/2 w-3 h-3 bg-gray-800 rotate-45"></div>
                                    候補者のキャリア志向や人柄、企業文化（カルチャー）との相性が良い求人です。
                                </div>
                            </span>
                        </button>
                    </div>
            <div id="analysis-tab-content"></div>
        `;
                container.append(tabsHtml);

                // データが存在する最初のタブを開く
                if (data.matches_skill && data.matches_skill.length > 0) {
                    switchAnalysisTab('skill');
                } else if (data.matches_industry && data.matches_industry.length > 0) {
                    switchAnalysisTab('industry');
                } else if (data.matches_mindset && data.matches_mindset.length > 0) {
                    switchAnalysisTab('mindset');
                } else {
                    switchAnalysisTab('skill'); // デフォルト
                }

            } else {
                // 従来表示 (フラットリスト)
                if (!data.matches || data.matches.length === 0) {
                    container.html('<p class="text-gray-500 text-center">マッチする求人が見つかりませんでした</p>');
                    $('#load-more-analysis-container').addClass('hidden');
                    return;
                }
                currentAnalysisMatches = data.matches;
                currentAnalysisOffset = 0;
                loadMoreAnalysisMatches();
            }

            // Load Moreボタンのコンテナ (共通)
            if ($('#load-more-analysis-container').length === 0) {
                container.after(`
            <div id="load-more-analysis-container" class="text-center mt-4 hidden">
                <button id="load-more-analysis-btn" onclick="loadMoreAnalysisMatches()"
                    class="px-6 py-2 bg-white border border-gray-300 rounded-full text-sm font-medium text-gray-700 hover:bg-gray-50 shadow-sm transition">
                    もっと見る
                </button>
                    </div>
            `);
            }
        }

        window.switchAnalysisTab = function (tab) {
            // スタイル更新
            ['skill', 'industry', 'mindset'].forEach(t => {
                const btn = $(`#tab - ${t} `);
                if (t === tab) {
                    btn.removeClass('border-transparent text-gray-500 hover:text-gray-700')
                        .addClass('text-indigo-600 border-indigo-600');
                } else {
                    btn.removeClass('text-indigo-600 border-indigo-600')
                        .addClass('border-transparent text-gray-500 hover:text-gray-700');
                }
            });

            // データ切り替え (categoryプロパティでフィルタリング)
            if (analysisResultsData && analysisResultsData.matches) {
                currentAnalysisMatches = analysisResultsData.matches.filter(m => m.category === tab);
            } else {
                currentAnalysisMatches = [];
            }

            currentAnalysisOffset = 0;
            $('#analysis-tab-content').empty();
            $('#load-more-analysis-container').addClass('hidden');

            // データがない場合の表示
            if (currentAnalysisMatches.length === 0) {
                $('#analysis-tab-content').html('<p class="text-gray-400 text-center py-4">この観点でのマッチング求人はありません</p>');
                return;
            }

            loadMoreAnalysisMatches();
        }

        window.loadMoreAnalysisMatches = function () {
            // タブ内かメインコンテナかを判定
            let container = $('#analysis-tab-content');
            if (container.length === 0) {
                container = $('#suggested-jobs-container');
            }
            const nextMatches = currentAnalysisMatches.slice(currentAnalysisOffset, currentAnalysisOffset + ANALYSIS_BATCH_SIZE);

            // Store ID for feedback use (Moved from pagination loop)

            nextMatches.forEach(match => {
                const html = `
            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm hover:shadow-md transition mb-4">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <h5 class="text-lg font-bold text-gray-900">${match.job_title}</h5>
                                ${match.match_score ? `<span class="px-2 py-0.5 bg-indigo-100 text-indigo-800 text-xs font-bold rounded-full">マッチ度 ${match.match_score}%</span>` : ''}
                                <a href="#" onclick="showJobDetailModal('${match.job_id}'); return false;" 
                                    class="text-xs text-indigo-600 hover:text-indigo-800 underline ml-2">
                                    詳細を見る
                                </a>
                            </div>
                            <p class="text-sm text-gray-600 mb-1">
                                <i class="fas fa-building text-gray-400 mr-1"></i>${match.company_name}
                            </p>
                            ${match.job_description ? `
                            <p class="text-xs text-gray-500 line-clamp-2 mt-2">${match.job_description.substring(0, 100)}...</p>
                            ` : ''}
                        </div>
                        <!-- Copy Button with Tooltip -->
                        <div class="relative group ml-4 inline-block">
                            <button onclick="copyToClipboard(this)" class="text-gray-400 hover:text-indigo-600 focus:outline-none">
                                <i class="far fa-copy text-xl"></i>
                            </button>
                            <div class="absolute bottom-full right-0 mb-2 w-40 p-2 bg-gray-800 text-white text-xs rounded shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none z-50 text-center font-normal">
                                <div class="absolute bottom-[-6px] right-3 w-3 h-3 bg-gray-800 rotate-45"></div>
                                文面をクリップボードにコピー
                            </div>
                        </div>

                        <!-- Save Button with Tooltip -->
                        <div class="relative group ml-2 inline-block">
                            <button onclick="saveScoutMessage(this, '${match.job_id}')" class="text-gray-400 hover:text-green-600 focus:outline-none">
                                <i class="fas fa-save text-xl"></i>
                            </button>
                            <div class="absolute bottom-full right-0 mb-2 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none z-50 leading-relaxed font-normal text-left">
                                <div class="absolute bottom-[-6px] right-3 w-3 h-3 bg-gray-800 rotate-45"></div>
                                <strong>スカウトを保存</strong><br>
                                この候補者と文面を「スカウト管理」に登録します。保存することで、送信ステータスの管理や候補者の追跡が可能になります。
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 p-3 rounded mb-4">
                        <p class="text-xs font-bold text-yellow-800 mb-1">
                            <i class="fas fa-lightbulb mr-1"></i>マッチング理由
                        </p>
                        <p class="text-sm text-gray-700">${match.match_reason}</p>
                    </div>

                    <div class="border-t pt-4">
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-xs text-gray-500 font-bold">生成されたスカウト文面 (編集可)</p>
                            <span class="text-[10px] bg-indigo-100 text-indigo-600 px-1.5 py-0.5 rounded italic">クリックして直接編集できます</span>
                        </div>
                        <div class="bg-gray-50 p-4 rounded border border-gray-200 focus-within:border-indigo-300 focus-within:ring-1 focus-within:ring-indigo-100 transition-all">
                            <div class="flex items-center mb-2 border-b border-gray-200 pb-2">
                                <span class="text-sm font-bold text-gray-400 mr-2 flex-shrink-0">件名:</span>
                                <input type="text" class="scout-subject-input w-full font-bold text-gray-900 border-none bg-transparent focus:ring-0 text-sm p-0" value="${match.scout_subject}">
                            </div>
                            <textarea class="scout-body-textarea w-full text-gray-700 text-sm bg-transparent border-none focus:ring-0 p-0 resize-none overflow-hidden leading-relaxed" 
                                      oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'">${(match.scout_body || '').replace(/\\n/g, '\n')}</textarea>
                        </div>
                        
                        <!-- Feedback UI -->
                        <div class="flex justify-end items-center mt-2 space-x-2 feedback-container" data-job-id="${match.job_id}" data-history-id="${window.currentAnalysisHistoryId || ''}">
                            <span class="text-xs text-gray-400">この文面の評価:</span>
                            <button onclick="submitFeedback(this, 'good')" class="text-gray-400 hover:text-yellow-500 transition tooltip" data-tip="Good">
                                <i class="far fa-laugh text-lg"></i>
                            </button>
                            <button onclick="submitFeedback(this, 'soso')" class="text-gray-400 hover:text-yellow-500 transition tooltip" data-tip="So-so">
                                <i class="far fa-meh text-lg"></i>
                            </button>
                            <button onclick="submitFeedback(this, 'bad')" class="text-gray-400 hover:text-yellow-500 transition tooltip" data-tip="Bad">
                                <i class="far fa-frown text-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
                container.append(html);
            });

            currentAnalysisOffset += nextMatches.length;

            // Textareaの初期高さを調整
            setTimeout(() => {
                $('.scout-body-textarea').trigger('input');
            }, 100);

            if (currentAnalysisOffset < currentAnalysisMatches.length) {
                $('#load-more-analysis-container').removeClass('hidden');
            } else {
                $('#load-more-analysis-container').addClass('hidden');
            }
        }

        /* =========================================
           Scout Style Personalization Logic
           ========================================= */



        window.analyzeScoutExamples = async function () {
            const examples = [];
            $('.scout-example-input').each(function () {
                const val = $(this).val().trim();
                if (val) examples.push(val);
            });

            if (examples.length === 0) {
                alert('例文を少なくとも1つ入力してください');
                return;
            }

            const btn = $('#analyze-examples-btn');
            const originalText = btn.text();
            btn.text('分析中...').prop('disabled', true);

            try {
                const { data, error } = await supabase.functions.invoke('analyze-scout-style', {
                    body: { examples }
                });

                if (error) throw error;
                if (!data.success) throw new Error(data.error);

                $('#scout-style-prompt').val(data.style_prompt);
                alert('文体の分析が完了しました。「設定を保存」ボタンを押して適用してください。');

            } catch (e) {
                console.error(e);
                alert('分析に失敗しました: ' + e.message);
            } finally {
                btn.text(originalText).prop('disabled', false);
            }
        }

        window.closeScoutSettingsModal = function () {
            $('#scout-settings-modal').addClass('hidden');
        }

        window.saveScoutSettings = async function () {
            const isActive = $('#scout-style-active').is(':checked');
            const prompt = $('#scout-style-prompt').val();

            try {
                const { error } = await supabase
                    .from('user_scout_settings')
                    .upsert({
                        user_id: currentUser.id,
                        style_prompt: prompt,
                        is_active: isActive,
                        updated_at: new Date().toISOString()
                    });

                if (error) throw error;
                alert('設定を保存しました');
                closeScoutSettingsModal();
            } catch (e) {
                console.error(e);
                alert('保存に失敗しました');
            }
        }

        window.submitFeedback = async function (btn, rating) {
            const container = $(btn).closest('.feedback-container');
            // Try to get history ID from DOM (hidden input is most reliable), then data-attr, then global
            const historyId = $('#current-analysis-history-id').val() || container.data('history-id') || window.currentAnalysisHistoryId;

            if (!historyId) {
                console.warn('No history ID found for feedback');
                return;
            }

            const jobId = container.data('job-id');
            // Find scout content nearby
            const scoutContent = $(btn).closest('.border-t').find('.scout-body-textarea').val() || $(btn).closest('.border-t').find('.scout-body-text').text();

            // Visual feedback
            container.find('button').addClass('text-gray-200').removeClass('text-yellow-500');
            $(btn).removeClass('text-gray-200').addClass('text-yellow-500');

            try {
                const { error } = await supabase
                    .from('scout_feedbacks')
                    .insert({
                        user_id: currentUser.id,
                        history_id: historyId,
                        job_id: jobId,
                        rating: rating,
                        scout_content: scoutContent
                    });

                if (error) throw error;
                console.log('Feedback submitted:', rating);
                // alert('評価を保存しました！'); // Optional: show distinct feedback
            } catch (e) {
                console.error('Feedback error:', e);
            }
        }

        /* =========================================
           Candidate Search & Matching Logic
           ========================================= */

        let isCandidateSearchInitialized = false;
        window.selectedTargetJobId = null;
        let allCandidateSearchJobs = [];

        async function loadCandidateSearch() {
            if (!currentUser) return;
            showLoading();
            try {
                await loadMasterDataForCandidateSearch();
                await loadAllJobsforSearch();

                // 初回検索（フィルタなし）
                await searchCandidates();

            } catch (e) {
                console.error(e);
            } finally {
                hideLoading();
            }
        }

        async function loadMasterDataForCandidateSearch() {
            if (isCandidateSearchInitialized) return;

            // 都道府県
            const prefSelect = $('#c-search-prefecture');
            if (prefSelect.hasClass("select2-hidden-accessible")) {
                prefSelect.select2('destroy');
            }
            prefSelect.empty();
            window.prefectures.forEach(pref => {
                prefSelect.append(`<option value="${pref}">${pref}</option>`);
            });
            prefSelect.select2({ placeholder: "勤務地（都道府県）", allowClear: true, width: '100%' });

            // マスタデータ取得
            const { data: masters } = await supabase
                .from('master_data')
                .select('*')
                .eq('is_active', true)
                .order('sort_order');

            const validMasters = masters.filter(m => m.organization_id === null || m.organization_id === currentUser.organization_id);

            // ----------------------------------------------------------------
            // 1. 求職者検索フォーム用 Select2
            // ----------------------------------------------------------------

            // 雇用形態
            const empSelect = $('#c-search-employment-type');
            if (empSelect.hasClass("select2-hidden-accessible")) {
                empSelect.select2('destroy');
            }
            empSelect.empty();
            const uniqueEmps = [...new Set(validMasters.filter(m => m.type === 'employment_type').map(m => m.label))];
            uniqueEmps.forEach(label => {
                empSelect.append(`<option value="${label}">${label}</option>`);
            });
            empSelect.select2({ placeholder: "雇用形態", allowClear: true, width: '100%' });

            // 職種
            const catSelect = $('#c-search-job-category');
            if (catSelect.hasClass("select2-hidden-accessible")) {
                catSelect.select2('destroy');
            }
            catSelect.empty();
            const uniqueCats = [...new Set(validMasters.filter(m => m.type === 'job_category').map(m => m.label))];
            uniqueCats.forEach(label => {
                catSelect.append(`<option value="${label}">${label}</option>`);
            });
            catSelect.select2({ placeholder: "職種カテゴリ", allowClear: true, width: '100%' });

            // 業界
            const indSelect = $('#c-search-industry-category');
            if (indSelect.hasClass("select2-hidden-accessible")) {
                indSelect.select2('destroy');
            }
            indSelect.empty();
            const uniqueInds = [...new Set(validMasters.filter(m => m.type === 'industry_category').map(m => m.label))];
            uniqueInds.forEach(label => {
                indSelect.append(`<option value="${label}">${label}</option>`);
            });
            indSelect.select2({ placeholder: "業界カテゴリ", allowClear: true, width: '100%' });

            // ----------------------------------------------------------------
            // 2. 対象求人検索用 Select2 (追加)
            // ----------------------------------------------------------------

            // 職種 (t-job-category)
            const tjCatSelect = $('#t-job-category');
            if (tjCatSelect.hasClass("select2-hidden-accessible")) {
                tjCatSelect.select2('destroy');
            }
            tjCatSelect.empty();
            const uniqueTjCats = [...new Set(validMasters.filter(m => m.type === 'job_category').map(m => m.label))];
            uniqueTjCats.forEach(label => {
                tjCatSelect.append(`<option value="${label}">${label}</option>`);
            });
            tjCatSelect.select2({ placeholder: "職種で絞り込み", allowClear: true, width: '100%' });

            // 業界 (t-industry)
            const tjIndSelect = $('#t-industry');
            if (tjIndSelect.hasClass("select2-hidden-accessible")) {
                tjIndSelect.select2('destroy');
            }
            tjIndSelect.empty();
            const uniqueTjInds = [...new Set(validMasters.filter(m => m.type === 'industry_category').map(m => m.label))];
            uniqueTjInds.forEach(label => {
                tjIndSelect.append(`<option value="${label}">${label}</option>`);
            });
            tjIndSelect.select2({ placeholder: "業界で絞り込み", allowClear: true, width: '100%' });

            // 勤務地 (t-location) - 都道府県
            const tjLocSelect = $('#t-location');
            if (tjLocSelect.hasClass("select2-hidden-accessible")) {
                tjLocSelect.select2('destroy');
            }
            tjLocSelect.empty();
            window.prefectures.forEach(pref => {
                tjLocSelect.append(`<option value="${pref}">${pref}</option>`);
            });
            tjLocSelect.select2({ placeholder: "勤務地で絞り込み", allowClear: true, width: '100%' });

            // Event Listeners for Target Job Search
            const onTargetJobFilterChange = () => {
                const term = $('#target-job-search').val().toLowerCase();
                // Call filter even if term is empty (to filter by dropdowns)
                // But wait, existing logic hid dropdown if term was empty.
                // Now we want to show it if dropdowns are selected?
                // Or just filter in background?
                // Current UI expects "Search Input" to trigger.
                // Let's modify filterAndShowTargetJobs to handle empty term if filters are present.
                filterAndShowTargetJobs(term);
            };

            $('#target-job-search').on('input', onTargetJobFilterChange);
            $('#t-job-category, #t-industry, #t-location').on('change', onTargetJobFilterChange);

            $('#clear-job-selection').on('click', function () {
                clearTargetJobSelection();
            });

            // Float Action Bar Setup
            const floatBar = $(`
            <div id="candidate-float-bar" class="fixed bottom-0 right-0 bg-white border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] p-4 hidden z-50 transition-transform transform translate-y-full flex justify-between items-center" style="left: 0; width: 100%;">
                    <div class="flex items-center pl-4 md:pl-72">
                        <span class="font-bold text-gray-800 text-lg mr-1" id="c-selected-count">0</span>
                        <span class="text-gray-600 text-sm">人の候補者を選択中</span>
                        <button onclick="clearAllSelectedCandidates()" class="ml-4 text-xs bg-gray-200 hover:bg-gray-300 text-gray-600 font-medium py-1 px-3 rounded transition">全解除</button>
                    </div>
                    <div class="pr-4">
                        <button id="btn-save-recommendations" onclick="saveCandidatesToRecommendations()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition transform hover:scale-105 flex items-center">
                            <i class="fas fa-star mr-2"></i>おすすめ求人に保存
                        </button>
                    </div>
                </div>
            `);
            // bodyにappendしてz-indexを効かせる (またはcontent内でもよいがfixedなのでbody推奨)
            // ただしSidebarとの兼ね合いで left を調整したいが、Tailwindの md:pl-64 (16rem=256px) を使う
            // style="left: 0; width: 100%;" と class="md:pl-64" を併用

            $('body').append(floatBar);

            // Handler
            $(document).on('change', '.candidate-select-checkbox', function () {
                const count = $('.candidate-select-checkbox:checked').length;
                $('#c-selected-count').text(count);

                const bar = $('#candidate-float-bar');

                // AI結果表示中のみバーを表示する (求職者検索リストでのAIマッチングバーは不要との要望)
                if (count > 0 && isAImatchingResultView) {
                    bar.removeClass('hidden').removeClass('translate-y-full').addClass('translate-y-0');
                    $('#candidate-results-container').css('padding-bottom', '100px');
                } else {
                    bar.addClass('translate-y-full');
                    setTimeout(() => {
                        if ($('.candidate-select-checkbox:checked').length === 0 || !isAImatchingResultView) bar.addClass('hidden');
                    }, 300);
                    $('#candidate-results-container').css('padding-bottom', '0');
                }
            });

            isCandidateSearchInitialized = true;
        }

        window.clearAllSelectedCandidates = function () {
            $('.candidate-select-checkbox').prop('checked', false);
            const bar = $('#candidate-float-bar');
            bar.addClass('translate-y-full');
            setTimeout(() => {
                bar.addClass('hidden');
            }, 300);
            $('#c-selected-count').text('0');
            $('#candidate-results-container').css('padding-bottom', '0');
        };

        async function loadAllJobsforSearch() {
            let query = supabase.from('jobs')
                .select('id, title, companies(name), requirements, salary_min, salary_max, job_category, industry_category, location, employment_type')
                .eq('status', 'active');

            if (currentUser && currentUser.organization_id) {
                query = query.eq('organization_id', currentUser.organization_id);
            }

            const { data } = await query;
            allCandidateSearchJobs = data || [];
        }

        window.filterAndShowTargetJobs = function (term) {
            const cats = $('#t-job-category').val() || [];
            const inds = $('#t-industry').val() || [];
            const locs = $('#t-location').val() || [];

            // If no input and no filters, hide
            if (!term && cats.length === 0 && inds.length === 0 && locs.length === 0) {
                $('#target-job-dropdown').addClass('hidden');
                return;
            }

            const filtered = allCandidateSearchJobs.filter(job => {
                const title = (job.title || '').toLowerCase();
                const comp = (job.companies?.name || '').toLowerCase();
                let match = true;

                // Text Match
                if (term) {
                    if (!title.includes(term) && !comp.includes(term)) match = false;
                }

                // Category Match
                if (match && cats.length > 0) {
                    // job.job_category is string or array
                    const jCats = Array.isArray(job.job_category) ? job.job_category : (job.job_category || '').split(',');
                    // Check intersection
                    const hasCat = cats.some(c => jCats.some(jc => jc.includes(c) || c.includes(jc)));
                    if (!hasCat) match = false;
                }

                // Industry Match
                if (match && inds.length > 0) {
                    const jInds = Array.isArray(job.industry_category) ? job.industry_category : (job.industry_category || '').split(',');
                    const hasInd = inds.some(i => jInds.some(ji => ji.includes(i) || i.includes(ji)));
                    if (!hasInd) match = false;
                }

                // Location Match
                if (match && locs.length > 0) {
                    const jLocs = Array.isArray(job.location) ? job.location : (job.location || '').split(',');
                    const hasLoc = locs.some(l => jLocs.some(jl => jl.includes(l) || l.includes(jl)));
                    if (!hasLoc) match = false;
                }

                return match;
            });

            const dropdown = $('#target-job-dropdown');
            if (filtered.length === 0) {
                dropdown.html('<div class="p-3 text-gray-500 text-sm">該当する求人がありません</div>').removeClass('hidden');
                return;
            }

            const html = filtered.slice(0, 10).map(job => `
            <div class="p-2 hover:bg-indigo-50 cursor-pointer flex justify-between items-center border-b"
        onclick="window.selectTargetJob('${job.id}')">
            <div>
                <div class="font-medium text-gray-800">${job.title}</div>
                <div class="text-xs text-gray-500">${job.companies?.name || ''}</div>
            </div>
                </div>
            `).join('');

            dropdown.html(html).removeClass('hidden');
        }

        window.selectTargetJob = function (jobId) {
            console.log('selectTargetJob called', jobId);
            const job = allCandidateSearchJobs.find(j => j.id === jobId);
            if (!job) {
                console.error('Job not found in cache', jobId);
                return;
            }

            selectedTargetJobId = jobId;

            // 詳細ボタン追加
            $('#selected-job-title').html(`
                ${job.title}
        <button onclick="event.stopPropagation(); showJobDetailModal('${job.id}')" class="ml-2 text-indigo-600 hover:text-indigo-800 text-xs bg-indigo-50 px-2 py-1 rounded border border-indigo-200 transition-colors">
            <i class="fas fa-info-circle mr-1"></i>詳細
        </button>
        `);
            $('#selected-job-company').text(job.companies?.name || '-');

            $('#selected-job-display').removeClass('hidden');
            $('#target-job-input-wrapper').addClass('hidden');
            $('#target-job-dropdown').addClass('hidden');
            $('#job-ai-match-btn').prop('disabled', false);

            // 検索条件をセット
            // フォームリセット
            $('#c-search-keyword').val('');
            $('#c-search-location').val('');
            $('#c-search-prefecture').val(null).trigger('change');
            $('#c-search-job-category').val(null).trigger('change');
            $('#c-search-industry-category').val(null).trigger('change');
            $('#c-search-employment-type').val(null).trigger('change');
            $('#c-search-salary-min').val('');

            // ヘルパー: 配列かカンマ区切り文字列を配列に正規化
            const normalizeToArray = (val) => {
                if (!val) return [];
                if (Array.isArray(val)) return val;
                return val.split(',').map(s => s.trim());
            };

            // 職種
            if (job.job_category) {
                const vals = normalizeToArray(job.job_category);
                $('#c-search-job-category').val(vals).trigger('change');
            }

            // 業界
            if (job.industry_category) {
                const vals = normalizeToArray(job.industry_category);
                $('#c-search-industry-category').val(vals).trigger('change');
            }

            // 雇用形態
            if (job.employment_type) {
                const vals = normalizeToArray(job.employment_type);
                $('#c-search-employment-type').val(vals).trigger('change');
            }

            // 勤務地 (都道府県抽出)
            if (job.location) {
                const locs = normalizeToArray(job.location);
                // 詳細テキストボックスには結合してセット
                $('#c-search-location').val(locs.join(', '));

                // 都道府県をセット
                const foundPrefs = [];
                locs.forEach(loc => {
                    const pref = window.prefectures.find(p => loc.startsWith(p));
                    if (pref) foundPrefs.push(pref);
                });

                if (foundPrefs.length > 0) {
                    $('#c-search-prefecture').val(foundPrefs).trigger('change');
                }
            }

            // 給与 (最低年収) - 求人の最低年収以上の希望を持つ人を検索？ 
            // いや、求職者検索なので「求人の条件」に合う人を探す。
            // 求職者の希望年収 <= 求人の上限？
            // ここではシンプルにセットしない、または求人のMinを入れる。
            // ユーザー要望は「条件セット」。求人の属性をセットするのが自然。
            // 求人が「年収500万〜」なら、希望年収500万くらいの人を探すのが筋？
            // いったんスキップ（ユーザー判断に任せる）か、Minを入れる。
            // if (job.salary_min) $('#c-search-salary-min').val(job.salary_min / 10000);

            // 検索自動実行
            searchCandidates();
        }

        window.clearTargetJobSelection = function () {
            selectedTargetJobId = null;
            $('#selected-job-display').addClass('hidden');
            $('#target-job-input-wrapper').removeClass('hidden');
            $('#target-job-search').val('');
            $('#job-ai-match-btn').prop('disabled', true);
        }

        window.searchCandidatesImmediate = function () {
            searchCandidates();
        }

        window.clearCandidateSearch = function () {
            $('#c-search-keyword').val('');
            $('#c-tags-keyword').empty();
            $('#c-search-location').val('');
            $('#c-tags-location').empty();

            // Slider reset
            $('#c-search-salary-slider').val(0);
            $('#c-search-salary-min').val(0);
            $('#c-salary-display').text('指定なし');

            $('#c-search-prefecture').val(null).trigger('change');
            $('#c-search-job-category').val(null).trigger('change');
            $('#c-search-industry-category').val(null).trigger('change');
            $('#c-search-employment-type').val(null).trigger('change');
            $('#c-search-sort').val('created_at-desc');
            $('#c-search-management-status').val('active');
            searchCandidates();
        }

        // ========================
        // Candidate Pagination Variables
        // ========================
        const CANDIDATES_PER_PAGE = 20;
        let currentCandidatePage = 1;
        let totalCandidatePages = 1;
        let currentCandidateFilters = {};
        let allCandidatesCache = []; // フィルタリング後の全候補者

        window.searchCandidates = async function searchCandidates(filters = {}, page = 1) {
            showLoading();
            $('#candidate-results-container').empty();

            // Build Query
            // キーワードタグ
            const kTags = [];
            $('#c-tags-keyword .premium-tag').each(function () {
                kTags.push($(this).text().trim().toLowerCase());
            });
            let keyword = $('#c-search-keyword').val().toLowerCase().trim();
            if (kTags.length > 0) {
                keyword = (keyword + ' ' + kTags.join(' ')).trim();
            }

            // フリーワードタグ（勤務地）
            const fTags = [];
            $('#c-tags-location .premium-tag').each(function () {
                fTags.push($(this).text().trim());
            });
            let location = $('#c-search-location').val().trim();
            if (fTags.length > 0) {
                location = (location + ' ' + fTags.join(' ')).trim();
            }

            const pref = $('#c-search-prefecture').val(); // array
            const jobCat = $('#c-search-job-category').val(); // array
            const indCat = $('#c-search-industry-category').val(); // array
            const empType = $('#c-search-employment-type').val(); // array
            const minSal = $('#c-search-salary-min').val();
            const sort = $('#c-search-sort').val();
            const managementStatus = $('#c-search-management-status').val();

            try {
                let query = supabase.from('users')
                    .select('*, candidate_profiles(*)')
                    .eq('role', 'candidate')
                    .eq('organization_id', currentUser.organization_id);

                // ... (Auth Logic) ...
                const isAdmin = ['org_admin', 'admin', 'super_admin'].includes(currentUser.role);
                const isStaff = ['coach', 'ca', 'ra'].includes(currentUser.role);
                const limitView = currentUser.organizations && currentUser.organizations.settings && (currentUser.organizations.settings.limit_agent_view === true || currentUser.organizations.settings.limit_agent_view === 'true');

                if (!isAdmin && isStaff && limitView) {
                    query = query.eq('coach_id', currentUser.id);
                }

                const { data: users, error } = await query;
                if (error) throw error;

                // Client-side Filtering
                let results = users.map(u => {
                    const p = Array.isArray(u.candidate_profiles) ? u.candidate_profiles[0] : u.candidate_profiles;
                    return { ...u, ...p, id: u.id };
                });

                results = results.filter(u => u.status !== 'suspended');

                if (managementStatus && managementStatus !== 'all') {
                    results = results.filter(u => u.management_status === managementStatus || (managementStatus === 'active' && !u.management_status));
                }

                if (keyword) {
                    results = results.filter(u =>
                        (u.name && u.name.toLowerCase().includes(keyword)) ||
                        (u.skills && u.skills.toLowerCase().includes(keyword)) ||
                        (u.work_history && u.work_history.toLowerCase().includes(keyword))
                    );
                }

                if (location) {
                    results = results.filter(u =>
                        (u.desired_location && (Array.isArray(u.desired_location) ? u.desired_location.join(' ') : u.desired_location).toLowerCase().includes(location.toLowerCase()))
                    );
                }

                if (pref && pref.length > 0) {
                    results = results.filter(u => {
                        if (!u.desired_location) return false;
                        const uLocs = Array.isArray(u.desired_location) ? u.desired_location : u.desired_location.split(',');
                        return uLocs.some(ul => pref.some(p => ul.includes(p)));
                    });
                }

                if (jobCat && jobCat.length > 0) {
                    results = results.filter(u => {
                        if (!u.desired_job_type) return false;
                        const uVals = Array.isArray(u.desired_job_type) ? u.desired_job_type : u.desired_job_type.split(',');
                        return uVals.some(v => jobCat.some(c => v.includes(c)));
                    });
                }

                if (minSal) {
                    results = results.filter(u => (u.desired_salary || 0) / 10000 >= minSal);
                }

                // Sort
                if (sort === 'created_at-desc') results.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                else if (sort === 'age-asc') results.sort((a, b) => (a.age || 999) - (b.age || 999));
                else if (sort === 'age-desc') results.sort((a, b) => (b.age || 0) - (a.age || 0));
                else if (sort === 'salary-desc') results.sort((a, b) => (b.desired_salary || 0) - (a.desired_salary || 0));

                // ページネーション処理
                currentCandidatePage = page;
                currentCandidateFilters = filters;
                allCandidatesCache = results;

                const totalCount = results.length;
                totalCandidatePages = Math.ceil(totalCount / CANDIDATES_PER_PAGE);

                const from = (page - 1) * CANDIDATES_PER_PAGE;
                const to = from + CANDIDATES_PER_PAGE;
                const paginatedResults = results.slice(from, to);

                console.log(`Loaded candidate page ${page}/${totalCandidatePages}, showing ${paginatedResults.length} candidates (total: ${totalCount})`);

                renderCandidateResults(paginatedResults, totalCount);
                renderCandidatePagination();

            } catch (e) {
                console.error(e);
            } finally {
                hideLoading();
            }
        }

        // 候補者ページネーションUIのレンダリング
        function renderCandidatePagination() {
            const container = $('#candidate-pagination-container');
            if (!container.length) {
                // ページネーションコンテナが存在しない場合は作成
                $('#candidate-results-container').after('<div id="candidate-pagination-container" class="mt-6"></div>');
            }

            if (totalCandidatePages <= 1) {
                $('#candidate-pagination-container').html('');
                return;
            }

            const maxButtons = 5;
            let startPage = Math.max(1, currentCandidatePage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalCandidatePages, startPage + maxButtons - 1);

            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            let html = '<div class="flex justify-center items-center gap-2">';

            // 前へボタン
            if (currentCandidatePage > 1) {
                html += `<button onclick="searchCandidates(currentCandidateFilters, ${currentCandidatePage - 1})" 
                    class="px-4 py-2 border rounded-lg hover:bg-gray-50 transition">
                    <i class="fas fa-chevron-left"></i> 前へ
                </button>`;
            }

            // ページ番号ボタン
            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === currentCandidatePage;
                html += `<button onclick="searchCandidates(currentCandidateFilters, ${i})" 
                    class="px-4 py-2 border rounded-lg transition ${isActive ? 'bg-indigo-600 text-white' : 'hover:bg-gray-50'}">
                    ${i}
                </button>`;
            }

            // 次へボタン
            if (currentCandidatePage < totalCandidatePages) {
                html += `<button onclick="searchCandidates(currentCandidateFilters, ${currentCandidatePage + 1})" 
                    class="px-4 py-2 border rounded-lg hover:bg-gray-50 transition">
                    次へ <i class="fas fa-chevron-right"></i>
                </button>`;
            }

            html += '</div>';
            html += `<div class="text-center mt-2 text-sm text-gray-600">
                ページ ${currentCandidatePage} / ${totalCandidatePages}
            </div>`;

            $('#candidate-pagination-container').html(html);
        }

        // AIマッチング実行 (求人 -> 求職者)
        // AIマッチング実行 (2段階: ルールベース選抜 -> AI詳細評価)
        window.runJobToCandidateMatching = async function () {
            if (!selectedTargetJobId) {
                alert('対象求人を選択してください');
                return;
            }

            // チェックされた候補者を取得
            const checkedIds = $('.candidate-select-checkbox:checked').map((_, el) => $(el).val()).get();
            const isSubset = checkedIds.length > 0;

            console.log('Running Matching. Selected:', checkedIds.length);
            showLoading('候補者を抽出中...');

            try {
                const job = allCandidateSearchJobs.find(j => j.id === selectedTargetJobId);
                if (!job) throw new Error("Selected Job Not Found");

                let candidates = [];

                // 候補者取得
                if (isSubset) {
                    const { data: users } = await supabase.from('users')
                        .select('*, candidate_profiles(*)')
                        .in('id', checkedIds);
                    if (users) candidates = users;
                } else {
                    const { data: users } = await supabase.from('users')
                        .select('*, candidate_profiles(*)')
                        .eq('role', 'candidate')
                        .eq('organization_id', currentUser.organization_id);
                    if (users) candidates = users;
                }

                // Normalization
                candidates = candidates.map(u => {
                    const p = Array.isArray(u.candidate_profiles) ? u.candidate_profiles[0] : u.candidate_profiles;
                    return { ...u, ...p, id: u.id };
                });

                // 停止中ユーザーおよび活動終了ユーザーの除外
                candidates = candidates.filter(u => u.status !== 'suspended' && u.management_status !== 'inactive');

                // 1. ルールベーススコアリング
                const scored = candidates.map(c => {
                    const scores = calculateClientSideMatchScores(job, c);
                    return {
                        candidate: c,
                        ...scores,
                        recommendation_reason: generateClientSideRecommendationReason(job, c, scores)
                    };
                });

                // スコア順にソート (ルールベース)
                scored.sort((a, b) => b.match_score - a.match_score);

                // 2. 絞り込み (上位5名かつスコア40点以上)
                const AI_EVAL_LIMIT = 30;
                const AI_EVAL_THRESHOLD = 40;

                const candidatesForAI = scored.filter(s => s.match_score >= AI_EVAL_THRESHOLD).slice(0, AI_EVAL_LIMIT);

                hideLoading();

                if (candidatesForAI.length === 0) {
                    alert('AI評価を行う基準（スコア40点以上）を満たす候補者が見つかりませんでした。');
                    renderCandidateResults([]);
                    return;
                }

                // 確認
                const confirmMsg = `ルールベース評価により、上位${candidatesForAI.length} 名の候補者を抽出しました。\n（閾値: 40点以上 / 最大30名）\n\nこれらの候補者に対して、生成AIによる詳細評価を実行しますか？\n（プロンプトを用いた詳細分析を行います。量が多い場合は少し時間がかかる場合があります。）`;

                if (!confirm(confirmMsg)) {
                    // キャンセルした場合はルールベースの結果を表示
                    renderMatchingResults(scored, '#candidate-results-container');
                    alert(`AI評価をキャンセルしました。\nルールベース評価の結果（全${scored.length} 件）を表示します。`);
                    return;
                }

                // 3. AI評価実行
                showLoading(`AIが抽出された${candidatesForAI.length}名の候補者を詳細評価中...\nしばらくお待ちください。`);

                // 並列処理でEdge Functionを呼び出す
                const aiPromises = candidatesForAI.map(async (item) => {
                    try {


                        const { data, error } = await supabase.functions.invoke('ai-matching', {
                            body: {
                                user: item.candidate,
                                jobs: [job]
                            }
                        });

                        if (error) throw error;
                        if (!data || data.length === 0) throw new Error("No Data");

                        const result = data[0];

                        // マージ
                        return {
                            ...item,
                            match_score: result.match_score || item.match_score,
                            recommendation_reason: result.recommendation_reason || result.reason,

                            // 詳細スコアの上書き (AI結果にあれば優先)
                            skill_match_score: result.skill_match_score ?? item.skill_match_score,
                            experience_match_score: result.experience_match_score ?? item.experience_match_score,
                            location_match_score: result.location_match_score ?? item.location_match_score,
                            salary_match_score: result.salary_match_score ?? item.salary_match_score,
                            culture_match_score: result.culture_match_score ?? item.culture_match_score,

                            ai_details: result.details,
                            is_ai_evaluated: true
                        };

                    } catch (e) {
                        console.error('AI Error for', item.candidate.name, e);
                        return { ...item, recommendation_reason: item.recommendation_reason + ' (AI評価エラー)' };
                    }
                });

                const aiResults = await Promise.all(aiPromises);

                // 再ソート（AIスコアで順位が変わる可能性あり）
                aiResults.sort((a, b) => b.match_score - a.match_score);

                // 表示 (AI評価されたものだけを表示)
                isAImatchingResultView = true;

                // キャッシュに保存
                aiResults.forEach(r => {
                    const key = `${r.candidate.id}_${selectedTargetJobId}`;
                    aiResultCache[key] = r.ai_details;
                });

                renderMatchingResults(aiResults, '#candidate-results-container');

                // バーの状態をリセット（次は「保存」ボタンが出るようにするため）
                clearAllSelectedCandidates();

                alert(`AI詳細評価が完了しました。\n${aiResults.length} 名の候補者を表示します。`);

            } catch (e) {
                console.error(e);
                alert('エラーが発生しました: ' + e.message);
            } finally {
                hideLoading();
            }
        }

        window.saveCandidatesToRecommendations = async function () {
            const checkedIds = $('.candidate-select-checkbox:checked').map((_, el) => $(el).val()).get();
            if (checkedIds.length === 0) return;
            if (!selectedTargetJobId) {
                alert('対象の求人が選択されていません');
                return;
            }

            showLoading('おすすめに保存中...');
            try {
                const recs = checkedIds.map(userId => {
                    const key = `${userId}_${selectedTargetJobId}`;
                    const details = aiResultCache[key];

                    const card = $(`.candidate-select-checkbox[value="${userId}"]`).closest('.border');
                    const scoreText = card.find('span:contains("マッチ度:")').text();
                    const score = parseFloat(scoreText.replace('マッチ度:', '').replace('%', '')) || 0;

                    return {
                        organization_id: currentUser.organization_id,
                        user_id: userId,
                        job_id: selectedTargetJobId,
                        score: score,
                        reason: card.find('.bg-blue-50 p, .bg-gray-50 p').first().text().trim() || 'AIマッチング評価済み',
                        recommended_by: currentUser.id,
                        details: details || null
                    };
                });

                console.log('Saving recommendations:', recs);

                // 既存レコードをチェックして、insert/updateを個別に実行
                for (const rec of recs) {
                    // 既存レコードを確認
                    const { data: existing, error: checkError } = await supabase
                        .from('recommendations')
                        .select('id')
                        .eq('user_id', rec.user_id)
                        .eq('job_id', rec.job_id)
                        .maybeSingle();

                    if (checkError) {
                        console.error('Check error:', checkError);
                        throw checkError;
                    }

                    if (existing) {
                        // 既存レコードを更新
                        const { error: updateError } = await supabase
                            .from('recommendations')
                            .update({
                                score: rec.score,
                                reason: rec.reason,
                                recommended_by: rec.recommended_by,
                                details: rec.details
                            })
                            .eq('id', existing.id);

                        if (updateError) throw updateError;
                    } else {
                        // 新規レコードを挿入
                        const { error: insertError } = await supabase
                            .from('recommendations')
                            .insert(rec);

                        if (insertError) throw insertError;
                    }
                }

                alert(`${recs.length} 名を「おすすめ求人」に保存しました。`);
                clearAllSelectedCandidates();
            } catch (e) {
                console.error('Failed to save recommendations:', e);
                alert('保存に失敗しました: ' + e.message);
            } finally {
                hideLoading();
            }
        };

        window.clearMatchResults = function () {
            $('#candidate-results-container').empty();
            $('#candidate-results-container').html(`
            <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-search text-4xl mb-3"></i>
                        <p>条件を指定して検索してください</p>
                    </div>
            `);
            // Also restore checkboxes? They are gone.
            // Reset Floating Bar
            $('#c-selected-count').text('0');
            $('#candidate-float-bar').addClass('translate-y-full').addClass('hidden');
            $('#candidate-results-container').css('padding-bottom', '0');
        }

        function renderCandidateResults(candidates, totalCount = null) {
            isAImatchingResultView = false;
            // バーを隠す
            $('#candidate-float-bar').addClass('translate-y-full').addClass('hidden');

            const container = $('#candidate-results-container');
            if (candidates.length === 0) {
                container.html('<div class="text-center p-8 text-gray-500">条件に一致する求職者は見つかりませんでした</div>');
                animateCandidateCount(0);
                return;
            }

            // 件数表示アニメーション
            animateCandidateCount(totalCount);

            if (totalCount !== null) {
                const resultInfo = `<div class="mb-4 text-sm text-gray-600">
                    検索結果: ${totalCount}名 (${currentCandidatePage}ページ目を表示中)
                </div>`;
                container.append(resultInfo);
            }

            const html = candidates.map(c => {
                return renderCandidateCard({
                    candidate: c,
                    // マッチ度などは一旦0または検索結果から (検索ロジックによってはスコアが入る)
                    match_score: c.match_score || 0,
                    skill_match_score: c.skill_match_score || 0,
                    experience_match_score: c.experience_match_score || 0,
                    location_match_score: c.location_match_score || 0,
                    salary_match_score: c.salary_match_score || 0,
                    culture_match_score: c.culture_match_score || 0
                });
            }).join('');
            container.html(html);
        }

        window.copyToClipboard = function (btn) {
            const card = $(btn).closest('.bg-white');
            const subject = (card.find('.scout-subject-input').val() || card.find('p:contains("件名:")').text().replace('件名: ', '') || '').trim();
            const body = (card.find('.scout-body-textarea').val() || card.find('.scout-body-text').text() || '').trim();

            const textToCopy = `件名: ${subject} \n\n${body} `;

            navigator.clipboard.writeText(textToCopy).then(() => {
                const originalHtml = $(btn).html();
                $(btn).html('<i class="fas fa-check text-green-500 text-xl"></i>');
                setTimeout(() => {
                    $(btn).html(originalHtml);
                }, 2000);
            });
        }


        // ========================
        // Pagination Variables
        // ========================
        // Pagination Variables
        // ========================
        const ITEMS_PER_PAGE = 20;
        let currentJobPage = 1;
        let totalJobPages = 1;
        let currentJobFilters = {};
        let allJobsCache = []; // ページネーション用のキャッシュ

        async function loadJobs(filters = {}, page = 1) {
            if (!currentUser) return

            showLoading()
            try {
                // マスタデータのロード
                await loadMasterDataForSearch()

                // 管理者・コーチ・CA・スーパー管理者用ツールの表示制御
                if (['org_admin', 'admin', 'coach', 'ca', 'super_admin'].includes(currentUser.role)) {
                    $('#admin-job-search-tools').removeClass('hidden')
                    $('#candidate-ai-matching-tools').addClass('hidden')
                    $('#exclude-matched-container').hide();

                    // ユーザーリストのロード（未ロードの場合）
                    if (allCandidateUsers.length === 0) {
                        await loadCandidateUsers()
                    }
                } else if (currentUser.role === 'candidate') {
                    // 求職者用AIマッチングツールを表示
                    $('#admin-job-search-tools').addClass('hidden')
                    $('#candidate-ai-matching-tools').addClass('hidden')
                    $('#exclude-matched-container').show();
                } else {
                    $('#admin-job-search-tools').addClass('hidden')
                    $('#candidate-ai-matching-tools').addClass('hidden')
                    $('#exclude-matched-container').hide();
                }

                // お気に入りと保存された検索条件をロード
                await Promise.all([loadFavorites(), loadSavedSearchesList()])

                // マスタロード完了後にフィルタを適用（初回ロード＝引数filtersが空の場合のみ）
                // executeSearchからの呼び出し（filtersがある場合）は再適用しないことで無限ループを防ぐ
                if (Object.keys(filters).length === 0) {
                    const savedFilters = loadSearchFilters();
                    if (savedFilters) {
                        console.log('Applying saved filters after master load');
                        applySearchFilters(savedFilters);
                    }
                }


                let query = window.supabase
                    .from('jobs')
                    .select('*, companies(name)', { count: 'exact' })
                    .eq('organization_id', currentUser.organization_id)
                // .eq('status', 'active') // 一時的にステータスフィルタを解除（インポートデータが表示されない問題対応）

                // ソート順の適用は最後に移動しました

                // キーワード検索 (AND/OR)
                if (filters.keyword) {
                    const keywords = filters.keyword.split(/[\s　]+/).filter(k => k) // 空白で分割
                    const mode = filters.keywordMode || 'OR'

                    if (keywords.length > 0) {
                        // Note: companies.name での検索はSupabaseの複雑なクエリになるため、
                        // ここでは簡易的に title, description, company (legacy column) を対象とするか、
                        // もしくは companiesテーブルを検索してIDを取得してから...という手順が必要だが、
                        // パフォーマンスを考慮し、一旦既存の company カラムも検索対象に含める（データ移行済みなら company カラムにも値が入っているはず）
                        // 本来的には .or(`title.ilike.% ${ k }%, description.ilike.% ${ k }%, companies.name.ilike.% ${ k }% `) としたいが、
                        // ネストしたリレーションの検索は構文が異なる。
                        // 暫定対応: company (legacy) カラムが同期されている前提で検索。
                        if (mode === 'OR') {
                            const conditions = keywords.map(k =>
                                `title.ilike.%${k}%,description.ilike.%${k}%,company.ilike.%${k}%`
                            ).join(',')
                            query = query.or(conditions)
                        } else {
                            keywords.forEach(k => {
                                query = query.or(`title.ilike.%${k}%,description.ilike.%${k}%,company.ilike.%${k}%`)
                            })
                        }
                    }
                }

                if (filters.location) {
                    query = query.ilike('location', `%${filters.location}%`)
                }
                if (filters.prefecture && filters.prefecture.length > 0) {
                    const prefs = Array.isArray(filters.prefecture) ? filters.prefecture : [filters.prefecture];
                    const conditions = prefs.map(p => `location.ilike.%${p}%`).join(',');
                    query = query.or(conditions);
                }
                if (filters.employmentType && filters.employmentType.length > 0) {
                    const types = Array.isArray(filters.employmentType) ? filters.employmentType : [filters.employmentType];
                    // 完全一致(in)から部分一致(ilike)に変更して、カンマ区切りデータ等に対応
                    const conditions = types.map(t => `employment_type.ilike.%${t}%`).join(',');
                    query = query.or(conditions);
                }
                if (filters.jobCategory && filters.jobCategory.length > 0) {
                    const cats = Array.isArray(filters.jobCategory) ? filters.jobCategory : [filters.jobCategory];
                    // 完全一致(in)から部分一致(ilike)に変更 + 表記揺れ対策（括弧除去）
                    const conditions = cats.map(c => {
                        let cleanC = c.replace(/[\(（].*?[\)）]/g, '').trim();
                        if (!cleanC) cleanC = c;
                        return `job_category.ilike.%${cleanC}%`;
                    }).join(',');
                    query = query.or(conditions);
                }
                if (filters.industryCategory && filters.industryCategory.length > 0) {
                    const inds = Array.isArray(filters.industryCategory) ? filters.industryCategory : [filters.industryCategory];
                    const conditions = inds.map(i => {
                        let cleanI = i.replace(/[\(（].*?[\)）]/g, '').trim();
                        if (!cleanI) cleanI = i;
                        return `industry_category.ilike.%${cleanI}%`;
                    }).join(',');
                    query = query.or(conditions);
                }
                if (filters.salaryMin) {
                    const minVal = parseInt(filters.salaryMin) * 10000;
                    // 年収条件を満たすか、年収情報がない(null)求人を表示
                    query = query.or(`salary_max.gte.${minVal}, salary_max.is.null`);
                }
                if (filters.jobExperienceOk) {
                    query = query.eq('job_experience_ok', '可')
                }
                if (filters.industryExperienceOk) {
                    query = query.eq('industry_experience_ok', '可')
                }
                if (filters.isRemote) {
                    query = query.eq('is_remote', true)
                }

                // お気に入りのみフィルタリング
                if (filters.favoritesOnly) {
                    if (favoriteJobIds.size > 0) {
                        query = query.in('id', Array.from(favoriteJobIds));
                    } else {
                        // お気に入りが0件の場合は何も表示しない
                        // id.in.() はエラーになる可能性があるため、あり得ない条件を入れる
                        query = query.eq('id', '00000000-0000-0000-0000-000000000000'); // Dummy UUID
                    }
                }

                // AIマッチング済み除外
                if (filters.excludeMatched) {
                    const targetUserId = selectedTargetUserId || (currentUser.role === 'candidate' ? currentUser.id : null);

                    if (targetUserId) {
                        // 推薦済み求人IDを取得
                        const { data: recommendations } = await supabase
                            .from('recommendations')
                            .select('job_id')
                            .eq('user_id', targetUserId);

                        if (recommendations && recommendations.length > 0) {
                            const matchedJobIds = recommendations.map(r => r.job_id);
                            if (matchedJobIds.length > 0) {
                                query = query.not('id', 'in', `(${matchedJobIds.join(',')})`);
                            }
                        }
                    }
                }

                // ソート順の適用
                const sortParam = filters.sort || 'created_at-desc';
                console.log('Applying sort:', sortParam);
                const [sortCol, sortOrder] = sortParam.split('-');
                query = query.order(sortCol, { ascending: sortOrder === 'asc' });

                // ページネーション: 総件数を取得 + 指定ページのデータを取得
                currentJobPage = page;
                currentJobFilters = filters;

                const from = (page - 1) * ITEMS_PER_PAGE;
                const to = from + ITEMS_PER_PAGE - 1;

                console.log('Fetching jobs with pagination:', { from, to, page });

                // クエリを再構築してcompaniesとのjoinを追加
                // range()とcount取得を同時に行う
                const { data: jobs, error, count } = await query
                    .range(from, to);

                console.log('Query result:', { jobs: jobs?.length, error, count });

                if (error) {
                    console.error('Supabase query error:', error);
                    throw error;
                }

                // 総ページ数を計算
                totalJobPages = count ? Math.ceil(count / ITEMS_PER_PAGE) : 1;

                console.log(`Loaded page ${page}/${totalJobPages}, showing ${jobs?.length || 0} jobs (total: ${count})`);

                await renderJobs(jobs, count)
                renderJobPagination();
            } catch (error) {
                console.error('Load jobs error:', error)
                $('#jobs-container').html('<p class="text-red-500">求人の読み込みに失敗しました</p>')
            } finally {
                hideLoading()
            }
        }

        // ページネーションUIのレンダリング
        function renderJobPagination() {
            console.log('renderJobPagination called:', { currentJobPage, totalJobPages });

            const container = $('#job-pagination-container');
            if (!container.length) {
                console.log('Creating pagination container');
                // ページネーションコンテナが存在しない場合は作成
                $('#jobs-container').after('<div id="job-pagination-container" class="mt-6"></div>');
            }

            if (totalJobPages <= 1) {
                console.log('Only 1 page, hiding pagination');
                $('#job-pagination-container').html('');
                return;
            }

            console.log('Rendering pagination UI');
            const maxButtons = 5; // 表示するページボタンの最大数
            let startPage = Math.max(1, currentJobPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalJobPages, startPage + maxButtons - 1);

            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            let html = '<div class="flex justify-center items-center gap-2">';

            // 前へボタン
            if (currentJobPage > 1) {
                html += `<button onclick="goToJobPage(${currentJobPage - 1})" 
                    class="px-4 py-2 border rounded-lg hover:bg-gray-50 transition">
                    <i class="fas fa-chevron-left"></i> 前へ
                </button>`;
            }

            // ページ番号ボタン
            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === currentJobPage;
                html += `<button onclick="goToJobPage(${i})" 
                    class="px-4 py-2 border rounded-lg transition ${isActive ? 'bg-indigo-600 text-white' : 'hover:bg-gray-50'}">
                    ${i}
                </button>`;
            }

            // 次へボタン
            if (currentJobPage < totalJobPages) {
                html += `<button onclick="goToJobPage(${currentJobPage + 1})" 
                    class="px-4 py-2 border rounded-lg hover:bg-gray-50 transition">
                    次へ <i class="fas fa-chevron-right"></i>
                </button>`;
            }

            html += '</div>';
            html += `<div class="text-center mt-2 text-sm text-gray-600">
                ページ ${currentJobPage} / ${totalJobPages}
            </div>`;

            console.log('Setting pagination HTML');
            $('#job-pagination-container').html(html);
        }

        // 求人検索のページ移動
        window.goToJobPage = function (page) {
            loadJobs(currentJobFilters, page);
        }



        // 検索条件の保存・読み込み
        // 検索条件の保存・読み込み
        window.saveSearchFilters = function (filters) {
            if (!currentUser) {
                console.warn('Cannot save search filters: currentUser is null');
                return;
            }
            const key = `job_search_filters_${currentUser.id} `;
            localStorage.setItem(key, JSON.stringify(filters));
            console.log('Search filters saved:', filters);
        }

        window.loadSearchFilters = function () {
            if (!currentUser) {
                console.warn('Cannot load search filters: currentUser is null');
                return null;
            }
            const key = `job_search_filters_${currentUser.id} `;
            const saved = localStorage.getItem(key);
            console.log('Search filters loaded:', saved ? JSON.parse(saved) : 'none');
            return saved ? JSON.parse(saved) : null;
        }

        window.applySearchFilters = function applySearchFilters(filters) {
            if (!filters) return;

            console.log('Applying search filters:', filters);
            $('#search-keyword').val(filters.keyword || '');
            if (filters.keywordMode) {
                $(`input[name="search-keyword-mode"][value="${filters.keywordMode}"]`).prop('checked', true);
            }
            $('#search-location').val(filters.location || '');
            $('#search-prefecture').val(filters.prefecture || []).trigger('change');
            $('#search-employment-type').val(filters.employmentType || []).trigger('change');
            $('#search-job-category').val(filters.jobCategory || []).trigger('change');
            $('#search-industry-category').val(filters.industryCategory || []).trigger('change');
            $('#search-salary-min').val(filters.salaryMin || '');
            $('#search-job-experience-ok').prop('checked', !!filters.jobExperienceOk);
            $('#search-industry-experience-ok').prop('checked', !!filters.industryExperienceOk);
            $('#search-is-remote').prop('checked', !!filters.isRemote);
            $('#search-exclude-matched').prop('checked', !!filters.excludeMatched);
            $('#search-favorites-only').prop('checked', !!filters.favoritesOnly);
        }

        function animateJobCount(targetCount) {
            const display = $('#job-count-display-premium');
            const numberElement = display.find('#job-count-number');
            if (targetCount === null || targetCount === undefined) {
                display.addClass('hidden');
                return;
            }
            display.removeClass('hidden');
            const duration = 1200;
            const startTime = Date.now();
            const startValue = 0;
            function updateCount() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeProgress = 1 - Math.pow(1 - progress, 4);
                const currentValue = Math.floor(startValue + (targetCount - startValue) * easeProgress);
                numberElement.text(currentValue.toLocaleString());
                if (progress < 1) requestAnimationFrame(updateCount);
                else numberElement.text(targetCount.toLocaleString());
            }
            requestAnimationFrame(updateCount);
        }

        function animateCandidateCount(targetCount) {
            const display = $('#candidate-count-display-premium');
            const numberElement = display.find('#candidate-count-number');

            if (targetCount === null || targetCount === undefined) {
                display.addClass('hidden');
                return;
            }

            display.removeClass('hidden');

            const duration = 1200;
            const startTime = Date.now();
            const startValue = 0;

            function updateCount() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeProgress = 1 - Math.pow(1 - progress, 4);
                const currentValue = Math.floor(startValue + (targetCount - startValue) * easeProgress);

                numberElement.text(currentValue.toLocaleString());

                if (progress < 1) {
                    requestAnimationFrame(updateCount);
                } else {
                    numberElement.text(targetCount.toLocaleString());
                }
            }

            requestAnimationFrame(updateCount);
        }

        // --- Premium Search UI Support ---
        function setupPremiumSearchUI() {

            // Salary slider sync
            $('#search-salary-slider').on('input', function () {
                const val = $(this).val();
                $('#search-salary-min').val(val);
                $('#salary-display').text(val === '0' ? '指定なし' : val + ' 万円以上');
            });

            $('#c-search-salary-slider').on('input', function () {
                const val = $(this).val();
                $('#c-search-salary-min').val(val);
                $('#c-salary-display').text(val === '0' ? '指定なし' : val + ' 万円以上');
            });

            // Tag sync for Select2
            function syncTags(selectId, containerId, colorClass) {
                const $select = $('#' + selectId);
                const $container = $('#' + containerId);
                if (!$select.length || !$container.length) return;

                $select.off('change.syncTags').on('change.syncTags', function () {
                    $container.empty();
                    const selected = $select.select2('data') || [];
                    selected.forEach(item => {
                        const $tag = $(`
                            <span class="premium-tag ${colorClass}">
                                ${item.text}
                                <i class="fas fa-times tag-remove ml-2 opacity-50 hover:opacity-100" data-id="${item.id}"></i>
                            </span>
                        `);
                        $tag.find('.tag-remove').on('click', function (e) {
                            e.stopPropagation();
                            const id = $(this).data('id');
                            const values = $select.val() || [];
                            const newValues = values.filter(v => v !== id.toString());
                            $select.val(newValues).trigger('change');
                        });
                        $container.append($tag);
                    });
                });
            }

            // Jobs
            syncTags('search-industry-category', 'tags-industry', 'tag-blue');
            syncTags('search-job-category', 'tags-job', 'tag-blue');
            syncTags('search-employment-type', 'tags-employment', 'tag-blue');
            syncTags('search-prefecture', 'tags-prefecture', 'tag-blue');

            // Candidates
            syncTags('c-search-industry-category', 'c-tags-industry', 'tag-blue');
            syncTags('c-search-job-category', 'c-tags-job', 'tag-blue');
            syncTags('c-search-employment-type', 'c-tags-employment', 'tag-blue');
            syncTags('c-search-prefecture', 'c-tags-prefecture', 'tag-blue');

            // Freelance Keyword Tagging
            function setupFreeword(inputId, containerId, syncFunc, colorClass = 'tag-amber') {
                const $input = $('#' + inputId);
                const $container = $('#' + containerId);
                if (!$input.length) return;

                $input.off('keypress').on('keypress', function (e) {
                    if (e.which === 13) {
                        e.preventDefault();
                        const val = $(this).val().trim();
                        if (val) {
                            addFreewordTag(val, $container, syncFunc, colorClass);
                            $(this).val('');
                        }
                    }
                });
            }

            function addFreewordTag(val, $container, syncFunc, colorClass) {
                // 重複チェック
                let exists = false;
                $container.find('.premium-tag').each(function () {
                    if ($(this).text().trim() === val) exists = true;
                });
                if (exists) return;

                const $tag = $(`
                    <span class="premium-tag ${colorClass}">
                        ${val}
                        <i class="fas fa-times tag-remove ml-2 opacity-50 hover:opacity-100"></i>
                    </span>
                `);
                $tag.find('.tag-remove').on('click', function () {
                    $tag.remove();
                    if (syncFunc) syncFunc();
                });
                $container.append($tag);
                if (syncFunc) syncFunc();
            }

            // Keyword tagging
            setupFreeword('search-keyword', 'tags-keyword', null, 'tag-indigo');
            setupFreeword('c-search-keyword', 'c-tags-keyword', null, 'tag-indigo');

            // Location tagging
            setupFreeword('search-location', 'tags-freeword', null, 'tag-amber');
            setupFreeword('c-search-location', 'c-tags-location', null, 'tag-amber');
        }

        // デバウンス関数
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        const executeSearch = async function () {
            console.log('executeSearch called. Sort:', $('#search-sort').val());

            // キーワードタグ
            const kTags = [];
            $('#tags-keyword .premium-tag').each(function () {
                kTags.push($(this).text().trim().toLowerCase());
            });
            let keyword = $('#search-keyword').val().toLowerCase().trim();
            if (kTags.length > 0) {
                keyword = (keyword + ' ' + kTags.join(' ')).trim();
            }

            // フリーワードタグ
            let freeword = $('#search-location').val().trim();
            const fTags = [];
            $('#tags-freeword .premium-tag').each(function () {
                fTags.push($(this).text().trim());
            });
            if (fTags.length > 0) {
                freeword = (freeword + ' ' + fTags.join(' ')).trim();
            }

            const filters = {
                keyword: $('#search-keyword').val().trim(),
                keywordMode: $('input[name="search-keyword-mode"]:checked').val(),
                location: freeword,
                prefecture: $('#search-prefecture').val(),
                employmentType: $('#search-employment-type').val(),
                jobCategory: $('#search-job-category').val(),
                industryCategory: $('#search-industry-category').val(),
                salaryMin: $('#search-salary-min').val(),
                jobExperienceOk: $('#search-job-experience-ok').is(':checked'),
                industryExperienceOk: $('#search-industry-experience-ok').is(':checked'),
                isRemote: $('#search-is-remote').is(':checked'),
                excludeMatched: $('#search-exclude-matched').is(':checked'),
                favoritesOnly: $('#search-favorites-only').is(':checked'),
                sort: $('#search-sort').val()
            }

            // 検索条件を保存
            saveSearchFilters(filters);

            await loadJobs(filters)
        };

        // デバウンス付きの検索実行関数
        window.searchJobs = debounce(executeSearch, 500);

        // 手動で即時実行したい場合（ボタンクリックなど）
        window.searchJobsImmediate = executeSearch;

        // イベントリスナーの初期化
        function initSearchEventListeners() {
            const searchInputs = [
                '#search-keyword',
                '#search-salary-min'
            ];
            const searchSelects = [
                '#search-sort'
            ];
            const searchCheckboxes = [
                'input[name="search-keyword-mode"]',
                '#search-job-experience-ok',
                '#search-industry-experience-ok',
                '#search-is-remote',
                '#search-exclude-matched',
                '#search-favorites-only'
            ];

            // 以前のリスナーを解除して際設定（一部を自動検索対象に）
            // Select2などのchangeイベントはタグ同期側でトリガーされる可能性があるため慎重に
            // ここでは検索ボタンでの実行を基本とする
        }

        // ページロード時にも実行
        $(document).ready(function () {
            initSearchEventListeners();
            setupPremiumSearchUI();
        });

        window.clearSearch = function () {
            // テキスト入力のクリア
            $('#search-keyword').val('');
            $('#tags-keyword').empty();
            $('#search-location').val('');
            $('#tags-freeword').empty();
            $('#search-salary-min').val('');

            // ラジオボタンのリセット
            $('input[name="search-keyword-mode"][value="OR"]').prop('checked', true);

            // チェックボックスのクリア (順序を前に移動)
            $('#search-job-experience-ok').prop('checked', false);
            $('#search-industry-experience-ok').prop('checked', false);
            $('#search-is-remote').prop('checked', false);
            $('#search-exclude-matched').prop('checked', false);
            $('#search-favorites-only').prop('checked', false);

            // ソートのリセット
            $('#search-sort').val('created_at-desc');

            // Select2のクリア (トリガーによる再検索が走る可能性があるため最後に)
            $('#search-prefecture').val([]).trigger('change');
            $('#search-employment-type').val([]).trigger('change');
            $('#search-job-category').val([]).trigger('change');
            $('#search-industry-category').val([]).trigger('change');

            // 保存されたフィルタをクリア（空オブジェクトで上書き）
            if (window.saveSearchFilters) window.saveSearchFilters({});

            // 最後に検索実行
            if (typeof loadJobs === 'function') loadJobs();
        }

        /**
         * 上位30件を選択する
         */
        window.selectTop30Jobs = function () {
            const checkboxes = $('.job-checkbox:not(:disabled)');
            if (checkboxes.length === 0) {
                alert('選択可能な求人がありません');
                return;
            }

            let count = 0;
            checkboxes.each(function (index) {
                if (index < 30) {
                    if (!$(this).prop('checked')) {
                        $(this).trigger('click');
                        count++;
                    }
                }
            });
        }

        // ========================
        // Favorites & Saved Searches
        // ========================
        async function loadFavorites() {
            if (!currentUser) return
            try {
                const { data: favs, error } = await supabase
                    .from('favorites')
                    .select('job_id')
                    .eq('user_id', currentUser.id)

                if (error) throw error
                favoriteJobIds = new Set(favs.map(f => f.job_id))
            } catch (error) {
                console.error('Load favorites error:', error)
            }
        }

        // お気に入りモーダルを開く
        window.openFavoritesModal = async function () {
            if (!currentUser) return;

            showLoading();
            try {
                // お気に入り求人IDを取得（念のため再取得）
                await loadFavorites();

                if (favoriteJobIds.size === 0) {
                    $('#favorites-list').html('<p class="text-center text-gray-500 py-8">お気に入りに登録された求人はありません</p>');
                    $('#favorites-modal').removeClass('hidden');
                    hideLoading();
                    return;
                }

                // 求人情報を取得
                const { data: jobs, error } = await supabase
                    .from('jobs')
                    .select('*, companies(name)')
                    .in('id', Array.from(favoriteJobIds));

                if (error) throw error;

                renderFavoriteJobs(jobs);
                $('#favorites-modal').removeClass('hidden');

            } catch (error) {
                console.error('Open favorites error:', error);
                alert('お気に入りの読み込みに失敗しました');
            } finally {
                hideLoading();
            }
        }

        // お気に入り求人の描画
        function renderFavoriteJobs(jobs) {
            const container = $('#favorites-list');
            container.empty();

            const html = jobs.map(job => `
            <div class="border-b border-gray-200 py-4 last:border-0">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h4 class="text-lg font-bold text-gray-900 hover:text-indigo-600 cursor-pointer"
                            onclick="showJobDetail('${job.id}')">${job.title}</h4>
                        <p class="text-sm text-gray-600">${job.companies?.name || job.company}</p>
                        <div class="flex items-center gap-3 mt-2 text-sm text-gray-500">
                            <span><i class="fas fa-map-marker-alt mr-1"></i>${job.location}</span>
                            <span><i class="fas fa-yen-sign mr-1"></i>${(job.salary_min / 10000).toLocaleString()}万 - ${(job.salary_max / 10000).toLocaleString()}万円</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="showJobDetail('${job.id}')" class="text-indigo-600 hover:text-indigo-800 p-2 text-sm">
                            詳細
                        </button>
                        <button onclick="toggleFavorite('${job.id}'); $(this).closest('.border-b').remove();"
                            class="text-pink-500 hover:text-pink-700 p-2" title="お気に入りから削除">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
                </div>
            `).join('');

            container.html(html);
        }

        window.closeFavoritesModal = function () {
            $('#favorites-modal').addClass('hidden');
        }

        window.toggleFavorite = async function (jobId) {
            if (!currentUser) return
            const isFav = favoriteJobIds.has(jobId)

            try {
                const updateButtons = (active) => {
                    // リスト用アイコン
                    const listIcon = $(`#fav-btn-${jobId} i`);
                    if (active) {
                        listIcon.removeClass('far text-gray-400').addClass('fas text-pink-500');
                    } else {
                        listIcon.removeClass('fas text-pink-500').addClass('far text-gray-400');
                    }

                    // モーダル用ボタン
                    const modalBtn = $(`#modal-fav-btn-${jobId}`);
                    if (modalBtn.length) {
                        if (active) {
                            modalBtn.removeClass('border-gray-300 text-gray-700').addClass('border-pink-500 text-pink-600');
                            modalBtn.html('<i class="fas fa-heart mr-2"></i>お気に入り登録済み');
                        } else {
                            modalBtn.removeClass('border-pink-500 text-pink-600').addClass('border-gray-300 text-gray-700');
                            modalBtn.html('<i class="fas fa-heart mr-2"></i>お気に入りに追加');
                        }
                    }
                };

                if (isFav) {
                    // Remove
                    const { error } = await supabase
                        .from('favorites')
                        .delete()
                        .eq('user_id', currentUser.id)
                        .eq('job_id', jobId)
                    if (error) throw error
                    favoriteJobIds.delete(jobId)
                    updateButtons(false);
                } else {
                    // Add
                    const { error } = await supabase
                        .from('favorites')
                        .insert({ user_id: currentUser.id, job_id: jobId })
                    if (error) throw error
                    favoriteJobIds.add(jobId)
                    updateButtons(true);
                }
            } catch (error) {
                console.error('Toggle favorite error:', error)
                alert('お気に入りの更新に失敗しました')
            }
        }

        async function loadSavedSearchesList() {
            if (!currentUser) return
            try {
                const { data: searches, error } = await supabase
                    .from('saved_searches')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })

                if (error) throw error
                savedSearches = searches

                const select = $('#saved-searches-select')
                select.empty()
                select.append('<option value="">保存した検索条件</option>')

                if (searches.length > 0) {
                    select.removeClass('hidden')
                    searches.forEach(s => {
                        select.append(`<option value="${s.id}">${s.name}</option>`)
                    })
                } else {
                    select.addClass('hidden')
                }
            } catch (error) {
                console.error('Load saved searches error:', error)
            }
        }

        window.saveSearchConditions = async function () {
            if (!currentUser) return
            const name = prompt('検索条件の名前を入力してください:')
            if (!name) return

            const criteria = {
                keyword: $('#search-keyword').val().trim(),
                keywordMode: $('input[name="search-keyword-mode"]:checked').val(),
                location: $('#search-location').val().trim(),
                prefecture: $('#search-prefecture').val(),
                employmentType: $('#search-employment-type').val(),
                jobCategory: $('#search-job-category').val(),
                industryCategory: $('#search-industry-category').val(),
                salaryMin: $('#search-salary-min').val(),
                jobExperienceOk: $('#search-job-experience-ok').is(':checked'),
                industryExperienceOk: $('#search-industry-experience-ok').is(':checked'),
                isRemote: $('#search-is-remote').is(':checked'),
                excludeMatched: $('#search-exclude-matched').is(':checked'),
                favoritesOnly: $('#search-favorites-only').is(':checked')
            }

            try {
                const { error } = await supabase
                    .from('saved_searches')
                    .insert({
                        user_id: currentUser.id,
                        name: name,
                        criteria: criteria
                    })

                if (error) throw error
                alert('検索条件を保存しました')
                loadSavedSearchesList()
            } catch (error) {
                console.error('Save search error:', error)
                alert('保存に失敗しました')
            }
        }

        window.loadSavedSearch = function (searchId) {
            if (!searchId) return
            const search = savedSearches.find(s => s.id === searchId)
            if (!search) return

            const c = search.criteria
            $('#search-keyword').val(c.keyword || '')
            if (c.keywordMode) $(`input[name="search-keyword-mode"][value="${c.keywordMode}"]`).prop('checked', true)
            $('#search-location').val(c.location || '')
            $('#search-prefecture').val(c.prefecture || []).trigger('change')
            $('#search-employment-type').val(c.employmentType || []).trigger('change')
            $('#search-job-category').val(c.jobCategory || []).trigger('change')
            $('#search-industry-category').val(c.industryCategory || []).trigger('change')
            $('#search-salary-min').val(c.salaryMin || '')
            $('#search-job-experience-ok').prop('checked', !!c.jobExperienceOk)
            $('#search-industry-experience-ok').prop('checked', !!c.industryExperienceOk)
            $('#search-is-remote').prop('checked', !!c.isRemote)
            $('#search-exclude-matched').prop('checked', !!c.excludeMatched)
            $('#search-favorites-only').prop('checked', !!c.favoritesOnly)
            $('#search-favorites-only').prop('checked', !!c.favoritesOnly)

            // 検索実行
            searchJobs()
        }

        // AI推薦済み求人IDのキャッシュ
        let recommendedJobIds = new Set();

        async function renderJobs(jobs, totalCount = null) {
            const container = $('#jobs-container')
            container.empty()

            if (jobs.length === 0) {
                container.html('<p class="text-gray-500 text-center py-8">現在募集中の求人はありません</p>')
                animateJobCount(0); // カウンターを0にリセット
                return
            }

            // 求人件数をアニメーション表示
            animateJobCount(totalCount);

            // 検索結果の件数表示
            if (totalCount !== null) {
                const resultInfo = `<div class="mb-4 text-sm text-gray-600">
                    検索結果: ${totalCount}件 (${currentJobPage}ページ目を表示中)
                </div>`;
                container.append(resultInfo);
            }

            const isAdminOrCoach = currentUser && ['org_admin', 'admin', 'coach', 'ca', 'super_admin'].includes(currentUser.role)
            const isCandidate = currentUser && currentUser.role === 'candidate'

            // 選択中のユーザーIDを取得
            const selectedUserId = selectedTargetUserId;
            console.log('renderJobs - selectedUserId:', selectedUserId);

            // AI推薦済み求人IDを取得
            // 管理者/コーチ/CAが対象ユーザーを選択している場合、または求職者が自分自身の場合
            const targetUserId = isAdminOrCoach ? selectedUserId : (isCandidate ? currentUser.id : null);
            console.log('renderJobs - targetUserId:', targetUserId);

            let recommendedJobsMap = new Map(); // job_id -> score のマップ
            let appliedJobIds = new Set();

            if (targetUserId) {
                try {
                    // AI推薦済み求人とスコアを取得
                    const { data: recommendations, error: recError } = await supabase
                        .from('recommendations')
                        .select('job_id, score')
                        .eq('user_id', targetUserId);

                    console.log('renderJobs - recommendations:', recommendations, 'error:', recError);

                    if (!recError && recommendations) {
                        recommendations.forEach(r => {
                            recommendedJobsMap.set(r.job_id, r.score);
                        });
                        recommendedJobIds = new Set(recommendations.map(r => r.job_id));
                    }

                    // 応募済み求人を取得
                    const { data: applications, error: appError } = await supabase
                        .from('applications')
                        .select('job_id')
                        .eq('user_id', targetUserId);

                    if (!appError && applications) {
                        appliedJobIds = new Set(applications.map(a => a.job_id));
                    }
                } catch (error) {
                    console.error('Failed to load recommendations/applications:', error);
                }
            }

            // コンテナをグリッドレイアウトに変更
            container.attr('class', 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6');

            const html = jobs.map(job => {
                const isSelected = selectedJobIds.has(job.id)
                const isRecommended = recommendedJobIds.has(job.id)
                const recommendationScore = recommendedJobsMap.get(job.id)
                const isApplied = appliedJobIds.has(job.id)
                const showCheckbox = isAdminOrCoach || isCandidate

                // 給与フォーマット用ヘルパー（簡易）
                const formatSalary = (val) => val ? (val / 10000).toLocaleString() + '万' : '-';

                return `
                <div class="bg-white border border-gray-200 rounded-lg p-5 shadow-sm hover:shadow-md transition flex flex-col h-full relative ${isSelected ? 'ring-2 ring-indigo-500 bg-indigo-50' : ''} ${isRecommended ? 'ring-2 ring-purple-400' : ''}">
                    
                    <div class="flex justify-between items-start mb-3">
                         <div class="flex items-center z-10">
                            ${showCheckbox ? `
                                <input type="checkbox" 
                                    class="job-checkbox w-5 h-5 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 mr-2 cursor-pointer ${isRecommended ? 'opacity-50 cursor-not-allowed' : ''}"
                                    onclick="event.stopPropagation(); toggleJobSelection('${job.id}')"
                                    ${isSelected ? 'checked' : ''}
                                    ${isRecommended ? 'disabled' : ''}>
                            ` : ''}
                         </div>
                         <div class="flex items-center gap-2 z-10">
                            ${isRecommended ? `<span class="text-xs font-bold text-white bg-gradient-to-r from-purple-500 to-indigo-600 px-2 py-1 rounded-full shadow-sm"><i class="fas fa-robot mr-1"></i>${recommendationScore}%</span>` : ''}
                            ${isApplied ? `<span class="text-xs font-bold text-green-700 bg-green-100 px-2 py-1 rounded-full"><i class="fas fa-check mr-1"></i>応募済</span>` : ''}
                            <button id="fav-btn-${job.id}" onclick="event.stopPropagation(); toggleFavorite('${job.id}')" class="text-gray-400 hover:text-pink-500 transition p-1">
                                <i class="${favoriteJobIds.has(job.id) ? 'fas text-pink-500' : 'far'} fa-heart text-xl"></i>
                            </button>
                         </div>
                    </div>

                    <div class="flex-grow cursor-pointer" onclick="showJobDetailModal('${job.id}')">
                        <h3 class="font-bold text-lg text-gray-900 mb-2 leading-snug line-clamp-2 hover:text-indigo-600 transition">
                            ${job.title}
                        </h3>
                        
                        <p class="text-xs font-medium text-gray-500 mb-3 line-clamp-1"><i class="far fa-building mr-1"></i>${job.companies?.name || job.company}</p>
                        
                        <div class="flex flex-wrap gap-2 mb-4">
                            ${job.job_category ? `<span class="px-2 py-1 text-xs bg-indigo-50 text-indigo-700 rounded border border-indigo-100">${job.job_category}</span>` : ''}
                            ${job.is_remote ? `<span class="px-2 py-1 text-xs bg-emerald-50 text-emerald-700 rounded border border-emerald-100">リモート可</span>` : ''}
                            ${job.tags && Array.isArray(job.tags) ? job.tags.slice(0, 2).map(tag => `<span class="px-2 py-1 text-xs bg-gray-50 text-gray-600 rounded border border-gray-200">${tag}</span>`).join('') : ''}
                        </div>

                        <div class="space-y-2 text-sm text-gray-600 mb-4 border-t border-gray-100 pt-3">
                            <div class="flex items-start gap-2">
                                <i class="fas fa-map-marker-alt mt-1 text-gray-400 w-4 text-center"></i>
                                <span class="line-clamp-1">${job.location || '勤務地未定'}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-yen-sign text-gray-400 w-4 text-center"></i>
                                <span>${formatSalary(job.salary_min)} - ${formatSalary(job.salary_max)}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-briefcase text-gray-400 w-4 text-center"></i>
                                <span>${job.employment_type || '-'}</span>
                            </div>
                        </div>

                        ${job.welcome_requirements ? `
                        <div class="mb-2">
                            <span class="font-bold text-gray-700 block text-xs mb-1">【尚可要件】</span>
                            <p class="text-xs text-gray-500 line-clamp-2">${job.welcome_requirements}</p>
                        </div>
                        ` : ''}
                    </div>

                    <div class="pt-4 mt-auto border-t border-gray-100 flex flex-col gap-2">
                        ${isAdminOrCoach ? `
                        <div class="flex gap-2 mb-1">
                             ${!isRecommended ? `
                            <button onclick="event.stopPropagation(); openRecommendJobModal('${job.id}')" 
                                class="flex-1 bg-amber-500 text-white py-1.5 rounded text-xs font-bold hover:bg-amber-600 transition">
                                <i class="fas fa-star mr-1"></i>紹介
                            </button>
                            ` : ''}
                            ${!isApplied ? `
                            <button onclick="event.stopPropagation(); applyForJob('${job.id}', '${targetUserId || ''}')" 
                                class="flex-1 bg-indigo-600 text-white py-1.5 rounded text-xs font-bold hover:bg-indigo-700 transition">
                                <i class="fas fa-paper-plane mr-1"></i>代理応募
                            </button>
                            ` : ''}
                        </div>
                        ` : ''}
                    
                        <button onclick="event.stopPropagation(); showJobDetailModal('${job.id}')" class="w-full bg-slate-700 text-white text-sm font-bold py-2.5 rounded-lg hover:bg-slate-800 transition shadow-sm hover:shadow">
                            詳細を見る
                        </button>
                    </div>
                </div>
            `}).join('')

            container.html(html)
        }

        // ========================
        // Email Notification Utility
        // ========================
        async function sendEmail(type, to, data) {
            try {
                const { data: result, error } = await supabase.functions.invoke('send-email', {
                    body: { type, to, data }
                })

                if (error) throw error
                console.log('Email sent successfully:', result)
                return true
            } catch (error) {
                console.error('Failed to send email:', error)
                // メール送信失敗はユーザー体験を阻害しないよう、ログ出力のみでfalseを返す
                return false
            }
        }

        window.applyForJob = async function (jobId, targetUserId = null) {
            const isProxy = !!targetUserId;
            const applicantId = targetUserId || currentUser.id;

            const confirmMsg = isProxy ? 'このユーザーの代理として求人に応募しますか？' : 'この求人に応募しますか？';
            if (!confirm(confirmMsg)) return;

            showLoading()
            try {
                // 応募者情報を取得
                let applicant = currentUser;
                if (isProxy) {
                    const { data: user, error } = await supabase
                        .from('users')
                        .select('*')
                        .eq('id', applicantId)
                        .single();
                    if (error) throw error;
                    applicant = user;
                }

                const { data: application, error } = await supabase
                    .from('applications')
                    .insert({
                        organization_id: currentUser.organization_id,
                        user_id: applicantId,
                        job_id: jobId,
                        status: '応募完了'
                    })
                    .select('*, jobs(title, company)')
                    .single()

                if (error) throw error

                // ログ記録
                await auditLog.applicationSubmitted(application.id, {
                    job_id: jobId,
                    applicant_id: applicantId,
                    is_proxy: isProxy
                });

                // 通知作成処理
                try {
                    // 1. 管理者を取得
                    const { data: admins } = await supabase
                        .from('users')
                        .select('id')
                        .eq('organization_id', currentUser.organization_id)
                        .in('role', ['org_admin', 'admin'])

                    // 2. 担当コーチを取得
                    let coachId = applicant.coach_id

                    // 通知対象者のリスト作成（重複排除）
                    const notifyUserIds = new Set(admins?.map(a => a.id) || [])
                    if (coachId) notifyUserIds.add(coachId)

                    const jobTitle = application.jobs.title
                    const companyName = application.jobs.company

                    // 通知メッセージ
                    const message = isProxy
                        ? `${currentUser.name} さんが ${applicant.name} さんの代理で「${companyName} / ${jobTitle}」に応募しました。`
                        : `${applicant.name} さんが「${companyName} / ${jobTitle}」に応募しました。`;

                    // 通知レコード作成
                    const notifications = Array.from(notifyUserIds).map(uid => ({
                        user_id: uid,
                        title: '新規応募・選考登録がありました',
                        message: message,
                        read: false,
                        created_at: new Date().toISOString()
                    }))

                    if (notifications.length > 0) {
                        await supabase.from('notifications').insert(notifications)
                    }

                    // メール送信 (応募者へ)
                    await sendEmail('application_submitted', applicant.email, {
                        userName: applicant.name,
                        jobTitle: jobTitle,
                        companyName: companyName
                    })

                } catch (notifyError) {
                    console.error('Notification/Email error:', notifyError)
                    // 通知エラーはメイン処理を止めない
                }

                alert('応募が完了しました！')
                loadDashboard() // 統計更新
            } catch (error) {
                console.error('Application error:', error)
                if (error.code === '23505') { // Unique violation
                    alert('すでにこの求人には応募済みです')
                } else {
                    alert('応募に失敗しました: ' + error.message)
                }
            } finally {
                hideLoading()
            }
        }

        // ========================
        // Applications History
        // ========================
        async function loadApplications() {
            if (!currentUser) return

            showLoading()
            try {
                let query = supabase
                    .from('applications')
                    .select('*, jobs(*), users!applications_user_id_fkey(name), recommendation_text, resume_document_url, recommendation_letter_url')
                    .order('updated_at', { ascending: false })

                if (currentUser.role === 'super_admin' || currentUser.role === 'org_admin' || currentUser.role === 'admin') {
                    // 管理者: 組織内の全応募
                    query = query.eq('organization_id', currentUser.organization_id)
                } else if (currentUser.role === 'coach') {
                    // コーチ: 担当ユーザーの応募
                    // まず担当ユーザーIDを取得
                    const { data: assignedUsers } = await supabase
                        .from('users')
                        .select('id')
                        .eq('coach_id', currentUser.id)

                    const assignedUserIds = assignedUsers?.map(u => u.id) || []

                    if (assignedUserIds.length > 0) {
                        query = query.in('user_id', assignedUserIds)
                    } else {
                        // 担当ユーザーがいない場合は何も表示しない
                        renderApplications([])
                        hideLoading()
                        return
                    }
                } else {
                    // 一般ユーザー: 自身の応募
                    query = query.eq('user_id', currentUser.id)
                }

                const { data: applications, error } = await query

                if (error) throw error

                renderApplications(applications)
            } catch (error) {
                console.error('Load applications error:', error)
                console.error('Error details:', JSON.stringify(error, null, 2))
                $('#applications-container').html(`<p class="text-red-500">応募履歴の読み込みに失敗しました: ${error.message || JSON.stringify(error)}</p>`)
            } finally {
                hideLoading()
            }
        }

        function renderApplications(applications) {
            const container = $('#applications-container')
            container.empty()

            if (applications.length === 0) {
                container.html('<p class="text-gray-500 text-center py-8">まだ応募していません</p>')
                return
            }

            // デフォルトのステータス設定（マスタデータがない場合のフォールバック）
            let statusConfig = {
                'pending': { label: '書類選考中', color: 'bg-yellow-100 text-yellow-800' },
                'screening': { label: '書類選考中', color: 'bg-yellow-100 text-yellow-800' },
                'interview': { label: '面接予定', color: 'bg-blue-100 text-blue-800' },
                'offered': { label: '内定', color: 'bg-green-100 text-green-800' },
                'rejected': { label: '不合格', color: 'bg-red-100 text-red-800' },
                'withdrawn': { label: '辞退', color: 'bg-gray-100 text-gray-800' }
            };

            // マスタデータがある場合は上書き
            if (typeof masterSelectionStatuses !== 'undefined' && masterSelectionStatuses.length > 0) {
                const statusColorMap = {
                    'pending': 'bg-yellow-100 text-yellow-800',
                    'screening': 'bg-yellow-100 text-yellow-800',
                    'interview': 'bg-blue-100 text-blue-800',
                    'offered': 'bg-green-100 text-green-800',
                    'rejected': 'bg-red-100 text-red-800',
                    'withdrawn': 'bg-gray-100 text-gray-800'
                };

                masterSelectionStatuses.forEach(s => {
                    statusConfig[s.value] = {
                        label: s.label,
                        color: statusColorMap[s.value] || 'bg-gray-100 text-gray-800'
                    };
                });
            }

            const html = applications.map(app => {
                const status = statusConfig[app.status] || statusConfig['pending']
                const appliedDate = new Date(app.updated_at).toLocaleDateString('ja-JP')

                return `
                    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-4 hover:shadow-md transition">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <h3 class="text-xl font-bold text-gray-900">${app.jobs ? app.jobs.title : '不明な求人'}</h3>
                                </div>
                                <p class="text-gray-600">${app.jobs ? app.jobs.company : '-'}</p>
                                ${app.users ? `<p class="text-sm text-indigo-600 mt-1"><i class="fas fa-user mr-1"></i>応募者: ${app.users.name}</p>` : ''}
                            </div>
                            <div class="flex flex-col items-end gap-2">
                                <span class="px-3 py-1 rounded-full text-sm font-medium ${status.color}">
                                    ${status.label}
                                </span>
                                ${['org_admin', 'admin', 'super_admin', 'coach', 'ca', 'ra'].includes(currentUser.role) ? `
                                <button onclick="openRecommendationModal('${app.id}')" class="text-sm font-medium flex items-center ${app.recommendation_text ? 'text-green-600 hover:text-green-800' : 'text-indigo-600 hover:text-indigo-800'}">
                                    <i class="fas ${app.recommendation_text ? 'fa-check-circle' : 'fa-file-alt'} mr-1"></i>
                                    ${app.recommendation_text ? '推薦文編集' : '推薦文作成'}
                                </button>
                                <button onclick="generateDocument('${app.id}', 'resume')" class="text-sm font-medium flex items-center ${app.resume_document_url ? 'text-blue-600 hover:text-blue-800' : 'text-blue-600 hover:text-blue-800'}">
                                    <i class="fas ${app.resume_document_url ? 'fa-download' : 'fa-file-word'} mr-1"></i>
                                    ${app.resume_document_url ? '職務経歴書DL' : '職務経歴書作成'}
                                </button>
                                <button onclick="generateDocument('${app.id}', 'recommendation')" class="text-sm font-medium flex items-center ${app.recommendation_letter_url ? 'text-purple-600 hover:text-purple-800' : 'text-purple-600 hover:text-purple-800'}">
                                    <i class="fas ${app.recommendation_letter_url ? 'fa-download' : 'fa-file-word'} mr-1"></i>
                                    ${app.recommendation_letter_url ? '推薦状DL' : '推薦状作成'}
                                </button>
                                <button onclick="openProgressModal('${app.id}')"
                                    class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition flex items-center gap-2">
                                    <i class="fas fa-tasks"></i>
                                    <span>進捗管理</span>
                                </button>
                                ` : ''}
                            </div>
                        </div>

                        <div class="flex items-center gap-4 text-sm text-gray-600 mb-3">
                            <span><i class="fas fa-map-marker-alt mr-1"></i> ${app.jobs?.location || '勤務地不明'}</span>
                            <span><i class="fas fa-briefcase mr-1"></i> ${app.jobs?.employment_type || '-'}</span>
                            <span><i class="fas fa-calendar mr-1"></i> 応募日: ${appliedDate}</span>
                        </div>

                        ${app.jobs?.salary_max ? `
                        <div class="text-sm text-gray-700 mb-3">
                            <i class="fas fa-yen-sign mr-1"></i>
                            想定年収: ${(app.jobs.salary_min / 10000).toLocaleString()}万 - ${(app.jobs.salary_max / 10000).toLocaleString()}万円
                        </div>
                        ` : ''}

                        <p class="text-gray-600 text-sm line-clamp-2">${app.jobs?.description || '求人情報が見つかりません'}</p>
                    </div>
                `
            }).join('')

            container.html(html)
        }

        // ========================
        // ========================
        // Progress Management
        // ========================
        let currentApplicationData = null;
        let applicationStatuses = [];

        function getSelectionStatusLabel(value) {
            if (!value) return '-';
            // すでに日本語（ラベル）の場合はそのまま返す
            if (/^[^\x00-\x7F]+$/.test(value)) return value;

            // マスタから検索
            if (applicationStatuses && applicationStatuses.length > 0) {
                const status = applicationStatuses.find(s => s.value === value);
                if (status) return status.label;
            }

            // フォールバック
            const labels = {
                'pending': '書類選考中',
                'screening': '書類選考中',
                'interview': '面接予定',
                'offered': '内定',
                'rejected': '不合格',
                'withdrawn': '辞退',
                'applied': '応募完了'
            };
            return labels[value] || value;
        }

        window.openProgressModal = async function (applicationId) {
            showLoading();
            try {
                // 応募情報を取得 (emailも取得)
                const { data: application, error: appError } = await supabase
                    .from('applications')
                    .select('*, jobs(title, company), users!applications_user_id_fkey(name, email)')
                    .eq('id', applicationId)
                    .single();

                if (appError) throw appError;

                currentApplicationData = application;
                $('#progress-application-id').val(applicationId);
                $('#progress-job-title').text(application.jobs.title);
                $('#progress-company-name').text(application.jobs.company);
                $('#progress-user-name').text(`応募者: ${application.users.name}`);
                $('#progress-current-status').data('code', application.status || 'applied').val(getSelectionStatusLabel(application.status || 'applied'));

                // ステータスマスタデータを読み込み
                await loadApplicationStatuses();

                // 進捗履歴を読み込み
                await loadProgressHistory(applicationId);

                $('#progress-modal').removeClass('hidden');
            } catch (error) {
                console.error('Open progress modal error:', error);
                alert('進捗情報の読み込みに失敗しました');
            } finally {
                hideLoading();
            }
        };

        window.closeProgressModal = function () {
            $('#progress-modal').addClass('hidden');
            $('#progress-update-form')[0].reset();
            currentApplicationData = null;
        };

        async function loadApplicationStatuses() {
            if (applicationStatuses.length > 0) return;

            try {
                const { data: masters, error } = await supabase
                    .from('master_data')
                    .select('*')
                    .eq('type', 'selection_status')
                    .eq('is_active', true)
                    .order('sort_order');

                if (error) throw error;

                const validMasters = masters.filter(m =>
                    m.organization_id === null || m.organization_id === currentUser.organization_id
                );

                applicationStatuses = validMasters;

                const select = $('#progress-new-status');
                select.html('<option value="">選択してください</option>');
                validMasters.forEach(m => {
                    select.append(`<option value="${m.value}">${m.label}</option>`);
                });
            } catch (error) {
                console.error('Load application statuses error:', error);
            }
        }

        async function loadProgressHistory(applicationId) {
            try {
                const { data: history, error } = await supabase
                    .from('progress_history')
                    .select('*')
                    .eq('application_id', applicationId)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                renderProgressTimeline(history || []);
            } catch (error) {
                console.error('Load progress history error:', error);
                $('#progress-timeline').html('<p class="text-red-500 text-sm">履歴の読み込みに失敗しました</p>');
            }
        }

        function renderProgressTimeline(history) {
            const container = $('#progress-timeline');
            container.empty();

            if (history.length === 0) {
                container.html('<p class="text-gray-500 text-sm">まだ進捗履歴がありません</p>');
                return;
            }

            const html = history.map((item, index) => {
                const date = new Date(item.created_at).toLocaleString('ja-JP');
                const isLast = index === history.length - 1;

                return `
                    <div class="flex gap-4">
                        <div class="flex flex-col items-center">
                            <div class="w-3 h-3 rounded-full ${isLast ? 'bg-gray-300' : 'bg-indigo-600'}"></div>
                            ${!isLast ? '<div class="w-0.5 h-full bg-gray-200 mt-1"></div>' : ''}
                        </div>
                        <div class="flex-1 pb-6">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-semibold text-gray-900">${getSelectionStatusLabel(item.old_status) || '新規'} → ${getSelectionStatusLabel(item.new_status)}</span>
                                <span class="text-xs text-gray-500">${date}</span>
                            </div>
                            ${item.changed_by_name ? `<p class="text-sm text-gray-600 mb-1">変更者: ${item.changed_by_name}</p>` : ''}
                            ${item.notes ? `<p class="text-sm text-gray-700 bg-gray-50 p-2 rounded">${item.notes}</p>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            container.html(html);
        }

        $('#progress-update-form').on('submit', async function (e) {
            e.preventDefault();
            showLoading();

            const applicationId = $('#progress-application-id').val();
            const oldStatus = $('#progress-current-status').data('code');
            const newStatus = $('#progress-new-status').val();
            const notes = $('#progress-notes').val();

            try {
                // 1. 応募ステータスを更新
                const { error: updateError } = await supabase
                    .from('applications')
                    .update({
                        status: newStatus,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', applicationId);

                if (updateError) throw updateError;

                // 2. 進捗履歴を記録
                const { error: historyError } = await supabase
                    .from('progress_history')
                    .insert({
                        organization_id: currentUser.organization_id,
                        application_id: applicationId,
                        user_id: currentApplicationData.user_id,
                        old_status: oldStatus,
                        new_status: newStatus,
                        notes: notes,
                        changed_by: currentUser.id,
                        changed_by_name: currentUser.name
                    });

                if (historyError) throw historyError;

                // 3. メール通知 (ステータス変更時)
                if (currentApplicationData && currentApplicationData.users && currentApplicationData.users.email) {
                    await sendEmail('status_changed', currentApplicationData.users.email, {
                        userName: currentApplicationData.users.name,
                        jobTitle: currentApplicationData.jobs.title,
                        companyName: currentApplicationData.jobs.company,
                        oldStatus: oldStatus,
                        newStatus: newStatus
                    });
                }

                alert('ステータスを更新しました');

                // 4. 画面を更新
                $('#progress-current-status').val(newStatus);
                $('#progress-notes').val('');
                $('#progress-new-status').val('');

                await loadProgressHistory(applicationId);
                loadApplications(); // 応募一覧も更新

            } catch (error) {
                console.error('Update progress error:', error);
                alert('ステータスの更新に失敗しました: ' + error.message);
            } finally {
                hideLoading();
            }
        });

        // ========================
        // AI Recommendations
        // ========================
        // ========================
        // Recommendation Pagination Variables
        // ========================
        const RECOMMENDATIONS_PER_PAGE = 20;
        let currentRecommendationPage = 1;
        let totalRecommendationPages = 1;
        let allRecommendationsCache = []; // フィルタリング後の全推薦

        async function loadRecommendations(page = 1) {
            // window.currentUserを使用（スコープ問題を回避）
            const currentUser = window.currentUser;

            if (!currentUser) {
                console.error('currentUser is null in loadRecommendations');
                hideLoading();
                alert('セッションが切れています。再度ログインしてください。');
                showPage('login-page');
                return;
            }

            showLoading()
            try {
                // CAロールも管理者/コーチ枠に追加
                const isAdminOrCoach = ['org_admin', 'admin', 'coach', 'ca', 'super_admin'].includes(currentUser.role);

                // 1. 推薦データを取得
                let query = supabase
                    .from('recommendations')
                    .select('*, jobs(*), users!recommendations_user_id_fkey(id, name, email)')
                    .order('score', { ascending: false });

                if (isAdminOrCoach) {
                    // 管理者/コーチの場合は組織内の全推薦を取得
                    query = query.eq('organization_id', currentUser.organization_id);
                } else {
                    // 一般ユーザーは自分の推薦のみ
                    query = query.eq('user_id', currentUser.id);
                }

                let { data: recs, error } = await query;
                if (error) throw error;

                console.log('Loaded recommendations:', recs); // デバッグ用ログ

                // 2. ユーザー情報を取得（管理者/コーチの場合）
                let users = [];
                let allCandidates = []; // プルダウン用の全候補者リスト

                if (isAdminOrCoach) {
                    // 2-1. 推薦データに関連するユーザー情報を取得
                    if (recs.length > 0) {
                        const userIds = [...new Set(recs.map(r => r.user_id))];
                        const { data: recUsers, error: usersError } = await supabase
                            .from('users')
                            .select('id, name, email, coach_id')
                            .in('id', userIds);

                        if (!usersError && recUsers) {
                            users = recUsers;
                        }
                    }

                    // 2-2. 組織内の全求職者を取得（プルダウン用）
                    // コーチ/CAの場合は担当求職者のみ、それ以外は組織内全員
                    let candidateQuery = supabase
                        .from('users')
                        .select('id, name, email, coach_id')
                        .eq('organization_id', currentUser.organization_id)
                        .eq('role', 'candidate');

                    if (currentUser.role === 'coach' || currentUser.role === 'ca') {
                        candidateQuery = candidateQuery.eq('coach_id', currentUser.id);
                    }
                    // 活動終了ユーザーを除外
                    candidateQuery = candidateQuery.neq('management_status', 'inactive');

                    const { data: candidates, error: candidateError } = await candidateQuery;
                    if (!candidateError && candidates) {
                        allCandidates = candidates;
                    }

                    // コーチまたはCAの場合は推薦データも担当求職者のみにフィルタリング
                    if (currentUser.role === 'coach' || currentUser.role === 'ca') {
                        const assignedUserIds = allCandidates.map(u => u.id);
                        // usersリストもフィルタリング
                        users = users.filter(u => assignedUserIds.includes(u.id));
                        // 推薦データもフィルタリング
                        // 注意: recsはconstではないが、再代入するためにletで宣言し直すか、ここでフィルタリングした新しい配列を使う
                        // ここではrecsの内容を直接書き換えることはできないので、renderに渡す際にフィルタリング済みのものを渡す
                    }

                    // 推薦データにユーザー情報をマージ
                    recs.forEach(rec => {
                        rec.users = users.find(u => u.id === rec.user_id) || allCandidates.find(u => u.id === rec.user_id);
                    });
                }

                // コーチ/CAの場合のフィルタリング適用
                let finalRecs = recs;
                if (currentUser.role === 'coach' || currentUser.role === 'ca') {
                    const assignedUserIds = allCandidates.map(u => u.id);
                    finalRecs = recs.filter(r => assignedUserIds.includes(r.user_id));
                }

                // 応募済み求人を取得
                let appliedJobIds = new Set();

                if (isAdminOrCoach) {
                    // 管理者/コーチの場合: 全ユーザーの応募済み求人を取得
                    try {
                        const { data: applications } = await supabase
                            .from('applications')
                            .select('job_id, user_id')
                            .eq('organization_id', currentUser.organization_id);

                        if (applications) {
                            // 全ての応募済み求人IDをSetに格納
                            appliedJobIds = new Set(applications.map(a => a.job_id));
                        }
                    } catch (error) {
                        console.error('Failed to load applications:', error);
                    }
                } else {
                    // 求職者の場合: 自分の応募済み求人のみ取得
                    try {
                        const { data: applications } = await supabase
                            .from('applications')
                            .select('job_id')
                            .eq('user_id', currentUser.id);

                        if (applications) {
                            appliedJobIds = new Set(applications.map(a => a.job_id));
                        }
                    } catch (error) {
                        console.error('Failed to load applications:', error);
                    }
                }

                renderRecommendations(finalRecs, isAdminOrCoach, allCandidates, appliedJobIds);

            } catch (error) {
                console.error('Load recommendations error:', error)
                $('#recommendations-container').html('<p class="text-red-500">推薦データの読み込みに失敗しました</p>')
            } finally {
                hideLoading()
            }
        }

        // 現在のタブ状態を保持
        let currentRecommendationTab = 'matches';
        let allRecommendations = [];
        let isAdminOrCoachView = false;
        let allCandidatesList = []; // プルダウン用
        let currentSelectedUserId = ''; // 選択中のユーザーID
        let appliedJobIdsCache = new Set(); // 応募済み求人ID

        let currentSortOption = 'date-desc'; // ソートオプション初期値（追加日順）

        // タブ切り替え関数
        window.switchRecommendationTab = function (tab) {
            currentRecommendationTab = tab;
            currentRecommendationPage = 1; // ページ番号をリセット

            // タブのスタイルを更新
            $('.rec-tab').removeClass('border-indigo-600 text-indigo-600').addClass('border-transparent text-gray-500');
            $(`#rec-tab-${tab}`).removeClass('border-transparent text-gray-500').addClass('border-indigo-600 text-indigo-600');

            // 推薦結果を再レンダリング
            renderRecommendations(allRecommendations, isAdminOrCoachView, allCandidatesList, appliedJobIdsCache);
        }

        // ソート切り替え関数
        window.sortRecommendations = function (option) {
            currentSortOption = option;
            currentRecommendationPage = 1; // ページ番号をリセット
            renderRecommendations(allRecommendations, isAdminOrCoachView, allCandidatesList, appliedJobIdsCache);
        }

        window.renderRecommendations = function (recs, isAdminOrCoach, candidates, appliedJobIds) {
            // 引数省略時のフォールバック
            if (recs === undefined) recs = allRecommendations;
            if (isAdminOrCoach === undefined) isAdminOrCoach = isAdminOrCoachView;
            if (candidates === undefined) candidates = allCandidatesList;
            if (appliedJobIds === undefined) appliedJobIds = appliedJobIdsCache;

            // グローバル変数に保存
            allRecommendations = recs;
            isAdminOrCoachView = isAdminOrCoach;
            allCandidatesList = candidates;
            appliedJobIdsCache = appliedJobIds;

            const container = $('#recommendations-container');

            // 見送り済みデータの取得
            const dismissedKey = (window.currentUser ? `dismissed_recs_${window.currentUser.id}` : 'dismissed_recs_temp');
            const dismissed = new Set(JSON.parse(localStorage.getItem(dismissedKey) || '[]'));

            // ユーザーフィルタリング
            let displayRecs = recs;
            if (currentSelectedUserId) {
                displayRecs = recs.filter(r => r.user_id === currentSelectedUserId);
            }

            // タブに応じてフィルタリング
            let filteredRecs = displayRecs.filter(rec => {
                const isDismissed = dismissed.has(rec.job_id);
                if (currentRecommendationTab === 'matches') {
                    // 提案タブ: スコア50%以上 かつ 見送りでない
                    return rec.score >= 50 && !isDismissed;
                } else {
                    // アンマッチタブ: スコア49%以下 または 見送り済み
                    return rec.score < 50 || isDismissed;
                }
            });

            // ソート処理

            filteredRecs.sort((a, b) => {
                // 見送り済みを後ろへ
                const aDis = dismissed.has(a.job_id) ? 1 : 0;
                const bDis = dismissed.has(b.job_id) ? 1 : 0;
                if (aDis !== bDis) return aDis - bDis;

                const [key, order] = currentSortOption.split('-');
                let valA, valB;

                if (key === 'score') {
                    valA = a.score;
                    valB = b.score;
                } else if (key === 'date') {
                    valA = new Date(a.created_at).getTime();
                    valB = new Date(b.created_at).getTime();
                }

                if (order === 'asc') {
                    return valA - valB;
                } else {
                    return valB - valA;
                }
            });

            // ページネーション処理
            allRecommendationsCache = filteredRecs;
            const totalCount = filteredRecs.length;
            totalRecommendationPages = Math.ceil(totalCount / RECOMMENDATIONS_PER_PAGE);

            const from = (currentRecommendationPage - 1) * RECOMMENDATIONS_PER_PAGE;
            const to = from + RECOMMENDATIONS_PER_PAGE;
            const paginatedRecs = filteredRecs.slice(from, to);

            console.log(`Loaded recommendation page ${currentRecommendationPage}/${totalRecommendationPages}, showing ${paginatedRecs.length} recommendations (total: ${totalCount})`);

            // コントロールエリア（ユーザーフィルター ＆ ソート）の構築
            let controlsHtml = '<div class="flex flex-wrap items-center justify-between mb-6 gap-4">';

            // 左側: ユーザーフィルター (管理者のみ)
            if (isAdminOrCoach) {
                // candidatesリストがあればそれを使用、なければ推薦データから抽出（後方互換）
                const userList = candidates.length > 0 ? candidates : [...new Map(recs.map(r => [r.users?.id, r.users])).values()].filter(u => u);

                controlsHtml += `
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-medium text-gray-700 whitespace-nowrap">求職者:</label>
                        <div class="w-64">
                            <select id="rec-user-filter" onchange="filterRecommendations(this.value)" class="select2 w-full">
                                <option value="">全員</option>
                                ${userList.map(u => `<option value="${u.id}" ${u.id === currentSelectedUserId ? 'selected' : ''}>${u.name} (${u.email || 'メールなし'})</option>`).join('')}
                            </select>
                        </div>
                    </div>
                `;
            } else {
                controlsHtml += '<div></div>'; // レイアウト調整用のスペーサー
            }

            // 右側: ソート（再実行ボタンは削除）
            controlsHtml += `
                <div class="flex items-center gap-2 ml-auto">
                    ${isAdminOrCoach ? `
                    <button onclick="reRunSelectedRecommendations()" class="bg-white text-indigo-600 border border-indigo-200 px-3 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-indigo-50 transition flex items-center gap-2 whitespace-nowrap">
                        <i class="fas fa-sync-alt"></i> 再判定
                    </button>
                    
                    <button onclick="openRecommendationMessageModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-indigo-700 transition flex items-center gap-2 whitespace-nowrap">
                        <i class="fas fa-envelope"></i> メッセージ作成
                    </button>
                    ` : ''}

                    <div class="flex items-center gap-2 ml-2 pl-4 border-l">
                        <label class="text-sm font-medium text-gray-700 whitespace-nowrap"><i class="fas fa-sort mr-1"></i></label>
                        <select onchange="sortRecommendations(this.value)" class="px-3 py-2 border rounded-lg text-sm cursor-pointer hover:bg-gray-50 border-gray-200">
                            <option value="score-desc" ${currentSortOption === 'score-desc' ? 'selected' : ''}>マッチ度順</option>
                            <option value="date-desc" ${currentSortOption === 'date-desc' ? 'selected' : ''}>新着順</option>
                            <option value="date-asc" ${currentSortOption === 'date-asc' ? 'selected' : ''}>古い順</option>
                        </select>
                    </div>
                </div>
            `;
            controlsHtml += '</div>';

            // 件数表示を追加
            if (totalCount > 0) {
                controlsHtml += `<div class="mb-4 text-sm text-gray-600">
                    検索結果: ${totalCount}件 (${currentRecommendationPage}ページ目を表示中)
                </div>`;
            }

            container.empty();

            if (paginatedRecs.length === 0 && totalCount === 0) {
                const tabLabel = currentRecommendationTab === 'matches' ? '推薦' : 'アンマッチ';
                // ユーザーが選択されているがデータがない場合と、本当にデータがない場合でメッセージを変える
                let message = `${tabLabel}はまだありません`;
                let subMessage = isAdminOrCoach ? '求人検索画面から対象ユーザーを選択してAI推薦を実行してください。' : 'あなたのプロフィールに基づいて、最適な求人をAIが分析します。';

                if (currentSelectedUserId) {
                    const selectedUser = candidates.find(u => u.id === currentSelectedUserId);
                    if (selectedUser) {
                        message = `${selectedUser.name} さんの${tabLabel}データはありません`;
                        subMessage = '求人検索画面からこのユーザーを選択してAI推薦を実行してください。';
                    }
                }

                container.html(controlsHtml + `
                    <div class="text-center py-12">
                        <div class="mb-4">
                            <i class="fas fa-robot text-6xl text-indigo-200"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">${message}</h3>
                        <p class="text-gray-600 mb-6">${subMessage}</p>
                        ${!isAdminOrCoach ? `
                        <button onclick="generateAIRecommendations()" 
                            class="bg-indigo-600 text-white px-8 py-3 rounded-lg hover:bg-indigo-700 transition font-bold shadow-lg">
                            <i class="fas fa-magic mr-2"></i>AI分析を開始する
                        </button>
                        ` : ''}
                    </div>
                `)
                return
            }

            const html = controlsHtml + `
                <div id="recommendations-list">
            ` + paginatedRecs.map(rec => {
                const matchColor = rec.score >= 50 ? 'bg-indigo-600' : 'bg-gray-500';
                // ユーザー情報がない場合のガード
                const userName = rec.users ? rec.users.name : '不明なユーザー';
                const userEmail = rec.users ? rec.users.email : '';
                const isApplied = appliedJobIds.has(rec.job_id);

                // 見送りチェック
                const isDismissed = dismissed.has(rec.job_id);
                const cardStyle = isDismissed ? 'bg-gray-100 opacity-60' : 'bg-white border-gray-200 hover:shadow-md';

                return `
                <div class="${cardStyle} border rounded-lg p-6 transition mb-4 relative overflow-hidden group cursor-pointer rec-card" 
                     data-user-id="${rec.user_id}" 
                     data-job-id="${rec.job_id}"
                     onclick="showJobDetailModal('${rec.job_id}')">
                    ${isAdminOrCoach ? `
                    <div class="absolute top-0 left-0 p-3 z-20" onclick="event.stopPropagation()">
                        <div class="bg-white rounded-md shadow-sm border border-gray-200 p-1 flex items-center justify-center">
                            <input type="checkbox" class="w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 rec-checkbox cursor-pointer" 
                                   value="${rec.id}" data-job-id="${rec.job_id}" data-user-id="${rec.user_id}">
                        </div>
                    </div>
                    ` : ''}
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow cursor-pointer relative" onclick="window.customShowJobDetailModal('${rec.job_id}')">
                    <div class="flex flex-col md:flex-row gap-6">
                        <!-- メインコンテンツ (左側) -->
                        <div class="flex-1">
                            ${isAdminOrCoach ? `
                            <div class="flex items-center gap-2 mb-3">
                                <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-bold whitespace-nowrap">
                                    ${rec.users.name || '求職者'} 様
                                </span>
                                ${isApplied ? `<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold"><i class="fas fa-check-circle mr-1"></i>応募済み</span>` : ''}
                                ${isDismissed ? `<span class="bg-gray-200 text-gray-600 px-2 py-1 rounded text-xs font-bold"><i class="fas fa-eye-slash mr-1"></i>見送り</span>` : ''}
                            </div>
                            ` : ''}
                            ${!isAdminOrCoach && isApplied ? `
                            <div class="flex items-center gap-2 mb-3">
                                <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold"><i class="fas fa-check-circle mr-1"></i>応募済み</span>
                            </div>
                            ` : ''}

                            <h3 class="text-xl font-bold text-gray-900 mb-1 group-hover:text-indigo-600 transition leading-tight">${rec.jobs.title}</h3>
                            <p class="text-gray-600 font-medium mb-3">${rec.jobs.company}</p>
                            
                            <!-- 求人概要（抜粋） -->
                            <p class="text-sm text-gray-500 mb-4 line-clamp-2">
                                ${rec.jobs.description || '詳細情報は求人詳細をご覧ください。'}
                            </p>

                            <!-- AI分析結果 (スキルマッチ & 社風) -->
                            ${(() => {
                        const text = rec.match_reason || rec.reason || '';
                        let skillReason = text;
                        let cultureRank = '', cultureReason = '';

                        const skillMatch = text.match(/マッチ度評価[\s\S]*?理由[:：]([\s\S]*?)(?=総合評価|社風|$)/);
                        if (skillMatch) skillReason = skillMatch[1].trim();

                        const cultureMatch = text.match(/社風・カルチャーのフィット度評価[\s\S]*?評価[:：]\s*([A-E\-])[\s\S]*?理由[:：]([\s\S]*)/);
                        if (cultureMatch) {
                            cultureRank = cultureMatch[1].trim();
                            cultureReason = cultureMatch[2].trim();
                        }

                        const getRankLabelColor = (r) => {
                            if (['A', 'B'].includes(r)) return 'bg-sky-100 text-sky-800 border-sky-200';
                            if (r === 'C') return 'bg-gray-100 text-gray-800 border-gray-200';
                            if (['D', 'E'].includes(r)) return 'bg-orange-100 text-orange-800 border-orange-200';
                            return 'bg-gray-100 text-gray-600 border-gray-200';
                        };

                        return `
                                <div class="bg-blue-50 border border-blue-100 rounded-md p-3 mb-2">
                                    <div class="flex items-start">
                                        <div class="w-1 self-stretch bg-blue-600 rounded-full mr-3 mt-1 mb-1"></div>
                                        <div>
                                            <h4 class="text-blue-700 font-bold text-sm mb-1">スキルマッチ</h4>
                                            <p class="text-sm text-gray-800 leading-relaxed">${skillReason}</p>
                                        </div>
                                    </div>
                                </div>
                                ${cultureRank && cultureRank !== '-' ? `
                                <div class="mt-2 flex items-start text-sm">
                                    <span class="flex-shrink-0 inline-block px-2 py-0.5 border text-xs font-bold rounded mr-2 ${getRankLabelColor(cultureRank)}">
                                        社風: ${cultureRank}
                                    </span>
                                    <p class="text-gray-600 text-xs leading-relaxed self-center">
                                        ${cultureReason}
                                    </p>
                                </div>
                                ` : ''}
                                `;
                    })()}
                            
                            <!-- 操作ボタンエリア -->
                            <div class="mt-4 flex gap-3">
                                ${!isApplied ? `
                                    <button onclick="event.stopPropagation(); applyForJob('${rec.job_id}', '${rec.user_id}')" 
                                        class="text-sm bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-700 transition">
                                        ${isAdminOrCoach ? '代理応募' : '応募する'}
                                    </button>
                                    ${rec.score >= 50 && !isDismissed ? `
                                    <button onclick="event.stopPropagation(); window.dismissRecommendation('${rec.job_id}')" 
                                        class="text-sm bg-white text-gray-600 border border-gray-300 px-3 py-2 rounded hover:bg-gray-50 transition">
                                        見送る
                                    </button>
                                    ` : ''}
                                ` : ''}
                                ${isAdminOrCoach ? `
                                <button onclick="event.stopPropagation(); window.editRecommendationReason('${rec.id}')" 
                                    class="text-xs text-gray-500 hover:text-indigo-600 underline ml-auto self-center">
                                    <i class="fas fa-edit"></i> 理由編集
                                </button>
                                ` : ''}
                            </div>
                        </div>

                        <!-- サイドパネル (右側: 年収・リンク・AIスコア) -->
                        <div class="w-full md:w-48 flex flex-col items-end gap-6 border-l border-gray-100 pl-6 md:pt-2">
                            
                            <!-- 企業名 & 年収 -->
                            <div class="text-right">
                                <p class="text-sm font-bold text-gray-800 mb-1">${rec.jobs.company}</p>
                                <p class="text-lg font-bold text-orange-500">
                                    ${rec.jobs.salary_min ? `${Math.floor(rec.jobs.salary_min / 10000)}万円` : ''} 
                                    ${rec.jobs.salary_max ? `~ ${Math.floor(rec.jobs.salary_max / 10000)}万円` : ''}
                                </p>
                            </div>

                            <!-- リンク (縦書き風レイアウト) -->
                            ${rec.jobs.url ? `
                            <a href="${rec.jobs.url}" target="_blank" onclick="event.stopPropagation();" 
                               class="writing-vertical-rl text-indigo-600 hover:text-indigo-800 text-sm font-medium tracking-widest border-r-2 border-indigo-100 pr-2 h-24 flex items-center justify-center hover:border-indigo-300 transition">
                               リンクを開く <i class="fas fa-external-link-alt mb-2 transform rotate-90"></i>
                            </a>
                            ` : ''}

                            <!-- AIスコア -->
                            <div class="text-center mt-auto">
                                <i class="fas fa-robot text-3xl text-indigo-500 mb-1"></i>
                                <div class="text-lg font-bold text-indigo-900 leading-tight">AI</div>
                                <div class="text-xl font-bold text-indigo-900 leading-none">(${rec.score}点)</div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                `;
            }).join('') + '</div>';

            container.html(html);

            // ページネーションUIを追加
            renderRecommendationPagination();

            // Select2を初期化
            if (isAdminOrCoach) {
                $('#rec-user-filter').select2({
                    placeholder: "求職者を選択",
                    allowClear: true,
                    language: "ja",
                    width: '100%'
                });
            }
        }

        // 推薦一覧ページネーションUIのレンダリング
        function renderRecommendationPagination() {
            const container = $('#recommendation-pagination-container');
            if (!container.length) {
                // ページネーションコンテナが存在しない場合は作成
                $('#recommendations-container').after('<div id="recommendation-pagination-container" class="mt-6"></div>');
            }

            if (totalRecommendationPages <= 1) {
                $('#recommendation-pagination-container').html('');
                return;
            }

            const maxButtons = 5;
            let startPage = Math.max(1, currentRecommendationPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalRecommendationPages, startPage + maxButtons - 1);

            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            let html = '<div class="flex justify-center items-center gap-2">';

            // 前へボタン
            if (currentRecommendationPage > 1) {
                html += `<button onclick="goToRecommendationPage(${currentRecommendationPage - 1})" 
                    class="px-4 py-2 border rounded-lg hover:bg-gray-50 transition">
                    <i class="fas fa-chevron-left"></i> 前へ
                </button>`;
            }

            // ページ番号ボタン
            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === currentRecommendationPage;
                html += `<button onclick="goToRecommendationPage(${i})" 
                    class="px-4 py-2 border rounded-lg transition ${isActive ? 'bg-indigo-600 text-white' : 'hover:bg-gray-50'}">
                    ${i}
                </button>`;
            }

            // 次へボタン
            if (currentRecommendationPage < totalRecommendationPages) {
                html += `<button onclick="goToRecommendationPage(${currentRecommendationPage + 1})" 
                    class="px-4 py-2 border rounded-lg hover:bg-gray-50 transition">
                    次へ <i class="fas fa-chevron-right"></i>
                </button>`;
            }

            html += '</div>';
            html += `<div class="text-center mt-2 text-sm text-gray-600">
                ページ ${currentRecommendationPage} / ${totalRecommendationPages}
            </div>`;

            $('#recommendation-pagination-container').html(html);
        }

        // 推薦一覧のページ移動
        window.goToRecommendationPage = function (page) {
            currentRecommendationPage = page;
            renderRecommendations();
        }


        // 選択した求人のAI再判定
        window.reRunSelectedRecommendations = async function () {
            const checkboxes = $('.rec-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('再判定する求人を選択してください');
                return;
            }

            if (!confirm(`${checkboxes.length}件の求人についてAIマッチングを再実行しますか？\n（現在の判定結果は上書きされます）`)) {
                return;
            }

            showLoading();
            try {
                // ユーザーごとにグループ化
                const userJobMap = {}; // { userId: [{jobId, recId}...] }

                checkboxes.each(function () {
                    const userId = $(this).data('user-id');
                    const jobId = $(this).data('job-id');
                    const recId = $(this).val();
                    if (!userId || !jobId) return; // ガード
                    if (!userJobMap[userId]) userJobMap[userId] = [];
                    userJobMap[userId].push({ jobId, recId });
                });

                let totalSuccess = 0;
                let totalErrors = 0;

                // ユーザーごとに処理
                for (const userId of Object.keys(userJobMap)) {
                    const items = userJobMap[userId];
                    const jobIds = items.map(i => i.jobId);
                    // Always fetch fresh & complete data from DB to ensure AI has full context
                    // allCandidatesList only provides basic info (id, name)
                    const { data: dbUser } = await supabase.from('users')
                        .select('*, candidate_profiles(*)')
                        .eq('id', userId)
                        .single();

                    let userDataForAI = null;

                    if (dbUser) {
                        const profile = Array.isArray(dbUser.candidate_profiles) ? dbUser.candidate_profiles[0] : dbUser.candidate_profiles;
                        userDataForAI = { ...dbUser, ...profile, id: userId };
                        console.log('Fetched full user data for Re-Analysis:', userDataForAI.name);
                    } else {
                        // Fallback logic
                        const user = allCandidatesList.find(u => u.id === userId);
                        if (user) {
                            const profile = Array.isArray(user.candidate_profiles) ? user.candidate_profiles[0] : user.candidate_profiles;
                            userDataForAI = { ...user, ...profile, id: userId };
                        } else {
                            const sampleRec = allRecommendations.find(r => r.user_id === userId);
                            if (sampleRec && sampleRec.users) {
                                userDataForAI = { ...sampleRec.users, id: userId };
                            }
                        }
                    }

                    if (!userDataForAI) {
                        console.error('User data missing for AI reruun');
                        totalErrors += jobIds.length;
                        continue;
                    }

                    // 求人情報の取得 (allRecommendationsから探す)
                    // rec.jobs が必要
                    const jobs = jobIds.map(jobId => {
                        const rec = allRecommendations.find(r => r.job_id === jobId && r.user_id === userId);
                        return rec ? rec.jobs : null;
                    }).filter(j => j);

                    if (jobs.length === 0) continue;

                    console.log(`Re-analyzing for user ${userDataForAI.name || userId}: `, jobs.length, 'jobs');

                    const { data: results, error } = await supabase.functions.invoke('ai-matching', {
                        body: {
                            user: userDataForAI,
                            jobs: jobs
                        }
                    });

                    if (error) throw error;

                    // 結果の保存
                    const upsertData = results.map(res => {
                        // 型変換の不一致を防ぐため == を使用
                        const original = items.find(i => i.jobId == res.job_id);
                        return {
                            id: original ? original.recId : undefined,
                            organization_id: userDataForAI.organization_id || currentUser.organization_id, // フォールバックを追加
                            user_id: userId,
                            job_id: res.job_id,
                            score: res.match_score,
                            reason: res.recommendation_reason || res.reason,
                            details: res.details
                        };
                    });

                    const { error: upsertError } = await supabase
                        .from('recommendations')
                        .upsert(upsertData);

                    if (upsertError) {
                        console.error('Upsert error:', upsertError);
                        totalErrors += jobIds.length;
                    } else {
                        totalSuccess += jobIds.length;
                    }
                }

                alert(`再判定が完了しました。\n成功: ${totalSuccess} 件\n失敗: ${totalErrors} 件`);

                // データ再読み込み
                if (typeof loadRecommendations === 'function') {
                    loadRecommendations();
                }

            } catch (error) {
                console.error('Re-run error:', error);
                alert('再判定中にエラーが発生しました: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // おすすめ理由の編集
        window.editRecommendationReason = function (recId) {
            console.log('Edit Recommendation Reason requested for ID:', recId);

            const rec = allRecommendations.find(r => r.id === recId) ||
                (typeof allRecommendationsCache !== 'undefined' ? allRecommendationsCache.find(r => r.id === recId) : null);

            if (!rec) {
                console.error('Data not found for ID:', recId);
                alert('データの取得に失敗しました。再読み込みしてください。');
                return;
            }

            const currentReason = rec.reason || rec.match_reason || '';

            // 既存のモーダルがあれば削除
            $('#dynamic-edit-rec-modal').remove();

            // モーダルHTMLを定義
            const modalHtml = `
            <div id="dynamic-edit-rec-modal"
                class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4" 
                style="z-index: 9999999 !important; position: fixed !important; top:0; left:0; width:100%; height:100%;">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden transform transition-all" onclick="event.stopPropagation()">
                    <div class="bg-indigo-600 px-6 py-4 flex justify-between items-center text-white">
                        <h3 class="text-lg font-bold flex items-center gap-2 m-0">
                            <i class="fas fa-edit"></i> おすすめ理由の編集
                        </h3>
                        <button onclick="$('#dynamic-edit-rec-modal').remove()" class="text-white hover:text-indigo-200 transition-colors text-2xl border-none bg-transparent cursor-pointer">&times;</button>
                    </div>

                    <div class="p-6">
                        <input type="hidden" id="edit-rec-reason-id" value="${recId}">
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">おすすめ理由の入力</label>
                            <textarea id="edit-rec-reason-text" rows="10" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-800 leading-relaxed transition-all"
                                placeholder="${rec.score >= 50 ? 'おすすめの理由を詳しく入力してください...' : '不一致の理由を具体的に入力してください...'}">${currentReason}</textarea>
                            <p class="mt-2 text-xs text-gray-500">※保存されると求職者画面にも即時反映されます。</p>
                        </div>

                        <div class="flex justify-end gap-3 mt-8">
                            <button onclick="$('#dynamic-edit-rec-modal').remove()" 
                                class="px-6 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium transition-colors cursor-pointer bg-white">キャンセル</button>
                            <button onclick="saveRecommendationReason()" 
                                class="px-8 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold shadow-md transition-all cursor-pointer border-none">変更を保存する</button>
                        </div>
                    </div>
                </div>
            </div>`;

            $('body').append(modalHtml);
            console.log('Dynamic modal created and added to body. Displaying now.');
        }

        window.closeEditRecReasonModal = function () {
            $('#dynamic-edit-rec-modal').remove();
            // 念のため旧IDの方も消す
            $('#edit-recommendation-reason-modal').addClass('hidden').attr('style', 'display: none !important;');
        }

        window.saveRecommendationReason = async function () {
            const recId = $('#edit-rec-reason-id').val();
            const newReason = $('#edit-rec-reason-text').val();

            showLoading();
            try {
                const user = window.currentUser;

                const { error } = await supabase
                    .from('recommendations')
                    .update({
                        reason: newReason,
                        recommended_by: user.id
                    })
                    .eq('id', recId);

                if (error) throw error;

                alert('おすすめ理由を更新しました');

                // キャッシュを更新
                const rec = allRecommendations.find(r => r.id === recId) ||
                    (typeof allRecommendationsCache !== 'undefined' ? allRecommendationsCache.find(r => r.id === recId) : null);
                if (rec) {
                    rec.reason = newReason;
                    rec.recommended_by = user.id;
                }

                closeEditRecReasonModal();
                // 再描画
                renderRecommendations();
            } catch (error) {
                console.error('Update reason error:', error);
                alert('更新に失敗しました: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // 推薦結果のフィルタリング
        window.filterRecommendations = function (userId) {
            currentSelectedUserId = userId;
            currentRecommendationPage = 1; // ページ番号をリセット
            // 再レンダリングをトリガーして、フィルタリングロジックを適用
            renderRecommendations(allRecommendations, isAdminOrCoachView, allCandidatesList, appliedJobIdsCache);
        }

        window.generateAIRecommendations = async function () {
            if (!confirm('AI分析を開始しますか？（これには数秒かかる場合があります）')) return

            showLoading()
            try {
                // 1. 求人データを取得
                const { data: jobs } = await supabase
                    .from('jobs')
                    .select('*')
                    .eq('organization_id', currentUser.organization_id)
                    .eq('status', 'active')

                if (!jobs || jobs.length === 0) throw new Error('分析対象の求人がありません')

                // 2. ユーザープロフィール（DBから取得）
                const userProfile = `
                希望職種: ${currentUser.desired_job_type || '未設定'}
                希望勤務勤務地: ${currentUser.desired_location || '未設定'}
                スキル: ${currentUser.skills || '未設定'}
                職歴・自己PR: ${currentUser.work_history || '未設定'}
                `

                // 3. Edge Function 呼び出し
                // サーバーサイドでGemini APIを実行し、APIキーを隠蔽します
                const { data: recommendations, error: functionError } = await supabase.functions.invoke('score-ai-recommendations', {
                    body: {
                        userProfile,
                        jobs: jobs.map(j => ({ id: j.id, title: j.title, description: j.description }))
                    }
                })

                if (functionError) {
                    throw functionError
                }

                if (!recommendations || recommendations.length === 0) {
                    throw new Error('AIからの応答がありませんでした（候補なし）')
                }

                // 4. データベースに保存（upsert方式：既存は更新、新規は追加）
                for (const rec of recommendations) {
                    // 既存のレコードを確認
                    const { data: existing } = await supabase
                        .from('recommendations')
                        .select('id')
                        .eq('user_id', currentUser.id)
                        .eq('job_id', rec.job_id)
                        .maybeSingle();

                    if (existing) {
                        // 既存レコードを更新
                        await supabase
                            .from('recommendations')
                            .update({
                                score: rec.score,
                                reason: rec.reason,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', existing.id);
                    } else {
                        // 新規レコードを挿入
                        await supabase.from('recommendations').insert({
                            organization_id: currentUser.organization_id,
                            user_id: currentUser.id,
                            job_id: rec.job_id,
                            score: rec.score,
                            reason: rec.reason
                        });
                    }
                }

                alert('AI分析が完了しました！')
                loadRecommendations()
                loadDashboard()

            } catch (error) {
                console.error('AI generation error:', error)
                alert('AI分析に失敗しました: ' + error.message)
            } finally {
                hideLoading()
            }
        }

        // ========================
        // 推薦メッセージ・テンプレート関連
        // ========================
        let currentTemplates = [];

        window.openRecommendationMessageModal = async function () {
            const checkboxes = $('.rec-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('メッセージに含める求人を選択してください');
                return;
            }

            const targetUserIds = [...new Set(checkboxes.map((_, el) => $(el).data('user-id')).get())];
            if (targetUserIds.length > 1) {
                alert('異なる求職者の求人が混在しています。メッセージ作成は1人の求職者ごとに行ってください。');
                return;
            }

            const targetUserId = targetUserIds[0];
            const targetUser = allCandidatesList.find(u => u.id === targetUserId);

            // モーダルを表示
            $('#recommendation-message-modal').removeClass('hidden');

            // テンプレートをロード
            await loadEmailTemplates();

            // メッセージ生成
            generateRecommendationMessage();
        };

        window.closeRecommendationMessageModal = function () {
            $('#recommendation-message-modal').addClass('hidden');
        };

        window.loadEmailTemplates = async function () {
            try {
                const { data, error } = await supabase
                    .from('email_templates')
                    .select('*')
                    .eq('organization_id', currentUser.organization_id)
                    .order('is_default', { ascending: false })
                    .order('name');

                if (error) throw error;
                currentTemplates = data || [];

                // 推薦モーダル内のテンプレート選択プルダウン
                const select = $('#message-template-select');
                if (select.length) {
                    select.empty();
                    currentTemplates.forEach(t => {
                        select.append(`<option value="${t.id}" ${t.is_default ? 'selected' : ''}>${t.name}</option>`);
                    });
                }

                // 管理画面のリスト表示
                renderEmailTemplatesList();
            } catch (error) {
                console.error('Failed to load email templates:', error);
            }
        };

        window.applyMessageTemplate = function (templateId) {
            generateRecommendationMessage();
        };

        window.generateRecommendationMessage = function () {
            const checkboxes = $('.rec-checkbox:checked');
            const templateId = $('#message-template-select').val();
            const template = currentTemplates.find(t => t.id === templateId);

            if (!template) {
                $('#recommendation-message-body').val('テンプレートを選択してください');
                return;
            }

            const targetUserId = checkboxes.first().data('user-id');
            const targetUser = allCandidatesList.find(u => u.id === targetUserId);

            // 選択された求人推薦データを取得
            const selectedRecIds = checkboxes.map((_, el) => $(el).val()).get();
            const selectedRecs = allRecommendations.filter(r => selectedRecIds.includes(r.id));

            // 変数の組み立て
            let jobDetailsText = '';
            let jobListText = '';
            let reasonsText = '';

            selectedRecs.forEach((rec, idx) => {
                const job = rec.jobs;
                const driveUrl = job.url || 'URLなし';

                // AI出力テキストの取得とクリーニング
                let fullText = rec.details || rec.reason || rec.recommendation_reason || rec.match_reason || '';

                // ツールログの除去（念のためフロントエンドでも実施）
                const headerIndex = fullText.indexOf('マッチ度評価');
                if (headerIndex !== -1) fullText = fullText.substring(headerIndex);
                fullText = fullText.replace(/tool_code[\s\S]*?print\(.*?\)/g, '')
                    .replace(/thought\n[\s\S]*?(?=\n\n|\Z)/g, '')
                    .replace(/^```[\s\S]*?```/gm, '')
                    .trim();

                // 各要素の抽出
                let matchReason = '';
                let cultureGrade = '-';
                let cultureReason = '';

                // マッチ度区画の抽出
                const matchSectionMatch = fullText.match(/マッチ度評価([\s\S]*?)(?:社風・カルチャー|$)/);
                if (matchSectionMatch) {
                    const m = matchSectionMatch[1].match(/理由[:：]\s*([^\n]+)/);
                    if (m) matchReason = m[1].trim();
                } else {
                    // 区画が見つからない場合、最初の「理由:」を採用
                    const m = fullText.match(/理由[:：]\s*([^\n]+)/);
                    if (m) matchReason = m[1].trim();
                }

                // フォールバック: 全く抽出できなければ全文を使用（ただし短めにする）
                if (!matchReason && fullText) {
                    matchReason = fullText.length > 100 ? fullText.substring(0, 100) + '...' : fullText;
                }

                // 社風区画の抽出
                const cultureSectionMatch = fullText.match(/社風・カルチャーのフィット度評価([\s\S]*)/);
                if (cultureSectionMatch) {
                    const section = cultureSectionMatch[1];
                    const gm = section.match(/評価[:：]\s*([A-E\-])/);
                    if (gm) cultureGrade = gm[1];
                    const rm = section.match(/理由[:：]\s*([^\n]+)/);
                    if (rm) cultureReason = rm[1].trim();
                }

                // 1. jobDetails (理想フォーマット)
                jobDetailsText += `求人${idx + 1}\n`;
                jobDetailsText += `企業名： ${job.company}\n`;
                jobDetailsText += `求人名： ${job.title}\n`;
                jobDetailsText += `マッチ度： ${rec.score}点 (${matchReason})\n`;
                jobDetailsText += `社風マッチ： ${cultureGrade} (${cultureReason})\n`;
                jobDetailsText += `求人ID： ${driveUrl}\n\n`;

                // 2. jobList (理由なし)
                jobListText += `【案件 ${idx + 1}】 ${job.company} / ${job.title}\n`;
                jobListText += `詳細URL: ${driveUrl}\n\n`;

                // 3. recommendationReason (理由のみリスト - マッチ度理由を使用)
                if (matchReason) {
                    if (selectedRecs.length > 1) {
                        reasonsText += `■ ${job.company} (${job.title})\n${matchReason}\n\n`;
                    } else {
                        reasonsText = matchReason;
                    }
                }
            });

            // 変数置換
            const rawUserName = targetUser ? targetUser.name || '求職者' : '求職者';
            const cleanUserName = rawUserName.replace(/様$/, '');

            const body = template.body_template
                .replace(/{{userName}}/g, cleanUserName)
                .replace(/{{agentName}}/g, currentUser.name || '')
                .replace(/{{jobDetails}}/g, jobDetailsText.trim())
                .replace(/{{jobList}}/g, jobListText.trim())
                .replace(/{{jobDetailsCount}}/g, selectedRecs.length)
                .replace(/{{recommendationReason}}/g, reasonsText.trim());

            $('#recommendation-message-body').val(body);
        };

        window.copyRecommendationMessage = function () {
            const body = $('#recommendation-message-body').val();
            if (!body) return;
            navigator.clipboard.writeText(body).then(() => {
                alert('メッセージをクリップボードにコピーしました');
            });
        };

        window.sendRecommendationEmail = async function () {
            const checkboxes = $('.rec-checkbox:checked');
            const targetUserId = checkboxes.first().data('user-id');
            const body = $('#recommendation-message-body').val();
            const templateId = $('#message-template-select').val();
            const template = currentTemplates.find(t => t.id === templateId);

            if (!body) {
                alert('メッセージ内容が空です');
                return;
            }

            // 求職者情報を取得
            const { data: user, error } = await supabase
                .from('users')
                .select('name, email')
                .eq('id', targetUserId)
                .single();

            if (error || !user || !user.email) {
                alert('候補者のメールアドレスを確認できません。');
                return;
            }

            if (!confirm(`${user.name} さん（${user.email}）にこのメッセージをメールで送信しますか？`)) {
                return;
            }

            $('#send-recommendation-email-btn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>送信中...');

            try {
                // sendEmail(type, to, data)
                const success = await sendEmail('recommendation', user.email, {
                    userName: user.name,
                    subject: template.subject || '【求人のご紹介】',
                    body: body,
                    scoutUrl: `${window.location.origin}/#recommendations`
                });

                if (success) {
                    alert('メールを送信しました。');
                    closeRecommendationMessageModal();
                } else {
                    alert('メールの送信に失敗しました。');
                }
            } catch (error) {
                console.error('Email send error:', error);
                alert('送信中にエラーが発生しました');
            } finally {
                $('#send-recommendation-email-btn').prop('disabled', false).html('<i class="fas fa-paper-plane mr-2"></i>候補者へメール送信');
            }
        };

        // テンプレートリスト表示（管理画面用）
        window.renderEmailTemplatesList = function () {
            const container = $('#email-templates-list');
            if (!container.length) return;
            container.empty();

            if (currentTemplates.length === 0) {
                container.html('<div class="col-span-full py-12 text-center text-gray-500 bg-gray-50 border-2 border-dashed rounded-xl">テンプレートが登録されていません</div>');
                return;
            }

            currentTemplates.forEach(t => {
                const card = `
                    <div class="bg-white border ${t.is_default ? 'border-indigo-600 ring-1 ring-indigo-600' : 'border-gray-200'} p-5 rounded-xl shadow-sm hover:shadow-md transition group">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-bold text-gray-900">${t.name}</h4>
                                ${t.is_default ? '<span class="inline-block mt-1 text-[10px] bg-indigo-100 text-indigo-700 font-bold px-2 py-0.5 rounded uppercase">デフォルト</span>' : ''}
                            </div>
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition">
                                <button onclick="editEmailTemplate('${t.id}')" class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition" title="編集">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteEmailTemplate('${t.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="削除">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 line-clamp-3 mb-4 leading-relaxed">${t.body_template.substring(0, 100)}...</p>
                        <div class="text-[10px] text-gray-400 border-t pt-3">
                            <i class="far fa-clock mr-1"></i>最終更新: ${new Date(t.updated_at).toLocaleDateString()}
                        </div>
                    </div>
                `;
                container.append(card);
            });
        };

        window.openEmailTemplateModal = function (template = null) {
            $('#email-template-modal').removeClass('hidden');
            if (template) {
                $('#template-modal-title').text('テンプレートを編集');
                $('#template-id').val(template.id);
                $('#template-name').val(template.name);
                $('#template-subject').val(template.subject);
                $('#template-body').val(template.body_template);
                $('#template-is-default').prop('checked', template.is_default);
            } else {
                $('#template-modal-title').text('新規テンプレート作成');
                $('#template-id').val('');
                $('#template-name').val('');
                $('#template-subject').val('');
                $('#template-body').val('');
                $('#template-is-default').prop('checked', currentTemplates.length === 0);
            }
        };

        window.closeEmailTemplateModal = function () {
            $('#email-template-modal').addClass('hidden');
        };

        window.editEmailTemplate = function (id) {
            const template = currentTemplates.find(t => t.id === id);
            if (template) openEmailTemplateModal(template);
        };

        window.saveEmailTemplate = async function () {
            const id = $('#template-id').val();
            const name = $('#template-name').val();
            const subject = $('#template-subject').val();
            const body = $('#template-body').val();
            const isDefault = $('#template-is-default').prop('checked');

            if (!name || !body) {
                alert('テンプレート名と本文を入力してください');
                return;
            }

            showLoading();
            try {
                // デフォルトの解除（その組織内で一つだけに制限）
                if (isDefault) {
                    await supabase
                        .from('email_templates')
                        .update({ is_default: false })
                        .eq('organization_id', currentUser.organization_id);
                }

                const data = {
                    organization_id: currentUser.organization_id,
                    name: name,
                    subject: subject,
                    body_template: body,
                    is_default: isDefault,
                    updated_at: new Date().toISOString()
                };

                let error;
                if (id) {
                    const { error: err } = await supabase.from('email_templates').update(data).eq('id', id);
                    error = err;
                } else {
                    const { error: err } = await supabase.from('email_templates').insert(data);
                    error = err;
                }

                if (error) throw error;

                alert('保存しました');
                closeEmailTemplateModal();
                loadEmailTemplates();
            } catch (error) {
                console.error('Error saving template:', error);
                alert('保存に失敗しました');
            } finally {
                hideLoading();
            }
        };

        window.deleteEmailTemplate = async function (id) {
            if (!confirm('このテンプレートを削除してもよろしいですか？')) return;

            showLoading();
            try {
                const { error } = await supabase.from('email_templates').delete().eq('id', id);
                if (error) throw error;
                loadEmailTemplates();
            } catch (error) {
                console.error('Error deleting template:', error);
                alert('削除に失敗しました');
            } finally {
                hideLoading();
            }
        };

        // ========================
        // Profile
        // ========================

        async function loadMasterDataForProfile(user) {
            try {
                // Select2の初期化はオプション追加後に行うため、ここでは削除
                /*
                $('.select2').select2({
                    language: "ja",
                    width: 'resolve'
                });
                */

                // 都道府県の設定
                const setPrefectureOptions = (selector) => {
                    const select = $(selector);
                    select.empty().append('<option value="">都道府県</option>');
                    prefectures.forEach(pref => {
                        select.append(`<option value="${pref}">${pref}</option>`);
                    });
                };
                setPrefectureOptions('#profile-prefecture');
                setPrefectureOptions('#reg-prefecture');
                setPrefectureOptions('#admin-user-prefecture');

                // マスタデータが未ロードの場合はロードする
                if (masterJobCategories.length === 0 || masterIndustries.length === 0) {
                    await initMasterDataDropdowns();
                }

                // 雇用形態を取得 (キャッシュまたはmaster_dataから)
                let validMasters;

                if (masterDataCache.isValid() && masterDataCache.employmentTypes) {
                    console.log('Using cached employment types');
                    validMasters = masterDataCache.employmentTypes;
                } else {
                    console.log('Fetching employment types from database');

                    const { data: masters, error } = await supabase
                        .from('master_data')
                        .select('type, label, value, organization_id, sort_order') // 必要なカラムのみ取得
                        .eq('type', 'employment_type')
                        .eq('is_active', true)
                        .order('sort_order')

                    if (error) throw error

                    // フィルタリング: 自社専用データを優先、なければグローバルデータを使用
                    // 1. まず自社専用のデータを取得
                    const orgSpecific = masters.filter(m => m.organization_id === currentUser.organization_id);

                    // 2. グローバルデータを取得
                    const globalData = masters.filter(m => m.organization_id === null);

                    // 3. 自社専用データで既に存在するlabelを記録 (valueではなくlabelで判定)
                    const orgSpecificLabels = new Set(orgSpecific.map(m => m.label));

                    // 4. グローバルデータから、自社専用データと重複しないものだけを取得
                    const nonDuplicateGlobal = globalData.filter(m => !orgSpecificLabels.has(m.label));

                    // 5. 自社専用データとグローバルデータを結合
                    validMasters = [...orgSpecific, ...nonDuplicateGlobal];

                    // キャッシュを更新
                    masterDataCache.employmentTypes = validMasters;
                    if (!masterDataCache.lastUpdated) {
                        masterDataCache.lastUpdated = Date.now();
                    }
                }

                console.log('Employment types after filtering:', validMasters.map(m => `${m.label} (org: ${m.organization_id ? 'custom' : 'global'}, value: ${m.value})`));

                // 雇用形態のプルダウン生成
                const empTargets = ['#profile-employment-type', '#reg-employment-type', '#admin-user-employment-type'];
                empTargets.forEach(s => {
                    const select = $(s);

                    // Select2が既に初期化されている場合は破棄
                    if (select.hasClass("select2-hidden-accessible")) {
                        select.select2('destroy');
                    }

                    // オプションをクリアして再生成
                    select.empty();
                    validMasters.forEach(m => {
                        select.append(`<option value="${m.value}">${m.label}</option>`);
                    });
                });

                // 職種カテゴリのプルダウン生成 (共通マスタ使用)
                const jobTargets = ['#profile-job-type', '#reg-job-type', '#admin-user-job-type'];
                jobTargets.forEach(s => {
                    const select = $(s);

                    // Select2が既に初期化されている場合は破棄
                    if (select.hasClass("select2-hidden-accessible")) {
                        select.select2('destroy');
                    }

                    select.empty();
                    masterJobCategories.forEach(c => {
                        select.append(`<option value="${c}">${c}</option>`);
                    });
                });

                // 業界カテゴリのプルダウン生成 (共通マスタ使用)
                const indTargets = ['#profile-industry', '#reg-industry', '#admin-user-industry'];
                indTargets.forEach(s => {
                    const select = $(s);

                    // Select2が既に初期化されている場合は破棄
                    if (select.hasClass("select2-hidden-accessible")) {
                        select.select2('destroy');
                    }

                    select.empty();
                    masterIndustries.forEach(i => {
                        select.append(`<option value="${i}">${i}</option>`);
                    });
                });

                // Select2の初期化（オプション設定後に実行）
                // 既存のSelect2インスタンスを破棄（select要素のみ対象）
                $('select.select2').each(function () {
                    if ($(this).hasClass("select2-hidden-accessible")) {
                        try {
                            $(this).select2('destroy');
                        } catch (e) {
                            console.warn('Failed to destroy Select2:', e);
                        }
                    }
                });

                // 管理者用フォームのSelect2は特別な設定が必要
                $('#admin-user-job-type, #admin-user-industry, #admin-user-employment-type, #admin-user-prefecture').select2({
                    language: "ja",
                    width: '100%',
                    closeOnSelect: false,
                    allowClear: true,
                    placeholder: '選択してください'
                });

                // その他のSelect2は標準設定（select要素のみ）
                $('select.select2').not('#admin-user-job-type, #admin-user-industry, #admin-user-employment-type, #admin-user-prefecture').each(function () {
                    if (!$(this).hasClass("select2-hidden-accessible")) {
                        $(this).select2({
                            language: "ja",
                            width: 'resolve'
                        });
                    }
                });

                // ユーザーの選択値をセット (プロフィール編集時のみ)
                if (user) {
                    console.log('Before parse:', user.desired_location, typeof user.desired_location);

                    // 値を正規化（JSON文字列ならパースする）
                    user.desired_job_type = window.safeParseList(user.desired_job_type);
                    user.desired_industry = window.safeParseList(user.desired_industry);
                    user.desired_employment_type = window.safeParseList(user.desired_employment_type);
                    user.desired_location = window.safeParseList(user.desired_location);

                    console.log('After parse:', user.desired_location, Array.isArray(user.desired_location));

                    const setSelect2Val = (selectId, val) => {
                        if (!val) return;
                        if (Array.isArray(val)) {
                            $(selectId).val(val).trigger('change');
                        } else {
                            const v = val.toString().includes(',') ? val.split(',') : [val];
                            $(selectId).val(v).trigger('change');
                        }
                    };

                    // プロフィールフォーム
                    setSelect2Val('#profile-employment-type', user.desired_employment_type);
                    setSelect2Val('#profile-job-type', user.desired_job_type);
                    setSelect2Val('#profile-industry', user.desired_industry);

                    // 管理者用ユーザー編集フォーム
                    console.log('Setting admin user form values:', {
                        employment_type: user.desired_employment_type,
                        job_type: user.desired_job_type,
                        industry: user.desired_industry
                    });
                    setSelect2Val('#admin-user-employment-type', user.desired_employment_type);
                    setSelect2Val('#admin-user-job-type', user.desired_job_type);
                    setSelect2Val('#admin-user-industry', user.desired_industry);

                    // 値が正しくセットされたか確認
                    setTimeout(() => {
                        console.log('Verification - Values after setting:', {
                            employment_type: $('#admin-user-employment-type').val(),
                            job_type: $('#admin-user-job-type').val(),
                            industry: $('#admin-user-industry').val()
                        });
                    }, 50);

                    // 勤務地の分割セット
                    if (user.desired_location) {
                        let locations = Array.isArray(user.desired_location) ? user.desired_location : [user.desired_location];

                        // 要素内にスラッシュが含まれている場合は展開する (例: ["A/B"] -> ["A", "B"])
                        let flatLocations = [];
                        locations.forEach(loc => {
                            if (typeof loc === 'string') {
                                // 半角/全角スラッシュ、カンマ、読点、スペースで分割
                                const parts = loc.split(/[\/\uff0f,、\s]+/).map(s => s.trim()).filter(s => s);
                                if (parts.length > 0) {
                                    flatLocations.push(...parts);
                                } else {
                                    flatLocations.push(loc);
                                }
                            } else {
                                flatLocations.push(loc);
                            }
                        });
                        locations = flatLocations;
                        console.log('Flat locations:', locations);

                        const matchedPrefs = [];
                        const unmatched = [];

                        locations.forEach(loc => {
                            // "東京都" or "東京都xxx区" の場合、"東京都" を抽出してマッチさせる
                            let found = false;
                            for (const pref of prefectures) {
                                if (loc === pref || loc.startsWith(pref)) {
                                    if (!matchedPrefs.includes(pref)) {
                                        matchedPrefs.push(pref);
                                    }
                                    const rest = loc.substring(pref.length);
                                    if (rest) unmatched.push(rest);
                                    found = true;
                                    break;
                                }
                            }
                            if (!found) {
                                unmatched.push(loc);
                            }
                        });

                        console.log('Matched Prefs:', matchedPrefs);
                        console.log('Unmatched:', unmatched);

                        // プルダウンにセット（複数選択）
                        $('#profile-prefecture').val(matchedPrefs).trigger('change');
                        $('#admin-user-prefecture').val(matchedPrefs).trigger('change');

                        // 残りをテキストボックスにセット
                        console.log('Finalizing location sets...');
                        const restStr = unmatched.join(' / ');
                        $('#profile-city').val(restStr);
                        $('#admin-user-city').val(restStr);

                        // 性別と現住所のセット
                        $('#profile-gender').val(user.gender || '');
                        $('#admin-user-gender').val(user.gender || '');

                        // 都道府県プルダウンの初期化 (現住所用)
                        const prefSelects = $('#profile-current-location, #admin-user-current-location');
                        prefSelects.empty().append('<option value="">都道府県を選択</option>');
                        prefectures.forEach(p => {
                            prefSelects.append(`<option value="${p}">${p}</option>`);
                        });
                        $('#profile-current-location').val(user.current_location || '');
                        $('#admin-user-current-location').val(user.current_location || '');

                    }
                    console.log('loadMasterDataForProfile: Done');
                }

            } catch (error) {
                console.error('Load profile master error:', error);
                throw error;
            }
        }
        async function loadProfile() {
            if (!currentUser) return

            showLoading()
            try {
                // usersテーブルとcandidate_profilesを結合して取得
                const { data: userData, error } = await supabase
                    .from('users')
                    .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                    .eq('id', currentUser.id)
                    .single()

                if (error) throw error

                // フラット化（プロフィールが存在する場合）
                const profile = Array.isArray(userData.candidate_profiles) ? userData.candidate_profiles[0] : userData.candidate_profiles;
                const user = { ...userData, ...profile };
                user.id = userData.id;

                // Update local currentUser cache
                currentUser = user

                // マスタデータロード & 値セット
                await loadMasterDataForProfile(user);

                // Fill form
                $('#profile-name').val(user.name)
                $('#profile-furigana').val(user.furigana || '')
                $('#profile-email').val(user.email)
                $('#profile-phone').val(user.phone || '')
                $('#profile-birth-date').val(user.birth_date || '')
                $('#profile-age').val(user.age || '')

                // 職種、業界、雇用形態、勤務地は loadMasterDataForProfile でセット済み

                $('#profile-salary').val(user.desired_salary ? Math.floor(user.desired_salary / 10000) : '')
                $('#profile-freewords').val(user.desired_freewords || '')
                $('#profile-job-experience-ok').prop('checked', user.desired_job_experience_ok)
                $('#profile-industry-experience-ok').prop('checked', user.desired_industry_experience_ok)

                $('#profile-skills').val(user.skills || '')
                $('#profile-history').val(user.work_history || '')
                $('#profile-work-history-detail').val(user.work_history_detail || '')
                $('#profile-history-info').val(user.history_info || '')

                $('#profile-current-salary').val(user.current_salary ? user.current_salary / 10000 : '')
                $('#profile-academic').val(user.education || user.academic_background || '')
                $('#profile-languages').val(user.languages || '')
                $('#profile-certifications').val(user.certifications || '')
                $('#profile-start-date').val(user.available_start_date || '')

                // 詳細職歴
                $('#profile-work-history-list').empty();
                if (user.work_history_structured && Array.isArray(user.work_history_structured)) {
                    user.work_history_structured.forEach(item => addWorkHistoryItemToContainer('#profile-work-history-list', item));
                }
                updateJobChangeCountInContainer('#profile-work-history-list', '#profile-job-change-count');

                // 社内用情報のセット & 表示制御
                $('#profile-drive-url').val(user.drive_folder_url || '')
                $('#profile-notebooklm-url').val(user.notebooklm_url || '')
                $('#profile-line-url').val(user.line_url || '')
                $('#profile-resume-detail').val(user.resume || '')
                $('#profile-notes').val(user.notes || '')

                if (['admin', 'org_admin', 'super_admin', 'coach', 'ca', 'ra'].includes(currentUser.role)) {
                    $('#internal-profile-info').removeClass('hidden')
                } else {
                    $('#internal-profile-info').addClass('hidden')
                }

            } catch (error) {
                console.error('Load profile error:', error)
                alert('プロフィールの読み込みに失敗しました')
            } finally {
                hideLoading()
            }
        }

        $('#profile-form').on('submit', async function (e) {
            e.preventDefault()
            showLoading()

            const salaryNum = $('#profile-salary').val() ? parseInt($('#profile-salary').val()) * 10000 : null;

            // usersテーブル更新用
            const userUpdates = {
                email: $('#profile-email').val().trim(),
                furigana: $('#profile-furigana').val().trim(),
                updated_at: new Date().toISOString()
            }

            // candidate_profilesテーブル更新用
            const profileUpdates = {
                desired_job_type: $('#profile-job-type').val() ? $('#profile-job-type').val().join(',') : null,
                desired_industry: $('#profile-industry').val() ? $('#profile-industry').val().join(',') : null,
                desired_location: (() => {
                    const prefs = $('#profile-prefecture').val();
                    const city = $('#profile-city').val() || '';
                    if (Array.isArray(prefs) && prefs.length > 0) {
                        let loc = prefs.join(',');
                        if (city) {
                            if (prefs.length > 1) {
                                loc += ' ' + city;
                            } else {
                                loc = prefs[0] + city;
                            }
                        }
                        return loc;
                    } else if (prefs) {
                        return prefs + city;
                    }
                    return city || null;
                })(),
                desired_employment_type: $('#profile-employment-type').val() ? $('#profile-employment-type').val().join(',') : null,
                desired_salary: salaryNum,
                desired_freewords: $('#profile-freewords').val().trim(),
                desired_job_experience_ok: $('#profile-job-experience-ok').is(':checked'),
                desired_industry_experience_ok: $('#profile-industry-experience-ok').is(':checked'),
                skills: $('#profile-skills').val().trim(),
                work_history: $('#profile-history').val().trim(),
                work_history_detail: $('#profile-work-history-detail').val().trim(),
                history_info: $('#profile-history-info').val().trim(),
                current_salary: $('#profile-current-salary').val() ? parseInt($('#profile-current-salary').val()) * 10000 : null,
                education: $('#profile-academic').val().trim(),
                languages: $('#profile-languages').val().trim(),
                certifications: $('#profile-certifications').val().trim(),
                available_start_date: $('#profile-start-date').val() || null,
                birth_date: $('#profile-birth-date').val() || null,
                age: $('#profile-age').val() ? parseInt($('#profile-age').val()) : null,
                gender: $('#profile-gender').val() || null,
                current_location: $('#profile-current-location').val() || null,
                phone: $('#profile-phone').val().trim() || null,

                // 詳細職歴の取得
                work_history_structured: (() => {
                    const list = [];
                    $('#profile-work-history-list .work-history-item').each(function () {
                        list.push({
                            company_name: $(this).find('.wh-company').val(),
                            period: $(this).find('.wh-period').val(),
                            role: $(this).find('.wh-role').val(),
                            description: $(this).find('.wh-description').val()
                        });
                    });
                    return list;
                })(),
                job_change_count: $('#profile-work-history-list .work-history-item').length,

                updated_at: new Date().toISOString()
            }

            // 社内用情報の追加 (権限がある場合のみ、且つusers/profilesに分散して保存)
            if (['admin', 'org_admin', 'super_admin', 'coach', 'ca', 'ra'].includes(currentUser.role)) {
                // usersテーブル側
                userUpdates.drive_folder_url = $('#profile-drive-url').val().trim() || null;
                userUpdates.notebooklm_url = $('#profile-notebooklm-url').val().trim() || null;
                userUpdates.line_url = $('#profile-line-url').val().trim() || null;

                // profilesテーブル側
                profileUpdates.resume = $('#profile-resume-detail').val().trim() || null;
                profileUpdates.notes = $('#profile-notes').val().trim() || null;
            }

            try {
                // 1. usersテーブル更新
                const { error: userError } = await supabase
                    .from('users')
                    .update(userUpdates)
                    .eq('id', currentUser.id)

                if (userError) throw userError

                // 2. candidate_profilesテーブル更新 (upsert)
                const { error: profileError } = await supabase
                    .from('candidate_profiles')
                    .upsert({ user_id: currentUser.id, ...profileUpdates }, { onConflict: 'user_id' });

                if (profileError) throw profileError

                // Update local cache
                Object.assign(currentUser, userUpdates, profileUpdates)

                alert('プロフィールを保存しました！')
            } catch (error) {
                console.error('Save profile error:', error)
                alert('保存に失敗しました: ' + error.message)
            } finally {
                hideLoading()
            }
        })

        // ========================
        // Admin: Job Management
        // ========================
        let adminJobsCache = [];

        async function loadCoachStudents() {
            if (!currentUser) {
                console.warn('loadCoachStudents: currentUser is null');
                return;
            }
            console.log('loadCoachStudents START', {
                userId: currentUser.id,
                role: currentUser.role,
                orgId: currentUser.organization_id
            });
            showLoading()
            try {
                // 担当ユーザーを取得
                let studentQuery = supabase
                    .from('users')
                    .select('*')
                    .eq('coach_id', currentUser.id)
                    .eq('organization_id', currentUser.organization_id)
                    .order('created_at', { ascending: false });

                console.log('Executing studentQuery...');
                const { data: users, error } = await studentQuery;

                if (error) {
                    console.error('studentQuery error:', error);
                    throw error;
                }

                console.log(`Loaded ${users ? users.length : 0} assigned students`);
                renderCoachStudents(users || [])
            } catch (error) {
                console.error('Load students error:', error)
                alert('担当ユーザーの読み込みに失敗しました: ' + (error.message || error));
            } finally {
                hideLoading()
            }
        }

        function renderCoachStudents(users) {
            console.log('renderCoachStudents START', users);
            const container = $('#coach-students-container')
            if (container.length === 0) {
                console.error('Error: #coach-students-container not found');
                return;
            }
            container.empty()

            if (!users || users.length === 0) {
                console.log('No assigned students to render');
                container.html('<tr><td colspan="4" class="px-6 py-8 text-center text-gray-500">担当ユーザーがいません</td></tr>')
                return
            }

            const html = users.map(u => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${u.name || '名前なし'}</div>
                        <div class="text-sm text-gray-500">${u.email || '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${u.created_at ? new Date(u.created_at).toLocaleDateString() : '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <!-- ここに進捗状況（応募数など）を表示できると良い -->
                        -
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="viewCandidateProfile('${u.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">
                            詳細
                        </button>
                    </td>
                </tr>
            `).join('')

            container.html(html)
            console.log('renderCoachStudents DONE');
        }

        // ========================
        // Admin: Job CSV Import
        // ========================
        window.showJobCsvImportModal = function () {
            $('#job-csv-file').val('');
            $('#job-csv-preview').addClass('hidden').empty();
            $('#admin-job-csv-modal').removeClass('hidden');
        }

        window.closeJobCsvImportModal = function () {
            $('#admin-job-csv-modal').addClass('hidden');
        }

        window.downloadJobCsvTemplate = function (e) {
            e.preventDefault();

            if (typeof jobFields === 'undefined') {
                alert('テンプレート生成エラー: フィールド定義が見つかりません');
                return;
            }

            // ヘッダー生成 (エイリアスの先頭を使用、なければラベル)
            // これにより、追加された全項目（URL、福利厚生など）が自動的に反映される
            const headers = jobFields.map(f => {
                const name = f.aliases && f.aliases.length > 0 ? f.aliases[0] : f.label;
                return `"${name}"`; // クォートで囲む
            });

            // サンプルデータ1
            const sample1Values = jobFields.map(f => {
                switch (f.key) {
                    case 'title': return '法人営業マネージャー';
                    case 'company': return '株式会社ABC';
                    case 'salary_min': return '600'; // 万円
                    case 'salary_max': return '900'; // 万円
                    case 'location': return '東京都港区';
                    case 'description': return '営業チームのマネジメント、戦略立案業務をお任せします。';
                    case 'requirements': return '法人営業経験5年以上';
                    case 'welcome_requirements': return 'マネジメント経験があれば尚可';
                    case 'work_hours': return '9:00 - 18:00';
                    case 'holidays': return '土日祝、年末年始';
                    case 'employment_type': return '正社員';
                    case 'benefits': return '社会保険完備、交通費全額支給';
                    case 'is_remote': return '可'; // または 'あり', 'true'
                    case 'experience_level': return 'マネジメント経験者';
                    case 'industry': return 'IT・通信';
                    case 'url': return 'https://example.com/recruit/sales-mgr';
                    default: return '';
                }
            });
            const sample1 = sample1Values.map(v => `"${v}"`).join(',');

            // サンプルデータ2
            const sample2Values = jobFields.map(f => {
                switch (f.key) {
                    case 'title': return 'Webエンジニア';
                    case 'company': return 'テック株式会社';
                    case 'salary_min': return '500';
                    case 'salary_max': return '800';
                    case 'location': return 'フルリモート';
                    case 'description': return '自社サービスのWebアプリケーション開発を担当していただきます。';
                    case 'requirements': return 'Javaでの開発経験3年以上';
                    case 'welcome_requirements': return 'AWSの運用経験';
                    case 'work_hours': return 'フレックスタイム制';
                    case 'holidays': return '完全週休2日制';
                    case 'employment_type': return '正社員';
                    case 'benefits': '書籍購入補助、リモートワーク手当';
                    case 'is_remote': return 'はい';
                    case 'experience_level': return '実務経験3年以上';
                    case 'industry': return 'Webサービス';
                    case 'url': return 'https://example.com/recruit/engineer';
                    default: return '';
                }
            });
            const sample2 = sample2Values.map(v => `"${v}"`).join(',');

            const csvContent = headers.join(',') + "\n" + sample1 + "\n" + sample2;
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "job_import_template.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.processJobCsvImport = function () {
            const fileInput = document.getElementById('job-csv-file');
            const file = fileInput.files[0];

            if (!file) {
                alert('CSVファイルを選択してください');
                return;
            }

            // 共通のCSV処理フロー（マッピングモーダル表示）へ委譲
            processCSVFile(file, 'jobs');

            // シンプルなインポートモーダルは閉じる
            if (typeof closeJobCsvImportModal === 'function') {
                closeJobCsvImportModal();
            }
        }

        window.executeCSVImport = async function () {
            if (!currentCSVData || currentCSVData.length === 0) {
                alert('インポートするデータがありません');
                return;
            }

            if (!confirm(`${currentCSVData.length}件のデータをインポートしますか？`)) return;

            showLoading('CSVデータをインポート中...');
        }

        window.exportJobsCsv = function () {
            if (!adminJobsCache || adminJobsCache.length === 0) {
                alert('エクスポートするデータがありません');
                return;
            }

            const csvData = adminJobsCache.map(job => ({
                title: job.title,
                company: job.company,
                salary_min: job.salary_min,
                salary_max: job.salary_max,
                location: job.location,
                description: job.description,
                requirements: job.requirements,
                welcome_requirements: job.welcome_requirements,
                created_at: new Date(job.created_at).toLocaleString()
            }));

            const csv = Papa.unparse(csvData);
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `jobs_export_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function loadAdminJobs() {
            if (!currentUser) return

            showLoading()
            try {
                const { data: jobs, error } = await supabase
                    .from('jobs')
                    .select('*, companies(name)') // Join with companies
                    .eq('organization_id', currentUser.organization_id)
                    .is('deleted_at', null)
                    .order('created_at', { ascending: false })

                if (error) throw error

                adminJobsCache = jobs || [];
                renderAdminJobs(adminJobsCache);
            } catch (error) {
                console.error('Load admin jobs error:', error)
                $('#admin-jobs-container').html('<p class="text-red-500">求人の読み込みに失敗しました</p>')
            } finally {
                hideLoading()
            }
        }

        window.filterAdminJobs = function () {
            const searchText = $('#admin-job-search').val().toLowerCase();
            if (!searchText) {
                renderAdminJobs(adminJobsCache);
                return;
            }

            const filtered = adminJobsCache.filter(job =>
                (job.title && job.title.toLowerCase().includes(searchText)) ||
                (job.company && job.company.toLowerCase().includes(searchText)) ||
                (job.companies && job.companies.name && job.companies.name.toLowerCase().includes(searchText))
            );
            renderAdminJobs(filtered);
        }

        function renderAdminJobs(jobs) {
            const container = $('#admin-jobs-container')
            container.empty()

            if (jobs.length === 0) {
                container.html('<p class="text-gray-500 text-center py-8">求人がありません</p>')
                return
            }

            const statusBadge = (status) => {
                const config = {
                    'active': { label: '公開中', color: 'bg-green-100 text-green-800' },
                    'draft': { label: '下書き', color: 'bg-gray-100 text-gray-800' },
                    'closed': { label: '募集終了', color: 'bg-red-100 text-red-800' }
                }
                const s = config[status] || config['draft']
                return `<span class="px-2 py-1 rounded text-xs font-medium ${s.color}">${s.label}</span>`
            }

            const html = jobs.map(job => `
                <div class="bg-white border border-gray-200 rounded-lg p-6 mb-4">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h3 class="text-lg font-bold text-gray-900">${job.title}</h3>
                                ${statusBadge(job.status)}
                            </div>
                            <p class="text-gray-600 text-sm">${job.companies ? job.companies.name : job.company}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick='openEditJobModal("${job.id}")' class="text-indigo-600 hover:text-indigo-800 px-3 py-1 text-sm">
                                <i class="fas fa-edit mr-1"></i>編集
                            </button>
                            <button onclick="deleteJob('${job.id}')" class="text-red-600 hover:text-red-800 px-3 py-1 text-sm">
                                <i class="fas fa-trash mr-1"></i>削除
                            </button>
                        </div>
                    </div>
                    <p class="text-gray-600 text-sm line-clamp-2">${job.description || ''}</p>
                </div>
            `).join('')

            container.html(html)
        }

        window.deleteJob = async function (jobId) {
            if (!confirm('この求人を削除しますか？')) return

            showLoading()
            try {
                const { error } = await supabase
                    .from('jobs')
                    .update({ deleted_at: new Date().toISOString() })
                    .eq('id', jobId)

                if (error) throw error

                alert('削除しました')
                loadAdminJobs()
            } catch (error) {
                console.error('Delete job error:', error)
                alert('削除に失敗しました: ' + error.message)
            } finally {
                hideLoading()
            }
        }

        // 業種マスタ一括更新用関数
        window.updateIndustryCategoriesMaster = async function () {
            if (!currentUser || !currentUser.organization_id) {
                alert('組織情報が取得できませんでした。');
                return;
            }
            if (currentUser.role !== 'super_admin') {
                alert('この操作はスーパー管理者のみ可能です。');
                return;
            }
            if (!confirm('自組織の業種マスタを初期化して、新しいリストで更新しますか？\n既存の業種カテゴリは全て削除されます。')) return;

            const newIndustryCategories = [
                "IT・通信・インターネット",
                "メーカー（機械・電気・電子）",
                "メーカー（素材・化学・食品・その他）",
                "商社（総合・専門）",
                "金融・保険",
                "建設・不動産・住宅",
                "物流・運輸",
                "流通・小売・サービス",
                "広告・出版・マスコミ",
                "コンサルティング・調査",
                "人材サービス",
                "医療・医薬・福祉",
                "教育・官公庁・その他",
                "エネルギー・インフラ",
                "旅行・宿泊・レジャー",
                "その他"
            ];

            try {
                // 1. 既存の業種カテゴリを削除 (自組織のみ対象)
                const { error: deleteError } = await supabase
                    .from('master_data')
                    .delete()
                    .eq('type', 'industry_category')
                    .eq('organization_id', currentUser.organization_id);

                if (deleteError) throw deleteError;

                // 2. 新しい業種カテゴリを追加
                const insertData = newIndustryCategories.map((label, index) => ({
                    type: 'industry_category',
                    label: label,
                    value: label,
                    sort_order: (index + 1) * 10,
                    is_active: true,
                    organization_id: currentUser.organization_id
                }));

                const { error } = await supabase
                    .from('master_data')
                    .insert(insertData);

                if (error) throw error;

                alert('業種マスタを初期化しました');
                // マスタ管理画面が開いていれば再読み込み
                if ($('#admin-master-content').is(':visible')) {
                    loadMasterData();
                }

            } catch (error) {
                console.error('Failed to update industry categories:', error);
                alert('業種マスタの更新に失敗しました: ' + error.message);
            }
        }

        window.deleteUser = async function (userId) {
            if (!confirm('このユーザーを削除しますか？\n（論理削除され、一覧から非表示になります）')) return

            showLoading()
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ deleted_at: new Date().toISOString() })
                    .eq('id', userId)

                if (error) throw error

                alert('削除しました')

                // リロード
                if ($('#admin-users-content').is(':visible')) {
                    loadAdminUsers();
                } else if ($('#admin-candidates-content').is(':visible')) {
                    loadAdminCandidates();
                }
            } catch (error) {
                console.error('Delete user error:', error)
                alert('削除に失敗しました: ' + error.message)
            } finally {
                hideLoading()
            }
        }

        window.openEditJobModal = function (jobId) {
            showJobForm(jobId)
        }

        // マスタデータから選択肢をロードするヘルパー関数
        async function loadMasterOptions(type, selectId, selectedValue = null) {
            try {
                const { data: masters, error } = await supabase
                    .from('master_data')
                    .select('*')
                    .eq('type', type)
                    .eq('is_active', true)
                    .order('sort_order', { ascending: true })

                if (error) throw error

                // フィルタリング（グローバル または 自社用）
                const validMasters = masters.filter(m =>
                    m.organization_id === null || m.organization_id === currentUser.organization_id
                )

                const select = $(`#${selectId}`)
                select.empty()

                if (validMasters.length > 0) {
                    validMasters.forEach(m => {
                        const option = $('<option></option>').val(m.value).text(m.label)
                        if (selectedValue && m.value === selectedValue) {
                            option.prop('selected', true)
                        }
                        select.append(option)
                    })
                } else {
                    // マスタがない場合のフォールバック
                    const fallbacks = {
                        'employment_type': ['正社員', '契約社員', '派遣社員', '業務委託'],
                        'job_category': ['エンジニア', '営業', 'デザイナー', 'その他']
                    }
                    const options = fallbacks[type] || []
                    options.forEach(opt => {
                        const option = $('<option></option>').val(opt).text(opt)
                        if (selectedValue && opt === selectedValue) {
                            option.prop('selected', true)
                        }
                        select.append(option)
                    })
                }
            } catch (error) {
                console.error(`Load master options error (${type}):`, error)
            }
        }

        window.showJobForm = async function (jobId = null) {
            // マスタデータが未ロードならロードする
            if (masterJobCategories.length === 0 || masterIndustries.length === 0) {
                await initMasterDataDropdowns();
            }

            $('#job-form')[0].reset()
            $('#job-id').val('')

            // 企業リストのロード
            try {
                const { data: companies } = await supabase
                    .from('companies')
                    .select('id, name')
                    .eq('organization_id', currentUser.organization_id)
                    .order('name');

                const select = $('#job-company-select');
                select.empty();
                select.append('<option value="">企業を選択してください</option>');
                select.append('<option value="new">+ 新規企業を作成</option>');

                if (companies) {
                    companies.forEach(c => {
                        select.append(`<option value="${c.id}">${c.name}</option>`);
                    });
                }
            } catch (e) {
                console.error('Failed to load companies for select:', e);
            }

            // 担当者リストのロード (管理者・コーチ・CA)
            try {
                const { data: picUsers } = await supabase
                    .from('users')
                    .select('id, name')
                    .eq('organization_id', currentUser.organization_id)
                    .in('role', ['admin', 'super_admin', 'coach', 'ca'])
                    .neq('management_status', 'inactive')
                    .order('name');

                const picSelect1 = $('#job-pic-user-1');
                const picSelect2 = $('#job-pic-user-2');

                const defaultOption = '<option value="">選択してください</option>';
                picSelect1.empty().append(defaultOption);
                picSelect2.empty().append(defaultOption);

                if (picUsers) {
                    picUsers.forEach(u => {
                        const option = `<option value="${u.id}">${u.name}</option>`;
                        picSelect1.append(option);
                        picSelect2.append(option);
                    });
                }
            } catch (e) {
                console.error('Failed to load users for PIC select:', e);
            }

            // マスタデータのプルダウン初期化（値なし）
            populateSelectOptions('job-employment-type', ['正社員', '契約社員', '派遣社員', '業務委託']);

            populateSelectOptions('job-category', masterJobCategories);
            populateSelectOptions('job-industry-category', masterIndustries);

            if (jobId) {
                $('#job-modal-title').text('求人編集')
                $('#job-id').val(jobId)

                // 編集時はデータを取得してセット
                const { data: job } = await supabase
                    .from('jobs')
                    .select('*')
                    .eq('id', jobId)
                    .single()

                if (job) {
                    $('#job-title').val(job.title)
                    $('#job-company-id').val(job.company_id)
                    $('#job-company-select').val(job.company_id)

                    $('#job-location').val(job.location)
                    if (job.salary_min) $('#job-salary-min').val(job.salary_min / 10000)
                    if (job.salary_max) $('#job-salary-max').val(job.salary_max / 10000)
                    $('#job-description').val(job.description)
                    $('#job-work-hours').val(job.work_hours)
                    $('#job-holidays').val(job.holidays)
                    $('#job-benefits').val(job.benefits)
                    $('#job-interview-process').val(job.interview_process)
                    // Requirements and Welcome Requirements
                    $('#job-requirements').val(job.requirements || '')
                    $('#job-welcome-requirements').val(job.welcome_requirements || '')

                    // 追加項目
                    $('#job-url').val(job.url || '');
                    $('#job-pic-user-1').val(job.pic_user_id_1 || '');
                    $('#job-pic-user-2').val(job.pic_user_id_2 || '');

                    $('#job-employment-type').val(job.employment_type)
                    $('#job-is-remote').prop('checked', job.is_remote)
                    $('#job-experience-ok').prop('checked', job.job_experience_ok === '可')
                    $('#job-industry-experience-ok').prop('checked', job.industry_experience_ok === '可')

                    // マスタデータ選択肢の再設定 (selected valueを反映)
                    // populateSelectOptions はマスタにない値も追加してくれる
                    populateSelectOptions('job-category', masterJobCategories, job.job_category);
                    populateSelectOptions('job-industry-category', masterIndustries, job.industry_category);
                }
            } else {
                $('#job-modal-title').text('求人作成')
            }
            $('#job-modal').removeClass('hidden')
        }

        window.handleCompanySelect = function (value) {
            if (value === 'new') {
                // 新規作成モーダルを開くなどの処理が必要だが、
                // ここでは簡易的に「企業管理画面で作成してください」と案内するか、
                // あるいはCompanyModalを重ねて開く。
                // 重ねて開くのはZ-index管理が面倒なので、一旦アラートで案内。
                if (confirm('新しい企業を登録しますか？\nOKを押すと企業登録画面が開きます。\n（現在の入力内容は破棄されます）')) {
                    closeJobModal();
                    showCompanyForm();
                } else {
                    $('#job-company-select').val('');
                }
            } else {
                $('#job-company-id').val(value);
            }
        }

        window.closeJobModal = function () {
            $('#job-modal').addClass('hidden')
            $('#job-form')[0].reset()
        }

        $('#job-form').on('submit', async function (e) {
            e.preventDefault()
            showLoading()

            const jobId = $('#job-id').val()
            const salaryMin = $('#job-salary-min').val()
            const salaryMax = $('#job-salary-max').val()

            const jobData = {
                organization_id: currentUser.organization_id,
                title: $('#job-title').val(),
                company_id: $('#job-company-id').val(),
                company: $('#job-company-select option:selected').text(), // Legacy support but required by DB constraint
                location: $('#job-location').val(),
                employment_type: $('#job-employment-type').val(),
                salary_min: salaryMin ? parseInt(salaryMin) * 10000 : null,
                salary_max: salaryMax ? parseInt(salaryMax) * 10000 : null,
                job_category: $('#job-category').val() || null,
                industry_category: $('#job-industry-category').val() || null,
                job_experience_ok: $('#job-experience-ok').is(':checked') ? '可' : '不可',
                industry_experience_ok: $('#job-industry-experience-ok').is(':checked') ? '可' : '不可',
                industry_experience_ok: $('#job-industry-experience-ok').is(':checked') ? '可' : '不可',
                description: $('#job-description').val(),
                requirements: $('#job-requirements').val(),
                welcome_requirements: $('#job-welcome-requirements').val(),
                status: $('#job-status').val(),
                is_remote: $('#job-is-remote').is(':checked'),
                work_hours: $('#job-work-hours').val(),
                holidays: $('#job-holidays').val(),
                benefits: $('#job-benefits').val(),
                interview_process: $('#job-interview-process').val(),
                url: $('#job-url').val() || null,
                pic_user_id_1: $('#job-pic-user-1').val() || null,
                pic_user_id_2: $('#job-pic-user-2').val() || null,
                updated_at: new Date().toISOString()
            }

            if (!jobData.company_id) {
                alert('企業を選択してください');
                hideLoading();
                return;
            }

            try {
                if (jobId) {
                    // Update
                    const { error } = await supabase
                        .from('jobs')
                        .update(jobData)
                        .eq('id', jobId)

                    if (error) throw error

                    // ログ記録
                    await auditLog.jobUpdated(jobId, { title: jobData.title });

                    alert('求人を更新しました')
                } else {
                    // Create
                    const { data: newJob, error } = await supabase
                        .from('jobs')
                        .insert(jobData)
                        .select()
                        .single()

                    if (error) throw error

                    // ログ記録
                    if (newJob) {
                        await auditLog.jobCreated(newJob.id, { title: jobData.title });
                    }

                    alert('求人を作成しました')
                }

                closeJobModal()
                loadAdminJobs()
            } catch (error) {
                console.error('Save job error:', error)
                alert('保存に失敗しました: ' + error.message)
            } finally {
                hideLoading()
            }
        })

        // ========================
        // ========================
        // Admin: Candidate Management
        // ========================
        let adminCandidatesCache = [];
        // ========================
        // Admin: User Edit Modal Logic
        // ========================
        let adminCoachesCache = [];

        async function loadAdminCoaches() {
            // コーチ、CA、RAに加えて管理者も担当者として取得可能にする
            const { data: coaches } = await supabase
                .from('users')
                .select('id, name, role, status, management_status')
                .eq('organization_id', currentUser.organization_id)
                .in('role', ['coach', 'ca', 'ra', 'admin', 'org_admin']);
            // 停止中ユーザーまたは管理ステータスが「活動終了」のユーザーを除外
            adminCoachesCache = (coaches || []).filter(u => u.status !== 'suspended' && (u.management_status !== 'inactive'));
        }

        window.showAdminUserModal = async function (userId) {
            console.log('showAdminUserModal called with userId:', userId);
            if (!currentUser) return;

            // Reset modal ready flag to prevent premature submission
            isModalReady = false;

            // コーチリストをロード（未ロードの場合）
            if (adminCoachesCache.length === 0) {
                await loadAdminCoaches();
            }

            // ユーザー情報を取得
            const { data: userData, error } = await supabase
                .from('users')
                .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                .eq('id', userId)
                .single();

            if (error || !userData) {
                console.error('Error fetching user:', error);
                alert('ユーザー情報の取得に失敗しました');
                return;
            }

            console.log('Fetched userData:', userData);
            console.log('candidate_profiles:', userData.candidate_profiles);

            // フラット化
            const profile = Array.isArray(userData.candidate_profiles) ? userData.candidate_profiles[0] : userData.candidate_profiles;
            const user = { ...userData, ...profile };
            user.id = userData.id; // ID確保

            console.log('Merged user object:', {
                desired_job_type: user.desired_job_type,
                desired_industry: user.desired_industry,
                desired_employment_type: user.desired_employment_type,
                desired_location: user.desired_location
            });

            // 権限チェック: コーチ/CA/RAは担当求職者のみ編集可能
            if (['coach', 'ca', 'ra'].includes(currentUser.role)) {
                if (user.role !== 'candidate' || user.coach_id !== currentUser.id) {
                    alert('このユーザーを編集する権限がありません');
                    return;
                }
            }

            // フォームに値をセット
            $('#admin-user-id').val(user.id);
            $('#admin-user-name').val(user.name);
            $('#admin-user-furigana').val(user.furigana || '');
            $('#admin-user-email').val(user.email);
            $('#admin-user-new-password').val(''); // パスワードフィールドをリセット (新規追加)

            // 権限ラベルの更新
            const $roleSelect = $('#admin-user-role');
            $roleSelect.find('option[value="org_admin"]').text(getRoleLabel('org_admin'));
            $roleSelect.find('option[value="admin"]').text(getRoleLabel('admin'));
            $roleSelect.find('option[value="coach"]').text(getRoleLabel('coach'));
            $roleSelect.find('option[value="candidate"]').text(getRoleLabel('candidate'));

            $roleSelect.val(user.role);
            $('#admin-user-status').val(user.status || 'active');
            $('#admin-user-management-status').val(user.management_status || 'active');

            // 権限変更の制御: 管理者のみ可能
            if (['org_admin', 'admin', 'super_admin'].includes(currentUser.role)) {
                $('#admin-user-role-container').show();
                $('#admin-user-coach-container').show();
            } else {
                $('#admin-user-role-container').hide();
                $('#admin-user-coach-container').hide();
            }

            // 求職者フィールドの表示制御
            if (user.role === 'candidate') {
                $('#admin-candidate-fields').removeClass('hidden');

                // コーチプルダウンの生成
                const coachSelect = $('#admin-user-coach');
                coachSelect.empty();
                coachSelect.append('<option value="">未設定</option>');
                adminCoachesCache.forEach(c => {
                    const roleLabel = `(${getRoleLabel(c.role)})`;
                    coachSelect.append(`<option value="${c.id}">${c.name} ${roleLabel}</option>`);
                });
                if (user.coach_id) {
                    coachSelect.val(user.coach_id);
                }

                // マスタデータロード & 値セット
                try {
                    console.log('Loading master data for user:', user);
                    await loadMasterDataForProfile(user);

                    // loadMasterDataForProfile内で既にSelect2の初期化と値のセットが完了している
                    console.log('Master data loaded and values set successfully');
                } catch (err) {
                    console.error('Failed to load master data:', err);
                    // エラーが出てもフォームは開くようにする（ただし値はセットされない可能性がある）
                }

                const salary = user.desired_salary ? Math.floor(user.desired_salary / 10000) : '';
                // 異常値（10億円以上など、Int32上限オーバーフロー由来の値）は表示しない
                // 異常値（10億円以上など、Int32上限オーバーフロー由来の値）は表示しない
                $('#admin-user-salary').val(salary > 100000 ? '' : salary);
                $('#admin-user-birth-date').val(user.birth_date || '');
                $('#admin-user-age').val(user.age || '');
                $('#admin-user-education').val(user.education || '');
                $('#admin-user-skills').val(user.skills || '');
                $('#admin-user-history').val(user.work_history || '');
                $('#admin-user-work-history-detail').val(user.work_history_detail || '');
                $('#admin-user-history-info').val(user.history_info || '');


                // 追加詳細項目のセット
                $('#admin-user-phone').val(user.phone || '');
                $('#admin-user-job-exp-ok').prop('checked', user.desired_job_experience_ok);
                $('#admin-user-industry-exp-ok').prop('checked', user.desired_industry_experience_ok);
                $('#admin-user-work-history-detail').val(user.work_history || '');
                $('#admin-user-resume-detail').val(user.resume || '');
                $('#admin-user-notes').val(user.notes || '');
                $('#admin-user-drive-url').val(user.drive_folder_url || '');
                $('#admin-user-notebooklm-url').val(user.notebooklm_url || '');
                $('#admin-user-line-url').val(user.line_url || '');

                // 詳細職歴
                console.log('Rendering work history list...');
                $('#work-history-list').empty();
                if (user.work_history_structured && Array.isArray(user.work_history_structured)) {
                    user.work_history_structured.forEach(item => addWorkHistoryItem(item));
                }
                updateJobChangeCount();
                console.log('Work history rendering complete');

            } else {
                console.log('User is not a candidate, skipping candidate fields');
                $('#admin-candidate-fields').addClass('hidden');
            }
            console.log('Forcing modal visibility (z-index 99999)...');
            const modal = $('#admin-user-modal');
            if (modal.length === 0) {
                console.error('CRITICAL: #admin-user-modal not found!');
                return;
            }
            // Move to body to avoid parent clipping
            $('body').append(modal);
            modal.removeClass('hidden').attr('style', 'display: flex !important; z-index: 99999 !important; visibility: visible !important; opacity: 1 !important;');
            console.log('showAdminUserModal process finished');

            // Set modal ready flag after everything is loaded
            setTimeout(() => {
                isModalReady = true;
                console.log('Modal is now ready for submission');
            }, 100);
        }

        window.closeAdminUserModal = function () {
            console.log('--- closeAdminUserModal Triggered ---');
            console.trace('closeAdminUserModal called from:');

            // Reset the ready flag
            isModalReady = false;

            $('#admin-user-modal').addClass('hidden').attr('style', 'display: none !important;');
        }

        // パスワード更新処理 (新規追加)
        window.updateUserPassword = async function () {
            const userId = $('#admin-user-id').val();
            const newPassword = $('#admin-user-new-password').val();

            if (!userId) {
                alert('ユーザーIDが見つかりません');
                return;
            }

            if (!newPassword || newPassword.length < 6) {
                alert('パスワードは6文字以上で入力してください');
                return;
            }

            if (!confirm('本当にパスワードを更新しますか？')) {
                return;
            }

            showLoading();
            try {
                const { data, error } = await supabase.functions.invoke('update-user-password', {
                    body: { userId, newPassword }
                });

                if (error) throw error;
                if (data && data.success === false) throw new Error(data.error);

                alert('パスワードを更新しました');
                $('#admin-user-new-password').val(''); // クリア
            } catch (error) {
                console.error('Password update error:', error);
                alert('パスワードの更新に失敗しました: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // 職歴リスト操作関数 (汎用化)
        window.addWorkHistoryItemToContainer = function (containerSelector, data = {}) {
            const container = $(containerSelector);
            const count = container.children().length;
            if (count >= 10) {
                alert('職歴項目は最大10件までです。');
                return;
            }
            const index = count + 1;
            const targetCountId = containerSelector === '#work-history-list' ? '#admin-user-job-change-count' : '#profile-job-change-count';

            const $item = $(`
                <div class="work-history-item bg-gray-50 p-4 rounded-lg border border-gray-200 relative mb-4">
                    <button type="button" onclick="$(this).closest('.work-history-item').remove(); updateJobChangeCountInContainer('${containerSelector}', '${targetCountId}');" 
                        class="absolute top-2 right-2 text-gray-400 hover:text-red-500 w-6 h-6 flex items-center justify-center rounded-full hover:bg-gray-200 transition">
                        <i class="fas fa-times"></i>
                    </button>
                    <h5 class="text-sm font-bold text-indigo-700 mb-2">職歴 ${index}</h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">会社名</label>
                            <input type="text" class="wh-company w-full px-3 py-2 border rounded text-sm bg-white" placeholder="会社名">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">在籍期間</label>
                            <input type="text" class="wh-period w-full px-3 py-2 border rounded text-sm bg-white" placeholder="例: 2020/04 - 2023/03">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="block text-xs text-gray-500 mb-1">役割・役職</label>
                        <input type="text" class="wh-role w-full px-3 py-2 border rounded text-sm bg-white" placeholder="役割・役職">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">職務内容</label>
                        <textarea class="wh-description w-full px-3 py-2 border rounded text-sm bg-white" rows="3" placeholder="職務内容"></textarea>
                    </div>
                </div>
            `);

            $item.find('.wh-company').val(data.company_name || '');
            $item.find('.wh-period').val(data.period || '');
            $item.find('.wh-role').val(data.role || '');
            $item.find('.wh-description').val(data.description || '');

            container.append($item);
            updateJobChangeCountInContainer(containerSelector, targetCountId);
        };

        window.updateJobChangeCountInContainer = function (containerSelector, countIdSelector) {
            const container = $(containerSelector);
            const count = container.children().length;
            $(countIdSelector).val(count);
            // 番号振り直し
            container.find('.work-history-item').each(function (i) {
                $(this).find('h5').text(`職歴 ${i + 1}`);
            });
        };

        // 旧関数をエイリアスとして残す (互換性維持)
        window.addWorkHistoryItem = function (data = {}) {
            addWorkHistoryItemToContainer('#work-history-list', data);
        };
        window.updateJobChangeCount = function () {
            updateJobChangeCountInContainer('#work-history-list', '#admin-user-job-change-count');
        };

        // 管理者用: PDFからの自動入力ハンドラ
        window.handleAdminUserPdfUpload = async function (input) {
            if (input.files.length === 0) return;

            if (!confirm('PDFを解析してフォームに自動入力しますか？\n※既存の入力内容は上書きされます。')) {
                input.value = '';
                return;
            }

            showLoading('PDFを解析中...');
            try {
                let combinedText = '';
                for (let i = 0; i < input.files.length; i++) {
                    combinedText += await extractTextFromPDF(input.files[i]);
                }

                // AI解析実行
                let result = await analyzeDocumentWithAI(combinedText, 'resume');

                // 配列で返ってきた場合は最初の要素を使う
                if (Array.isArray(result)) {
                    result = result[0] || {};
                }

                console.log('PDF Analysis Result:', result);

                // --- フォームへの反映 ---

                // 基本情報
                if (result.name) $('#admin-user-name').val(result.name);
                if (result.furigana || result.kana) $('#admin-user-furigana').val(result.furigana || result.kana);
                if (result.email) $('#admin-user-email').val(result.email);

                // 年齢・生年月日 (推定値があれば)
                if (result.age) $('#admin-user-age').val(result.age);

                // 年収
                if (result.current_salary) {
                    $('#admin-user-salary').val(result.current_salary / 10000); // 万円単位
                }

                // 学歴
                if (result.academic_background) {
                    $('#admin-user-education').val(result.academic_background);
                }

                // スキル
                if (result.skills) {
                    $('#admin-user-skills').val(result.skills);
                }

                // 職歴
                if (result.work_history) {
                    $('#admin-user-history').val(result.work_history);
                }
                if (result.work_history_detail) {
                    $('#admin-user-work-history-detail').val(result.work_history_detail);
                }

                // 構造化された職歴
                if (result.work_history_structured && Array.isArray(result.work_history_structured)) {
                    $('#work-history-list').empty();
                    result.work_history_structured.forEach(item => addWorkHistoryItem(item));
                    updateJobChangeCount();
                }

                // --- マスタデータの自動マッチング (職種・業界) ---

                // 職種
                if (result.desired_job_type || result.job_sub_category) {
                    // 抽出された値リスト
                    const extractedJobs = [result.desired_job_type, result.job_sub_category].flat().filter(Boolean);

                    const matchedJobs = [];
                    extractedJobs.forEach(val => {
                        const match = findClosestMasterValue(val, masterJobCategories);
                        if (match && !matchedJobs.includes(match)) {
                            matchedJobs.push(match);
                        }
                    });

                    if (matchedJobs.length > 0) {
                        console.log('Matched Job Categories:', matchedJobs);
                        // Select2の値をセットして通知
                        $('#admin-user-job-type').val(matchedJobs).trigger('change');
                    }
                }

                // 業界
                if (result.desired_industry) {
                    const extractedIndustries = [result.desired_industry].flat().filter(Boolean);

                    const matchedIndustries = [];
                    extractedIndustries.forEach(val => {
                        const match = findClosestMasterValue(val, masterIndustries);
                        if (match && !matchedIndustries.includes(match)) {
                            matchedIndustries.push(match);
                        }
                    });

                    if (matchedIndustries.length > 0) {
                        console.log('Matched Industries:', matchedIndustries);
                        $('#admin-user-industry').val(matchedIndustries).trigger('change');
                    }
                }

                alert('解析が完了し、フォームに入力しました。');

            } catch (error) {
                console.error('PDF analysis error:', error);
                alert('解析に失敗しました: ' + error.message);
            } finally {
                hideLoading();
                input.value = '';
            }
        }

        // Flag to prevent premature submission
        let isModalReady = false;

        // ユーザー保存処理
        $('#admin-user-form').off('submit').on('submit', async function (e) {
            console.log('=== FORM SUBMIT TRIGGERED ===');
            console.log('isModalReady:', isModalReady);
            console.log('Event:', e);

            e.preventDefault();
            e.stopPropagation();

            if (!currentUser) {
                console.warn('No current user, aborting submit');
                return;
            }

            // Prevent submission if modal is not fully loaded
            if (!isModalReady) {
                console.warn('Modal not ready for submission yet - BLOCKING SUBMIT');
                return false;
            }

            const userId = $('#admin-user-id').val();
            const role = $('#admin-user-role').val();

            console.log('Proceeding with save - userId:', userId, 'role:', role);

            if (!userId) {
                console.error('No user ID found');
                return false;
            }

            // Usersテーブル用更新データ
            const updates = {
                name: $('#admin-user-name').val().trim(),
                furigana: $('#admin-user-furigana').val().trim(),
                email: $('#admin-user-email').val().trim(),
                status: $('#admin-user-status').val(),
                management_status: $('#admin-user-management-status').val(),
                updated_at: new Date().toISOString()
            };

            if (['org_admin', 'admin', 'super_admin'].includes(currentUser.role)) {
                updates.role = role;
            }

            // candidate固有のUsersテーブル更新項目
            if (role === 'candidate') {
                if (['org_admin', 'admin', 'super_admin'].includes(currentUser.role)) {
                    updates.coach_id = $('#admin-user-coach').val() || null;
                }
                updates.drive_folder_url = $('#admin-user-drive-url').val().trim() || null;
                updates.notebooklm_url = $('#admin-user-notebooklm-url').val().trim() || null;
                updates.line_url = $('#admin-user-line-url').val().trim() || null;
            }

            showLoading();
            try {
                console.log('Updating users table with:', updates);

                // 1. usersテーブル更新
                const { data: updatedUser, error: usersError } = await supabase
                    .from('users')
                    .update(updates)
                    .eq('id', userId)
                    .select();

                console.log('Users table update result:', { data: updatedUser, error: usersError });

                if (usersError) {
                    console.error('Users table update failed:', usersError);
                    throw usersError;
                }

                if (!updatedUser || updatedUser.length === 0) {
                    console.warn('⚠️ No rows were updated in users table. This might be an RLS policy issue.');
                    alert('警告: ユーザー情報の更新に失敗しました。RLSポリシーを確認してください。');
                }

                // 2. candidate_profilesテーブル更新 (role === 'candidate' の場合のみ)
                const currentRole = $('#admin-user-role').val();
                if (currentRole === 'candidate') {
                    const jobType = $('#admin-user-job-type').val();
                    const industry = $('#admin-user-industry').val();
                    const prefs = $('#admin-user-prefecture').val();
                    const city = $('#admin-user-city').val() || '';

                    console.log('=== Form Values Debug ===');
                    console.log('Job Type:', jobType);
                    console.log('Industry:', industry);
                    console.log('Prefs:', prefs);
                    console.log('City:', city);

                    let locationStr = '';
                    if (Array.isArray(prefs) && prefs.length > 0) {
                        locationStr = prefs.join(',');
                        if (city && prefs.length > 1) locationStr += ' ' + city;
                        else if (city) locationStr = prefs[0] + city;
                    } else if (prefs) locationStr = prefs + city;
                    else if (city) locationStr = city;

                    const empType = $('#admin-user-employment-type').val();

                    console.log('Location String:', locationStr);
                    console.log('Employment Type:', empType);

                    // 詳細職歴リスト
                    const workHistoryList = [];
                    $('#work-history-list .work-history-item').each(function () {
                        workHistoryList.push({
                            company_name: $(this).find('.wh-company').val(),
                            period: $(this).find('.wh-period').val(),
                            role: $(this).find('.wh-role').val(),
                            description: $(this).find('.wh-description').val()
                        });
                    });

                    // 値の取得
                    const workHistorySummary = $('#admin-user-history').val().trim();
                    const workHistoryDetailText = $('#admin-user-work-history-detail').val().trim();
                    const resumeDetailText = $('#admin-user-resume-detail').val().trim();
                    const notes = $('#admin-user-notes').val();

                    // 明示的にプロパティを指定してオブジェクトを作成
                    const profileUpdates = {
                        desired_job_type: jobType ? jobType.join(',') : null,
                        desired_industry: industry ? industry.join(',') : null,
                        desired_location: locationStr,
                        desired_employment_type: empType ? empType.join(',') : null,
                        desired_salary: $('#admin-user-salary').val() ? parseInt($('#admin-user-salary').val()) * 10000 : null,
                        skills: $('#admin-user-skills').val().trim(),

                        // work_historyとdetailを別々に保存
                        work_history: workHistorySummary,
                        work_history_detail: workHistoryDetailText,
                        history_info: $('#admin-user-history-info').val().trim(),

                        // 構造化データ
                        work_history_structured: workHistoryList,
                        job_change_count: workHistoryList.length,

                        desired_job_experience_ok: $('#admin-user-job-exp-ok').is(':checked'),
                        desired_industry_experience_ok: $('#admin-user-industry-exp-ok').is(':checked'),

                        // カラム名の修正 (DBに存在しない _detail カラムを使わない)
                        resume: resumeDetailText,

                        notes: notes,
                        birth_date: $('#admin-user-birth-date').val() || null,
                        age: $('#admin-user-age').val() ? parseInt($('#admin-user-age').val()) : null,
                        gender: $('#admin-user-gender').val() || null,
                        current_location: $('#admin-user-current-location').val() || null,
                        education: $('#admin-user-education').val().trim() || null,
                        phone: $('#admin-user-phone').val().trim() || null,
                        updated_at: new Date().toISOString()
                    };

                    console.log('Upserting profile:', profileUpdates); // Debug

                    const { error: profileError } = await supabase
                        .from('candidate_profiles')
                        .upsert({ user_id: userId, ...profileUpdates }, { onConflict: 'user_id' });

                    if (profileError) throw profileError;
                }

                alert('ユーザー情報を更新しました');
                closeAdminUserModal();

                // リロード
                if ($('#admin-users-content').is(':visible')) loadAdminUsers();
                else if ($('#admin-candidates-content').is(':visible')) loadAdminCandidates();

            } catch (error) {
                console.error('Update user error:', error);
                alert('更新に失敗しました: ' + error.message);
            } finally {
                hideLoading();
            }
        });

        async function loadAdminCandidates() {
            if (!currentUser) return
            showLoading()
            try {
                console.log('loadAdminCandidates - currentUser:', currentUser);
                console.log('loadAdminCandidates - role:', currentUser.role);

                // 組織設定を確認（閲覧制限）
                let limitView = false;
                if (['coach', 'ca', 'ra'].includes(currentUser.role)) {
                    const { data: org } = await supabase
                        .from('organizations')
                        .select('settings')
                        .eq('id', currentUser.organization_id)
                        .single();

                    console.log('loadAdminCandidates - org settings:', org);
                    if (org && org.settings && org.settings.limit_agent_view) {
                        limitView = true;
                        console.log('loadAdminCandidates - limit_agent_view is enabled');
                    }
                }

                // roleがcandidateのユーザーを取得
                let query = supabase
                    .from('users')
                    .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                    .eq('organization_id', currentUser.organization_id)
                    .eq('role', 'candidate')
                    .is('deleted_at', null)
                    .order('created_at', { ascending: false });

                // 閲覧制限が有効な場合、担当者でフィルタリング
                if (limitView) {
                    console.log('loadAdminCandidates - filtering by coach_id:', currentUser.id);
                    query = query.eq('coach_id', currentUser.id);
                }

                const { data: users, error } = await query;

                console.log('loadAdminCandidates - query result:', { users, error });
                console.log('loadAdminCandidates - number of users:', users?.length || 0);

                if (error) throw error

                // データをフラット化（後方互換性のため）
                const flattenedUsers = users.map(u => {
                    const profile = Array.isArray(u.candidate_profiles) ? u.candidate_profiles[0] : u.candidate_profiles;
                    const combined = { ...u, ...profile };
                    // idだけはusersのものを維持（同じはずだが念のため）
                    combined.id = u.id;
                    return combined;
                });

                adminCandidatesCache = flattenedUsers || [];
                renderAdminCandidates(adminCandidatesCache);
                // データ更新があったため、検索画面のキャッシュも更新待ち状態にする
                shouldReloadCandidates = true;
            } catch (error) {
                console.error('Load candidates error:', error)
                alert('求職者の読み込みに失敗しました')
            } finally {
                hideLoading()
            }
        }

        function renderAdminCandidates(users) {
            const container = $('#admin-candidates-container')
            container.empty()

            if (users.length === 0) {
                container.html('<tr><td colspan="4" class="px-6 py-8 text-center text-gray-500">登録されている求職者はいません</td></tr>')
                return
            }

            const html = users.map(u => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${u.name}</div>
                        <div class="text-sm text-gray-500">${u.email}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900 font-medium">${window.formatArrayValue(u.desired_job_type)}</div>
                        <div class="text-xs text-gray-500">${window.formatArrayValue(u.desired_location)}</div>
                        <div class="text-xs text-indigo-600 mt-1 font-bold">${window.formatSalaryValue(u.desired_salary)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="mb-1">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${u.status === 'suspended' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                ${u.status === 'suspended' ? '停止中' : '利用中'}
                            </span>
                        </div>
                        <div>
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${u.management_status === 'inactive' ? 'bg-gray-200 text-gray-700' : 'bg-blue-100 text-blue-800'}">
                                ${u.management_status === 'inactive' ? '活動終了' : '活動中'}
                            </span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="viewCandidateProfile('${u.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">
                            詳細
                        </button>
                        <button onclick="deleteUser('${u.id}')" class="text-red-600 hover:text-red-900">
                            削除
                        </button>
                    </td>
                </tr>
            `).join('')

            container.html(html)
        }

        window.showUserProfile = async function (userId) {
            try {
                const { data: userData, error } = await supabase
                    .from('users')
                    .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                    .eq('id', userId)
                    .single();

                if (error) throw error;

                // フラット化
                const profile = Array.isArray(userData.candidate_profiles) ? userData.candidate_profiles[0] : userData.candidate_profiles;
                const user = { ...userData, ...profile };
                user.id = userData.id;

                const info = `
名前: ${user.name}
メール: ${user.email}
希望職種: ${window.formatArrayValue(user.desired_job_type)}
希望勤務地: ${window.formatArrayValue(user.desired_location)}
希望年収: ${window.formatSalaryValue(user.desired_salary)}
スキル: ${window.formatArrayValue(user.skills)}
職歴: ${user.work_history || '-'}
                `;
                alert(info);
            } catch (e) {
                console.error(e);
                alert('情報の取得に失敗しました');
            }
        }

        // ========================
        // Admin: AI Prompts
        // ========================
        async function loadPrompts() {
            // スーパー管理者以外はアクセス不可
            if (!currentUser || currentUser.role !== 'super_admin') {
                alert('権限がありません');
                showPage('dashboard');
                return;
            }
            showLoading();
            try {
                // master_dataからプロンプトを取得 (自組織のもの)
                const { data: prompts, error } = await supabase
                    .from('master_data')
                    .select('*')
                    .eq('type', 'prompt')
                    .eq('organization_id', currentUser.organization_id)
                    .in('value', ['ai_matching_scoring', 'ai_recommendation_reason', 'recommendation_letter', 'scout_message']);

                if (error) throw error;

                const defaultScoring = `
あなたは温かみのある転職支援のプロフェッショナルであり、企業文化と人材のフィット分析の専門家です。
以下の求人と求職者情報から、マッチ度を分析し、**指定されたフォーマットのみ**で回答してください。
分析の詳細プロセス（「1.職務経歴のマッチ度」など）は一切出力せず、結果のみを記述してください。

【求職者情報】
- 基本情報: 年齢 \${userData.age} / 希望年収 \${userData.desired_salary}
- 希望条件: \${userData.desired_industry} / \${userData.desired_job_type} / \${userData.desired_location}
- 未経験OKの希望: 職種[\${userProfile.desired_job_experience_ok ? 'はい' : 'いいえ'}] / 業種[\${userProfile.desired_industry_experience_ok ? 'はい' : 'いいえ'}]
- スキル・PR・備考: \${userData.notes}
- 履歴書/経歴書: \${userData.resume}
- 職務経歴詳細: \${userData.work_history}
- 社内マッチング情報: \${userData.matching_info}
- 社内メモ・共有事項: \${userData.internal_info}
- その他補足: \${userData.other_info}

【求人情報】
- 企業名: \${jobDetails.company}
- 職種: \${jobDetails.title}
- 業種: \${jobDetails.industrycategory}
- 職種カテゴリ: \${jobDetails.jobcategory}
- 給与: \${jobDetails.salary}
- 勤務地: \${jobDetails.location}
- 雇用形態: \${jobDetails.employment_type}
- 業務内容: \${jobDetails.description}
- 必須スキル: \${jobDetails.qualifications}
- 企業文化・特徴: \${jobDetails.company_info}

【重要：企業文化の分析について】
・企業情報の不足や深い分析が必要な場合は、企業名（\${jobDetails.company}）に基づき、Web検索機能を活用して実際のクチコミや経営理念を補完してください。

---
【出力における絶対遵守の制約】
1. 分析の詳細プロセス（「1.職務経歴のマッチ度」などの区分けや説明）は絶対に書き出さないでください。
2. 指定されたラベル（「評価: 」「理由: 」等）以外で始まる文章を出力しないでください。
3. Markdown記号（#、*、**、> 等）は使用禁止です。
4. 各項目の文字数制限を1文字でも超えないでください。
5. 理由とアドバイスは改行せず、それぞれ1文（80文字以内/60文字以内）で記述してください。

回答形式：

評価: [ランクA-Eを1文字]
理由: [80文字以内で簡潔に。改行せず1文で記述]

総合評価: [数値]点

マッチする点
・[要点。30文字以内]
・[要点。30文字以内]

今後のさらなる成長・挑戦が期待される点
・[要点。30文字以内]
・[要点。30文字以内]

アドバイス
[60文字以内。改行せず1文で記述]
`;

                const defaultReason = `
あなたは温かみのあるキャリアアドバイザーです。
以下の求職者に対して、この求人を紹介する理由を300文字程度で作成してください。
求職者のこれまでの経験や強みを尊重し、それらが求人の特徴や企業の魅力とどのように結びつくかを、ポジティブかつ魅力的に伝えてください。

【求職者情報】
- 基本情報: 年齢 \${userData.age} / 希望年収 \${userData.desired_salary}
- 希望条件: \${userData.desired_industry} / \${userData.desired_job_type}
- スキル・PR: \${userData.notes}
- 履歴書/経歴書: \${userData.resume}
- 職務経歴詳細: \${userData.work_history}
- 社内マッチング情報: \${userData.matching_info}

【求人情報】
- 企業名: \${jobDetails.company}
- 職種: \${jobDetails.title}
- 魅力・業務内容: \${jobDetails.description}

構成:
1. 挨拶と紹介の意図
2. 求職者の強みと求人の接点
3. この求人に挑戦するメリット・成長可能性
4. 温かい応援メッセージ
`;

                const defaultRecommendationLetter = `
あなたは人材紹介会社のエージェントです。以下の求職者を企業に推薦するための推薦文を作成してください。
400-600文字程度で、以下の構成で作成してください。

【求職者情報】
- 氏名: \${userData.name}
- 年齢: \${userData.age}
- 現職: \${userData.current_position || 'N/A'}
- スキル・経験: \${userData.notes}
- アピールポイント: \${userData.self_pr || 'N/A'}

【応募先企業・求人】
- 企業名: \${jobDetails.company}
- 職種: \${jobDetails.title}

構成:
1. 冒頭の挨拶
2. 求職者の強みと実績
3. 求人とのマッチング理由
4. 推薦の結び
`;

                const defaultScoutMessage = `
あなたは企業の採用担当者です。以下の求職者に対して、魅力的なスカウトメッセージを作成してください。

【求職者情報】
- 氏名: \${candidateName}
- 現職: \${currentPosition}
- スキル・経験: \${skills}
- 希望条件: \${desiredConditions}

【自社・求人情報】
- 企業名: \${companyName}
- 職種: \${jobTitle}
- 業務内容: \${jobDescription}
- 魅力: \${companyStrengths}
- 待遇: \${benefits}

以下の構成で、300-500文字程度のスカウトメッセージを作成してください：

1. 求職者への敬意と関心の表明
2. 自社・求人の魅力
3. 求職者のスキルとのマッチング
4. 面談・応募への誘導
`;


                let scoringContent = defaultScoring.trim();
                let reasonContent = defaultReason.trim();
                let recommendationLetterContent = defaultRecommendationLetter.trim();
                let scoutMessageContent = defaultScoutMessage.trim();
                let jobDescriptionContent = '';
                let csvMappingContent = '';
                let externalProfileAnalysisContent = '';

                // Helper for decode
                function decodeBase64(str) {
                    if (!str) return '';
                    try { return decodeURIComponent(escape(atob(str))); }
                    catch (e) { return str; }
                }

                // System Prompts Load
                try {
                    const { data: sysPrompts } = await supabase.from('system_prompts').select('*').in('key', ['job_description', 'csv_field_mapping', 'external_profile_analysis_prompt']);
                    if (sysPrompts) {
                        const jp = sysPrompts.find(p => p.key === 'job_description');
                        if (jp) jobDescriptionContent = decodeBase64(jp.content);
                        const cmp = sysPrompts.find(p => p.key === 'csv_field_mapping');
                        if (cmp) csvMappingContent = decodeBase64(cmp.content);
                        const epa = sysPrompts.find(p => p.key === 'external_profile_analysis_prompt');
                        if (epa) externalProfileAnalysisContent = decodeBase64(epa.content);
                    }
                } catch (e) { console.error('System prompts load error', e); }

                if (prompts) {
                    const scoring = prompts.find(p => p.value === 'ai_matching_scoring');
                    const reason = prompts.find(p => p.value === 'ai_recommendation_reason');
                    const letter = prompts.find(p => p.value === 'recommendation_letter');
                    const scout = prompts.find(p => p.value === 'scout_message');

                    if (scoring) scoringContent = decodeBase64(scoring.label);
                    if (reason) reasonContent = decodeBase64(reason.label);
                    if (letter) recommendationLetterContent = decodeBase64(letter.label);
                    if (scout) scoutMessageContent = decodeBase64(scout.label);
                }

                $('#prompt-scoring').val(scoringContent);
                $('#prompt-reason').val(reasonContent);
                $('#prompt-recommendation-letter').val(recommendationLetterContent);
                $('#prompt-scout-message').val(scoutMessageContent);
                $('#prompt-job-description').val(jobDescriptionContent);
                $('#prompt-csv-mapping').val(csvMappingContent);
                $('#prompt-external-profile-analysis').val(externalProfileAnalysisContent);

            } catch (error) {
                console.error('Load prompts error:', error);
                alert('プロンプトの読み込みに失敗しました');
            } finally {
                hideLoading();
            }
        }

        window.savePrompts = async function () {
            if (!currentUser || currentUser.role !== 'super_admin') {
                alert('この操作はスーパー管理者のみ可能です。');
                return;
            }
            if (!confirm('プロンプト設定を保存しますか？')) return;

            showLoading();
            try {
                const scoringContent = $('#prompt-scoring').val();
                const reasonContent = $('#prompt-reason').val();
                const recommendationLetterContent = $('#prompt-recommendation-letter').val();
                const scoutMessageContent = $('#prompt-scout-message').val();
                const jobDescriptionContent = $('#prompt-job-description').val();
                const csvMappingContent = $('#prompt-csv-mapping').val();
                const externalProfileAnalysisContent = $('#prompt-external-profile-analysis').val();

                const updates = [
                    { key: 'ai_matching_scoring', content: scoringContent, sort_order: 10 },
                    { key: 'ai_recommendation_reason', content: reasonContent, sort_order: 20 },
                    { key: 'recommendation_letter', content: recommendationLetterContent, sort_order: 30 },
                    { key: 'scout_message', content: scoutMessageContent, sort_order: 40 }
                ];

                // 0. system_prompts 保存 (Super Admin Only but guard is at top)
                // Encoding Helpers
                function encodeBase64(str) {
                    if (!str) return null;
                    try { return btoa(unescape(encodeURIComponent(str))); }
                    catch (e) { return str; }
                }
                function decodeBase64(str) {
                    if (!str) return '';
                    try { return decodeURIComponent(escape(atob(str))); }
                    catch (e) { return str; }
                }

                // 0. Payload Preparation (Encode for WAF bypass)
                // 1. System Prompts Upsert (Super Admin Only)
                if (jobDescriptionContent) {
                    const { error } = await supabase.from('system_prompts').upsert({ key: 'job_description', content: encodeBase64(jobDescriptionContent) }, { onConflict: 'key' });
                    if (error) console.error('SysPrompt error:', error);
                }
                if (csvMappingContent) {
                    const { error } = await supabase.from('system_prompts').upsert({ key: 'csv_field_mapping', content: encodeBase64(csvMappingContent) }, { onConflict: 'key' });
                    if (error) console.error('SysPrompt error:', error);
                }
                if (externalProfileAnalysisContent) {
                    const { error } = await supabase.from('system_prompts').upsert({ key: 'external_profile_analysis_prompt', content: encodeBase64(externalProfileAnalysisContent) }, { onConflict: 'key' });
                    if (error) console.error('SysPrompt error:', error);
                }

                // 2. Master Data Update
                // Delete existing
                const { error: deleteError } = await supabase
                    .from('master_data')
                    .delete()
                    .eq('type', 'prompt')
                    .eq('organization_id', currentUser.organization_id);

                if (deleteError) throw deleteError;

                // Insert new
                const insertData = updates.map(u => ({
                    type: 'prompt',
                    label: encodeBase64(u.content),
                    value: u.key,
                    sort_order: u.sort_order,
                    is_active: true,
                    organization_id: currentUser.organization_id
                }));

                const { error: insertError } = await supabase
                    .from('master_data')
                    .insert(insertData);

                if (insertError) throw insertError;

                alert('プロンプト設定を保存しました');
            } catch (error) {
                console.error('Save prompts error:', error);
                alert('保存に失敗しました: ' + (error.message || error));
            } finally {
                hideLoading();
            }
        }

        window.filterAdminCandidates = function () {
            const searchText = $('#admin-candidate-search').val().toLowerCase();
            if (!searchText) {
                renderAdminCandidates(adminCandidatesCache);
                return;
            }
            const filtered = adminCandidatesCache.filter(u =>
                (u.name && u.name.toLowerCase().includes(searchText)) ||
                (u.email && u.email.toLowerCase().includes(searchText)) ||
                (u.desired_job_type && u.desired_job_type.toLowerCase().includes(searchText))
            );
            renderAdminCandidates(filtered);
        }

        // ========================
        // Admin: User Management
        // ========================
        let adminUsersCache = [];
        // ========================
        // Admin: User CSV Import
        // ========================
        window.showUserCsvImportModal = function () {
            $('#user-csv-file').val('');
            $('#user-csv-preview').addClass('hidden').empty();
            $('#admin-user-csv-modal').removeClass('hidden');
        }

        // エイリアス: openUserCsvImportModal
        window.openUserCsvImportModal = window.showUserCsvImportModal;

        window.closeUserCsvImportModal = function () {
            $('#admin-user-csv-modal').addClass('hidden');
        }

        window.calculateAge = function (birthDateStr, targetSelector) {
            if (!birthDateStr) return;
            const birthDate = new Date(birthDateStr);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            $(targetSelector).val(age);
        }

        window.downloadUserCsvTemplate = function (e) {
            e.preventDefault();

            if (typeof userFields === 'undefined') {
                alert('テンプレート生成エラー: フィールド定義が見つかりません');
                return;
            }

            const headers = userFields.map(f => {
                const name = f.aliases && f.aliases.length > 0 ? f.aliases[0] : f.label;
                return `"${name}"`;
            });

            // サンプルデータ
            const sample1Values = userFields.map(f => {
                switch (f.key) {
                    case 'name': return '山田 太郎';
                    case 'email': return 'yamada@example.com';
                    case 'role': return 'candidate';
                    case 'birth_date': return '1990-01-01';
                    case 'age': return '34';
                    case 'education': return '早稲田大学 商学部 卒業';
                    case 'desired_job_type': return 'エンジニア';
                    case 'desired_location': return '東京都,神奈川県';
                    case 'desired_salary': return '600';
                    case 'skills': return 'JavaScript・Python';
                    case 'work_history': return '○○株式会社でWebエンジニアとして3年勤務';
                    case 'academic_background': return '○○大学情報学部卒業';
                    case 'languages': return '英語(TOEIC800点)';
                    case 'certifications': return '基本情報技術者';
                    case 'matching_info': return 'マッチング情報サンプル';
                    case 'internal_info': return '社内情報サンプル';
                    case 'other_info': return 'その他情報サンプル';
                    default: return '';
                }
            });
            const sample1 = sample1Values.map(v => `"${v}"`).join(',');

            const sample2Values = userFields.map(f => {
                switch (f.key) {
                    case 'name': return '鈴木 花子';
                    case 'email': return 'suzuki@example.com';
                    case 'role': return 'candidate';
                    case 'birth_date': return '1995-05-15';
                    case 'age': return '29';
                    case 'education': return '慶應義塾大学 法学部 卒業';
                    case 'desired_job_type': return '営業';
                    case 'desired_location': return '大阪府,兵庫県';
                    case 'desired_salary': return '500';
                    case 'skills': return '営業経験5年';
                    case 'work_history': return '△△株式会社で法人営業として5年勤務';
                    case 'academic_background': return '○○大学経済学部卒業';
                    case 'languages': return '英語(日常会話レベル)';
                    case 'certifications': return '普通自動車免許';
                    default: return '';
                }
            });
            const sample2 = sample2Values.map(v => `"${v}"`).join(',');

            const csvContent = headers.join(',') + "\n" + sample1 + "\n" + sample2;
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "user_import_template.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.downloadCandidateCsvTemplate = function (e) {
            e.preventDefault();
            const csvContent = "name,email,password,age,desired_job_type,desired_location,desired_salary,skills,work_history,academic_background,languages,certifications,matching_info,internal_info,other_info\n山田太郎,yamada@example.com,pass123,28,エンジニア,\"東京都,神奈川県\",600,JavaScript・Python,○○株式会社でWebエンジニアとして3年勤務,○○大学情報学部卒業,英語(TOEIC800点),基本情報技術者,マッチング情報サンプル,社内情報サンプル,その他情報サンプル\n鈴木花子,suzuki@example.com,pass456,32,営業,\"大阪府,兵庫県\",500,営業経験5年,△△株式会社で法人営業として5年勤務,○○大学経済学部卒業,英語(日常会話レベル),普通自動車免許,,,";
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' }); // BOM付き
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "candidate_import_template.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.processUserCsvImport = function () {
            const fileInput = document.getElementById('user-csv-file');
            const file = fileInput.files[0];

            if (!file) {
                alert('CSVファイルを選択してください');
                return;
            }

            showLoading('CSVファイルを読み込み中...');

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: async function (results) {
                    hideLoading();

                    const data = results.data;
                    if (data.length === 0) {
                        alert('データが含まれていません');
                        return;
                    }

                    // CSVのヘッダー（カラム名）を取得
                    const csvHeaders = Object.keys(data[0]);

                    // グローバル変数に保存（既存のCSVインポートフローで使用）
                    currentCSVData = data;
                    currentCSVHeaders = csvHeaders;
                    currentImportType = 'candidates'; // 求職者専用

                    // モーダルを閉じる
                    closeUserCsvImportModal();

                    // AIマッピングモーダルを表示（既存の関数を使用）
                    showCSVMappingModal('users'); // 'users' タイプを使用（userFieldsを参照）
                },
                error: function (error) {
                    hideLoading();
                    console.error('CSV parse error:', error);
                    alert('CSVの解析に失敗しました');
                }
            });
        }

        window.exportUsersCsv = function () {
            if (!adminUsersCache || adminUsersCache.length === 0) {
                alert('エクスポートするデータがありません');
                return;
            }

            const csvData = adminUsersCache.map(user => ({
                name: user.name,
                email: user.email,
                role: user.role,
                created_at: new Date(user.created_at).toLocaleString()
            }));

            const csv = Papa.unparse(csvData);
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `users_export_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function loadAdminUsers() {
            if (!currentUser) return
            showLoading()
            try {
                // 全ユーザーを取得（自組織のみ）
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                    .eq('organization_id', currentUser.organization_id)
                    .neq('role', 'candidate')
                    .is('deleted_at', null)
                    .order('created_at', { ascending: false })

                if (error) throw error

                // フラット化（一覧表示でプロフィール情報が必要な場合のため）
                const flattenedUsers = (users || []).map(u => {
                    const profile = Array.isArray(u.candidate_profiles) ? u.candidate_profiles[0] : u.candidate_profiles;
                    return { ...u, ...profile, id: u.id };
                });

                adminUsersCache = flattenedUsers;
                renderAdminUsers(adminUsersCache);
            } catch (error) {
                console.error('Load users error:', error)
                alert('ユーザーの読み込みに失敗しました')
            } finally {
                hideLoading()
            }
        }

        function renderAdminUsers(users) {
            const container = $('#admin-users-container')
            const infoContainer = $('#org-info-display'); // Placeholder for Org Info
            container.empty()

            // Display Organization Code for Org Admins
            if (currentUser && ['org_admin', 'admin'].includes(currentUser.role)) {
                if ($('#org-code-info').length === 0) {
                    // Add Org Code Display Area if not exists
                    const headerSection = $('#admin-users-content h2').parent();
                    // Fetch Org Code async
                    (async () => {
                        const { data, error } = await supabase.from('organizations').select('code').eq('id', currentUser.organization_id).single();
                        if (data && data.code) {
                            headerSection.append(`
                                <div id="org-code-info" class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg inline-block">
                                    <span class="text-sm text-blue-800 font-bold">組織コード: </span>
                                    <span class="text-lg font-mono text-blue-900 mx-2">${data.code}</span>
                                    <span class="text-xs text-gray-500">（このコードを求職者に共有してください）</span>
                                </div>
                             `);
                        }
                    })();
                }
            }

            if (users.length === 0) {
                container.html('<tr><td colspan="4" class="px-6 py-8 text-center text-gray-500">ユーザーがいません</td></tr>')
                return
            }

            const html = users.map(u => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${u.name}</div>
                        <div class="text-sm text-gray-500">${u.email}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getRoleBadgeColor(u.role)}">
                            ${getRoleLabel(u.role)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="mb-1">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${u.status === 'suspended' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                ${u.status === 'suspended' ? '停止中' : '利用中'}
                            </span>
                        </div>
                        <div>
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${u.management_status === 'inactive' ? 'bg-gray-200 text-gray-700' : 'bg-blue-100 text-blue-800'}">
                                ${u.management_status === 'inactive' ? '活動終了' : '活動中'}
                            </span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${new Date(u.created_at).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="viewCandidateProfile('${u.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">
                            詳細
                        </button>
                        <button onclick="deleteUser('${u.id}')" class="text-red-600 hover:text-red-900">
                            削除
                        </button>
                    </td>
                </tr>
            `).join('')

            container.html(html)
        }

        function getRoleLabel(role) {
            const roles = {
                'super_admin': 'スーパー管理者',
                'org_admin': '組織管理者',
                'admin': '管理者',
                'coach': 'CA・RA',
                'ca': 'CA',
                'ra': 'RA',
                'candidate': '求職者'
            };

            // 組織ごとのカスタマイズ名称を確認
            let customLabel = null;
            if (window.currentUser && window.currentUser.organizations && window.currentUser.organizations.settings) {
                const labels = window.currentUser.organizations.settings.role_labels || {};

                // 特定のロールが設定されているか
                if (labels && labels[role]) {
                    customLabel = labels[role];
                }
                // ca, ra の場合は coach の設定を流用する（個別に設定されていなければ）
                else if ((role === 'ca' || role === 'ra') && labels && labels['coach']) {
                    customLabel = labels['coach'];
                }
            }

            return customLabel || roles[role] || role;
        }

        function getRoleBadgeColor(role) {
            const colors = {
                'super_admin': 'bg-purple-100 text-purple-800',
                'org_admin': 'bg-blue-100 text-blue-800',
                'admin': 'bg-indigo-100 text-indigo-800',
                'coach': 'bg-yellow-100 text-yellow-800',
                'candidate': 'bg-green-100 text-green-800'
            };
            return colors[role] || 'bg-gray-100 text-gray-800';
        }

        window.filterAdminUsers = function () {
            const searchText = $('#admin-user-search').val().toLowerCase();
            if (!searchText) {
                renderAdminUsers(adminUsersCache);
                return;
            }
            const filtered = adminUsersCache.filter(u =>
                (u.name && u.name.toLowerCase().includes(searchText)) ||
                (u.email && u.email.toLowerCase().includes(searchText))
            );
            renderAdminUsers(filtered);
        }

        window.editUserRole = async function (userId, currentRole) {
            const newRole = prompt('新しいロールを入力してください (admin, coach, candidate):', currentRole);
            if (newRole && newRole !== currentRole) {
                if (!['admin', 'coach', 'candidate'].includes(newRole)) {
                    alert('無効なロールです');
                    return;
                }
                try {
                    const { error } = await supabase
                        .from('users')
                        .update({ role: newRole })
                        .eq('id', userId);

                    if (error) throw error;
                    alert('権限を更新しました');
                    loadAdminUsers();
                } catch (e) {
                    console.error(e);
                    alert('更新に失敗しました');
                }
            }
        }

        // ========================
        // User Registration
        // ========================
        window.showUserRegistrationModal = async function (type) {
            $('#user-registration-form')[0].reset();
            $('#reg-resume-filename').text('');

            // マスタデータ初期化
            await loadMasterDataForProfile(null);

            // Select2の既存インスタンスを破棄してから再初期化
            $('#reg-job-type, #reg-industry, #reg-employment-type, #reg-prefecture').each(function () {
                if ($(this).hasClass("select2-hidden-accessible")) {
                    $(this).select2('destroy');
                }
            });

            // Select2初期化（複数選択の操作性向上）
            $('#reg-job-type, #reg-industry, #reg-employment-type, #reg-prefecture').select2({
                width: '100%',
                closeOnSelect: false,
                allowClear: true,
                placeholder: '選択してください',
                language: 'ja'
            });

            if (type === 'candidate') {
                $('#user-reg-title').text('新規求職者登録');
                $('#reg-role').val('candidate');
                $('#reg-role-section').addClass('hidden');
                $('#reg-candidate-fields').removeClass('hidden');
            } else {
                $('#user-reg-title').text('新規ユーザー登録');
                $('#reg-role').val('');

                // 権限ラベルの更新
                const $regRoleSelect = $('#reg-role-select');
                $regRoleSelect.empty();
                $regRoleSelect.append(`<option value="admin">${getRoleLabel('admin')}</option>`);
                $regRoleSelect.append(`<option value="coach">${getRoleLabel('coach')}</option>`);
                $regRoleSelect.append(`<option value="org_admin">${getRoleLabel('org_admin')}</option>`);

                $('#reg-role-section').removeClass('hidden');
                $('#reg-candidate-fields').addClass('hidden');
            }

            $('#user-registration-modal').removeClass('hidden');
        }

        window.closeUserRegistrationModal = function () {
            $('#user-registration-modal').addClass('hidden');
        }

        // 登録用職歴リスト操作関数
        window.addRegWorkHistoryItem = function (data = {}) {
            const count = $('#reg-work-history-list').children().length;
            if (count >= 10) return;
            const index = count + 1;
            const $item = $(`
                <div class="reg-work-history-item bg-gray-50 p-4 rounded-lg border border-gray-200 relative mb-2">
                    <button type="button" onclick="$(this).closest('.reg-work-history-item').remove(); updateRegJobChangeCount();" 
                        class="absolute top-2 right-2 text-gray-400 hover:text-red-500 w-6 h-6 flex items-center justify-center rounded-full hover:bg-gray-200 transition">
                        <i class="fas fa-times"></i>
                    </button>
                    <h5 class="text-sm font-bold text-indigo-700 mb-2">職歴 ${index}</h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">会社名</label>
                            <input type="text" class="wh-company w-full px-3 py-2 border rounded text-sm bg-white" placeholder="会社名">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">在籍期間</label>
                            <input type="text" class="wh-period w-full px-3 py-2 border rounded text-sm bg-white" placeholder="例: 2020/04 - 2023/03">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="block text-xs text-gray-500 mb-1">役割・役職</label>
                        <input type="text" class="wh-role w-full px-3 py-2 border rounded text-sm bg-white" placeholder="役割・役職">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">職務内容</label>
                        <textarea class="wh-description w-full px-3 py-2 border rounded text-sm bg-white" rows="3" placeholder="職務内容"></textarea>
                    </div>
                </div>
            `);

            $item.find('.wh-company').val(data.company_name || '');
            $item.find('.wh-period').val(data.period || '');
            $item.find('.wh-role').val(data.role || '');
            $item.find('.wh-description').val(data.description || '');

            $('#reg-work-history-list').append($item);
            updateRegJobChangeCount();
        };

        window.updateRegJobChangeCount = function () {
            const count = $('#reg-work-history-list').children().length;
            $('#reg-job-change-count').val(count);
            $('#reg-work-history-list .reg-work-history-item').each(function (i) {
                $(this).find('h5').text(`職歴 ${i + 1}`);
            });
        };

        window.handleRegResumeUpload = async function (input) {
            if (input.files.length === 0) return;

            const fileNames = Array.from(input.files).map(f => f.name).join(', ');
            $('#reg-resume-filename').text(fileNames);

            showLoading();
            try {
                let combinedText = '';
                for (let i = 0; i < input.files.length; i++) {
                    const text = await extractTextFromPDF(input.files[i]);
                    combinedText += `--- File ${i + 1} ---\n${text}\n`;
                }

                let result = await analyzeDocumentWithAI(combinedText, 'resume');

                // 配列で返ってきた場合は最初の要素を使う
                if (Array.isArray(result)) {
                    result = result[0] || {};
                }

                // フォームに反映
                // 名前・ふりがな
                if (result.name) $('#reg-name').val(result.name);
                if (result.furigana || result.kana) $('#reg-furigana').val(result.furigana || result.kana);

                if (result.desired_job_type) $('#reg-job-type').val(result.desired_job_type);
                if (result.desired_location) $('#reg-location').val(result.desired_location);
                if (result.desired_employment_type) $('#reg-employment-type').val(result.desired_employment_type);
                if (result.desired_salary) $('#reg-salary').val(Math.floor(result.desired_salary / 10000));
                if (result.skills) $('#reg-skills').val(result.skills);
                if (result.work_history) $('#reg-history').val(result.work_history);
                if (result.work_history_detail) $('#reg-work-history-detail').val(result.work_history_detail);
                if (result.resume) $('#reg-resume-detail').val(result.resume); // resumeは詳細テキスト扱い

                // 構造化された職歴
                if (result.work_history_structured && Array.isArray(result.work_history_structured)) {
                    $('#reg-work-history-list').empty();
                    result.work_history_structured.forEach(item => addRegWorkHistoryItem(item));
                    updateRegJobChangeCount();
                }

                alert('解析が完了し、フォームに入力しました。\n内容を確認して登録してください。');
            } catch (error) {
                console.error('Resume analysis error:', error);
                alert('解析に失敗しました: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        window.handleUserRegistration = async function (event) {
            event.preventDefault();

            let email = $('#reg-email').val().trim();
            let password = $('#reg-password').val();
            const name = $('#reg-name').val().trim();
            const furigana = $('#reg-furigana').val().trim();

            let role = $('#reg-role').val();
            if (!role) {
                // hidden値がない場合はプルダウンの値を使用（管理者・コーチ登録時）
                role = $('#reg-role-select').val();
            }

            if (!role) {
                // ロール選択がない場合は管理者登録画面からの呼び出しとみなす（通常はありえないが念のため）
                // しかし showUserRegistrationModal('candidate') では hidden にして 'candidate' をセットしている
                // ここではフォームの値を確認
                if ($('#reg-candidate-fields').is(':visible') || $('#user-reg-title').text().includes('求職者')) {
                    role = 'candidate';
                } else {
                    // デフォルトは admin にする（user はDB制約違反になるため）
                    role = 'admin';
                }
            }

            // 求職者の場合、メアド・パスワード未入力なら自動生成
            if (role === 'candidate') {
                if (!email) {
                    const uuid = crypto.randomUUID();
                    email = `candidate-${Date.now()}-${uuid.substring(0, 8)}@placeholder.local`;
                }

                if (!password) {
                    password = crypto.randomUUID();
                }
            }

            if ((role !== 'candidate' && (!email || !password)) || !name) {
                alert('必須項目を入力してください');
                return;
            }

            showLoading();
            try {
                // プロフィールデータの構築（求職者の場合）
                const profileData = {};
                if (role === 'candidate') {
                    const jobType = $('#reg-job-type').val();
                    profileData.desired_job_type = jobType ? jobType.join(',') : null;

                    const industry = $('#reg-industry').val();
                    profileData.desired_industry = industry ? industry.join(',') : null;

                    const prefs = $('#reg-prefecture').val(); // 配列または文字列
                    const city = $('#reg-city').val() || '';
                    let location = '';

                    if (Array.isArray(prefs) && prefs.length > 0) {
                        location = prefs.join(',');
                        if (city) {
                            // 複数選択時はスペース区切り、単一の場合は結合（従来互換）
                            if (prefs.length > 1) {
                                location += ' ' + city;
                            } else {
                                location = prefs[0] + city;
                            }
                        }
                    } else if (prefs) {
                        // 文字列の場合（単一選択設定などの場合）
                        location = prefs + city;
                    } else if (city) {
                        location = city;
                    }
                    profileData.desired_location = location || null;

                    const empType = $('#reg-employment-type').val();
                    profileData.desired_employment_type = empType ? empType.join(',') : null;
                    const salary = $('#reg-salary').val();
                    profileData.desired_salary = salary ? parseInt(salary) * 10000 : null;
                    profileData.skills = $('#reg-skills').val() || null;
                    profileData.work_history = $('#reg-history').val() || null;
                    profileData.work_history_detail = $('#reg-work-history-detail').val() || null;
                    profileData.resume = $('#reg-resume-detail').val() || null;

                    // 構造化データ収集
                    const workHistoryList = [];
                    $('#reg-work-history-list .reg-work-history-item').each(function () {
                        workHistoryList.push({
                            company_name: $(this).find('.wh-company').val(),
                            period: $(this).find('.wh-period').val(),
                            role: $(this).find('.wh-role').val(),
                            description: $(this).find('.wh-description').val()
                        });
                    });
                    profileData.work_history_structured = workHistoryList;
                    profileData.job_change_count = workHistoryList.length;
                }

                const requestBody = {
                    email,
                    password,
                    name,
                    furigana,
                    role,
                    organizationId: currentUser.organization_id,
                    profileData
                };



                console.log('Sending user registration request:', requestBody);

                // Edge Function呼び出し
                const { data, error } = await supabase.functions.invoke('create-user', {
                    body: requestBody
                });

                console.log('Edge Function response:', { data, error });

                if (error) {
                    // エラーの詳細を取得
                    console.error('Edge Function error details:', error);

                    // FunctionsHttpErrorの場合、レスポンスボディを確認
                    if (error.context) {
                        console.error('Error context:', error.context);
                    }

                    throw error;
                }

                // dataにエラー情報が含まれている場合もチェック
                if (data && data.error) {
                    console.error('Edge Function returned error:', data);
                    throw new Error(data.error + (data.details ? '\n詳細: ' + data.details : ''));
                }

                // 招待メール送信
                if (email) {
                    const orgName = currentUser.organizations ? currentUser.organizations.name : 'RightJob';
                    const loginUrl = window.location.origin;

                    // 非同期でメール送信（エラーでもフローは止めない）
                    sendEmail('invitation', email, {
                        organizationName: orgName,
                        invitationUrl: loginUrl
                    }).catch(e => console.error('Failed to send invitation email:', e));
                }

                alert('ユーザーを登録しました');
                closeUserRegistrationModal();

                // リストを再読み込み
                if (role === 'candidate') {
                    loadAdminCandidates();
                } else {
                    loadAdminUsers();
                }

            } catch (error) {
                console.error('User registration error:', error);

                // より詳細なエラーメッセージを表示
                let errorMessage = '登録に失敗しました\n\n';

                if (error.message) {
                    errorMessage += 'エラー: ' + error.message + '\n';
                }

                // error.contextがResponseオブジェクトの場合の処理
                if (error.context) {
                    try {
                        // Responseオブジェクトの場合
                        if (error.context instanceof Response) {
                            const responseText = await error.context.text();
                            console.log('Response text:', responseText);

                            try {
                                const errorBody = JSON.parse(responseText);
                                if (errorBody.error) {
                                    errorMessage += '\n詳細: ' + errorBody.error;
                                }
                                if (errorBody.details) {
                                    errorMessage += '\n' + errorBody.details;
                                }
                            } catch (parseError) {
                                // JSONパースに失敗した場合、テキストをそのまま表示
                                errorMessage += '\n詳細: ' + responseText;
                            }
                        }
                        // bodyプロパティがある場合
                        else if (error.context.body) {
                            const errorBody = typeof error.context.body === 'string'
                                ? JSON.parse(error.context.body)
                                : error.context.body;

                            if (errorBody.error) {
                                errorMessage += '\n詳細: ' + errorBody.error;
                            }
                            if (errorBody.details) {
                                errorMessage += '\n' + errorBody.details;
                            }
                        }
                    } catch (e) {
                        console.error('Failed to parse error context:', e);
                    }
                }

                // エラーメッセージの日本語化（ユーザーフレンドリーなメッセージへ置換）
                if (errorMessage.includes('already been registered') || errorMessage.includes('User already registered')) {
                    errorMessage = '登録に失敗しました\n\nこのメールアドレスは既に登録されています。\n別のメールアドレスを使用するか、管理者に確認してください。';
                } else if (errorMessage.includes('Password should be at least')) {
                    errorMessage = '登録に失敗しました\n\nパスワードは6文字以上で設定してください。';
                }

                alert(errorMessage);
            } finally {
                hideLoading();
            }
        }

        // Admin: Applicant Management
        // ========================
        let adminApplicantsCache = [];

        async function loadAdminApplicants() {
            if (!currentUser) return

            showLoading()
            try {
                const { data: applications, error } = await supabase
                    .from('applications')
                    .select('*, jobs(*), users!applications_user_id_fkey(*)')
                    .eq('organization_id', currentUser.organization_id)
                    .order('updated_at', { ascending: false })

                if (error) throw error

                adminApplicantsCache = applications || [];
                renderAdminApplicants(adminApplicantsCache);
            } catch (error) {
                console.error('Load admin applicants error:', error)
                $('#admin-applicants-container').html('<p class="text-red-500">応募者の読み込みに失敗しました</p>')
            } finally {
                hideLoading()
            }
        }

        window.filterAdminApplicants = function () {
            const searchText = $('#admin-applicant-search').val().toLowerCase();
            if (!searchText) {
                renderAdminApplicants(adminApplicantsCache);
                return;
            }

            const filtered = adminApplicantsCache.filter(app =>
                (app.users && app.users.name && app.users.name.toLowerCase().includes(searchText)) ||
                (app.jobs && app.jobs.title && app.jobs.title.toLowerCase().includes(searchText))
            );
            renderAdminApplicants(filtered);
        }

        function renderAdminApplicants(applications) {
            const container = $('#admin-applicants-container')
            container.empty()

            if (applications.length === 0) {
                container.html('<p class="text-gray-500 text-center py-8">応募者がいません</p>')
                return
            }

            const statusOptions = ['pending', 'screening', 'interview', 'offered', 'rejected', 'withdrawn']
            const statusLabels = {
                'pending': '書類選考中',
                'screening': '書類選考中',
                'interview': '面接予定',
                'offered': '内定',
                'rejected': '不合格',
                'withdrawn': '辞退'
            }

            const html = applications.map(app => {
                // nullチェック
                const userName = app.users?.name || '不明なユーザー';
                const jobTitle = app.jobs?.title || '不明な求人';
                const updatedDate = app.updated_at ? new Date(app.updated_at).toLocaleDateString('ja-JP') : '-';

                return `
                <div class="bg-white border border-gray-200 rounded-lg p-6 mb-4">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-gray-900 mb-1">${userName}</h3>
                            <p class="text-gray-600 text-sm mb-2">${jobTitle}</p>
                            <p class="text-gray-500 text-xs">応募日: ${updatedDate}</p>
                        </div>
                        <div class="flex flex-col gap-2 items-end">
                            <select onchange="updateApplicationStatus('${app.id}', this.value)" class="px-3 py-1 border rounded text-sm mb-2">
                                ${statusOptions.map(s => `
                                    <option value="${s}" ${app.status === s ? 'selected' : ''}>${statusLabels[s]}</option>
                                `).join('')}
                            </select>
                            <button onclick="openRecommendationModal('${app.id}')" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium flex items-center">
                                <i class="fas fa-file-alt mr-1"></i>推薦文作成
                            </button>
                        </div>
                    </div>
                </div>
            `;
            }).join('')

            container.html(html)
        }

        window.updateApplicationStatus = async function (applicationId, newStatus) {
            showLoading()
            try {
                const { error } = await supabase
                    .from('applications')
                    .update({ status: newStatus })
                    .eq('id', applicationId)

                if (error) throw error

                // ログ記録
                await logAction('update', 'application', applicationId, { status: newStatus })

                alert('ステータスを更新しました')
            } catch (error) {
                console.error('Update status error:', error)
                alert('更新に失敗しました: ' + error.message)
                loadAdminApplicants() // Reload to revert
            } finally {
                hideLoading()
            }
        }

        // ========================
        // Admin: Company Management
        // ========================
        let companiesCache = []; // キャッシュして検索に使用
        async function loadCompanies() {
            if (!currentUser) return
            showLoading()
            try {
                const { data: companies, error } = await supabase
                    .from('companies')
                    .select('*')
                    .eq('organization_id', currentUser.organization_id)
                    .is('deleted_at', null)
                    .order('name', { ascending: true })

                if (error) throw error

                companiesCache = companies || [];
                renderCompanies(companiesCache);
            } catch (error) {
                console.error('Load companies error:', error)
                alert('企業の読み込みに失敗しました')
            } finally {
                hideLoading()
            }
        }

        function renderCompanies(companies) {
            const container = $('#companies-container')
            container.empty()

            if (companies.length === 0) {
                container.html('<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">登録されている企業はありません</td></tr>')
                return
            }

            const html = companies.map(c => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${c.name}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-600">${c.industry || '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-600">${c.location || '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${c.website ? `<a href="${c.website}" target="_blank" class="text-indigo-600 hover:underline text-sm"><i class="fas fa-external-link-alt mr-1"></i>リンク</a>` : '<span class="text-sm text-gray-400">-</span>'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick='editCompany(${JSON.stringify(c)})' class="text-indigo-600 hover:text-indigo-900 mr-3">
                            <i class="fas fa-edit"></i> 編集
                        </button>
                        <button onclick="deleteCompany('${c.id}')" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash"></i> 削除
                        </button>
                    </td>
                </tr>
            `).join('')

            container.html(html)
        }

        window.filterCompanies = function () {
            const searchText = $('#company-search').val().toLowerCase();
            if (!searchText) {
                renderCompanies(companiesCache);
                return;
            }

            const filtered = companiesCache.filter(c =>
                (c.name && c.name.toLowerCase().includes(searchText)) ||
                (c.industry && c.industry.toLowerCase().includes(searchText)) ||
                (c.location && c.location.toLowerCase().includes(searchText))
            );
            renderCompanies(filtered);
        }

        window.showCompanyForm = function () {
            $('#company-modal-title').text('企業登録')
            $('#company-form')[0].reset()
            $('#company-id').val('')
            populateSelectOptions('company-industry', masterIndustries); // マスタ初期化
            $('#company-modal').removeClass('hidden')
        }

        window.closeCompanyModal = function () {
            $('#company-modal').addClass('hidden')
        }

        window.editCompany = function (company) {
            $('#company-modal-title').text('企業編集')
            $('#company-id').val(company.id)
            $('#company-name').val(company.name)
            // $('#company-industry').val(company.industry) // populateSelectOptionsで設定
            populateSelectOptions('company-industry', masterIndustries, company.industry);
            $('#company-location').val(company.location)
            $('#company-website').val(company.website)
            $('#company-description').val(company.description)
            $('#company-modal').removeClass('hidden')
        }

        window.handleCompanySubmit = async function (e) {
            e.preventDefault()
            showLoading()
            try {
                const id = $('#company-id').val()
                const companyData = {
                    organization_id: currentUser.organization_id,
                    name: $('#company-name').val(),
                    industry: $('#company-industry').val(),
                    location: $('#company-location').val(),
                    website: $('#company-website').val(),
                    description: $('#company-description').val()
                }

                let error
                if (id) {
                    ({ error } = await supabase.from('companies').update(companyData).eq('id', id))
                } else {
                    ({ error } = await supabase.from('companies').insert(companyData))
                }

                if (error) throw error

                closeCompanyModal()
                loadCompanies()
                // 求人フォームの企業選択肢も更新が必要ならここで行うが、
                // 求人フォームを開くたびにロードするので基本的には不要
                alert('保存しました')
            } catch (error) {
                console.error('Save company error:', error)
                alert('保存に失敗しました: ' + error.message)
            } finally {
                hideLoading()
            }
        }

        window.deleteCompany = async function (id) {
            if (!confirm('本当に削除しますか？\n（論理削除され、一覧から非表示になります）')) return

            showLoading()
            try {
                const { error } = await supabase
                    .from('companies')
                    .update({ deleted_at: new Date().toISOString() })
                    .eq('id', id)
                if (error) throw error

                alert('削除しました')
                loadCompanies()
            } catch (error) {
                console.error('Delete company error:', error)
                alert('削除に失敗しました: ' + error.message)
            } finally {
                hideLoading()
            }
        }

        // ========================
        // Admin: CSV Import
        // ========================


        // ========================
        // CSV Import Logic
        // ========================

        // システムフィールド定義
        const jobFields = [
            { key: 'title', label: '求人タイトル', required: true, aliases: ['タイトル', '求人名', '職種名'] },
            { key: 'company', label: '企業名', required: true, aliases: ['会社名', '企業'] },
            { key: 'job_category', label: '職種カテゴリー', aliases: ['職種', 'カテゴリー'] },
            { key: 'employment_type', label: '雇用形態', aliases: ['雇用タイプ', '勤務形態'] },
            { key: 'location', label: '勤務地', aliases: ['場所', '住所', '勤務場所'] },
            { key: 'salary_min', label: '最低年収(万円)', aliases: ['年収下限', '最低給与'] },
            { key: 'salary_max', label: '最高年収(万円)', aliases: ['年収上限', '最高給与'] },
            { key: 'description', label: '職務内容', aliases: ['仕事内容', '詳細'] },
            { key: 'requirements', label: '必須要件', aliases: ['応募資格', '必須スキル'] },
            { key: 'welcome_requirements', label: '歓迎要件', aliases: ['歓迎スキル', '尚可'] },
            { key: 'benefits', label: '福利厚生', aliases: ['待遇', '福利'] },
            { key: 'is_remote', label: 'リモート可否', aliases: ['リモート', '在宅'] },
            { key: 'experience_level', label: '経験レベル', aliases: ['経験年数', 'レベル'] },
            { key: 'industry', label: '業界', aliases: ['業種', '産業'] },
            { key: 'url', label: '求人URL', aliases: ['URL', 'リンク', 'サイト', 'ページ'] },
            { key: 'job_experience_ok', label: '職種未経験OK', aliases: ['職種未経験', '未経験可', '職種未経験歓迎'] },
            { key: 'industry_experience_ok', label: '業種未経験OK', aliases: ['業界未経験', '業種未経験', '業界未経験歓迎'] },
            { key: 'work_hours', label: '勤務時間', aliases: ['就業時間', '拘束時間'] },
            { key: 'holidays', label: '休日休暇', aliases: ['休日', '休暇'] },
            { key: 'interview_process', label: '選考プロセス', aliases: ['選考の流れ', '採用フロー'] }
        ];

        const companyFields = [
            { key: 'name', label: '企業名', required: true, aliases: ['会社名', '企業', 'Name'] },
            { key: 'industry', label: '業界', aliases: ['業種', '産業', 'Industry'] },
            { key: 'location', label: '所在地', aliases: ['場所', '住所', '本部所在地', 'Location'] },
            { key: 'website', label: 'Webサイト', aliases: ['URL', 'ウェブサイト', 'HP', 'Website'] },
            { key: 'description', label: '企業説明', aliases: ['会社概要', '詳細', 'Description'] }
        ];

        const userFields = [
            // 基本情報
            { key: 'name', label: '氏名', required: true, aliases: ['名前', 'ユーザー名', '氏名'] },
            { key: 'email', label: 'メールアドレス', required: true, aliases: ['メール', 'Email', 'E-mail'] },
            { key: 'password', label: 'パスワード', required: false, aliases: ['パスワード', 'Password', 'pass'] },
            { key: 'role', label: '権限(candidate/coach/...)', aliases: ['ロール', '役割'] },
            { key: 'birth_date', label: '生年月日', aliases: ['誕生日', '生れ'] },
            { key: 'age', label: '年齢', aliases: ['歳', '年齢'] },
            { key: 'education', label: '学歴', aliases: ['学校', '大学', '学部', '学歴'] },

            // 希望条件
            { key: 'desired_job_type', label: '希望職種', aliases: ['希望職種名', '職種'] },
            { key: 'desired_location', label: '希望勤務地', aliases: ['希望場所', '勤務地'] },
            { key: 'desired_salary', label: '希望年収(万円)', aliases: ['希望給与', '年収'] },

            // スキル・経歴
            { key: 'skills', label: 'スキル', aliases: ['技術', '技能', '保有スキル'] },
            { key: 'work_history', label: '職歴・自己PR', aliases: ['経歴', '自己紹介', '職務経歴'] },
            { key: 'academic_background', label: '学歴', aliases: ['最終学歴', '学校', '出身校'] },
            { key: 'certifications', label: '資格', aliases: ['免許', '保有資格'] },
            { key: 'languages', label: '言語スキル', aliases: ['語学', '語学力'] },

            // 管理用情報（本人非表示）
            { key: 'matching_info', label: 'マッチング情報', aliases: ['マッチングメモ', 'マッチング'] },
            { key: 'internal_info', label: '社内情報', aliases: ['社内メモ', '内部情報'] },
            { key: 'other_info', label: 'その他情報', aliases: ['その他', '備考2'] }
        ];

        let currentCSVData = [];
        let currentImportType = ''; // 'jobs' or 'users'
        let currentCSVHeaders = [];

        // CSVパース関数（既存のものを強化）
        function parseCSV(text) {
            const lines = text.split(/\r\n|\n/).filter(line => line.trim() !== '');
            if (lines.length < 2) return [];

            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));

            const data = [];
            for (let i = 1; i < lines.length; i++) {
                // 簡易的なCSVパース（カンマ区切り、引用符対応は完全ではない）
                // 本格的なライブラリ（PapaParseなど）の使用が推奨されるが、ここでは簡易実装
                const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
                if (values.length === headers.length) {
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = values[index];
                    });
                    data.push(obj);
                }
            }
            return { headers, data };
        }

        window.importJobsCSV = function () {
            handleCSVUpload('jobs');
        }

        window.importUsersCSV = function () {
            handleCSVUpload('users');
        }

        window.showCompanyCsvImportModal = function () {
            $('#admin-company-csv-modal').removeClass('hidden');
        }

        window.closeCompanyCsvImportModal = function () {
            $('#admin-company-csv-modal').addClass('hidden');
        }

        window.processCompanyCsvImport = function () {
            const fileInput = document.getElementById('company-csv-file');
            const file = fileInput.files[0];

            if (!file) {
                alert('CSVファイルを選択してください');
                return;
            }

            processCSVFile(file, 'companies');

            if (typeof closeCompanyCsvImportModal === 'function') {
                closeCompanyCsvImportModal();
            }
        }

        window.downloadCompanyCsvTemplate = function (event) {
            if (event) event.preventDefault();
            const headers = companyFields.map(f => f.label);
            const csvContent = headers.join(',') + "\n" +
                '"株式会社サンプル","IT・通信","東京都渋谷区","https://example.com","テック系スタートアップです。"';
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "company_import_template.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.toggleUpsertKey = function () {
            const isChecked = $('#csv-upsert-mode').is(':checked');
            if (isChecked) {
                $('#csv-upsert-key-container').removeClass('hidden');
                updateUpsertKeyOptions();
            } else {
                $('#csv-upsert-key-container').addClass('hidden');
            }
        }

        function updateUpsertKeyOptions() {
            const select = $('#csv-upsert-key');
            const currentValue = select.val();
            select.empty();

            const fields = currentImportType === 'jobs' ? jobFields :
                currentImportType === 'companies' ? companyFields : userFields;

            let hasOption = false;
            fields.forEach(f => {
                // マッピングされている項目のみ選択肢にする
                const mapping = $(`.mapping-select[data-key="${f.key}"]`).val();
                if (mapping) {
                    const selected = f.key === currentValue ? 'selected' : '';
                    select.append(`<option value="${f.key}" ${selected}>${f.label} (${f.key})</option>`);
                    hasOption = true;
                }
            });

            if (!hasOption) {
                select.append('<option value="">-- マッピングしてください --</option>');
            }
        }

        function handleCSVUpload(type) {
            const fileInput = type === 'jobs' ? $('#csv-jobs-file')[0] : $('#csv-users-file')[0]; // ユーザー用inputが必要なら追加
            // ユーザー用のinputがない場合は一時的に作成してクリック
            if (type === 'users' && !$('#csv-users-file').length) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.csv';
                input.onchange = e => processCSVFile(e.target.files[0], type);
                input.click();
                return;
            }

            if (!fileInput.files.length) {
                alert('ファイルを選択してください');
                return;
            }
            processCSVFile(fileInput.files[0], type);
        }

        function processCSVFile(file, type) {
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true, // 空行をスキップ
                complete: function (results) {
                    console.log('Parsed results:', results);

                    const data = results.data;
                    const headers = results.meta.fields;

                    if (!data || data.length === 0) {
                        alert('有効なデータが見つかりませんでした');
                        return;
                    }

                    currentCSVData = data;
                    currentCSVHeaders = headers;
                    currentImportType = type;

                    showCSVMappingModal(type);
                },
                error: function (error) {
                    console.error('CSV parse error:', error);
                    alert('CSVの解析に失敗しました: ' + error.message);
                }
            });
        }

        function showCSVMappingModal(type) {
            const fields = type === 'jobs' ? jobFields :
                type === 'companies' ? companyFields : userFields;
            const tbody = $('#csv-mapping-tbody');
            tbody.empty();

            // アップサート設定の初期化
            $('#csv-upsert-mode').prop('checked', false);
            $('#csv-upsert-key-container').addClass('hidden');

            // 保存済み設定のプルダウンを更新
            // candidatesタイプの場合は、usersの設定を読み込む
            const mappingType = (currentImportType === 'candidates') ? 'users' : type;
            updateSavedMappingSelect(mappingType);
            $('#new-mapping-name').val(''); // 入力欄クリア

            fields.forEach(field => {
                // 自動マッピングロジック
                let selectedHeader = '';
                // 完全一致またはエイリアス一致を探す
                const match = currentCSVHeaders.find(h =>
                    h === field.key ||
                    h === field.label ||
                    (field.aliases && field.aliases.some(alias => h.includes(alias)))
                );
                if (match) selectedHeader = match;

                const options = currentCSVHeaders.map(h =>
                    `<option value="${h}" ${h === selectedHeader ? 'selected' : ''}>${h}</option>`
                ).join('');

                const previewValue = currentCSVData.length > 0 && selectedHeader ? currentCSVData[0][selectedHeader] : '-';

                const row = `
                    <tr>
                        <td class="px-6 py-4 text-sm font-medium text-gray-900 border-b">
                            ${field.label} ${field.required ? '<span class="text-red-500">*</span>' : ''}
                            <div class="text-xs text-gray-500">${field.key}</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500 border-b">
                            <select class="mapping-select w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" data-key="${field.key}">
                                <option value="">(インポートしない)</option>
                                ${options}
                            </select>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500 mapping-preview border-b break-all" data-key="${field.key}">
                            <div class="max-h-24 overflow-y-auto w-full">
                                ${previewValue}
                            </div>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });

            // セレクトボックス変更時にプレビュー更新とアップサートキー選択肢更新
            $('.mapping-select').on('change', function () {
                const key = $(this).data('key');
                const header = $(this).val();
                const previewCell = $(`.mapping-preview[data-key="${key}"]`);
                const val = currentCSVData.length > 0 && header ? currentCSVData[0][header] : '-';
                previewCell.text(val);

                // アップサートキーの選択肢を更新
                if ($('#csv-upsert-mode').is(':checked')) {
                    updateUpsertKeyOptions();
                }
            });

            $('#csv-mapping-modal').removeClass('hidden');
        }

        // ========================
        // Mapping Settings Logic
        // ========================
        const MAPPING_STORAGE_KEY = 'csv_mapping_settings';

        function getSavedMappings(type) {
            try {
                const saved = localStorage.getItem(MAPPING_STORAGE_KEY);
                if (!saved) return [];
                const settings = JSON.parse(saved);
                // 現在の組織とタイプでフィルタリング
                return settings.filter(s => s.type === type && s.organization_id === currentUser.organization_id);
            } catch (e) {
                console.error('Failed to load mappings', e);
                return [];
            }
        }

        function updateSavedMappingSelect(type) {
            const mappings = getSavedMappings(type);
            const select = $('#saved-mapping-select');
            select.empty();
            select.append('<option value="">-- 設定を選択 --</option>');
            mappings.forEach(m => {
                select.append(`<option value="${m.name}">${m.name}</option>`);
            });
        }

        window.applySavedMapping = function (name) {
            if (!name) return;

            // candidatesタイプの場合は、usersの設定も読み込む
            let importType = currentImportType;
            if (importType === 'candidates') {
                importType = 'users';
            }

            const mappings = getSavedMappings(importType);
            const target = mappings.find(m => m.name === name);
            if (!target) return;

            // マッピング適用
            for (const [key, header] of Object.entries(target.mapping)) {
                const select = $(`.mapping-select[data-key="${key}"]`);
                if (select.length) {
                    // CSVヘッダーにその値が存在するか確認
                    // 存在しない場合は、警告を出さずに空にするか、そのままにするか。
                    // ここでは、ヘッダーが存在する場合のみ適用する
                    if (currentCSVHeaders.includes(header)) {
                        select.val(header).trigger('change');
                    }
                }
            }
        }

        window.saveCurrentMapping = function () {
            const name = $('#new-mapping-name').val().trim();
            if (!name) {
                alert('設定名を入力してください');
                return;
            }

            const mapping = {};
            let hasMapping = false;
            $('.mapping-select').each(function () {
                const key = $(this).data('key');
                const val = $(this).val();
                if (val) {
                    mapping[key] = val;
                    hasMapping = true;
                }
            });

            if (!hasMapping) {
                alert('保存するマッピング設定がありません（少なくとも1つはマッピングしてください）');
                return;
            }

            try {
                const saved = localStorage.getItem(MAPPING_STORAGE_KEY);
                let settings = saved ? JSON.parse(saved) : [];

                // candidatesタイプの場合は、usersとして保存
                const saveType = (currentImportType === 'candidates') ? 'users' : currentImportType;

                // 既存チェック
                const idx = settings.findIndex(s => s.name === name && s.type === saveType && s.organization_id === currentUser.organization_id);

                const newSetting = {
                    name,
                    type: saveType,
                    organization_id: currentUser.organization_id,
                    mapping,
                    updated_at: new Date().toISOString()
                };

                if (idx >= 0) {
                    if (!confirm(`設定「${name}」は既に存在します。上書きしますか？`)) return;
                    settings[idx] = newSetting;
                } else {
                    settings.push(newSetting);
                }

                localStorage.setItem(MAPPING_STORAGE_KEY, JSON.stringify(settings));
                alert('設定を保存しました');

                // 保存済み設定のプルダウンを更新
                const mappingType = (currentImportType === 'candidates') ? 'users' : currentImportType;
                updateSavedMappingSelect(mappingType);
                $('#saved-mapping-select').val(name);

            } catch (e) {
                console.error('Save error', e);
                alert('設定の保存に失敗しました');
            }
        }

        window.deleteSavedMapping = function () {
            const name = $('#saved-mapping-select').val();
            if (!name) {
                alert('削除する設定を選択してください');
                return;
            }

            if (!confirm(`設定「${name}」を削除してもよろしいですか？`)) return;

            try {
                const saved = localStorage.getItem(MAPPING_STORAGE_KEY);
                if (!saved) return;

                let settings = JSON.parse(saved);
                settings = settings.filter(s => !(s.name === name && s.type === currentImportType && s.organization_id === currentUser.organization_id));

                localStorage.setItem(MAPPING_STORAGE_KEY, JSON.stringify(settings));
                alert('設定を削除しました');
                updateSavedMappingSelect(currentImportType);
                $('#new-mapping-name').val('');

            } catch (e) {
                console.error('Delete error', e);
                alert('設定の削除に失敗しました');
            }
        }

        window.closeCSVMappingModal = function () {
            $('#csv-mapping-modal').addClass('hidden');
            currentCSVData = [];
            currentCSVHeaders = [];
        }

        window.autoMapWithAI = async function () {
            if (!currentCSVHeaders || currentCSVHeaders.length === 0) {
                alert('解析対象のCSVヘッダーがありません');
                return;
            }

            const fields = currentImportType === 'jobs' ? jobFields : userFields;

            // AIに送る情報
            // 補足情報として既存のエイリアスも渡すことで精度向上を図る
            const inputData = {
                csv_headers: currentCSVHeaders,
                system_fields: fields.map(f => ({
                    key: f.key,
                    label: f.label,
                    description: f.aliases ? f.aliases.join(', ') : ''
                }))
            };

            const btn = $(event.currentTarget);
            const originalContent = btn.html();
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>AI解析中...');

            try {
                // analyzeDocumentWithAI は既存の関数 (内部でEdge Functionを呼ぶ)
                // テキストとしてJSON文字列を渡す
                // prompt_key 'csv_field_mapping' (Step 435で追加) を指定
                const promptDetail = JSON.stringify(inputData, null, 2);

                const result = await analyzeDocumentWithAI(promptDetail, 'csv_field_mapping');

                let mapping = null;
                // 結果が文字列(JSON文字列)の場合と、既にオブジェクトの場合に対応
                if (typeof result === 'string') {
                    try {
                        // Markdownコードブロック除去
                        const cleanJson = result.replace(/^```json\s*|\s*```$/g, '').trim();
                        mapping = JSON.parse(cleanJson);
                    } catch (e) {
                        console.error('JSON parse error from AI', e);
                    }
                } else if (typeof result === 'object') {
                    mapping = result;
                }

                if (mapping) {
                    console.log('AI Mapping Result:', mapping);
                    let count = 0;

                    // 既存の選択をクリアするかどうか？ -> 既存を生かしつつ、未割当を埋める、あるいは上書きする
                    // ここでは「空欄」または「AIがより確度の高い提案をしてきた」場合に適用するが、
                    // シンプルに「AIの提案を全適用（上書き）」とする。
                    // ユーザーは気に入らなければ手動で戻せる。

                    for (const [key, header] of Object.entries(mapping)) {
                        // ヘッダーがCSVに本当に存在するか確認
                        if (currentCSVHeaders.includes(header)) {
                            const select = $(`.mapping-select[data-key="${key}"]`);
                            if (select.length) {
                                // 既に値が入っていても上書きする
                                select.val(header).trigger('change');
                                count++;
                            }
                        }
                    }
                    alert(`${count}件のフィールドを自動マッピングしました。\n結果を確認し、必要に応じて修正してください。`);
                } else {
                    alert('AIによる解析結果の取得に失敗しました。');
                }

            } catch (err) {
                console.error('AI Auto Map Error:', err);
                alert('AI処理中にエラーが発生しました: ' + err.message);
            } finally {
                btn.prop('disabled', false).html(originalContent);
            }
        }

        window.previewAIAnalysis = async function () {
            if (!currentCSVData || currentCSVData.length === 0) {
                alert('データがありません');
                return;
            }

            if (currentImportType !== 'jobs') {
                alert('現在、求人データのAI解析プレビューのみ対応しています');
                return;
            }

            const btn = $(event.currentTarget);
            const originalContent = btn.html();
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>解析中...');

            try {
                const row = currentCSVData[0];
                // 全カラムをテキスト化
                const text = Object.entries(row).map(([k, v]) => `${k}: ${v}`).join('\n');

                const options = {
                    job_categories: typeof masterJobCategories !== 'undefined' ? masterJobCategories : [],
                    industry_categories: typeof masterIndustries !== 'undefined' ? masterIndustries : []
                };

                // プロンプトキーは 'job_description'
                let aiResult = await analyzeDocumentWithAI(text, 'job_description', options);

                // 配列で返ってくる場合への対応
                if (Array.isArray(aiResult)) aiResult = aiResult[0] || {};

                if (typeof aiResult === 'string') {
                    try { aiResult = JSON.parse(aiResult.replace(/```json|```/g, '').trim()); } catch (e) { }
                }

                // キーの正規化 (AIの揺らぎ吸収)
                if (aiResult.industry_category && !aiResult.industry) aiResult.industry = aiResult.industry_category;
                // リモート可否の表示用変換
                if (aiResult.is_remote === true || aiResult.is_remote === 'true') aiResult.is_remote = '可';
                if (aiResult.is_remote === false || aiResult.is_remote === 'false') aiResult.is_remote = '不可';

                console.log('AI Preview Result:', aiResult);

                // 結果を表示
                $('.ai-preview-badge').remove(); // 既存のバッジ消去

                let matchCount = 0;
                for (const [key, value] of Object.entries(aiResult)) {
                    if (value === null || value === undefined || value === '') continue;

                    // key名が jobFields の key と一致するものを探す
                    const select = $(`.mapping-select[data-key="${key}"]`);
                    if (select.length) {
                        const rowEl = select.closest('tr');
                        const previewCell = rowEl.find('td:last-child');

                        // 値が長い場合は切り詰める
                        let displayValue = String(value);
                        if (displayValue.length > 30) displayValue = displayValue.substring(0, 30) + '...';

                        previewCell.append(`
                            <div class="ai-preview-badge mt-2 text-xs text-indigo-700 bg-indigo-50 border border-indigo-200 rounded px-2 py-1 shadow-sm">
                                <strong class="block text-indigo-900 mb-0.5"><i class="fas fa-robot mr-1"></i>AI解析</strong>
                                ${displayValue}
                            </div>
                        `);
                        matchCount++;
                    }
                }

                if (matchCount > 0) {
                    alert(`1件目の解析が完了しました。\n${matchCount}項目のAI解析結果をプレビュー列に表示しました。`);
                } else {
                    alert('AI解析を実行しましたが、表示できる項目が見つかりませんでした。\n解析結果: ' + JSON.stringify(aiResult, null, 2));
                }

            } catch (e) {
                console.error(e);
                alert('解析失敗: ' + e.message);
            } finally {
                btn.prop('disabled', false).html(originalContent);
            }
        }

        window.executeCSVImport = async function () {
            showLoading();
            try {
                const mapping = {};
                let missingRequired = [];
                const fields = currentImportType === 'jobs' ? jobFields :
                    currentImportType === 'companies' ? companyFields : userFields;

                const isUpsert = $('#csv-upsert-mode').is(':checked');
                const upsertKey = $('#csv-upsert-key').val();

                if (isUpsert && !upsertKey) {
                    alert('アップサートを有効にする場合は、更新キーを選択してください');
                    hideLoading();
                    return;
                }

                // マッピング情報の収集
                $('.mapping-select').each(function () {
                    const key = $(this).data('key');
                    const header = $(this).val();
                    if (header) {
                        mapping[key] = header;
                    } else {
                        const field = fields.find(f => f.key === key);
                        if (field && field.required) {
                            // メールアドレスの必須チェックを組織設定に基づいてスキップ
                            if ((currentImportType === 'users' || currentImportType === 'candidates') && field.key === 'email') {
                                if (currentUser.organizations && currentUser.organizations.settings && currentUser.organizations.settings.candidate_email_required === false) {
                                    return; // スキップ
                                }
                            }
                            missingRequired.push(field.label);
                        }
                    }
                });

                if (missingRequired.length > 0) {
                    alert(`必須項目がマッピングされていません: ${missingRequired.join(', ')}`);
                    hideLoading();
                    return;
                }

                let successCount = 0;
                let failedCount = 0;
                const errors = [];

                const salaryUnit = $('input[name="csv-salary-unit"]:checked').val() || 'auto';

                for (let i = 0; i < currentCSVData.length; i++) {
                    const row = currentCSVData[i];
                    try {
                        const importData = {};
                        // マッピングに基づいてデータ変換
                        for (const [key, header] of Object.entries(mapping)) {
                            let value = row[header];

                            // 数値変換が必要なフィールドの処理
                            if (['salary_min', 'salary_max', 'desired_salary'].includes(key)) {
                                if (value) {
                                    value = String(value).replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
                                    const numStr = value.replace(/[^0-9]/g, '');
                                    const num = parseInt(numStr);
                                    if (!isNaN(num)) {
                                        if (salaryUnit === 'man') {
                                            value = num * 10000;
                                        } else if (salaryUnit === 'yen') {
                                            value = num;
                                        } else {
                                            // auto
                                            value = num < 10000 ? num * 10000 : num;
                                        }
                                    } else {
                                        value = null;
                                    }
                                } else {
                                    value = null;
                                }
                            }

                            if (key === 'is_remote') {
                                value = ['true', 'yes', '1', '可', 'あり', '有', 'ok', '〇', '◯'].includes(String(value).toLowerCase());
                            }

                            if (key === 'job_experience_ok' || key === 'industry_experience_ok') {
                                const isPos = ['true', 'yes', '1', '可', 'あり', '有', 'ok', '〇', '◯'].includes(String(value).toLowerCase());
                                value = isPos ? '可' : '不可';
                            }

                            importData[key] = value;
                        }

                        importData.organization_id = currentUser.organization_id;

                        if (currentImportType === 'jobs') {
                            // AI自動補完
                            const useAI = $('#csv-ai-augment').is(':checked');
                            if (useAI) {
                                const jobText = Object.entries(row).map(([k, v]) => `${k}: ${v}`).join('\n');
                                const options = {
                                    job_categories: typeof masterJobCategories !== 'undefined' ? masterJobCategories : [],
                                    industry_categories: typeof masterIndustries !== 'undefined' ? masterIndustries : []
                                };
                                try {
                                    let aiResult = await analyzeDocumentWithAI(jobText, 'job_description', options);
                                    if (Array.isArray(aiResult)) aiResult = aiResult[0] || {};
                                    if (aiResult) {
                                        if (!importData.job_category && aiResult.job_category) importData.job_category = aiResult.job_category;
                                        if (!importData.industry_category && aiResult.industry_category) importData.industry_category = aiResult.industry_category;
                                        if (!importData.is_remote) {
                                            if (aiResult.is_remote === true || aiResult.is_remote === 'true') importData.is_remote = '可';
                                            else if (aiResult.is_remote === false || aiResult.is_remote === 'false') importData.is_remote = '不可';
                                            else if (aiResult.is_remote) importData.is_remote = aiResult.is_remote;
                                        }
                                        if (!importData.industry) importData.industry = aiResult.industry || aiResult.industry_category;

                                        // 必須要件と歓迎要件の精緻化
                                        // CSV側にデータがあっても、AIが綺麗に分割してくれた内容で補完・上書きを試みる
                                        if (aiResult.requirements) {
                                            // 10文字以下の短いデータ、またはAIがより詳細な場合はAIを優先
                                            if (!importData.requirements || importData.requirements.length < 10 || aiResult.requirements.length > importData.requirements.length) {
                                                importData.requirements = aiResult.requirements;
                                            }
                                        }
                                        if (aiResult.welcome_requirements) {
                                            if (!importData.welcome_requirements || importData.welcome_requirements.length < 5 || aiResult.welcome_requirements.length > importData.welcome_requirements.length) {
                                                importData.welcome_requirements = aiResult.welcome_requirements;
                                            }
                                        }

                                        // その他情報の補完
                                        if (!importData.description && aiResult.description) importData.description = aiResult.description;
                                        if (!importData.work_hours && aiResult.work_hours) importData.work_hours = aiResult.work_hours;
                                        if (!importData.holidays && aiResult.holidays) importData.holidays = aiResult.holidays;
                                        if (!importData.benefits && aiResult.benefits) importData.benefits = aiResult.benefits;
                                        if (!importData.interview_process && aiResult.interview_process) importData.interview_process = aiResult.interview_process;
                                        if (!importData.employment_type && aiResult.employment_type) importData.employment_type = aiResult.employment_type;
                                    }
                                } catch (e) { console.error('AI error:', e); }
                            }

                            if (!importData.title) throw new Error('求人タイトルは必須です');
                            if (!importData.company) throw new Error('企業名は必須です');

                            // 企業IDの解決
                            let companyId = null;
                            const { data: existingCompany } = await supabase
                                .from('companies')
                                .select('id')
                                .eq('organization_id', currentUser.organization_id)
                                .eq('name', importData.company)
                                .single();

                            if (existingCompany) {
                                companyId = existingCompany.id;
                            } else {
                                const { data: newCompany, error: createError } = await supabase
                                    .from('companies')
                                    .insert({
                                        organization_id: currentUser.organization_id,
                                        name: importData.company,
                                        location: importData.location || '未定'
                                    })
                                    .select()
                                    .single();
                                if (createError) throw new Error(`企業作成エラー: ${createError.message}`);
                                companyId = newCompany.id;
                            }
                            importData.company_id = companyId;
                            importData.status = 'active';

                            if (importData.industry) {
                                let val = importData.industry;
                                if (typeof masterIndustries !== 'undefined') {
                                    const match = masterIndustries.find(m => m.label === val || m.value === val);
                                    if (match) val = match.value;
                                }
                                importData.industry_category = val;
                                delete importData.industry;
                            }

                            if (importData.job_category) {
                                let val = importData.job_category;
                                if (typeof masterJobCategories !== 'undefined') {
                                    const match = masterJobCategories.find(m => m.label === val || m.value === val);
                                    if (match) val = match.value;
                                }
                                importData.job_category = val;
                            }

                            // アップサート処理
                            if (isUpsert && upsertKey && importData[upsertKey]) {
                                const { data: existingRecord } = await supabase
                                    .from('jobs')
                                    .select('id')
                                    .eq('organization_id', currentUser.organization_id)
                                    .eq(upsertKey, importData[upsertKey])
                                    .is('deleted_at', null)
                                    .maybeSingle();

                                if (existingRecord) {
                                    const { error } = await supabase.from('jobs').update(importData).eq('id', existingRecord.id);
                                    if (error) throw error;
                                } else {
                                    const { error } = await supabase.from('jobs').insert(importData);
                                    if (error) throw error;
                                }
                            } else {
                                const { error } = await supabase.from('jobs').insert(importData);
                                if (error) throw error;
                            }

                        } else if (currentImportType === 'companies') {
                            if (!importData.name) throw new Error('企業名は必須です');

                            if (isUpsert && upsertKey && importData[upsertKey]) {
                                const { data: existingRecord } = await supabase
                                    .from('companies')
                                    .select('id')
                                    .eq('organization_id', currentUser.organization_id)
                                    .eq(upsertKey, importData[upsertKey])
                                    .maybeSingle();

                                if (existingRecord) {
                                    const { error } = await supabase.from('companies').update(importData).eq('id', existingRecord.id);
                                    if (error) throw error;
                                } else {
                                    const { error } = await supabase.from('companies').insert(importData);
                                    if (error) throw error;
                                }
                            } else {
                                const { error } = await supabase.from('companies').insert(importData);
                                if (error) throw error;
                            }

                        } else if (currentImportType === 'users') {
                            if (!importData.role) importData.role = 'candidate';
                            let emailRequired = true;
                            if (importData.role === 'candidate' && currentUser.organizations?.settings?.candidate_email_required === false) {
                                emailRequired = false;
                            }

                            if (!importData.email) {
                                if (emailRequired) throw new Error('メールアドレスは必須です');
                                importData.email = `candidate-${Date.now()}-${crypto.randomUUID().substring(0, 8)}@placeholder.local`;
                            }
                            if (!importData.name) throw new Error('氏名は必須です');

                            if (isUpsert && upsertKey && importData[upsertKey]) {
                                const { data: existingRecord } = await supabase
                                    .from('users')
                                    .select('id')
                                    .eq('organization_id', currentUser.organization_id)
                                    .eq(upsertKey, importData[upsertKey])
                                    .maybeSingle();

                                if (existingRecord) {
                                    const { error } = await supabase.from('users').update(importData).eq('id', existingRecord.id);
                                    if (error) throw error;
                                } else {
                                    const { error } = await supabase.from('users').insert(importData);
                                    if (error) throw error;
                                }
                            } else {
                                // 重複チェック（emailのみデフォルトで）
                                const { data: existingUser } = await supabase.from('users').select('id').eq('email', importData.email).maybeSingle();
                                if (existingUser) throw new Error(`既に存在するメールアドレスです: ${importData.email}`);

                                const { error } = await supabase.from('users').insert(importData);
                                if (error) throw error;
                            }

                        } else if (currentImportType === 'candidates') {
                            // 求職者(Edge Function)
                            importData.role = 'candidate';

                            // 最新の組織設定を同期（ステール状態を防ぐ）
                            if (!currentUser.organizations || !currentUser.organizations.settings || currentUser.role === 'super_admin') {
                                try {
                                    const { data: freshOrg } = await supabase.from('organizations').select('settings').eq('id', currentUser.organization_id).single();
                                    if (freshOrg) {
                                        if (!currentUser.organizations) currentUser.organizations = {};
                                        currentUser.organizations.settings = freshOrg.settings;
                                    }
                                } catch (e) { console.warn('Failed to refresh org settings before import', e); }
                            }

                            const orgSettings = (Array.isArray(currentUser.organizations) ? currentUser.organizations[0]?.settings : currentUser.organizations?.settings) || {};
                            const emailRequired = orgSettings.candidate_email_required !== false;
                            const passwordRequired = orgSettings.candidate_password_required !== false;

                            if (!importData.email || importData.email.trim() === '') {
                                if (emailRequired) throw new Error('メールアドレスは必須です');
                                importData.email = `candidate-${Date.now()}-${Math.random().toString(36).substring(2, 10)}@placeholder.local`;
                            }
                            if (!importData.password || importData.password.trim() === '') {
                                if (passwordRequired) throw new Error('パスワードは必須です');
                                importData.password = `dummyPass${Math.random().toString(36).substring(2, 15)}`;
                            }
                            if (!importData.name || importData.name.trim() === '') throw new Error('氏名は必須です');

                            // Edge Function呼び出し
                            const { data, error } = await supabase.functions.invoke('create-user', {
                                body: {
                                    email: importData.email,
                                    password: importData.password,
                                    name: importData.name,
                                    role: 'candidate',
                                    organizationId: currentUser.organization_id,
                                    upsert: isUpsert, // アップサートフラグを渡す
                                    profileData: {
                                        age: importData.age || null,
                                        desired_job_type: importData.desired_job_type ?
                                            (typeof importData.desired_job_type === 'string' ? importData.desired_job_type.split(/[,、\uff0c\uff0f\s　]+/).map(s => s.trim()).filter(Boolean) : importData.desired_job_type) : null,
                                        desired_location: importData.desired_location ?
                                            (typeof importData.desired_location === 'string' ? importData.desired_location.split(/[,、\uff0c\uff0f\s　]+/).map(s => s.trim()).filter(Boolean) : importData.desired_location) : null,
                                        desired_salary: importData.desired_salary || null,
                                        skills: importData.skills || null,
                                        work_history: importData.work_history || null,
                                        academic_background: importData.academic_background || null,
                                        languages: importData.languages || null,
                                        certifications: importData.certifications || null,
                                        matching_info: importData.matching_info || null,
                                        internal_info: importData.internal_info || null,
                                        other_info: importData.other_info || null
                                    }
                                }
                            });

                            if (error || !data.success) throw new Error(error?.message || data?.error || 'ユーザー作成失敗');
                        }

                        successCount++;
                    } catch (err) {
                        console.error(`Row ${i + 1} error:`, err);
                        failedCount++;
                        errors.push({ row: i + 1, data: row, error: err.message || JSON.stringify(err) });
                    }
                }

                await supabase.from('csv_imports').insert({
                    organization_id: currentUser.organization_id,
                    user_id: currentUser.id,
                    import_type: currentImportType,
                    file_name: 'import.csv',
                    total_rows: currentCSVData.length,
                    success_rows: successCount,
                    failed_rows: failedCount,
                    errors: errors
                });

                closeCSVMappingModal();
                let message = `インポート完了\n成功: ${successCount}件\n失敗: ${failedCount}件`;
                if (failedCount > 0) {
                    message += `\n\nエラー内容（最初の5件）:\n` + errors.slice(0, 5).map(e => `${e.row}行目: ${e.error}`).join('\n');
                }
                alert(message);

                // 画面更新
                if (currentImportType === 'jobs') { if (typeof loadAdminJobs === 'function') loadAdminJobs(); }
                else if (currentImportType === 'companies') { if (typeof loadCompanies === 'function') loadCompanies(); }
                else if (currentImportType === 'users' || currentImportType === 'candidates') { if (typeof loadAdminUsers === 'function') loadAdminUsers(); }
                if (typeof loadCSVHistory === 'function') loadCSVHistory();

            } catch (err) {
                console.error('Import process error:', err);
                alert('インポート処理中に致命的なエラーが発生しました: ' + err.message);
            } finally {
                hideLoading();
            }
        }

        async function loadCSVHistory() {
            try {
                const { data: history, error } = await supabase
                    .from('csv_imports')
                    .select('*')
                    .eq('organization_id', currentUser.organization_id)
                    .order('created_at', { ascending: false })
                    .limit(10)

                if (error) throw error

                const container = $('#csv-history-container')
                container.empty()

                if (history.length === 0) {
                    container.html('<p class="text-gray-500 text-sm">履歴はありません</p>')
                    return
                }

                const html = history.map(h => `
                    <div class="border-b py-3 last:border-0">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-medium text-sm">${h.file_name}</span>
                            <span class="text-xs text-gray-500">${new Date(h.created_at).toLocaleString('ja-JP')}</span>
                        </div>
                        <div class="text-xs flex gap-4">
                            <span class="text-green-600">成功: ${h.success_rows}</span>
                            <span class="text-red-600">失敗: ${h.failed_rows}</span>
                            <span class="text-gray-600">タイプ: ${h.import_type}</span>
                        </div>
                    </div>
                `).join('')

                container.html(html)
            } catch (error) {
                console.error('Load CSV history error:', error)
            }
        }

        // ========================
        // Admin: Audit Logs
        // ========================
        async function logAction(action, entityType, entityId, details = {}) {
            if (!currentUser) return

            try {
                await supabase.from('audit_logs').insert({
                    organization_id: currentUser.organization_id,
                    user_id: currentUser.id,
                    action: action,
                    entity_type: entityType,
                    entity_id: entityId,
                    details: details,
                    user_agent: navigator.userAgent
                })
            } catch (error) {
                console.error('Log action error:', error)
            }
        }

        window.loadAuditLogs = async function () {
            if (!currentUser) return

            showLoading()
            try {
                let query = supabase
                    .from('audit_logs')
                    .select('*, users(name)')
                    .eq('organization_id', currentUser.organization_id)
                    .order('created_at', { ascending: false })
                    .limit(50)

                const filterAction = $('#log-filter-action').val()
                if (filterAction) {
                    query = query.eq('action', filterAction)
                }

                const { data: logs, error } = await query

                if (error) throw error

                const container = $('#audit-logs-container')
                container.empty()

                if (logs.length === 0) {
                    container.html('<p class="text-gray-500 text-center py-8">ログがありません</p>')
                    return
                }

                const actionLabels = {
                    'create': { label: '作成', color: 'bg-green-100 text-green-800' },
                    'update': { label: '更新', color: 'bg-blue-100 text-blue-800' },
                    'delete': { label: '削除', color: 'bg-red-100 text-red-800' },
                    'login': { label: 'ログイン', color: 'bg-gray-100 text-gray-800' },
                    'logout': { label: 'ログアウト', color: 'bg-gray-100 text-gray-800' },
                    'apply': { label: '応募', color: 'bg-indigo-100 text-indigo-800' },
                    'recommend': { label: 'AI推薦', color: 'bg-purple-100 text-purple-800' },
                    'bulk_recommend': { label: '一括AI推薦', color: 'bg-purple-100 text-purple-800' },
                    'csv_import': { label: 'CSVインポート', color: 'bg-yellow-100 text-yellow-800' }
                }

                const html = logs.map(log => {
                    const action = actionLabels[log.action] || { label: log.action, color: 'bg-gray-100 text-gray-800' }
                    const details = log.details ? JSON.stringify(log.details, null, 2) : '詳細なし';
                    const targetType = log.resource_type || log.target_type || log.entity_type || '不明';

                    return `
                        <div class="bg-white border border-gray-200 rounded-lg p-4 mb-3 text-sm">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center gap-2">
                                    <span class="px-2 py-1 rounded text-xs font-medium ${action.color}">${action.label}</span>
                                    <span class="font-bold text-gray-900">${log.users?.name || '不明なユーザー'}</span>
                                    <span class="text-gray-500">が ${targetType} を操作しました</span>
                                </div>
                                <span class="text-xs text-gray-400">${new Date(log.created_at).toLocaleString('ja-JP')}</span>
                            </div>
                            <details class="mt-2">
                                <summary class="cursor-pointer text-xs text-indigo-600 hover:text-indigo-800">詳細を表示</summary>
                                <pre class="mt-2 p-2 bg-gray-50 rounded text-xs overflow-x-auto">${details}</pre>
                            </details>
                        </div>
                    `
                }).join('')

                container.html(html)
            } catch (error) {
                console.error('Load audit logs error:', error)
                $('#audit-logs-container').html('<p class="text-red-500">ログの読み込みに失敗しました</p>')
            } finally {
                hideLoading()
            }
        }



        // ========================
        // Admin: Prompt Settings
        // ========================
        // ========================
        // Multi-tenant: Organization Switching
        // ========================
        window.showOrgSelectModalForSwitch = async function () {
            if (!currentUser) return;
            showLoading('所属組織を取得中...');
            try {
                // user_idだけでなく、念のためメールアドレスが一致する全所属を取得
                // ※ organization_members に email カラムはないため、usersテーブルを経由して取得
                const { data: memberships, error } = await supabase
                    .from('organization_members')
                    .select('organization_id, role, organizations(name, code), users!inner(email)')
                    .eq('users.email', currentUser.email);

                console.log('Switch Modal Debug: All memberships for email', currentUser.email, ':', memberships);

                if (error) {
                    console.error('Switch Modal Debug: Error fetching memberships:', error);
                    throw error;
                }

                if (!memberships || memberships.length === 0) {
                    console.warn('Switch Modal Debug: No memberships found for user', currentUser.id);
                }

                const modal = $('#org-select-modal');
                const list = $('#org-select-list');
                list.empty();

                memberships.forEach(m => {
                    const org = m.organizations;
                    const isCurrent = m.organization_id === currentUser.organization_id;
                    const btn = $(`
                        <button class="w-full text-left px-4 py-3 ${isCurrent ? 'bg-indigo-600 text-white' : 'bg-gray-50 text-gray-900 hover:bg-indigo-50'} border rounded-lg transition items-center flex justify-between group">
                            <div>
                                <div class="font-bold">${org.name} ${isCurrent ? '<span class="text-[10px] ml-2 font-normal">(現在選択中)</span>' : ''}</div>
                                <div class="text-xs ${isCurrent ? 'text-indigo-200' : 'text-gray-500'}">Role: ${m.role}</div>
                            </div>
                            <i class="fas fa-chevron-right ${isCurrent ? 'text-white' : 'text-gray-300'}"></i>
                        </button>
                    `);
                    btn.on('click', async (e) => {
                        e.preventDefault();
                        if (isCurrent) {
                            modal.addClass('hidden');
                            return;
                        }
                        await switchOrganization(m.organization_id, m.role, org.name);
                        modal.addClass('hidden');
                    });
                    list.append(btn);
                });

                hideLoading();
                modal.removeClass('hidden');
            } catch (error) {
                console.error('Fetch memberships error:', error);
                alert('組織情報の取得に失敗しました');
                hideLoading();
            }
        };

        async function switchOrganization(orgId, role, orgName) {
            showLoading(`${orgName} に切り替え中...`);
            try {
                // 1. ユーザーの現在のデフォルト組織を更新
                await supabase.from('users').update({
                    organization_id: orgId,
                    role: role // 既存ロジック互換のためusersのroleも一応更新（RLSが通る場合のみ）
                }).eq('id', currentUser.id);

                // 2. グローバル変数を更新
                currentUser.organization_id = orgId;
                currentUser.role = role;
                currentUser.organizations = { name: orgName };
                window.currentUser = currentUser;

                // 3. UIの表示を初期化
                $('#user-role').text(getRoleLabel(role));
                $('#org-name').text(orgName);
                $('#org-code-display').text(''); // 組織コードは後で更新される

                // メニューの再構築（役割に応じて表示/非表示）
                loadedPages.clear(); // キャッシュをクリア
                updateMenuVisibility(role);

                // 4. ダッシュボードへ戻る
                await loadDashboard();
                showAppContent('dashboard-content');
                $('.nav-link').removeClass('bg-indigo-50 text-indigo-600');
                $('.nav-link[data-page="dashboard"]').addClass('bg-indigo-50 text-indigo-600');

                alert(`${orgName} に切り替えました`);
            } catch (error) {
                console.error('Switch organization error:', error);
                alert('切り替えに失敗しました。ページを再読み込みしてください。');
            } finally {
                hideLoading();
            }
        }

        function updateMenuVisibility(role) {
            const adminRoles = ['org_admin', 'admin', 'super_admin'];
            const staffRoles = ['org_admin', 'admin', 'coach', 'ca', 'ra', 'super_admin'];

            if (adminRoles.includes(role)) $('#admin-menu').removeClass('hidden');
            else $('#admin-menu').addClass('hidden');

            if (role === 'super_admin') $('#super-admin-menu').removeClass('hidden');
            else $('#super-admin-menu').addClass('hidden');

            if (staffRoles.includes(role)) {
                $('#coach-menu').removeClass('hidden');
                $('#ai-scout-link').removeClass('hidden');
                $('#nav-candidate-search').removeClass('hidden');
            } else {
                $('#coach-menu').addClass('hidden');
                $('#ai-scout-link').addClass('hidden');
                $('#nav-candidate-search').addClass('hidden');
            }

            if (role === 'candidate') $('#nav-dashboard').addClass('hidden');
            else $('#nav-dashboard').removeClass('hidden');
        }

        // ========================
        // Super Admin: Organization Management
        // ========================
        let superAdminOrgsCache = [];

        async function loadSuperAdminOrganizations() {
            console.log('--- loadSuperAdminOrganizations START ---');
            if (!currentUser) {
                console.error('loadSuperAdminOrganizations: currentUser is missing');
                return;
            }
            console.log('Current user role:', currentUser.role);
            if (currentUser.role !== 'super_admin') {
                console.warn('loadSuperAdminOrganizations: User is not super_admin');
                return;
            }

            showLoading();
            try {
                console.log('Fetching organizations from Supabase...');
                const { data: orgs, error } = await supabase
                    .from('organizations')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Supabase fetch error:', error);
                    throw error;
                }

                console.log('Orgs fetched:', orgs ? orgs.length : 0);
                superAdminOrgsCache = orgs || [];
                renderSuperAdminOrganizations(superAdminOrgsCache);
            } catch (error) {
                console.error('Load organizations error:', error);
                const $errContainer = $('#super-admin-organizations-container');
                if ($errContainer.length) {
                    $errContainer.html('<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">読み込みに失敗しました: ' + error.message + '</td></tr>');
                } else {
                    console.error('Error container NOT FOUND');
                }
            } finally {
                hideLoading();
                console.log('--- loadSuperAdminOrganizations END ---');
            }
        }

        function renderSuperAdminOrganizations(orgs) {
            console.log('renderSuperAdminOrganizations called with', orgs.length, 'orgs');
            const container = $('#super-admin-organizations-container');
            console.log('Container found:', container.length);

            if (container.length === 0) {
                console.error('CRITICAL: #super-admin-organizations-container NOT FOUND IN DOM');
                return;
            }

            container.empty();

            if (orgs.length === 0) {
                console.log('No orgs to display.');
                container.html('<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">組織がありません</td></tr>');
                return;
            }

            const html = orgs.map(org => {
                const statusColors = {
                    'active': 'bg-green-100 text-green-800',
                    'suspended': 'bg-red-100 text-red-800',
                    'cancelled': 'bg-gray-100 text-gray-800'
                };
                const statusLabel = {
                    'active': '有効',
                    'suspended': '停止中',
                    'cancelled': '解約済'
                };
                const planLabel = {
                    'free': 'Free',
                    'standard': 'Standard',
                    'premium': 'Premium'
                };

                return `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${org.name}</div>
                        <div class="text-xs text-gray-500">ID: ${org.id}</div>
                        <div class="text-xs text-indigo-600 font-mono mt-1">Code: ${org.code || '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                            ${planLabel[org.plan_type] || org.plan_type || 'Free'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColors[org.status] || 'bg-gray-100 text-gray-800'}">
                            ${statusLabel[org.status] || org.status || 'Active'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${org.max_users || 5}名
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${org.valid_until ? new Date(org.valid_until).toLocaleDateString('ja-JP') : '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="showOrganizationModal('${org.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">
                            <i class="fas fa-edit"></i> 編集
                        </button>
                        <button onclick="generateInvitationForOrg('${org.id}')" class="text-green-600 hover:text-green-900">
                            <i class="fas fa-user-plus"></i> 招待URL発行
                        </button>
                    </td>
                </tr>
                `;
            }).join('');

            container.html(html);
        }

        window.showOrganizationModal = function (orgId = null) {
            console.log('showOrganizationModal called with ID:', orgId);
            try {
                const form = $('#organization-form')[0];
                if (!form) {
                    console.error('Organization form not found');
                    return;
                }
                form.reset();
                $('#org-id').val('');

                if (orgId) {
                    const org = superAdminOrgsCache.find(o => o.id === orgId);
                    if (org) {
                        $('#org-modal-title').text('組織編集');
                        $('#org-id').val(org.id);
                        $('#org-name-input').val(org.name);
                        $('#org-plan').val(org.plan_type || 'free');
                        $('#org-status').val(org.status || 'active');
                        $('#org-max-users').val(org.max_users || 5);
                        if (org.valid_until) {
                            $('#org-valid-until').val(new Date(org.valid_until).toISOString().split('T')[0]);
                        }
                        // 編集時は初期管理者入力欄を隠す
                        $('#org-initial-admin-fields').addClass('hidden');
                        $('#org-admin-name').removeAttr('required');
                        $('#org-admin-email').removeAttr('required');

                        // 設定の読み込み
                        const settings = org.settings || {};
                        $('#org-setting-email-required').prop('checked', settings.candidate_email_required !== false); // デフォルトtrue
                        $('#org-setting-password-required').prop('checked', settings.candidate_password_required !== false); // デフォルトtrue
                        $('#org-setting-limit-agent-view').prop('checked', settings.limit_agent_view === true); // デフォルトfalse

                        // ロール名称の読み込み
                        const roleLabels = settings.role_labels || {};
                        $('#org-role-label-org_admin').val(roleLabels.org_admin || '');
                        $('#org-role-label-admin').val(roleLabels.admin || '');
                        $('#org-role-label-coach').val(roleLabels.coach || '');
                        $('#org-role-label-candidate').val(roleLabels.candidate || '');
                    } else {
                        console.warn(`Organization with ID ${orgId} not found in cache.`);
                    }
                } else {
                    $('#org-modal-title').text('新規組織作成');
                    $('#org-plan').val('free');
                    $('#org-status').val('active');
                    $('#org-max-users').val(5);
                    // 新規時は初期管理者入力欄を表示
                    $('#org-initial-admin-fields').removeClass('hidden');
                    $('#org-admin-name').attr('required', 'required');
                    $('#org-admin-email').attr('required', 'required');

                    // デフォルト設定
                    $('#org-setting-email-required').prop('checked', true);
                    $('#org-setting-password-required').prop('checked', true);
                }

                console.log('Toggling modal visibility...');
                const $modal = $('#organization-modal');
                console.log('Modal found:', $modal.length);
                if ($modal.length > 0) {
                    $modal.removeClass('hidden').css('z-index', '1000000');
                    console.log('Modal hidden class removed. Current display:', $modal.css('display'));
                } else {
                    console.error('CRITICAL: #organization-modal NOT FOUND IN DOM');
                }
            } catch (error) {
                console.error('Error in showOrganizationModal:', error);
                alert('モーダルの表示中にエラーが発生しました: ' + error.message);
            }
        }

        window.closeOrganizationModal = function () {
            $('#organization-modal').addClass('hidden');
        }

        // 組織保存処理
        $('#organization-form').on('submit', async function (e) {
            e.preventDefault();
            if (!currentUser || currentUser.role !== 'super_admin') return;

            const orgId = $('#org-id').val();
            const orgData = {
                name: $('#org-name-input').val().trim(),
                plan_type: $('#org-plan').val(),
                status: $('#org-status').val(),
                max_users: parseInt($('#org-max-users').val()),
                valid_until: $('#org-valid-until').val() ? new Date($('#org-valid-until').val()).toISOString() : null,
                updated_at: new Date().toISOString()
            };

            // slugの扱い
            if (!orgId) {
                orgData.slug = 'org-' + Date.now().toString(36) + '-' + Math.random().toString(36).substring(2, 7);
                // コード生成 (8桁のランダムな英数字)
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let code = '';
                for (let i = 0; i < 8; i++) {
                    code += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                orgData.code = code;
            }

            // 現在の設定を取得してマージ
            let currentSettings = {};
            if (orgId && typeof superAdminOrgsCache !== 'undefined') {
                const existingOrg = superAdminOrgsCache.find(o => o.id === orgId);
                if (existingOrg && existingOrg.settings) {
                    currentSettings = existingOrg.settings;
                }
            }

            orgData.settings = {
                ...currentSettings,
                candidate_email_required: $('#org-setting-email-required').is(':checked'),
                candidate_password_required: $('#org-setting-password-required').is(':checked'),
                limit_agent_view: $('#org-setting-limit-agent-view').is(':checked'),
                role_labels: {
                    org_admin: $('#org-role-label-org_admin').val().trim() || null,
                    admin: $('#org-role-label-admin').val().trim() || null,
                    coach: $('#org-role-label-coach').val().trim() || null,
                    candidate: $('#org-role-label-candidate').val().trim() || null
                }
            };

            // 初期管理者情報（新規作成時のみ）
            const adminName = $('#org-admin-name').val().trim();
            const adminEmail = $('#org-admin-email').val().trim();

            showLoading();
            try {
                if (orgId) {
                    // 更新 (Direct DB Update)
                    const { error } = await supabase
                        .from('organizations')
                        .update(orgData)
                        .eq('id', orgId);

                    if (error) throw error;

                    alert('保存しました');

                    // キャッシュを更新
                    if (typeof superAdminOrgsCache !== 'undefined') {
                        const idx = superAdminOrgsCache.findIndex(o => o.id === orgId);
                        if (idx !== -1) {
                            superAdminOrgsCache[idx] = { ...superAdminOrgsCache[idx], ...orgData };
                        }
                    }

                    // 現在の組織情報を更新
                    if (currentUser && currentUser.organization_id === orgId) {
                        currentUser.organizations = { ...currentUser.organizations, ...orgData };
                    }

                } else {
                    // 新規作成 (Direct DB Insert)
                    const { data: newOrgData, error: createError } = await supabase
                        .from('organizations')
                        .insert(orgData)
                        .select()
                        .single();

                    if (createError) throw createError;

                    const newOrg = newOrgData;

                    // 招待状の作成
                    const token = crypto.randomUUID();
                    const expiresAt = new Date();
                    expiresAt.setDate(expiresAt.getDate() + 7); // 7日間有効

                    const { error: inviteError } = await supabase
                        .from('invitations')
                        .insert({
                            organization_id: newOrg.id,
                            email: adminEmail,
                            role: 'org_admin',
                            token: token,
                            expires_at: expiresAt.toISOString()
                        });

                    if (inviteError) {
                        console.error('Invitation error:', inviteError);
                        alert('組織は作成されましたが、招待状の作成に失敗しました: ' + inviteError.message);
                    } else {
                        const inviteUrl = `${window.location.origin}${window.location.pathname}?token=${token}`;

                        // メール送信 (Client Side Mock/Impl)
                        await sendEmail('invitation', adminEmail, {
                            organizationName: newOrg.name,
                            invitationUrl: inviteUrl
                        });

                        // モーダルで招待URLを表示
                        showInvitationUrlModal(newOrg.name, adminEmail, inviteUrl);
                    }
                }

                if (!($('#invitation-url-modal').hasClass('hidden') === false)) {
                    // 招待URLモーダルが出ていない場合のみ閉じる
                    closeOrganizationModal();
                }

                loadSuperAdminOrganizations();

            } catch (error) {
                console.error('Save organization error:', error);
                alert('保存に失敗しました: ' + error.message);
            } finally {
                hideLoading();
            }
        });

        // 招待URLモーダル関連の関数
        function showInvitationUrlModal(orgName, email, url) {
            $('#invite-org-name').text(orgName);
            $('#invite-admin-email').text(email);
            $('#invitation-url-display').val(url);
            $('#invitation-url-modal').removeClass('hidden');
        }

        window.closeInvitationUrlModal = function () {
            $('#invitation-url-modal').addClass('hidden');
        }

        window.copyInvitationUrl = function () {
            const urlInput = document.getElementById('invitation-url-display');
            urlInput.select();
            urlInput.setSelectionRange(0, 99999); // モバイル対応

            navigator.clipboard.writeText(urlInput.value).then(() => {
                alert('URLをクリップボードにコピーしました');
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('コピーに失敗しました');
            });
        }

        window.sendInvitationEmail = async function () {
            const email = $('#invite-admin-email').text();
            const url = $('#invitation-url-display').val();
            const orgName = $('#invite-org-name').text();

            if (!confirm('招待メールを再送信しますか？')) return;

            showLoading();
            try {
                const success = await sendEmail('invitation', email, {
                    organizationName: orgName,
                    invitationUrl: url
                });

                if (success) {
                    alert('招待メールを送信しました');
                } else {
                    alert('メール送信に失敗しました');
                }
            } catch (error) {
                console.error('Resend invitation error:', error);
                alert('送信エラーが発生しました');
            } finally {
                hideLoading();
            }
        }

        // 既存組織への招待URL発行
        window.generateInvitationForOrg = async function (orgId) {
            const org = superAdminOrgsCache.find(o => o.id === orgId);
            if (!org) {
                alert('組織情報が見つかりません');
                return;
            }

            const adminName = prompt('管理者の名前を入力してください:');
            if (!adminName || !adminName.trim()) return;

            const adminEmail = prompt('管理者のメールアドレスを入力してください:');
            if (!adminEmail || !adminEmail.trim()) return;

            // メールアドレスの簡易バリデーション
            if (!adminEmail.includes('@')) {
                alert('有効なメールアドレスを入力してください');
                return;
            }

            showLoading();
            try {
                // 既存の招待を削除（同じ組織とメールアドレスの組み合わせ）
                await supabase
                    .from('invitations')
                    .delete()
                    .eq('organization_id', orgId)
                    .eq('email', adminEmail.trim());

                const token = crypto.randomUUID();
                const expiresAt = new Date();
                expiresAt.setDate(expiresAt.getDate() + 7); // 7日間有効

                const { error: inviteError } = await supabase
                    .from('invitations')
                    .insert({
                        organization_id: orgId,
                        email: adminEmail.trim(),
                        role: 'org_admin',
                        token: token,
                        expires_at: expiresAt.toISOString()
                    });

                if (inviteError) throw inviteError;

                const inviteUrl = `${window.location.origin}${window.location.pathname}?token=${token}`;

                // メール送信
                await sendEmail('invitation', adminEmail.trim(), {
                    organizationName: org.name,
                    invitationUrl: inviteUrl
                });

                showInvitationUrlModal(org.name, adminEmail.trim(), inviteUrl);

            } catch (error) {
                console.error('Invitation creation failed:', error);
                alert('招待URLの発行に失敗しました: ' + error.message);
            } finally {
                hideLoading();
            }
        }



        window.showPromptForm = function () {
            $('#prompt-modal-title').text('プロンプト作成')
            $('#prompt-form')[0].reset()
            $('#prompt-id').val('')
            $('#prompt-is-active').prop('checked', true)

            // Global option is only for super_admin
            if (currentUser.role === 'super_admin') {
                $('#prompt-is-global').parent().show()
                $('#prompt-is-global').prop('checked', false)
            } else {
                $('#prompt-is-global').parent().hide()
                $('#prompt-is-global').prop('checked', false)
            }

            // Enable inputs
            $('#prompt-name').prop('disabled', false)
            $('#prompt-template').prop('disabled', false)
            $('#prompt-is-active').prop('disabled', false)
            $('#prompt-is-global').prop('disabled', false)
            $('#prompt-submit-btn').show()

            $('#prompt-modal').removeClass('hidden')
        }

        window.editPrompt = function (prompt) {
            $('#prompt-modal-title').text('プロンプト編集')
            $('#prompt-id').val(prompt.id)
            $('#prompt-name').val(prompt.name)
            $('#prompt-template').val(prompt.prompt_template)
            $('#prompt-is-active').prop('checked', prompt.is_active)
            $('#prompt-is-global').prop('checked', prompt.is_global)

            // Global option visibility
            if (currentUser.role === 'super_admin') {
                $('#prompt-is-global').parent().show()
            } else {
                $('#prompt-is-global').parent().hide()
            }

            // Enable inputs
            $('#prompt-name').prop('disabled', false)
            $('#prompt-template').prop('disabled', false)
            $('#prompt-is-active').prop('disabled', false)
            $('#prompt-is-global').prop('disabled', false)
            $('#prompt-submit-btn').show()

            $('#prompt-modal').removeClass('hidden')
        }

        window.viewPrompt = function (prompt) {
            $('#prompt-modal-title').text('プロンプト閲覧')
            $('#prompt-id').val(prompt.id)
            $('#prompt-name').val(prompt.name)
            $('#prompt-template').val(prompt.prompt_template)
            $('#prompt-is-active').prop('checked', prompt.is_active)
            $('#prompt-is-global').prop('checked', prompt.is_global)

            // Global option visibility
            if (currentUser.role === 'super_admin') {
                $('#prompt-is-global').parent().show()
            } else {
                $('#prompt-is-global').parent().hide()
            }

            // Disable inputs
            $('#prompt-name').prop('disabled', true)
            $('#prompt-template').prop('disabled', true)
            $('#prompt-is-active').prop('disabled', true)
            $('#prompt-is-global').prop('disabled', true)
            $('#prompt-submit-btn').hide()

            $('#prompt-modal').removeClass('hidden')
        }

        window.closePromptModal = function () {
            $('#prompt-modal').addClass('hidden')
            $('#prompt-form')[0].reset()
        }

        $('#prompt-form').on('submit', async function (e) {
            e.preventDefault()
            showLoading()

            const promptId = $('#prompt-id').val()
            const isGlobal = $('#prompt-is-global').is(':checked')

            // If not super admin, force is_global to false and set organization_id
            let orgId = null
            if (currentUser.role === 'super_admin') {
                orgId = isGlobal ? null : currentUser.organization_id // Or maybe super admin can create for specific org? For now, if not global, assign to their org (which might be null or a system org)
                // Actually, if super admin creates a non-global prompt, it should probably be global or assigned to a specific org. 
                // For simplicity, super admin creates global prompts by default or "system" prompts.
                // If isGlobal is false, let's set it to null (global) or current org.
                // Let's stick to: isGlobal -> orgId = null. !isGlobal -> orgId = currentUser.organization_id
            } else {
                orgId = currentUser.organization_id
            }

            const promptData = {
                name: $('#prompt-name').val(),
                prompt_template: $('#prompt-template').val(),
                is_active: $('#prompt-is-active').is(':checked'),
                is_global: isGlobal,
                organization_id: orgId,
                updated_at: new Date().toISOString()
            }

            if (!promptId) {
                promptData.created_by = currentUser.id
            }

            try {
                if (promptId) {
                    const { error } = await supabase
                        .from('ai_prompts')
                        .update(promptData)
                        .eq('id', promptId)
                    if (error) throw error
                    alert('プロンプトを更新しました')
                } else {
                    const { error } = await supabase
                        .from('ai_prompts')
                        .insert(promptData)
                    if (error) throw error
                    alert('プロンプトを作成しました')
                }

                closePromptModal()
                loadPrompts()
            } catch (error) {
                console.error('Save prompt error:', error)
                alert('保存に失敗しました: ' + error.message)
            } finally {
                hideLoading()
            }
        })

        // ========================
        // Admin: Master Data
        // ========================
        window.switchMasterTab = function (type) {
            $('#master-filter-type').val(type);

            // Update tab styles
            $('.master-tab').each(function () {
                const onclick = $(this).attr('onclick');
                if (onclick.includes(`'${type}'`)) {
                    $(this).removeClass('border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300')
                        .addClass('border-indigo-500 text-indigo-600');
                } else {
                    $(this).removeClass('border-indigo-500 text-indigo-600')
                        .addClass('border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300');
                }
            });

            loadMasterData();
        }

        window.updateMasterSortOrder = async function (id, direction) {
            if (!currentUser) return;

            try {
                // Get current item
                const { data: currentItem, error: fetchError } = await supabase
                    .from('master_data')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (fetchError) throw fetchError;

                // Find adjacent item
                let query = supabase
                    .from('master_data')
                    .select('*')
                    .eq('type', currentItem.type);

                if (currentItem.organization_id) {
                    query = query.eq('organization_id', currentItem.organization_id);
                } else {
                    query = query.is('organization_id', null);
                }

                if (direction === 'up') {
                    // Find item with smaller sort_order (closest)
                    query = query.lt('sort_order', currentItem.sort_order).order('sort_order', { ascending: false }).limit(1);
                } else {
                    // Find item with larger sort_order (closest)
                    query = query.gt('sort_order', currentItem.sort_order).order('sort_order', { ascending: true }).limit(1);
                }

                const { data: adjacentItems, error: adjError } = await query;

                if (adjError) throw adjError;

                if (adjacentItems.length === 0) return; // No item to swap with

                const adjacentItem = adjacentItems[0];

                // Swap sort_order
                const { error: update1 } = await supabase
                    .from('master_data')
                    .update({ sort_order: adjacentItem.sort_order })
                    .eq('id', currentItem.id);

                if (update1) throw update1;

                const { error: update2 } = await supabase
                    .from('master_data')
                    .update({ sort_order: currentItem.sort_order })
                    .eq('id', adjacentItem.id);

                if (update2) throw update2;

                loadMasterData();

            } catch (error) {
                console.error('Sort update error:', error);
                alert('並び順の更新に失敗しました');
            }
        }
        async function loadMasterOrganizations() {
            try {
                const { data: orgs, error } = await supabase
                    .from('organizations')
                    .select('id, name')
                    .order('name');

                if (error) throw error;

                const select = $('#master-filter-org');
                const currentVal = select.val();
                select.html('<option value="">全ての組織を表示</option>');

                if (orgs) {
                    orgs.forEach(org => {
                        select.append(`<option value="${org.id}">${org.name}</option>`);
                    });
                }
                if (currentVal) select.val(currentVal);
            } catch (e) {
                console.error('Failed to load organizations for filter:', e);
            }
        }

        window.loadMasterData = async function () {
            // 権限チェック
            if (!currentUser || !['super_admin', 'org_admin', 'admin'].includes(currentUser.role)) {
                alert('権限がありません');
                showPage('dashboard');
                return;
            }

            // スーパー管理者の場合、組織リストを表示・ロード
            if (currentUser.role === 'super_admin') {
                $('#master-org-filter-container').removeClass('hidden');
                // 既にロード済みでなければロード (optionが1つ以下なら)
                if ($('#master-filter-org option').length <= 1) {
                    await loadMasterOrganizations();
                }
            } else {
                $('#master-org-filter-container').addClass('hidden');
            }

            showLoading()
            try {
                let query = supabase
                    .from('master_data')
                    .select('*, organizations(name)')
                    .order('type', { ascending: true })
                    .order('sort_order', { ascending: true })

                const filterType = $('#master-filter-type').val()
                if (filterType) {
                    query = query.eq('type', filterType)
                }

                // 組織フィルタリング
                if (currentUser.role === 'super_admin') {
                    const orgFilter = $('#master-filter-org').val();
                    if (orgFilter) {
                        query = query.eq('organization_id', orgFilter);
                    }
                } else {
                    // 一般管理者: 自組織 または グローバル
                    query = query.or(`organization_id.eq.${currentUser.organization_id},organization_id.is.null`);
                }

                const { data: masters, error } = await query

                if (error) throw error

                const container = $('#master-data-container')
                container.empty()

                if (masters.length === 0) {
                    container.html('<p class="text-gray-500 text-center py-8">マスタデータがありません</p>')
                    return
                }

                const typeLabels = {
                    'employment_type': '雇用形態',
                    'job_category': '職種カテゴリ',
                    'industry_category': '業種カテゴリ',
                    'selection_status': '進捗ステータス'
                }

                const html = masters.map(m => {
                    const isGlobal = m.organization_id === null
                    const isMyOrg = m.organization_id === currentUser.organization_id
                    // スーパー管理者は全て編集可能。組織管理者は自組織のもののみ編集可能。
                    const canEdit = currentUser.role === 'super_admin' || (isMyOrg && ['org_admin', 'admin'].includes(currentUser.role))

                    let badge = ''
                    let orgName = ''

                    if (isGlobal) {
                        badge = '<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">グローバル</span>'
                    } else {
                        orgName = m.organizations ? m.organizations.name : 'Unknown Org';
                        if (isMyOrg) {
                            badge = `<span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded">自社用</span>`
                        } else {
                            badge = `<span class="px-2 py-1 bg-gray-100 text-gray-800 text-xs rounded">${orgName}</span>`
                        }
                    }

                    return `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 mb-3 flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            ${canEdit ? `
                            <div class="flex flex-col gap-1">
                                <button onclick="updateMasterSortOrder('${m.id}', 'up')" class="text-gray-400 hover:text-indigo-600 p-1 hover:bg-gray-100 rounded transition">
                                    <i class="fas fa-chevron-up text-xs"></i>
                                </button>
                                <button onclick="updateMasterSortOrder('${m.id}', 'down')" class="text-gray-400 hover:text-indigo-600 p-1 hover:bg-gray-100 rounded transition">
                                    <i class="fas fa-chevron-down text-xs"></i>
                                </button>
                            </div>
                            ` : ''}
                            <div>
                                <div class="flex items-center gap-3 mb-1">
                                    <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded">${typeLabels[m.type] || m.type}</span>
                                    <span class="font-bold text-gray-900">${m.label}</span>
                                    <span class="text-sm text-gray-500">(${m.value})</span>
                                    ${!m.is_active ? '<span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded">無効</span>' : ''}
                                    ${badge}
                                </div>
                                <div class="flex gap-2 text-xs text-gray-400">
                                    <span>表示順: ${m.sort_order}</span>
                                    ${m.organization_id ? `<span>組織: ${orgName}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            ${canEdit ? `
                            <button onclick='editMaster(${JSON.stringify(m).replace(/'/g, "&#39;")})' class="text-indigo-600 hover:text-indigo-800 text-sm px-3 py-1">
                                <i class="fas fa-edit mr-1"></i>編集
                            </button>
                            <button onclick="deleteMaster('${m.id}')" class="text-red-600 hover:text-red-800 text-sm px-3 py-1">
                                <i class="fas fa-trash mr-1"></i>削除
                            </button>
                            ` : `
                            <span class="text-gray-400 text-xs px-3 py-1"><i class="fas fa-lock mr-1"></i>編集不可</span>
                            `}
                        </div>
                    </div>
                `}).join('')

                container.html(html)
            } catch (error) {
                console.error('Load master data error:', error)
                $('#master-data-container').html('<p class="text-red-500">マスタデータの読み込みに失敗しました</p>')
            } finally {
                hideLoading()
            }
        }

        window.showMasterForm = function () {
            $('#master-modal-title').text('マスタデータ作成')
            $('#master-form')[0].reset()
            $('#master-id').val('')
            $('#master-organization-id').val('')
            $('#master-is-active').prop('checked', true)

            // Global option
            if (currentUser.role === 'super_admin') {
                $('#master-is-global-container').show()
                $('#master-is-global').prop('checked', false)
            } else {
                $('#master-is-global-container').hide()
                $('#master-is-global').prop('checked', false)
            }

            $('#master-modal').removeClass('hidden')
        }

        window.editMaster = function (master) {
            $('#master-modal-title').text('マスタデータ編集')
            $('#master-id').val(master.id)
            $('#master-organization-id').val(master.organization_id || '')
            $('#master-type').val(master.type)
            $('#master-label').val(master.label)
            $('#master-value').val(master.value)
            $('#master-sort').val(master.sort_order)
            $('#master-is-active').prop('checked', master.is_active)

            const isGlobal = master.organization_id === null
            $('#master-is-global').prop('checked', isGlobal)

            // Global option visibility
            if (currentUser.role === 'super_admin') {
                $('#master-is-global-container').show()
            } else {
                $('#master-is-global-container').hide()
            }

            $('#master-modal').removeClass('hidden')
        }

        window.closeMasterModal = function () {
            $('#master-modal').addClass('hidden')
            $('#master-form')[0].reset()
        }

        window.deleteMaster = async function (id) {
            if (!confirm('本当に削除しますか？')) return

            showLoading()
            try {
                const { error } = await supabase
                    .from('master_data')
                    .delete()
                    .eq('id', id)

                if (error) throw error
                loadMasterData()
            } catch (error) {
                console.error('Delete master error:', error)
                alert('削除に失敗しました: ' + error.message)
            } finally {
                hideLoading()
            }
        }

        $('#master-form').on('submit', async function (e) {
            e.preventDefault()
            showLoading()

            const id = $('#master-id').val()
            const isGlobal = $('#master-is-global').is(':checked')

            // Logic for organization_id
            // Logic for organization_id
            let orgId = null
            if (currentUser.role === 'super_admin') {
                if (isGlobal) {
                    orgId = null
                } else {
                    const currentOrgId = $('#master-organization-id').val()
                    const filterOrgId = $('#master-filter-org').val()

                    if (id && currentOrgId) {
                        // 編集時かつ、元々組織IDがある場合は維持
                        orgId = currentOrgId
                    } else if (filterOrgId && !id) { // 新規作成時でフィルタがある場合
                        orgId = filterOrgId
                    } else if (!id) {
                        // 新規作成時でフィルタもない場合、とりあえず自組織（これは運用によるが）
                        orgId = currentUser.organization_id
                    } else {
                        // 編集時だが元がGlobalだった場合で、Globalチェックを外したケースなど
                        // -> ここは難しいが、一旦自ユニーク組織IDにするか、エラーにするか。
                        // 現状は自組織IDにする
                        orgId = currentUser.organization_id
                    }
                }
            } else {
                orgId = currentUser.organization_id
            }

            const data = {
                type: $('#master-type').val(),
                label: $('#master-label').val(),
                value: $('#master-value').val(),
                sort_order: parseInt($('#master-sort').val()) || 0,
                is_active: $('#master-is-active').is(':checked'),
                organization_id: orgId,
                updated_at: new Date().toISOString()
            }

            try {
                if (id) {
                    const { error } = await supabase
                        .from('master_data')
                        .update(data)
                        .eq('id', id)
                    if (error) throw error
                } else {
                    const { error } = await supabase
                        .from('master_data')
                        .insert(data)
                    if (error) throw error
                }

                closeMasterModal()
                loadMasterData()
            } catch (error) {
                console.error('Save master error:', error)
                alert('保存に失敗しました: ' + error.message)
            } finally {
                hideLoading()
            }
        })
        async function loadNotifications() {
            if (!currentUser) return

            try {
                const { data: notifications, error } = await supabase
                    .from('notifications')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(10)

                if (error) throw error

                const unreadCount = notifications.filter(n => !n.read).length

                if (unreadCount > 0) {
                    $('#notification-badge').text(unreadCount).removeClass('hidden')
                } else {
                    $('#notification-badge').addClass('hidden')
                }

                renderNotifications(notifications)
            } catch (error) {
                console.error('Load notifications error:', error)
            }
        }

        function renderNotifications(notifications) {
            const container = $('#notification-list')
            container.empty()

            if (notifications.length === 0) {
                container.html('<p class="p-4 text-gray-500 text-center text-sm">通知はありません</p>')
                return
            }

            const html = notifications.map(notif => `
                <div class="p-4 border-b hover:bg-gray-50 cursor-pointer ${notif.read ? 'bg-white' : 'bg-blue-50'}" onclick="markAsRead('${notif.id}')">
                    <div class="flex justify-between items-start mb-1">
                        <h4 class="font-medium text-sm">${notif.title}</h4>
                        ${!notif.read ? '<span class="w-2 h-2 bg-blue-500 rounded-full"></span>' : ''}
                    </div>
                    <p class="text-xs text-gray-600">${notif.message}</p>
                    <p class="text-xs text-gray-400 mt-1">${new Date(notif.created_at).toLocaleString('ja-JP')}</p>
                </div>
            `).join('')

            container.html(html)
        }

        window.markAsRead = async function (notificationId) {
            try {
                await supabase
                    .from('notifications')
                    .update({ read: true })
                    .eq('id', notificationId)

                loadNotifications()
            } catch (error) {
                console.error('Mark as read error:', error)
            }
        }

        // ========================
        // PDF & AI Analysis
        // ========================
        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer()
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise
            let fullText = ''

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i)
                const textContent = await page.getTextContent()
                const pageText = textContent.items.map(item => item.str).join(' ')
                fullText += pageText + '\n'
            }

            return fullText
        }

        async function analyzeDocumentWithAI(text, type, options = {}) {
            // Edge Function 'analyze-document' を呼び出す
            // type: 'resume' | 'job_description'
            const { data, error } = await supabase.functions.invoke('analyze-document', {
                body: { text, type, options }
            })

            if (error) throw error
            return data
        }

        // 文字列の類似度を計算（レーベンシュタイン距離ベース）
        function calculateSimilarity(str1, str2) {
            if (!str1 || !str2) return 0;

            const s1 = str1.toLowerCase().trim();
            const s2 = str2.toLowerCase().trim();

            // 完全一致
            if (s1 === s2) return 1.0;

            // 部分一致チェック
            if (s1.includes(s2) || s2.includes(s1)) return 0.8;

            // レーベンシュタイン距離を計算
            const matrix = [];
            for (let i = 0; i <= s1.length; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= s2.length; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= s1.length; i++) {
                for (let j = 1; j <= s2.length; j++) {
                    if (s1.charAt(i - 1) === s2.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }

            const distance = matrix[s1.length][s2.length];
            const maxLength = Math.max(s1.length, s2.length);
            return 1 - (distance / maxLength);
        }

        // マスタ値から最も類似した値を見つける
        function findClosestMasterValue(extractedValue, masterValues) {
            if (!extractedValue || !masterValues || masterValues.length === 0) {
                return null;
            }

            let bestMatch = null;
            let bestScore = 0;

            for (const masterValue of masterValues) {
                const score = calculateSimilarity(extractedValue, masterValue);
                if (score > bestScore) {
                    bestScore = score;
                    bestMatch = masterValue;
                }
            }

            // 類似度が0.3以上の場合のみ採用（あまりにも違う場合は null を返す）
            return bestScore >= 0.3 ? bestMatch : null;
        }

        window.handleResumeUpload = async function (input) {
            if (input.files.length === 0) return

            if (!confirm('PDFを解析してプロフィールに自動入力しますか？\n※既存の入力内容は上書きされます。')) {
                input.value = ''
                return
            }

            showLoading()
            try {
                let combinedText = ''
                for (let i = 0; i < input.files.length; i++) {
                    const text = await extractTextFromPDF(input.files[i])
                    combinedText += `--- File ${i + 1} ---\n${text}\n`
                }

                let result = await analyzeDocumentWithAI(combinedText, 'resume');

                // 配列で返ってきた場合は最初の要素を使う
                if (Array.isArray(result)) {
                    result = result[0] || {};
                }

                console.log('Resume Analysis Result:', result);

                // --- フォームへの反映 ---

                // 名前はreadonlyだが、ふりがななどは反映
                if (result.furigana || result.kana) $('#profile-furigana').val(result.furigana || result.kana);
                if (result.email) $('#profile-email').val(result.email);
                if (result.phone) $('#profile-phone').val(result.phone);
                if (result.age) $('#profile-age').val(result.age);

                // 学歴
                if (result.education || result.academic_background) {
                    $('#profile-academic').val(result.education || result.academic_background);
                }

                // スキル
                if (result.skills) {
                    $('#profile-skills').val(result.skills);
                }

                // 職歴概要
                if (result.work_history) {
                    $('#profile-history').val(result.work_history);
                }

                // 職務経歴 (詳細テキスト)
                if (result.work_history_detail) {
                    $('#profile-work-history-detail').val(result.work_history_detail);
                }

                // 推定年収 (万円単位)
                if (result.current_salary) {
                    $('#profile-current-salary').val(result.current_salary / 10000);
                }

                // 構造化された職歴 (詳細職歴)
                if (result.work_history_structured && Array.isArray(result.work_history_structured)) {
                    $('#profile-work-history-list').empty();
                    result.work_history_structured.forEach(item => addWorkHistoryItemToContainer('#profile-work-history-list', item));
                    updateJobChangeCountInContainer('#profile-work-history-list', '#profile-job-change-count');
                }

                // マスタデータとのマッチング (職種・業界)
                if (result.desired_job_type) {
                    const extractedJobs = [result.desired_job_type].flat().filter(Boolean);
                    const matchedJobs = [];
                    extractedJobs.forEach(val => {
                        const match = findClosestMasterValue(val, masterJobCategories);
                        if (match && !matchedJobs.includes(match)) matchedJobs.push(match);
                    });
                    if (matchedJobs.length > 0) {
                        $('#profile-job-type').val(matchedJobs).trigger('change');
                    }
                }

                if (result.desired_industry) {
                    const extractedIndustries = [result.desired_industry].flat().filter(Boolean);
                    const matchedIndustries = [];
                    extractedIndustries.forEach(val => {
                        const match = findClosestMasterValue(val, masterIndustries);
                        if (match && !matchedIndustries.includes(match)) matchedIndustries.push(match);
                    });
                    if (matchedIndustries.length > 0) {
                        $('#profile-industry').val(matchedIndustries).trigger('change');
                    }
                }

                alert('PDFの解析が完了しました。\n内容を確認・修正した上で保存してください。');
            } catch (error) {
                console.error('Resume analysis error:', error)
                alert('解析に失敗しました: ' + error.message)
            } finally {
                hideLoading()
                input.value = ''
            }
        }

        window.handleJobPdfUpload = async function (input) {
            if (input.files.length === 0) return

            const fileCount = input.files.length;
            const confirmMsg = fileCount > 1
                ? `${fileCount}件のPDFファイルを処理します。\nそれぞれ解析し、個別の求人として登録しますか？`
                : 'PDFを解析して求人フォームに自動入力しますか？\n※既存の入力内容は上書きされます。';

            if (!confirm(confirmMsg)) {
                input.value = ''
                return
            }

            // 複数ファイルの場合は、フォーム入力ではなく直接登録フローにする
            const isBulkMode = fileCount > 1;

            showLoading('PDFを解析中...')
            try {
                let successCount = 0;
                let skipCount = 0;

                // マスタデータの準備
                const options = {
                    job_categories: typeof masterJobCategories !== 'undefined' ? masterJobCategories : [],
                    industry_categories: typeof masterIndustries !== 'undefined' ? masterIndustries : []
                };

                for (let i = 0; i < fileCount; i++) {
                    const file = input.files[i];

                    // 進捗表示
                    console.log(`Processing file ${i + 1}/${fileCount}: ${file.name}`);

                    const text = await extractTextFromPDF(file);
                    console.log(`Extracted text length: ${text.length} characters`);

                    if (!text || text.trim().length === 0) {
                        alert(`ファイル「${file.name}」からテキストを抽出できませんでした。スキャン画像PDFの可能性があります。`);
                        skipCount++;
                        continue;
                    }

                    let result = await analyzeDocumentWithAI(text, 'job_description', options);

                    if (Array.isArray(result)) {
                        result = result[0] || {};
                    }

                    // 必須項目のチェック
                    if (!result.title || !result.company) {
                        alert(`ファイル「${file.name}」から求人タイトルまたは会社名を取得できませんでした。スキップします。`);
                        skipCount++;
                        continue;
                    }

                    // 重複チェック
                    let isDuplicate = false;
                    const { data: duplicates } = await supabase
                        .from('jobs')
                        .select('id, title, company')
                        .eq('organization_id', currentUser.organization_id)
                        .ilike('company', `%${result.company}%`)
                        .ilike('title', `%${result.title}%`)
                        .neq('status', 'closed');

                    if (duplicates && duplicates.length > 0) {
                        isDuplicate = true;
                        const dupMsg = `⚠️ 重複の可能性があります（ファイル: ${file.name}）\n\n既存の求人:\n${duplicates.map(d => `・${d.company} / ${d.title}`).join('\n')}`;
                        if (!confirm(`${dupMsg}\n\nそれでも登録しますか？`)) {
                            skipCount++;
                            continue;
                        }
                    }

                    // 会社名の解決（既存検索 or 新規作成）
                    let companyId = null;
                    const { data: existingCompany } = await supabase
                        .from('companies')
                        .select('id')
                        .eq('organization_id', currentUser.organization_id)
                        .eq('name', result.company)
                        .single();

                    if (existingCompany) {
                        companyId = existingCompany.id;
                    } else {
                        // 新規作成
                        if (isBulkMode || confirm(`企業「${result.company}」は未登録です。\n新規登録しますか？`)) {
                            const { data: newCompany, error: createError } = await supabase
                                .from('companies')
                                .insert({
                                    organization_id: currentUser.organization_id,
                                    name: result.company,
                                    location: result.location // 求人の場所を企業の場所として一旦登録
                                })
                                .select()
                                .single();

                            if (createError) {
                                console.error('Company creation error:', createError);
                                alert(`企業「${result.company}」の作成に失敗しました。スキップします。`);
                                skipCount++;
                                continue;
                            }
                            companyId = newCompany.id;
                        } else {
                            skipCount++;
                            continue;
                        }
                    }

                    if (isBulkMode) {
                        // 一括モード：確認して保存
                        const jobData = {
                            organization_id: currentUser.organization_id,
                            title: result.title,
                            company_id: companyId, // IDで紐付け
                            company: result.company, // Legacy
                            location: result.location || '未定',
                            salary_min: result.salary_min || null,
                            salary_max: result.salary_max || null,
                            description: result.description || '',
                            requirements: result.requirements || '',
                            welcome_requirements: result.welcome_requirements || '',
                            work_hours: result.work_hours || null,
                            holidays: result.holidays || null,
                            benefits: result.benefits || null,
                            interview_process: result.interview_process || null,
                            employment_type: result.employment_type || '正社員',
                            is_remote: result.is_remote || false,
                            job_experience_ok: result.job_experience_ok ? '可' : '不可',
                            industry_experience_ok: result.industry_experience_ok ? '可' : '不可',
                            job_category: result.job_category || null,
                            industry_category: result.industry_category || null,
                            status: 'active'
                        };

                        // 確認ダイアログ
                        const confirmSave = confirm(`【${i + 1}/${fileCount}】以下の内容で登録しますか？\n\n会社名: ${result.company}\nタイトル: ${jobData.title}\n勤務地: ${jobData.location}\n年収: ${jobData.salary_min ? jobData.salary_min / 10000 + '万' : '-'} ~ ${jobData.salary_max ? jobData.salary_max / 10000 + '万' : '-'}\n職種: ${jobData.job_category || '-'}\n業界: ${jobData.industry_category || '-'}`);

                        if (confirmSave) {
                            const { error } = await supabase.from('jobs').insert(jobData);
                            if (error) throw error;
                            successCount++;
                        } else {
                            skipCount++;
                        }

                    } else {
                        // 単一ファイルモード：フォームに入力
                        // フォームのセレクトボックスを更新して選択状態にする
                        const select = $('#job-company-select');
                        if (select.find(`option[value="${companyId}"]`).length === 0) {
                            select.append(`<option value="${companyId}">${result.company}</option>`);
                        }
                        select.val(companyId);
                        $('#job-company-id').val(companyId);

                        if (isDuplicate) {
                            alert(`⚠️ 重複の可能性があります！\n\n既存の求人:\n${duplicates.map(d => `・${d.company} / ${d.title}`).join('\n')}\n\n入力を続行しますが、内容を確認してください。`);
                        }

                        $('#job-title').val(result.title);
                        // $('#job-company').val(result.company); // 不要
                        $('#job-location').val(result.location);
                        if (result.salary_min) $('#job-salary-min').val(result.salary_min / 10000);
                        if (result.salary_max) $('#job-salary-max').val(result.salary_max / 10000);
                        $('#job-description').val(result.description);
                        $('#job-requirements').val(result.requirements);
                        $('#job-welcome-requirements').val(result.welcome_requirements);

                        $('#job-work-hours').val(result.work_hours);
                        $('#job-holidays').val(result.holidays);
                        $('#job-benefits').val(result.benefits);
                        $('#job-interview-process').val(result.interview_process);

                        if (result.employment_type) $('#job-employment-type').val(result.employment_type);

                        if (result.is_remote !== undefined) $('#job-is-remote').prop('checked', result.is_remote);
                        if (result.job_experience_ok !== undefined) $('#job-experience-ok').prop('checked', result.job_experience_ok);
                        if (result.industry_experience_ok !== undefined) $('#job-industry-experience-ok').prop('checked', result.industry_experience_ok);

                        // カテゴリのセット（マスタ値から最も近い値を選択）
                        if (result.job_category) {
                            const closestJobCategory = findClosestMasterValue(result.job_category, masterJobCategories);
                            if (closestJobCategory) {
                                $('#job-category').val(closestJobCategory);
                            }
                        }
                        if (result.industry_category) {
                            const closestIndustryCategory = findClosestMasterValue(result.industry_category, masterIndustries);
                            if (closestIndustryCategory) {
                                $('#job-industry-category').val(closestIndustryCategory);
                            }
                        }

                        alert('解析が完了しました。内容を確認してください。');
                    }
                }

                if (isBulkMode) {
                    alert(`処理完了\n登録: ${successCount}件\nスキップ: ${skipCount}件`);
                    closeJobModal();
                    loadJobs(); // リスト更新
                }

            } catch (error) {
                console.error('Job analysis error:', error)
                alert('解析処理中にエラーが発生しました: ' + error.message)
            } finally {
                hideLoading()
                input.value = ''
            }
        }



        // Dashboard
        // ========================
        let dashboardChartInstances = {};
        let currentDashboardPeriod = 'month';

        async function loadDashboard() {
            if (!currentUser) return

            // ユーザー情報を表示
            $('#user-name').text(currentUser.name)
            $('#user-role').text(getRoleLabel(currentUser.role))
            $('#org-name').text(currentUser.organizations?.name || '')
            $('#org-code-display').text(currentUser.organizations?.code ? `コード: ${currentUser.organizations.code}` : '')

            const contentArea = $('#dashboard-content');
            contentArea.empty(); // 全体をクリアして再構築

            // 1. KPI Stats Area
            const statsGrid = $('<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" id="dashboard-stats"></div>');
            contentArea.append(statsGrid);

            // 2. Charts Area (Agent only)
            const isAgent = ['super_admin', 'org_admin', 'admin', 'coach', 'ca', 'ra'].includes(currentUser.role);
            if (isAgent) {
                const controlsHtml = `
                    <div class="flex flex-wrap justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800"><i class="fas fa-chart-line mr-2"></i>進捗・歩留まり分析</h3>
                        <div class="flex gap-2 bg-gray-100 p-1 rounded-lg">
                            <button onclick="changeDashboardPeriod('day')" class="px-4 py-1 rounded-md text-sm font-medium transition ${currentDashboardPeriod === 'day' ? 'bg-white text-indigo-600 shadow' : 'text-gray-500 hover:text-gray-700'}">日次</button>
                            <button onclick="changeDashboardPeriod('week')" class="px-4 py-1 rounded-md text-sm font-medium transition ${currentDashboardPeriod === 'week' ? 'bg-white text-indigo-600 shadow' : 'text-gray-500 hover:text-gray-700'}">週次</button>
                            <button onclick="changeDashboardPeriod('month')" class="px-4 py-1 rounded-md text-sm font-medium transition ${currentDashboardPeriod === 'month' ? 'bg-white text-indigo-600 shadow' : 'text-gray-500 hover:text-gray-700'}">月次</button>
                            <button onclick="changeDashboardPeriod('year')" class="px-4 py-1 rounded-md text-sm font-medium transition ${currentDashboardPeriod === 'year' ? 'bg-white text-indigo-600 shadow' : 'text-gray-500 hover:text-gray-700'}">年次</button>
                        </div>
                    </div>
                `;
                contentArea.append(controlsHtml);

                const chartGrid = $(`
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8" id="dashboard-charts">
                        <div class="bg-white rounded-lg shadow p-6">
                            <h4 class="font-bold text-gray-700 mb-4">工程別 歩留まり (ファネル)</h4>
                            <canvas id="funnelChart"></canvas>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <h4 class="font-bold text-gray-700 mb-4">累積推移 (トレンド)</h4>
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                `);
                contentArea.append(chartGrid);
            }

            // Load Data & Render
            try {
                // --- KPI Cards Logic (Same as before) ---
                if (['super_admin', 'org_admin', 'admin'].includes(currentUser.role)) {
                    const { count: jobCount } = await supabase.from('jobs').select('*', { count: 'exact', head: true }).eq('organization_id', currentUser.organization_id).eq('status', 'active');
                    const { count: userCount } = await supabase.from('users').select('*', { count: 'exact', head: true }).eq('organization_id', currentUser.organization_id).eq('role', 'user');
                    const { count: appCount } = await supabase.from('applications').select('*', { count: 'exact', head: true }).eq('organization_id', currentUser.organization_id);

                    renderDashboardCards(statsGrid, [
                        { label: '有効求人件数', value: jobCount || 0, icon: 'fa-briefcase', color: 'indigo' },
                        { label: '登録求職者数', value: userCount || 0, icon: 'fa-users', color: 'green' },
                        { label: '総応募数', value: appCount || 0, icon: 'fa-file-alt', color: 'purple' }
                    ]);
                } else if (['coach', 'ca', 'ra'].includes(currentUser.role)) {
                    const { data: assignedUsers } = await supabase.from('users').select('id').eq('coach_id', currentUser.id);
                    const assignedUserIds = assignedUsers?.map(u => u.id) || [];
                    let candidateAppCount = 0;
                    if (assignedUserIds.length > 0) {
                        const { count } = await supabase.from('applications').select('*', { count: 'exact', head: true }).in('user_id', assignedUserIds);
                        candidateAppCount = count || 0;
                    }
                    const { count: aiRecoCount } = await supabase.from('recommendations').select('*', { count: 'exact', head: true }).eq('created_by', currentUser.id);
                    renderDashboardCards(statsGrid, [
                        { label: '担当求職者数', value: assignedUserIds.length, icon: 'fa-user-friends', color: 'indigo' },
                        { label: '担当者の応募数', value: candidateAppCount, icon: 'fa-file-contract', color: 'green' },
                        { label: 'AI推薦実施数', value: aiRecoCount || 0, icon: 'fa-robot', color: 'pink' }
                    ]);
                } else {
                    const { count: appCount } = await supabase.from('applications').select('*', { count: 'exact', head: true }).eq('user_id', currentUser.id);
                    const { count: recoCount } = await supabase.from('recommendations').select('*', { count: 'exact', head: true }).eq('user_id', currentUser.id);
                    renderDashboardCards(statsGrid, [
                        { label: '応募中の求人', value: appCount || 0, icon: 'fa-file-alt', color: 'indigo' },
                        { label: 'あなたへのAI推薦', value: recoCount || 0, icon: 'fa-star', color: 'purple' },
                        { label: '閲覧した求人', value: '-', icon: 'fa-eye', color: 'gray' }
                    ]);
                }

                // --- Charts Rendering Logic ---
                if (isAgent) {
                    await renderDashboardCharts();
                }

            } catch (error) {
                console.error('Dashboard load error:', error);
                statsGrid.html('<p class="col-span-3 text-red-500 text-center py-4">データの読み込みに失敗しました</p>');
            }
        }

        window.changeDashboardPeriod = (period) => {
            currentDashboardPeriod = period;
            loadDashboard(); // Reload (Optimally should only reload charts, but strict implementation needs clean state)
        };

        async function renderDashboardCharts() {
            // 既存チャートの破棄
            if (dashboardChartInstances.funnel) dashboardChartInstances.funnel.destroy();
            if (dashboardChartInstances.trend) dashboardChartInstances.trend.destroy();

            // Safety Check
            if (typeof Chart === 'undefined') {
                console.error('Dashboard: Chart.js library is not loaded');
                return;
            }
            if (!document.getElementById('funnelChart') || !document.getElementById('trendChart')) {
                console.error('Dashboard: Chart canvas elements not found');
                return;
            }

            // 1. マスタデータ取得 (進捗ステータス)
            let { data: statusMasters } = await supabase
                .from('master_data')
                .select('*')
                .eq('type', 'application_status')
                .order('sort_order', { ascending: true });

            // マスタがない場合のフォールバック
            if (!statusMasters || statusMasters.length === 0) {
                statusMasters = [
                    { label: '書類選考', value: '書類選考中', sort_order: 10 },
                    { label: '一次面接', value: '一次面接予定', sort_order: 40 },
                    { label: '二次面接', value: '二次面接予定', sort_order: 60 },
                    { label: '最終面接', value: '最終面接予定', sort_order: 80 },
                    { label: '内定', value: '内定', sort_order: 100 }
                ];
            }
            // 組織フィルタ・グローバル除外などのロジックは簡易化（全取得済データを使用）
            // 組織IDでフィルタリングする場合は .eq('organization_id', currentUser.organization_id) 必要だが、
            // 上記クエリではグローバルも取ってくる必要があるので、JS側でフィルタが安全。
            statusMasters = statusMasters.filter(m => m.organization_id === currentUser.organization_id || m.is_global);


            // 2. 応募データ取得 (全量取得してJS集計 - データ量が多い場合はRPC推奨)
            // 'created_at' does not exist in applications table, using 'applied_at' instead.
            let query = supabase.from('applications').select('applied_at, status, updated_at');

            if (currentUser.role === 'coach' || currentUser.role === 'ca') {
                // コーチの場合は担当ユーザーのみ
                const { data: assignedUsers } = await supabase.from('users').select('id').eq('coach_id', currentUser.id);
                const ids = assignedUsers?.map(u => u.id) || [];
                if (ids.length > 0) query = query.in('user_id', ids);
                else query = query.eq('id', '00000000-0000-0000-0000-000000000000'); // No hits
            } else {
                query = query.eq('organization_id', currentUser.organization_id);
            }

            // 期間フィルタ
            const now = new Date();
            let startDate = new Date();
            if (currentDashboardPeriod === 'day') startDate.setDate(now.getDate() - 7); // 直近7日
            else if (currentDashboardPeriod === 'week') startDate.setMonth(now.getMonth() - 1); // 直近4週
            else if (currentDashboardPeriod === 'month') startDate.setMonth(now.getMonth() - 6); // 直近6ヶ月
            else if (currentDashboardPeriod === 'year') startDate.setFullYear(now.getFullYear() - 1); // 直近1年

            query = query.gte('applied_at', startDate.toISOString());

            const { data: applications, error } = await query;

            if (error) {
                console.error('Dashboard: Applications fetch error:', error);
                $('#dashboard-charts').prepend('<div class="col-span-2 text-red-500 bg-red-50 p-4 rounded">データ取得エラー: ' + error.message + '</div>');
                // エラー詳細メッセージのヒントを追加
                if (error.code === '42703') { // Undefined column
                    $('#dashboard-charts').prepend('<div class="col-span-2 text-yellow-600 bg-yellow-50 p-2 rounded text-sm mt-2">ヒント: カラムが存在しない可能性があります。DBスキーマを確認してください。</div>');
                }
                return;
            }

            if (!applications || applications.length === 0) {
                console.log('Dashboard: No applications data found for this period');
                // データがない場合でも空のチャートを表示するか、メッセージを表示する
                // ここでは処理を続行して空のチャートを表示させる（0件の確認のため）
            } else {
                console.log('Dashboard: Applications loaded:', applications.length);
            }

            // 安全策: nullの場合は空配列にする
            const validApplications = applications || [];

            // --- 集計ロジック ---

            // A. ファネル集計 (単純なステータスカウントからの累積推計)
            // ステータスのsort_order順に並べる
            statusMasters.sort((a, b) => a.sort_order - b.sort_order);

            // ステータスごとの件数
            const statusCounts = {};
            validApplications.forEach(app => {
                // 部分一致などで柔軟にマッチング
                const match = statusMasters.find(m => app.status === m.value || app.status?.includes(m.value));
                const key = match ? match.label : 'その他';
                statusCounts[key] = (statusCounts[key] || 0) + 1;
            });

            // 累積計算 (簡易ロジック: sort_orderが後ろのものは前のものも通過したと仮定)
            // ※注意: '不合格' '辞退' などのネガティブステータスを除外するか、それらを '到達した最高フェーズ' として扱うか。
            // ここではシンプルに主要フェーズを表示対象とする。
            const displayPhases = statusMasters.filter(m => m.sort_order <= 120); // 入社確認まで
            const funnelLabels = displayPhases.map(m => m.label);
            const funnelData = displayPhases.map((phase, idx) => {
                // このフェーズ以降のすべてのステータスの合計 (このフェーズに到達した総数)
                // 実際には「不合格」なども考慮すべきだが、不合格ステータスのsort_orderが200番台なら、
                // 書類不合格(200)は書類通過(30)に含まれない。
                // 簡易的に「累積」としてチャートにする。

                // ここでは「現在そのステータスにある数」をまず出す
                // const count = applications.filter(a => a.status === phase.value).length;
                // return count;

                // 要件は「工程ごとの歩留まり」なので、「通過数」ベースが望ましい。
                // 簡易ロジック: sort_orderが自分以上のレコード数を合計する
                const passedCount = validApplications.filter(a => {
                    const m = statusMasters.find(mst => mst.value === a.status);
                    return m && m.sort_order >= phase.sort_order;
                }).length;
                return passedCount;
            });

            // 歩留まり率計算 (直前と比較)
            // const yieldRates = funnelData.map((val, i) => i === 0 ? '100%' : Math.round((val / funnelData[i-1])*100) + '%');

            dashboardChartInstances.funnel = new Chart(document.getElementById('funnelChart'), {
                type: 'bar',
                data: {
                    labels: funnelLabels,
                    datasets: [{
                        label: '到達数(累積)',
                        data: funnelData,
                        backgroundColor: 'rgba(79, 70, 229, 0.6)',
                        borderColor: 'rgb(79, 70, 229)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterLabel: function (context) {
                                    const val = context.raw;
                                    const prev = context.dataset.data[context.dataIndex - 1]; // 前のフェーズ
                                    if (context.dataIndex === 0 || !prev) return '開始';
                                    const rate = Math.round((val / prev) * 100);
                                    return `歩留まり: ${rate}%`;
                                }
                            }
                        }
                    }
                }
            });

            // B. トレンド集計 (月次/週次 推移)
            // 期間ごとのラベル生成
            const trendLabels = [];
            const trendDataMap = { 'all': [] }; // 総応募数推移
            // 主要フェーズごとの推移も出したいが、ログがないので「いつ変わったか」不明。
            // したがってトレンドは「応募発生日ベースの応募数」のみ正確に出せる。

            // 単位ごとの集計
            const dateMap = {};
            validApplications.forEach(app => {
                // Use applied_at for date calculation
                const d = new Date(app.applied_at || app.updated_at); // Fallback to updated_at if applied_at is null
                let key = '';
                if (currentDashboardPeriod === 'day') key = `${d.getMonth() + 1}/${d.getDate()}`;
                else if (currentDashboardPeriod === 'week') {
                    // 週番号など (簡易的に月/週)
                    const week = Math.ceil(d.getDate() / 7);
                    key = `${d.getMonth() + 1}月第${week}週`;
                }
                else if (currentDashboardPeriod === 'month') key = `${d.getFullYear()}/${d.getMonth() + 1}`;
                else if (currentDashboardPeriod === 'year') key = `${d.getFullYear()}`;

                dateMap[key] = (dateMap[key] || 0) + 1;
            });

            // 時間順にソートして配列化
            const sortedKeys = Object.keys(dateMap).sort(); // 文字列ソートだがYYYY/MM系なら概ねOK
            // ※日付順ソートは厳密にはDateパースが必要だが省略

            dashboardChartInstances.trend = new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: {
                    labels: sortedKeys,
                    datasets: [{
                        label: '新規応募数',
                        data: sortedKeys.map(k => dateMap[k]),
                        borderColor: 'rgb(16, 185, 129)',
                        tension: 0.1,
                        fill: true,
                        backgroundColor: 'rgba(16, 185, 129, 0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // ダッシュボードカード描画ヘルパー関数 (変更なし)
        function renderDashboardCards(container, cards) {
            const html = cards.map(c => `
                <div class="bg-white rounded-lg shadow p-6 transform transition hover:-translate-y-1 duration-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">${c.label}</p>
                            <p class="text-3xl font-bold text-${c.color}-600 mt-2">${c.value}</p>
                        </div>
                        <div class="w-12 h-12 bg-${c.color}-100 rounded-full flex items-center justify-center">
                            <i class="fas ${c.icon} text-${c.color}-600 text-xl"></i>
                        </div>
                    </div>
                </div>
            `).join('');

            container.html(html);
        }



        // ========================
        // Event Handlers
        // ========================
        // ========================
        // 対象ユーザー選択機能
        // ========================
        // 求職者選択モーダル関連
        // ========================

        window.openCandidateSelectionModal = async function () {
            if (allCandidateUsers.length === 0) {
                await loadCandidateUsers();
            }
            renderModalCandidateList();
            $('#candidate-selection-modal').removeClass('hidden');
        };

        window.closeCandidateSelectionModal = function () {
            $('#candidate-selection-modal').addClass('hidden');
        };

        function renderModalCandidateList(filter = '') {
            const container = $('#modal-candidate-list');
            const users = allCandidateUsers.filter(u =>
                u.name.toLowerCase().includes(filter.toLowerCase()) ||
                (u.email && u.email.toLowerCase().includes(filter.toLowerCase()))
            );

            if (users.length === 0) {
                container.html('<p class="text-center py-4 text-gray-500 text-sm">該当するユーザーはいません</p>');
                return;
            }

            const html = users.map(u => `
                <div onclick="selectCandidateFromModal('${u.id}', '${escapeHtml(u.name)}', '${escapeHtml(u.email)}')"
                    class="p-3 bg-white border rounded hover:border-indigo-500 hover:bg-indigo-50 cursor-pointer transition-colors flex justify-between items-center">
                    <div>
                        <div class="font-bold text-gray-900">${u.name}</div>
                        <div class="text-xs text-gray-500">${u.email || ''}</div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300"></i>
                </div>
            `).join('');
            container.html(html);
        }

        $('#modal-candidate-search').on('input', function () {
            renderModalCandidateList($(this).val());
        });

        window.selectCandidateFromModal = function (userId, userName, userEmail) {
            selectTargetUser(userId, userName, userEmail);
            closeCandidateSelectionModal();

            // 少し待ってから本来の紹介モーダルを開く
            if (currentRecommendJobId) {
                setTimeout(() => {
                    openRecommendJobModal(currentRecommendJobId);
                }, 100);
            }
        };

        function escapeHtml(str) {
            if (!str) return '';
            return str
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // 候補ユーザーリストを読み込む
        async function loadCandidateUsers() {
            if (!window.currentUser) return; // currentUserがない場合は何もしない

            try {
                let query = supabase
                    .from('users')
                    .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                    .eq('organization_id', window.currentUser.organization_id)
                    .in('role', ['candidate', 'user'])
                    .order('name', { ascending: true });

                // コーチの場合は担当ユーザーのみに絞り込み
                if (window.currentUser.role === 'coach') {
                    query = query.eq('coach_id', window.currentUser.id);
                }

                const { data: users, error } = await query;

                if (error) throw error;

                // フラット化 (candidate_profilesの中身をトップレベルにマージ)
                const flattenedUsers = (users || []).map(u => {
                    const profile = Array.isArray(u.candidate_profiles) ? u.candidate_profiles[0] : u.candidate_profiles;
                    const combined = { ...u, ...profile };
                    // IDはusersのものを優先
                    combined.id = u.id;
                    return combined;
                });

                allCandidateUsers = flattenedUsers;
                targetUsersCache = flattenedUsers; // 既存ロジックとの互換性のため
                shouldReloadCandidates = false; // キャッシュ更新完了
                console.log('Loaded candidate users:', allCandidateUsers.length);
            } catch (error) {
                console.error('Failed to load candidate users:', error);
            }
        }

        // ユーザーをフィルタリングしてドロップダウンに表示
        function filterAndShowTargetUsers(searchTerm) {
            const filtered = allCandidateUsers.filter(user => {
                if (user.status === 'suspended') return false;
                const name = (user.name || '').toLowerCase();
                const email = (user.email || '').toLowerCase();
                return name.includes(searchTerm) || email.includes(searchTerm);
            });

            const dropdown = $('#target-user-dropdown');

            if (filtered.length === 0) {
                dropdown.html('<div class="p-3 text-gray-500 text-sm">該当するユーザーがいません</div>').removeClass('hidden');
                return;
            }

            const html = filtered.map(user => `
                <div class="target-user-option" data-user-id="${user.id}">
                    <div class="user-name font-medium text-gray-800">${user.name || 'No Name'}</div>
                    <div class="user-email text-sm text-gray-500">${user.email || 'No Email'}</div>
                </div>
            `).join('');

            dropdown.html(html).removeClass('hidden');
        }

        // 対象ユーザーを選択
        function selectTargetUser(userId, userName, userEmail) {
            selectedTargetUserId = userId;
            selectedTargetUserName = userName;
            selectedTargetUserEmail = userEmail;

            $('#selected-user-name').html(`
                ${userName} 
                <button onclick="event.stopPropagation(); showAdminUserModal('${userId}')" class="ml-2 text-indigo-600 hover:text-indigo-800 text-xs bg-indigo-50 px-2 py-1 rounded border border-indigo-200 transition-colors">
                    <i class="fas fa-address-card mr-1"></i>詳細
                </button>
            `);
            $('#selected-user-email').text(userEmail);
            $('#selected-user-display').removeClass('hidden');
            $('#target-user-dropdown').addClass('hidden');
            $('#target-user-search').val('');
            $('#target-user-input-wrapper').addClass('hidden'); // 入力欄を隠す

            // 追加UIを表示
            $('#exclude-matched-container').show();
            $('#select-top-30-btn').removeClass('hidden');

            // ユーザー情報を取得して検索条件にセット
            const user = allCandidateUsers.find(u => u.id === userId);
            if (user) {
                console.log('Setting search filters from user profile:', user);

                // フォームを一旦リセット
                $('#search-keyword').val('');
                $('#search-location').val('');
                $('#search-salary-min').val('');
                $('#search-job-category').val(null).trigger('change');
                $('#search-industry-category').val(null).trigger('change');
                $('#search-employment-type').val(null).trigger('change');
                $('#search-prefecture').val(null).trigger('change');
                $('#search-job-experience-ok').prop('checked', false);
                $('#search-industry-experience-ok').prop('checked', false);
                // $('#search-is-remote').prop('checked', false); // リモート可は保持してもいいかもしれないがリセット推奨

                // ヘルパー: 配列かカンマ区切り文字列を配列に正規化
                // ヘルパー: 配列かカンマ区切り文字列を配列に正規化
                const normalizeToArray = (val) => {
                    if (!val) return [];
                    if (Array.isArray(val)) return val;
                    // JSON文字列っぽい場合はパースを試みる
                    if (typeof val === 'string') {
                        const trimmed = val.trim();
                        if (trimmed.startsWith('[') && trimmed.endsWith(']')) {
                            try {
                                return JSON.parse(trimmed);
                            } catch (e) {
                                console.warn('JSON Parse failed for profile data:', val);
                            }
                        }
                        // カンマ区切りなど
                        return filteredSplit(val); // filteredSplitがあれば使うが、なければsplit
                    }
                    return val.toString().split(',').map(s => s.trim());
                };

                const filteredSplit = (val) => {
                    return val.split(/[,、\s]+/).map(s => s.trim()).filter(s => s.length > 0);
                }

                // 職種
                if (user.desired_job_type) {
                    const vals = normalizeToArray(user.desired_job_type);
                    $('#search-job-category').val(vals).trigger('change');
                }

                // 業界
                if (user.desired_industry) {
                    const vals = normalizeToArray(user.desired_industry);
                    $('#search-industry-category').val(vals).trigger('change');
                }

                // 雇用形態
                if (user.desired_employment_type) {
                    const vals = normalizeToArray(user.desired_employment_type);
                    $('#search-employment-type').val(vals).trigger('change');
                }

                // 勤務地
                if (user.desired_location) {
                    const locs = normalizeToArray(user.desired_location);

                    // 詳細テキストボックスへのセットは除外 (ユーザー要望)
                    // $('#search-location').val(locs.join(', '));

                    // 都道府県をセット
                    const foundPrefs = [];
                    locs.forEach(loc => {
                        const pref = window.prefectures.find(p => loc.startsWith(p));
                        if (pref) foundPrefs.push(pref);
                    });

                    if (foundPrefs.length > 0) {
                        $('#search-prefecture').val(foundPrefs).trigger('change');
                        // 副作用対策: トリガーによってセットされてしまった場合は即座にクリア
                        $('#search-location').val('');
                    }
                }

                // 最低年収
                if (user.desired_salary) {
                    $('#search-salary-min').val(user.desired_salary / 10000);
                }

                // 未経験OK条件
                if (user.desired_job_experience_ok) {
                    $('#search-job-experience-ok').prop('checked', true);
                }
                if (user.desired_industry_experience_ok) {
                    $('#search-industry-experience-ok').prop('checked', true);
                }
            }

            // 検索を再実行して除外フィルタを適用
            searchJobs();

            console.log('Selected target user:', userName, userId);
            updateBulkRecommendBar(); // ボタン状態更新
        }

        // 対象ユーザー選択をクリア
        function clearTargetUserSelection() {
            selectedTargetUserId = null;
            selectedTargetUserName = null;
            selectedTargetUserEmail = null;

            $('#selected-user-display').addClass('hidden');
            $('#target-user-search').val('');
            $('#target-user-input-wrapper').removeClass('hidden'); // 入力欄を表示

            // 追加UIを非表示
            $('#exclude-matched-container').hide();
            $('#select-top-30-btn').addClass('hidden');
            $('#search-exclude-matched').prop('checked', false); // チェックを外す

            // 検索を再実行
            searchJobs();

            console.log('Cleared target user selection');
            updateBulkRecommendBar(); // ボタン状態更新
        }

        // スーパー管理者用：組織切り替え機能
        async function initOrgSwitcher() {
            try {
                // 全組織を取得
                const { data: orgs, error } = await supabase
                    .from('organizations')
                    .select('id, name')
                    .order('name');

                if (error) throw error;

                const switcher = $('#org-switcher');
                switcher.empty();

                // 自分の所属組織（デフォルト）も選択肢に含めるか、あるいは「選択解除」で戻るか
                // ここではシンプルに全組織リストを表示し、現在のorganization_idを選択状態にする

                orgs.forEach(org => {
                    const option = $('<option>').val(org.id).text(org.name);
                    if (org.id === currentUser.organization_id) {
                        option.prop('selected', true);
                    }
                    switcher.append(option);
                });

                // 表示
                $('#org-switcher-container').removeClass('hidden');

                // Select2を適用
                switcher.select2({
                    width: '300px',
                    placeholder: '組織を選択...',
                    allowClear: false,
                    dropdownAutoWidth: true,
                    language: {
                        noResults: function () {
                            return "見つかりません";
                        }
                    }
                });

                // イベントリスナー
                switcher.off('change').on('change', function () {
                    const newOrgId = $(this).val();
                    if (newOrgId) {
                        localStorage.setItem('super_admin_target_org_id', newOrgId);
                    } else {
                        localStorage.removeItem('super_admin_target_org_id');
                    }
                    // リロードして設定を反映
                    location.reload();
                });

            } catch (error) {
                console.error('Failed to init org switcher:', error);
            }
        }

        $(document).ready(function () {

            // Organization Code Validation
            $('#check-org-code').on('click', async function () {
                const code = $('#signup-org-code').val().trim();
                const errorEl = $('#org-code-error');
                const nameEl = $('#org-name-display');
                const inputEl = $('#signup-org-code');

                if (!code) {
                    errorEl.text('コードを入力してください').removeClass('hidden');
                    nameEl.addClass('hidden');
                    inputEl.removeClass('border-green-500 bg-green-50');
                    return;
                }

                try {
                    errorEl.addClass('hidden');
                    const { data, error } = await supabase.rpc('get_organization_name_by_code', { org_code: code });

                    if (error) throw error;

                    if (data && data.length > 0) {
                        nameEl.text(`参加組織: ${data[0].name}`).removeClass('hidden');
                        inputEl.addClass('border-green-500 bg-green-50');
                    } else {
                        errorEl.text('無効な組織コードです').removeClass('hidden');
                        nameEl.addClass('hidden');
                        inputEl.removeClass('border-green-500 bg-green-50');
                    }
                } catch (err) {
                    console.error('Check Error:', err);
                    errorEl.text('確認中にエラーが発生しました').removeClass('hidden');
                }
            });

            // ログインフォーム
            $('#login-form').on('submit', async function (e) {
                e.preventDefault()
                const email = $('#login-email').val().trim()
                const password = $('#login-password').val()
                await login(email, password)
            })

            // 登録フォーム
            $('#signup-form').on('submit', async function (e) {
                e.preventDefault()
                const name = $('#signup-name').val().trim()
                const furigana = $('#signup-furigana').val().trim()
                const email = $('#signup-email').val().trim()
                const password = $('#signup-password').val()
                const token = $('#invitation-token').val()
                const orgCode = $('#signup-org-code').val().trim()
                await signup(name, furigana, email, password, token, orgCode)
            })


            // ログアウト
            $('#logout-btn').on('click', logout)

            // 通知ドロップダウン
            $('#notification-btn').on('click', function (e) {
                e.stopPropagation()
                $('#notification-dropdown').toggleClass('hidden')
                loadNotifications()
            })

            // ドロップダウン外クリックで閉じる
            $(document).on('click', function () {
                $('#notification-dropdown').addClass('hidden')
            })

            $('#notification-dropdown').on('click', function (e) {
                e.stopPropagation()
            })

            // Prevent admin user modal from closing when clicking inside
            $('#admin-user-modal').on('click', function (e) {
                // Only close if clicking on the backdrop (the modal itself, not its children)
                if (e.target === this) {
                    // Don't close automatically - user must click the X button or Cancel
                    e.stopPropagation();
                }
            });

            // Prevent clicks inside modal content from bubbling
            $('#admin-user-modal > div').on('click', function (e) {
                e.stopPropagation();
            });

            // ナビゲーション
            $('#show-signup').on('click', function (e) {
                e.preventDefault()
                showPage('signup-page')
            })

            $('#show-login').on('click', function (e) {
                e.preventDefault()
                showPage('login-page')
            })

            // ナビゲーション
            $('.nav-link').on('click', function (e) {
                e.preventDefault()
                const page = $(this).data('page')

                $('.nav-link').removeClass('bg-indigo-50 text-indigo-600')
                $(this).addClass('bg-indigo-50 text-indigo-600')

                showAppContent(`${page}-content`)

                if (page === 'jobs') {
                    // 保存された検索条件を適用
                    const savedFilters = loadSearchFilters();
                    if (savedFilters) {
                        applySearchFilters(savedFilters);
                        loadJobs(savedFilters);
                    } else {
                        loadJobs();
                    }

                    // 管理者・コーチの場合、対象ユーザー選択UIを表示
                    if (window.currentUser && ['org_admin', 'admin', 'super_admin', 'coach', 'ca'].includes(window.currentUser.role)) {
                        if (allCandidateUsers.length === 0 || shouldReloadCandidates) {
                            loadCandidateUsers();
                        }

                        // イベントハンドラーの登録（重複登録防止のためoffしてからon）
                        $('#target-user-search').off('input focus click').on('input focus click', function () {
                            const searchTerm = $(this).val().toLowerCase();
                            filterAndShowTargetUsers(searchTerm);
                        });

                        // ドロップダウン以外をクリックしたら閉じる
                        $(document).on('click', function (e) {
                            if (!$(e.target).closest('#target-user-input-wrapper').length && !$(e.target).closest('#target-user-dropdown').length) {
                                $('#target-user-dropdown').addClass('hidden');
                            }
                        });

                        $('#clear-user-selection').off('click').on('click', function () {
                            clearTargetUserSelection();
                        });

                        $(document).off('click', '.target-user-option').on('click', '.target-user-option', function () {
                            const userId = $(this).data('user-id');
                            const userName = $(this).find('.user-name').text();
                            const userEmail = $(this).find('.user-email').text();
                            selectTargetUser(userId, userName, userEmail);
                        });
                    }
                } else if (page === 'applications') {
                    loadApplications()
                } else if (page === 'recommendations') {
                    loadRecommendations()
                } else if (page === 'profile') {
                    loadProfile()
                } else if (page === 'admin-jobs') {
                    loadAdminJobs()
                } else if (page === 'admin-companies') {
                    loadCompanies()
                } else if (page === 'admin-applicants') {
                    loadAdminApplicants()
                } else if (page === 'admin-candidates') {
                    loadAdminCandidates()
                } else if (page === 'admin-users') {
                    loadAdminUsers()
                } else if (page === 'admin-csv') {
                    loadCSVHistory()
                } else if (page === 'admin-logs') {
                    loadAuditLogs()
                } else if (page === 'admin-settings') {
                    loadAdminSettings()
                } else if (page === 'admin-prompts') {
                    loadPrompts()
                } else if (page === 'admin-master') {
                    loadMasterData()
                } else if (page === 'super-admin-organizations') {
                    loadSuperAdminOrganizations()
                } else if (page === 'coach-students') {
                    loadCoachStudents()
                } else if (page === 'candidate-search') {
                    loadCandidateSearch()
                } else if (page === 'kpi-dashboard') {
                    loadKPIDashboard()
                } else if (page === 'ai-scout') {
                    // AIスカウトページの初期化
                    switchProfileAnalysisTab('new');
                }

                const titles = {
                    'dashboard': 'ダッシュボード',
                    'jobs': '求人検索',
                    'ai-scout': 'AIスカウト',
                    'applications': '応募・選考状況',
                    'recommendations': 'おすすめ求人',
                    'profile': 'プロフィール',
                    'admin-jobs': '求人管理',
                    'admin-companies': '企業管理',
                    'admin-applicants': '応募者管理',
                    'admin-candidates': '求職者管理',
                    'admin-users': 'ユーザー管理',
                    'admin-csv': 'CSVインポート',
                    'admin-logs': '操作ログ',
                    'admin-prompts': 'AIプロンプト設定',
                    'admin-master': 'マスタデータ管理',
                    'super-admin-organizations': '組織管理',
                    'coach-students': '担当求職者管理',
                    'candidate-search': '求職者検索',
                    'kpi-dashboard': 'KPIダッシュボード'
                }
                $('#page-title').text(titles[page] || page)
            })

            // モバイルメニュー
            // モバイルメニュー制御
            function toggleSidebar() {
                $('.sidebar').toggleClass('open');
                $('#sidebar-overlay').toggleClass('active');
            }

            $('#mobile-menu-btn').on('click', function (e) {
                e.stopPropagation();
                toggleSidebar();
            });

            $('#sidebar-overlay').on('click', function () {
                toggleSidebar();
            });

            // メニュー項目クリック時に閉じる（モバイルのみ）
            $('.nav-link').on('click', function () {
                if ($(window).width() < 768) {
                    $('.sidebar').removeClass('open');
                    $('#sidebar-overlay').removeClass('active');
                }
            });

            // URLパラメータから招待トークンを取得
            const urlParams = new URLSearchParams(window.location.search)
            const token = urlParams.get('token')
            if (token) {
                $('#invitation-token').val(token)
                showPage('signup-page')
            }

            // セッションチェック
            supabase.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    // セッションがある場合、ユーザー情報を取得してダッシュボードへ
                    supabase
                        .from('users')
                        .select('*, organizations(*), organization_members!inner(role)')
                        .eq('id', session.user.id)
                        .eq('organization_members.organization_id', session.user.user_metadata.organization_id || null) // 暫定
                        .single()
                        .then(async ({ data }) => {
                            if (!data) {
                                // organization_members 込みで再取得（より確実な方法）
                                const { data: userData } = await supabase
                                    .from('users')
                                    .select('*, organizations(*)')
                                    .eq('id', session.user.id)
                                    .single();

                                const { data: memData } = await supabase
                                    .from('organization_members')
                                    .select('role')
                                    .eq('user_id', session.user.id)
                                    .eq('organization_id', userData.organization_id)
                                    .single();

                                data = { ...userData, role: memData ? memData.role : userData.role };
                            }

                            if (data) {
                                currentUser = data
                                window.currentUser = data;
                                console.log('Session restored for:', currentUser.name, 'Role:', currentUser.role);

                                // スーパー管理者の場合、組織切り替えロジックを適用
                                if (currentUser.role === 'super_admin') {
                                    const targetOrgId = localStorage.getItem('super_admin_target_org_id');
                                    if (targetOrgId && targetOrgId !== currentUser.organization_id) {
                                        // 切り替え先の組織情報を取得
                                        const { data: targetOrg } = await supabase
                                            .from('organizations')
                                            .select('*')
                                            .eq('id', targetOrgId)
                                            .single();

                                        if (targetOrg) {
                                            // 組織IDと組織情報を上書き（メモリ上のみ）
                                            currentUser.organization_id = targetOrgId;
                                            currentUser.organizations = targetOrg;
                                            console.log('Super Admin: Switched to organization', targetOrg.name, targetOrgId);
                                        }
                                    }
                                    // 組織切り替えUIの初期化
                                    initOrgSwitcher();
                                }

                                // UI反映
                                $('#user-name').text(currentUser.name);
                                $('#user-role').text(getRoleLabel(currentUser.role));
                                $('#org-name').text(currentUser.organizations ? currentUser.organizations.name : '');
                                $('#org-code-display').text(currentUser.organizations?.code ? `コード: ${currentUser.organizations.code}` : '');

                                // メニュー表示の更新
                                updateMenuVisibility(currentUser.role);

                                // ダッシュボードへ

                                // loadDashboardの呼び出しをロールで分岐
                                if (currentUser.role === 'candidate') {
                                    await loadJobs();
                                    showAppContent('jobs-content');
                                    // ナビゲーションのハイライト
                                    $('.nav-link').removeClass('bg-indigo-50 text-indigo-600');
                                    $('.nav-link[data-page="jobs"]').addClass('bg-indigo-50 text-indigo-600');
                                } else {
                                    loadDashboard();
                                    // 通常のフローではshowPage('app-page')でデフォルトのダッシュボードが表示されるが、念のため
                                    $('.nav-link[data-page="dashboard"]').addClass('bg-indigo-50 text-indigo-600');
                                }

                                loadNotifications()
                                initMasterDataDropdowns(); // マスタデータ読み込み
                                showPage('app-page')
                            }
                        })
                }
            })
        })
    </script>

    <!-- Scout Settings Modal -->
    <div id="scout-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
        style="z-index: 10001;">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-magic mr-2 text-indigo-600"></i>AIスカウト文体設定
                </h2>
                <button onclick="closeScoutSettingsModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-6">
                <!-- Activation Toggle -->
                <div class="bg-indigo-50 border border-indigo-100 rounded-lg p-4 flex items-center justify-between">
                    <div>
                        <h3 class="font-bold text-indigo-900">自分の文体を適用する</h3>
                        <p class="text-xs text-indigo-700 mt-1">ONにすると、あなたの普段のメールや過去のスカウト文を学習し、AIが「あなたらしい」文面を生成します。</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="scout-style-active" class="sr-only peer">
                        <div
                            class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600">
                        </div>
                    </label>
                </div>

                <!-- Style Analysis Section -->
                <div>
                    <h3 class="font-bold text-gray-800 mb-2">普段のメールから文体を分析・自動生成</h3>
                    <p class="text-sm text-gray-600 mb-4">
                        過去に送ったスカウトメールや、普段の業務連絡などを3件以上入力してください。あなたの口調、丁寧さの度合い、改行のクセなどをAIが分析します。
                    </p>

                    <div id="scout-examples-area" class="space-y-3 mb-4">
                        <textarea class="scout-example-input w-full border rounded p-2 text-sm h-20"
                            placeholder="例文1: はじめまして、株式会社〇〇の田中と申します..."></textarea>
                        <textarea class="scout-example-input w-full border rounded p-2 text-sm h-20"
                            placeholder="例文2: 先日はありがとうございました。次回の件ですが..."></textarea>
                        <textarea class="scout-example-input w-full border rounded p-2 text-sm h-20"
                            placeholder="例文3: （必須ではありませんが、多いほど精度が上がります）"></textarea>
                    </div>
                    <button id="analyze-examples-btn" onclick="analyzeScoutExamples()"
                        class="w-full bg-white border-2 border-indigo-600 text-indigo-600 font-bold py-2 rounded hover:bg-indigo-50 transition">
                        <i class="fas fa-microscope mr-2"></i>分析してスタイルを生成
                    </button>
                </div>

                <div class="border-t pt-6">
                    <label class="block font-bold text-gray-800 mb-2">
                        生成されたスタイルプロンプト（編集可）
                    </label>
                    <textarea id="scout-style-prompt" rows="6"
                        class="w-full border border-gray-300 rounded-lg p-3 text-sm font-mono bg-gray-50 focus:bg-white transition"
                        placeholder="分析結果がここに表示されます。手動で入力・修正も可能です。"></textarea>
                </div>
            </div>
            <div class="p-6 border-t bg-gray-50 flex justify-end gap-3 rounded-b-lg">
                <button onclick="closeScoutSettingsModal()"
                    class="px-4 py-2 text-gray-600 hover:text-gray-800">キャンセル</button>
                <button onclick="saveScoutSettings()"
                    class="px-6 py-2 bg-indigo-600 text-white font-bold rounded shadow hover:bg-indigo-700 transition">
                    設定を保存
                </button>
            </div>
        </div>
    </div>

    <!-- Favorites Modal -->
    <div id="favorites-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg w-full max-w-2xl mx-4 max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-heart text-pink-500 mr-2"></i>お気に入り求人
                </h3>
                <button onclick="closeFavoritesModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="favorites-list" class="p-6 overflow-y-auto flex-1">
                <!-- Favorites will be rendered here -->
            </div>
            <div class="p-4 border-t border-gray-200 bg-gray-50 rounded-b-lg text-right">
                <button onclick="closeFavoritesModal()"
                    class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    閉じる
                </button>
            </div>
        </div>
    </div>

    <div id="recommendation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
        style="z-index: 10002;">
        <div class="bg-white rounded-lg w-full max-w-3xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-file-alt text-indigo-600 mr-2"></i>企業への推薦文作成
                </h3>
                <button onclick="closeRecommendationModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="mb-6">
                <p class="text-gray-600 mb-4">
                    AIが求職者のプロフィールと求人情報を分析し、人事担当者に響く推薦文を自動生成します。
                    生成された文章は自由に編集できます。
                </p>

                <div class="flex justify-end mb-4">
                    <button onclick="generateRecommendation()" id="generate-recommendation-btn"
                        class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 flex items-center gap-2">
                        <i class="fas fa-magic"></i>
                        <span>AIで推薦文を生成する</span>
                    </button>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">推薦文</label>
                    <textarea id="recommendation-text" rows="15"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        placeholder="ここに推薦文が生成されます..."></textarea>
                </div>
            </div>

            <div class="flex justify-end gap-3 pt-4 border-t">
                <button onclick="closeRecommendationModal()"
                    class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded">キャンセル</button>
                <button onclick="saveRecommendation()"
                    class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                    <i class="fas fa-save mr-2"></i>保存する
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentRecommendationAppId = null;

        // 推薦文モーダルを開く
        window.openRecommendationModal = async function (applicationId) {
            console.log('openRecommendationModal called with ID:', applicationId);
            currentRecommendationAppId = applicationId;

            // 既存の推薦文を取得
            try {
                if (!window.supabase) {
                    throw new Error('Supabase client is not initialized');
                }

                const { data: app, error } = await window.supabase
                    .from('applications')
                    .select('recommendation_text')
                    .eq('id', applicationId)
                    .single();

                if (error) throw error;

                console.log('Fetched application data:', app);

                const modal = $('#recommendation-modal');
                console.log('Modal element found:', modal.length > 0);

                // モーダルをbodyの最後に移動して、親要素の影響を受けないようにする
                $('body').append(modal);

                $('#recommendation-text').val(app.recommendation_text || '');

                // 強制的に表示
                modal.removeClass('hidden');
                modal.attr('style', 'display: flex !important; z-index: 99999 !important;');

                console.log('Modal moved to body end and forced to display');
                // alert('推薦文モーダルを開きました'); // デバッグ用アラート

            } catch (error) {
                console.error('Failed to fetch recommendation:', error);
                alert('データの取得に失敗しました: ' + (error.message || error));
            }
        }

        // 推薦文モーダルを閉じる
        window.closeRecommendationModal = function () {
            // インラインスタイルを上書きして非表示にする
            $('#recommendation-modal').addClass('hidden').css('display', 'none');
            currentRecommendationAppId = null;
        }

        // AIで推薦文を生成
        window.generateRecommendation = async function () {
            console.log('generateRecommendation called');
            if (!currentRecommendationAppId) {
                console.error('No currentRecommendationAppId set');
                return;
            }

            const btn = $('#generate-recommendation-btn');
            const originalHtml = btn.html();
            btn.html('<i class="fas fa-spinner fa-spin mr-2"></i>生成中...').prop('disabled', true);

            try {
                if (!window.supabase) throw new Error('Supabase client not initialized');

                console.log('Invoking generate-recommendation-letter for:', currentRecommendationAppId);
                const { data, error } = await window.supabase.functions.invoke('generate-recommendation-letter', {
                    body: { applicationId: currentRecommendationAppId }
                });

                if (error) throw error;
                if (!data.success) throw new Error(data.error || '生成に失敗しました');

                console.log('Generation success:', data);
                $('#recommendation-text').val(data.text);

            } catch (error) {
                console.error('Failed to generate recommendation:', error);
                alert('推薦文の生成に失敗しました: ' + (error.message || error));
            } finally {
                btn.html(originalHtml).prop('disabled', false);
            }
        }


        // ========================================
        // 職務経歴書・推薦状プレビューモーダル機能
        // ========================================

        // グローバル変数
        let currentDocumentApplicationId = null;
        let currentDocumentType = null;
        let currentDocumentData = null;


        // 職務経歴書・推薦状を生成（モーダル表示版）
        window.generateDocument = async function (applicationId, type) {
            console.log('generateDocument called:', { applicationId, type });

            currentDocumentApplicationId = applicationId;
            currentDocumentType = type;

            console.log('About to call modal function for type:', type);

            if (type === 'resume') {
                console.log('Calling window.openResumePreviewModal');
                window.openResumePreviewModal(applicationId);
            } else {
                console.log('Calling window.openRecommendationDocPreviewModal');
                window.openRecommendationDocPreviewModal(applicationId);
            }

            console.log('Modal function called');
        }

        // 職務経歴書プレビューモーダルを開く
        window.openResumePreviewModal = async function (applicationId) {
            console.log('openResumePreviewModal START, applicationId:', applicationId);

            const modal = $('#resume-preview-modal');
            console.log('Modal element found:', modal.length);

            // モーダルをbodyの直下に移動（親要素の影響を受けないようにする）
            modal.appendTo('body');

            modal.removeClass('hidden').css('display', 'flex');
            console.log('Modal display set to flex');

            // 生成中表示
            $('#resume-generating').show();
            $('#resume-preview-content').hide();
            $('#resume-error').hide();
            console.log('Loading state shown');

            try {
                console.log('Calling Edge Function...');
                // Edge Functionを呼び出してAI生成
                const { data, error } = await window.supabase.functions.invoke('generate-application-document', {
                    body: {
                        applicationId: applicationId,
                        type: 'resume'
                    },
                    headers: {
                        'x-user-id': currentUser?.id || ''
                    }
                });

                console.log('Edge Function response:', { data, error });

                if (error) throw error;
                if (!data.success) throw new Error(data.error);

                currentDocumentData = data.documentData;
                console.log('Document data received:', currentDocumentData);

                // プレビューに表示
                $('#resume-summary').val(data.documentData.summary || '');
                $('#resume-work-history').val(formatWorkHistory(data.documentData.work_history));
                $('#resume-strengths').val(formatList(data.documentData.strengths || data.documentData.match_highlights));
                $('#resume-skills').val(formatSkills(data.documentData.skills));
                $('#resume-self-pr').val(data.documentData.self_pr || '');
                $('#resume-motivation').val(data.documentData.motivation || '志望動機を記入してください');

                console.log('Form fields populated');

                // プレビュー表示
                $('#resume-generating').hide();
                $('#resume-preview-content').show();
                console.log('Preview content shown');

            } catch (error) {
                console.error('Resume generation error:', error);
                $('#resume-generating').hide();
                $('#resume-error-message').text(error.message || '生成に失敗しました');
                $('#resume-error').show();
            }
        }

        // 推薦状プレビューモーダルを開く
        window.openRecommendationDocPreviewModal = async function (applicationId) {
            const modal = $('#recommendation-doc-preview-modal');

            // モーダルをbodyの直下に移動（親要素の影響を受けないようにする）
            modal.appendTo('body');

            modal.removeClass('hidden').css('display', 'flex');

            // 生成中表示
            $('#recommendation-doc-generating').show();
            $('#recommendation-doc-preview-content').hide();
            $('#recommendation-doc-error').hide();

            try {
                // Edge Functionを呼び出してAI生成
                const { data, error } = await window.supabase.functions.invoke('generate-application-document', {
                    body: {
                        applicationId: applicationId,
                        type: 'recommendation'
                    },
                    headers: {
                        'x-user-id': currentUser?.id || ''
                    }
                });

                if (error) throw error;
                if (!data.success) throw new Error(data.error);

                currentDocumentData = data.documentData;

                // 推薦状を整形して表示
                const formattedText = formatRecommendationLetter(data.documentData);
                $('#recommendation-doc-full-text').val(formattedText);

                // プレビュー表示
                $('#recommendation-doc-generating').hide();
                $('#recommendation-doc-preview-content').show();

            } catch (error) {
                console.error('Recommendation generation error:', error);
                $('#recommendation-doc-generating').hide();
                $('#recommendation-doc-error-message').text(error.message || '生成に失敗しました');
                $('#recommendation-doc-error').show();
            }
        }

        // モーダルを閉じる
        window.closeResumePreviewModal = function () {
            $('#resume-preview-modal').addClass('hidden').css('display', 'none');
            currentDocumentApplicationId = null;
            currentDocumentData = null;
        }

        window.closeRecommendationDocPreviewModal = function () {
            $('#recommendation-doc-preview-modal').addClass('hidden').css('display', 'none');
            currentDocumentApplicationId = null;
            currentDocumentData = null;
        }

        // 再生成
        window.regenerateResume = async function () {
            if (currentDocumentApplicationId) {
                await openResumePreviewModal(currentDocumentApplicationId);
            }
        }

        window.regenerateRecommendationDoc = async function () {
            if (currentDocumentApplicationId) {
                await openRecommendationDocPreviewModal(currentDocumentApplicationId);
            }
        }

        // Word出力
        window.downloadResumeWord = async function () {
            showLoading('Word文書を生成中...');

            try {
                // 編集された内容を取得
                const editedData = {
                    summary: $('#resume-summary').val(),
                    work_history_text: $('#resume-work-history').val(),
                    strengths_text: $('#resume-strengths').val(),
                    skills_text: $('#resume-skills').val(),
                    self_pr: $('#resume-self-pr').val(),
                    motivation: $('#resume-motivation').val()
                };

                // HTMLベースのWord文書を生成（画像のフォーマットを再現）
                const today = new Date();
                const dateStr = `${today.getFullYear()}年${today.getMonth() + 1}月${today.getDate()}日現在`;

                const htmlContent = `
<!DOCTYPE html>
<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
<head>
    <meta charset='utf-8'>
    <title>職務経歴書</title>
    <style>
        @page {
            size: A4;
            margin: 20mm;
        }
        body { 
            font-family: 'MS Gothic', 'MS Mincho', 'Meiryo', sans-serif; 
            font-size: 10.5pt;
            line-height: 1.6; 
            margin: 0;
            padding: 20px;
        }
        .header {
            position: relative;
            margin-bottom: 20px;
        }
        .title { 
            text-align: center; 
            font-size: 16pt; 
            font-weight: bold;
            letter-spacing: 8px;
            margin-bottom: 10px;
        }
        .date-name {
            text-align: right;
            font-size: 10pt;
            line-height: 1.8;
        }
        .section-title {
            font-size: 11pt;
            font-weight: bold;
            margin-top: 15px;
            margin-bottom: 8px;
            padding-left: 2px;
        }
        .section-title::before {
            content: '■';
            margin-right: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 10pt;
        }
        th, td {
            border: 1px solid #000;
            padding: 6px 8px;
            vertical-align: top;
            line-height: 1.7;
        }
        th {
            background-color: #ffffff;
            font-weight: normal;
            text-align: left;
        }
        .work-history-table th {
            width: 15%;
        }
        .work-history-table td {
            width: 85%;
        }
        .skill-table th {
            width: 25%;
            font-weight: normal;
        }
        .skill-table td {
            width: 75%;
        }
        .content {
            white-space: pre-wrap;
            line-height: 1.7;
        }
        .subsection {
            font-weight: bold;
            margin-top: 8px;
            margin-bottom: 4px;
        }
        .indent {
            padding-left: 1em;
        }
        p {
            margin: 8px 0;
            line-height: 1.8;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">職務経歴書</div>
        <div class="date-name">
            ${dateStr}<br>
            氏名　${currentUser?.user_metadata?.full_name || ''}
        </div>
    </div>
    
    <div class="section-title">職務要約</div>
    <p class="content">${editedData.summary.replace(/\n/g, '<br>')}</p>
    
    <div class="section-title">職務経歴</div>
    <table class="work-history-table">
        <tr>
            <td colspan="2" class="content">${editedData.work_history_text.replace(/\n/g, '<br>')}</td>
        </tr>
    </table>
    
    <div class="section-title">PCスキル</div>
    <table class="skill-table">
        ${editedData.skills_text.split('\n').filter(line => line.trim()).map(line => {
                    const parts = line.split(/[：:]/);
                    if (parts.length >= 2) {
                        return `<tr><th>${parts[0].trim()}</th><td>${parts.slice(1).join(':').trim()}</td></tr>`;
                    } else {
                        return `<tr><td colspan="2">${line}</td></tr>`;
                    }
                }).join('\n        ')}
    </table>
    
    <div class="section-title">自己PR</div>
    <p class="content">${editedData.self_pr.replace(/\n/g, '<br>')}</p>
    
    <div class="section-title">志望動機</div>
    <p class="content">${editedData.motivation.replace(/\n/g, '<br>')}</p>
    
    <div style="text-align: right; margin-top: 30px;">以上</div>
</body>
</html>`;

                // Blobを作成してダウンロード
                const blob = new Blob(['\ufeff', htmlContent], {
                    type: 'application/msword'
                });

                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `職務経歴書_${currentDocumentApplicationId}.doc`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // モーダルを閉じる
                closeResumePreviewModal();

                alert('職務経歴書をダウンロードしました!');

            } catch (error) {
                console.error('Word generation error:', error);
                alert(`ダウンロードに失敗しました: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        window.downloadRecommendationDocWord = async function () {
            showLoading('Word文書を生成中...');

            try {
                const content = $('#recommendation-doc-full-text').val();

                // HTMLベースのWord文書を生成
                const htmlContent = `
<!DOCTYPE html>
<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
<head>
    <meta charset='utf-8'>
    <title>推薦状</title>
    <style>
        body { font-family: 'MS Gothic', 'Meiryo', sans-serif; line-height: 1.8; margin: 40px; }
        h1 { text-align: center; font-size: 24px; margin-bottom: 30px; }
        p { margin: 10px 0; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>推薦状</h1>
    <p>${content.replace(/\n/g, '<br>')}</p>
</body>
</html>`;

                // Blobを作成してダウンロード
                const blob = new Blob(['\ufeff', htmlContent], {
                    type: 'application/msword'
                });

                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `推薦状_${currentDocumentApplicationId}.doc`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // モーダルを閉じる
                closeRecommendationDocPreviewModal();

                alert('推薦状をダウンロードしました!');

            } catch (error) {
                console.error('Word generation error:', error);
                alert(`ダウンロードに失敗しました: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // フォーマット関数
        window.formatWorkHistory = function (workHistory) {
            if (!Array.isArray(workHistory)) return '';

            return workHistory.map((item, index) => {
                let text = `${index + 1}.${item.period || ''}\n`;
                text += `   ${item.company || ''} - ${item.position || ''}\n`;
                text += `   ${item.description || ''}\n`;
                if (item.skills_used && item.skills_used.length > 0) {
                    text += `   使用スキル: ${item.skills_used.join(', ')}\n`;
                }
                return text;
            }).join('\n');
        }

        window.formatList = function (items) {
            if (Array.isArray(items)) {
                return items.map((s, i) => `• ${s}`).join('\n');
            }
            return items || '';
        }

        window.formatSkills = function (skills) {
            if (!skills) return '';

            let text = '';
            if (skills.technical && Array.isArray(skills.technical)) {
                text += `技術スキル: ${skills.technical.join(', ')}\n`;
            }
            if (skills.business && Array.isArray(skills.business)) {
                text += `ビジネススキル: ${skills.business.join(', ')}\n`;
            }
            if (skills.certifications && Array.isArray(skills.certifications)) {
                text += `資格: ${skills.certifications.join(', ')}`;
            }
            return text;
        }

        window.formatRecommendationLetter = function (data) {
            let text = `${data.date || new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' })}現在\n\n`;
            text += `${data.recipient || '採用ご担当者様'}\n\n`;
            text += `件名: ${data.subject || '候補者推薦の件'}\n\n`;
            text += `${data.greeting || '拝啓 時下ますますご清栄のこととお慶び申し上げます。'}\n\n`;
            text += `${data.introduction || ''}\n\n`;

            if (data.candidate_overview) {
                text += `【候補者概要】\n${data.candidate_overview}\n\n`;
            }

            if (data.match_points && Array.isArray(data.match_points)) {
                text += `【マッチングポイント】\n`;
                data.match_points.forEach((point, index) => {
                    if (typeof point === 'object') {
                        text += `\n${index + 1}. ${point.title || ''} \n`;
                        text += `${point.description || ''} \n`;
                    } else {
                        text += `${index + 1}. ${point} \n`;
                    }
                });
                text += `\n`;
            }

            if (data.strengths && Array.isArray(data.strengths)) {
                text += `【候補者の強み】\n`;
                data.strengths.forEach((strength, index) => {
                    text += `${index + 1}. ${strength} \n`;
                });
                text += `\n`;
            }

            if (data.why_recommend) {
                text += `【推薦理由】\n${data.why_recommend} \n\n`;
            }

            text += `${data.closing || '何卒ご検討のほど、よろしくお願い申し上げます。'} \n\n`;
            text += `${data.signature || '敬具'} `;

            return text;
        }


        // 推薦文を保存
        window.saveRecommendation = async function () {
            if (!currentRecommendationAppId) return;

            const text = $('#recommendation-text').val();
            if (!text) {
                alert('推薦文を入力してください');
                return;
            }

            showLoading();
            try {
                if (!window.supabase) throw new Error('Supabase client not initialized');

                const { error } = await window.supabase
                    .from('applications')
                    .update({
                        recommendation_text: text,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentRecommendationAppId);

                if (error) throw error;

                alert('推薦文を保存しました');
                closeRecommendationModal();

                // リストを更新 (存在する場合のみ)
                if (typeof loadAdminApplicants === 'function') {
                    loadAdminApplicants();
                } else if (typeof loadApplications === 'function') {
                    loadApplications();
                }

            } catch (error) {
                console.error('Failed to save recommendation:', error);
                alert('保存に失敗しました: ' + (error.message || error));
            } finally {
                hideLoading();
            }
        }

        // ========================
        // 新機能: お気に入り見送り & プロフィール検索
        // ========================

        // おすすめ求人を見送る（最下部へ移動＆グレーアウト）
        // おすすめ求人を見送る（最下部へ移動＆グレーアウト）
        window.dismissRecommendation = function (jobId) {
            if (!window.currentUser) return;

            // 視覚的な即時フィードバック（クリックしたカードをグレーアウト）
            const card = $(`.rec - card[data - job - id="${jobId}"]`);
            if (card.length > 0) {
                card.css({
                    'opacity': '0.3',
                    'filter': 'grayscale(100%)',
                    'pointer-events': 'none',
                    'transition': 'all 0.4s ease'
                });
            }

            const key = `dismissed_recs_${window.currentUser.id} `;
            let dismissed = JSON.parse(localStorage.getItem(key) || '[]');

            if (!dismissed.includes(jobId)) {
                dismissed.push(jobId);
                localStorage.setItem(key, JSON.stringify(dismissed));

                // 少し待ってから再描画（グレーアウトを見せるため）
                setTimeout(() => {
                    if (typeof renderRecommendations === 'function') {
                        renderRecommendations();
                    }
                }, 400);
            }
        }

        // プロフィール条件で検索
        window.searchByProfile = async function () {
            const user = (typeof currentUser !== 'undefined' ? currentUser : window.currentUser);
            if (!user || user.role !== 'candidate') {
                console.warn('searchByProfile: Invalid user or role', user);
                return;
            }

            if (window.showLoading) window.showLoading();

            try {
                // 最新のプロフィール情報を取得 (currentUserが古い可能性があるため)
                const { data: profileData, error: profileError } = await window.supabase
                    .from('candidate_profiles')
                    .select('*')
                    .eq('user_id', user.id)
                    .maybeSingle();

                if (profileError) throw profileError;

                // プロフィールがない場合は警告
                if (!profileData) {
                    alert('プロフィール情報が登録されていないため、条件を自動セットできません。先にプロフィールを入力してください。');
                    return;
                }

                // ユーザー情報とプロフィール情報をマージ
                const fullUser = { ...user, ...profileData };

                // マスタデータ取得 (IDとLabelの対応が必要なため)
                const { data: masters } = await window.supabase
                    .from('master_data')
                    .select('type, label, value, organization_id')
                    .in('type', ['job_category', 'industry_category', 'employment_type'])
                    .eq('is_active', true);

                // 自社または共通マスタ
                const validMasters = masters ? masters.filter(m =>
                    m.organization_id === null || m.organization_id === user.organization_id
                ) : [];

                const mapToLabel = (inputStr, type) => {
                    if (inputStr === null || inputStr === undefined || inputStr === '') return [];

                    // JSON配列、カンマ区切り文字列、あるいは単一の値を処理
                    let inputs = [];
                    if (Array.isArray(inputStr)) {
                        inputs = inputStr;
                    } else if (typeof inputStr === 'string') {
                        if (inputStr.startsWith('[') && inputStr.endsWith(']')) {
                            try { inputs = JSON.parse(inputStr); } catch (e) { inputs = [inputStr]; }
                        } else {
                            inputs = inputStr.split(',').map(s => s.trim()).filter(Boolean);
                        }
                    } else {
                        inputs = [inputStr];
                    }

                    const typeMasters = validMasters.filter(m => m.type === type);

                    return inputs.map(val => {
                        // value (ID) で検索 (緩い比較)
                        const byId = typeMasters.find(m => m.value == val);
                        if (byId) return byId.label;

                        // label で検索
                        const byLabel = typeMasters.find(m => m.label == val);
                        if (byLabel) return byLabel.label;

                        // マッチしなければそのまま返す
                        return val;
                    });
                };

                // 最低年収の整形
                let salaryMin = '';
                if (fullUser.desired_salary) {
                    let salaryVal = fullUser.desired_salary;
                    // 文字列なら数値のみ抽出
                    if (typeof salaryVal === 'string') {
                        salaryVal = parseInt(salaryVal.replace(/[^0-9]/g, '')) || 0;
                    }
                    // 1万倍（例: 500万）以上なら1万で割る
                    if (salaryVal >= 10000) {
                        salaryMin = Math.floor(salaryVal / 10000);
                    } else {
                        salaryMin = salaryVal;
                    }
                }

                const filters = {
                    jobCategory: mapToLabel(fullUser.desired_job_type, 'job_category'),
                    industryCategory: mapToLabel(fullUser.desired_industry, 'industry_category'),
                    prefecture: fullUser.desired_location ?
                        (Array.isArray(fullUser.desired_location) ? fullUser.desired_location :
                            String(fullUser.desired_location).startsWith('[') ? JSON.parse(fullUser.desired_location) :
                                String(fullUser.desired_location).split(/[,、]/).map(s => s.trim()))
                        : [],
                    employmentType: mapToLabel(fullUser.desired_employment_type, 'employment_type'),
                    salaryMin: salaryMin,
                    jobExperienceOk: !!fullUser.desired_job_experience_ok,
                    industryExperienceOk: !!fullUser.desired_industry_experience_ok,
                    isRemote: false // プロフィールに項目がない場合はデフォルト
                };

                console.log('Searching by profile (mapped):', filters);

                // 検索パラメータ設定
                if (window.applySearchFilters) {
                    window.applySearchFilters(filters);
                } else if (typeof applySearchFilters === 'function') {
                    applySearchFilters(filters);
                }

                // 検索実行
                if (typeof searchJobsImmediate === 'function') {
                    searchJobsImmediate();
                } else if (typeof loadJobs === 'function') {
                    loadJobs(filters);
                }

            } catch (e) {
                console.error('Search by profile error:', e);
                alert('検索条件の適用に失敗しました: ' + (e.message || e));
            } finally {
                if (window.hideLoading) window.hideLoading();
            }
        }

        /* ============================================================ */
        /*  Scout Management & Specific Job Scout Generation Logic      */
        /* ============================================================ */

        window.loadScoutManagement = async function () {
            if (!currentUser) return;
            const container = $('#scout-management-list');
            container.html('<div class="text-center py-12"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto"></div></div>');

            try {
                // 1. 組織設定の取得
                const { data: orgData } = await supabase
                    .from('organizations')
                    .select('settings')
                    .eq('id', currentUser.organization_id)
                    .single();
                const visibility = orgData?.settings?.scout_history_visibility || 'all';

                // 2. 統計データの取得 (スカウト送信数: sent/replied/interview/hired/rejected)
                // Note: ステータスが 'generated' (下書き) は除外するのが一般的だが、履歴として含めても良い。ここでは 'generated' 以外をカウントとするか、全部含むか。
                // 一般的に「履歴」は送信済みを指すことが多い。
                const validStatuses = ['sent', 'replied', 'interview', 'rejected', 'hired'];

                // 個人
                const { count: myCount } = await supabase
                    .from('scout_messages')
                    .select('*', { count: 'exact', head: true })
                    .eq('organization_id', currentUser.organization_id)
                    .eq('created_by', currentUser.id)
                    .in('status', validStatuses);

                // 全体
                const { count: orgCount } = await supabase
                    .from('scout_messages')
                    .select('*', { count: 'exact', head: true })
                    .eq('organization_id', currentUser.organization_id)
                    .in('status', validStatuses);


                // 3. 候補者データの取得
                const { data: candidates, error: cError } = await supabase
                    .from('external_candidates')
                    .select('*')
                    .eq('organization_id', currentUser.organization_id)
                    .order('created_at', { ascending: false });

                if (cError) {
                    if (cError.code === '42P01') {
                        container.html('<div class="text-center py-8 text-gray-500">機能準備中（テーブル未作成）</div>');
                        return;
                    }
                    throw cError;
                }

                // 4. メッセージデータの取得
                let messages = [];
                // Check if candidates exist
                if (candidates && candidates.length > 0) {
                    const candidateIds = candidates.map(c => c.id);
                    try {
                        let msgQuery = supabase
                            .from('scout_messages')
                            .select('*, jobs(title, companies(name))')
                            .in('external_candidate_id', candidateIds)
                            .order('created_at', { ascending: false });

                        // Visibility制御
                        if (visibility === 'personal') {
                            msgQuery = msgQuery.eq('created_by', currentUser.id);
                        }

                        const { data: msgs, error: mError } = await msgQuery;
                        if (!mError) {
                            messages = msgs;

                            // ユーザー名の取得 (作成者表示用)
                            if (messages.length > 0) {
                                const userIds = [...new Set(messages.map(m => m.created_by).filter(id => id))];
                                if (userIds.length > 0) {
                                    const { data: users } = await supabase
                                        .from('users')
                                        .select('id, name')
                                        .in('id', userIds);

                                    const userMap = {};
                                    if (users) users.forEach(u => userMap[u.id] = u.name);

                                    messages.forEach(m => {
                                        m.sender_name = userMap[m.created_by] || '-';
                                    });
                                }
                            }
                        }
                    } catch (e) { console.warn('scout_messages fetch failed', e); }
                }

                // 5. 統計UIの表示とリストのレンダリング
                const statsHtml = `
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-indigo-50 rounded-lg p-4 text-center border border-indigo-100">
                            <p class="text-xs text-gray-500 font-bold mb-1">自分のスカウト送信数</p>
                            <p class="text-2xl font-bold text-indigo-700">${myCount || 0}<span class="text-sm font-normal text-gray-500 ml-1">件</span></p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 text-center border border-gray-200">
                            <p class="text-xs text-gray-500 font-bold mb-1">組織全体のスカウト送信数</p>
                            <p class="text-2xl font-bold text-gray-700">${orgCount || 0}<span class="text-sm font-normal text-gray-500 ml-1">件</span></p>
                        </div>
                    </div>
                `;

                if (!candidates || candidates.length === 0) {
                    container.html(statsHtml + '<div class="text-center py-8 text-gray-500">登録された候補者はいません</div>');
                    return;
                }

                container.html(statsHtml + '<div class="space-y-4" id="scout-list-content"></div>');

                // リストの中身を別の関数で描画するなど、あるいはここで直接呼び出し
                // 既存の renderScoutManagementList は container.html() を上書きしてしまうので、
                // container の中の div をターゲットにするように調整が必要。
                // しかし renderScoutManagementList は window関数として定義されている。
                // ここで呼び出す際に、targetを変えるか、renderScoutManagementList を修正する。
                // 修正するのが早い。

                // 既存関数を呼び出すが、ターゲット Element ID が固定されている ('scout-management-list')。
                // これだと STATS が消えてしまう。
                // 解決策: renderScoutManagementList にターゲットコンテナを渡せるようにする、もしくは
                // renderScoutManagementList の中身をここにインライン化/リファクタする。
                // ここでは安直に、renderScoutManagementList を呼び出した後で、STATS を prepend するのはちらつく。
                // renderScoutManagementList を修正しよう。

                renderScoutManagementList(candidates, messages || [], '#scout-list-content');

            } catch (e) {
                console.error('Load Scout Management Error:', e);
                container.html('<div class="text-center py-8 text-red-500">読み込みに失敗しました</div>');
            }
        };

        window.renderScoutManagementList = function (candidates, messages, targetSelector = '#scout-management-list') {
            const container = $(targetSelector);

            if (!candidates || candidates.length === 0) {
                container.html('<div class="text-center py-8 text-gray-500">登録された候補者はいません</div>');
                return;
            }

            const rows = candidates.map(c => {
                const cMessages = messages.filter(m => m.external_candidate_id === c.id);
                const lastMsg = cMessages.length > 0 ? cMessages[0] : null;
                const currentStatus = lastMsg ? lastMsg.status : (c.status || 'new');

                const jobTitle = lastMsg?.jobs?.title || '-';
                const companyName = lastMsg?.jobs?.companies?.name || '';
                const lastJobTitle = lastMsg ? (companyName ? `${companyName} ${jobTitle} ` : jobTitle) : '-';
                const lastScoutDate = lastMsg ? new Date(lastMsg.created_at).toLocaleDateString() : '-';
                const senderName = lastMsg ? (lastMsg.sender_name || '不明') : '-';

                // Status Dropdown
                const statusOptions = [
                    { val: 'new', label: '新規' },
                    { val: 'generated', label: '文面作成済' },
                    { val: 'sent', label: '送信済' },
                    { val: 'replied', label: '返信あり' },
                    { val: 'interview', label: '面談設定' },
                    { val: 'rejected', label: '辞退/不採用' },
                    { val: 'hired', label: '採用決定' }
                ];

                const statusChangeHandler = lastMsg
                    ? `onchange="updateScoutStatus('${lastMsg.id}', this.value)"`
                    : `disabled title="スカウトを作成するとステータスを変更できます"`;

                const statusSelect = `
                    <select ${statusChangeHandler} class="text-xs border border-gray-300 rounded px-2 py-1 bg-white text-gray-700 w-28">
                    ${statusOptions.map(opt => `<option value="${opt.val}" ${currentStatus === opt.val ? 'selected' : ''}>${opt.label}</option>`).join('')}
                    </select>
                `;

                // Title display
                const displayTitle = c.custom_title || '名称未設定';
                const subText = c.custom_title
                    ? (c.parsed_data?.candidate_summary ? c.parsed_data.candidate_summary.substring(0, 30) + '...' : (c.profile_text || '').substring(0, 30) + '...')
                    : (c.profile_text || '').substring(0, 30) + '...';

                return `
                    <tr>
                        <td class="px-6 py-4">
                            <div class="text-sm font-bold text-gray-900 truncate" style="max-width: 250px;" title="${c.profile_text}">
                                ${displayTitle}
                            </div>
                            <div class="text-xs text-gray-500">
                                ${subText}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${new Date(c.created_at).toLocaleDateString()}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            ${senderName}
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900 truncate" style="max-width: 200px;" title="${lastJobTitle}">${lastJobTitle}</div>
                            <div class="text-xs text-gray-500">${lastScoutDate}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${statusSelect}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="viewExternalCandidateDetail('${c.id}')" class="text-indigo-600 hover:text-indigo-900 bg-indigo-50 hover:bg-indigo-100 px-3 py-1 rounded transition">
                                <i class="fas fa-file-alt mr-1"></i>詳細・履歴
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            const tableHtml = `
                    <div class="overflow-x-auto border border-gray-200 rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">候補者 / 管理ID</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">登録日</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">実行者</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">直近スカウト</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ステータス</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${rows}
                        </tbody>
                    </table>
                </div>
                `;

            container.html(tableHtml);
        }

        window.viewExternalCandidateDetail = async function (candidateId) {
            try {
                const { data: candidate, error } = await supabase
                    .from('external_candidates')
                    .select('*')
                    .eq('id', candidateId)
                    .single();

                if (error) throw error;

                if (!candidate.parsed_data) {
                    alert("解析データがありません");
                    return;
                }

                window.currentExternalCandidateId = candidate.id;

                switchProfileAnalysisTab('new');

                if (candidate.profile_text) {
                    $('#profile-text-input').val(candidate.profile_text);
                }

                // Set custom title
                if (candidate.custom_title) {
                    $('#candidate-title-input').val(candidate.custom_title);
                } else {
                    $('#candidate-title-input').val('');
                }

                renderAnalysisResults(candidate.parsed_data);

                document.getElementById('analysis-results').scrollIntoView({ behavior: 'smooth' });

            } catch (e) {
                console.error('View detail error:', e);
                alert("詳細の読み込みに失敗しました");
            }
        }

        window.updateScoutStatus = async function (scoutId, newStatus) {
            if (!confirm(`ステータスを「${newStatus}」に変更しますか？`)) {
                loadScoutManagement(); // Revert selection UI by reloading
                return;
            }

            try {
                // Update scout_messages
                const { error: msgError } = await supabase
                    .from('scout_messages')
                    .update({ status: newStatus, updated_at: new Date().toISOString() })
                    .eq('id', scoutId);

                if (msgError) throw msgError;

                // Also update external_candidates status for consistency if needed
                // For now, mainly tracking scout message status.

                alert('ステータスを更新しました');
                loadScoutManagement(); // Reload list
            } catch (e) {
                console.error('Status update failed:', e);
                alert('更新に失敗しました');
            }
        }

        window.fetchActiveJobs = async function () {
            const { data } = await supabase
                .from('jobs')
                .select('id, title')
                .eq('organization_id', currentUser.organization_id)
                .eq('status', 'active')
                .order('created_at', { ascending: false })
                .limit(20);
            return data;
        }

        // Job Selector Modal Logic
        let scoutJobSelectorInitialized = false;

        window.openJobSelectorForScout = function () {
            $('#job-selection-modal').removeClass('hidden');

            // Initialize Prefectures if needed
            if (!scoutJobSelectorInitialized && window.prefectures) {
                const select = $('#selector-search-prefecture');
                window.prefectures.forEach(p => {
                    select.append(`< option value = "${p}" > ${p}</option > `);
                });
                scoutJobSelectorInitialized = true;
            }

            // Reset results if empty
            if ($('#selector-job-results').children().length === 0) {
                $('#selector-job-results').html('<div class="text-center py-8 text-gray-400">検索条件を入力して検索してください</div>');
            }
        };

        window.closeJobSelectorForScout = function () {
            $('#job-selection-modal').addClass('hidden');
        };

        window.searchJobsForScout = async function () {
            if (!currentUser) return;

            const company = $('#selector-search-company').val().trim();
            const prefecture = $('#selector-search-prefecture').val();
            const keyword = $('#selector-search-keyword').val().trim();

            const container = $('#selector-job-results');
            container.html('<div class="text-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto"></div></div>');

            try {
                let query = supabase
                    .from('jobs')
                    .select('id, title, company, location, description, updated_at')
                    .eq('organization_id', currentUser.organization_id)
                    .eq('status', 'active');

                if (company) {
                    query = query.ilike('company', `%${company}%`);
                }

                if (prefecture) {
                    query = query.ilike('location', `%${prefecture}%`);
                }

                if (keyword) {
                    // search title and description
                    query = query.or(`title.ilike.%${keyword}%, description.ilike.%${keyword}%`);
                }

                query = query.order('updated_at', { ascending: false }).limit(50);

                const { data, error } = await query;

                if (error) throw error;

                if (!data || data.length === 0) {
                    container.html('<div class="text-center py-8 text-gray-500">条件に一致する求人は見つかりませんでした</div>');
                    return;
                }

                const html = data.map(job => `
                <div class="bg-gray-50 hover:bg-gray-100 p-3 rounded border border-gray-200 flex justify-between items-center transition">
                        <div class="flex-1 min-w-0 mr-4">
                            <h5 class="font-bold text-gray-800 truncate">${job.title}</h5>
                            <p class="text-xs text-gray-600 truncate">
                                <i class="fas fa-building mr-1"></i>${job.company || '会社名なし'}
                                <span class="mx-2 text-gray-300">|</span>
                                <i class="fas fa-map-marker-alt mr-1"></i>${job.location || '勤務地なし'}
                            </p>
                            <p class="text-xs text-gray-400 mt-1 truncate">${(job.description || '').substring(0, 50)}...</p>
                        </div>
                        <button onclick="selectJobForScout('${job.id}')" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold py-2 px-4 rounded whitespace-nowrap">
                            選択
                        </button>
                    </div>
                `).join('');

                container.html(html);

            } catch (e) {
                console.error('Job search error:', e);
                container.html('<div class="text-center py-8 text-red-500">検索エラーが発生しました</div>');
            }
        }

        window.selectJobForScout = async function (jobId) {
            // Close modal
            closeJobSelectorForScout();

            // Fetch full job details (reuse existing query or just simple fetch)
            // generateScoutForSelectedJob expects {id, title} at minimum
            try {
                const { data: job, error } = await supabase.from('jobs').select('id, title').eq('id', jobId).single();
                if (error || !job) {
                    alert('求人情報の取得に失敗しました');
                    return;
                }
                generateScoutForSelectedJob(job);
            } catch (e) {
                console.error(e);
                alert('エラーが発生しました');
            }
        }

        window.generateScoutForSelectedJob = async function (job) {
            const instruction = `以下の特定の求人に対するスカウト文面を作成してください。\n(他の求人は無視して、この求人に絞って提案してください) \n\n【ターゲット求人情報】\n求人名: ${job.title} \n求人ID: ${job.id} `;
            $('#scout-instruction-text').val(instruction);
            analyzeProfile(instruction, job.id);
        }
        window.resetProfileAnalysis = function () {
            uploadedFiles = [];
            $('#profile-file-input').val('');
            $('#file-list').empty();
            $('#profile-text-input').val('');
            $('#candidate-title-input').val(''); // Clear title
            $('#scout-instruction-text').val('');
            $('#scout-instruction-container').addClass('hidden');
            $('#analysis-placeholder').removeClass('hidden');
            $('#analysis-loading').addClass('hidden');
            $('#analysis-results').addClass('hidden');
            $('#suggested-jobs-container').empty();
            window.currentAnalysisHistoryId = null;
            window.currentExternalCandidateId = null; // Clear candidate ID
            if ($('#current-analysis-history-id').length) $('#current-analysis-history-id').val('');
        }

        /* ... existing analyzeProfile ... */

        window.saveExternalCandidateProfile = async function (analysisData) {
            try {
                const customTitle = $('#candidate-title-input').val().trim();
                const payload = {
                    organization_id: currentUser.organization_id,
                    profile_text: analysisData.candidate_summary,
                    parsed_data: analysisData,
                    status: 'new',
                    custom_title: customTitle || null,
                    updated_at: new Date().toISOString()
                };

                // DEBUG: Check payload
                console.log('Saving External Candidate. Payload:', payload);
                console.log('Current User Org ID:', currentUser?.organization_id);
                if (!currentUser?.organization_id) {
                    alert('エラー: 組織IDが取得できませんでした。再ログインしてください。');
                    return;
                }

                // DEBUG: Check RLS Function result
                try {
                    const { data: dbOrgId, error: rpcError } = await supabase.rpc('get_my_org_id');
                    console.log('RPC get_my_org_id result:', dbOrgId, rpcError);

                    if (dbOrgId !== currentUser.organization_id) {
                        alert(`【重要】ID不一致検出\nDB上の組織ID: ${dbOrgId} \nアプリ上の組織ID: ${currentUser.organization_id} \n\nこれが原因で保存が拒否されています。`);
                    } else {
                        console.log('Org IDs match confirmed.');
                    }
                } catch (e) {
                    console.error('RPC Error:', e);
                }

                let resultData, resultError;

                if (window.currentExternalCandidateId) {
                    // Update existing
                    const { data, error } = await supabase
                        .from('external_candidates')
                        .update(payload)
                        .eq('id', window.currentExternalCandidateId)
                        .select();
                    resultData = data;
                    resultError = error;
                } else {
                    // Insert new
                    const { data, error } = await supabase
                        .from('external_candidates')
                        .insert(payload)
                        .select();
                    resultData = data;
                    resultError = error;
                }

                if (resultData && resultData[0]) {
                    window.currentExternalCandidateId = resultData[0].id; // Ensure ID is set
                }

                // タブがアクティブならリロード
                if (!$('#profile-scout_management-tab-content').hasClass('hidden')) {
                    loadScoutManagement();
                }
            } catch (e) {
                console.error('Failed to save to external_candidates', e);
            }
        }

        window.saveScoutMessage = async function (btn, jobId) {
            const container = $(btn).closest('.bg-white'); // Card container
            const subject = (container.find('.scout-subject-input').val() || container.find('p:contains("件名:")').text().replace('件名: ', '') || '').trim();
            const body = (container.find('.scout-body-textarea').val() || container.find('.scout-body-text').text() || '').trim();

            if (!subject || !body) {
                alert('スカウト文面が取得できませんでした');
                return;
            }

            if (!confirm('このスカウト文面を「送信済み」として登録しますか？')) return;

            if (!window.currentExternalCandidateId) {
                // Not yet saved to DB. Save profile first.
                if (window.analysisResultsData && window.saveExternalCandidateProfile) {
                    try {
                        await window.saveExternalCandidateProfile(window.analysisResultsData);
                    } catch (e) {
                        console.error('Failed to save profile before scout:', e);
                    }
                }
            }

            if (!window.currentExternalCandidateId) {
                alert("候補者情報の保存が完了していません。\nDBへの保存が失敗している可能性があります。\n(migration_scout_features.sqlが正しく実行されているか確認してください)");
                return;
            }

            try {
                // Insert into scout_messages
                const { error } = await supabase.from('scout_messages').insert({
                    organization_id: currentUser.organization_id,
                    external_candidate_id: window.currentExternalCandidateId,
                    job_id: jobId,
                    subject: subject,
                    message_body: body,
                    status: 'sent',
                    sent_at: new Date().toISOString(),
                    created_by: currentUser.id
                });

                if (error) throw error;

                alert('スカウトを登録しました');
                $(btn).removeClass('text-gray-400').addClass('text-green-600').text('送信済').prop('disabled', true);

                if (!$('#profile-scout_management-tab-content').hasClass('hidden')) {
                    loadScoutManagement();
                }

            } catch (e) {
                console.error('Save scout error:', e);
                alert('保存に失敗しました');
            }
        }

        /* ---------------------------------------------------- */
        /*  Analytics Logic                                     */
        /* ---------------------------------------------------- */

        window.loadScoutAnalytics = async function () {
            if (!currentUser) return;
            const userStatsContainer = $('#analytics-user-stats');
            const orgStatsContainer = $('#analytics-org-stats');
            const detailsContainer = $('#analytics-details-container');

            try {
                // Fetch ALL messages for the organization
                // We need status and created_by
                const { data: messages, error } = await supabase
                    .from('scout_messages')
                    .select('id, status, created_by, created_at')
                    .eq('organization_id', currentUser.organization_id);

                if (error) throw error;

                if (!messages || messages.length === 0) {
                    userStatsContainer.html('<div class="col-span-2 text-center text-gray-500">データなし</div>');
                    orgStatsContainer.html('<div class="col-span-2 text-center text-gray-500">データなし</div>');
                    return;
                }

                // --- Calculate Stats ---
                const calculateStats = (msgs) => {
                    const totalSent = msgs.filter(m => ['sent', 'replied', 'interview', 'rejected', 'hired'].includes(m.status)).length;
                    const replied = msgs.filter(m => ['replied', 'interview', 'rejected', 'hired'].includes(m.status)).length;
                    const interview = msgs.filter(m => ['interview', 'hired'].includes(m.status)).length;

                    const replyRate = totalSent > 0 ? ((replied / totalSent) * 100).toFixed(1) : '0.0';
                    const interviewRate = totalSent > 0 ? ((interview / totalSent) * 100).toFixed(1) : '0.0';

                    return { totalSent, replied, interview, replyRate, interviewRate };
                };

                const orgStats = calculateStats(messages);
                const userData = messages.filter(m => m.created_by === currentUser.id);
                const userStats = calculateStats(userData);

                // --- Render Stats ---
                const renderStatItem = (label, value, unit = '', subText = '') => `
                <div class="bg-indigo-50 rounded p-3 text-center">
                        <div class="text-xs text-gray-500 font-bold mb-1">${label}</div>
                        <div class="text-2xl font-bold text-indigo-700">${value}<span class="text-sm font-normal text-gray-600 ml-1">${unit}</span></div>
                        ${subText ? `<div class="text-xs text-gray-400 mt-1">${subText}</div>` : ''}
                    </div>
                `;

                orgStatsContainer.html(`
                    ${renderStatItem('総送信数', orgStats.totalSent, '件')}
                    ${renderStatItem('返信数', orgStats.replied, '件', `返信率: ${orgStats.replyRate}%`)}
                    ${renderStatItem('面談設定数', orgStats.interview, '件', `面談率: ${orgStats.interviewRate}%`)}
            `);

                userStatsContainer.html(`
                    ${renderStatItem('総送信数', userStats.totalSent, '件')}
                    ${renderStatItem('返信数', userStats.replied, '件', `返信率: ${userStats.replyRate}%`)}
                    ${renderStatItem('面談設定数', userStats.interview, '件', `面談率: ${userStats.interviewRate}%`)}
            `);

                // --- Render Details Table (Org Wide) ---
                // Shows breakdown by status
                const statuses = ['sent', 'replied', 'interview', 'rejected', 'hired'];
                const statusLabels = { sent: '送信済(未読/未返信)', replied: '返信あり', interview: '面談設定', rejected: '辞退/不採用', hired: '採用決定' };

                const rows = statuses.map(s => {
                    const count = messages.filter(m => m.status === s).length;
                    const rate = orgStats.totalSent > 0 ? ((count / orgStats.totalSent) * 100).toFixed(1) : '0.0';
                    return `
                <tr>
                            <td class="px-6 py-4 text-sm text-gray-900">${statusLabels[s]}</td>
                            <td class="px-6 py-4 text-sm text-gray-900 text-right">${count} 件</td>
                            <td class="px-6 py-4 text-sm text-gray-500 text-right">${rate} %</td>
                        </tr>
                `;
                }).join('');

                detailsContainer.html(`
                <table class="min-w-full divide-y divide-gray-200 border border-gray-200 rounded">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ステータス</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">件数</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">構成比</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${rows}
                        </tbody>
                    </table>
                `);

            } catch (e) {
                console.error("Analytics Error:", e);
                userStatsContainer.html('<p class="text-red-500">読み込みエラー</p>');
            }
        }
        // ========================
        // Admin Settings
        // ========================
        window.loadAdminSettings = async function () {
            if (!currentUser) return;

            try {
                // 組織情報を取得
                const { data: org, error } = await supabase
                    .from('organizations')
                    .select('settings')
                    .eq('id', currentUser.organization_id)
                    .single();

                if (error) throw error;

                // 設定値をフォームに反映
                const settings = org.settings || {};
                const visibility = settings.analysis_history_visibility || 'all';
                const scoutVisibility = settings.scout_history_visibility || 'all';

                $('input[name="setting-history-visibility"][value="' + visibility + '"]').prop('checked', true);
                $('input[name="setting-scout-visibility"][value="' + scoutVisibility + '"]').prop('checked', true);

            } catch (error) {
                console.error('Load admin settings error:', error);
                alert('設定の読み込みに失敗しました');
            }
        };

        window.saveAdminSettings = async function () {
            if (!currentUser) return;

            if (!confirm('設定を保存してもよろしいですか？')) return;

            try {
                // 1. 現在の設定を取得（マージするため）
                const { data: currentOrg, error: fetchError } = await supabase
                    .from('organizations')
                    .select('settings')
                    .eq('id', currentUser.organization_id)
                    .single();

                if (fetchError) throw fetchError;

                let newSettings = currentOrg.settings || {};

                // 2. フォームから値を取得して更新
                const visibility = $('input[name="setting-history-visibility"]:checked').val();
                const scoutVisibility = $('input[name="setting-scout-visibility"]:checked').val();

                newSettings.analysis_history_visibility = visibility;
                newSettings.scout_history_visibility = scoutVisibility;

                // 3. 保存 (RPCを使用)
                const { error: updateError } = await supabase
                    .rpc('update_organization_settings', { new_settings: newSettings });

                if (updateError) throw updateError;

                alert('設定を保存しました');

            } catch (error) {
                console.error('Save admin settings error:', error);
                alert('設定の保存に失敗しました: ' + (error.message || error.details || JSON.stringify(error)));
            }
        };

        // ============================================
        // KPI Dashboard Logic
        // ============================================
        let kpiChartFunnel = null;
        let kpiChartActivity = null;

        async function loadKPIDashboard() {
            const currentUser = window.currentUser;
            const supabase = window.supabase;
            if (!currentUser || !currentUser.organization_id) return;

            window.showLoading('KPIデータを集計中...');

            try {
                // 1. Get Filters
                const period = $('#kpi-filter-period').val();
                const userIdFilter = $('#kpi-filter-user').val();

                // 2. Fetch Data
                // Fetch Applications (with Job and User info)
                let query = supabase
                    .from('applications')
                    .select('*, jobs!inner(title, salary_min, salary_max, company), users!applications_user_id_fkey!inner(name, coach_id)')
                    .eq('jobs.organization_id', currentUser.organization_id);

                // Period Filter
                const now = new Date();
                let startDate;
                if (period === 'this_month') startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                else if (period === 'last_month') startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                else if (period === 'this_quarter') startDate = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
                else if (period === 'this_year') startDate = new Date(now.getFullYear(), 0, 1);

                if (startDate) {
                    query = query.gte('updated_at', startDate.toISOString());
                }

                if (userIdFilter) {
                    query = query.eq('users.coach_id', userIdFilter);
                }

                const { data: applications, error } = await query;
                if (error) throw error;

                // Load Coaches for Mapping and Filter
                const { data: allCoaches } = await window.supabase
                    .from('users')
                    .select('id, name')
                    .eq('organization_id', currentUser.organization_id)
                    .in('role', ['coach', 'admin', 'org_admin', 'super_admin']);

                const coachNameMap = {};
                if (allCoaches) {
                    allCoaches.forEach(c => {
                        coachNameMap[c.id] = c.name;
                        // Populate filter if empty (or missing)
                        if ($('#kpi-filter-user option[value="' + c.id + '"]').length === 0) {
                            $('#kpi-filter-user').append(`< option value = "${c.id}" > ${c.name}</option > `);
                        }
                    });
                }

                const summary = calculateKPISummary(applications || []);
                const funnelData = calculateKPIFunnel(applications || []);
                const activityData = calculateKPIActivity(applications || [], coachNameMap);
                const stagnantCases = identifyStagnantCases(applications || []);

                renderKPICards(summary);
                renderKPIFunnelChart(funnelData);
                renderKPIActivityChart(activityData);
                renderKPIStagnantTable(stagnantCases);

            } catch (e) {
                console.error('KPI Load Error:', e);
            } finally {
                window.hideLoading();
            }
        }

        function calculateKPISummary(apps) {
            let revenue = 0;
            let candidates = 0;
            let success = 0;
            const PROB = { 'pending': 0, 'applied': 0.1, 'interviewing': 0.3, 'offered': 0.8, 'rejected': 0, 'withdrawn': 0 };
            const FEE_RATE = 0.35;

            apps.forEach(app => {
                if (!['rejected', 'withdrawn', 'pending'].includes(app.status)) candidates++;
                if (app.status === 'offered') success++;
                const salary = app.jobs.salary_min || 4000000;
                const prob = PROB[app.status] || 0;
                revenue += (salary * FEE_RATE * prob);
            });
            return { revenue, candidates, success };
        }

        function calculateKPIFunnel(apps) {
            const counts = { 'applied': 0, 'interviewing': 0, 'offered': 0 };
            apps.forEach(app => {
                const s = app.status;
                if (['applied', 'interviewing', 'offered'].includes(s)) counts['applied']++;
                if (['interviewing', 'offered'].includes(s)) counts['interviewing']++;
                if (['offered'].includes(s)) counts['offered']++;
            });
            return counts;
        }

        function calculateKPIActivity(apps, nameMap) {
            const activity = {};
            apps.forEach(app => {
                const cid = app.users.coach_id;
                const name = cid ? (nameMap && nameMap[cid] ? nameMap[cid] : 'Unknown') : '未アサイン';

                if (!activity[name]) activity[name] = 0;
                activity[name]++;
            });
            return activity;
        }

        function identifyStagnantCases(apps) {
            const now = new Date();
            const thresholdDays = 5;
            const stagnant = [];
            apps.forEach(app => {
                if (['rejected', 'withdrawn', 'offered'].includes(app.status)) return;
                const lastUpdate = new Date(app.updated_at);
                const diffDays = Math.ceil(Math.abs(now - lastUpdate) / (1000 * 60 * 60 * 24));
                if (diffDays >= thresholdDays) stagnant.push({ ...app, days_stagnant: diffDays });
            });
            return stagnant;
        }

        function renderKPICards(summary) {
            $('#kpi-metric-revenue').text(`¥${Math.floor(summary.revenue / 10000).toLocaleString()} 万`);
            $('#kpi-metric-candidates').text(summary.candidates);
            $('#kpi-metric-success').text(summary.success);
            fetchActiveJobs().then(jobs => { if (jobs) $('#kpi-metric-jobs').text(jobs.length); });
        }

        function renderKPIFunnelChart(data) {
            const ctx = document.getElementById('kpi-funnel-chart');
            if (!ctx) return;
            if (kpiChartFunnel) kpiChartFunnel.destroy();
            kpiChartFunnel = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['書類選考/推薦', '面接中', '内定/成約'],
                    datasets: [{
                        label: '候補者数',
                        data: [data.applied, data.interviewing, data.offered],
                        backgroundColor: ['rgba(99, 102, 241, 0.5)', 'rgba(167, 139, 250, 0.5)', 'rgba(16, 185, 129, 0.5)'],
                        borderColor: ['rgb(99, 102, 241)', 'rgb(167, 139, 250)', 'rgb(16, 185, 129)'],
                        borderWidth: 1
                    }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function renderKPIActivityChart(activityData) {
            const ctx = document.getElementById('kpi-activity-chart');
            if (!ctx) return;
            if (kpiChartActivity) kpiChartActivity.destroy();
            kpiChartActivity = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: Object.keys(activityData),
                    datasets: [{ label: 'アクション数', data: Object.values(activityData), backgroundColor: 'rgba(59, 130, 246, 0.5)' }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }

        function renderKPIStagnantTable(cases) {
            const tbody = $('#kpi-stagnant-table-body');
            tbody.empty();
            $('#stagnant-cases-count').text(`${cases.length} 件`);
            if (cases.length === 0) {
                tbody.html('<tr><td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">停滞している案件はありません</td></tr>');
                return;
            }
            cases.forEach(c => {
                const tr = `<tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${c.users.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${c.jobs.title}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">${c.status}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(c.updated_at).toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">ID: ${c.users.coach_id || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><button class="text-indigo-600 hover:text-indigo-900">詳細</button></td></tr>`;
                tbody.append(tr);
            });
        }
    </script>
    <!-- Job Detail Modal -->
    <div id="job-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
        style="z-index: 30000;">
        <div class="bg-white rounded-lg w-full max-w-6xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-900" id="job-detail-title">求人詳細</h3>
                <button onclick="closeJobDetailModal()"
                    class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <!-- タブナビゲーション -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="flex space-x-8">
                    <button onclick="switchJobDetailTab('details')" id="job-tab-details"
                        class="job-detail-tab py-4 px-1 border-b-2 border-indigo-600 font-medium text-sm text-indigo-600">
                        求人情報
                    </button>
                    <button onclick="switchJobDetailTab('candidates')" id="job-tab-candidates"
                        class="job-detail-tab py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        マッチング候補者
                        <span id="job-candidates-count"
                            class="ml-2 bg-gray-100 text-gray-600 py-1 px-2 rounded-full text-xs"></span>
                    </button>
                </nav>
            </div>

            <!-- 求人詳細タブ -->
            <div id="job-detail-tab-content" class="space-y-6">
                <!-- Job details will be loaded here -->
            </div>

            <!-- 候補者マッチングタブ -->
            <div id="job-candidates-tab-content" class="hidden">
                <div class="mb-4 flex justify-between items-center">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900">AIマッチング候補者</h4>
                        <p class="text-sm text-gray-600">この求人に最適な候補者を表示しています</p>
                    </div>
                    <button onclick="runJobMatching()" id="run-matching-btn"
                        class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center gap-2">
                        <i class="fas fa-magic"></i>
                        <span>AI マッチング実行</span>
                    </button>
                </div>

                <!-- マッチング候補者リスト -->
                <div id="job-candidates-list" class="space-y-4">
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-users text-4xl mb-3"></i>
                        <p>「AI マッチング実行」ボタンをクリックして候補者を検索してください</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- スカウト作成モーダル -->
    <div id="scout-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center hidden"
        style="z-index: 99999 !important; position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; background-color: rgba(0, 0, 0, 0.8) !important;">
        <div class="bg-white rounded-lg w-full max-w-2xl p-6" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-paper-plane text-indigo-600 mr-2"></i>スカウトメッセージ作成
                </h3>
                <button onclick="closeScoutModal()"
                    class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="space-y-4">
                <!-- 宛先 -->
                <div class="bg-gray-50 p-3 rounded border">
                    <span class="text-gray-600 text-sm">宛先:</span>
                    <span id="scout-candidate-name" class="font-bold text-gray-900 ml-2"></span>
                </div>

                <!-- 件名 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">件名</label>
                    <input type="text" id="scout-subject"
                        class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- 本文 -->
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="block text-sm font-medium text-gray-700">本文</label>
                        <button onclick="regenerateScoutMessage()"
                            class="text-xs text-indigo-600 hover:text-indigo-800 flex items-center">
                            <i class="fas fa-sync-alt mr-1"></i>AIで再生成
                        </button>
                    </div>
                    <textarea id="scout-body" rows="10"
                        class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>

                <!-- アクション -->
                <div class="flex justify-end gap-3 pt-4 border-t">
                    <button onclick="closeScoutModal()"
                        class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded">キャンセル</button>
                    <button onclick="sendScoutMessage()"
                        class="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 flex items-center">
                        <i class="fas fa-paper-plane mr-2"></i>送信する
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dynamic modal is injected here via JS -->
    <!-- 職務経歴書プレビューモーダル -->
    <div id="resume-preview-modal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center"
        style="z-index: 10003; width: 100vw; height: 100vh; top: 0; left: 0; display: none;">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-5xl max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b bg-gradient-to-r from-blue-600 to-indigo-600">
                <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                    <i class="fas fa-file-alt"></i>
                    職務経歴書プレビュー
                </h2>
                <button onclick="closeResumePreviewModal()" class="text-white hover:text-gray-200">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 180px);">
                <!-- 生成中表示 -->
                <div id="resume-generating" class="text-center py-16">
                    <i class="fas fa-spinner fa-spin text-6xl text-indigo-600 mb-6"></i>
                    <p class="text-xl text-gray-700 font-medium">AIが職務経歴書を生成中...</p>
                    <p class="text-sm text-gray-500 mt-2">求人情報とマッチング分析に基づいて最適な内容を作成しています</p>
                </div>

                <!-- プレビュー表示 -->
                <div id="resume-preview-content" class="hidden space-y-4">
                    <div class="bg-blue-50 border-l-4 border-blue-600 p-4 mb-6">
                        <p class="text-sm text-blue-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            生成された内容を確認・編集してから「Word出力」ボタンでダウンロードできます
                        </p>
                    </div>

                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                                <i class="fas fa-user-circle text-indigo-600"></i>
                                職務要約
                            </label>
                            <textarea id="resume-summary" rows="4"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                placeholder="職務要約が表示されます"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                                <i class="fas fa-briefcase text-indigo-600"></i>
                                職務経歴
                            </label>
                            <textarea id="resume-work-history" rows="10"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-mono text-sm"
                                placeholder="職務経歴が表示されます"></textarea>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                                    <i class="fas fa-star text-indigo-600"></i>
                                    強み・活かせる経験
                                </label>
                                <textarea id="resume-strengths" rows="6"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    placeholder="強みが表示されます"></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                                    <i class="fas fa-laptop-code text-indigo-600"></i>
                                    PCスキル・資格
                                </label>
                                <textarea id="resume-skills" rows="6"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    placeholder="スキル・資格が表示されます"></textarea>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                                <i class="fas fa-comment-dots text-indigo-600"></i>
                                自己PR
                            </label>
                            <textarea id="resume-self-pr" rows="5"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                placeholder="自己PRが表示されます"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                                <i class="fas fa-heart text-indigo-600"></i>
                                志望動機
                            </label>
                            <textarea id="resume-motivation" rows="5"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                placeholder="志望動機が表示されます"></textarea>
                        </div>
                    </div>
                </div>

                <!-- エラー表示 -->
                <div id="resume-error" class="hidden text-center py-16">
                    <i class="fas fa-exclamation-triangle text-6xl text-red-600 mb-6"></i>
                    <p class="text-xl text-red-600 font-medium" id="resume-error-message"></p>
                    <button onclick="regenerateResume()"
                        class="mt-6 px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        <i class="fas fa-redo mr-2"></i>再試行
                    </button>
                </div>
            </div>

            <div class="flex justify-end gap-3 p-6 border-t bg-gray-50">
                <button onclick="closeResumePreviewModal()"
                    class="px-6 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-100 font-medium">
                    キャンセル
                </button>
                <button onclick="regenerateResume()"
                    class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 font-medium">
                    <i class="fas fa-sync"></i>
                    再生成
                </button>
                <button onclick="downloadResumeWord()"
                    class="px-6 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center gap-2 font-medium">
                    <i class="fas fa-file-word"></i>
                    Word出力
                </button>
            </div>
        </div>
    </div>

    <!-- 推薦状プレビューモーダル -->
    <div id="recommendation-doc-preview-modal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center"
        style="z-index: 10003; width: 100vw; height: 100vh; top: 0; left: 0; display: none;">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-4xl max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b bg-gradient-to-r from-purple-600 to-pink-600">
                <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                    <i class="fas fa-file-signature"></i>
                    推薦状プレビュー
                </h2>
                <button onclick="closeRecommendationDocPreviewModal()" class="text-white hover:text-gray-200">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 180px);">
                <!-- 生成中表示 -->
                <div id="recommendation-doc-generating" class="text-center py-16">
                    <i class="fas fa-spinner fa-spin text-6xl text-purple-600 mb-6"></i>
                    <p class="text-xl text-gray-700 font-medium">AIが推薦状を生成中...</p>
                    <p class="text-sm text-gray-500 mt-2">企業向けの正式な推薦状を作成しています</p>
                </div>

                <!-- プレビュー表示 -->
                <div id="recommendation-doc-preview-content" class="hidden">
                    <div class="bg-purple-50 border-l-4 border-purple-600 p-4 mb-6">
                        <p class="text-sm text-purple-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            生成された推薦状を確認・編集してから「Word出力」ボタンでダウンロードできます
                        </p>
                    </div>

                    <div class="bg-white border-2 border-gray-200 rounded-lg p-6">
                        <textarea id="recommendation-doc-full-text" rows="25"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent font-serif text-sm leading-relaxed"
                            placeholder="推薦状が表示されます"></textarea>
                    </div>
                </div>

                <!-- エラー表示 -->
                <div id="recommendation-doc-error" class="hidden text-center py-16">
                    <i class="fas fa-exclamation-triangle text-6xl text-red-600 mb-6"></i>
                    <p class="text-xl text-red-600 font-medium" id="recommendation-doc-error-message"></p>
                    <button onclick="regenerateRecommendationDoc()"
                        class="mt-6 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        <i class="fas fa-redo mr-2"></i>再試行
                    </button>
                </div>
            </div>

            <div class="flex justify-end gap-3 p-6 border-t bg-gray-50">
                <button onclick="closeRecommendationDocPreviewModal()"
                    class="px-6 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-100 font-medium">
                    キャンセル
                </button>
                <button onclick="regenerateRecommendationDoc()"
                    class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 font-medium">
                    <i class="fas fa-sync"></i>
                    再生成
                </button>
                <button onclick="downloadRecommendationDocWord()"
                    class="px-6 py-2.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center gap-2 font-medium">
                    <i class="fas fa-file-word"></i>
                    Word出力
                </button>
            </div>
        </div>
    </div>
</body>

</html>
