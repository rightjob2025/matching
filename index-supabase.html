import { serve } from "https://deno.land/std@0.168.0/http/server.ts"

const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

// Resend API Key (環境変数から取得)
const RESEND_API_KEY = Deno.env.get('RESEND_API_KEY')

interface EmailRequest {
    type: 'application_submitted' | 'invitation' | 'password_reset' | 'status_changed' | 'scout' | 'recommendation'
    to: string
    data: {
        userName?: string
        jobTitle?: string
        companyName?: string
        invitationUrl?: string
        resetUrl?: string
        oldStatus?: string
        newStatus?: string
        organizationName?: string
        // Scout related fields
        subject?: string
        body?: string
        scoutUrl?: string
    }
}

serve(async (req) => {
    if (req.method === 'OPTIONS') {
        return new Response('ok', { headers: corsHeaders })
    }

    try {
        const { type, to, data }: EmailRequest = await req.json()

        if (!RESEND_API_KEY) {
            throw new Error('RESEND_API_KEY is not configured')
        }

        if (!to || !type) {
            throw new Error('Email address and type are required')
        }

        // メールテンプレートを取得
        const emailContent = getEmailTemplate(type, data)

        // Resend APIを使用してメール送信
        const res = await fetch('https://api.resend.com/emails', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${RESEND_API_KEY}`,
            },
            body: JSON.stringify({
                from: 'rightjob <noreply@rightjob.info>',
                to: [to],
                subject: emailContent.subject,
                html: emailContent.html,
            }),
        })

        if (!res.ok) {
            const error = await res.text()
            throw new Error(`Failed to send email: ${error}`)
        }

        const result = await res.json()

        return new Response(
            JSON.stringify({ success: true, messageId: result.id }),
            {
                headers: { ...corsHeaders, 'Content-Type': 'application/json' },
                status: 200,
            }
        )

    } catch (error) {
        console.error('Send email error:', error)
        return new Response(
            JSON.stringify({ error: error.message }),
            {
                headers: { ...corsHeaders, 'Content-Type': 'application/json' },
                status: 400,
            }
        )
    }
})

function getEmailTemplate(type: string, data: any): { subject: string; html: string } {
    switch (type) {
        case 'scout':
        case 'recommendation':
            return {
                subject: data.subject || (type === 'scout' ? '【RightJob】スカウトのお知らせ' : '【RightJob】求人のご紹介'),
                html: `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="utf-8">
                        <style>
                            body { font-family: 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; }
                            .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                            .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
                            .content { background: #f9fafb; padding: 30px; border-radius: 0 0 10px 10px; }
                            .button { display: inline-block; background: #667eea; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; margin: 20px 0; }
                            .footer { text-align: center; margin-top: 30px; color: #666; font-size: 12px; }
                            .message-body { background: white; padding: 20px; border-radius: 5px; margin: 20px 0; white-space: pre-wrap; }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <div class="header">
                                <h1>${type === 'scout' ? 'スカウトのお知らせ' : '案件紹介のお知らせ'}</h1>
                            </div>
                            <div class="content">
                                <p>${data.userName}様</p>
                                <p>${type === 'scout' ? '企業からスカウトメッセージが届きました。' : 'キャリアアドバイザーよりおすすめの案件をご紹介します。'}</p>
                                <div class="message-body">
                                    ${(data.body || '').replace(/\n/g, '<br>')}
                                </div>
                                ${data.scoutUrl ? `
                                <div style="text-align: center;">
                                    <a href="${data.scoutUrl}" class="button">詳細を確認する</a>
                                </div>
                                ` : ''}
                            </div>
                            <div class="footer">
                                <p>このメールは自動送信されています。</p>
                                <p>&copy; 2024 RightJob. All rights reserved.</p>
                            </div>
                        </div>
                    </body>
                    </html>
                `
            }

        case 'application_submitted':
            return {
                subject: `【RightJob】応募完了のお知らせ - ${data.jobTitle}`,
                html: `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="utf-8">
                        <style>
                            body { font-family: 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; }
                            .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                            .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
                            .content { background: #f9fafb; padding: 30px; border-radius: 0 0 10px 10px; }
                            .button { display: inline-block; background: #667eea; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; margin: 20px 0; }
                            .footer { text-align: center; margin-top: 30px; color: #666; font-size: 12px; }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <div class="header">
                                <h1>応募完了</h1>
                            </div>
                            <div class="content">
                                <p>${data.userName}様</p>
                                <p>以下の求人への応募が完了しました。</p>
                                <div style="background: white; padding: 20px; border-radius: 5px; margin: 20px 0;">
                                    <h3 style="margin-top: 0;">${data.jobTitle}</h3>
                                    <p style="color: #666;">${data.companyName}</p>
                                </div>
                                <p>選考結果については、担当者から別途ご連絡いたします。</p>
                                <p>引き続きよろしくお願いいたします。</p>
                            </div>
                            <div class="footer">
                                <p>このメールは自動送信されています。</p>
                                <p>&copy; 2024 RightJob. All rights reserved.</p>
                            </div>
                        </div>
                    </body>
                    </html>
                `
            }

        case 'invitation':
            return {
                subject: '【RightJob】招待のお知らせ',
                html: `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="utf-8">
                        <style>
                            body { font-family: 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; }
                            .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                            .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
                            .content { background: #f9fafb; padding: 30px; border-radius: 0 0 10px 10px; }
                            .button { display: inline-block; background: #667eea; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; margin: 20px 0; }
                            .footer { text-align: center; margin-top: 30px; color: #666; font-size: 12px; }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <div class="header">
                                <h1>RightJobへの招待</h1>
                            </div>
                            <div class="content">
                                <p>${data.organizationName}からRightJobへ招待されました。</p>
                                <p>以下のリンクからアカウントを作成してください。</p>
                                <div style="text-align: center;">
                                    <a href="${data.invitationUrl}" class="button">アカウントを作成</a>
                                </div>
                                <p style="color: #666; font-size: 14px;">※このリンクは7日間有効です。</p>
                            </div>
                            <div class="footer">
                                <p>このメールは自動送信されています。</p>
                                <p>&copy; 2024 RightJob. All rights reserved.</p>
                            </div>
                        </div>
                    </body>
                    </html>
                `
            }

        case 'password_reset':
            return {
                subject: '【RightJob】パスワードリセットのご案内',
                html: `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="utf-8">
                        <style>
                            body { font-family: 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; }
                            .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                            .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
                            .content { background: #f9fafb; padding: 30px; border-radius: 0 0 10px 10px; }
                            .button { display: inline-block; background: #667eea; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; margin: 20px 0; }
                            .footer { text-align: center; margin-top: 30px; color: #666; font-size: 12px; }
                            .warning { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; margin: 20px 0; }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <div class="header">
                                <h1>パスワードリセット</h1>
                            </div>
                            <div class="content">
                                <p>パスワードリセットのリクエストを受け付けました。</p>
                                <p>以下のリンクから新しいパスワードを設定してください。</p>
                                <div style="text-align: center;">
                                    <a href="${data.resetUrl}" class="button">パスワードをリセット</a>
                                </div>
                                <div class="warning">
                                    <p style="margin: 0;"><strong>⚠️ セキュリティに関する注意</strong></p>
                                    <p style="margin: 5px 0 0 0; font-size: 14px;">このリンクは1時間有効です。リクエストに心当たりがない場合は、このメールを無視してください。</p>
                                </div>
                            </div>
                            <div class="footer">
                                <p>このメールは自動送信されています。</p>
                                <p>&copy; 2024 RightJob. All rights reserved.</p>
                            </div>
                        </div>
                    </body>
                    </html>
                `
            }

        case 'status_changed':
            return {
                subject: `【RightJob】選考ステータス更新のお知らせ - ${data.jobTitle}`,
                html: `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="utf-8">
                        <style>
                            body { font-family: 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; }
                            .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                            .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
                            .content { background: #f9fafb; padding: 30px; border-radius: 0 0 10px 10px; }
                            .status-box { background: white; padding: 20px; border-radius: 5px; margin: 20px 0; text-align: center; }
                            .footer { text-align: center; margin-top: 30px; color: #666; font-size: 12px; }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <div class="header">
                                <h1>選考ステータス更新</h1>
                            </div>
                            <div class="content">
                                <p>${data.userName}様</p>
                                <p>以下の求人の選考ステータスが更新されました。</p>
                                <div style="background: white; padding: 20px; border-radius: 5px; margin: 20px 0;">
                                    <h3 style="margin-top: 0;">${data.jobTitle}</h3>
                                    <p style="color: #666;">${data.companyName}</p>
                                </div>
                                <div class="status-box">
                                    <p style="margin: 0; color: #666;">ステータス</p>
                                    <p style="margin: 10px 0 0 0; font-size: 20px; font-weight: bold; color: #667eea;">${data.newStatus}</p>
                                </div>
                                <p>詳細については、担当者から別途ご連絡いたします。</p>
                            </div>
                            <div class="footer">
                                <p>このメールは自動送信されています。</p>
                                <p>&copy; 2024 RightJob. All rights reserved.</p>
                            </div>
                        </div>
                    </body>
                    </html>
                `
            }

        default:
            throw new Error(`Unknown email type: ${type}`)
    }
}
