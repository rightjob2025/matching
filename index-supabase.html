-- Create table for storing external candidates parsed from files/text
CREATE TABLE IF NOT EXISTS external_candidates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL, -- Link to organization
    name TEXT, -- Extracted name (if any)
    email TEXT, -- Extracted email (if any)
    source_type TEXT, -- 'pdf', 'image', 'text'
    profile_text TEXT, -- Full extracted text or summary
    parsed_data JSONB, -- Structured data (skills, history, etc.)
    status TEXT DEFAULT 'new', -- 'new', 'scouted', 'interview'
    custom_title TEXT, -- User defined title (e.g. Media Name + Member ID)
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Ensure columns exist
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'external_candidates' AND column_name = 'status') THEN
        ALTER TABLE external_candidates ADD COLUMN status TEXT DEFAULT 'new';
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'external_candidates' AND column_name = 'custom_title') THEN
        ALTER TABLE external_candidates ADD COLUMN custom_title TEXT;
    END IF;
END $$;

-- Create table for managing scout messages sent to external candidates
CREATE TABLE IF NOT EXISTS scout_messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL,
    external_candidate_id UUID REFERENCES external_candidates(id),
    job_id UUID REFERENCES jobs(id),
    
    subject TEXT,
    message_body TEXT,
    
    status TEXT DEFAULT 'generated', -- 'generated', 'sent', 'replied', 'rejected', 'hired'
    
    feedback_score INTEGER, -- 1(Bad) to 5(Good) or similar
    feedback_text TEXT,
    
    sent_at TIMESTAMPTZ,
    created_by UUID, -- Sender User ID
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'scout_messages' AND column_name = 'created_by') THEN
        ALTER TABLE scout_messages ADD COLUMN created_by UUID;
    END IF;
END $$;

-- RLS Policies (assuming standard separation by organization_id)
ALTER TABLE external_candidates ENABLE ROW LEVEL SECURITY;
ALTER TABLE scout_messages ENABLE ROW LEVEL SECURITY;

-- RLS Policies (assuming standard separation by organization_id)
ALTER TABLE external_candidates ENABLE ROW LEVEL SECURITY;
ALTER TABLE scout_messages ENABLE ROW LEVEL SECURITY;

DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_policies 
        WHERE tablename = 'external_candidates' 
        AND policyname = 'Org Access Candidates'
    ) THEN
        CREATE POLICY "Org Access Candidates" ON external_candidates
            USING (organization_id = (SELECT organization_id FROM users WHERE id = auth.uid()));
    END IF;
END $$;

DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_policies 
        WHERE tablename = 'scout_messages' 
        AND policyname = 'Org Access Messages'
    ) THEN
        CREATE POLICY "Org Access Messages" ON scout_messages
            USING (organization_id = (SELECT organization_id FROM users WHERE id = auth.uid()));
    END IF;
END $$;

-- Add foreign key index for performance
CREATE INDEX IF NOT EXISTS idx_scout_messages_candidate ON scout_messages(external_candidate_id);
CREATE INDEX IF NOT EXISTS idx_scout_messages_job ON scout_messages(job_id);
