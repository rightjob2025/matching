-- 組織管理者に「担当CA・RA」の変更・更新権限を付与するRLSポリシー
-- すでに fix_users_rls_for_job_seekers.sql 等が適用されている場合でも、
-- より確実に権限を定義するためにこのスクリプトを実行してください。

-- 1. 既存の関連ポリシーを一時削除（名前が重複する可能性があるため）
DROP POLICY IF EXISTS "Update users within organization" ON users;
DROP POLICY IF EXISTS "Users can update within organization" ON users;

-- 2. 組織管理者、管理者、スーパー管理者が、同じ組織内のユーザーを更新できるようにするポリシー
-- また、コーチ(coach/ca/ra)も自組織のユーザー（求職者）を編集できるようにします。
CREATE POLICY "Update users within organization" ON users
    FOR UPDATE USING (
        -- 自分自身の情報は常に編集可能
        auth.uid() = id OR 
        (
            -- 同じ組織内で、かつ管理者権限またはスタッフ権限を持つユーザー
            (SELECT organization_id FROM users WHERE id = auth.uid()) = organization_id AND
            -- 更新を実行する側のロールが candidate 以外であること
            (SELECT role FROM users WHERE id = auth.uid()) IN ('org_admin', 'admin', 'super_admin', 'coach', 'ca', 'ra')
        )
    )
    WITH CHECK (
        -- 更新後のデータも同じ組織であること、または管理者が組織を跨いで編集する場合
        auth.uid() = id OR 
        (
            (SELECT organization_id FROM users WHERE id = auth.uid()) = organization_id OR
            (SELECT role FROM users WHERE id = auth.uid()) = 'super_admin'
        )
    );

-- 3. 参照（SELECT）ポリシーの再確認
DROP POLICY IF EXISTS "View users within organization" ON users;
CREATE POLICY "View users within organization" ON users
    FOR SELECT USING (
        auth.uid() = id OR 
        (
            -- 同じ組織内のユーザーは互いに参照可能
            (SELECT organization_id FROM users WHERE id = auth.uid()) = organization_id
        )
    );

-- 4. 念のため RLS を有効化
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
