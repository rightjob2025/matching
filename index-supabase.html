<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RightJob ãƒãƒƒãƒãƒ³ã‚° - Supabaseç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Chart.js for Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap');

        :root {
            --sidebar-width: 250px;
            --header-height: 64px;
            --primary: #4f46e5;
            --primary-dark: #4338ca;
        }

        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f8f9fa;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .spinner {
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Sidebar & Layout */
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0);
            }

            .main-content {
                margin-left: var(--sidebar-width);
            }
        }

        /* Custom Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }

        input[type=range]:focus {
            outline: none;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.2);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #ddd;
            border-radius: 5px;
        }

        /* AI Result Tabs */
        .ai-result-tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 1.5rem;
        }

        .ai-result-tab {
            flex: 1;
            padding: 12px 16px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .ai-result-tab:hover {
            color: #4f46e5;
            background-color: #f8fafc;
        }

        .ai-result-tab.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
            background-color: #f8fafc;
        }

        .ai-result-content {
            display: none;
        }

        .ai-result-content.active {
            display: block;
        }

        /* Diagnosis Page Styles */
        .result-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .strength-ranking-header,
        .job-recommendation-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .strength-ranking-title,
        .job-recommendation-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .strength-ranking-subtitle,
        .job-recommendation-subtitle {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
            margin-top: 8px;
        }

        .result-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 40px;
        }

        .result-card-content {
            padding: 16px;
        }

        .rank-badge {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
            margin-right: 12px;
        }

        .rank-badge.gold {
            background-color: #ffd700;
        }

        .rank-badge.silver {
            background-color: #c0c0c0;
        }

        .rank-badge.bronze {
            background-color: #cd7f32;
        }

        /* Select2 custom styles for Tailwind */
        .select2-container--default .select2-selection--single {
            border: 1px solid #d1d5db !important;
            border-radius: 0.5rem !important;
            height: 42px !important;
            display: flex !important;
            align-items: center !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: #374151 !important;
            line-height: normal !important;
            padding-left: 0.75rem !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 40px !important;
        }

        .select2-dropdown {
            border: 1px solid #d1d5db !important;
            border-radius: 0.5rem !important;
            z-index: 10000 !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
        }

        .select2-results__option--highlighted[aria-selected] {
            background-color: #4f46e5 !important;
        }

        .rank-badge.blue {
            background-color: #4a90e2;
        }

        /* Job recommendation styles */
        .job-container {
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .job-container.job-engineer {
            border-color: #4a90e2;
        }

        .job-container.job-designer {
            border-color: #d0021b;
        }

        .job-container.job-marketer {
            border-color: #f5a623;
        }

        .job-rank-badge {
            text-align: center;
            padding: 4px 0;
            border-radius: 20px;
            color: white;
            font-size: 12px;
            margin: 0 auto 16px;
            max-width: 250px;
        }

        .job-rank-badge.badge-engineer {
            background: #4a90e2;
        }

        .job-rank-badge.badge-designer {
            background: #d0021b;
        }

        .job-rank-badge.badge-marketer {
            background: #f5a623;
        }

        .job-name {
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 24px;
        }

        .job-section {
            margin-top: 24px;
        }

        .job-section-title {
            font-weight: bold;
            margin-bottom: 8px;
            border-left: 4px solid #4a90e2;
            padding-left: 8px;
        }

        .job-skill-tag {
            background: #eef5ff;
            color: #4a90e2;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
        }

        /* Sidebar Styles (Mobile Optimized) */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: #1e1b4b;
            /* Indigo-950 */
            color: #e2e8f0;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 50;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            box-shadow: 10px 0 15px -3px rgba(0, 0, 0, 0.1);
        }

        .sidebar .nav-link {
            color: #94a3b8;
            margin-bottom: 4px;
        }

        .sidebar .nav-link:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .sidebar .nav-link.active {
            background: white !important;
            color: #4f46e5 !important;
            font-weight: 700;
        }

        .main-content {
            margin-left: 0;
            /* Default no margin */
            min-height: 100vh;
            transition: margin-left 0.3s;
        }

        /* Sidebar Overlay */
        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 45;
            display: none;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Desktop Override */
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0) !important;
            }

            .main-content {
                margin-left: var(--sidebar-width) !important;
            }

            .sidebar-overlay {
                display: none !important;
            }
        }

        /* Mobile UI Refinements */
        @media (max-width: 767px) {
            header {
                position: sticky;
                top: 0;
                z-index: 40;
                backdrop-filter: blur(8px);
                background-color: rgba(255, 255, 255, 0.9) !important;
            }
        }

        /* Open State (Mobile) */
        .sidebar.open {
            transform: translateX(0);
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .app-content {
            animation: fadeIn 0.3s ease-out;
        }

        /* Smooth transitions */
        button,
        a,
        .nav-link {
            transition: all 0.2s ease;
        }

        /* Card hover effects */
        .hover\:shadow-md {
            transition: box-shadow 0.3s ease;
        }

        /* AIæ¨è–¦å¯¾è±¡ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
        .job-card {
            position: relative;
            transition: all 0.3s ease;
        }

        .job-card-highlighted {
            border: 3px solid #6366f1 !important;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1) !important;
            background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%) !important;
        }

        .job-card-highlighted::before {
            content: "AIç´¹ä»‹å¯¾è±¡";
            position: absolute;
            top: -12px;
            right: 16px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
            z-index: 10;
        }

        /* AIæ¨è–¦çµæœãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã‚¿ãƒ–ã‚¹ã‚¿ã‚¤ãƒ« */
        .ai-result-tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 1.5rem;
        }

        .ai-result-tab {
            flex: 1;
            padding: 12px 16px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .ai-result-tab:hover {
            color: #4f46e5;
            background-color: #f8fafc;
        }

        .ai-result-tab.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
            background-color: #f8fafc;
        }

        .ai-result-content {
            display: none;
        }

        .ai-result-content.active {
            display: block;
        }

        .ai-result-item {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .ai-result-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .ai-result-item.excluded {
            background-color: #f8fafc;
            border-color: #cbd5e1;
        }

        /* å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ */
        .target-user-dropdown {
            position: absolute;
            z-index: 50;
            width: 100%;
            margin-top: 4px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            max-height: 256px;
            overflow-y: auto;
        }

        .target-user-option {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: background-color 0.2s;
        }

        .target-user-option:hover {
            background-color: #eff6ff;
        }

        .target-user-option:last-child {
            border-bottom: none;
        }

        /* --- HIGH VISIBILITY SCROLLBAR --- */
        .custom-scrollbar {
            overflow-y: scroll !important;
            scrollbar-width: thin !important;
            scrollbar-color: #4f46e5 #f1f5f9 !important;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 12px !important;
            display: block !important;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9 !important;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #4f46e5 !important;
            border-radius: 6px !important;
            border: 2px solid #f1f5f9 !important;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #312e81 !important;
        }

        /* Modal Animation */
        .animate-fade-in-up {
            animation: fadeInUp 0.3s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Utility overrides */
        /* Candidate Detail Tabs */
        .candidate-tab-btn.active {
            border-bottom-color: #4f46e5 !important;
            color: #4f46e5 !important;
        }


        /* Print Styles */
        @media print {
            @page {
                margin: 5mm;
                /* ä½™ç™½ã‚’ã•ã‚‰ã«ç¸®å° */
                size: landscape;
            }

            body {
                background-color: white;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                overflow: visible !important;
            }

            /* å…¨ã¦ã®è¦ç´ ã‚’ä¸€æ—¦éè¡¨ç¤ºã« */
            body>* {
                display: none !important;
            }

            /* ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã®ã¿è¡¨ç¤º */
            body>#app-page {
                display: block !important;
                position: static !important;
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
            }

            /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ã¨ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’éè¡¨ç¤º */
            .sidebar,
            header,
            .no-print,
            #loading-overlay {
                display: none !important;
            }

            /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¨­å®š */
            .main-content {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                position: static !important;
                display: block !important;
            }

            /* å…¨ã¦ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒšãƒ¼ã‚¸ã‚’éè¡¨ç¤º */
            .app-content {
                display: none !important;
            }

            /* ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªï¼ˆhiddenã‚¯ãƒ©ã‚¹ãŒãªã„ï¼‰ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã¿è¡¨ç¤ºã—ã€çµ¶å¯¾é…ç½®ã§ä¸Šéƒ¨ã«å›ºå®š */
            .app-content:not(.hidden) {
                display: block !important;
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* ã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
            .shadow-sm,
            .shadow-md,
            .shadow-lg,
            .shadow {
                box-shadow: none !important;
                border: 1px solid #ccc !important;
            }

            /* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®èª¿æ•´ */
            textarea {
                height: auto !important;
                min-height: 50px;
                resize: none !important;
                border: 1px solid #ddd !important;
                page-break-inside: avoid;
            }

            /* æ”¹ãƒšãƒ¼ã‚¸åˆ¶å¾¡ */
            .bg-white {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }

        /* --- PREMIUM SEARCH UI --- */
        .search-card {
            background: #ffffff;
            border-radius: 24px;
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.04), 0 8px 10px -6px rgba(0, 0, 0, 0.04);
            padding: 32px;
            border: 1px solid #f1f5f9;
            position: relative;
        }

        .filter-group-label {
            font-size: 0.875rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .admin-badge {
            background: #6366f1;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.625rem;
            font-weight: 700;
            display: inline-block;
            vertical-align: middle;
        }

        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
            min-height: 24px;
        }

        /* Mobile adjustments */
        @media (max-width: 640px) {
            .filter-group-label {
                font-size: 11px;
                margin-bottom: 6px;
                color: #64748b;
            }

            .premium-tag {
                font-size: 10px;
                padding: 2px 8px;
            }

            .search-card {
                padding: 1.25rem !important;
            }

            .count-badge-premium {
                padding: 8px 16px !important;
                gap: 8px !important;
            }

            .count-number-premium {
                font-size: 1.5rem !important;
            }

            .premium-slider-container {
                padding: 4px 0;
            }
        }

        .premium-tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .tag-blue {
            background: #eff6ff !important;
            color: #2563eb !important;
            border: 1px solid #dbeafe !important;
        }

        .tag-blue:hover {
            background: #dbeafe !important;
        }

        .tag-amber {
            background: #fffbeb !important;
            color: #d97706 !important;
            border: 1px solid #fef3c7 !important;
        }

        .tag-indigo {
            background: #f5f3ff !important;
            color: #4f46e5 !important;
            border: 1px solid #ede9fe !important;
        }

        .tag-indigo:hover {
            background: #ede9fe !important;
        }

        .tag-remove {
            margin-left: 6px;
            cursor: pointer;
            opacity: 0.6;
        }

        .tag-remove:hover {
            opacity: 1;
        }

        /* Custom Slider */
        .premium-slider-container {
            padding: 10px 0;
        }

        .premium-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            outline: none;
        }

        .premium-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #6366f1;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .count-badge-premium {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .count-number-premium {
            font-size: 1.75rem;
            font-weight: 800;
            color: #4f46e5;
            font-family: 'Inter', sans-serif;
        }

        .ai-search-btn {
            background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
            color: white;
            padding: 8px 16px;
        }

        .filter-toggle-btn.active {
            background-color: #4f46e5 !important;
            color: white !important;
            border-color: #4f46e5 !important;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2) !important;
        }

        .filter-toggle-btn i {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .filter-toggle-btn.active i {
            transform: rotate(180deg);
        }

        /* AI Search Box Styles */
        .ai-search-box {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .ai-search-box.collapsed .ai-search-body {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .ai-search-box:not(.collapsed) .ai-search-body {
            max-height: 500px;
            opacity: 1;
            margin-top: 1.5rem;
        }

        .ai-search-box .ai-search-toggle-icon {
            transition: transform 0.3s ease;
        }

        .ai-search-box.collapsed .ai-search-toggle-icon {
            transform: rotate(-180deg);
        }

        .ai-search-box.disabled {
            filter: grayscale(1);
            opacity: 0.5;
            cursor: not-allowed !important;
        }

        .ai-search-box.disabled * {
            cursor: not-allowed !important;
        }

        .ai-search-box.disabled .ai-search-header {
            pointer-events: none;
        }

        .ai-search-box.disabled .ai-search-body {
            display: none !important;
        }

        .ai-search-box .disabled-message {
            display: none;
            font-size: 11px;
            color: #64748b;
            font-weight: 500;
        }

        /* Advanced Filters Styles */
        .advanced-filters-container {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .advanced-filters-container.collapsed {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
            pointer-events: none;
        }

        .advanced-filters-container:not(.collapsed) {
            max-height: 3000px;
            opacity: 1;
            margin-top: 1.5rem;
        }

        .filter-toggle-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s;
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
        }

        .filter-toggle-btn:hover {
            background: #e2e8f0;
            color: #1e293b;
        }

        .filter-toggle-btn.active {
            background: #eff6ff;
            color: #2563eb;
            border-color: #bfdbfe;
        }

        .filter-toggle-btn i {
            transition: transform 0.3s ease;
        }

        .filter-toggle-btn.active i {
            transform: rotate(180deg);
        }

        .ai-search-box.disabled .disabled-message {
            display: flex;
        }

        border-radius: 8px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .ai-search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.3);
        }

        .toggle-link {
            color: #6366f1;
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }

        .toggle-link:hover {
            text-decoration: underline;
        }

        /* Select2 Customization */
        .select2-container--default .select2-selection--single,
        .select2-container--default .select2-selection--multiple {
            border: 1px solid #e2e8f0 !important;
            border-radius: 12px !important;
            min-height: 56px !important;
            padding: 0 16px !important;
            display: flex !important;
            align-items: center !important;
            background-color: white !important;
        }

        .select2-container--default.select2-container--focus .select2-selection--single,
        .select2-container--default.select2-container--focus .select2-selection--multiple {
            border-color: #6366f1 !important;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1) !important;
        }

        .select2-selection__choice {
            background: #eff6ff !important;
            border: 1px solid #dbeafe !important;
            border-radius: 4px !important;
            color: #1d4ed8 !important;
            font-size: 0.75rem !important;
            font-weight: 500 !important;
            margin-top: 5px !important;
        }

        /* Checkbox styling */
        .candidate-select-checkbox:checked,
        .job-checkbox:checked {
            background-color: #2563eb !important;
            border-color: #2563eb !important;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e") !important;
        }

        /* Select2 Multi-selection Premium UI adjustments */
        .search-card .select2-selection__choice {
            display: none !important;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__rendered {
            display: flex !important;
            flex-wrap: wrap !important;
            align-items: center !important;
            width: 100% !important;
            padding: 0 !important;
            line-height: normal !important;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__placeholder {
            margin: 0 !important;
            line-height: normal !important;
            display: inline-block !important;
            color: #94a3b8 !important;
        }

        .search-card .select2-search--inline {
            display: flex !important;
            align-items: center !important;
            margin: 0 !important;
            width: 100% !important;
        }

        .search-card .select2-search__field {
            margin: 0 !important;
            line-height: normal !important;
            padding: 0 !important;
            height: auto !important;
            min-height: 32px !important;
            width: 100% !important;
        }

        /* Ensure dropdown is always on top */
        .select2-dropdown {
            z-index: 100000 !important;
        }

        /* Floating AI Agent Styles */
        #ai-search-agent-trigger {
            position: fixed !important;
            bottom: 30px !important;
            right: 30px !important;
            width: 64px !important;
            height: 64px !important;
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%) !important;
            border-radius: 50% !important;
            display: none !important;
            align-items: center !important;
            justify-content: center !important;
            color: white !important;
            font-size: 28px !important;
            cursor: pointer !important;
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4) !important;
            z-index: 999999 !important;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
            border: 4px solid white !important;
        }

        #ai-search-agent-trigger:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 12px 32px rgba(99, 102, 241, 0.5);
        }

        #ai-search-agent-trigger .notification-dot {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 14px;
            height: 14px;
            background: #ef4444;
            border-radius: 50%;
            border: 2px solid white;
        }

        #ai-search-agent-chat {
            position: fixed;
            bottom: 110px;
            right: 30px;
            width: 400px;
            height: 550px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #f1f5f9;
            animation: chatOpen 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes chatOpen {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .chat-header {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            padding: 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chat-bubble {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.5;
            position: relative;
        }

        .chat-bubble.ai {
            align-self: flex-start;
            background: white;
            color: #1e293b;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #f1f5f9;
        }

        .chat-bubble.user {
            align-self: flex-end;
            background: #6366f1;
            color: white;
            border-bottom-right-radius: 4px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }

        .chat-footer {
            padding: 16px;
            background: white;
            border-top: 1px solid #f1f5f9;
            display: flex;
            gap: 12px;
        }

        .chat-input {
            flex: 1;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 10px 16px;
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }

        .chat-input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .chat-send-btn {
            width: 40px;
            height: 40px;
            background: #6366f1;
            color: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-send-btn:hover {
            background: #4f46e5;
            transform: scale(1.05);
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 12px;
            background: white;
            border-radius: 12px;
            align-self: flex-start;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #cbd5e1;
            border-radius: 50%;
            animation: typing 1s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {

            0%,
            60%,
            100% {
                transform: translateY(0);
            }

            30% {
                transform: translateY(-4px);
            }
        }

        @media (max-width: 640px) {
            #ai-search-agent-chat {
                width: calc(100vw - 40px);
                height: 500px;
                right: 20px;
                bottom: 90px;
            }

            #ai-search-agent-trigger {
                bottom: 20px;
                right: 20px;
                width: 56px;
                height: 56px;
            }
        }
    </style>

</head>

<body>
    <!-- Floating AI Search Agent -->
    <div id="ai-search-agent-trigger" onclick="toggleAISearchChat()">
        <i class="fas fa-robot"></i>
        <div class="notification-dot"></div>
    </div>

    <div id="ai-search-agent-chat">
        <div class="chat-header">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                    <i class="fas fa-robot text-xl"></i>
                </div>
                <div>
                    <h3 class="font-bold">AIæ¤œç´¢ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</h3>
                    <p class="text-[10px] opacity-80 uppercase tracking-tighter">Powered by Gemini 2.5 Flash</p>
                </div>
            </div>
            <button onclick="toggleAISearchChat()" class="text-white/80 hover:text-white transition">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div id="ai-chat-body" class="chat-body custom-scrollbar">
            <div class="chat-bubble ai">
                ã“ã‚“ã«ã¡ã¯ï¼ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼AIã§ã™ã€‚ğŸ˜Š<br>
                ã€Œæ±äº¬ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®æ±‚äººã‚’æ¢ã—ã¦ã€ã‚„ã€Œ30ä»£ã§å–¶æ¥­çµŒé¨“ã®ã‚ã‚‹äººã‚’è¦‹ã¤ã‘ã¦ã€ãªã©ã€è‡ªç„¶ãªè¨€è‘‰ã§æŒ‡ç¤ºã‚’ã„ãŸã ã‘ã‚Œã°ã€æœ€é©ãªæƒ…å ±ã‚’æ¤œç´¢ã—ã¾ã™ã€‚
            </div>

            <!-- Typing Indicator (Hidden by default) -->
            <div id="chat-typing" class="typing-indicator" style="display: none;">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>

        <div class="chat-footer">
            <input type="text" id="ai-chat-input" class="chat-input" placeholder="ä¾‹: å¹´å600ä¸‡ä»¥ä¸Šã®å–¶æ¥­æ±‚äºº"
                onkeypress="if(event.key === 'Enter') sendAIChatMessage()">
            <button onclick="sendAIChatMessage()" class="chat-send-btn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    <!-- Loading Spinner -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
        style="z-index: 20000;">
        <div class="bg-white rounded-lg p-6 flex flex-col items-center">
            <div class="spinner border-4 border-gray-200 rounded-full w-16 h-16 mb-4"></div>
            <p id="loading-message" class="text-gray-700 font-medium">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
    </div>

    <!-- Organization Selection Modal -->
    <div id="org-select-modal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">æ‰€å±çµ„ç¹”ã‚’é¸æŠ</h3>
                <div id="org-select-list" class="space-y-3 max-h-60 overflow-y-auto">
                    <!-- Org Buttons provided by JS -->
                </div>
                <div class="mt-4">
                    <button onclick="logout()" class="text-sm text-gray-500 hover:text-gray-700 underline">
                        ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦æˆ»ã‚‹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Organization Modal -->
    <div id="organization-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
        style="z-index: 100000;">
        <div class="bg-white rounded-lg w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900" id="org-modal-title">çµ„ç¹”ç·¨é›†</h3>
                <button onclick="closeOrganizationModal()"
                    class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="organization-form" class="space-y-4">
                <input type="hidden" id="org-id">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">çµ„ç¹”å <span
                            class="text-red-500">*</span></label>
                    <input type="text" id="org-name-input" required
                        class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-50">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ—ãƒ©ãƒ³</label>
                        <select id="org-plan"
                            class="w-full border border-gray-300 rounded px-3 py-2 bg-white focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="free">Free</option>
                            <option value="standard">Standard</option>
                            <option value="premium">Premium</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                        <select id="org-status"
                            class="w-full border border-gray-300 rounded px-3 py-2 bg-white focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="active">æœ‰åŠ¹</option>
                            <option value="suspended">åœæ­¢ä¸­</option>
                            <option value="cancelled">è§£ç´„æ¸ˆ</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æœ€å¤§ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</label>
                        <input type="number" id="org-max-users" min="1"
                            class="w-full border border-gray-300 rounded px-3 py-2 bg-white focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æœ‰åŠ¹æœŸé™</label>
                        <input type="date" id="org-valid-until"
                            class="w-full border border-gray-300 rounded px-3 py-2 bg-white focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <!-- åˆæœŸç®¡ç†è€…è¨­å®šï¼ˆæ–°è¦ä½œæˆæ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
                <div id="org-initial-admin-fields" class="border-t pt-4 mt-4 hidden">
                    <h4 class="text-sm font-bold text-gray-700 mb-3">åˆæœŸç®¡ç†è€…è¨­å®š</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç®¡ç†è€…å <span
                                    class="text-red-500">*</span></label>
                            <input type="text" id="org-admin-name"
                                class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ« <span
                                    class="text-red-500">*</span></label>
                            <input type="email" id="org-admin-email"
                                class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <p class="text-xs text-gray-500 mt-1">â€»ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«æ‹›å¾…ãƒ¡ãƒ¼ãƒ«ãŒé€ä¿¡ã•ã‚Œã¾ã™</p>
                        </div>
                    </div>
                </div>
                <!-- çµ„ç¹”è¨­å®š -->
                <div class="border-t pt-4 mt-4">
                    <h4 class="text-sm font-bold text-gray-700 mb-2">çµ„ç¹”ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š</h4>
                    <div class="space-y-2 mb-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="org-setting-email-required"
                                class="form-checkbox h-4 w-4 text-indigo-600">
                            <span class="ml-2 text-sm text-gray-700">æ±‚è·è€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›ã‚’å¿…é ˆã«ã™ã‚‹</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="org-setting-password-required"
                                class="form-checkbox h-4 w-4 text-indigo-600">
                            <span class="ml-2 text-sm text-gray-700">æ±‚è·è€…ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã‚’å¿…é ˆã«ã™ã‚‹</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="org-setting-limit-agent-view"
                                class="form-checkbox h-4 w-4 text-indigo-600">
                            <span class="ml-2 text-sm text-gray-700">ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–²è¦§åˆ¶é™(æ‹…å½“æ±‚è·è€…ã®ã¿è¡¨ç¤º)</span>
                        </label>
                    </div>

                    <h4 class="text-sm font-bold text-gray-700 mb-2">å½¹å‰²ã®è¡¨ç¤ºåç§°è¨­å®š</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">çµ„ç¹”ç®¡ç†è€…</label>
                            <input type="text" id="org-role-label-org_admin" placeholder="çµ„ç¹”ç®¡ç†è€…"
                                class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">ç®¡ç†è€…</label>
                            <input type="text" id="org-role-label-admin" placeholder="ç®¡ç†è€…"
                                class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">CAãƒ»RA (ã‚¹ã‚¿ãƒƒãƒ•)</label>
                            <input type="text" id="org-role-label-coach" placeholder="CAãƒ»RA"
                                class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">æ±‚è·è€…</label>
                            <input type="text" id="org-role-label-candidate" placeholder="æ±‚è·è€…"
                                class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">â€»æœªå…¥åŠ›ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåç§°ãŒä½¿ç”¨ã•ã‚Œã¾ã™</p>
                </div>

                <!-- Google Drive PDF è»¢é€è¨­å®š -->
                <div class="border-t pt-4 mt-4">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-sm font-bold text-gray-700">Googleãƒ‰ãƒ©ã‚¤ãƒ–PDFè»¢é€è¨­å®š</h4>
                        <span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-[10px] rounded font-bold">BETA</span>
                    </div>
                    <div class="space-y-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="org-setting-drive-transfer-enabled"
                                class="form-checkbox h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500"
                                onchange="$('#drive-transfer-settings-container').toggleClass('hidden', !this.checked)">
                            <span class="ml-2 text-sm text-gray-700 font-medium">æ±‚äººPDFã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã«Googleãƒ‰ãƒ©ã‚¤ãƒ–ã¸ä¿å­˜ã™ã‚‹</span>
                        </label>

                        <div id="drive-transfer-settings-container"
                            class="pl-6 space-y-4 hidden border-l-2 border-indigo-100 py-1">
                            <div>
                                <label
                                    class="block text-[11px] font-bold text-gray-500 uppercase tracking-wider mb-1">è»¢é€ç”¨GAS
                                    Webã‚¢ãƒ—ãƒªURL</label>
                                <input type="url" id="org-setting-drive-gas-url"
                                    placeholder="https://script.google.com/macros/s/.../exec"
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                                <p class="text-[10px] text-gray-400 mt-1">â€»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã®Google Apps Script
                                    Webã‚¢ãƒ—ãƒªURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                            </div>
                            <div>
                                <label
                                    class="block text-[11px] font-bold text-gray-500 uppercase tracking-wider mb-1">ä¿å­˜å…ˆã‚«ãƒ©ãƒ 
                                    (jobsãƒ†ãƒ¼ãƒ–ãƒ«)</label>
                                <input type="text" id="org-setting-drive-column" placeholder="pdf_url"
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                                <p class="text-[10px] text-gray-400 mt-1">â€»DBã«äº‹å‰ã«ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆä¾‹: pdf_urlï¼‰</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Google Drive PDF ã‚¤ãƒ³ãƒãƒ¼ãƒˆè¨­å®š -->
                <div class="border-t pt-4 mt-4">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-sm font-bold text-gray-700">Googleãƒ‰ãƒ©ã‚¤ãƒ–æ±‚äººPDFã‚¤ãƒ³ãƒãƒ¼ãƒˆè¨­å®š</h4>
                        <span class="px-2 py-0.5 bg-green-100 text-green-700 text-[10px] rounded font-bold">NEW</span>
                    </div>
                    <div class="space-y-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="org-setting-drive-import-enabled"
                                class="form-checkbox h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500"
                                onchange="$('#drive-import-settings-container').toggleClass('hidden', !this.checked)">
                            <span class="ml-2 text-sm text-gray-700 font-medium">Googleãƒ‰ãƒ©ã‚¤ãƒ–ã‹ã‚‰æ±‚äººPDFã‚’ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¯èƒ½ã«ã™ã‚‹</span>
                        </label>

                        <div id="drive-import-settings-container"
                            class="pl-6 space-y-4 hidden border-l-2 border-green-100 py-1">
                            <div>
                                <label
                                    class="block text-[11px] font-bold text-gray-500 uppercase tracking-wider mb-1">ã‚¤ãƒ³ãƒãƒ¼ãƒˆç”¨GAS
                                    Webã‚¢ãƒ—ãƒªURL</label>
                                <input type="url" id="org-setting-drive-import-gas-url"
                                    placeholder="https://script.google.com/macros/s/.../exec"
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                                <p class="text-[10px] text-gray-400 mt-1">â€»æ±‚äººç¥¨PDFã‚’å–å¾—ãƒ»è§£æã™ã‚‹ãŸã‚ã®Google Apps Script
                                    Webã‚¢ãƒ—ãƒªURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ±‚äººã‚¤ãƒ³ãƒãƒ¼ãƒˆè¨­å®š -->
                <div class="border-t pt-4 mt-4">
                    <h4 class="text-sm font-bold text-gray-700 mb-2">æ±‚äººã‚¤ãƒ³ãƒãƒ¼ãƒˆè¨­å®š</h4>
                    <div class="space-y-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="org-setting-bulk-duplicate-confirm"
                                class="form-checkbox h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                            <span class="ml-2 text-sm text-gray-700 font-medium">è¤‡æ•°PDFå–ã‚Šè¾¼ã¿æ™‚ã«é‡è¤‡ç–‘ã„ã‚’å¾Œã§ä¸€æ‹¬ç¢ºèªã™ã‚‹</span>
                        </label>
                        <p class="text-[10px] text-gray-400 ml-6 mt-[-10px]">
                            â€»ONã®å ´åˆã€å‡¦ç†ä¸­ã«ä¸€ã¤ãšã¤ç¢ºèªã›ãšã€æœ€å¾Œã«ä¸€è¦§ã§ãƒã‚§ãƒƒã‚¯ã—ã¦ç™»éŒ²ã§ãã¾ã™ã€‚
                        </p>
                    </div>
                </div>

                <div class="flex justify-end pt-4 gap-3">
                    <button type="button" onclick="closeOrganizationModal()"
                        class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit"
                        class="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 shadow-sm">ä¿å­˜ã™ã‚‹</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Invitation URL Modal -->
    <div id="invitation-url-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
        style="z-index: 100010;">
        <div class="bg-white rounded-lg w-full max-w-md p-6">
            <div class="text-center mb-6">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                    <i class="fas fa-check text-green-600 text-xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900">æ‹›å¾…URLã‚’ç™ºè¡Œã—ã¾ã—ãŸ</h3>
                <p class="text-sm text-gray-500 mt-2">
                    <span id="invite-org-name" class="font-bold"></span> ã®ç®¡ç†è€…ã¨ã—ã¦<br>
                    <span id="invite-admin-email" class="font-bold"></span> ã‚’æ‹›å¾…ã—ã¾ã—ãŸã€‚
                </p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ‹›å¾…URL</label>
                    <div class="flex gap-2">
                        <input type="text" id="invitation-url-display" readonly
                            class="w-full bg-gray-50 border border-gray-300 rounded px-3 py-2 text-sm text-gray-600">
                        <button onclick="copyInvitationUrl()"
                            class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-700" title="ã‚³ãƒ”ãƒ¼">
                            <i class="far fa-copy"></i>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">â€»ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—ã—ãŸå ´åˆãªã©ã¯ã€ã“ã®URLã‚’ç›´æ¥ç®¡ç†è€…ã«ä¼ãˆã¦ãã ã•ã„ã€‚</p>
                </div>

                <div class="flex flex-col gap-2 mt-6">
                    <button onclick="sendInvitationEmail()"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none sm:text-sm">
                        <i class="fas fa-paper-plane mr-2 pt-1"></i> ãƒ¡ãƒ¼ãƒ«ã‚’å†é€ä¿¡
                    </button>
                    <button onclick="closeInvitationUrlModal()"
                        class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:text-sm">
                        é–‰ã˜ã‚‹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="page active">
        <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-100 to-purple-100 px-4">
            <div class="max-w-md w-full bg-white rounded-2xl shadow-xl p-8">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">RightJob ãƒãƒƒãƒãƒ³ã‚°</h1>
                    <p class="text-gray-600">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
                </div>

                <form id="login-form" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input type="email" id="login-email" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                        <input type="password" id="login-password" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>

                    <div id="login-error" class="text-red-600 text-sm hidden"></div>

                    <button type="submit"
                        class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">
                        ãƒ­ã‚°ã‚¤ãƒ³
                    </button>
                </form>

                <div class="mt-6 text-center">
                    <a href="#" id="show-signup" class="text-indigo-600 hover:text-indigo-700 text-sm">
                        ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„æ–¹ã¯ã“ã¡ã‚‰
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Signup Page -->
    <div id="signup-page" class="page">
        <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-100 to-purple-100 px-4">
            <div class="max-w-md w-full bg-white rounded-2xl shadow-xl p-8">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">æ–°è¦ç™»éŒ²</h1>
                    <p class="text-gray-600">çµ„ç¹”ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ç™»éŒ²ã—ã¦ãã ã•ã„</p>
                </div>

                <form id="signup-form" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">çµ„ç¹”ã‚³ãƒ¼ãƒ‰ <span
                                class="text-xs text-gray-500 font-normal">ï¼ˆæ‹…å½“è€…ã‹ã‚‰é…å¸ƒã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ï¼‰</span></label>
                        <div class="flex gap-2">
                            <input type="text" id="signup-org-code" required placeholder="ä¾‹: A1B2C3D4"
                                class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent uppercase">
                            <button type="button" id="check-org-code"
                                class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition text-sm font-medium whitespace-nowrap">
                                ç¢ºèª
                            </button>
                        </div>
                        <p id="org-name-display" class="mt-2 text-sm text-green-600 font-bold hidden"></p>
                        <p id="org-code-error" class="mt-1 text-sm text-red-500 hidden"></p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ãŠåå‰</label>
                        <input type="text" id="signup-name" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ãµã‚ŠãŒãª</label>
                        <input type="text" id="signup-furigana"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input type="email" id="signup-email" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                        <input type="password" id="signup-password" required minlength="6"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>

                    <input type="hidden" id="invitation-token">

                    <div id="signup-error" class="text-red-600 text-sm hidden"></div>

                    <button type="submit"
                        class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">
                        ç™»éŒ²ã™ã‚‹
                    </button>
                </form>

                <div class="mt-6 text-center">
                    <a href="#" id="show-login" class="text-indigo-600 hover:text-indigo-700 text-sm">
                        ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-page" class="page">
        <!-- Sidebar -->
        <aside class="sidebar flex flex-col">
            <div class="p-6 flex-shrink-0">
                <h2 class="text-2xl font-bold text-white">RightJob</h2>
                <div class="flex items-center gap-2 mt-1">
                    <div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>
                    <p id="org-name" class="text-sm text-indigo-300"></p>
                </div>
                <p id="org-code-display"
                    class="text-[10px] text-indigo-200 mt-2 font-mono bg-white/5 px-2 py-1 rounded inline-block border border-white/10 uppercase tracking-widest">
                </p>
            </div>

            <nav class="px-3 space-y-1 flex-1 overflow-y-auto custom-scrollbar">
                <a href="#" id="nav-dashboard" data-page="dashboard"
                    class="nav-link flex items-center px-4 py-3 rounded-lg transition active">
                    <i class="fas fa-home w-5"></i>
                    <span class="ml-3">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
                </a>
                <a href="#" data-page="jobs" class="nav-link flex items-center px-4 py-3 rounded-lg transition">
                    <i class="fas fa-briefcase w-5"></i>
                    <span class="ml-3">æ±‚äººæ¤œç´¢</span>
                </a>
                <a href="#" id="nav-candidate-search" data-page="candidate-search"
                    class="nav-link hidden flex items-center px-4 py-3 rounded-lg transition">
                    <i class="fas fa-users w-5"></i>
                    <span class="ml-3">æ±‚è·è€…æ¤œç´¢</span>
                </a>

                <a href="#" data-page="ai-scout" id="ai-scout-link"
                    class="nav-link hidden flex items-center px-4 py-3 rounded-lg transition">
                    <i class="fas fa-robot w-5"></i>
                    <span class="ml-3">AIã‚¹ã‚«ã‚¦ãƒˆ</span>
                </a>

                <a href="#" data-page="applications" class="nav-link flex items-center px-4 py-3 rounded-lg transition">
                    <i class="fas fa-file-alt w-5"></i>
                    <span class="ml-3">å¿œå‹Ÿãƒ»é¸è€ƒçŠ¶æ³</span>
                </a>
                <a href="#" data-page="recommendations"
                    class="nav-link flex items-center px-4 py-3 rounded-lg transition">
                    <i class="fas fa-robot w-5"></i>
                    <span class="ml-3">ãŠã™ã™ã‚æ±‚äºº</span>
                </a>
                <a href="#" data-page="profile" class="nav-link flex items-center px-4 py-3 rounded-lg transition">
                    <i class="fas fa-user w-5"></i>
                    <span class="ml-3">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</span>
                </a>

                <!-- Coach Menu (visible only for coach) -->
                <div id="coach-menu" class="hidden mt-6 pt-6 border-t border-white/10">
                    <p class="px-4 text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-3">CAãƒ»RAãƒ¡ãƒ‹ãƒ¥ãƒ¼</p>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="coach-students">
                        <i class="fas fa-user-graduate w-5"></i>
                        <span class="ml-3">æ‹…å½“æ±‚è·è€…</span>
                    </a>
                </div>

                <!-- Admin Menu (visible only for org_admin and admin) -->
                <div id="admin-menu" class="hidden mt-6 pt-6 border-t border-white/10">
                    <p class="px-4 text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-3">ç®¡ç†è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼</p>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-jobs">
                        <i class="fas fa-briefcase w-5"></i>
                        <span class="ml-3">æ±‚äººç®¡ç†</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-companies">
                        <i class="fas fa-building w-5"></i>
                        <span class="ml-3">ä¼æ¥­ç®¡ç†</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-applicants">
                        <i class="fas fa-users w-5"></i>
                        <span class="ml-3">å¿œå‹Ÿè€…ç®¡ç†</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-candidates">
                        <i class="fas fa-user-graduate w-5"></i>
                        <span class="ml-3">æ±‚è·è€…ç®¡ç†</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-users">
                        <i class="fas fa-user-cog w-5"></i>
                        <span class="ml-3">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-csv">
                        <i class="fas fa-file-upload w-5"></i>
                        <span class="ml-3">CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-logs">
                        <i class="fas fa-history w-5"></i>
                        <span class="ml-3">æ“ä½œãƒ­ã‚°</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-data-management">
                        <i class="fas fa-broom w-5"></i>
                        <span class="ml-3">é‡è¤‡ãƒ‡ãƒ¼ã‚¿ç®¡ç†</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="kpi-dashboard">
                        <i class="fas fa-chart-line w-5"></i>
                        <span class="ml-3">KPIãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-yomi-management">
                        <i class="fas fa-funnel-dollar w-5"></i>
                        <span class="ml-3">ãƒ¨ãƒŸç®¡ç† (é€²æ—ãƒ»å…¥é‡‘)</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-templates">
                        <i class="fas fa-file-invoice w-5"></i>
                        <span class="ml-3">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†</span>
                    </a>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg transition"
                        data-page="admin-settings">
                        <i class="fas fa-cog w-5"></i>
                        <span class="ml-3">AIã‚¹ã‚«ã‚¦ãƒˆè¨­å®š</span>
                    </a>

                </div>

                <!-- Super Admin Menu (visible only for super_admin) -->
                <div id="super-admin-menu" class="hidden mt-6 pt-6 border-t border-gray-200">
                    <p class="px-4 text-xs font-semibold text-red-400 uppercase tracking-wider mb-3">ã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…</p>
                    <a href="#"
                        class="nav-link flex items-center px-4 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600 rounded-lg transition"
                        data-page="super-admin-organizations">
                        <i class="fas fa-building w-5"></i>
                        <span class="ml-3">çµ„ç¹”ç®¡ç†</span>
                    </a>
                    <a href="#"
                        class="nav-link flex items-center px-4 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600 rounded-lg transition"
                        data-page="admin-prompts">
                        <i class="fas fa-cog w-5"></i>
                        <span class="ml-3">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š</span>
                    </a>
                    <a href="#"
                        class="nav-link flex items-center px-4 py-3 text-gray-700 hover:bg-red-50 hover:text-red-600 rounded-lg transition"
                        data-page="admin-master">
                        <i class="fas fa-database w-5"></i>
                        <span class="ml-3">ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ç®¡ç†</span>
                    </a>
                </div>
            </nav>

            <div class="p-4 border-t border-white/10 flex-shrink-0 bg-transparent">
                <div class="flex items-center mb-3">
                    <div class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-indigo-300"></i>
                    </div>
                    <div class="ml-3">
                        <p id="user-name" class="text-sm font-medium text-white"></p>
                        <p id="user-role" class="text-xs text-indigo-200 mb-1"></p>
                        <button onclick="showOrgSelectModalForSwitch()"
                            class="hidden text-[10px] text-indigo-300 hover:text-indigo-100 font-bold flex items-center gap-1">
                            <i class="fas fa-exchange-alt"></i> çµ„ç¹”ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
                        </button>
                    </div>
                </div>
                <button id="logout-btn"
                    class="w-full px-4 py-2 text-sm text-red-400 hover:bg-red-400/10 rounded-lg transition">
                    <i class="fas fa-sign-out-alt mr-2"></i>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                </button>
            </div>
        </aside>
        <!-- Sidebar Overlay -->
        <div id="sidebar-overlay" class="sidebar-overlay"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="bg-white border-b border-gray-200 px-4 sm:px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <button id="mobile-menu-btn"
                            class="md:hidden w-10 h-10 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded-lg shadow-sm active:scale-95 transition">
                            <i class="fas fa-bars text-xl"></i>
                        </button>
                        <h1 id="page-title"
                            class="text-xl sm:text-2xl font-bold text-gray-900 truncate max-w-[150px] sm:max-w-none">
                            ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
                    </div>
                    <div class="flex items-center gap-2 sm:gap-4">
                        <!-- Organization Switcher (Super Admin only) -->
                        <div id="org-switcher-container" class="hidden">
                            <select id="org-switcher"
                                class="border border-red-300 rounded-md px-3 py-1 text-xs sm:text-sm focus:outline-none focus:ring-2 focus:ring-red-500 bg-red-50 text-red-900 font-medium max-w-[100px] sm:max-w-none">
                                <option value="">çµ„ç¹”ã‚’é¸æŠ...</option>
                            </select>
                        </div>

                        <!-- Notification Bell -->
                        <div class="relative">
                            <button id="notification-btn"
                                class="relative p-2 text-gray-600 hover:text-gray-900 bg-gray-50 rounded-lg">
                                <i class="fas fa-bell text-lg sm:text-xl"></i>
                                <span id="notification-badge"
                                    class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[10px] rounded-full min-w-[18px] h-[18px] flex items-center justify-center px-1">0</span>
                            </button>
                            <!-- Notification Dropdown -->
                            <div id="notification-dropdown"
                                class="hidden absolute right-0 mt-2 w-72 sm:w-80 bg-white rounded-lg shadow-xl border z-50">
                                <div class="p-4 border-b">
                                    <h3 class="font-semibold text-sm sm:text-base">é€šçŸ¥</h3>
                                </div>
                                <div id="notification-list" class="max-h-96 overflow-y-auto">
                                    <!-- Notifications will be rendered here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Dashboard Page -->
            <div id="dashboard-content" class="app-content p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Stats Cards -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">å¿œå‹Ÿä¸­</p>
                                <p id="stat-applications" class="text-3xl font-bold text-indigo-600 mt-2">0</p>
                            </div>
                            <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-file-alt text-indigo-600 text-xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">AIç´¹ä»‹</p>
                                <p id="stat-recommendations" class="text-3xl font-bold text-purple-600 mt-2">0</p>
                            </div>
                            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-star text-purple-600 text-xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">é–²è¦§ã—ãŸæ±‚äºº</p>
                                <p id="stat-views" class="text-3xl font-bold text-green-600 mt-2">0</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-eye text-green-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6 border-b">
                        <h2 class="text-lg font-semibold text-gray-900">æœ€è¿‘ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£</h2>
                    </div>
                    <div id="recent-activity" class="p-6">
                        <p class="text-gray-500 text-center py-8">ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                </div>
            </div>

            <!-- Jobs Page -->
            <div id="jobs-content" class="app-content p-6 hidden">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <div class="flex items-center gap-4">
                        <h2 class="text-2xl font-bold text-gray-900">æ±‚äººæ¤œç´¢</h2>
                    </div>
                </div>

                <div class="search-card mb-8">
                    <!-- Admin/Coach: User Selection (Integrated) -->
                    <div id="admin-job-search-tools" class="mb-6 pb-6 border-b border-slate-100 hidden">
                        <div class="filter-group-label">
                            <i class="fas fa-user-circle text-indigo-500"></i> å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ <span
                                class="admin-badge ml-2">ç®¡ç†è€…å°‚ç”¨</span>
                        </div>
                        <div class="relative">
                            <div id="target-user-input-wrapper">
                                <input type="text" id="target-user-search" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§æ¤œç´¢..."
                                    class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all" />
                                <i class="fas fa-search absolute right-3 top-3 text-slate-400"></i>
                            </div>
                            <div id="target-user-dropdown"
                                class="hidden absolute w-full bg-white border border-slate-200 rounded-lg shadow-xl mt-1 z-50 max-h-60 overflow-y-auto">
                            </div>
                            <div id="selected-user-display"
                                class="hidden mt-2 p-3 bg-indigo-50 border border-indigo-100 rounded-lg flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold"
                                        id="selected-user-avatar">?</div>
                                    <div>
                                        <div class="font-bold text-slate-900" id="selected-user-name"></div>
                                        <div class="text-xs text-slate-500" id="selected-user-email"></div>
                                    </div>
                                </div>
                                <button id="clear-user-selection"
                                    class="text-slate-400 hover:text-red-500 transition-colors">
                                    <i class="fas fa-times-circle text-xl"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Primary Search Row upgraded with more fields -->
                    <div class="flex flex-col gap-6 mb-4 mt-6">
                        <!-- Row 1: Search Box & Count -->
                        <div class="flex flex-col md:flex-row items-stretch gap-4">
                            <div class="flex-1">
                                <div class="relative group">
                                    <input type="text" id="search-keyword" placeholder="æ±‚äººã‚¿ã‚¤ãƒˆãƒ«ã€ä¼æ¥­åã€ã‚¹ã‚­ãƒ«ãªã©..."
                                        class="w-full h-14 px-12 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 outline-none shadow-sm transition-all focus:border-indigo-500 text-base">
                                    <i
                                        class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                                </div>
                                <div id="tags-keyword" class="tag-container mt-2 px-1"></div>
                            </div>

                            <!-- Count Display -->
                            <div id="job-count-display-premium"
                                class="hidden flex items-center px-6 h-14 bg-white border-2 border-indigo-100/50 rounded-2xl shadow-sm">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-indigo-50 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-briefcase text-indigo-500"></i>
                                    </div>
                                    <div class="flex flex-col leading-none">
                                        <span
                                            class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-0.5">Matches</span>
                                        <div class="flex items-baseline gap-1">
                                            <span id="job-count-number"
                                                class="text-xl font-bold text-indigo-600 font-mono">0</span>
                                            <span class="text-xs text-slate-400 font-bold">ä»¶</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Row 2: Location & Job Category (Moved to Primary) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <div class="relative">
                                    <select id="search-job-category" class="w-full select2" multiple="multiple"
                                        data-placeholder="å…¨ã¦ã®è·ç¨®"></select>
                                    <div id="tags-job" class="tag-container mt-1"></div>
                                </div>
                            </div>
                            <div>
                                <div class="relative">
                                    <select id="search-prefecture" class="w-full select2" multiple="multiple"
                                        data-placeholder="å‹¤å‹™åœ°ï¼ˆéƒ½é“åºœçœŒï¼‰"></select>
                                    <div id="tags-prefecture" class="tag-container mt-1"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Row 3: Saved Search, Mode & Actions -->
                        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                            <!-- Saved Search Controls -->
                            <div class="flex items-center gap-4">
                                <div
                                    class="flex items-center gap-2 bg-slate-50 px-4 py-2 rounded-xl border border-slate-100 shadow-sm transition-all hover:border-indigo-200">
                                    <i class="fas fa-bookmark text-indigo-500 text-sm"></i>
                                    <select id="saved-searches-select" onchange="loadSavedSearch(this.value)"
                                        class="text-sm bg-transparent outline-none focus:ring-0 min-w-[150px] font-medium text-slate-700">
                                        <option value="">ä¿å­˜ã—ãŸæ¤œç´¢æ¡ä»¶</option>
                                    </select>
                                </div>
                                <button onclick="saveSearchConditions()"
                                    class="text-indigo-600 hover:text-indigo-800 text-sm font-bold flex items-center gap-1.5 px-2">
                                    <i class="fas fa-plus-circle text-base"></i> æ¡ä»¶ã‚’ä¿å­˜
                                </button>
                            </div>

                            <div class="flex flex-wrap lg:flex-nowrap items-center gap-3">
                                <!-- Mode Switch -->
                                <div class="flex p-1 bg-slate-100/80 rounded-2xl border border-slate-200">
                                    <label class="relative flex items-center cursor-pointer">
                                        <input type="radio" name="search-keyword-mode" value="OR" checked
                                            class="sr-only peer">
                                        <div
                                            class="px-5 py-2 rounded-xl text-xs font-bold text-slate-500 peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm transition-all">
                                            ORæ¤œç´¢</div>
                                    </label>
                                    <label class="relative flex items-center cursor-pointer">
                                        <input type="radio" name="search-keyword-mode" value="AND" class="sr-only peer">
                                        <div
                                            class="px-5 py-2 rounded-xl text-xs font-bold text-slate-500 peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm transition-all">
                                            ANDæ¤œç´¢</div>
                                    </label>
                                </div>

                                <!-- Exclude Matched Checkbox -->
                                <label id="exclude-matched-container"
                                    class="flex items-center gap-2 cursor-pointer group bg-purple-50 px-4 py-2 rounded-xl border border-purple-100 shadow-sm hover:border-purple-200 transition-all hidden">
                                    <input type="checkbox" id="search-exclude-matched"
                                        class="w-4 h-4 accent-purple-600 border-slate-300 rounded">
                                    <span class="text-xs text-purple-700 font-bold whitespace-nowrap">AIãƒãƒƒãƒæ¸ˆã¿ã‚’é™¤ã</span>
                                </label>

                                <div class="flex gap-2 h-14">
                                    <button onclick="searchJobsImmediate()"
                                        class="px-10 bg-indigo-600 text-white rounded-2xl hover:bg-indigo-700 font-bold transition-all shadow-md hover:shadow-lg hover:-translate-y-0.5 flex items-center justify-center gap-3">
                                        <i class="fas fa-search"></i> æ¤œç´¢
                                    </button>
                                    <button id="toggle-advanced-filters" onclick="toggleAdvancedFilters()"
                                        class="filter-toggle-btn px-6 bg-white border-2 border-indigo-100 text-indigo-600 rounded-2xl hover:bg-indigo-50 font-bold transition-all flex items-center gap-2 whitespace-nowrap shadow-sm">
                                        <i class="fas fa-sliders-h"></i> <span class="hidden sm:inline">è©³ç´°æ¡ä»¶</span>
                                    </button>
                                    <button onclick="clearSearch()"
                                        class="px-5 border-2 border-slate-100 text-slate-400 rounded-2xl hover:text-red-500 hover:bg-red-50 hover:border-red-100 transition shadow-sm"
                                        title="æ¤œç´¢æ¡ä»¶ã‚’ã‚¯ãƒªã‚¢">
                                        <i class="fas fa-rotate-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>



                    <!-- Advanced Filters Container (Collapsible) -->
                    <div id="advanced-filters-body"
                        class="advanced-filters-container collapsed pt-6 border-t border-slate-100">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 mb-8">
                            <!-- Col 1: Salary & remote -->
                            <div class="space-y-6">
                                <div>
                                    <label class="filter-group-label">å¸Œæœ›å¹´å</label>
                                    <div class="premium-slider-container">
                                        <input type="range" id="search-salary-slider" min="0" max="2000" step="50"
                                            value="0" class="premium-slider"
                                            oninput="$('#salary-display').text(this.value === '0' ? 'æŒ‡å®šãªã—' : this.value + ' ä¸‡å††ä»¥ä¸Š')">
                                        <div class="flex justify-between mt-2">
                                            <span class="text-[10px] text-slate-400">0</span>
                                            <span id="salary-display"
                                                class="text-sm font-bold text-indigo-600 font-mono">æŒ‡å®šãªã—</span>
                                            <span class="text-[10px] text-slate-400">2000ä¸‡</span>
                                        </div>
                                        <input type="hidden" id="search-salary-min" value="0">
                                    </div>
                                </div>
                                <div>
                                    <label class="filter-group-label">è¡¨ç¤ºè¨­å®š</label>
                                    <div class="flex flex-col gap-3 mt-2">

                                        <label class="flex items-center gap-2 cursor-pointer group">
                                            <input type="checkbox" id="search-favorites-only"
                                                class="w-5 h-5 accent-pink-500 border-slate-300 rounded">
                                            <span
                                                class="text-sm text-pink-600 font-medium group-hover:text-pink-900">ãŠæ°—ã«å…¥ã‚Šã®ã¿</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Col 2: Industry -->
                            <div class="space-y-6">
                                <div>
                                    <label class="filter-group-label">æ¥­ç¨®</label>
                                    <select id="search-industry-category" class="w-full select2"
                                        multiple="multiple"></select>
                                    <div id="tags-industry" class="tag-container mt-1"></div>
                                </div>
                                <div>
                                    <label class="filter-group-label">è¿½åŠ æ¡ä»¶</label>
                                    <div class="flex flex-col gap-3 mt-2">
                                        <label class="flex items-center gap-2 cursor-pointer group">
                                            <input type="checkbox" id="search-job-experience-ok"
                                                class="w-5 h-5 accent-indigo-600 border-slate-300 rounded">
                                            <span
                                                class="text-sm text-slate-600 group-hover:text-slate-900">è·ç¨®æœªçµŒé¨“OK</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer group">
                                            <input type="checkbox" id="search-industry-experience-ok"
                                                class="w-5 h-5 accent-indigo-600 border-slate-300 rounded">
                                            <span
                                                class="text-sm text-slate-600 group-hover:text-slate-900">æ¥­ç•ŒæœªçµŒé¨“OK</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Col 3: Employment & Free word -->
                            <div class="space-y-6">
                                <div>
                                    <label class="filter-group-label">é›‡ç”¨å½¢æ…‹</label>
                                    <select id="search-employment-type" class="w-full select2"
                                        multiple="multiple"></select>
                                    <div id="tags-employment" class="tag-container mt-1"></div>
                                </div>
                                <div>
                                    <label class="filter-group-label">ã‚¨ãƒªã‚¢è©³ç´°(é§…åãƒ»åœ°å)</label>
                                    <div class="relative">
                                        <input type="text" id="search-location" placeholder="ç‰¹å®šã®åœ°åã€é§…åãªã©..."
                                            class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                                        <i class="fas fa-map-marked-alt absolute right-3 top-3 text-slate-400"></i>
                                    </div>
                                    <div id="tags-freeword" class="tag-container mt-1"></div>
                                </div>
                            </div>
                        </div>

                        <!-- AI Search Prompt -->
                        <div id="job-ai-search-box"
                            class="ai-search-box bg-white disabled collapsed mt-8 p-6 bg-gradient-to-r from-indigo-50/50 to-purple-50/50 rounded-2xl border border-indigo-100 shadow-sm relative overflow-hidden group">
                            <div
                                class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                <i class="fas fa-robot text-6xl text-indigo-600"></i>
                            </div>
                            <div class="relative">
                                <div class="ai-search-header flex justify-between items-center cursor-pointer select-none"
                                    onclick="toggleAISearch('job')">
                                    <div class="flex items-center gap-3">
                                        <label class="flex items-center gap-2 m-0">
                                            <span class="bg-white p-2 rounded-lg shadow-sm text-indigo-600">
                                                <i class="fas fa-magic"></i>
                                            </span>
                                            <span class="text-sm font-bold text-indigo-900">AIæŒ‡ç¤ºãƒ»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè§£æ</span>
                                            <span
                                                class="ml-2 px-2 py-0.5 bg-indigo-600 text-white text-[10px] rounded-full font-bold uppercase tracking-wider">PREMIUM</span>
                                        </label>
                                        <div class="disabled-message items-center gap-1">
                                            <i class="fas fa-lock text-xs"></i>
                                            <span>çµæœã‚’500ä»¶æœªæº€ã«çµã‚Šè¾¼ã‚€ã¨åˆ©ç”¨å¯èƒ½ã§ã™</span>
                                        </div>
                                    </div>
                                    <div class="ai-search-toggle-icon text-indigo-400">
                                        <i class="fas fa-chevron-up"></i>
                                    </div>
                                </div>

                                <div class="ai-search-body transition-all duration-300">
                                    <div class="relative mt-4">
                                        <textarea id="search-ai-prompt"
                                            placeholder="ä¾‹: æ€¥æˆé•·ä¸­ã®ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ã§ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆçµŒé¨“ãŒã‚ã‚Šã€Javaã«å¼·ã„æ–¹ã‚’å„ªå…ˆã—ã¦..."
                                            class="w-full bg-white border border-indigo-100 rounded-xl p-4 text-sm focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all shadow-inner hover:border-indigo-300 min-h-[80px]"
                                            rows="2"></textarea>
                                        <div class="mt-2 flex items-center gap-4 text-[10px] text-slate-500">
                                            <span class="flex items-center gap-1">
                                                <i class="fas fa-info-circle"></i>
                                                é€šå¸¸ã®ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ã«åŠ ãˆã¦ã€AIãŒæŒ‡ç¤ºå†…å®¹ã«åŸºã¥ãé †ä½ä»˜ã‘ã¨åˆ†æã‚’è¡Œã„ã¾ã™ã€‚
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bottom Action Row: Move Search here when expanded -->
                        <div
                            class="mt-8 pt-6 border-t border-slate-100 flex flex-col md:flex-row justify-between items-center gap-6">
                            <div class="flex items-center gap-4">
                                <button onclick="selectTop30Jobs()" id="select-top-30-btn"
                                    class="px-5 py-2.5 bg-purple-50 text-purple-700 rounded-xl hover:bg-purple-100 border border-purple-100 font-bold text-sm hidden transition-all flex items-center gap-2">
                                    <i class="fas fa-check-double text-base"></i> ä¸Šä½30ä»¶ã‚’ä¸€æ‹¬é¸æŠ
                                </button>
                            </div>

                            <button onclick="searchJobsImmediate()"
                                class="w-full md:w-auto px-16 py-4 bg-indigo-600 text-white rounded-2xl hover:bg-indigo-700 font-bold transition-all shadow-xl hover:shadow-2xl hover:-translate-y-1 flex items-center justify-center gap-3 text-lg">
                                <i class="fas fa-search"></i> ã“ã®æ¡ä»¶ã§æ¤œç´¢ã™ã‚‹
                            </button>
                        </div>
                    </div>

                    <!-- ä¸€æ‹¬æ¨è–¦/AIãƒãƒƒãƒãƒ³ã‚°è¨ºæ–­ãƒãƒ¼ -->
                    <!-- ä¸€æ‹¬æ¨è–¦/AIãƒãƒƒãƒãƒ³ã‚°è¨ºæ–­ãƒãƒ¼ -->
                    <div id="bulk-recommend-bar"
                        class="fixed bottom-10 left-1/2 md:left-[calc(50%+125px)] transform -translate-x-1/2 z-50 bg-white border border-indigo-100 rounded-full shadow-2xl px-4 sm:px-8 py-3 sm:py-4 hidden flex items-center justify-between gap-3 sm:gap-8 transition-all duration-300 w-[92vw] sm:w-auto max-w-[600px]">
                        <div class="flex items-center">
                            <div
                                class="bg-indigo-100 text-indigo-600 rounded-full w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center mr-2 sm:mr-3 shrink-0">
                                <i class="fas fa-check text-xs sm:text-base"></i>
                            </div>
                            <div class="leading-tight">
                                <span class="bar-title font-bold text-gray-800 block text-[10px] sm:text-sm">é¸æŠçŠ¶æ³</span>
                                <span class="text-indigo-600 font-bold"><span id="selected-jobs-count"
                                        class="text-base sm:text-xl">0</span> <span
                                        class="text-[10px] sm:text-sm text-gray-500">ä»¶</span></span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 sm:gap-3">
                            <button onclick="clearAllSelectedJobs()"
                                class="bg-gray-100 text-gray-600 px-3 sm:px-4 py-2 sm:py-3 rounded-full hover:bg-gray-200 font-bold shadow hover:shadow-md transition flex items-center text-xs sm:text-sm">
                                <i class="fas fa-times sm:mr-2"></i><span class="hidden sm:inline">å…¨è§£é™¤</span>
                            </button>
                            <button onclick="openBulkRecommendModal()"
                                class="bar-button bg-indigo-600 text-white px-4 sm:px-8 py-2 sm:py-3 rounded-full hover:bg-indigo-700 font-bold shadow-lg hover:shadow-xl transition flex items-center transform hover:-translate-y-0.5 text-xs sm:text-sm">
                                <i class="fas fa-paper-plane mr-1 sm:mr-2"></i>AIãƒãƒƒãƒ<span
                                    class="hidden sm:inline">ã‚’å®Ÿè¡Œ</span>
                            </button>
                        </div>
                    </div>
                </div> <!-- Closes search-card -->

                <div id="jobs-container">
                    <!-- Jobs will be rendered here -->
                </div>
            </div> <!-- Closes jobs-content -->

            <!-- Applications Page -->
            <!-- æ±‚è·è€…æ¤œç´¢ãƒšãƒ¼ã‚¸ï¼ˆæ–°è¦è¿½åŠ ï¼‰ -->
            <div id="candidate-search-content" class="app-content p-6 hidden">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <div class="flex items-center gap-4">
                        <h2 class="text-2xl font-bold text-gray-900">æ±‚è·è€…æ¤œç´¢</h2>
                    </div>
                </div>

                <div class="search-card mb-8">
                    <!-- Target Job Selection (AI Matching) -->
                    <div id="admin-candidate-search-tools" class="mb-6 pb-6 border-b border-slate-100">
                        <div class="filter-group-label">
                            <i class="fas fa-briefcase text-indigo-500"></i> å¯¾è±¡æ±‚äººã‚’é¸æŠ <span
                                class="admin-badge ml-2">AIãƒãƒƒãƒãƒ³ã‚°ç”¨</span>
                        </div>
                        <div class="relative">
                            <div id="target-job-input-wrapper">
                                <input type="text" id="target-job-search" placeholder="æ±‚äººã‚¿ã‚¤ãƒˆãƒ«ã¾ãŸã¯ä¼æ¥­åã§æ¤œç´¢..."
                                    class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all" />
                                <i class="fas fa-search absolute right-3 top-3 text-slate-400"></i>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
                                <select id="t-job-category" class="w-full select2" multiple="multiple"></select>
                                <select id="t-industry" class="w-full select2" multiple="multiple"></select>
                                <select id="t-location" class="w-full select2" multiple="multiple"></select>
                            </div>

                            <!-- æ¤œç´¢çµæœãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ -->
                            <div id="target-job-dropdown"
                                class="hidden absolute w-full bg-white border border-slate-200 rounded-lg shadow-xl mt-1 z-50 max-h-60 overflow-y-auto">
                            </div>

                            <!-- é¸æŠæ¸ˆã¿æ±‚äººè¡¨ç¤º -->
                            <div id="selected-job-display"
                                class="hidden mt-3 p-3 bg-indigo-50 border border-indigo-100 rounded-lg flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold"
                                        id="selected-job-avatar"><i class="fas fa-building"></i></div>
                                    <div>
                                        <div class="font-bold text-slate-900" id="selected-job-title"></div>
                                        <div class="text-xs text-slate-500" id="selected-job-company"></div>
                                    </div>
                                </div>
                                <button id="clear-job-selection"
                                    class="text-slate-400 hover:text-red-500 transition-colors">
                                    <i class="fas fa-times-circle text-xl"></i>
                                </button>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button onclick="runJobToCandidateMatching()" id="job-ai-match-btn"
                                class="bg-indigo-600 text-white px-8 py-2 rounded-lg hover:bg-white hover:text-indigo-600 border border-transparent hover:border-indigo-600 font-bold transition shadow-md flex items-center"
                                disabled>
                                <i class="fas fa-robot mr-2"></i>AIãƒãƒƒãƒãƒ³ã‚°ã‚’å®Ÿè¡Œ
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <!-- Col 1: Keyword & Salary -->
                        <div class="space-y-4">
                            <div>
                                <label class="filter-group-label">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
                                <div class="relative">
                                    <input type="text" id="c-search-keyword" placeholder="ã‚¹ã‚­ãƒ«ã€çµŒæ­´ã€è³‡æ ¼ãªã©..."
                                        class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                                    <i class="fas fa-search absolute right-3 top-3 text-slate-400"></i>
                                </div>
                                <div id="c-tags-keyword" class="tag-container mt-2"></div>
                                <div class="flex gap-4 text-[10px] sm:text-xs text-slate-500 mt-2 px-1">
                                    <label class="flex items-center cursor-pointer hover:text-indigo-600 transition">
                                        <input type="radio" name="c-search-keyword-mode" value="OR" checked
                                            class="mr-1 accent-indigo-600"> ORæ¤œç´¢
                                    </label>
                                    <label class="flex items-center cursor-pointer hover:text-indigo-600 transition">
                                        <input type="radio" name="c-search-keyword-mode" value="AND"
                                            class="mr-1 accent-indigo-600"> ANDæ¤œç´¢
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="filter-group-label">å¸Œæœ›æœ€ä½å¹´å</label>
                                <div class="premium-slider-container">
                                    <input type="range" id="c-search-salary-slider" min="0" max="2000" step="50"
                                        value="0" class="premium-slider"
                                        oninput="$('#c-salary-display').text(this.value === '0' ? 'æŒ‡å®šãªã—' : this.value + ' ä¸‡å††ä»¥ä¸Š')">
                                    <div class="flex justify-between mt-2">
                                        <span class="text-[10px] text-slate-400">0</span>
                                        <span id="c-salary-display"
                                            class="text-sm font-bold text-indigo-600">æŒ‡å®šãªã—</span>
                                        <span class="text-[10px] text-slate-400">2000ä¸‡</span>
                                    </div>
                                    <input type="hidden" id="c-search-salary-min" value="0">
                                </div>
                            </div>
                        </div>

                        <!-- Col 2: Job Category & Employment Type -->
                        <div class="space-y-4">
                            <div>
                                <label class="filter-group-label">å¸Œæœ›è·ç¨®</label>
                                <select id="c-search-job-category" class="w-full select2" multiple="multiple"></select>
                                <div id="c-tags-job" class="tag-container mt-1"></div>
                            </div>
                            <div>
                                <label class="filter-group-label">å¸Œæœ›é›‡ç”¨å½¢æ…‹</label>
                                <select id="c-search-employment-type" class="w-full select2"
                                    multiple="multiple"></select>
                                <div id="c-tags-employment" class="tag-container mt-1"></div>
                            </div>
                        </div>

                        <!-- Col 3: Industry & Status -->
                        <div class="space-y-4">
                            <div>
                                <label class="filter-group-label">å¸Œæœ›æ¥­ç•Œ</label>
                                <select id="c-search-industry-category" class="w-full select2"
                                    multiple="multiple"></select>
                                <div id="c-tags-industry" class="tag-container mt-1"></div>
                            </div>
                            <div>
                                <label class="filter-group-label">ç®¡ç†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                                <select id="c-search-management-status"
                                    class="w-full px-4 py-2 border border-slate-200 rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="all">ã™ã¹ã¦</option>
                                    <option value="active" selected>æ´»å‹•ä¸­</option>
                                    <option value="inactive">æ´»å‹•çµ‚äº†</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Details (Always Visible) -->
                    <div
                        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8 pt-6 border-t border-slate-50">
                        <div>
                            <label class="filter-group-label">å¸Œæœ›å‹¤å‹™åœ°</label>
                            <select id="c-search-prefecture" class="w-full select2" multiple="multiple"></select>
                            <div id="c-tags-prefecture" class="tag-container mt-1"></div>
                        </div>
                        <div>
                            <label class="filter-group-label">å‹¤å‹™åœ°ãƒ•ãƒªãƒ¼ãƒ¯ãƒ¼ãƒ‰(é§…åã€åœ°åãªã©)</label>
                            <div class="relative">
                                <input type="text" id="c-search-location" placeholder="æ¨ªæµœã€å¤§é˜ªã€ãƒªãƒ¢ãƒ¼ãƒˆãªã©..."
                                    class="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                                <i class="fas fa-map-marked-alt absolute right-3 top-3 text-slate-400"></i>
                            </div>
                            <div id="c-tags-location" class="tag-container mt-1"></div>
                        </div>
                    </div>

                    <!-- AI Search Prompt -->
                    <div id="candidate-ai-search-box"
                        class="ai-search-box bg-white disabled collapsed mb-8 p-6 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-2xl border border-indigo-100 shadow-sm relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i class="fas fa-robot text-6xl text-indigo-600"></i>
                        </div>
                        <div class="relative">
                            <div class="ai-search-header flex justify-between items-center cursor-pointer select-none"
                                onclick="toggleAISearch('candidate')">
                                <div class="flex items-center gap-3">
                                    <label class="flex items-center gap-2 m-0">
                                        <span class="bg-white p-2 rounded-lg shadow-sm text-indigo-600">
                                            <i class="fas fa-magic"></i>
                                        </span>
                                        <span class="text-sm font-bold text-indigo-900">AI Search Assistant
                                            (ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæŒ‡ç¤º)</span>
                                        <span
                                            class="ml-2 px-2 py-0.5 bg-indigo-600 text-white text-[10px] rounded-full font-bold uppercase tracking-wider">PREMIUM</span>
                                    </label>
                                    <div class="disabled-message items-center gap-1">
                                        <i class="fas fa-lock text-xs"></i>
                                        <span>çµæœã‚’500ä»¶æœªæº€ã«çµã‚Šè¾¼ã‚€ã¨åˆ©ç”¨å¯èƒ½ã§ã™</span>
                                    </div>
                                </div>
                                <div class="ai-search-toggle-icon text-indigo-400">
                                    <i class="fas fa-chevron-up"></i>
                                </div>
                            </div>

                            <div class="ai-search-body transition-all duration-300">
                                <div class="relative">
                                    <textarea id="c-search-ai-prompt"
                                        placeholder="ä¾‹: å¤§æ‰‹SIerå‡ºèº«ã§ã€PMçµŒé¨“ãŒè±Šå¯Œã€ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³èƒ½åŠ›ãŒé«˜ãã†ãªæ–¹ã‚’å„ªå…ˆã—ã¦..."
                                        class="w-full bg-white border border-indigo-100 rounded-xl p-4 text-sm focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all shadow-inner hover:border-indigo-300 min-h-[80px]"
                                        rows="2"></textarea>
                                    <div class="mt-2 flex items-center gap-4 text-[10px] text-slate-500">
                                        <span class="flex items-center gap-1">
                                            <i class="fas fa-info-circle"></i>
                                            é€šå¸¸ã®ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ã«åŠ ãˆã¦ã€AIãŒæŒ‡ç¤ºå†…å®¹ã«åŸºã¥ãé †ä½ä»˜ã‘ã¨åˆ†æã‚’è¡Œã„ã¾ã™ã€‚
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex flex-wrap gap-6 justify-between items-center pt-6 border-t border-slate-100">
                        <div class="flex gap-4 items-center">
                            <button onclick="searchCandidatesImmediate()"
                                class="bg-indigo-600 text-white px-10 py-2.5 rounded-lg hover:bg-white hover:text-indigo-600 border border-transparent hover:border-indigo-600 font-bold transition shadow-md flex items-center">
                                <i class="fas fa-search mr-2"></i>æ±‚è·è€…æ¤œç´¢
                            </button>
                            <button onclick="clearCandidateSearch()"
                                class="px-8 py-2.5 border border-slate-200 text-slate-600 rounded-lg hover:bg-slate-50 font-medium transition">
                                ã‚¯ãƒªã‚¢
                            </button>

                            <div id="candidate-count-display-premium" class="hidden count-badge-premium ml-4">
                                <i class="fas fa-user text-indigo-400 text-xl"></i>
                                <div class="flex flex-col leading-none">
                                    <span
                                        class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Candidates
                                        Found</span>
                                    <div class="flex items-baseline gap-1">
                                        <span id="candidate-count-number" class="count-number-premium">0</span>
                                        <span class="text-xs text-slate-500 font-bold">å</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <select id="c-search-sort"
                                class="px-4 py-2 border border-slate-200 rounded-lg text-sm bg-slate-50 hover:bg-white transition cursor-pointer">
                                <option value="created_at-desc">ç™»éŒ²æ—¥ï¼ˆæ–°ã—ã„é †ï¼‰</option>
                                <option value="age-asc">å¹´é½¢ï¼ˆè‹¥ã„é †ï¼‰</option>
                                <option value="age-desc">å¹´é½¢ï¼ˆé«˜ã„é †ï¼‰</option>
                                <option value="salary-desc">å¸Œæœ›å¹´åãŒé«˜ã„é †</option>
                                <option value="salary-asc">å¸Œæœ›å¹´åãŒä½ã„é †</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- çµæœä¸€è¦§ -->
                <div id="candidate-results-container" class="space-y-4">
                    <!-- Candidates will be rendered here -->
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-search text-4xl mb-3"></i>
                        <p>æ¡ä»¶ã‚’æŒ‡å®šã—ã¦æ¤œç´¢ã—ã¦ãã ã•ã„</p>
                    </div>
                </div>
                <div id="load-more-candidates-container" class="text-center mt-8 hidden">
                    <button onclick="loadMoreCandidates()"
                        class="bg-white border border-gray-300 text-gray-700 px-6 py-3 rounded-xl hover:bg-gray-50 transition">
                        ã‚‚ã£ã¨è¦‹ã‚‹
                    </button>
                </div>
            </div>

            <div id="applications-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6 flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-semibold mb-2">å¿œå‹Ÿãƒ»é¸è€ƒå±¥æ­´</h2>
                        <p class="text-gray-600">å¿œå‹Ÿãƒ»é¸è€ƒä¸­ã®æ±‚äººã®ä¸€è¦§ã§ã™ã€‚</p>
                    </div>
                    <button onclick="exportApplicationsCsv()" id="export-applications-btn"
                        class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 hidden">
                        <i class="fas fa-download mr-2"></i>CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                </div>

                <!-- Candidate Search/Filter -->
                <div class="bg-white rounded-xl shadow-sm border p-4 mb-6">
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex-1 relative">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="application-search-input" placeholder="ä¼æ¥­åã€è·ç¨®ã§æ¤œç´¢..."
                                class="w-full pl-9 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                                onkeyup="filterCandidateApplications()">
                        </div>
                        <div class="flex items-center gap-2 overflow-x-auto pb-1 md:pb-0 no-scrollbar">
                            <button onclick="setCandidateApplicationStatusFilter('all')"
                                class="candidate-status-filter active whitespace-nowrap px-4 py-2 rounded-lg text-sm font-bold bg-indigo-600 text-white border border-indigo-600"
                                data-status="all">ã™ã¹ã¦</button>
                            <button onclick="setCandidateApplicationStatusFilter('ongoing')"
                                class="candidate-status-filter whitespace-nowrap px-4 py-2 rounded-lg text-sm font-bold bg-white text-gray-600 border border-gray-200 hover:bg-gray-50"
                                data-status="ongoing">é¸è€ƒä¸­</button>
                            <button onclick="setCandidateApplicationStatusFilter('offered')"
                                class="candidate-status-filter whitespace-nowrap px-4 py-2 rounded-lg text-sm font-bold bg-white text-gray-600 border border-gray-200 hover:bg-gray-50"
                                data-status="offered">å†…å®š</button>
                            <button onclick="setCandidateApplicationStatusFilter('closed')"
                                class="candidate-status-filter whitespace-nowrap px-4 py-2 rounded-lg text-sm font-bold bg-white text-gray-600 border border-gray-200 hover:bg-gray-50"
                                data-status="closed">çµ‚äº†</button>
                        </div>
                    </div>
                </div>
                <div id="applications-container">
                    <!-- Applications will be rendered here -->
                </div>
            </div>

            <!-- Recommendations Page -->
            <div id="recommendations-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-2">ãŠã™ã™ã‚æ±‚äºº</h2>
                    <p class="text-gray-600">ã‚ãªãŸã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã«åŸºã¥ã„ã¦ã€AIãŒæœ€é©ãªæ±‚äººã‚’ææ¡ˆã—ã¾ã™ã€‚</p>
                </div>

                <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
                <div class="bg-white rounded-lg shadow mb-6">
                    <div class="border-b border-gray-200">
                        <nav class="flex -mb-px">
                            <button onclick="switchRecommendationTab('matches')" id="rec-tab-matches"
                                class="rec-tab px-6 py-3 text-sm font-medium border-b-2 border-indigo-600 text-indigo-600">
                                <i class="fas fa-check-circle mr-2"></i>ææ¡ˆ (50%ä»¥ä¸Š)
                            </button>
                            <button onclick="switchRecommendationTab('unmatches')" id="rec-tab-unmatches"
                                class="rec-tab px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                <i class="fas fa-times-circle mr-2"></i>ã‚¢ãƒ³ãƒãƒƒãƒ (49%ä»¥ä¸‹)
                            </button>
                        </nav>
                    </div>
                </div>

                <div id="recommendations-container">
                    <!-- Recommendations will be rendered here -->
                </div>

                <!-- æ¨è–¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
                <div id="recommendation-message-modal"
                    class="fixed inset-0 bg-black bg-opacity-50 z-[100] hidden flex items-center justify-center p-4">
                    <div
                        class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                        <div class="p-6 border-b flex justify-between items-center bg-indigo-50">
                            <div>
                                <h3 class="text-xl font-bold text-indigo-900"><i class="fas fa-magic mr-2"></i>æ¨è–¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
                                </h3>
                                <p class="text-xs text-indigo-600 mt-1">é¸æŠã—ãŸæ±‚äººã®å†…å®¹ã‚’å…ƒã«ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è‡ªå‹•æ§‹æˆã—ã¾ã™</p>
                            </div>
                            <button onclick="closeRecommendationMessageModal()"
                                class="text-gray-400 hover:text-gray-600 transition-colors">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-6 space-y-6">
                            <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ</label>
                                    <select id="message-template-select" onchange="applyMessageTemplate(this.value)"
                                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <!-- Loaded dynamically -->
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button onclick="generateRecommendationMessage()"
                                        class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 font-bold transition flex items-center justify-center gap-2">
                                        <i class="fas fa-sync-alt"></i> ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆ/æ›´æ–°
                                    </button>
                                </div>
                            </div>

                            <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡ -->
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">
                                    ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡
                                    <span class="text-xs font-normal text-gray-500 ml-2">(å¿…è¦ã«å¿œã˜ã¦æ‰‹å‹•ã§èª¿æ•´ã—ã¦ãã ã•ã„)</span>
                                </label>
                                <textarea id="recommendation-message-body" rows="15"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm font-mono focus:ring-2 focus:ring-indigo-500 bg-gray-50"></textarea>
                            </div>
                        </div>
                        <div class="p-6 border-t bg-gray-50 flex justify-between items-center">
                            <div class="flex gap-2">
                                <button onclick="copyRecommendationMessage()"
                                    class="px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium transition flex items-center gap-2">
                                    <i class="fas fa-copy"></i> ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
                                </button>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="closeRecommendationMessageModal()"
                                    class="px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium transition">
                                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                                </button>
                                <button id="send-recommendation-email-btn" onclick="sendRecommendationEmail()"
                                    class="px-8 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold shadow-lg transition flex items-center gap-2">
                                    <i class="fas fa-paper-plane"></i> å€™è£œè€…ã¸ãƒ¡ãƒ¼ãƒ«é€ä¿¡
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profile-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 max-w-2xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</h2>
                        <div class="relative">
                            <input type="file" id="resume-upload" accept=".pdf" multiple class="hidden"
                                onchange="handleResumeUpload(this)">
                            <button onclick="$('#resume-upload').click()"
                                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm flex items-center">
                                <i class="fas fa-file-pdf mr-2"></i>PDFã‹ã‚‰è‡ªå‹•å…¥åŠ›
                            </button>
                        </div>
                    </div>
                    <form id="profile-form" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ãŠåå‰</label>
                            <input type="text" id="profile-name" class="w-full px-4 py-2 border rounded-lg bg-gray-50"
                                readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ãµã‚ŠãŒãª</label>
                            <input type="text" id="profile-furigana"
                                class="w-full px-4 py-2 border rounded-lg bg-gray-50">
                            <p class="text-xs text-gray-500 mt-1">â€»ãŠåå‰ã¯ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                                <input type="email" id="profile-email" class="w-full px-4 py-2 border rounded-lg"
                                    required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">é›»è©±ç•ªå·</label>
                                <input type="tel" id="profile-phone" class="w-full px-4 py-2 border rounded-lg"
                                    placeholder="ä¾‹: 090-0000-0000">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ç”Ÿå¹´æœˆæ—¥</label>
                                <input type="date" id="profile-birth-date" class="w-full px-4 py-2 border rounded-lg"
                                    onchange="calculateAge(this.value, '#profile-age')">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">å¹´é½¢</label>
                                <input type="number" id="profile-age" class="w-full px-4 py-2 border rounded-lg"
                                    min="0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">æ€§åˆ¥</label>
                                <select id="profile-gender" class="w-full px-4 py-2 border rounded-lg">
                                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                    <option value="ç”·æ€§">ç”·æ€§</option>
                                    <option value="å¥³æ€§">å¥³æ€§</option>
                                    <option value="ãã®ä»–">ãã®ä»–</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç¾ä½æ‰€ï¼ˆéƒ½é“åºœçœŒï¼‰</label>
                            <select id="profile-current-location"
                                class="w-full px-4 py-2 border rounded-lg select2-prefecture">
                                <option value="">éƒ½é“åºœçœŒã‚’é¸æŠ</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">å¸Œæœ›è·ç¨®</label>
                                <select id="profile-job-type" class="w-full px-4 py-2 border rounded-lg select2"
                                    multiple style="width: 100%">
                                    <!-- Options will be loaded dynamically -->
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">å¸Œæœ›æ¥­ç•Œ</label>
                                <select id="profile-industry" class="w-full px-4 py-2 border rounded-lg select2"
                                    multiple style="width: 100%">
                                    <!-- Options will be loaded dynamically -->
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">å¸Œæœ›å‹¤å‹™åœ°</label>
                                <div class="flex gap-2">
                                    <select id="profile-prefecture" class="w-1/3 px-2 py-2 border rounded-lg select2"
                                        multiple="multiple">
                                        style="width: 40%">
                                        <option value="">éƒ½é“åºœçœŒ</option>
                                    </select>
                                    <input type="text" id="profile-city" placeholder="å¸‚åŒºç”ºæ‘ï¼ˆä¾‹: æ¸‹è°·åŒºï¼‰"
                                        class="w-2/3 px-4 py-2 border rounded-lg" style="width: 60%">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">å¸Œæœ›é›‡ç”¨å½¢æ…‹</label>
                                <select id="profile-employment-type" class="w-full px-4 py-2 border rounded-lg select2"
                                    multiple style="width: 100%">
                                    <!-- Options will be loaded dynamically -->
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">å¸Œæœ›æœ€ä½å¹´åï¼ˆä¸‡å††ï¼‰</label>
                                <input type="number" id="profile-salary" placeholder="ä¾‹: 400" min="0"
                                    class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ•ãƒªãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
                                <input type="text" id="profile-freewords" placeholder="æ¤œç´¢ç”¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰"
                                    class="w-full px-4 py-2 border rounded-lg">
                            </div>
                        </div>

                        <div class="flex gap-6">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="profile-job-experience-ok"
                                    class="w-4 h-4 text-indigo-600 rounded">
                                <span class="text-sm text-gray-700">è·ç¨®æœªçµŒé¨“å¯</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="profile-industry-experience-ok"
                                    class="w-4 h-4 text-indigo-600 rounded">
                                <span class="text-sm text-gray-700">æ¥­ç•ŒæœªçµŒé¨“å¯</span>
                            </label>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ã‚¹ã‚­ãƒ«</label>
                            <input type="text" id="profile-skills" placeholder="ä¾‹: React, TypeScript, Figma"
                                class="w-full px-4 py-2 border rounded-lg">
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ç¾åœ¨ã®å¹´åï¼ˆä¸‡å††ï¼‰</label>
                                <input type="number" id="profile-current-salary" placeholder="ä¾‹: 400" min="0"
                                    class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">æœ€çµ‚å­¦æ­´</label>
                                <input type="text" id="profile-academic" placeholder="ä¾‹: ã€‡ã€‡å¤§å­¦ çµŒæ¸ˆå­¦éƒ¨ å’"
                                    class="w-full px-4 py-2 border rounded-lg">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">èªå­¦åŠ›</label>
                                <input type="text" id="profile-languages" placeholder="ä¾‹: TOEIC 800ç‚¹, æ—¥å¸¸ä¼šè©±ãƒ¬ãƒ™ãƒ«ã®è‹±èª"
                                    class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">è³‡æ ¼</label>
                                <input type="text" id="profile-certifications" placeholder="ä¾‹: åŸºæœ¬æƒ…å ±æŠ€è¡“è€…, AWS SAA"
                                    class="w-full px-4 py-2 border rounded-lg">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å‹¤å‹™é–‹å§‹å¯èƒ½æ—¥</label>
                            <input type="date" id="profile-start-date" class="w-full px-4 py-2 border rounded-lg">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">è·æ­´ãƒ»è‡ªå·±PRï¼ˆæ¦‚è¦ï¼‰</label>
                            <textarea id="profile-history" rows="6" placeholder="ã“ã‚Œã¾ã§ã®çµŒé¨“ã‚„å¾—æ„ãªã“ã¨ã‚’è©³ã—ãæ•™ãˆã¦ãã ã•ã„"
                                class="w-full px-4 py-2 border rounded-lg"></textarea>
                        </div>

                        <!-- æ§‹é€ åŒ–ã•ã‚ŒãŸè·æ­´ (New) -->
                        <div class="mb-6 border-t border-gray-200 pt-6">
                            <div class="flex justify-between items-center mb-4">
                                <label class="block text-sm font-bold text-gray-700">è©³ç´°è·æ­´ (æœ€å¤§10ç¤¾)</label>
                                <button type="button"
                                    onclick="addWorkHistoryItemToContainer('#profile-work-history-list')"
                                    class="text-sm text-indigo-600 hover:text-indigo-800 flex items-center font-medium">
                                    <i class="fas fa-plus-circle mr-1"></i>è·æ­´ã‚’è¿½åŠ 
                                </button>
                            </div>
                            <div id="profile-work-history-list" class="space-y-4 mb-2">
                                <!-- JSã§å‹•çš„ã«è¿½åŠ  -->
                            </div>

                            <div class="flex items-center gap-4 mt-2 mb-4">
                                <label class="text-xs text-gray-500">çµŒé¨“ç¤¾æ•° (è‡ªå‹•è¨ˆç®—):</label>
                                <input type="number" id="profile-job-change-count"
                                    class="w-20 px-2 py-1 border rounded bg-gray-50 text-center text-sm" readonly>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">è·å‹™çµŒæ­´
                                (è©³ç´°ãƒ†ã‚­ã‚¹ãƒˆ)</label>
                            <textarea id="profile-work-history-detail" rows="10"
                                class="w-full px-4 py-2 border rounded-lg text-sm font-mono bg-gray-50 focus:bg-white transition"
                                placeholder="è·å‹™çµŒæ­´ã®è©³ç´°ãƒ†ã‚­ã‚¹ãƒˆã‚’ã“ã¡ã‚‰ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å±¥æ­´æƒ…å ±</label>
                            <textarea id="profile-history-info" rows="6"
                                class="w-full px-4 py-2 border rounded-lg text-sm bg-gray-50 focus:bg-white transition"
                                placeholder="å±¥æ­´æƒ…å ±ã®è£œè¶³ã‚„è©³ç´°ã‚’ã“ã¡ã‚‰ã«å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                        </div>

                        <!-- ç¤¾å†…ç”¨æƒ…å ± (ç®¡ç†è€…ãƒ»ã‚³ãƒ¼ãƒã®ã¿è¡¨ç¤º) -->
                        <div id="internal-profile-info"
                            class="hidden border-t-2 border-dashed border-indigo-200 pt-6 mt-8 space-y-6">
                            <h3 class="text-lg font-bold text-indigo-900 flex items-center">
                                <i class="fas fa-lock mr-2"></i>ç¤¾å†…ç”¨æƒ…å ±ï¼ˆæ±‚è·è€…ã«ã¯éè¡¨ç¤ºï¼‰
                            </h3>

                            <div class="grid grid-cols-1 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Google Drive
                                        URL</label>
                                    <input type="url" id="profile-drive-url" class="w-full px-4 py-2 border rounded-lg"
                                        placeholder="https://drive.google.com/...">
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">NotebookLM
                                            URL</label>
                                        <input type="url" id="profile-notebooklm-url"
                                            class="w-full px-4 py-2 border rounded-lg"
                                            placeholder="https://notebooklm.google.com/...">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">LINE
                                            URL</label>
                                        <input type="url" id="profile-line-url"
                                            class="w-full px-4 py-2 border rounded-lg"
                                            placeholder="https://line.me/...">
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ç¤¾å†…ãƒãƒƒãƒãƒ³ã‚°æƒ…å ±</label>
                                <textarea id="profile-resume-detail" rows="10"
                                    class="w-full px-4 py-2 border rounded-lg text-sm font-mono bg-gray-50 focus:bg-white transition"
                                    placeholder="ç¤¾å†…ãƒãƒƒãƒãƒ³ã‚°æƒ…å ±ï¼ˆã‚¹ã‚­ãƒ«ã€çµŒé¨“ã€å¸Œæœ›ã®è£œè¶³ãªã©ï¼‰"></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ç¤¾å†…ãƒ¡ãƒ¢ãƒ»å…±æœ‰äº‹é …</label>
                                <textarea id="profile-notes" rows="6"
                                    class="w-full px-4 py-2 border rounded-lg text-sm bg-gray-50 focus:bg-white transition"
                                    placeholder="ç¤¾å†…ãƒ¡ãƒ¢ã€é¢è«‡è¨˜éŒ²ã€å…±æœ‰äº‹é …ãªã©"></textarea>
                            </div>
                        </div>

                        <div class="flex justify-end pt-4">
                            <button type="submit"
                                class="bg-indigo-600 text-white px-8 py-2 rounded-lg hover:bg-indigo-700 transition font-medium">
                                ä¿å­˜ã™ã‚‹
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- AIã‚¹ã‚«ã‚¦ãƒˆãƒšãƒ¼ã‚¸ -->
            <!-- AIã‚¹ã‚«ã‚¦ãƒˆãƒšãƒ¼ã‚¸ -->
            <div id="ai-scout-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg w-full p-6 shadow min-h-[600px]">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-900">
                            <i class="fas fa-robot text-indigo-600 mr-2"></i>AIã‚¹ã‚«ã‚¦ãƒˆ
                        </h3>
                    </div>

                    <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
                    <div class="border-b border-gray-200 mb-4">
                        <nav class="flex space-x-8">
                            <button onclick="switchProfileAnalysisTab('new')" id="profile-tab-new"
                                class="profile-analysis-tab py-3 px-1 border-b-2 border-indigo-600 font-medium text-sm text-indigo-600">
                                æ–°è¦è§£æ
                            </button>
                            <button onclick="switchProfileAnalysisTab('history')" id="profile-tab-history"
                                class="profile-analysis-tab py-3 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                è§£æå±¥æ­´
                            </button>
                            <button onclick="switchProfileAnalysisTab('scout_management')"
                                id="profile-tab-scout_management"
                                class="profile-analysis-tab py-3 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                ã‚¹ã‚«ã‚¦ãƒˆç®¡ç†
                            </button>
                            <button onclick="switchProfileAnalysisTab('analytics')" id="profile-tab-analytics"
                                class="profile-analysis-tab py-3 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                åŠ¹æœæ¸¬å®š
                            </button>
                        </nav>
                    </div>

                    <!-- æ–°è¦è§£æã‚¿ãƒ– -->
                    <div id="profile-new-tab-content" class="flex-1 overflow-y-auto flex gap-6">
                        <!-- å·¦å´: å…¥åŠ›ã‚¨ãƒªã‚¢ -->
                        <!-- å·¦å´: å…¥åŠ›ã‚¨ãƒªã‚¢ -->
                        <div class="w-1/3 flex flex-col gap-6">

                            <!-- STEP 1: Basic Information -->
                            <div
                                class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm transition hover:shadow-md">
                                <!-- 1. Candidate Info Header -->
                                <div class="flex items-center justify-between mb-4">
                                    <h5 class="font-bold text-gray-700 flex items-center">
                                        <span
                                            class="bg-indigo-100 text-indigo-600 rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2">1</span>
                                        å€™è£œè€…æƒ…å ±ã®å…¥åŠ›
                                        <div class="group relative inline-block ml-2 align-middle">
                                            <i
                                                class="fas fa-question-circle text-gray-400 hover:text-indigo-500 cursor-help transition-colors"></i>
                                            <div
                                                class="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none z-50 leading-relaxed text-left font-normal">
                                                <div
                                                    class="absolute top-[-6px] left-1/2 transform -translate-x-1/2 w-3 h-3 bg-gray-800 rotate-45">
                                                </div>
                                                å€™è£œè€…ã®æ°åã‚„IDã‚’å…¥åŠ›ã—ã¾ã™ã€‚ã“ã‚Œã¯å±¥æ­´ç®¡ç†ã®ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã€AIã®è§£æçµæœã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“ã€‚
                                            </div>
                                        </div>
                                    </h5>
                                    <button onclick="openScoutSettingsModal()"
                                        class="text-xs text-indigo-600 hover:text-indigo-800 flex items-center transition-colors">
                                        <i class="fas fa-cog mr-1"></i>è¨­å®š
                                        <div class="group relative inline-block ml-1 align-middle">
                                            <div
                                                class="absolute right-0 bottom-full mb-2 w-48 p-2 bg-gray-800 text-white text-xs rounded shadow opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-50 text-center font-normal">
                                                æ–‡ä½“ã‚„ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
                                            </div>
                                        </div>
                                    </button>
                                </div>

                                <div class="mb-4">
                                    <label class="block text-xs font-bold text-gray-700 mb-1.5">
                                        å€™è£œè€…å / ç®¡ç†ID <span class="font-normal text-gray-400 ml-1">(ä»»æ„)</span>
                                    </label>
                                    <input type="text" id="candidate-title-input"
                                        class="w-full border border-gray-200 bg-gray-50 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all"
                                        placeholder="ä¾‹: BizReach 123456">
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-gray-700 mb-1.5 flex items-center">
                                        ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±å…¥åŠ› <span class="font-normal text-gray-400 ml-1">(è£œè¶³æƒ…å ±ãªã©)</span>
                                        <div class="group relative inline-block ml-2 align-middle">
                                            <i
                                                class="fas fa-question-circle text-gray-400 hover:text-indigo-500 cursor-help transition-colors"></i>
                                            <div
                                                class="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 w-72 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none z-50 leading-relaxed font-normal">
                                                <div
                                                    class="absolute top-[-6px] left-1/2 transform -translate-x-1/2 w-3 h-3 bg-gray-800 rotate-45">
                                                </div>
                                                è·å‹™çµŒæ­´æ›¸ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ç›´æ¥è²¼ã‚Šä»˜ã‘ã‚‹ã‹ã€ã€Œå¹´åã€‡ã€‡ä¸‡å††ä»¥ä¸Šå¸Œæœ›ã€ã€Œãƒ•ãƒ«ãƒªãƒ¢ãƒ¼ãƒˆå¸Œæœ›ã€ãªã©ã®è£œè¶³æ¡ä»¶ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚AIãŒã“ã‚Œã‚’è€ƒæ…®ã—ã¦ãƒãƒƒãƒãƒ³ã‚°ã—ã¾ã™ã€‚
                                            </div>
                                        </div>
                                    </label>
                                    <textarea id="profile-text-input" rows="4"
                                        class="w-full border border-gray-200 bg-gray-50 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all resize-none"
                                        placeholder="å€™è£œè€…ã®çµŒæ­´ã€ã‚¹ã‚­ãƒ«ã€å¸Œæœ›æ¡ä»¶ãªã©ã‚’å…¥åŠ›..."></textarea>
                                </div>
                            </div>

                            <!-- STEP 2: File Upload -->
                            <div
                                class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm transition hover:shadow-md relative">
                                <div class="mb-3">
                                    <h5 class="font-bold text-gray-700 flex items-center">
                                        <span
                                            class="bg-indigo-100 text-indigo-600 rounded-full w-6 h-6 flex items-center justify-center text-xs mr-2">2</span>
                                        è³‡æ–™ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                                        <div class="group relative inline-block ml-2 align-middle">
                                            <i
                                                class="fas fa-question-circle text-gray-400 hover:text-indigo-500 cursor-help transition-colors"></i>
                                            <div
                                                class="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none z-50 leading-relaxed font-normal">
                                                <div
                                                    class="absolute top-[-6px] left-1/2 transform -translate-x-1/2 w-3 h-3 bg-gray-800 rotate-45">
                                                </div>
                                                å±¥æ­´æ›¸ãƒ»è·å‹™çµŒæ­´æ›¸ã®PDFã‚„ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚åŒ¿åå…¬é–‹ã•ã‚Œã¦ã„ã‚‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚‚è§£æå¯èƒ½ã§ã™ã€‚
                                            </div>
                                        </div>
                                    </h5>
                                </div>

                                <div id="file-drop-area"
                                    class="border-2 border-dashed border-indigo-300 bg-indigo-50 rounded-xl p-8 text-center hover:bg-indigo-100 transition-colors cursor-pointer relative">

                                    <div class="mb-3 transform group-hover:scale-110 transition-transform duration-300">
                                        <div
                                            class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center mx-auto text-indigo-500">
                                            <i class="fas fa-cloud-upload-alt text-xl"></i>
                                        </div>
                                    </div>

                                    <p class="text-sm font-bold text-gray-700 mb-1">ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°</p>
                                    <p class="text-xs text-gray-500">PDF, ç”»åƒ (å±¥æ­´æ›¸/è·å‹™çµŒæ­´æ›¸)</p>
                                    <input type="file" id="profile-file-input" class="hidden"
                                        accept="image/*,application/pdf" multiple>
                                </div>
                                <div id="file-list" class="mt-3 space-y-1"></div>
                            </div>

                            <!-- Action -->
                            <div class="relative group">
                                <button id="analyze-profile-btn" onclick="analyzeProfile()"
                                    class="w-full bg-gradient-to-r from-indigo-600 to-violet-600 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:shadow-xl hover:from-indigo-700 hover:to-violet-700 transform hover:-translate-y-0.5 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                                    <i class="fas fa-magic mr-2"></i>AIè§£æã‚’å®Ÿè¡Œ
                                </button>
                                <div
                                    class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-max px-3 py-1 bg-gray-800 text-white text-xs rounded shadow opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all pointer-events-none">
                                    ç´„30ã€œ60ç§’ã§è§£æãŒå®Œäº†ã—ã¾ã™
                                </div>
                            </div>

                            <div class="text-center">
                                <button onclick="resetProfileAnalysis()"
                                    class="text-xs text-gray-400 hover:text-gray-600 underline">
                                    å…¥åŠ›å†…å®¹ã‚’ãƒªã‚»ãƒƒãƒˆ
                                </button>
                            </div>

                            <!-- ã‚¹ã‚«ã‚¦ãƒˆä¿®æ­£æŒ‡ç¤ºã‚¨ãƒªã‚¢ (Hidden) -->
                            <div id="scout-instruction-container"
                                class="hidden mt-2 bg-yellow-50 p-4 rounded-xl border border-yellow-100">
                                <label class="block text-xs font-bold text-yellow-800 mb-2">
                                    <i class="fas fa-pen-fancy mr-1"></i>ä¿®æ­£æŒ‡ç¤ºãƒ»å†ç”Ÿæˆ
                                </label>
                                <textarea id="scout-instruction-text" rows="3"
                                    class="w-full border border-yellow-200 bg-white rounded-lg px-3 py-2 text-sm focus:ring-yellow-500 mb-2"
                                    placeholder="ä¾‹: æ–‡é¢ã‚’ã‚‚ã£ã¨ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã«..."></textarea>
                                <button id="regenerate-scout-btn" onclick="regenerateScoutsWithInstruction()"
                                    class="w-full bg-white text-yellow-700 border border-yellow-300 py-2 rounded-lg font-bold text-sm hover:bg-yellow-50 transition">
                                    <i class="fas fa-sync-alt mr-2"></i>æŒ‡ç¤ºã‚’åæ˜ ã—ã¦å†ç”Ÿæˆ
                                </button>
                            </div>
                        </div>

                        <!-- å³å´: è§£æçµæœã‚¨ãƒªã‚¢ -->
                        <div
                            class="w-2/3 bg-gray-50/50 rounded-xl p-6 overflow-y-auto border border-gray-200/60 shadow-inner min-h-[500px] flex flex-col relative">
                            <div id="analysis-placeholder" class="text-center m-auto max-w-sm">
                                <div
                                    class="w-20 h-20 bg-white rounded-full shadow-md flex items-center justify-center mx-auto mb-6">
                                    <i class="fas fa-magic text-3xl text-indigo-500 animate-pulse-slow"></i>
                                </div>
                                <h4 class="text-lg font-bold text-gray-800 mb-2">AIã‚¹ã‚«ã‚¦ãƒˆã‚’é–‹å§‹</h4>
                                <p class="text-sm text-gray-500 leading-relaxed mb-6">
                                    å·¦å´ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å±¥æ­´æ›¸ãƒ»è·å‹™çµŒæ­´æ›¸ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚<br>
                                    AIãŒçµŒé¨“ãƒ»ã‚¹ã‚­ãƒ«ã‚’è§£æã—ã€æœ€é©ãªæ±‚äººææ¡ˆã¨ã‚¹ã‚«ã‚¦ãƒˆæ–‡é¢ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚
                                </p>
                                <div class="flex justify-center gap-4 text-xs text-gray-400">
                                    <span class="flex items-center"><i class="fas fa-check mr-1"></i>PDFå¯¾å¿œ</span>
                                    <span class="flex items-center"><i class="fas fa-check mr-1"></i>ç”»åƒå¯¾å¿œ</span>
                                </div>
                            </div>

                            <div id="analysis-loading" class="hidden text-center py-20">
                                <div
                                    class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4">
                                </div>
                                <p class="text-indigo-600 font-bold">AIãŒç”»åƒã‚’è§£æä¸­...</p>
                                <p class="text-sm text-gray-500 mt-2">çµŒæ­´ã®æŠ½å‡ºã¨æ±‚äººãƒãƒƒãƒãƒ³ã‚°ã‚’è¡Œã£ã¦ã„ã¾ã™</p>
                            </div>

                            <div id="analysis-results" class="hidden space-y-6">
                                <!-- å€™è£œè€…ã‚µãƒãƒªãƒ¼ -->
                                <div class="bg-white p-4 rounded-lg shadow-sm border border-indigo-100">
                                    <h4 class="font-bold text-indigo-900 mb-2"><i
                                            class="fas fa-user-circle mr-2"></i>å€™è£œè€…ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¦ç´„</h4>
                                    <p id="candidate-summary-text" class="text-gray-700 text-sm leading-relaxed">
                                    </p>
                                </div>

                                <h4 class="font-bold text-gray-900 border-b pb-2">ææ¡ˆæ±‚äºº & ã‚¹ã‚«ã‚¦ãƒˆæ–‡é¢</h4>
                                <div id="suggested-jobs-container" class="space-y-6">
                                    <!-- ã“ã“ã«çµæœãŒæŒ¿å…¥ã•ã‚Œã‚‹ -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è§£æå±¥æ­´ã‚¿ãƒ– -->
                    <div id="profile-history-tab-content" class="hidden flex-1 overflow-y-auto">
                        <div class="mb-4 flex justify-between items-center">
                            <h4 class="text-lg font-semibold text-gray-900">éå»ã®è§£æå±¥æ­´</h4>
                            <button onclick="loadProfileAnalysisHistory()"
                                class="text-sm text-indigo-600 hover:text-indigo-800">
                                <i class="fas fa-sync-alt mr-1"></i>æ›´æ–°
                            </button>
                        </div>
                        <div id="history-list" class="space-y-4">
                            <div class="text-center py-12 text-gray-500">
                                <i class="fas fa-history text-4xl mb-3"></i>
                                <p>å±¥æ­´ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
                            </div>
                        </div>
                    </div>

                    <!-- ã‚¹ã‚«ã‚¦ãƒˆç®¡ç†ã‚¿ãƒ– -->
                    <div id="profile-scout_management-tab-content" class="hidden flex-1 overflow-y-auto">
                        <div class="mb-4 flex justify-between items-center">
                            <h4 class="text-lg font-semibold text-gray-900">ã‚¹ã‚«ã‚¦ãƒˆé€ä¿¡ãƒ»è¿”ä¿¡çŠ¶æ³</h4>
                            <button onclick="loadScoutManagement()"
                                class="text-sm text-indigo-600 hover:text-indigo-800">
                                <i class="fas fa-sync-alt mr-1"></i>æ›´æ–°
                            </button>
                        </div>
                        <div id="scout-management-list" class="space-y-4">
                            <div class="text-center py-12 text-gray-500">
                                <i class="fas fa-inbox text-4xl mb-3"></i>
                                <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Tab 4: Analytics -->
                    <div id="profile-analytics-tab-content" class="flex-1 overflow-y-auto hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 mt-4">
                            <!-- User Stats -->
                            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                                <h4 class="font-bold text-lg text-gray-900 mb-4 flex items-center">
                                    <i class="fas fa-user mr-2 text-indigo-600"></i>å€‹äººã®æˆç¸¾
                                </h4>
                                <div id="analytics-user-stats" class="grid grid-cols-2 gap-4">
                                    <!-- Stats injected here -->
                                    <div class="text-center p-4 bg-gray-50 rounded">èª­ã¿è¾¼ã¿ä¸­...</div>
                                </div>
                            </div>

                            <!-- Organization Stats -->
                            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                                <h4 class="font-bold text-lg text-gray-900 mb-4 flex items-center">
                                    <i class="fas fa-building mr-2 text-indigo-600"></i>çµ„ç¹”å…¨ä½“ã®æˆç¸¾
                                </h4>
                                <div id="analytics-org-stats" class="grid grid-cols-2 gap-4">
                                    <!-- Stats injected here -->
                                    <div class="text-center p-4 bg-gray-50 rounded">èª­ã¿è¾¼ã¿ä¸­...</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm mb-4">
                            <h4 class="font-bold text-lg text-gray-900 mb-4">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è©³ç´°æ¨ç§»</h4>
                            <p class="text-sm text-gray-500 mb-4">â€» é€ä¿¡æ¸ˆã¿ã‚¹ã‚«ã‚¦ãƒˆã‚’æ¯æ•°ã¨ã—ãŸå„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å†…è¨³ã§ã™ã€‚</p>
                            <div id="analytics-details-container">
                                <div class="text-center p-4 bg-gray-50 rounded">èª­ã¿è¾¼ã¿ä¸­...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å€‹åˆ¥æ±‚äººæ¨è–¦ãƒ¢ãƒ¼ãƒ€ãƒ« -->
            <div id="recommend-job-modal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
                style="z-index: 10002;">
                <div class="bg-white rounded-lg w-full max-w-2xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-900">
                            <i class="fas fa-star text-yellow-500 mr-2"></i>æ±‚äººã‚’ç´¹ä»‹
                        </h3>
                        <button onclick="closeRecommendJobModal()"
                            class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>

                    <div class="space-y-4">
                        <!-- æ±‚äººæƒ…å ± -->
                        <div class="bg-gray-50 p-4 rounded border">
                            <p class="text-sm text-gray-600 mb-1">ç´¹ä»‹ã™ã‚‹æ±‚äºº:</p>
                            <p id="recommend-job-title" class="font-bold text-gray-900"></p>
                        </div>

                        <!-- ç´¹ä»‹å…ˆ -->
                        <div class="bg-gray-50 p-4 rounded border">
                            <p class="text-sm text-gray-600 mb-1">ç´¹ä»‹å…ˆ:</p>
                            <p id="recommend-target-user" class="font-bold text-gray-900"></p>
                        </div>

                        <!-- ãŠã™ã™ã‚ç†ç”± -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-medium text-gray-700">ãŠã™ã™ã‚ç†ç”±</label>
                                <div class="flex items-center gap-2">
                                    <select id="generate-reason-type"
                                        class="text-xs border border-gray-300 rounded px-2 py-1">
                                        <option value="reason">ç´¹ä»‹ç†ç”±</option>
                                        <option value="scout">ã‚¹ã‚«ã‚¦ãƒˆæ–‡</option>
                                    </select>
                                    <button onclick="generateRecommendReason()"
                                        class="text-xs text-indigo-600 hover:text-indigo-800 flex items-center">
                                        <i class="fas fa-magic mr-1"></i>AIã§ç”Ÿæˆ
                                    </button>
                                </div>
                            </div>
                            <textarea id="recommend-reason" rows="6"
                                class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500"
                                placeholder="ã“ã®æ±‚äººã‚’ãŠã™ã™ã‚ã™ã‚‹ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
                        </div>

                        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
                        <div class="flex justify-end gap-3 pt-4 border-t">
                            <button onclick="closeRecommendJobModal()"
                                class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onclick="submitRecommendation()"
                                class="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                                <i class="fas fa-check mr-2"></i>ç´¹ä»‹ã™ã‚‹
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AIè©³ç´°åˆ†æãƒ¢ãƒ¼ãƒ€ãƒ« -->
            <div id="ai-detail-modal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
                style="z-index: 10010;">
                <div class="bg-white rounded-lg w-full max-w-2xl p-6 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-900">
                            <i class="fas fa-chart-bar text-indigo-600 mr-2"></i>AIè©³ç´°åˆ†æ
                        </h3>
                        <button onclick="closeAIDetailModal()"
                            class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    <div id="ai-detail-modal-content">
                        <!-- Content will be injected here -->
                    </div>
                    <div class="mt-6 text-right">
                        <button onclick="closeAIDetailModal()"
                            class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                            é–‰ã˜ã‚‹
                        </button>
                    </div>
                </div>
            </div>

            <!-- ä¸€æ‹¬æ¨è–¦ãƒ¢ãƒ¼ãƒ€ãƒ« -->
            <div id="bulk-recommend-modal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
                style="z-index: 10002;">
                <div class="bg-white rounded-lg w-full max-w-3xl p-6 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="bulk-recommend-modal-title" class="text-xl font-bold text-gray-900">
                            <i class="fas fa-star text-yellow-500 mr-2"></i>è¤‡æ•°æ±‚äººã‚’ä¸€æ‹¬ç´¹ä»‹
                        </h3>
                        <button onclick="closeBulkRecommendModal()"
                            class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>

                    <div class="space-y-4">
                        <!-- ç´¹ä»‹å…ˆ -->
                        <div class="bg-gray-50 p-4 rounded border">
                            <p class="text-sm text-gray-600 mb-1">ç´¹ä»‹å…ˆ:</p>
                            <p id="bulk-recommend-target-user" class="font-bold text-gray-900"></p>
                        </div>

                        <!-- é¸æŠã—ãŸæ±‚äººãƒªã‚¹ãƒˆ -->
                        <div>
                            <p class="text-sm font-medium text-gray-700 mb-2">é¸æŠã—ãŸæ±‚äºº (<span
                                    id="bulk-job-count">0</span>ä»¶)</p>
                            <div id="bulk-jobs-list"
                                class="space-y-2 max-h-60 overflow-y-auto border rounded p-3 bg-gray-50">
                                <!-- æ±‚äººãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
                            </div>
                        </div>

                        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
                        <div class="flex justify-end gap-3 pt-4 border-t">
                            <button onclick="closeBulkRecommendModal()"
                                class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onclick="submitBulkRecommendation()"
                                class="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                                <i class="fas fa-check mr-2"></i>AIãƒãƒƒãƒãƒ³ã‚°ã™ã‚‹
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ±‚è·è€…é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå€‹åˆ¥ç´¹ä»‹ç”¨ï¼‰ -->
            <div id="candidate-selection-modal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
                style="z-index: 10005;">
                <div class="bg-white rounded-lg w-full max-w-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-900">ç´¹ä»‹å…ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ</h3>
                        <button onclick="closeCandidateSelectionModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="mb-4">
                        <div class="relative">
                            <input type="text" id="modal-candidate-search" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§çµã‚Šè¾¼ã¿..."
                                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                        </div>
                    </div>
                    <div id="modal-candidate-list"
                        class="space-y-2 max-h-80 overflow-y-auto border rounded p-2 bg-gray-50">
                        <!-- ã“ã“ã«æ±‚è·è€…ãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </div>
                    <div class="mt-6 text-right">
                        <button onclick="closeCandidateSelectionModal()"
                            class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded">é–‰ã˜ã‚‹</button>
                    </div>
                </div>
            </div>



            <!-- Super Admin: Master Data Page -->
            <div id="admin-master-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-xl font-semibold mb-2">ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
                            <p class="text-gray-600">ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®é¸æŠè‚¢ï¼ˆé›‡ç”¨å½¢æ…‹ã€è·ç¨®ãªã©ï¼‰ã‚’ç®¡ç†ã—ã¾ã™</p>
                        </div>
                        <button onclick="showMasterForm()"
                            class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">
                            <i class="fas fa-plus mr-2"></i>æ–°è¦ä½œæˆ
                        </button>
                        <button onclick="updateJobCategoriesMaster()"
                            class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 ml-2">
                            <i class="fas fa-sync mr-2"></i>è·ç¨®ãƒã‚¹ã‚¿åˆæœŸåŒ–
                        </button>
                        <button onclick="updateIndustryCategoriesMaster()"
                            class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 ml-2">
                            <i class="fas fa-sync mr-2"></i>æ¥­ç¨®ãƒã‚¹ã‚¿åˆæœŸåŒ–
                        </button>
                        <button onclick="updateSelectionStatusMaster()"
                            class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 ml-2">
                            <i class="fas fa-sync mr-2"></i>é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆæœŸåŒ–
                        </button>
                        <button onclick="updatePromptMaster()"
                            class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 ml-2">
                            <i class="fas fa-sync mr-2"></i>ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆåˆæœŸåŒ–
                        </button>
                    </div>
                    <div id="master-org-filter-container" class="mb-4 hidden">
                        <select id="master-filter-org" onchange="loadMasterData()"
                            class="w-full md:w-1/3 px-3 py-2 border rounded-lg text-sm bg-gray-50">
                            <option value="">å…¨ã¦ã®çµ„ç¹”ã‚’è¡¨ç¤º</option>
                        </select>
                    </div>
                    <div class="border-b border-gray-200 mb-4">
                        <nav class="-mb-px flex space-x-8" id="master-tabs">
                            <button onclick="switchMasterTab('')"
                                class="master-tab border-indigo-500 text-indigo-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                å…¨ã¦ã®ç¨®åˆ¥
                            </button>
                            <button onclick="switchMasterTab('employment_type')"
                                class="master-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                é›‡ç”¨å½¢æ…‹
                            </button>
                            <button onclick="switchMasterTab('job_category')"
                                class="master-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                è·ç¨®ã‚«ãƒ†ã‚´ãƒª
                            </button>
                            <button onclick="switchMasterTab('industry_category')"
                                class="master-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                æ¥­ç¨®ã‚«ãƒ†ã‚´ãƒª
                            </button>
                            <button onclick="switchMasterTab('selection_status')"
                                class="master-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                            </button>
                        </nav>
                        <input type="hidden" id="master-filter-type" value="">
                    </div>
                </div>
                <div id="master-data-container"></div>
            </div>

            <!-- Admin: Job Management Page -->
            <div id="admin-jobs-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-600 mb-2">æ±‚äººã®ä½œæˆãƒ»ç·¨é›†ãƒ»å‰Šé™¤ãŒã§ãã¾ã™ã€‚</p>
                        </div>
                        <div class="flex gap-2 flex-wrap">
                            <button id="admin-job-drive-import-btn" onclick="openDriveImportModal()"
                                class="hidden bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                                <i class="fab fa-google-drive"></i> Googleãƒ‰ãƒ©ã‚¤ãƒ–å–å¾—
                                <span class="text-[10px] bg-white/20 px-1 rounded">GAS</span>
                            </button>
                            <button id="admin-job-csv-import-btn" onclick="showJobCsvImportModal()"
                                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition flex items-center gap-2">
                                <i class="fas fa-file-csv"></i> CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                            </button>
                            <button onclick="exportJobsCsv()"
                                class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                                <i class="fas fa-download mr-2"></i>CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                            </button>
                            <button onclick="showJobForm()"
                                class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition font-medium">
                                <i class="fas fa-plus mr-2"></i>æ–°è¦ä½œæˆ
                            </button>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 mb-6">
                    <input type="text" id="admin-job-search" placeholder="æ±‚äººã‚¿ã‚¤ãƒˆãƒ«ã€ä¼šç¤¾åã§æ¤œç´¢..."
                        class="w-full px-4 py-2 border rounded-lg" onkeyup="filterAdminJobs()">
                </div>
                <div id="admin-jobs-container">
                    <!-- Jobs will be rendered here -->
                </div>
            </div>

            <!-- Admin: Applicant Management Page -->
            <div id="admin-applicants-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <p class="text-gray-600 mb-2">å¿œå‹Ÿè€…ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç®¡ç†ã§ãã¾ã™ã€‚</p>
                </div>
                <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                    <div class="flex flex-col md:flex-row gap-6">
                        <!-- Keyword Search -->
                        <div class="flex-1">
                            <label class="block text-sm font-bold text-gray-700 mb-2">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢</label>
                            <input type="text" id="admin-applicant-search" placeholder="æ±‚è·è€…åã€ä¼æ¥­åã€æ±‚äººå..."
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all"
                                onkeyup="filterAdminApplicants()">
                        </div>

                        <!-- Status Filter -->
                        <div class="md:w-auto">
                            <label class="block text-sm font-bold text-gray-700 mb-2">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§çµã‚Šè¾¼ã‚€</label>
                            <div class="flex flex-wrap gap-2" id="admin-applicant-status-filters">
                                <button onclick="setAdminApplicantStatusFilter('ongoing')"
                                    class="status-filter-btn active px-4 py-2 rounded-lg text-sm font-bold border transition-all bg-indigo-600 text-white border-indigo-600"
                                    data-status="ongoing">é¸è€ƒä¸­</button>
                                <button onclick="setAdminApplicantStatusFilter('offered')"
                                    class="status-filter-btn px-4 py-2 rounded-lg text-sm font-bold border transition-all bg-white text-gray-600 border-gray-300 hover:bg-gray-50"
                                    data-status="offered">å†…å®š</button>
                                <button onclick="setAdminApplicantStatusFilter('contracted')"
                                    class="status-filter-btn px-4 py-2 rounded-lg text-sm font-bold border transition-all bg-white text-gray-600 border-gray-300 hover:bg-gray-50"
                                    data-status="contracted">å…¥ç¤¾æ±ºå®š</button>
                                <button onclick="setAdminApplicantStatusFilter('closed')"
                                    class="status-filter-btn px-4 py-2 rounded-lg text-sm font-bold border transition-all bg-white text-gray-600 border-gray-300 hover:bg-gray-50"
                                    data-status="closed">çµ‚äº†</button>
                                <button onclick="setAdminApplicantStatusFilter('all')"
                                    class="status-filter-btn px-4 py-2 rounded-lg text-sm font-bold border transition-all bg-white text-gray-600 border-gray-300 hover:bg-gray-50"
                                    data-status="all">ã™ã¹ã¦</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bulk Actions Row -->
                <div
                    class="bg-indigo-50/50 border border-indigo-100 rounded-lg p-4 mb-6 flex flex-wrap justify-between items-center gap-4">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="admin-applicant-select-all"
                            class="w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer"
                            onchange="toggleAllAdminApplicants(this.checked)">
                        <span class="text-sm font-bold text-indigo-900"
                            id="admin-applicant-selection-count">0ä»¶é¸æŠä¸­</span>
                    </div>
                    <button id="admin-bulk-status-btn" onclick="openBulkStatusUpdateModal()" disabled
                        class="bg-white text-indigo-300 border border-indigo-100 px-4 py-2 rounded-lg text-sm font-bold shadow-sm cursor-not-allowed transition-all flex items-center gap-2">
                        <i class="fas fa-edit"></i> ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä¸€æ‹¬å¤‰æ›´
                    </button>
                </div>
                <div id="admin-applicants-container">
                    <!-- Applicants will be rendered here -->
                </div>
            </div>


            <!-- Admin: Candidate Management Page -->
            <div id="admin-candidates-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6 flex justify-between items-center">
                    <div>
                        <p class="text-gray-600 mb-2">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹æ±‚è·è€…ã®æƒ…å ±ã‚’ç®¡ç†ã§ãã¾ã™ã€‚</p>
                    </div>
                    <button onclick="showUserRegistrationModal('candidate')"
                        class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                        <i class="fas fa-plus mr-2"></i>æ–°è¦ç™»éŒ²
                    </button>
                </div>
                <div class="bg-white rounded-lg shadow p-4 mb-6">
                    <input type="text" id="admin-candidate-search" placeholder="åå‰ã€ãƒ¡ãƒ¼ãƒ«ã€å¸Œæœ›è·ç¨®ã§æ¤œç´¢..."
                        class="w-full px-4 py-2 border rounded-lg" onkeyup="filterAdminCandidates()">
                </div>
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    åå‰ / ãƒ¡ãƒ¼ãƒ«</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    å¸Œæœ›æ¡ä»¶</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                <th
                                    class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="admin-candidates-container" class="bg-white divide-y divide-gray-200">
                            <!-- Candidates will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Admin: User Management Page -->
            <div id="admin-users-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6 flex justify-between items-center">
                    <div>
                        <p class="text-gray-600 mb-2">ã‚·ã‚¹ãƒ†ãƒ åˆ©ç”¨è€…ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨æ¨©é™ã‚’ç®¡ç†ã§ãã¾ã™ã€‚</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="showUserCsvImportModal()"
                            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                            <i class="fas fa-file-csv mr-2"></i>CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                        </button>
                        <button onclick="exportUsersCsv()"
                            class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                            <i class="fas fa-download mr-2"></i>CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                        </button>
                        <button onclick="showUserRegistrationModal('admin')"
                            class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                            <i class="fas fa-plus mr-2"></i>æ–°è¦ç™»éŒ²
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 mb-6">
                    <input type="text" id="admin-user-search" placeholder="åå‰ã€ãƒ¡ãƒ¼ãƒ«ã§æ¤œç´¢..."
                        class="w-full px-4 py-2 border rounded-lg" onkeyup="filterAdminUsers()">
                </div>
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    åå‰ / ãƒ¡ãƒ¼ãƒ«</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ãƒ­ãƒ¼ãƒ«</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ç™»éŒ²æ—¥</th>
                                <th
                                    class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="admin-users-container" class="bg-white divide-y divide-gray-200">
                            <!-- Users will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Admin: CSV Import Page -->
            <div id="admin-csv-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <!-- Title removed -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- æ±‚äººã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
                        <div class="border rounded-lg p-6">
                            <h3 class="font-semibold mb-3 flex items-center">
                                <i class="fas fa-briefcase mr-2 text-indigo-600"></i>æ±‚äººãƒ‡ãƒ¼ã‚¿
                            </h3>
                            <input type="file" id="csv-jobs-file" accept=".csv" class="mb-3 w-full">
                            <button onclick="importJobsCSV()"
                                class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 w-full">
                                <i class="fas fa-upload mr-2"></i>ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                            </button>
                            <p class="text-xs text-gray-500 mt-2">
                                å½¢å¼: title, company, location, employment_type, salary_min, salary_max,
                                description
                            </p>
                        </div>

                        <!-- æ±‚è·è€…ã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
                        <div class="border rounded-lg p-6">
                            <h3 class="font-semibold mb-3 flex items-center">
                                <i class="fas fa-user-tie mr-2 text-green-600"></i>æ±‚è·è€…ãƒ‡ãƒ¼ã‚¿
                            </h3>
                            <p class="text-sm text-gray-600 mb-4">
                                æ±‚è·è€…æƒ…å ±ã‚’CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¸€æ‹¬ç™»éŒ²ã§ãã¾ã™ã€‚
                            </p>
                            <button onclick="openUserCsvImportModal()"
                                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 w-full">
                                <i class="fas fa-file-csv mr-2"></i>æ±‚è·è€…CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                            </button>
                            <p class="text-xs text-gray-500 mt-2">
                                â€» ãƒ­ãƒ¼ãƒ«ã¯è‡ªå‹•çš„ã«ã€Œæ±‚è·è€…ã€ã«è¨­å®šã•ã‚Œã¾ã™
                            </p>
                        </div>
                    </div>
                </div>

                <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆå±¥æ­´ -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="font-semibold mb-4">ã‚¤ãƒ³ãƒãƒ¼ãƒˆå±¥æ­´</h3>
                    <div id="csv-history-container"></div>
                </div>
            </div>

            <!-- Admin: Audit Logs Page -->
            <div id="admin-logs-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <!-- Title removed -->
                    <div class="flex gap-4 mb-4">
                        <select id="log-filter-action" class="px-4 py-2 border rounded-lg">
                            <option value="">å…¨ã¦ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</option>
                            <option value="create">ä½œæˆ</option>
                            <option value="update">æ›´æ–°</option>
                            <option value="delete">å‰Šé™¤</option>
                            <option value="login">ãƒ­ã‚°ã‚¤ãƒ³</option>
                            <option value="csv_upload">CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</option>
                        </select>
                        <button onclick="loadAuditLogs()"
                            class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">
                            <i class="fas fa-search mr-2"></i>æ¤œç´¢
                        </button>
                    </div>
                </div>
                <div id="audit-logs-container"></div>
            </div>

            <!-- Admin: Data Management Page -->
            <div id="admin-data-management-content" class="app-content p-6 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4">é‡è¤‡ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
                    <p class="text-gray-600 mb-6">
                        é‡è¤‡ã—ã¦ã„ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹ä¼æ¥­ã‚„æ±‚äººã‚’æ¤œå‡ºã—ã€æƒ…å ±ã‚’çµ±åˆï¼ˆãƒãƒ¼ã‚¸ï¼‰ã—ã¾ã™ã€‚
                    </p>

                    <div class="border-b border-gray-200 mb-6">
                        <nav class="-mb-px flex space-x-8">
                            <button onclick="switchDataManagementTab('companies')" id="data-mgmt-tab-companies"
                                class="data-mgmt-tab border-indigo-500 text-indigo-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                <i class="fas fa-building mr-2"></i>ä¼æ¥­ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
                            </button>
                            <button onclick="switchDataManagementTab('jobs')" id="data-mgmt-tab-jobs"
                                class="data-mgmt-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                <i class="fas fa-briefcase mr-2"></i>æ±‚äººã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
                            </button>
                        </nav>
                    </div>

                    <!-- Settings Section -->
                    <div id="data-mgmt-settings-container" class="bg-gray-50 p-6 rounded-lg mb-8">
                        <h3 class="font-bold text-gray-800 mb-4 flex justify-between items-center">
                            <span>ãƒã‚§ãƒƒã‚¯é …ç›®ã®è¨­å®š</span>
                            <button onclick="saveDataCleanupSettings()"
                                class="bg-white border border-indigo-600 text-indigo-600 px-4 py-1.5 rounded-lg text-sm font-medium hover:bg-indigo-50 transition">
                                <i class="fas fa-save mr-2"></i>è¨­å®šã‚’ä¿å­˜
                            </button>
                        </h3>

                        <div id="data-mgmt-criteria-companies" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <label
                                class="flex items-center space-x-2 cursor-pointer p-3 bg-white rounded border border-gray-200 hover:border-indigo-300">
                                <input type="checkbox" id="criteria-company-name" checked>
                                <span class="text-sm">ä¼šç¤¾åã®ä¸€è‡´</span>
                            </label>
                            <label
                                class="flex items-center space-x-2 cursor-pointer p-3 bg-white rounded border border-gray-200 hover:border-indigo-300">
                                <input type="checkbox" id="criteria-company-phone">
                                <span class="text-sm">é›»è©±ç•ªå·ã®ä¸€è‡´</span>
                            </label>
                            <label
                                class="flex items-center space-x-2 cursor-pointer p-3 bg-white rounded border border-gray-200 hover:border-indigo-300">
                                <input type="checkbox" id="criteria-company-domain">
                                <span class="text-sm">ãƒ‰ãƒ¡ã‚¤ãƒ³/URLã®ä¸€è‡´</span>
                            </label>
                            <label
                                class="flex items-center space-x-2 cursor-pointer p-3 bg-white rounded border border-gray-200 hover:border-indigo-300">
                                <input type="checkbox" id="criteria-company-address">
                                <span class="text-sm">ä½æ‰€ï¼ˆå¸‚åŒºç”ºæ‘ã¾ã§ï¼‰ã®ä¸€è‡´</span>
                            </label>
                        </div>

                        <div id="data-mgmt-criteria-jobs" class="hidden grid grid-cols-1 md:grid-cols-3 gap-4">
                            <label
                                class="flex items-center space-x-2 cursor-pointer p-3 bg-white rounded border border-gray-200 hover:border-indigo-300">
                                <input type="checkbox" id="criteria-job-title" checked>
                                <span class="text-sm">æ±‚äººã‚¿ã‚¤ãƒˆãƒ«ã®ä¸€è‡´</span>
                            </label>
                            <label
                                class="flex items-center space-x-2 cursor-pointer p-3 bg-white rounded border border-gray-200 hover:border-indigo-300">
                                <input type="checkbox" id="criteria-job-company" checked>
                                <span class="text-sm">åŒä¸€ä¼æ¥­ã®æ±‚äºº</span>
                            </label>
                            <label
                                class="flex items-center space-x-2 cursor-pointer p-3 bg-white rounded border border-gray-200 hover:border-indigo-300">
                                <input type="checkbox" id="criteria-job-location">
                                <span class="text-sm">å‹¤å‹™åœ°ã®ä¸€è‡´</span>
                            </label>
                        </div>

                        <div class="mt-6 pt-4 border-t border-gray-200 text-right">
                            <button onclick="detectDuplicates()"
                                class="bg-indigo-600 text-white px-8 py-2.5 rounded-lg font-bold hover:bg-indigo-700 transition shadow-md">
                                <i class="fas fa-search mr-2"></i>é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚’é–‹å§‹
                            </button>
                        </div>
                    </div>

                    <!-- Results Section -->
                    <div id="data-mgmt-results">
                        <div class="text-center py-12 text-gray-500 border-2 border-dashed border-gray-200 rounded-lg">
                            <i class="fas fa-broom text-4xl mb-4"></i>
                            <p>è¨­å®šã‚’ç¢ºèªã—ã¦ã€ã€Œé‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚’é–‹å§‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin: Yomi Management (Progress & Forecasting) Page -->
            <div id="admin-yomi-management-content" class="app-content p-6 hidden">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">ãƒ¨ãƒŸç®¡ç†ãƒ»é€²æ—ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°</h2>
                        <p class="text-gray-500 text-sm">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ±‚è·è€…ã®é€²æ—ã¨å£²ä¸Šäºˆæ¸¬ã‚’ä¸€æ‹¬ç®¡ç†ã—ã¾ã™ã€‚</p>
                    </div>
                    <div class="flex items-center bg-gray-100 p-1 rounded-lg">
                        <button onclick="switchYomiView('board')" id="yomi-view-board-btn"
                            class="yomi-view-btn px-4 py-2 text-sm font-bold rounded-md transition-all bg-white shadow-sm text-indigo-600">
                            <i class="fas fa-columns mr-2"></i>ã‚«ãƒ³ãƒãƒ³
                        </button>
                        <button onclick="switchYomiView('list')" id="yomi-view-list-btn"
                            class="yomi-view-btn px-4 py-2 text-sm font-bold rounded-md transition-all text-gray-600 hover:text-gray-900">
                            <i class="fas fa-list mr-2"></i>ãƒªã‚¹ãƒˆ
                        </button>
                        <button onclick="switchYomiView('forecast')" id="yomi-view-forecast-btn"
                            class="yomi-view-btn px-4 py-2 text-sm font-bold rounded-md transition-all text-gray-600 hover:text-gray-900">
                            <i class="fas fa-chart-line mr-2"></i>å…¥é‡‘äºˆæ¸¬
                        </button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm mb-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                        <div class="lg:col-span-1">
                            <label
                                class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">çµ„ç¹”ãƒ»ãƒãƒ¼ãƒ </label>
                            <select id="yomi-filter-team"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="">å…¨ã¦ã®ãƒãƒ¼ãƒ </option>
                            </select>
                        </div>
                        <div class="lg:col-span-1">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">æ‹…å½“è€…
                                (CA/RA)</label>
                            <select id="yomi-filter-coach"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="">å…¨å“¡</option>
                            </select>
                        </div>
                        <div class="lg:col-span-1">
                            <label
                                class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">æœŸé–“</label>
                            <select id="yomi-filter-period"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="this_month">ä»Šæœˆ</option>
                                <option value="next_month">æ¥æœˆ</option>
                                <option value="this_quarter" selected>ä»Šå››åŠæœŸ</option>
                                <option value="all">å…¨æœŸé–“</option>
                            </select>
                        </div>
                        <div class="lg:col-span-1">
                            <label
                                class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">ãƒ¨ãƒŸå®šç¾©</label>
                            <select id="yomi-filter-probability"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="">å…¨ã¦ã®ãƒ¨ãƒŸ</option>
                                <option value="80">Aãƒ¨ãƒŸ (80%â†‘)</option>
                                <option value="60">Bãƒ¨ãƒŸ (60%â†‘)</option>
                                <option value="40">Cãƒ¨ãƒŸ (40%â†‘)</option>
                            </select>
                        </div>
                        <div class="lg:col-span-1 flex gap-2">
                            <button onclick="loadYomiData()"
                                class="flex-1 bg-indigo-600 text-white rounded-lg px-4 py-2 font-bold hover:bg-indigo-700 transition shadow-sm">
                                <i class="fas fa-search mr-2"></i>é©ç”¨
                            </button>
                            <button onclick="exportYomiData()"
                                class="bg-gray-100 text-gray-600 rounded-lg px-3 py-2 hover:bg-gray-200 transition"
                                title="ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Stats Summary Row -->
                <div id="yomi-stats-summary" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                        <p class="text-[10px] font-bold text-gray-400 uppercase">å£²ä¸Šè¦‹è¾¼ã¿åˆè¨ˆ</p>
                        <p class="text-xl font-bold text-gray-800" id="yomi-stat-total-revenue">Â¥0</p>
                    </div>
                    <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 shadow-sm">
                        <p class="text-[10px] font-bold text-indigo-400 uppercase">ãƒ¨ãƒŸæ›ç®—åˆè¨ˆ (åˆ©ç›Šäºˆæ¸¬)</p>
                        <p class="text-xl font-bold text-indigo-600" id="yomi-stat-weighted-revenue">Â¥0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                        <p class="text-[10px] font-bold text-gray-400 uppercase">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ä»¶æ•°</p>
                        <p class="text-xl font-bold text-gray-800" id="yomi-stat-active-count">0ä»¶</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                        <p class="text-[10px] font-bold text-gray-400 uppercase">æˆç´„ç¢ºåº¦ (AVG)</p>
                        <p class="text-xl font-bold text-gray-800" id="yomi-stat-avg-probability">0%</p>
                    </div>
                </div>

                <!-- Board View (Kanban) -->
                <div id="yomi-board-view" class="yomi-view-content hidden">
                    <div id="yomi-kanban-container"
                        class="flex gap-4 overflow-x-auto pb-4 custom-scrollbar min-h-[600px]">
                        <!-- Columns will be rendered here -->
                    </div>
                </div>

                <!-- List View (Table) -->
                <div id="yomi-list-view" class="yomi-view-content hidden">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                        å€™è£œè€… / æ‹…å½“è€…</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                        æ±‚äºº / ä¼æ¥­</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                        ãƒ•ã‚§ãƒ¼ã‚º</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                        è¦‹è¾¼ã¿é‡‘é¡</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                        æ±ºå®šãƒ¨ãƒŸ</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                                        å…¥ç¤¾äºˆå®šæ—¥</th>
                                    <th
                                        class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">
                                        æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="yomi-list-container" class="bg-white divide-y divide-gray-200">
                                <!-- List items populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Forecast View (Report) -->
                <div id="yomi-forecast-view" class="yomi-view-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm h-full">
                                <h3 class="font-bold text-gray-800 mb-6 flex items-center">
                                    <i class="fas fa-chart-area mr-2 text-indigo-500"></i>æœˆåˆ¥å…¥é‡‘äºˆæ¸¬æ¨ç§»
                                </h3>
                                <div class="h-64">
                                    <canvas id="yomi-forecast-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="lg:col-span-1">
                            <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm h-full">
                                <h3 class="font-bold text-gray-800 mb-6 flex items-center">
                                    <i class="fas fa-percentage mr-2 text-purple-500"></i>ãƒ¨ãƒŸåˆ¥å†…è¨³
                                </h3>
                                <div class="h-64">
                                    <canvas id="yomi-distribution-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </div>
    </div>

    <!-- KPI Dashboard Content -->
    <div id="kpi-dashboard-content" class="app-content p-6 hidden">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 md:px-8 py-6">
            <h1 class="text-2xl font-semibold text-gray-900">KPIãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <p class="text-gray-500 text-sm mb-6">çµ„ç¹”å…¨ä½“ã®é€²æ—çŠ¶æ³ã€æ­©ç•™ã¾ã‚Šã€å£²ä¸Šäºˆæ¸¬ã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚</p>

            <!-- Filter Bar -->
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-6 flex flex-wrap gap-4 items-end">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">æœŸé–“</label>
                    <select id="kpi-filter-period" class="border border-gray-300 rounded px-3 py-1.5 text-sm">
                        <option value="this_month">ä»Šæœˆ</option>
                        <option value="last_month">å…ˆæœˆ</option>
                        <option value="this_quarter" selected>ä»Šå››åŠæœŸ</option>
                        <option value="this_year">ä»Šå¹´åº¦</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">æ‹…å½“è€…</label>
                    <select id="kpi-filter-user" class="border border-gray-300 rounded px-3 py-1.5 text-sm w-40">
                        <option value="">å…¨å“¡</option>
                    </select>
                </div>
                <div>
                    <button onclick="loadKPIDashboard()"
                        class="bg-indigo-600 text-white px-4 py-1.5 rounded text-sm font-bold hover:bg-indigo-700">
                        <i class="fas fa-sync-alt mr-1"></i>æ›´æ–°
                    </button>
                </div>
            </div>

            <!-- KPI Cards (Feature B & D) -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-sm p-5 border border-gray-200">
                    <p class="text-xs font-bold text-gray-400 uppercase">å£²ä¸Šäºˆæ¸¬ (ãƒ¨ãƒŸ)</p>
                    <h3 class="text-2xl font-bold text-gray-800 mt-1" id="kpi-metric-revenue">Â¥0
                    </h3>
                    <p class="text-xs text-green-600 mt-1"><i class="fas fa-arrow-up mr-1"></i>å‰æœˆæ¯”
                        --%</p>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-5 border border-gray-200">
                    <p class="text-xs font-bold text-gray-400 uppercase">æœ‰åŠ¹æ±‚äººæ•°</p>
                    <h3 class="text-2xl font-bold text-gray-800 mt-1" id="kpi-metric-jobs">0</h3>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-5 border border-gray-200">
                    <p class="text-xs font-bold text-gray-400 uppercase">é¸è€ƒä¸­å€™è£œè€…</p>
                    <h3 class="text-2xl font-bold text-gray-800 mt-1" id="kpi-metric-candidates">0
                    </h3>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-5 border border-gray-200">
                    <p class="text-xs font-bold text-gray-400 uppercase">æˆç´„æ•°</p>
                    <h3 class="text-2xl font-bold text-gray-800 mt-1" id="kpi-metric-success">0</h3>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Feature A: Funnel Analysis -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h4 class="font-bold text-gray-800 mb-4">é¸è€ƒæ­©ç•™ã¾ã‚Š (ãƒ•ã‚¡ãƒãƒ«)</h4>
                    <div class="relative h-64">
                        <canvas id="kpi-funnel-chart"></canvas>
                    </div>
                </div>

                <!-- Feature D: Activity Analysis -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h4 class="font-bold text-gray-800 mb-4">æ‹…å½“è€…åˆ¥ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£</h4>
                    <div class="relative h-64">
                        <canvas id="kpi-activity-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Feature C: Stagnant Cases -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                    <h4 class="font-bold text-gray-800"><i
                            class="fas fa-exclamation-circle text-amber-500 mr-2"></i>åœæ»æ¡ˆä»¶ã‚¢ãƒ©ãƒ¼ãƒˆ
                        (5æ—¥ä»¥ä¸Šå¤‰å‹•ãªã—)</h4>
                    <span class="bg-amber-100 text-amber-800 text-xs font-bold px-2 py-1 rounded-full"
                        id="stagnant-cases-count">0ä»¶</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    å€™è£œè€…</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    æ±‚äºº</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚º</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    æœ€çµ‚æ›´æ–°æ—¥</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    æ‹…å½“è€…</th>
                                <th
                                    class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="kpi-stagnant-table-body">
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
                                    ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin: Organization Settings Page -->
    <div id="admin-settings-content" class="app-content p-6 hidden">
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h3 class="text-xl font-bold mb-4">AIã‚¹ã‚«ã‚¦ãƒˆè¨­å®š</h3>
            <p class="text-gray-600 mb-6">AIã‚¹ã‚«ã‚¦ãƒˆæ©Ÿèƒ½ã®å‹•ä½œã«é–¢ã™ã‚‹è¨­å®šã‚’ç®¡ç†ã—ã¾ã™ã€‚</p>

            <div class="space-y-6">
                <!-- è§£æå±¥æ­´ã®å…¬é–‹ç¯„å›²è¨­å®š -->
                <div class="border-b border-gray-200 pb-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">å¤–éƒ¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è§£æå±¥æ­´ã®å…¬é–‹ç¯„å›²</h4>
                    <p class="text-sm text-gray-500 mb-4">
                        ã€Œå¤–éƒ¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è§£æã€ã§ä½œæˆã•ã‚ŒãŸå±¥æ­´ã‚’ã€çµ„ç¹”å†…ã®ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé–²è¦§ã§ãã‚‹ã‹ã©ã†ã‹ã‚’åˆ¶å¾¡ã—ã¾ã™ã€‚
                    </p>

                    <div class="bg-gray-50 p-4 rounded-lg">
                        <label class="flex items-start mb-3 cursor-pointer">
                            <input type="radio" name="setting-history-visibility" value="all"
                                class="mt-1 mr-3 h-4 w-4 text-indigo-600">
                            <div>
                                <div class="font-bold text-gray-900">å…¨å“¡ã«å…¬é–‹ (æ¨™æº–)</div>
                                <div class="text-sm text-gray-600">
                                    çµ„ç¹”å†…ã®ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã—ãŸè§£æå±¥æ­´ãƒ»æ±‚äººææ¡ˆå†…å®¹ã‚’é–²è¦§ã§ãã¾ã™ã€‚å…±æœ‰çŸ¥ã¨ã—ã¦ã®æ´»ç”¨ã«é©ã—ã¦ã„ã¾ã™ã€‚
                                </div>
                            </div>
                        </label>

                        <label class="flex items-start cursor-pointer">
                            <input type="radio" name="setting-history-visibility" value="personal"
                                class="mt-1 mr-3 h-4 w-4 text-indigo-600">
                            <div>
                                <div class="font-bold text-gray-900">ä½œæˆè€…ã®ã¿é–²è¦§ (ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ)</div>
                                <div class="text-sm text-gray-600">
                                    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ãŒå®Ÿè¡Œã—ãŸè§£æå±¥æ­´ã®ã¿é–²è¦§ã§ãã¾ã™ã€‚ãŸã ã—ã€çµ„ç¹”å…¨ä½“ã®é›†è¨ˆæ•°å€¤ãªã©ã¯è¡¨ç¤ºã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- ã‚¹ã‚«ã‚¦ãƒˆå±¥æ­´ã®å…¬é–‹ç¯„å›²è¨­å®š -->
                <div class="border-b border-gray-200 pb-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">ã‚¹ã‚«ã‚¦ãƒˆå±¥æ­´ã®å…¬é–‹ç¯„å›²</h4>
                    <p class="text-sm text-gray-500 mb-4">
                        ã€Œã‚¹ã‚«ã‚¦ãƒˆç®¡ç†ã€ã§è¡¨ç¤ºã•ã‚Œã‚‹å€™è£œè€…ãŠã‚ˆã³é€ä¿¡å±¥æ­´ã‚’ã€çµ„ç¹”å†…ã®ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé–²è¦§ã§ãã‚‹ã‹ã©ã†ã‹ã‚’åˆ¶å¾¡ã—ã¾ã™ã€‚
                    </p>

                    <div class="bg-gray-50 p-4 rounded-lg">
                        <label class="flex items-start mb-3 cursor-pointer">
                            <input type="radio" name="setting-scout-visibility" value="all"
                                class="mt-1 mr-3 h-4 w-4 text-indigo-600">
                            <div>
                                <div class="font-bold text-gray-900">å…¨å“¡ã«å…¬é–‹ (æ¨™æº–)</div>
                                <div class="text-sm text-gray-600">
                                    çµ„ç¹”å†…ã®ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé€ä¿¡ã—ãŸã‚¹ã‚«ã‚¦ãƒˆå±¥æ­´ãƒ»å€™è£œè€…ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é–²è¦§ã§ãã¾ã™ã€‚é‡è¤‡ã‚¹ã‚«ã‚¦ãƒˆã®é˜²æ­¢ã«é©ã—ã¦ã„ã¾ã™ã€‚
                                </div>
                            </div>
                        </label>

                        <label class="flex items-start cursor-pointer">
                            <input type="radio" name="setting-scout-visibility" value="personal"
                                class="mt-1 mr-3 h-4 w-4 text-indigo-600">
                            <div>
                                <div class="font-bold text-gray-900">ä½œæˆè€…ã®ã¿é–²è¦§ (ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ)</div>
                                <div class="text-sm text-gray-600">
                                    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ãŒã‚¹ã‚«ã‚¦ãƒˆã‚’é€ã£ãŸå€™è£œè€…ãŠã‚ˆã³ãã®å±¥æ­´ã®ã¿é–²è¦§ã§ãã¾ã™ã€‚</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
                <div class="flex justify-end pt-4">
                    <button onclick="saveAdminSettings()"
                        class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition shadow-sm">
                        <i class="fas fa-save mr-2"></i>è¨­å®šã‚’ä¿å­˜
                    </button>
                </div>
            </div>
        </div>

        <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç† Page -->
        <div id="admin-templates-content" class="app-content p-6 hidden">
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-xl font-bold">æ¨è–¦ãƒ¡ãƒ¼ãƒ«ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h2>
                        <p class="text-gray-600 mt-1">å€™è£œè€…ã¸é€ã‚‹æ¨è–¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å®šå‹æ–‡ã‚’ç®¡ç†ã—ã¾ã™ã€‚</p>
                    </div>
                    <button onclick="openEmailTemplateModal()"
                        class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition flex items-center gap-2">
                        <i class="fas fa-plus"></i> æ–°è¦ä½œæˆ
                    </button>
                </div>

                <div id="email-templates-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Templates will be rendered here -->
                    <div class="animate-pulse bg-gray-100 h-32 rounded-lg"></div>
                </div>
            </div>

            <!-- ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
            <div id="email-template-modal"
                class="fixed inset-0 bg-black bg-opacity-50 z-[110] hidden flex items-center justify-center p-4">
                <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="p-6 border-b bg-indigo-50 flex justify-between items-center">
                        <h3 class="text-xl font-bold text-indigo-900" id="template-modal-title">
                            ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç·¨é›†</h3>
                        <button onclick="closeEmailTemplateModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-6 space-y-4">
                        <input type="hidden" id="template-id">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå</label>
                            <input type="text" id="template-name"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"
                                placeholder="ä¾‹: æ¨™æº–æ¨è–¦ãƒ¡ãƒ¼ãƒ«, LinkedInç”¨ãªã©">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">ãƒ¡ãƒ¼ãƒ«ä»¶å
                                (ä»»æ„)</label>
                            <input type="text" id="template-subject"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"
                                placeholder="å€™è£œè€…ã¸é€ä¿¡ã™ã‚‹éš›ã®æ¨™æº–ä»¶å">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">æœ¬æ–‡ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</label>
                            <div class="bg-blue-50 p-3 rounded text-xs text-blue-700 mb-2 leading-relaxed">
                                <i class="fas fa-info-circle mr-1"></i>ä»¥ä¸‹ã®å¤‰æ•°ã‚’ä½¿ç”¨ã§ãã¾ã™ï¼š<br>
                                <code>{{userName}}</code>ï¼šå€™è£œè€…åã€
                                <code>{{agentName}}</code>ï¼šæ‹…å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåã€
                                <code>{{jobDetails}}</code>ï¼šæ±‚äººæƒ…å ±ã®è©³ç´°ãƒªã‚¹ãƒˆï¼ˆãŠã™ã™ã‚ç†ç”±å«ã‚€ï¼‰ã€
                                <code>{{recommendationReason}}</code>ï¼š1ä»¶ç›®ã®ãŠã™ã™ã‚ç†ç”±
                            </div>
                            <textarea id="template-body" rows="12"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm font-mono focus:ring-2 focus:ring-indigo-500"></textarea>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="template-is-default" class="w-4 h-4 text-indigo-600 rounded">
                            <label for="template-is-default" class="ml-2 text-sm text-gray-700">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®šã™ã‚‹</label>
                        </div>
                    </div>
                    <div class="p-6 border-t bg-gray-50 flex justify-end gap-3">
                        <button onclick="closeEmailTemplateModal()"
                            class="px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition font-medium">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                        <button onclick="saveEmailTemplate()"
                            class="px-8 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold shadow-lg transition">
                            ä¿å­˜ã™ã‚‹
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Super Admin: Prompt Settings Page -->
        <!-- Super Admin: Organization Management Page -->
        <div id="super-admin-organizations-content" class="app-content p-6 hidden">
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-gray-600 mb-2">åˆ©ç”¨çµ„ç¹”ï¼ˆãƒ†ãƒŠãƒ³ãƒˆï¼‰ã®å¥‘ç´„ãƒ—ãƒ©ãƒ³ã‚„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç®¡ç†ã—ã¾ã™ã€‚</p>
                    </div>
                    <button onclick="showOrganizationModal()"
                        class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">
                        <i class="fas fa-plus mr-2"></i>æ–°è¦çµ„ç¹”ä½œæˆ
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                çµ„ç¹”å
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ãƒ—ãƒ©ãƒ³
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                æœ‰åŠ¹æœŸé™
                            </th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                æ“ä½œ
                            </th>
                        </tr>
                    </thead>
                    <tbody id="super-admin-organizations-container" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
                                ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Admin: User Edit Modal -->
        <div id="admin-user-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
            style="z-index: 30000;">
            <div class="bg-white rounded-lg w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold" id="admin-user-modal-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†</h3>
                    <button onclick="closeAdminUserModal()"
                        class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <form id="admin-user-form">
                    <!-- PDF Parsing Area -->
                    <div class="mb-6 p-4 bg-indigo-50 border border-dashed border-indigo-300 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="text-sm font-bold text-indigo-900 mb-1">
                                    <i class="fas fa-file-pdf mr-2"></i>å±¥æ­´æ›¸/è·å‹™çµŒæ­´æ›¸ã‹ã‚‰è‡ªå‹•å…¥åŠ›
                                </h4>
                                <p class="text-xs text-indigo-700">
                                    PDFã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€AIãŒæ°åãƒ»ã‚¹ã‚­ãƒ«ãƒ»çµŒæ­´ãªã©ã‚’è§£æã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›ã—ã¾ã™ã€‚
                                </p>
                            </div>
                            <div>
                                <label for="admin-user-pdf-upload"
                                    class="cursor-pointer bg-white text-indigo-600 border border-indigo-600 px-3 py-1.5 rounded text-sm font-medium hover:bg-indigo-50 transition shadow-sm">
                                    <i class="fas fa-upload mr-1"></i>PDFã‚’é¸æŠ
                                </label>
                                <input type="file" id="admin-user-pdf-upload" accept="application/pdf" class="hidden"
                                    onchange="handleAdminUserPdfUpload(this)">
                            </div>
                        </div>
                    </div>

                    <input type="hidden" id="admin-user-id">

                    <!-- åŸºæœ¬æƒ…å ± -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">åå‰ *</label>
                        <input type="text" id="admin-user-name" required class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ãµã‚ŠãŒãª</label>
                        <input type="text" id="admin-user-furigana" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
                            *</label>
                        <input type="email" id="admin-user-email" required class="w-full px-4 py-2 border rounded-lg">
                    </div>

                    <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ï¼ˆæ–°è¦è¿½åŠ ï¼‰ -->
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´</label>
                        <div class="flex gap-2">
                            <input type="password" id="admin-user-new-password" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
                                class="flex-1 px-4 py-2 border rounded-lg text-sm">
                            <button type="button" onclick="updateUserPassword()"
                                class="bg-gray-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-gray-700 transition shadow-sm whitespace-nowrap">
                                ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°
                            </button>
                        </div>
                        <p class="text-[10px] text-gray-500 mt-1">â€»
                            ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä¸Šæ›¸ãã—ã¾ã™ã€‚ç©ºã®ã¾ã¾ã€Œæ›´æ–°ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚å¤‰æ›´ã•ã‚Œã¾ã›ã‚“ã€‚</p>
                    </div>

                    <!-- æ¨©é™ï¼ˆç®¡ç†è€…ã®ã¿å¤‰æ›´å¯ï¼‰ -->
                    <div id="admin-user-role-container">
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ¨©é™</label>
                        <select id="admin-user-role" class="w-full px-4 py-2 border rounded-lg">
                            <option value="org_admin">çµ„ç¹”ç®¡ç†è€…</option>
                            <option value="admin">ç®¡ç†è€…</option>
                            <option value="coach">CAãƒ»RA</option>
                            <option value="candidate">æ±‚è·è€…</option>
                        </select>
                    </div>

                    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">åˆ©ç”¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                            <select id="admin-user-status" class="w-full px-4 py-2 border rounded-lg">
                                <option value="active">åˆ©ç”¨ä¸­</option>
                                <option value="suspended">åœæ­¢</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç®¡ç†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                            <select id="admin-user-management-status" class="w-full px-4 py-2 border rounded-lg">
                                <option value="active">æ´»å‹•ä¸­</option>
                                <option value="inactive">æ´»å‹•çµ‚äº†</option>
                            </select>
                        </div>
                    </div>

                    <!-- æ±‚è·è€…ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                    <div id="admin-candidate-fields" class="hidden space-y-4 border-t pt-4 mt-4">
                        <h4 class="font-medium text-gray-900">æ±‚è·è€…æƒ…å ±</h4>

                        <!-- æ‹…å½“ã‚³ãƒ¼ãƒï¼ˆç®¡ç†è€…ã®ã¿å¤‰æ›´å¯ï¼‰ -->
                        <div id="admin-user-coach-container">
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ‹…å½“CAãƒ»RA</label>
                            <select id="admin-user-coach" class="w-full px-4 py-2 border rounded-lg">
                                <option value="">æœªè¨­å®š</option>
                                <!-- ã‚³ãƒ¼ãƒä¸€è¦§ã‚’JSã§æŒ¿å…¥ -->
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ‰€å±ãƒãƒ¼ãƒ </label>
                            <select id="admin-user-team" class="w-full px-4 py-2 border rounded-lg">
                                <option value="">æœªè¨­å®š</option>
                                <!-- ãƒãƒ¼ãƒ ä¸€è¦§ã‚’JSã§æŒ¿å…¥ -->
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å¸Œæœ›è·ç¨®</label>
                            <select id="admin-user-job-type" class="w-full px-4 py-2 border rounded-lg select2" multiple
                                style="width: 100%">
                                <!-- Options will be loaded dynamically -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å¸Œæœ›æ¥­ç•Œ</label>
                            <select id="admin-user-industry" class="w-full px-4 py-2 border rounded-lg select2" multiple
                                style="width: 100%">
                                <!-- Options will be loaded dynamically -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å¸Œæœ›å‹¤å‹™åœ°</label>
                            <div class="flex gap-2">
                                <select id="admin-user-prefecture" class="w-1/3 px-2 py-2 border rounded-lg select2"
                                    multiple="multiple" style="width: 40%">
                                </select>
                                <input type="text" id="admin-user-city" placeholder="å¸‚åŒºç”ºæ‘"
                                    class="w-2/3 px-4 py-2 border rounded-lg" style="width: 60%">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å¸Œæœ›é›‡ç”¨å½¢æ…‹</label>
                            <select id="admin-user-employment-type" class="w-full px-4 py-2 border rounded-lg select2"
                                multiple style="width: 100%">
                                <!-- Options will be loaded dynamically -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å¸Œæœ›å¹´å
                                (ä¸‡å††)</label>
                            <input type="number" id="admin-user-salary" class="w-full px-4 py-2 border rounded-lg"
                                min="0">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ç”Ÿå¹´æœˆæ—¥</label>
                                <input type="date" id="admin-user-birth-date"
                                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 transition-all"
                                    onchange="calculateAge(this.value, '#admin-user-age')">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">å¹´é½¢</label>
                                <input type="number" id="admin-user-age"
                                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 transition-all font-mono"
                                    min="0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">æ€§åˆ¥</label>
                                <select id="admin-user-gender" class="w-full px-4 py-2 border rounded-lg">
                                    <option value="">é¸æŠ</option>
                                    <option value="ç”·æ€§">ç”·æ€§</option>
                                    <option value="å¥³æ€§">å¥³æ€§</option>
                                    <option value="ãã®ä»–">ãã®ä»–</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç¾ä½æ‰€ï¼ˆå±…ä½åœ°ï¼‰</label>
                            <select id="admin-user-current-location" class="w-full px-4 py-2 border rounded-lg">
                                <option value="">éƒ½é“åºœçœŒã‚’é¸æŠ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å­¦æ­´</label>
                            <textarea id="admin-user-education" rows="2" class="w-full px-4 py-2 border rounded-lg"
                                placeholder="ä¾‹: ã€‡ã€‡å¤§å­¦ ã€‡ã€‡å­¦éƒ¨ å’æ¥­"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ã‚¹ã‚­ãƒ«</label>
                            <textarea id="admin-user-skills" rows="3"
                                class="w-full px-4 py-2 border rounded-lg"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">è·æ­´æ¦‚è¦</label>
                            <textarea id="admin-user-history" rows="3"
                                class="w-full px-4 py-2 border rounded-lg"></textarea>
                        </div>

                        <!-- è¿½åŠ è©³ç´°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">é›»è©±ç•ªå·</label>
                            <input type="tel" id="admin-user-phone" class="w-full px-4 py-2 border rounded-lg">
                        </div>

                        <div class="flex gap-6 py-2">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="admin-user-job-exp-ok"
                                    class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 mr-2">
                                <span class="text-sm text-gray-700">è·ç¨®æœªçµŒé¨“OK</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="admin-user-industry-exp-ok"
                                    class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 mr-2">
                                <span class="text-sm text-gray-700">æ¥­ç•ŒæœªçµŒé¨“OK</span>
                            </label>
                        </div>

                        <!-- æ§‹é€ åŒ–ã•ã‚ŒãŸè·æ­´ (New) -->
                        <div class="mb-6 border-t border-gray-200 pt-4">
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-medium text-gray-700">è©³ç´°è·æ­´
                                    (æœ€å¤§10ç¤¾)</label>
                                <button type="button" onclick="addWorkHistoryItem()"
                                    class="text-sm text-indigo-600 hover:text-indigo-800 flex items-center font-medium">
                                    <i class="fas fa-plus-circle mr-1"></i>è·æ­´ã‚’è¿½åŠ 
                                </button>
                            </div>
                            <div id="work-history-list" class="space-y-4 mb-2">
                                <!-- JSã§å‹•çš„ã«è¿½åŠ  -->
                            </div>

                            <div class="flex items-center gap-4 mt-2 mb-4">
                                <label class="text-xs text-gray-500">çµŒé¨“ç¤¾æ•° (è‡ªå‹•è¨ˆç®—):</label>
                                <input type="number" id="admin-user-job-change-count"
                                    class="w-20 px-2 py-1 border rounded bg-gray-50 text-center text-sm" readonly>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">è·å‹™çµŒæ­´æ›¸
                                (è©³ç´°ãƒ†ã‚­ã‚¹ãƒˆ)</label>
                            <textarea id="admin-user-work-history-detail" rows="10"
                                class="w-full px-4 py-2 border rounded-lg text-sm font-mono bg-gray-50 focus:bg-white transition"
                                placeholder="è·å‹™çµŒæ­´ã®è©³ç´°ãƒ†ã‚­ã‚¹ãƒˆ"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å±¥æ­´æƒ…å ±</label>
                            <textarea id="admin-user-history-info" rows="6"
                                class="w-full px-4 py-2 border rounded-lg text-sm bg-gray-50 focus:bg-white transition"
                                placeholder="å±¥æ­´æƒ…å ±ã®è£œè¶³ãªã©"></textarea>
                        </div>

                        <!-- å¤–éƒ¨é€£æºURL -->
                        <div class="border-t border-gray-200 pt-4 mt-4">
                            <h5 class="text-sm font-bold text-gray-700 mb-3">å¤–éƒ¨é€£æºURL</h5>
                            <div class="grid grid-cols-1 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Google
                                        Drive
                                        URL</label>
                                    <input type="url" id="admin-user-drive-url"
                                        class="w-full px-4 py-2 border rounded-lg"
                                        placeholder="https://drive.google.com/...">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">NotebookLM
                                        URL</label>
                                    <input type="url" id="admin-user-notebooklm-url"
                                        class="w-full px-4 py-2 border rounded-lg"
                                        placeholder="https://notebooklm.google.com/...">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">LINE
                                        URL</label>
                                    <input type="url" id="admin-user-line-url"
                                        class="w-full px-4 py-2 border rounded-lg" placeholder="https://line.me/...">
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç¤¾å†…ãƒãƒƒãƒãƒ³ã‚°æƒ…å ±</label>
                            <textarea id="admin-user-resume-detail" rows="6"
                                class="w-full px-4 py-2 border rounded-lg text-sm font-mono bg-gray-50 focus:bg-white transition"
                                placeholder="ç¤¾å†…ãƒãƒƒãƒãƒ³ã‚°æƒ…å ±ï¼ˆã‚¹ã‚­ãƒ«ã€çµŒé¨“ã€å¸Œæœ›ã®è£œè¶³ãªã©ï¼‰"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç¤¾å†…ãƒ¡ãƒ¢ãƒ»å…±æœ‰äº‹é …</label>
                            <textarea id="admin-user-notes" rows="6"
                                class="w-full px-4 py-2 border rounded-lg text-sm bg-gray-50 focus:bg-white transition"
                                placeholder="ç¤¾å†…ãƒ¡ãƒ¢ã€é¢è«‡è¨˜éŒ²ã€å…±æœ‰äº‹é …ãªã©"></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 pt-4 border-t">
                        <button type="button" onclick="closeAdminUserModal()"
                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                        <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                            ä¿å­˜
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Admin: Data Merge Modal -->
        <div id="data-merge-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
            style="z-index: 40000;">
            <div class="bg-white rounded-lg w-full max-w-4xl p-6 max-h-[90vh] overflow-hidden flex flex-col">
                <div class="flex justify-between items-center mb-4 pb-4 border-b">
                    <div>
                        <h3 class="text-xl font-bold text-gray-900">ãƒ‡ãƒ¼ã‚¿ã®çµ±åˆ (ãƒãƒ¼ã‚¸)</h3>
                        <p class="text-xs text-gray-500 mt-1">
                            çµ±åˆã™ã‚‹ã¨ã€é¸æŠã•ã‚Œãªã‹ã£ãŸæ–¹ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯å‰Šé™¤ã•ã‚Œã¾ã™ã€‚é–¢é€£ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ï¼ˆæ±‚äººã€å¿œå‹Ÿãªã©ï¼‰ã¯çµ±åˆå…ˆã«å¼•ãç¶™ãŒã‚Œã¾ã™ã€‚</p>
                    </div>
                    <button onclick="closeDataMergeModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto px-1">
                    <table class="min-w-full border-collapse">
                        <thead class="sticky top-0 bg-gray-50 z-10">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase border-b">
                                    é …ç›®</th>
                                <th
                                    class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase border-b w-[40%]">
                                    <div class="flex items-center justify-between">
                                        <span>ãƒ¬ã‚³ãƒ¼ãƒ‰ A (çµ±åˆå…ˆ)</span>
                                        <button onclick="selectAllMerge('A')"
                                            class="text-[10px] text-indigo-600 hover:underline">å…¨é¸æŠ</button>
                                    </div>
                                </th>
                                <th
                                    class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase border-b w-[40%]">
                                    <div class="flex items-center justify-between">
                                        <span>ãƒ¬ã‚³ãƒ¼ãƒ‰ B (çµ±åˆå…ƒ: å‰Šé™¤å¯¾è±¡)</span>
                                        <button onclick="selectAllMerge('B')"
                                            class="text-[10px] text-indigo-600 hover:underline">å…¨é¸æŠ</button>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="merge-fields-container" class="divide-y divide-gray-100">
                            <!-- Fields injected by JS -->
                        </tbody>
                    </table>
                </div>

                <div class="mt-6 pt-4 border-t flex justify-between items-center bg-gray-50 p-4 rounded-lg">
                    <div class="text-sm text-amber-700">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        çµ±åˆå®Ÿè¡Œå¾Œã€Bã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯<strong>å®Œå…¨ã«å‰Šé™¤</strong>ã•ã‚Œã¾ã™ã€‚
                    </div>
                    <div class="flex gap-3">
                        <button onclick="closeDataMergeModal()"
                            class="px-4 py-2 border rounded-lg hover:bg-white transition">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button onclick="executeMerge()"
                            class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 shadow-lg">
                            <i class="fas fa-compress-alt mr-2"></i>çµ±åˆã‚’å®Ÿè¡Œã™ã‚‹
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin: User CSV Import Modal -->
        <div id="admin-user-csv-modal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
            style="z-index: 100000;">
            <div class="bg-white rounded-lg w-full max-w-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">æ±‚è·è€…CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
                    <button onclick="closeUserCsvImportModal()"
                        class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg text-sm text-blue-800">
                        <p class="font-bold mb-2">CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«ã¤ã„ã¦</p>
                        <p>ä»¥ä¸‹ã®ã‚«ãƒ©ãƒ ã‚’æŒã¤CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š</p>
                        <ul class="list-disc list-inside ml-2 mt-1">
                            <li>name (å¿…é ˆ): æ°å</li>
                            <li>email (çµ„ç¹”è¨­å®šã«ã‚ˆã‚Šå¿…é ˆ/ä»»æ„): ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</li>
                            <li>age (ä»»æ„): å¹´é½¢</li>
                            <li>desired_job_type (ä»»æ„): å¸Œæœ›è·ç¨®</li>
                            <li>desired_location (ä»»æ„): å¸Œæœ›å‹¤å‹™åœ°</li>
                            <li>desired_salary (ä»»æ„): å¸Œæœ›å¹´åï¼ˆä¸‡å††ï¼‰</li>
                            <li>skills (ä»»æ„): ã‚¹ã‚­ãƒ«</li>
                        </ul>
                        <p class="mt-2 text-xs">â€» ãƒ­ãƒ¼ãƒ«ã¯è‡ªå‹•çš„ã«ã€Œæ±‚è·è€…ã€ã«è¨­å®šã•ã‚Œã¾ã™</p>
                        <div class="mt-3">
                            <a href="#" onclick="downloadCandidateCsvTemplate(event)"
                                class="text-blue-600 hover:underline">
                                <i class="fas fa-download mr-1"></i>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                            </a>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
                        <input type="file" id="user-csv-file" accept=".csv" class="w-full border rounded-lg p-2">
                    </div>

                    <div id="user-csv-preview" class="hidden max-h-40 overflow-y-auto border rounded p-2 text-xs">
                        <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                    </div>

                    <div class="flex justify-end gap-3 pt-4 border-t">
                        <button onclick="closeUserCsvImportModal()"
                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                        <button onclick="processUserCsvImport()"
                            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                            ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin: Job CSV Import Modal -->
        <div id="admin-job-csv-modal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
            style="z-index: 100000;">
            <div class="bg-white rounded-lg w-full max-w-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">æ±‚äººCSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
                    <button onclick="closeJobCsvImportModal()"
                        class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg text-sm text-blue-800">
                        <p class="font-bold mb-2">CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«ã¤ã„ã¦</p>
                        <p>ä»¥ä¸‹ã®ã‚«ãƒ©ãƒ ã‚’æŒã¤CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š</p>
                        <ul class="list-disc list-inside ml-2 mt-1">
                            <li>title (å¿…é ˆ): æ±‚äººã‚¿ã‚¤ãƒˆãƒ«</li>
                            <li>company (å¿…é ˆ): ä¼šç¤¾å</li>
                            <li>salary_min (å¿…é ˆ): æœ€ä½å¹´å(æ•°å€¤)</li>
                            <li>salary_max (å¿…é ˆ): æœ€é«˜å¹´å(æ•°å€¤)</li>
                            <li>location (å¿…é ˆ): å‹¤å‹™åœ°</li>
                            <li>description: ä»•äº‹å†…å®¹</li>
                        </ul>
                        <div class="mt-3">
                            <a href="#" onclick="downloadJobCsvTemplate(event)" class="text-blue-600 hover:underline">
                                <i class="fas fa-download mr-1"></i>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                            </a>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
                        <input type="file" id="job-csv-file" accept=".csv" class="w-full border rounded-lg p-2">
                    </div>

                    <div id="job-csv-preview" class="hidden max-h-40 overflow-y-auto border rounded p-2 text-xs">
                        <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                    </div>

                    <div class="flex justify-end gap-3 pt-4 border-t">
                        <button onclick="closeJobCsvImportModal()"
                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                        <button onclick="processJobCsvImport()"
                            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                            ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin: Company CSV Import Modal -->
        <div id="admin-company-csv-modal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
            style="z-index: 100000;">
            <div class="bg-white rounded-lg w-full max-w-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">ä¼æ¥­CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
                    <button onclick="closeCompanyCsvImportModal()"
                        class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg text-sm text-blue-800">
                        <p class="font-bold mb-2">CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«ã¤ã„ã¦</p>
                        <p>ä»¥ä¸‹ã®ã‚«ãƒ©ãƒ ã‚’æŒã¤CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š</p>
                        <ul class="list-disc list-inside ml-2 mt-1">
                            <li>name (å¿…é ˆ): ä¼æ¥­å</li>
                            <li>industry (ä»»æ„): æ¥­ç•Œ</li>
                            <li>location (ä»»æ„): æ‰€åœ¨åœ°</li>
                            <li>website (ä»»æ„): Webã‚µã‚¤ãƒˆURL</li>
                            <li>description (ä»»æ„): ä¼æ¥­èª¬æ˜</li>
                        </ul>
                        <div class="mt-3">
                            <a href="#" onclick="downloadCompanyCsvTemplate(event)"
                                class="text-blue-600 hover:underline">
                                <i class="fas fa-download mr-1"></i>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                            </a>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
                        <input type="file" id="company-csv-file" accept=".csv" class="w-full border rounded-lg p-2">
                    </div>

                    <div id="company-csv-preview" class="hidden max-h-40 overflow-y-auto border rounded p-2 text-xs">
                        <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                    </div>

                    <div class="flex justify-end gap-3 pt-4 border-t">
                        <button onclick="closeCompanyCsvImportModal()"
                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                        <button onclick="processCompanyCsvImport()"
                            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                            ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin: Drive Import Modal -->
        <div id="drive-import-modal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
            style="z-index: 100000;">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] flex flex-col">
                <div class="p-6 border-b flex justify-between items-center bg-blue-600 text-white rounded-t-lg">
                    <h3 class="text-xl font-bold flex items-center gap-2">
                        <i class="fab fa-google-drive"></i> Googleãƒ‰ãƒ©ã‚¤ãƒ–æ±‚äººå–å¾—
                    </h3>
                    <button onclick="closeDriveImportModal()" class="text-white hover:text-blue-100">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <div class="p-6 overflow-y-auto flex-1 bg-gray-50">
                    <!-- Filters -->
                    <div class="bg-white p-4 rounded-lg shadow-sm mb-4 border border-gray-200">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢</label>
                                <div class="relative">
                                    <input type="text" id="drive-filter-search" placeholder="ãƒ•ã‚¡ã‚¤ãƒ«åã§æ¤œç´¢..."
                                        class="w-full pl-9 pr-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                                        oninput="applyDriveFileFilters()">
                                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">æ›´æ–°æ—¥ï¼ˆã‹ã‚‰ï¼‰</label>
                                <input type="date" id="drive-filter-date-from"
                                    class="w-full px-3 py-2 border rounded-lg text-sm outline-none"
                                    onchange="applyDriveFileFilters()">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ä¸¦ã³æ›¿ãˆ</label>
                                <select id="drive-filter-sort"
                                    class="w-full px-3 py-2 border rounded-lg text-sm outline-none bg-white"
                                    onchange="applyDriveFileFilters()">
                                    <option value="newest">æ›´æ–°æ—¥ãŒæ–°ã—ã„é †</option>
                                    <option value="oldest">æ›´æ–°æ—¥ãŒå¤ã„é †</option>
                                    <option value="name">åå‰é †</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="drive-import-status"
                        class="mb-4 p-4 bg-blue-50 text-blue-700 rounded-lg flex items-center gap-3 border border-blue-100">
                        <i class="fas fa-info-circle"></i>
                        <p class="text-sm">Googleãƒ‰ãƒ©ã‚¤ãƒ–ã‹ã‚‰æœ€æ–°ã®PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã—ã¦ã„ã¾ã™...</p>
                    </div>

                    <!-- Select All & Count -->
                    <div class="flex justify-between items-center mb-3 px-1">
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <input type="checkbox" id="drive-file-select-all"
                                class="h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500 transition"
                                onchange="toggleDriveAllCheckboxes(this.checked)">
                            <span class="text-sm font-bold text-gray-700 group-hover:text-blue-600 transition">ã™ã¹ã¦é¸æŠ
                                / è§£é™¤</span>
                        </label>
                        <div id="drive-file-list-count"
                            class="text-xs font-bold text-gray-400 uppercase tracking-wider">
                            0ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«
                        </div>
                    </div>

                    <div id="drive-file-list" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <!-- File list will be rendered here -->
                    </div>
                </div>

                <div class="p-4 border-t bg-white flex justify-between items-center rounded-b-lg">
                    <div id="drive-import-count"
                        class="text-sm font-bold text-gray-600 bg-gray-100 px-3 py-1 rounded-full">
                        0ä»¶é¸æŠ
                    </div>
                    <div class="flex gap-3">
                        <button onclick="closeDriveImportModal()"
                            class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button id="execute-drive-import-btn" onclick="executeDriveImport()" disabled
                            class="bg-blue-600 text-white px-8 py-2 rounded-lg font-bold hover:bg-blue-700 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 transition-all active:scale-95">
                            <i class="fas fa-download"></i> ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’é–‹å§‹
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Coach: My Students Page -->
        <div id="coach-students-content" class="app-content p-6 hidden">
            <div class="flex justify-between items-center mb-6">
                <!-- Title removed -->
            </div>

            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ç™»éŒ²æ—¥</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    é€²æ—çŠ¶æ³</th>
                                <th
                                    class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="coach-students-container" class="bg-white divide-y divide-gray-200">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


        <!-- å€™è£œè€…ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="candidate-preview-modal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
            style="z-index: 30000;">
            <div
                class="bg-white rounded-2xl w-full max-w-7xl mx-4 h-[92vh] flex flex-col shadow-2xl overflow-hidden animate-fade-in">
                <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ (å›ºå®š) -->
                <div class="flex-none flex justify-between items-center px-8 py-5 border-b bg-white">
                    <div class="flex items-center gap-4">
                        <div id="candidate-avatar-header"
                            class="w-12 h-12 bg-indigo-600 rounded-full flex items-center justify-center text-white text-xl font-bold shadow-inner">
                            ?
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-gray-900 leading-tight flex items-center gap-3">
                                <span id="candidate-detail-title">å€™è£œè€…è©³ç´°</span>
                                <span id="candidate-header-meta"
                                    class="text-sm font-normal text-gray-500 bg-gray-100 px-3 py-1 rounded-full"></span>
                            </h3>
                            <p id="candidate-email-header" class="text-sm text-gray-500"></p>
                        </div>
                        <div id="candidate-status-badge-header" class="ml-4">
                            <!-- Status badge will be injected here -->
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="showAdminUserModal($('#interview-candidate-id').val())"
                            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 text-sm font-bold flex items-center transition-all">
                            <i class="fas fa-edit mr-2 text-gray-400"></i>æƒ…å ±ã‚’ç·¨é›†
                        </button>
                        <button onclick="closeCandidatePreview()"
                            class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-500 transition-all">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>

                <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ (é›†ç´„ç”»é¢) -->
                <div class="flex-1 min-h-0 bg-gray-50 flex flex-col lg:flex-row overflow-hidden">

                    <!-- å·¦ã‚«ãƒ©ãƒ : ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è©³ç´° (ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯) -->
                    <div id="candidate-preview-content"
                        class="w-full lg:w-[42%] h-full bg-white border-r overflow-y-scroll custom-scrollbar p-8 space-y-8 pb-32">
                        <!-- Profile details will be loaded here -->
                    </div>

                    <!-- å³ã‚«ãƒ©ãƒ : ç®¡ç†æƒ…å ± (ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯) -->
                    <div
                        class="w-full lg:w-[58%] h-full bg-gray-50 overflow-y-scroll custom-scrollbar p-8 space-y-8 pb-32">
                        <!-- é¸è€ƒé€²æ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                        <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm">
                            <div class="flex justify-between items-center mb-6">
                                <h4 class="font-bold text-lg text-gray-900 flex items-center">
                                    <i class="fas fa-tasks mr-2 text-indigo-600 bg-indigo-50 p-2 rounded-lg"></i>
                                    ã‚¨ãƒ³ãƒˆãƒªãƒ¼ä¸­ã®æ¡ˆä»¶ / é¸è€ƒçŠ¶æ³
                                </h4>
                            </div>
                            <div id="selection-progress-container" class="space-y-4">
                                <!-- Selection list will be rendered here -->
                            </div>
                        </div>

                        <!-- é¢è«‡å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                        <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm flex flex-col">
                            <div class="flex justify-between items-center mb-6">
                                <h4 class="font-bold text-lg text-gray-900 flex items-center">
                                    <i class="fas fa-comments mr-2 text-blue-600 bg-blue-50 p-2 rounded-lg"></i>
                                    é¢è«‡å±¥æ­´ãƒ»å¯¾å¿œãƒ¡ãƒ¢
                                </h4>
                                <button onclick="openInterviewRecordModal()"
                                    class="bg-indigo-600 text-white px-5 py-2.5 rounded-xl hover:bg-indigo-700 text-sm font-bold flex items-center transition-all shadow-md transform hover:-translate-y-0.5">
                                    <i class="fas fa-plus mr-2"></i>å±¥æ­´ã‚’è¨˜éŒ²
                                </button>
                            </div>
                            <div id="interview-list-container" class="space-y-4">
                                <!-- Interviews will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- é¢è«‡å±¥æ­´è¨˜éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="interview-record-modal"
            class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden"
            style="z-index: 31000;">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 animate-fade-in-up">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h3 class="text-xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-clipboard-list text-indigo-600 mr-2"></i>é¢è«‡å±¥æ­´ã‚’ä¿å­˜
                    </h3>
                    <button onclick="closeInterviewRecordModal()"
                        class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <form id="interview-record-form" class="space-y-5">
                    <input type="hidden" id="interview-candidate-id">
                    <input type="hidden" id="interview-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">å®Ÿæ–½æ—¥</label>
                            <input type="date" id="interview-date"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 transition-all"
                                required>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">é¢è«‡ç¨®åˆ¥</label>
                            <select id="interview-type"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 transition-all">
                                <option value="åˆå›é¢è«‡">åˆå›é¢è«‡</option>
                                <option value="ãƒ•ã‚©ãƒ­ãƒ¼é¢è«‡">ãƒ•ã‚©ãƒ­ãƒ¼é¢è«‡</option>
                                <option value="ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«é¢è«‡">ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«é¢è«‡</option>
                                <option value="æ¨¡æ“¬é¢æ¥">æ¨¡æ“¬é¢æ¥</option>
                                <option value="é›»è©±é€£çµ¡">é›»è©±é€£çµ¡</option>
                                <option value="ãã®ä»–">ãã®ä»–</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">å†…å®¹ãƒ»ãƒ¡ãƒ¢</label>
                        <textarea id="interview-content" rows="8"
                            class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 transition-all text-sm leading-relaxed"
                            placeholder="è©±ã—ãŸå†…å®¹ã€å°è±¡ã€æ‡¸å¿µç‚¹ãªã©ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">ãƒã‚¯ã‚¹ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³</label>
                        <input type="text" id="interview-next-action"
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 transition-all text-sm"
                            placeholder="ä¾‹: ã€‡ã€‡ç¤¾ã®æ±‚äººã‚’æ¡ˆå†…ã™ã‚‹ã€æ¥é€±æœˆæ›œæ—¥ã«é€²æ—ç¢ºèªãªã©">
                    </div>
                    <div class="flex justify-end gap-3 pt-4 border-t">
                        <button type="button" onclick="closeInterviewRecordModal()"
                            class="px-6 py-2 border rounded-lg hover:bg-gray-50 transition-all text-sm font-bold text-gray-600">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                        <button type="submit"
                            class="bg-indigo-600 text-white px-8 py-2 rounded-lg hover:bg-indigo-700 transition-all text-sm font-bold shadow-md transform hover:-translate-y-0.5">
                            å±¥æ­´ã‚’ä¿å­˜ã™ã‚‹
                        </button>
                    </div>
                </form>
            </div>
        </div>


    </div>
    </div>

    <!-- æ±‚äººé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="job-selection-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
        style="z-index: 11000;">
        <div class="bg-white rounded-lg w-full max-w-2xl p-6 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-search-plus text-indigo-600 mr-2"></i>ã‚¹ã‚«ã‚¦ãƒˆæ±‚äººã‚’é¸æŠ
                </h3>
                <button onclick="closeJobSelectorForScout()"
                    class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-4 space-y-3">
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">ä¼æ¥­å</label>
                    <input type="text" id="selector-search-company"
                        class="w-full border border-gray-300 rounded px-3 py-2 text-sm" placeholder="ä¼æ¥­åã§æ¤œç´¢...">
                </div>
                <div class="flex gap-4">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-600 mb-1">å‹¤å‹™åœ°ï¼ˆéƒ½é“åºœçœŒï¼‰</label>
                        <select id="selector-search-prefecture"
                            class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
                            <option value="">æŒ‡å®šãªã—</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-600 mb-1">è·å‹™å†…å®¹ãƒ»è·ç¨®</label>
                        <input type="text" id="selector-search-keyword"
                            class="w-full border border-gray-300 rounded px-3 py-2 text-sm" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰...">
                    </div>
                </div>
                <div class="text-right">
                    <button onclick="searchJobsForScout()"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded shadow transition">
                        <i class="fas fa-search mr-2"></i>æ¤œç´¢
                    </button>
                </div>
            </div>

            <div id="selector-job-results" class="flex-1 overflow-y-auto space-y-2 border-t pt-4">
                <div class="text-center py-8 text-gray-400">
                    æ¤œç´¢æ¡ä»¶ã‚’å…¥åŠ›ã—ã¦æ¤œç´¢ã—ã¦ãã ã•ã„
                </div>
            </div>
        </div>
    </div>

    <!-- å¤–éƒ¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è§£æãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <!-- Admin: AI Prompts -->
    <div id="admin-prompts-content" class="app-content p-2 hidden">
        <div class="max-w-full mx-auto">
            <div class="flex justify-between items-center mb-2 px-2">
                <div>
                    <h2 class="text-xl font-bold text-gray-800">AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š</h2>
                </div>
                <button onclick="savePrompts()"
                    class="bg-indigo-600 text-white px-4 py-1.5 rounded hover:bg-indigo-700 shadow-sm transition-all flex items-center text-sm font-medium">
                    <i class="fas fa-save mr-1.5"></i>ä¿å­˜
                </button>
            </div>

            <!-- â‘  ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚° -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 mb-3">
                <div class="mb-2 border-b border-gray-100 pb-2 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span
                            class="bg-indigo-50 text-indigo-700 px-2 py-0.5 rounded text-xs font-bold border border-indigo-100">åˆ†æ</span>
                        <h3 class="text-base font-bold text-gray-800">ãƒãƒƒãƒãƒ³ã‚°ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°</h3>
                        <span class="text-xs text-gray-500">ãƒãƒƒãƒãƒ³ã‚°è©³ç´°åˆ†æãƒ»ã‚¹ã‚³ã‚¢ç®—å‡ºç”¨</span>
                    </div>
                </div>
                <textarea id="prompt-scoring"
                    class="w-full h-64 px-3 py-2 bg-gray-50 border border-gray-200 rounded font-mono text-xs text-gray-800 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all leading-relaxed resize-y"
                    placeholder="ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
            </div>

            <!-- â‘¡ ç´¹ä»‹ç†ç”± -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 mb-3">
                <div class="mb-2 border-b border-gray-100 pb-2 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span
                            class="bg-green-50 text-green-700 px-2 py-0.5 rounded text-xs font-bold border border-green-100">ç”Ÿæˆ</span>
                        <h3 class="text-base font-bold text-gray-800">ç´¹ä»‹ç†ç”±ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
                        <span class="text-xs text-gray-500">æ±‚è·è€…å‘ã‘ç´¹ä»‹ç†ç”±ï¼ˆ100æ–‡å­—ç¨‹åº¦ï¼‰ç”¨</span>
                    </div>
                </div>
                <textarea id="prompt-reason"
                    class="w-full h-32 px-3 py-2 bg-gray-50 border border-gray-200 rounded font-mono text-xs text-gray-800 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all leading-relaxed resize-y"
                    placeholder="ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
            </div>

            <!-- â‘¢ æ¨è–¦æ–‡ -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 mb-3">
                <div class="mb-2 border-b border-gray-100 pb-2 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span
                            class="bg-blue-50 text-blue-700 px-2 py-0.5 rounded text-xs font-bold border border-blue-100">æ›¸é¡</span>
                        <h3 class="text-base font-bold text-gray-800">æ¨è–¦æ–‡ï¼ˆç´¹ä»‹çŠ¶ï¼‰</h3>
                        <span class="text-xs text-gray-500">æ±‚è·è€…ã¸ã®æ¨è–¦æ–‡ç”Ÿæˆç”¨</span>
                    </div>
                </div>
                <textarea id="prompt-recommendation-letter"
                    class="w-full h-48 px-3 py-2 bg-gray-50 border border-gray-200 rounded font-mono text-xs text-gray-800 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all leading-relaxed resize-y"
                    placeholder="ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
            </div>

            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 mb-3">
                <div class="mb-2 border-b border-gray-100 pb-2 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span
                            class="bg-orange-50 text-orange-700 px-2 py-0.5 rounded text-xs font-bold border border-orange-100">é€ä¿¡</span>
                        <h3 class="text-base font-bold text-gray-800">ã‚¹ã‚«ã‚¦ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h3>
                        <span class="text-xs text-gray-500">ä¼æ¥­ã‹ã‚‰æ±‚è·è€…ã¸ã®ã‚¹ã‚«ã‚¦ãƒˆæ–‡ç”Ÿæˆç”¨</span>
                    </div>
                </div>
                <textarea id="prompt-scout-message"
                    class="w-full h-48 px-3 py-2 bg-gray-50 border border-gray-200 rounded font-mono text-xs text-gray-800 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all leading-relaxed resize-y"
                    placeholder="ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
            </div>

            <!-- â‘¤ æ±‚äººè§£æ (System Prompt) -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 mb-3">
                <div class="mb-2 border-b border-gray-100 pb-2 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span
                            class="bg-purple-50 text-purple-700 px-2 py-0.5 rounded text-xs font-bold border border-purple-100">è§£æ</span>
                        <h3 class="text-base font-bold text-gray-800">æ±‚äººè§£æ (System)</h3>
                        <span class="text-xs text-gray-500">CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã®æ±‚äººæƒ…å ±è§£æç”¨</span>
                    </div>
                </div>
                <textarea id="prompt-job-description"
                    class="w-full h-64 px-3 py-2 bg-gray-50 border border-gray-200 rounded font-mono text-xs text-gray-800 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all leading-relaxed resize-y"
                    placeholder="è§£æãƒ­ã‚¸ãƒƒã‚¯ï¼ˆJSONå®šç¾©ãªã©ï¼‰..."></textarea>
            </div>

            <!-- â‘¥ CSVãƒãƒƒãƒ”ãƒ³ã‚° (System Prompt) -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 mb-3">
                <div class="mb-2 border-b border-gray-100 pb-2 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span
                            class="bg-purple-50 text-purple-700 px-2 py-0.5 rounded text-xs font-bold border border-purple-100">è§£æ</span>
                        <h3 class="text-base font-bold text-gray-800">CSVãƒãƒƒãƒ”ãƒ³ã‚° (System)</h3>
                        <span class="text-xs text-gray-500">CSVãƒ˜ãƒƒãƒ€ãƒ¼ã®è‡ªå‹•ãƒãƒƒãƒ—ç”¨</span>
                    </div>
                </div>
                <textarea id="prompt-csv-mapping"
                    class="w-full h-48 px-3 py-2 bg-gray-50 border border-gray-200 rounded font-mono text-xs text-gray-800 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all leading-relaxed resize-y"
                    placeholder="ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯..."></textarea>
            </div>

            <!-- â‘¦ å¤–éƒ¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è§£æ (System Prompt) -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 mb-3">
                <div class="mb-2 border-b border-gray-100 pb-2 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span
                            class="bg-purple-50 text-purple-700 px-2 py-0.5 rounded text-xs font-bold border border-purple-100">è§£æ</span>
                        <h3 class="text-base font-bold text-gray-800">å¤–éƒ¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è§£æ (System)</h3>
                        <span class="text-xs text-gray-500">PDF/ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã®è§£æç”¨</span>
                    </div>
                </div>
                <textarea id="prompt-external-profile-analysis"
                    class="w-full h-80 px-3 py-2 bg-gray-50 border border-gray-200 rounded font-mono text-xs text-gray-800 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:bg-white focus:border-transparent transition-all leading-relaxed resize-y"
                    placeholder="è§£æãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ..."></textarea>
            </div>
        </div>
    </div>

    <!-- Admin: Company Management Page -->
    <div id="admin-companies-content" class="app-content p-6 hidden">
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">ä¼æ¥­ç®¡ç†</h2>
                    <p class="text-gray-600 text-sm mt-1">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ä¼æ¥­ã®ä¸€è¦§ã¨ç®¡ç†</p>
                </div>
                <div class="flex gap-2">
                    <button id="bulk-delete-companies" onclick="bulkDeleteCompanies()"
                        class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 hidden">
                        <i class="fas fa-trash-alt mr-2"></i>ä¸€æ‹¬å‰Šé™¤ (<span id="selected-companies-count">0</span>)
                    </button>
                    <button onclick="showCompanyCsvImportModal()"
                        class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                        <i class="fas fa-file-csv mr-2"></i>CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                    </button>
                    <button onclick="showCompanyForm()"
                        class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                        <i class="fas fa-plus mr-2"></i>æ–°è¦ä¼æ¥­ç™»éŒ²
                    </button>
                </div>
            </div>
            <div class="mb-4">
                <input type="text" id="company-search" placeholder="ä¼æ¥­åã€æ¥­ç•Œã€æ‰€åœ¨åœ°ã§æ¤œç´¢..."
                    class="w-full px-4 py-2 border rounded-lg" onkeyup="filterCompanies()">
            </div>
        </div>
        <div class="bg-white rounded-lg shadow overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200" id="companies-table">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left w-10">
                            <input type="checkbox" id="select-all-companies" onchange="toggleAllCompanies(this)"
                                class="rounded text-indigo-600 focus:ring-indigo-500">
                        </th>
                        <th
                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[200px]">
                            ä¼æ¥­å</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            æ¥­ç•Œ</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            æ‰€åœ¨åœ°</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Webã‚µã‚¤ãƒˆ</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="companies-container" class="bg-white divide-y divide-gray-200">
                    <!-- Companies will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
    </main>
    </div>

    <!-- Company Form Modal -->
    <div id="company-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 id="company-modal-title" class="text-xl font-bold">ä¼æ¥­ç™»éŒ²</h2>
                <button onclick="closeCompanyModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <form id="company-form" onsubmit="handleCompanySubmit(event)">
                    <input type="hidden" id="company-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ä¼šç¤¾å <span
                                    class="text-red-500">*</span></label>
                            <input type="text" id="company-name" required class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ¥­ç•Œ</label>
                            <select id="company-industry" class="w-full border rounded-lg px-3 py-2">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ‰€åœ¨åœ°</label>
                            <input type="text" id="company-location" class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Webã‚µã‚¤ãƒˆURL</label>
                            <input type="url" id="company-website" class="w-full border rounded-lg px-3 py-2"
                                placeholder="https://...">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ä¼šç¤¾æ¦‚è¦</label>
                            <textarea id="company-description" rows="4"
                                class="w-full border rounded-lg px-3 py-2"></textarea>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="closeCompanyModal()"
                            class="px-4 py-2 border rounded-lg hover:bg-gray-50">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button type="submit"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">ä¿å­˜</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Master Data Modal -->
    <div id="master-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 id="master-modal-title" class="text-xl font-bold">ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ä½œæˆ</h2>
                <button onclick="closeMasterModal()"
                    class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="master-form" class="p-6 space-y-4">
                <input type="hidden" id="master-id">
                <input type="hidden" id="master-organization-id">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç¨®åˆ¥ *</label>
                    <select id="master-type" required class="w-full px-4 py-2 border rounded-lg">
                        <option value="employment_type">é›‡ç”¨å½¢æ…‹</option>
                        <option value="job_category">è·ç¨®ã‚«ãƒ†ã‚´ãƒª</option>
                        <option value="industry_category">æ¥­ç¨®ã‚«ãƒ†ã‚´ãƒª</option>
                        <option value="selection_status">é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è¡¨ç¤ºå (Label) *</label>
                    <input type="text" id="master-label" required class="w-full px-4 py-2 border rounded-lg">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä¿å­˜å€¤ (Value) *</label>
                    <input type="text" id="master-value" required class="w-full px-4 py-2 border rounded-lg">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è¡¨ç¤ºé †</label>
                    <input type="number" id="master-sort" value="0" class="w-full px-4 py-2 border rounded-lg">
                </div>

                <div class="flex items-center gap-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="master-is-active" class="w-4 h-4 text-indigo-600 rounded" checked>
                        <span class="text-sm text-gray-700">æœ‰åŠ¹ã«ã™ã‚‹</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer" id="master-is-global-container">
                        <input type="checkbox" id="master-is-global" class="w-4 h-4 text-indigo-600 rounded">
                        <span class="text-sm text-gray-700">ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š</span>
                    </label>
                </div>

                <!-- AIè‡ªå‹•è£œå®Œã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
                <div class="mb-6 bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                    <label class="flex items-start gap-3 cursor-pointer">
                        <input type="checkbox" id="csv-ai-augment" class="w-5 h-5 text-indigo-600 rounded mt-0.5">
                        <div>
                            <span class="font-bold text-gray-900">AIã«ã‚ˆã‚‹è‡ªå‹•è£œå®Œã‚’è¡Œã†</span>
                            <p class="text-xs text-gray-600 mt-1">
                                è·ç¨®ã‚«ãƒ†ã‚´ãƒªã€æ¥­ç•Œã‚«ãƒ†ã‚´ãƒªã€ãƒªãƒ¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯å¯å¦ãªã©ã®é …ç›®ãŒç©ºæ¬„ã®å ´åˆã€<br>
                                æ±‚äººè©³ç´°ãªã©ã®ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‹ã‚‰AIãŒè‡ªå‹•çš„ã«æ¨æ¸¬ã—ã¦è£œå®Œã—ã¾ã™ã€‚<br>
                                <span class="text-red-500">â€»å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</span>
                            </p>
                        </div>
                    </label>
                </div>

                <div class="flex justify-end gap-3 pt-4 border-t">
                    <button type="button" onclick="closeMasterModal()"
                        class="px-6 py-2 border rounded-lg hover:bg-gray-50">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                    <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">
                        ä¿å­˜
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Status Update Modal -->
    <div id="bulk-status-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] hidden">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 overflow-hidden">
            <div class="p-4 border-b bg-indigo-50 flex justify-between items-center">
                <h3 class="font-bold text-indigo-900">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸€æ‹¬å¤‰æ›´</h3>
                <button onclick="closeBulkStatusModal()" class="text-gray-400 hover:text-gray-600"><i
                        class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <p class="text-sm text-gray-600 mb-4 font-bold" id="bulk-status-target-count">0ä»¶ã®å¿œå‹Ÿã‚’é¸æŠä¸­</p>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">ä¸€æ‹¬é©ç”¨ã™ã‚‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                        <select id="bulk-new-status"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg font-bold focus:ring-2 focus:ring-indigo-500 outline-none">
                            <!-- Options populated JS -->
                        </select>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-end gap-3">
                <button onclick="closeBulkStatusModal()"
                    class="px-4 py-2 text-sm font-bold text-gray-600 border border-gray-300 rounded-lg hover:bg-white transition-all">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="submitBulkStatusUpdate()"
                    class="px-6 py-2 text-sm font-bold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 shadow-md transition-all">ä¸€æ‹¬æ›´æ–°ã‚’å®Ÿè¡Œ</button>
            </div>
        </div>
    </div>

    <!-- Progress Management Modal -->
    <div id="progress-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold">é€²æ—ç®¡ç†</h2>
                <button onclick="closeProgressModal()"
                    class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="p-6">
                <input type="hidden" id="progress-application-id">

                <!-- Application Info -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="font-semibold text-lg mb-2" id="progress-job-title"></h3>
                    <p class="text-gray-600 text-sm" id="progress-company-name"></p>
                    <p class="text-gray-600 text-sm" id="progress-user-name"></p>
                </div>

                <!-- Status Update Form -->
                <div class="bg-white border rounded-lg p-4 mb-6">
                    <h4 class="font-semibold mb-3">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°</h4>
                    <form id="progress-update-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                                <input type="text" id="progress-current-status" readonly
                                    class="w-full px-4 py-2 border rounded-lg bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ *</label>
                                <select id="progress-new-status" required class="w-full px-4 py-2 border rounded-lg">
                                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                </select>
                            </div>
                        </div>

                        <!-- Yomi/Revenue Forecasting -->
                        <div class="bg-indigo-50/50 p-4 rounded-lg border border-indigo-100 space-y-4">
                            <h5 class="text-xs font-bold text-indigo-800 uppercase tracking-wider">å£²ä¸Šãƒ»ãƒ¨ãƒŸäºˆæ¸¬</h5>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-500 mb-1">è¦‹è¾¼ã¿å£²ä¸Š (å††)</label>
                                    <input type="number" id="progress-expected-revenue"
                                        class="w-full px-4 py-2 border rounded-lg text-sm" placeholder="ä¾‹: 1000000">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-500 mb-1">æˆç´„ç¢ºåº¦ (%)</label>
                                    <select id="progress-probability-rate"
                                        class="w-full px-4 py-2 border rounded-lg text-sm">
                                        <option value="0">0% (Cãƒ¨ãƒŸ)</option>
                                        <option value="20">20% (Cãƒ¨ãƒŸ)</option>
                                        <option value="40">40% (Cãƒ¨ãƒŸ)</option>
                                        <option value="60">60% (Bãƒ¨ãƒŸ)</option>
                                        <option value="80">80% (Aãƒ¨ãƒŸ)</option>
                                        <option value="100">100% (ç¢ºå®š)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-500 mb-1">å…¥ç¤¾äºˆå®šæ—¥</label>
                                    <input type="date" id="progress-expected-start-date"
                                        class="w-full px-4 py-2 border rounded-lg text-sm">
                                </div>
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 mb-1">ãƒ¨ãƒŸè©³ç´°ãƒ¡ãƒ¢ (ç‰¹è¨˜äº‹é …)</label>
                                <textarea id="progress-yomi-notes" rows="2"
                                    class="w-full px-4 py-2 border rounded-lg text-sm"
                                    placeholder="ç¢ºåº¦ã®æ ¹æ‹ ã‚„æ‡¸å¿µç‚¹ãªã©"></textarea>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">é€²æ—ãƒ¡ãƒ¢ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆ</label>
                            <textarea id="progress-notes" rows="3" class="w-full px-4 py-2 border rounded-lg"
                                placeholder="ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã®ç†ç”±ã‚„è©³ç´°ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„"></textarea>
                        </div>
                        <div class="flex justify-end">
                            <button type="submit"
                                class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">
                                <i class="fas fa-save mr-2"></i>ä¿å­˜ã—ã¦æ›´æ–°
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Progress Timeline -->
                <div class="bg-white border rounded-lg p-4">
                    <h4 class="font-semibold mb-4">é€²æ—å±¥æ­´</h4>
                    <div id="progress-timeline" class="space-y-4">
                        <!-- Timeline will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Job Form Modal -->
    <div id="job-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 id="job-modal-title" class="text-xl font-bold">æ±‚äººä½œæˆ</h2>
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <input type="file" id="job-pdf-upload" accept=".pdf" multiple class="hidden"
                            onchange="handleJobPdfUpload(this)">
                        <button onclick="$('#job-pdf-upload').click()"
                            class="bg-green-600 text-white px-3 py-1.5 rounded hover:bg-green-700 text-xs flex items-center">
                            <i class="fas fa-file-pdf mr-1"></i>PDFèª­è¾¼
                        </button>
                    </div>
                    <button onclick="closeJobModal()"
                        class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
            </div>
            <form id="job-form" class="p-6 space-y-4">
                <input type="hidden" id="job-id">
                <input type="hidden" id="job-drive-pdf-url">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ±‚äººã‚¿ã‚¤ãƒˆãƒ« *</label>
                    <input type="text" id="job-title" required class="w-full px-4 py-2 border rounded-lg">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ•ã‚¡ã‚¤ãƒ«å (PDFç­‰)</label>
                    <input type="text" id="job-pdf-filename" class="w-full px-4 py-2 border rounded-lg bg-gray-50"
                        placeholder="PDFå–è¾¼æ™‚ã«è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä¼šç¤¾å *</label>
                    <div class="flex gap-2">
                        <select id="job-company-select"
                            class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">ä¼æ¥­ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="new">+ æ–°è¦ä¼æ¥­ã‚’ä½œæˆ</option>
                        </select>
                        <input type="hidden" id="job-company-id">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å‹¤å‹™åœ° *</label>
                        <input type="text" id="job-location" required class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">é›‡ç”¨å½¢æ…‹ *</label>
                        <select id="job-employment-type" required class="w-full px-4 py-2 border rounded-lg">
                            <option value="æ­£ç¤¾å“¡">æ­£ç¤¾å“¡</option>
                            <option value="å¥‘ç´„ç¤¾å“¡">å¥‘ç´„ç¤¾å“¡</option>
                            <option value="æ´¾é£ç¤¾å“¡">æ´¾é£ç¤¾å“¡</option>
                            <option value="æ¥­å‹™å§”è¨—">æ¥­å‹™å§”è¨—</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æœ€ä½å¹´åï¼ˆä¸‡å††ï¼‰</label>
                        <input type="number" id="job-salary-min" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æœ€é«˜å¹´åï¼ˆä¸‡å††ï¼‰</label>
                        <input type="number" id="job-salary-max" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è·ç¨®ã‚«ãƒ†ã‚´ãƒª</label>
                        <select id="job-category" class="w-full px-4 py-2 border rounded-lg">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ¥­ç•Œã‚«ãƒ†ã‚´ãƒª</label>
                        <select id="job-industry-category" class="w-full px-4 py-2 border rounded-lg">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        </select>
                    </div>
                </div>

                <div class="flex gap-6">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="job-experience-ok" class="w-4 h-4 text-indigo-600 rounded">
                        <span class="text-sm text-gray-700">è·ç¨®æœªçµŒé¨“å¯</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="job-industry-experience-ok" class="w-4 h-4 text-indigo-600 rounded">
                        <span class="text-sm text-gray-700">æ¥­ç•ŒæœªçµŒé¨“å¯</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="job-is-remote" class="w-4 h-4 text-indigo-600 rounded">
                        <span class="text-sm text-gray-700">ãƒªãƒ¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯å¯</span>
                    </label>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å‹¤å‹™æ™‚é–“</label>
                        <input type="text" id="job-work-hours" placeholder="ä¾‹: 9:00 - 18:00"
                            class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ä¼‘æ—¥ä¼‘æš‡</label>
                        <input type="text" id="job-holidays" placeholder="ä¾‹: å®Œå…¨é€±ä¼‘2æ—¥åˆ¶ï¼ˆåœŸæ—¥ç¥ï¼‰"
                            class="w-full px-4 py-2 border rounded-lg">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç¦åˆ©åšç”Ÿ</label>
                    <textarea id="job-benefits" rows="3" placeholder="ä¾‹: ç¤¾ä¼šä¿é™ºå®Œå‚™ã€äº¤é€šè²»æ”¯çµ¦"
                        class="w-full px-4 py-2 border rounded-lg"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">é¸è€ƒãƒ•ãƒ­ãƒ¼</label>
                    <textarea id="job-interview-process" rows="3" placeholder="ä¾‹: æ›¸é¡é¸è€ƒ â†’ ä¸€æ¬¡é¢æ¥ â†’ æœ€çµ‚é¢æ¥"
                        class="w-full px-4 py-2 border rounded-lg"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ±‚äººURL</label>
                    <input type="url" id="job-url" placeholder="https://example.com/job/..."
                        class="w-full px-4 py-2 border rounded-lg">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ‹…å½“è€…1</label>
                        <select id="job-pic-user-1" class="w-full px-4 py-2 border rounded-lg">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ‹…å½“è€…2</label>
                        <select id="job-pic-user-2" class="w-full px-4 py-2 border rounded-lg">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ±‚äººè©³ç´° *</label>
                    <textarea id="job-description" required rows="6" placeholder="ä»•äº‹å†…å®¹ã€æ¥­å‹™ã®è©³ç´°ãªã©"
                        class="w-full px-4 py-2 border rounded-lg"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å¿…é ˆè¦ä»¶</label>
                    <textarea id="job-requirements" rows="4" placeholder="å¿…é ˆã‚¹ã‚­ãƒ«ã€çµŒé¨“å¹´æ•°ã€è³‡æ ¼ãªã©"
                        class="w-full px-4 py-2 border rounded-lg"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å°šå¯è¦ä»¶ï¼ˆæ­“è¿ã‚¹ã‚­ãƒ«ï¼‰</label>
                    <textarea id="job-welcome-requirements" rows="4" placeholder="ã‚ã‚‹ã¨æœ›ã¾ã—ã„ã‚¹ã‚­ãƒ«ã€çµŒé¨“ãªã©"
                        class="w-full px-4 py-2 border rounded-lg"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                    <select id="job-status" class="w-full px-4 py-2 border rounded-lg">
                        <option value="active">å…¬é–‹ä¸­</option>
                        <option value="draft">ä¸‹æ›¸ã</option>
                        <option value="closed">å‹Ÿé›†çµ‚äº†</option>
                    </select>
                </div>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeJobModal()"
                        class="px-6 py-2 border rounded-lg hover:bg-gray-50">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                    <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">
                        ä¿å­˜
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Job Bulk Confirm Modal -->
    <div id="job-bulk-confirm-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center bg-indigo-50">
                <div>
                    <h2 class="text-xl font-bold text-indigo-900">é‡è¤‡ã®å¯èƒ½æ€§ãŒã‚ã‚‹æ±‚äººã®ç¢ºèª</h2>
                    <p class="text-sm text-indigo-600 mt-1">ä»¥ä¸‹ã®æ±‚äººã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ç™»éŒ²ã™ã‚‹ã‚‚ã®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
                </div>
                <button onclick="closeJobBulkConfirmModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <div class="mb-4 flex justify-between items-center">
                    <label class="flex items-center cursor-pointer text-sm font-medium text-gray-700">
                        <input type="checkbox" id="job-bulk-select-all"
                            class="form-checkbox h-4 w-4 text-indigo-600 rounded mr-2"
                            onchange="toggleAllBulkJobs(this.checked)">
                        ã™ã¹ã¦é¸æŠ
                    </label>
                    <span id="job-bulk-count" class="text-sm text-gray-500">0ä»¶é¸æŠä¸­</span>
                </div>
                <div id="job-bulk-list" class="space-y-4">
                    <!-- Dynamic List Items -->
                </div>
            </div>
            <div class="p-6 border-t bg-gray-50 flex justify-end gap-3">
                <button onclick="closeJobBulkConfirmModal()"
                    class="px-6 py-2 border rounded-lg hover:bg-gray-100 transition">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button onclick="executeBulkJobImport()" id="execute-bulk-import-btn"
                    class="bg-indigo-600 text-white px-8 py-2 rounded-lg hover:bg-indigo-700 transition font-bold shadow-md">
                    é¸æŠã—ãŸæ±‚äººã‚’ç™»éŒ²
                </button>
            </div>
        </div>
    </div>

    <!-- Import Result Modal -->
    <div id="import-result-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50">
                <h2 class="text-xl font-bold text-gray-800">ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†çµæœ</h2>
                <button onclick="$('#import-result-modal').addClass('hidden')"
                    class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <div id="import-result-summary" class="mb-6">
                    <!-- Summary info like "Success: X, Failed: Y" -->
                </div>
                <div class="space-y-6">
                    <div id="import-result-success-section" class="hidden">
                        <h3 class="text-sm font-bold text-green-700 mb-2 flex items-center gap-2">
                            <i class="fas fa-check-circle"></i> æˆåŠŸã—ãŸãƒ•ã‚¡ã‚¤ãƒ«
                        </h3>
                        <ul id="import-result-success-list"
                            class="text-sm text-gray-600 list-disc list-inside bg-green-50 p-3 rounded-lg border border-green-100 space-y-1">
                        </ul>
                    </div>
                    <div id="import-result-error-section" class="hidden">
                        <h3 class="text-sm font-bold text-red-700 mb-2 flex items-center gap-2">
                            <i class="fas fa-exclamation-circle"></i> ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸãƒ•ã‚¡ã‚¤ãƒ«
                        </h3>
                        <ul id="import-result-error-list"
                            class="text-sm text-gray-600 list-disc list-inside bg-red-50 p-3 rounded-lg border border-red-100 space-y-1">
                        </ul>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-end">
                <button onclick="$('#import-result-modal').addClass('hidden')"
                    class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-bold">
                    é–‰ã˜ã‚‹
                </button>
            </div>
        </div>
    </div>
    <div id="prompt-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 id="prompt-modal-title" class="text-xl font-bold">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›†</h2>
                <button onclick="closePromptModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="prompt-form" class="p-6 space-y-4">
                <input type="hidden" id="prompt-id">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå *</label>
                    <input type="text" id="prompt-name" required class="w-full px-4 py-2 border rounded-lg"
                        placeholder="ä¾‹: ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢å‘ã‘æ¨è–¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ">
                </div>

                <div class="flex items-center gap-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="prompt-is-active" class="w-4 h-4 text-indigo-600 rounded">
                        <span class="text-sm text-gray-700">æœ‰åŠ¹ã«ã™ã‚‹</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="prompt-is-global" class="w-4 h-4 text-indigo-600 rounded">
                        <span class="text-sm text-gray-700">ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šï¼ˆå…¨çµ„ç¹”ã«é©ç”¨ï¼‰</span>
                    </label>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ *</label>
                    <p class="text-xs text-gray-500 mb-2">
                        åˆ©ç”¨å¯èƒ½ãªå¤‰æ•°: {user_profile}, {jobs}<br>
                        â€»JSONå½¢å¼ã§ã®å‡ºåŠ›ã‚’ç¶­æŒã—ã¦ãã ã•ã„
                    </p>
                    <textarea id="prompt-template" required rows="15"
                        class="w-full px-4 py-2 border rounded-lg font-mono text-sm bg-gray-50"></textarea>
                </div>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closePromptModal()"
                        class="px-6 py-2 border rounded-lg hover:bg-gray-50">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                    <button type="submit" id="prompt-submit-btn"
                        class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">
                        ä¿å­˜
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Suspected Duplicates Modal -->
    <div id="suspected-duplicates-modal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-[60]">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-5xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">é‡è¤‡ç–‘ã„ã®ã‚ã‚‹æ±‚äººã®ç¢ºèª</h3>
                <button onclick="closeSuspectedDuplicatesModal()" class="text-gray-400 hover:text-gray-500">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="mb-4">
                <div class="bg-amber-50 border-l-4 border-amber-400 p-4 mb-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-amber-400"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-amber-700">
                                ä»¥ä¸‹ã®æ±‚äººã¯ã€æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹æ±‚äººã¨é‡è¤‡ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆä¼æ¥­åãƒ»æ±‚äººã‚¿ã‚¤ãƒˆãƒ«ãƒ»å‹¤å‹™åœ°ãŒä¸€è‡´ï¼‰ã€‚
                                <br>
                                ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¯¾è±¡ã¨ã™ã‚‹æ±‚äººã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto mb-6 border rounded-lg max-h-96 overflow-y-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">
                                <input type="checkbox" id="duplicate-check-all" onchange="toggleDuplicateCheckAll(this)"
                                    class="rounded text-indigo-600">
                            </th>
                            <th
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">
                                CSVè¡Œ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                å€‹åˆ¥ã®ç†ç”±/ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ä¼æ¥­å</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                æ±‚äººã‚¿ã‚¤ãƒˆãƒ«</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                å‹¤å‹™åœ°</th>
                        </tr>
                    </thead>
                    <tbody id="suspected-duplicates-tbody" class="bg-white divide-y divide-gray-200 text-sm">
                        <!-- JSã§å‹•çš„ã«è¿½åŠ  -->
                    </tbody>
                </table>
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="closeSuspectedDuplicatesModal()"
                    class="px-6 py-2.5 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium transition-colors">
                    å–ã‚Šè¾¼ã¿ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button onclick="importSelectedDuplicates()"
                    class="px-6 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium transition-colors shadow-sm">
                    é¸æŠã—ãŸæ±‚äººã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ
                </button>
            </div>
        </div>
    </div>



    <!-- Job Smart Import Modal (Text/Image) -->



    <!-- CSV Mapping Modal -->
    <div id="csv-mapping-modal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-5xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆè¨­å®š</h3>
                <button onclick="closeCSVMappingModal()" class="text-gray-400 hover:text-gray-500">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-2">CSVãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ—ã¨ã‚·ã‚¹ãƒ†ãƒ ã®é …ç›®ã‚’å¯¾å¿œä»˜ã‘ã¦ãã ã•ã„ã€‚</p>

                <!-- è¨­å®šä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ã‚¨ãƒªã‚¢ -->
                <div class="bg-gray-50 p-4 rounded-lg mb-4 border border-gray-200">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="flex-1">
                            <label
                                class="block text-xs font-bold text-gray-700 mb-1 uppercase tracking-wide">ä¿å­˜æ¸ˆã¿è¨­å®šã‚’é©ç”¨</label>
                            <div class="flex gap-2">
                                <select id="saved-mapping-select" onchange="applySavedMapping(this.value)"
                                    class="flex-1 border-gray-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="">-- è¨­å®šã‚’é¸æŠ --</option>
                                </select>
                                <button onclick="deleteSavedMapping()"
                                    class="px-2 py-1 text-red-500 hover:text-red-700 border border-transparent hover:border-red-200 rounded"
                                    title="é¸æŠã—ãŸè¨­å®šã‚’å‰Šé™¤">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex-1">
                            <label
                                class="block text-xs font-bold text-gray-700 mb-1 uppercase tracking-wide">ç¾åœ¨ã®è¨­å®šã‚’ä¿å­˜</label>
                            <div class="flex gap-2">
                                <input type="text" id="new-mapping-name" placeholder="è¨­å®šåã‚’å…¥åŠ› (ä¾‹: æ±‚äººã‚µã‚¤ãƒˆA)"
                                    class="flex-1 border-gray-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <button onclick="saveCurrentMapping()"
                                    class="px-3 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-100 text-sm font-medium shadow-sm">
                                    ä¿å­˜
                                </button>
                            </div>
                        </div>
                    </div>
                </div>



                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700">
                                æœ€åˆã®5è¡Œã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ã—ã¦è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚<br>
                                å¿…é ˆé …ç›®ãŒãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¦ã„ãªã„å ´åˆã€ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã¾ã›ã‚“ã€‚
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-4 flex justify-end">
                <button onclick="autoMapWithAI()"
                    class="px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg hover:from-purple-700 hover:to-indigo-700 shadow-sm text-sm font-medium flex items-center transition-all duration-200 mr-2">
                    <i class="fas fa-magic mr-2"></i>AIã§è‡ªå‹•ãƒãƒƒãƒ”ãƒ³ã‚°
                </button>
                <button onclick="previewAIAnalysis()"
                    class="px-4 py-2 bg-white border border-purple-200 text-purple-700 rounded-lg hover:bg-purple-50 shadow-sm text-sm font-medium flex items-center transition-all duration-200">
                    <i class="fas fa-eye mr-2"></i>1ä»¶ç›®ã‚’AIè§£æãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                </button>
            </div>

            <!-- Upsert Mode Settings -->
            <div class="bg-indigo-50 p-4 rounded-lg mb-4 border border-indigo-200">
                <h4 class="text-sm font-bold text-indigo-900 mb-2">æ›´æ–°è¨­å®š</h4>
                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="csv-upsert-mode" onchange="toggleUpsertKey()"
                            class="rounded text-indigo-600 focus:ring-indigo-500 mr-2">
                        <span class="text-sm text-gray-700">é‡è¤‡ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°ã™ã‚‹ï¼ˆã‚¢ãƒƒãƒ—ã‚µãƒ¼ãƒˆï¼‰</span>
                    </label>
                    <div id="csv-upsert-key-container" class="hidden flex items-center gap-2">
                        <span class="text-sm text-gray-600 font-medium">æ›´æ–°ã‚­ãƒ¼:</span>
                        <select id="csv-upsert-key"
                            class="text-sm border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 min-w-[150px]">
                            <!-- JSã§å‹•çš„ã«è¿½åŠ  -->
                        </select>
                    </div>
                </div>
                <p class="text-[10px] text-indigo-500 mt-2">
                    â€» æ›´æ–°ã‚­ãƒ¼ãŒä¸€è‡´ã™ã‚‹æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆã€ãã®æƒ…å ±ã‚’æ›´æ–°ï¼ˆä¸Šæ›¸ãï¼‰ã—ã¾ã™ã€‚ä¸€è‡´ã—ãªã„å ´åˆã¯æ–°è¦ç™»éŒ²ã—ã¾ã™ã€‚
                    <br>
                    â€» ã‚·ã‚¹ãƒ†ãƒ é …ç›®ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã—ãŸé …ç›®ã‹ã‚‰ã®ã¿ã‚­ãƒ¼ã‚’é¸æŠã§ãã¾ã™ã€‚
                </p>
            </div>

            <!-- Salary Unit Settings -->
            <div class="bg-blue-50 p-4 rounded-lg mb-6 border border-blue-200">
                <h4 class="text-sm font-bold text-blue-900 mb-2">å¹´åãƒ‡ãƒ¼ã‚¿ã®å˜ä½è¨­å®š</h4>
                <div class="flex flex-wrap gap-x-6 gap-y-2">
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="csv-salary-unit" value="auto" checked
                            class="text-blue-600 focus:ring-blue-500 mr-2">
                        <span class="text-sm text-gray-700">è‡ªå‹•åˆ¤å®š (1ä¸‡æœªæº€ãªã‚‰ä¸‡å††å˜ä½ã¨ã¿ãªã™)</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="csv-salary-unit" value="man"
                            class="text-blue-600 focus:ring-blue-500 mr-2">
                        <span class="text-sm text-gray-700">å¸¸ã«ä¸‡å††å˜ä½ (ä¾‹: 500)</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="csv-salary-unit" value="yen"
                            class="text-blue-600 focus:ring-blue-500 mr-2">
                        <span class="text-sm text-gray-700">å¸¸ã«å††å˜ä½ (ä¾‹: 5000000)</span>
                    </label>
                </div>
                <p class="text-[10px] text-blue-500 mt-2">
                    â€» ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¾Œã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚·ã‚¹ãƒ†ãƒ å†…ã§ã€Œâ—â—ä¸‡å††ã€ã¨ã—ã¦çµ±ä¸€ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚
                </p>
            </div>

            <div class="overflow-x-auto mb-6">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                style="width: 20%;">
                                ã‚·ã‚¹ãƒ†ãƒ é …ç›®
                            </th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                style="width: 40%; min-width: 250px; resize: horizontal; overflow: auto;">
                                CSVåˆ—ã®é¸æŠ
                            </th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                style="width: 40%;">
                                ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (1è¡Œç›®)
                            </th>
                        </tr>
                    </thead>
                    <tbody id="csv-mapping-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Mapping rows will be inserted here -->
                    </tbody>
                </table>
            </div>

            <div class="flex justify-end gap-3">
                <button onclick="closeCSVMappingModal()"
                    class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button onclick="executeCSVImport()"
                    class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow-md">
                    ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ
                </button>
            </div>
        </div>
    </div>

    <!-- User Registration Modal -->
    <div id="user-registration-modal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900" id="user-reg-title">æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</h3>
                <button onclick="closeUserRegistrationModal()"
                    class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="user-registration-form" onsubmit="handleUserRegistration(event)">
                <input type="hidden" id="reg-role">

                <!-- Basic Info -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">åå‰ *</label>
                        <input type="text" id="reg-name" required class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ãµã‚ŠãŒãª</label>
                        <input type="text" id="reg-furigana" placeholder="ä¾‹: ã‚„ã¾ã  ãŸã‚ã†"
                            class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *</label>
                        <input type="email" id="reg-email" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ *</label>
                    <input type="password" id="reg-password" minlength="6" class="w-full px-4 py-2 border rounded-lg">
                </div>

                <!-- Role Selection (for User Management) -->
                <div id="reg-role-section" class="mb-4 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ãƒ­ãƒ¼ãƒ« *</label>
                    <select id="reg-role-select" class="w-full px-4 py-2 border rounded-lg">
                        <option value="admin">ç®¡ç†è€…</option>
                        <option value="coach">CAãƒ»RA</option>
                        <option value="candidate">æ±‚è·è€…</option>
                    </select>
                </div>

                <!-- Candidate Specific Fields -->
                <div id="reg-candidate-fields" class="hidden border-t pt-4 mt-4">
                    <h4 class="text-md font-medium text-gray-900 mb-3">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±</h4>

                    <!-- PDF Upload -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">å±¥æ­´æ›¸/è·å‹™çµŒæ­´æ›¸PDFã‹ã‚‰è‡ªå‹•å…¥åŠ›</label>
                        <div class="flex gap-2">
                            <input type="file" accept=".pdf" multiple class="hidden" id="reg-resume-upload"
                                onchange="handleRegResumeUpload(this)">
                            <button type="button" onclick="$('#reg-resume-upload').click()"
                                class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition">
                                <i class="fas fa-file-upload mr-2"></i>PDFã‚’é¸æŠ
                            </button>
                            <span id="reg-resume-filename" class="text-sm text-gray-500 flex items-center"></span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å¸Œæœ›è·ç¨®</label>
                            <select id="reg-job-type" class="w-full px-4 py-2 border rounded-lg select2" multiple
                                style="width: 100%">
                                <!-- Options will be loaded dynamically -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å¸Œæœ›æ¥­ç•Œ</label>
                            <select id="reg-industry" class="w-full px-4 py-2 border rounded-lg select2" multiple
                                style="width: 100%">
                                <!-- Options will be loaded dynamically -->
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å¸Œæœ›å‹¤å‹™åœ°</label>
                            <div class="flex gap-2">
                                <select id="reg-prefecture" class="w-1/3 px-2 py-2 border rounded-lg select2" multiple
                                    style="width: 40%">
                                </select>
                                <input type="text" id="reg-city" placeholder="å¸‚åŒºç”ºæ‘"
                                    class="w-2/3 px-4 py-2 border rounded-lg" style="width: 60%">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">å¸Œæœ›é›‡ç”¨å½¢æ…‹</label>
                                <select id="reg-employment-type" class="w-full px-4 py-2 border rounded-lg select2"
                                    multiple style="width: 100%">
                                    <!-- Options will be loaded dynamically -->
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">å¸Œæœ›å¹´åï¼ˆä¸‡å††ï¼‰</label>
                                <input type="number" id="reg-salary" class="w-full px-4 py-2 border rounded-lg">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">ã‚¹ã‚­ãƒ«</label>
                            <textarea id="reg-skills" rows="3" class="w-full px-4 py-2 border rounded-lg"></textarea>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">è·æ­´ãƒ»è‡ªå·±PR</label>
                            <textarea id="reg-history" rows="4" class="w-full px-4 py-2 border rounded-lg"></textarea>
                        </div>

                        <!-- æ§‹é€ åŒ–ã•ã‚ŒãŸè·æ­´ -->
                        <div class="mb-4 border-t border-gray-200 pt-4">
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-medium text-gray-700">è©³ç´°è·æ­´</label>
                                <button type="button" onclick="addRegWorkHistoryItem()"
                                    class="text-sm text-indigo-600 hover:text-indigo-800 flex items-center">
                                    <i class="fas fa-plus-circle mr-1"></i>è¿½åŠ 
                                </button>
                            </div>
                            <div id="reg-work-history-list" class="space-y-4 mb-2"></div>
                            <div class="flex items-center gap-4 mt-2">
                                <label class="text-xs text-gray-500">çµŒé¨“ç¤¾æ•° (è‡ªå‹•è¨ˆç®—):</label>
                                <input type="number" id="reg-job-change-count"
                                    class="w-20 px-2 py-1 border rounded bg-gray-50 text-center text-sm" readonly
                                    value="0">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">è·å‹™çµŒæ­´æ›¸ (è©³ç´°ãƒ†ã‚­ã‚¹ãƒˆ)</label>
                            <textarea id="reg-work-history-detail" rows="10"
                                class="w-full px-4 py-2 border rounded-lg text-sm font-mono bg-gray-50 focus:bg-white transition"
                                placeholder="è·å‹™çµŒæ­´ã®è©³ç´°ãƒ†ã‚­ã‚¹ãƒˆ"></textarea>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç¤¾å†…ãƒãƒƒãƒãƒ³ã‚°æƒ…å ±</label>
                            <textarea id="reg-resume-detail" rows="6"
                                class="w-full px-4 py-2 border rounded-lg text-sm font-mono bg-gray-50 focus:bg-white transition"
                                placeholder="ç¤¾å†…ãƒãƒƒãƒãƒ³ã‚°æƒ…å ±ï¼ˆã‚¹ã‚­ãƒ«ã€çµŒé¨“ã€å¸Œæœ›ã®è£œè¶³ãªã©ï¼‰"></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" onclick="closeUserRegistrationModal()"
                            class="px-4 py-2 border rounded-lg hover:bg-gray-50">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button type="submit"
                            class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">ç™»éŒ²</button>
                    </div>
            </form>
        </div>
    </div>

    <script type="module">
        // ========================
        // Supabase Configuration
        // ========================
        // ç’°å¢ƒåˆ¤å®šã¨Supabaseè¨­å®š
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.hostname === '';

        // æœ¬ç•ªç’°å¢ƒ (Production)
        const PROD_CONFIG = {
            url: 'https://npjsmoxxzlqkpopzjyyz.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5wanNtb3h4emxxa3BvcHpqeXl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzOTQ5MzYsImV4cCI6MjA3Njk3MDkzNn0.SInkweULu_GTr33JV7RCVtj4HBUfNFfK0_yrZghd38o' // (æ—¢å­˜ã®ã‚­ãƒ¼)
        };

        // é–‹ç™ºç’°å¢ƒ (Development)
        const DEV_CONFIG = {
            url: 'https://sgkhqtqdnyiliqpksiej.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNna2hxdHFkbnlpbGlxcGtzaWVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5NjU1MjIsImV4cCI6MjA4MDU0MTUyMn0.gx_E7OWW0mFwb4gCXh1NrU7pp0d-5vlL3PPSXUe-ZWE'
        };

        // ç¾åœ¨ã®ç’°å¢ƒã«åˆã‚ã›ã¦è¨­å®šã‚’é¸æŠ
        // ç¾åœ¨ã®ç’°å¢ƒã«åˆã‚ã›ã¦è¨­å®šã‚’é¸æŠ
        const config = isLocal ? DEV_CONFIG : PROD_CONFIG;

        // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
        const { createClient } = supabase
        const supabaseClient = createClient(config.url, config.key)

        // é–‹ç™ºç’°å¢ƒã®å ´åˆã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤ºï¼ˆã‚ã‹ã‚Šã‚„ã™ãã™ã‚‹ãŸã‚ï¼‰
        if (isLocal) {
            console.log('%c[Dev Mode] Connected to Development Supabase', 'color: #4f46e5; font-weight: bold; background: #e0e7ff; padding: 4px 8px; border-radius: 4px;');
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
        window.supabase = supabaseClient

        // currentUserã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦å®šç¾©
        let isInitialLoad = true;
        let currentUser = null;
        let isModalLoading = false;
        let isAImatchingResultView = false;
        let aiResultCache = {}; // userId_jobId -> details
        let pendingBulkJobs = []; // æ±‚äººä¸€æ‹¬å–ã‚Šè¾¼ã¿æ™‚ã®ç¢ºèªå¾…ã¡ãƒªã‚¹ãƒˆ
        let importResultSuccessFiles = []; // ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ
        let importResultErrorFiles = [];   // ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ

        window.showImportResult = function (successFiles, errorFiles) {
            const $modal = $('#import-result-modal');
            const $summary = $('#import-result-summary');
            const $successSection = $('#import-result-success-section');
            const $successList = $('#import-result-success-list');
            const $errorSection = $('#import-result-error-section');
            const $errorList = $('#import-result-error-list');

            $successList.empty();
            $errorList.empty();

            $summary.html(`
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-green-50 p-4 rounded-lg border border-green-100 text-center">
                        <div class="text-2xl font-bold text-green-600">${successFiles.length}</div>
                        <div class="text-xs text-green-700 font-bold">ç™»éŒ²æˆåŠŸ</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg border border-red-100 text-center">
                        <div class="text-2xl font-bold text-red-600">${errorFiles.length}</div>
                        <div class="text-xs text-red-700 font-bold">ã‚¨ãƒ©ãƒ¼</div>
                    </div>
                </div>
            `);

            if (successFiles.length > 0) {
                successFiles.forEach(f => $successList.append(`<li>${f}</li>`));
                $successSection.removeClass('hidden');
            } else {
                $successSection.addClass('hidden');
            }

            if (errorFiles.length > 0) {
                errorFiles.forEach(item => {
                    const name = typeof item === 'string' ? item : item.name;
                    const msg = typeof item === 'string' ? '' : ` (${item.message})`;
                    $errorList.append(`<li>${name}${msg}</li>`);
                });
                $errorSection.removeClass('hidden');
            } else {
                $errorSection.addClass('hidden');
            }

            $modal.removeClass('hidden');
        }
        window.prefectures = [
            "åŒ—æµ·é“", "é’æ£®çœŒ", "å²©æ‰‹çœŒ", "å®®åŸçœŒ", "ç§‹ç”°çœŒ", "å±±å½¢çœŒ", "ç¦å³¶çœŒ",
            "èŒ¨åŸçœŒ", "æ ƒæœ¨çœŒ", "ç¾¤é¦¬çœŒ", "åŸ¼ç‰çœŒ", "åƒè‘‰çœŒ", "æ±äº¬éƒ½", "ç¥å¥ˆå·çœŒ",
            "æ–°æ½ŸçœŒ", "å¯Œå±±çœŒ", "çŸ³å·çœŒ", "ç¦äº•çœŒ", "å±±æ¢¨çœŒ", "é•·é‡çœŒ", "å²é˜œçœŒ",
            "é™å²¡çœŒ", "æ„›çŸ¥çœŒ", "ä¸‰é‡çœŒ", "æ»‹è³€çœŒ", "äº¬éƒ½åºœ", "å¤§é˜ªåºœ", "å…µåº«çœŒ",
            "å¥ˆè‰¯çœŒ", "å’Œæ­Œå±±çœŒ", "é³¥å–çœŒ", "å³¶æ ¹çœŒ", "å²¡å±±çœŒ", "åºƒå³¶çœŒ", "å±±å£çœŒ",
            "å¾³å³¶çœŒ", "é¦™å·çœŒ", "æ„›åª›çœŒ", "é«˜çŸ¥çœŒ", "ç¦å²¡çœŒ", "ä½è³€çœŒ", "é•·å´çœŒ",
            "ç†Šæœ¬çœŒ", "å¤§åˆ†çœŒ", "å®®å´çœŒ", "é¹¿å…å³¶çœŒ", "æ²–ç¸„çœŒ"
        ];

        // AIæ¨è–¦å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£
        let selectedTargetUserId = null;
        let selectedTargetUserName = null;
        let selectedTargetUserEmail = null;
        let allCandidateUsers = []; // å€™è£œãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆï¼ˆç®¡ç†è€…ãƒ»ã‚³ãƒ¼ãƒç”¨ï¼‰
        let shouldReloadCandidates = false; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ãƒ•ãƒ©ã‚°


        // ========================
        // Master Data Logic with Caching
        // ========================
        let masterIndustries = [];
        let masterJobCategories = [];
        let masterSelectionStatuses = [];

        // ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        const masterDataCache = {
            employmentTypes: null,
            industries: null,
            jobCategories: null,
            selectionStatuses: null,
            lastUpdated: null,
            cacheDuration: 30 * 60 * 1000, // 30åˆ†

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
            isValid() {
                if (!this.lastUpdated) return false;
                const now = Date.now();
                return (now - this.lastUpdated) < this.cacheDuration;
            },

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
            clear() {
                this.employmentTypes = null;
                this.industries = null;
                this.jobCategories = null;
                this.selectionStatuses = null;
                this.lastUpdated = null;
                console.log('Master data cache cleared');
            },

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
            update(data) {
                this.employmentTypes = data.employmentTypes;
                this.industries = data.industries;
                this.jobCategories = data.jobCategories;
                this.selectionStatuses = data.selectionStatuses;
                this.lastUpdated = Date.now();
                console.log('Master data cache updated');
            }
        };

        async function initMasterDataDropdowns() {
            if (!currentUser) {
                console.warn('initMasterDataDropdowns called but currentUser is null');
                return;
            }

            try {
                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæœ‰åŠ¹ãªå ´åˆã¯å†åˆ©ç”¨
                if (masterDataCache.isValid()) {
                    console.log('Using cached master data');
                    masterIndustries = masterDataCache.industries;
                    masterJobCategories = masterDataCache.jobCategories;
                    masterSelectionStatuses = masterDataCache.selectionStatuses;
                } else {
                    console.log('Fetching master data from database');

                    // master_data ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰æ¥­ç•Œã¨è·ç¨®ã‚’å–å¾—
                    const { data: masters, error } = await supabase
                        .from('master_data')
                        .select('type, label, value, organization_id, sort_order') // å¿…è¦ãªã‚«ãƒ©ãƒ ã®ã¿å–å¾—
                        .in('type', ['industry_category', 'job_category', 'selection_status'])
                        .eq('is_active', true)
                        .order('sort_order');

                    if (error) throw error;

                    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ« ã¾ãŸã¯ è‡ªç¤¾ç”¨ï¼‰
                    const validMasters = masters.filter(m =>
                        m.organization_id === null || m.organization_id === currentUser.organization_id
                    );

                    // æ¥­ç•Œãƒã‚¹ã‚¿
                    masterIndustries = [...new Set(validMasters
                        .filter(m => m.type === 'industry_category')
                        .map(m => m.label))];

                    // è·ç¨®ãƒã‚¹ã‚¿
                    masterJobCategories = [...new Set(validMasters
                        .filter(m => m.type === 'job_category')
                        .map(m => m.label))];

                    // é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚¹ã‚¿
                    masterSelectionStatuses = validMasters
                        .filter(m => m.type === 'selection_status');

                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
                    masterDataCache.update({
                        industries: masterIndustries,
                        jobCategories: masterJobCategories,
                        selectionStatuses: masterSelectionStatuses
                    });
                }

                // å„ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®åˆæœŸåŒ–ï¼ˆæ¤œç´¢ç”»é¢ãªã©ã€å¸¸ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ï¼‰
                populateSelectOptions('search-industry-category', masterIndustries);
                populateSelectOptions('search-job-category', masterJobCategories);

                // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»é¢ãªã©ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚‚åˆæœŸåŒ–ï¼ˆå­˜åœ¨ã™ã‚Œã°ï¼‰
                populateSelectOptions('profile-industry', masterIndustries);
                populateSelectOptions('profile-job-type', masterJobCategories);
                populateSelectOptions('company-industry', masterIndustries);
                populateSelectOptions('job-industry-category', masterIndustries);
                populateSelectOptions('job-category', masterJobCategories);

                // ç®¡ç†è€…ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚‚æ›´æ–°
                populateSelectOptions('admin-user-industry', masterIndustries);
                populateSelectOptions('admin-user-job-type', masterJobCategories);

                // Select2ã®é©ç”¨ãƒ»å†é©ç”¨ï¼ˆæ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ç”¨ï¼‰
                // closeOnSelect: false ã«ã‚ˆã‚Šã€è¤‡æ•°é¸æŠæ™‚ã«é–‰ã˜ãªãã™ã‚‹
                const searchSelects = $('#search-job-category, #search-industry-category, #search-employment-type, #search-prefecture');
                searchSelects.each(function () {
                    if ($(this).hasClass("select2-hidden-accessible")) {
                        $(this).select2('destroy');
                    }
                });
                searchSelects.select2({
                    closeOnSelect: false,
                    width: '100%',
                    allowClear: true,
                    placeholder: 'é¸æŠã—ã¦ãã ã•ã„'
                });

                // è·æ­´å…¥åŠ›ç”¨ã®datalistã‚’æ›´æ–°
                updateWorkHistoryDatalists();

            } catch (error) {
                console.error('Error loading master data:', error);
            }
        }

        // è·ç¨®ãƒã‚¹ã‚¿ä¸€æ‹¬æ›´æ–°ç”¨é–¢æ•°
        window.updateJobCategoriesMaster = async function () {
            if (!currentUser || !currentUser.organization_id) {
                alert('çµ„ç¹”æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
                return;
            }
            if (currentUser.role !== 'super_admin') {
                alert('ã“ã®æ“ä½œã¯ã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…ã®ã¿å¯èƒ½ã§ã™ã€‚');
                return;
            }
            if (!confirm('è‡ªçµ„ç¹”ã®è·ç¨®ãƒã‚¹ã‚¿ã‚’åˆæœŸåŒ–ã—ã¦ã€æ–°ã—ã„ãƒªã‚¹ãƒˆã§æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ\næ—¢å­˜ã®è·ç¨®ã‚«ãƒ†ã‚´ãƒªã¯å…¨ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) return;

            const newJobCategories = [
                "ãã®ä»–å–¶æ¥­ç³»",
                "æ³•äººå–¶æ¥­ (BtoB)",
                "å€‹äººå–¶æ¥­ (BtoC)",
                "æµ·å¤–å–¶æ¥­",
                "ä»£ç†åº—å–¶æ¥­",
                "MR (åŒ»è–¬æƒ…å ±æ‹…å½“è€…)",
                "å–¶æ¥­ä¼ç”»ãƒ»å–¶æ¥­ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ",
                "ãã®ä»–ä¼ç”»ãƒ»ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ç³»",
                "çµŒå–¶ä¼ç”»ãƒ»äº‹æ¥­ä¼ç”»",
                "å•†å“ä¼ç”»ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ä¼ç”»",
                "ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ãƒ»è²©ä¿ƒ",
                "åºƒå ±ãƒ»PRãƒ»IR",
                "Webãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ãƒ»ãƒ‡ã‚¸ã‚¿ãƒ«ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°",
                "ãã®ä»–äº‹å‹™ãƒ»ç®¡ç†ç³»",
                "äººäº‹ãƒ»åŠ´å‹™",
                "çµŒç†ãƒ»è²¡å‹™ãƒ»ä¼šè¨ˆ",
                "æ³•å‹™ãƒ»ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹",
                "ç·å‹™",
                "ç§˜æ›¸ãƒ»å—ä»˜",
                "ä¸€èˆ¬äº‹å‹™ãƒ»å–¶æ¥­äº‹å‹™",
                "ãã®ä»–ITã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ç³»",
                "ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ (SE)",
                "ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼ (PG)",
                "Webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰/ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼‰",
                "ã‚¤ãƒ³ãƒ•ãƒ©ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ï¼ˆã‚µãƒ¼ãƒãƒ¼/ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼‰",
                "ç¤¾å†…SE",
                "ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚¨ãƒ³ãƒ†ã‚£ã‚¹ãƒˆãƒ»ã‚¢ãƒŠãƒªã‚¹ãƒˆ",
                "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ (PM)",
                "ITã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ",
                "å“è³ªç®¡ç†ãƒ»ãƒ†ã‚¹ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢",
                "ãã®ä»–ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ç³»",
                "Webãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ãƒ»UI/UXãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼",
                "ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼",
                "Webãƒ‡ã‚£ãƒ¬ã‚¯ã‚¿ãƒ¼ãƒ»ãƒ—ãƒ­ãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼",
                "ç·¨é›†ãƒ»ãƒ©ã‚¤ã‚¿ãƒ¼ãƒ»ã‚³ãƒ”ãƒ¼ãƒ©ã‚¤ã‚¿ãƒ¼",
                "ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ï¼ˆãƒ—ãƒ©ãƒ³ãƒŠãƒ¼/ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼/ã‚·ãƒŠãƒªã‚ªãƒ©ã‚¤ã‚¿ãƒ¼ï¼‰",
                "æ˜ åƒãƒ»éŸ³éŸ¿ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼",
                "ãã®ä»–æŠ€è¡“ãƒ»è£½é€ ç³»",
                "ç ”ç©¶ãƒ»é–‹ç™º (R&D)",
                "è¨­è¨ˆãƒ»é–‹ç™ºï¼ˆæ©Ÿæ¢°/é›»æ°—/é›»å­ï¼‰",
                "ç”Ÿç”£æŠ€è¡“ãƒ»è£½é€ æŠ€è¡“",
                "å“è³ªç®¡ç†ãƒ»å“è³ªä¿è¨¼",
                "ç”Ÿç”£ç®¡ç†ãƒ»å·¥ç¨‹ç®¡ç†",
                "è³¼è²·ãƒ»èª¿é”",
                "ãã®ä»–è²©å£²ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ç³»",
                "è²©å£²ãƒ»æ¥å®¢ã‚¹ã‚¿ãƒƒãƒ•",
                "åº—é•·ãƒ»ã‚¨ãƒªã‚¢ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼",
                "ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒã‚¤ã‚¶ãƒ¼ (SV)",
                "ã‚«ã‚¹ã‚¿ãƒãƒ¼ã‚µãƒãƒ¼ãƒˆãƒ»ã‚³ãƒ¼ãƒ«ã‚»ãƒ³ã‚¿ãƒ¼",
                "ãƒ›ãƒ†ãƒ«ãƒ»æ—…è¡Œé–¢é€£ã‚¹ã‚¿ãƒƒãƒ•",
                "é£²é£Ÿåº—ã‚¹ã‚¿ãƒƒãƒ•",
                "ãã®ä»–ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆãƒ»å°‚é–€è·ç³»",
                "æˆ¦ç•¥ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ",
                "ITã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ",
                "è²¡å‹™ãƒ»ä¼šè¨ˆã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ",
                "äººäº‹ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ",
                "é‡‘èå°‚é–€è·ï¼ˆã‚¢ãƒŠãƒªã‚¹ãƒˆã€ãƒ•ã‚¡ãƒ³ãƒ‰ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ç­‰ï¼‰",
                "å£«æ¥­ï¼ˆå¼è­·å£«ã€ä¼šè¨ˆå£«ã€ç¨ç†å£«ã€å¼ç†å£«ãªã©ï¼‰",
                "ãã®ä»–åŒ»ç™‚ãƒ»ç¦ç¥‰ãƒ»æ•™è‚²ç³»",
                "åŒ»å¸«ãƒ»çœ‹è­·å¸«ãƒ»è–¬å‰¤å¸«",
                "åŒ»ç™‚æŠ€è¡“è€…ï¼ˆè‡¨åºŠæ¤œæŸ»æŠ€å¸«ãªã©ï¼‰",
                "ä»‹è­·ç¦ç¥‰å£«ãƒ»ã‚±ã‚¢ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼",
                "æ•™å¸«ãƒ»è¬›å¸«ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼",
                "ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼",
                "ã‚­ãƒ£ãƒªã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ã‚¿ãƒ¼",
                "äººæç³»å–¶æ¥­",
                "ã‚­ãƒ£ãƒªã‚¢ã‚³ãƒ¼ãƒ",
                "ãã®ä»–"
            ];

            try {
                // 1. æ—¢å­˜ã®è·ç¨®ã‚«ãƒ†ã‚´ãƒªã‚’å‰Šé™¤ (è‡ªçµ„ç¹”ã®ã¿å¯¾è±¡)
                const { error: deleteError } = await supabase
                    .from('master_data')
                    .delete()
                    .eq('type', 'job_category')
                    .eq('organization_id', currentUser.organization_id);

                if (deleteError) throw deleteError;

                // 2. æ–°ã—ã„è·ç¨®ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ 
                const insertData = newJobCategories.map((label, index) => ({
                    type: 'job_category',
                    label: label,
                    value: label,
                    sort_order: (index + 1) * 10,
                    is_active: true,
                    organization_id: currentUser.organization_id
                }));

                const { error: insertError } = await supabase
                    .from('master_data')
                    .insert(insertData);

                if (insertError) throw insertError;

                alert('è·ç¨®ãƒã‚¹ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚ç”»é¢ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
                location.reload();

            } catch (error) {
                console.error('Error updating job categories:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚¹ã‚¿ä¸€æ‹¬æ›´æ–°ç”¨é–¢æ•°
        window.updateSelectionStatusMaster = async function () {
            if (!currentUser || !currentUser.organization_id) {
                alert('çµ„ç¹”æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
                return;
            }
            if (currentUser.role !== 'super_admin') {
                alert('ã“ã®æ“ä½œã¯ã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…ã®ã¿å¯èƒ½ã§ã™ã€‚');
                return;
            }
            if (!confirm('è‡ªçµ„ç¹”ã®é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚¹ã‚¿ã‚’åˆæœŸåŒ–ã—ã¦ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ\næ—¢å­˜ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨­å®šã¯å…¨ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) return;

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å®šç¾©
            const defaultStatuses = [
                { value: 'pending', label: 'æ›¸é¡é¸è€ƒä¸­', sort_order: 10 },
                { value: 'screening', label: 'æ›¸é¡é¸è€ƒä¸­(å¯©æŸ»ä¸­)', sort_order: 20 },
                { value: 'interview', label: 'é¢æ¥äºˆå®š', sort_order: 30 },
                { value: 'offered', label: 'å†…å®š', sort_order: 40 },
                { value: 'rejected', label: 'ä¸åˆæ ¼', sort_order: 50 },
                { value: 'withdrawn', label: 'è¾é€€', sort_order: 60 }
            ];

            try {
                // 1. æ—¢å­˜ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å‰Šé™¤ (è‡ªçµ„ç¹”ã®ã¿å¯¾è±¡)
                const { error: deleteError } = await supabase
                    .from('master_data')
                    .delete()
                    .eq('type', 'selection_status')
                    .eq('organization_id', currentUser.organization_id);

                if (deleteError) throw deleteError;

                // 2. æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¿½åŠ 
                const insertData = defaultStatuses.map(status => ({
                    type: 'selection_status',
                    label: status.label,
                    value: status.value,
                    sort_order: status.sort_order,
                    is_active: true,
                    organization_id: currentUser.organization_id
                }));

                const { error: insertError } = await supabase
                    .from('master_data')
                    .insert(insertData);

                if (insertError) throw insertError;

                alert('é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚¹ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚ç”»é¢ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
                location.reload();

            } catch (error) {
                console.error('Error updating selection statuses:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒã‚¹ã‚¿ä¸€æ‹¬æ›´æ–°ç”¨é–¢æ•°
        window.updatePromptMaster = async function () {
            if (!currentUser || !currentUser.organization_id) {
                alert('çµ„ç¹”æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
                return;
            }
            if (currentUser.role !== 'super_admin') {
                alert('ã“ã®æ“ä½œã¯ã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…ã®ã¿å¯èƒ½ã§ã™ã€‚');
                return;
            }
            if (!confirm('è‡ªçµ„ç¹”ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒã‚¹ã‚¿ã‚’åˆæœŸåŒ–ã—ã¦ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ\næ—¢å­˜ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šã¯å…¨ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) return;

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®šç¾©ï¼ˆloadPromptsã‹ã‚‰ã‚³ãƒ”ãƒ¼ï¼‰
            const defaultScoring = `
ã‚ãªãŸã¯æ¸©ã‹ã¿ã®ã‚ã‚‹è»¢è·æ”¯æ´ã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã§ã‚ã‚Šã€ä¼æ¥­æ–‡åŒ–ã¨äººæã®ãƒ•ã‚£ãƒƒãƒˆåˆ†æã®å°‚é–€å®¶ã§ã™ã€‚
ä»¥ä¸‹ã®æ±‚äººã¨æ±‚è·è€…æƒ…å ±ã‹ã‚‰ã€ãƒãƒƒãƒåº¦ã‚’åˆ†æã—ã€**æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ã¿**ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚
åˆ†æã®è©³ç´°ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆã€Œ1.è·å‹™çµŒæ­´ã®ãƒãƒƒãƒåº¦ã€ãªã©ï¼‰ã¯ä¸€åˆ‡å‡ºåŠ›ã›ãšã€çµæœã®ã¿ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚

ã€æ±‚è·è€…æƒ…å ±ã€‘
- åŸºæœ¬æƒ…å ±: å¹´é½¢ \${userData.age} / å¸Œæœ›å¹´å \${userData.desired_salary}
- å¸Œæœ›æ¡ä»¶: \${userData.desired_industry} / \${userData.desired_job_type} / \${userData.desired_location}
- æœªçµŒé¨“OKã®å¸Œæœ›: è·ç¨®[\${userProfile.desired_job_experience_ok ? 'ã¯ã„' : 'ã„ã„ãˆ'}] / æ¥­ç¨®[\${userProfile.desired_industry_experience_ok ? 'ã¯ã„' : 'ã„ã„ãˆ'}]
- ã‚¹ã‚­ãƒ«ãƒ»PRãƒ»å‚™è€ƒ: \${userData.notes}
- å±¥æ­´æ›¸/çµŒæ­´æ›¸: \${userData.resume}
- è·å‹™çµŒæ­´è©³ç´°: \${userData.work_history}
- ç¤¾å†…ãƒãƒƒãƒãƒ³ã‚°æƒ…å ±: \${userData.matching_info}
- ç¤¾å†…ãƒ¡ãƒ¢ãƒ»å…±æœ‰äº‹é …: \${userData.internal_info}
- ãã®ä»–è£œè¶³: \${userData.other_info}

ã€æ±‚äººæƒ…å ±ã€‘
- ä¼æ¥­å: \${jobDetails.company}
- è·ç¨®: \${jobDetails.title}
- æ¥­ç¨®: \${jobDetails.industrycategory}
- è·ç¨®ã‚«ãƒ†ã‚´ãƒª: \${jobDetails.jobcategory}
- çµ¦ä¸: \${jobDetails.salary}
- å‹¤å‹™åœ°: \${jobDetails.location}
- é›‡ç”¨å½¢æ…‹: \${jobDetails.employment_type}
- æ¥­å‹™å†…å®¹: \${jobDetails.description}
- å¿…é ˆã‚¹ã‚­ãƒ«: \${jobDetails.qualifications}
- ä¼æ¥­æ–‡åŒ–ãƒ»ç‰¹å¾´: \${jobDetails.company_info}

ã€é‡è¦ï¼šä¼æ¥­æ–‡åŒ–ã®åˆ†æã«ã¤ã„ã¦ã€‘
ãƒ»ä¼æ¥­æƒ…å ±ã®ä¸è¶³ã‚„æ·±ã„åˆ†æãŒå¿…è¦ãªå ´åˆã¯ã€ä¼æ¥­åï¼ˆ\${jobDetails.company}ï¼‰ã«åŸºã¥ãã€Webæ¤œç´¢æ©Ÿèƒ½ã‚’æ´»ç”¨ã—ã¦å®Ÿéš›ã®ã‚¯ãƒã‚³ãƒŸã‚„çµŒå–¶ç†å¿µã‚’è£œå®Œã—ã¦ãã ã•ã„ã€‚

---
ã€å‡ºåŠ›ã«ãŠã‘ã‚‹çµ¶å¯¾éµå®ˆã®åˆ¶ç´„ã€‘
1. åˆ†æã®è©³ç´°ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆã€Œ1.è·å‹™çµŒæ­´ã®ãƒãƒƒãƒåº¦ã€ãªã©ã®åŒºåˆ†ã‘ã‚„èª¬æ˜ï¼‰ã¯çµ¶å¯¾ã«æ›¸ãå‡ºã•ãªã„ã§ãã ã•ã„ã€‚
2. æŒ‡å®šã•ã‚ŒãŸãƒ©ãƒ™ãƒ«ï¼ˆã€Œè©•ä¾¡: ã€ã€Œç†ç”±: ã€ç­‰ï¼‰ä»¥å¤–ã§å§‹ã¾ã‚‹æ–‡ç« ã‚’å‡ºåŠ›ã—ãªã„ã§ãã ã•ã„ã€‚
3. Markdownè¨˜å·ï¼ˆ#ã€*ã€**ã€> ç­‰ï¼‰ã¯ä½¿ç”¨ç¦æ­¢ã§ã™ã€‚
4. å„é …ç›®ã®æ–‡å­—æ•°åˆ¶é™ã‚’1æ–‡å­—ã§ã‚‚è¶…ãˆãªã„ã§ãã ã•ã„ã€‚
5. ç†ç”±ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã¯æ”¹è¡Œã›ãšã€ãã‚Œãã‚Œ1æ–‡ï¼ˆ80æ–‡å­—ä»¥å†…/60æ–‡å­—ä»¥å†…ï¼‰ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚

å›ç­”å½¢å¼ï¼š

è©•ä¾¡: [ãƒ©ãƒ³ã‚¯A-Eã‚’1æ–‡å­—]
ç†ç”±: [80æ–‡å­—ä»¥å†…ã§ç°¡æ½”ã«ã€‚æ”¹è¡Œã›ãš1æ–‡ã§è¨˜è¿°]

ç·åˆè©•ä¾¡: [æ•°å€¤]ç‚¹

ãƒãƒƒãƒã™ã‚‹ç‚¹
ãƒ»[è¦ç‚¹ã€‚30æ–‡å­—ä»¥å†…]
ãƒ»[è¦ç‚¹ã€‚30æ–‡å­—ä»¥å†…]

ä»Šå¾Œã®ã•ã‚‰ãªã‚‹æˆé•·ãƒ»æŒ‘æˆ¦ãŒæœŸå¾…ã•ã‚Œã‚‹ç‚¹
ãƒ»[è¦ç‚¹ã€‚30æ–‡å­—ä»¥å†…]
ãƒ»[è¦ç‚¹ã€‚30æ–‡å­—ä»¥å†…]

ã‚¢ãƒ‰ãƒã‚¤ã‚¹
[60æ–‡å­—ä»¥å†…ã€‚æ”¹è¡Œã›ãš1æ–‡ã§è¨˜è¿°]
`;

            const defaultReason = `
ã‚ãªãŸã¯æ¸©ã‹ã¿ã®ã‚ã‚‹ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã§ã™ã€‚
ä»¥ä¸‹ã®æ±‚è·è€…ã«å¯¾ã—ã¦ã€ã“ã®æ±‚äººã‚’ç´¹ä»‹ã™ã‚‹ç†ç”±ã‚’300æ–‡å­—ç¨‹åº¦ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚
æ±‚è·è€…ã®ã“ã‚Œã¾ã§ã®çµŒé¨“ã‚„å¼·ã¿ã‚’å°Šé‡ã—ã€ãã‚Œã‚‰ãŒæ±‚äººã®ç‰¹å¾´ã‚„ä¼æ¥­ã®é­…åŠ›ã¨ã©ã®ã‚ˆã†ã«çµã³ã¤ãã‹ã‚’ã€ãƒã‚¸ãƒ†ã‚£ãƒ–ã‹ã¤é­…åŠ›çš„ã«ä¼ãˆã¦ãã ã•ã„ã€‚

ã€æ±‚è·è€…æƒ…å ±ã€‘
- åŸºæœ¬æƒ…å ±: å¹´é½¢ \${userData.age} / å¸Œæœ›å¹´å \${userData.desired_salary}
- å¸Œæœ›æ¡ä»¶: \${userData.desired_industry} / \${userData.desired_job_type}
- ã‚¹ã‚­ãƒ«ãƒ»PR: \${userData.notes}
- å±¥æ­´æ›¸/çµŒæ­´æ›¸: \${userData.resume}
- è·å‹™çµŒæ­´è©³ç´°: \${userData.work_history}
- ç¤¾å†…ãƒãƒƒãƒãƒ³ã‚°æƒ…å ±: \${userData.matching_info}

ã€æ±‚äººæƒ…å ±ã€‘
- ä¼æ¥­å: \${jobDetails.company}
- è·ç¨®: \${jobDetails.title}
- é­…åŠ›ãƒ»æ¥­å‹™å†…å®¹: \${jobDetails.description}

æ§‹æˆ:
1. æŒ¨æ‹¶ã¨ç´¹ä»‹ã®æ„å›³
2. æ±‚è·è€…ã®å¼·ã¿ã¨æ±‚äººã®æ¥ç‚¹
3. ã“ã®æ±‚äººã«æŒ‘æˆ¦ã™ã‚‹ãƒ¡ãƒªãƒƒãƒˆãƒ»æˆé•·å¯èƒ½æ€§
4. æ¸©ã‹ã„å¿œæ´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
`;

            const defaultRecommendationLetter = `
ã‚ãªãŸã¯äººæç´¹ä»‹ä¼šç¤¾ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®æ±‚è·è€…ã‚’ä¼æ¥­ã«æ¨è–¦ã™ã‚‹ãŸã‚ã®æ¨è–¦æ–‡ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
400-600æ–‡å­—ç¨‹åº¦ã§ã€ä»¥ä¸‹ã®æ§‹æˆã§ä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€æ±‚è·è€…æƒ…å ±ã€‘
- æ°å: \${userData.name}
- å¹´é½¢: \${userData.age}
- ç¾è·: \${userData.current_position || 'N/A'}
- ã‚¹ã‚­ãƒ«ãƒ»çµŒé¨“: \${userData.notes}
- ã‚¢ãƒ”ãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒˆ: \${userData.self_pr || 'N/A'}

ã€å¿œå‹Ÿå…ˆä¼æ¥­ãƒ»æ±‚äººã€‘
- ä¼æ¥­å: \${jobDetails.company}
- è·ç¨®: \${jobDetails.title}

æ§‹æˆ:
1. å†’é ­ã®æŒ¨æ‹¶
2. æ±‚è·è€…ã®å¼·ã¿ã¨å®Ÿç¸¾
3. æ±‚äººã¨ã®ãƒãƒƒãƒãƒ³ã‚°ç†ç”±
4. æ¨è–¦ã®çµã³
`;

            const defaultScoutMessage = `
ã‚ãªãŸã¯ä¼æ¥­ã®æ¡ç”¨æ‹…å½“è€…ã§ã™ã€‚ä»¥ä¸‹ã®æ±‚è·è€…ã«å¯¾ã—ã¦ã€é­…åŠ›çš„ãªã‚¹ã‚«ã‚¦ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€æ±‚è·è€…æƒ…å ±ã€‘
- æ°å: \${candidateName}
- ç¾è·: \${currentPosition}
- ã‚¹ã‚­ãƒ«ãƒ»çµŒé¨“: \${skills}
- å¸Œæœ›æ¡ä»¶: \${desiredConditions}

ã€è‡ªç¤¾ãƒ»æ±‚äººæƒ…å ±ã€‘
- ä¼æ¥­å: \${companyName}
- è·ç¨®: \${jobTitle}
- æ¥­å‹™å†…å®¹: \${jobDescription}
- é­…åŠ›: \${companyStrengths}
- å¾…é‡: \${benefits}

ä»¥ä¸‹ã®æ§‹æˆã§ã€300-500æ–‡å­—ç¨‹åº¦ã®ã‚¹ã‚«ã‚¦ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š

1. æ±‚è·è€…ã¸ã®æ•¬æ„ã¨é–¢å¿ƒã®è¡¨æ˜
2. è‡ªç¤¾ãƒ»æ±‚äººã®é­…åŠ›
3. æ±‚è·è€…ã®ã‚¹ã‚­ãƒ«ã¨ã®ãƒãƒƒãƒãƒ³ã‚°
4. é¢è«‡ãƒ»å¿œå‹Ÿã¸ã®èª˜å°
`;

            const prompts = [
                { key: 'ai_matching_scoring', label: defaultScoring.trim() },
                { key: 'ai_recommendation_reason', label: defaultReason.trim() },
                { key: 'recommendation_letter', label: defaultRecommendationLetter.trim() },
                { key: 'scout_message', label: defaultScoutMessage.trim() }
            ];

            try {
                // 1. æ—¢å­˜ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—ï¼ˆã‚ã‚Œã°ä¸Šæ›¸ãï¼‰
                const { data: systemPrompts } = await supabase
                    .from('system_prompts')
                    .select('*')
                    .in('key', prompts.map(p => p.key));

                if (systemPrompts && systemPrompts.length > 0) {
                    systemPrompts.forEach(sp => {
                        const target = prompts.find(p => p.key === sp.key);
                        if (target) {
                            target.label = sp.content; // system_promptsã®å†…å®¹ã‚’å„ªå…ˆ
                        }
                    });
                }

                // 2. æ—¢å­˜ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒã‚¹ã‚¿ã‚’å‰Šé™¤ (è‡ªçµ„ç¹”ã®ã¿å¯¾è±¡)
                const { error: deleteError } = await supabase
                    .from('master_data')
                    .delete()
                    .eq('type', 'prompt')
                    .eq('organization_id', currentUser.organization_id);

                if (deleteError) throw deleteError;

                // 3. æ–°ã—ã„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
                const insertData = prompts.map((p, index) => ({
                    type: 'prompt',
                    label: p.label, // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ¬æ–‡
                    value: p.key,   // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚­ãƒ¼
                    sort_order: (index + 1) * 10,
                    is_active: true,
                    organization_id: currentUser.organization_id
                }));

                const { error: insertError } = await supabase
                    .from('master_data')
                    .insert(insertData);

                if (insertError) throw insertError;

                alert('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒã‚¹ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚ç”»é¢ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
                location.reload();

            } catch (error) {
                console.error('Error updating prompts:', error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // AI Search Assistant UI Control
        window.toggleAISearch = function (type) {
            const boxId = type === 'job' ? '#job-ai-search-box' : '#candidate-ai-search-box';
            const $box = $(boxId);

            if ($box.hasClass('disabled')) return;

            $box.toggleClass('collapsed');
        }

        window.updateAISearchState = function (type, count) {
            const boxId = type === 'job' ? '#job-ai-search-box' : '#candidate-ai-search-box';
            const promptId = type === 'job' ? '#search-ai-prompt' : '#c-search-ai-prompt';
            const $box = $(boxId);

            console.log(`Updating AI search state for ${type}: count=${count}`);

            if (count > 0 && count < 500) {
                $box.removeClass('disabled');
            } else {
                $box.addClass('disabled');
                $box.addClass('collapsed');
            }
        }

        window.toggleAdvancedFilters = function () {
            const $container = $('#advanced-filters-body');
            const $btn = $('#toggle-advanced-filters');
            const isCollapsed = $container.hasClass('collapsed');

            if (isCollapsed) {
                $container.removeClass('collapsed');
                $btn.addClass('active');
                $btn.find('span').text('é–‰ã˜ã‚‹');
            } else {
                $container.addClass('collapsed');
                $btn.removeClass('active');
                $btn.find('span').text('è©³ç´°æ¡ä»¶');
            }
        }




        function populateSelectOptions(elementId, options, selectedValue = null) {
            const select = document.getElementById(elementId);
            if (!select) return;

            const currentVal = selectedValue || select.value;

            // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆæœ€åˆã®1ã¤ç›®ï¼ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠè‚¢ãªã©ï¼‰ã‚’ä¿æŒã™ã‚‹ã‹ã€
            // ã‚ã‚‹ã„ã¯ data-default-text å±æ€§ãªã©ã§ç®¡ç†ã™ã‚‹ã‹ã€‚
            // ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€æœ€åˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆvalue=""ã®ã‚‚ã®ï¼‰ã ã‘æ®‹ã—ã¦ä»–ã‚’å‰Šé™¤ã™ã‚‹
            const defaultOption = select.querySelector('option[value=""]');
            select.innerHTML = '';
            if (defaultOption) {
                select.appendChild(defaultOption);
            } else {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãŒãªã„å ´åˆã¯è¿½åŠ ã—ã¦ãŠã
                const opt = document.createElement('option');
                opt.value = "";
                opt.text = "é¸æŠã—ã¦ãã ã•ã„";
                select.appendChild(opt);
            }

            // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ 
            options.forEach(optVal => {
                const opt = document.createElement('option');
                opt.value = optVal;
                opt.text = optVal;
                select.appendChild(opt);
            });

            // é¸æŠå€¤ã®ã‚»ãƒƒãƒˆ
            if (currentVal) {
                // ãƒã‚¹ã‚¿ã«ãªã„å€¤ã®å ´åˆã€ä¸€æ™‚çš„ã«è¿½åŠ ã™ã‚‹
                if (!options.includes(currentVal)) {
                    const opt = document.createElement('option');
                    opt.value = currentVal;
                    opt.text = currentVal; // (æœªç™»éŒ²) ãªã©ã‚’ã¤ã‘ã¦ã‚‚ã„ã„ãŒã€ãã®ã¾ã¾è¡¨ç¤º
                    select.appendChild(opt);
                }
                select.value = currentVal;
            }
        }

        // è·æ­´å…¥åŠ›ç”¨ã®datalistã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateWorkHistoryDatalists() {
            // æ¥­ç•Œãƒªã‚¹ãƒˆ
            let industryDatalist = $('#master-industry-list');
            if (industryDatalist.length === 0) {
                if ($('body').length > 0) {
                    $('body').append('<datalist id="master-industry-list"></datalist>');
                } else {
                    return; // Body not ready
                }
                industryDatalist = $('#master-industry-list');
            }
            industryDatalist.empty();
            if (typeof masterIndustries !== 'undefined' && Array.isArray(masterIndustries)) {
                masterIndustries.forEach(item => {
                    industryDatalist.append(`<option value="${item}">`);
                });
            }

            // è·ç¨®ãƒªã‚¹ãƒˆ
            let jobDatalist = $('#master-job-category-list');
            if (jobDatalist.length === 0) {
                if ($('body').length > 0) {
                    $('body').append('<datalist id="master-job-category-list"></datalist>');
                } else {
                    return;
                }
                jobDatalist = $('#master-job-category-list');
            }
            jobDatalist.empty();
            if (typeof masterJobCategories !== 'undefined' && Array.isArray(masterJobCategories)) {
                masterJobCategories.forEach(item => {
                    jobDatalist.append(`<option value="${item}">`);
                });
            }
        }

        // Select2åˆæœŸåŒ–ç®¡ç†
        const select2InitializedElements = new Set();

        function initializeSelect2(selector, options = {}) {
            const $element = $(selector);
            if ($element.length === 0) return;

            const elementId = $element.attr('id') || selector;

            // æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if (select2InitializedElements.has(elementId)) {
                return;
            }

            const defaultOptions = {
                language: "ja",
                width: 'resolve',
                ...options
            };

            $element.select2(defaultOptions);
            select2InitializedElements.add(elementId);
        }

        function destroySelect2(selector) {
            const $element = $(selector);
            if ($element.length === 0) return;

            const elementId = $element.attr('id') || selector;

            if (select2InitializedElements.has(elementId)) {
                $element.select2('destroy');
                select2InitializedElements.delete(elementId);
            }
        }

        function reinitializeSelect2(selector, options = {}) {
            destroySelect2(selector);
            initializeSelect2(selector, options);
        }

        function showLoading(message = 'èª­ã¿è¾¼ã¿ä¸­...') {
            $('#loading-message').text(message);
            $('#loading-overlay').removeClass('hidden')
        }
        window.showLoading = showLoading;

        function hideLoading() {
            $('#loading-overlay').addClass('hidden')
        }
        window.hideLoading = hideLoading;

        function showError(elementId, message) {
            $(`#${elementId}`).text(message).removeClass('hidden')
        }

        function hideError(elementId) {
            $(`#${elementId}`).addClass('hidden')
        }

        // ========================
        // Lazy Loading Management
        // ========================
        const loadedPages = new Set();

        // ç”»åƒã®Lazy Loading
        function initImageLazyLoading() {
            // Intersection Observer ã‚’ä½¿ç”¨ã—ãŸç”»åƒã®é…å»¶èª­ã¿è¾¼ã¿
            if ('IntersectionObserver' in window) {
                const imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            const src = img.getAttribute('data-src');
                            if (src) {
                                img.src = src;
                                img.removeAttribute('data-src');
                                observer.unobserve(img);
                            }
                        }
                    });
                });

                // data-srcå±æ€§ã‚’æŒã¤ã™ã¹ã¦ã®ç”»åƒã‚’ç›£è¦–
                document.querySelectorAll('img[data-src]').forEach(img => {
                    imageObserver.observe(img);
                });
            } else {
                // Intersection Observer éå¯¾å¿œã®å ´åˆã¯å³åº§ã«èª­ã¿è¾¼ã¿
                document.querySelectorAll('img[data-src]').forEach(img => {
                    const src = img.getAttribute('data-src');
                    if (src) {
                        img.src = src;
                        img.removeAttribute('data-src');
                    }
                });
            }
        }

        function showPage(pageId) {
            $('.page').removeClass('active')
            $(`#${pageId}`).addClass('active')
        }

        let isChangingContent = false;
        async function showAppContent(contentId) {
            if (isChangingContent) return;
            isChangingContent = true;

            try {
                $('.app-content').addClass('hidden')
                const $target = $(`#${contentId}`);
                $target.removeClass('hidden')

                // ç”»é¢é·ç§»æ™‚ã«æ¤œç´¢æ¡ä»¶ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆæ„å›³ã—ãªã„AIå®Ÿè¡Œã‚’é˜²ãï¼‰
                try {
                    if (contentId === 'jobs-content') {
                        if (typeof window.clearSearch === 'function') window.clearSearch();
                    } else if (contentId === 'candidates-content') {
                        if (typeof window.clearCandidateSearch === 'function') window.clearCandidateSearch();
                    }
                } catch (e) {
                    console.error('Clear filters error during transition:', e);
                }

                // ç®¡ç†è€…ç³»ãƒšãƒ¼ã‚¸ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼é‡è¤‡ãƒ»ä½™ç™½å¯¾ç­–ãŒå¿…è¦ãªãƒšãƒ¼ã‚¸ï¼‰ã®ãƒªã‚¹ãƒˆ
                const adminPages = [
                    'admin-prompts-content',
                    'admin-jobs-content',
                    'admin-companies-content',
                    'admin-applicants-content',
                    'admin-candidates-content',
                    'admin-users-content',
                    'admin-csv-content',
                    'admin-log-content',
                    'admin-master-content',
                    'admin-settings-content',
                    'admin-data-management-content',
                    'kpi-dashboard-content',
                    'admin-yomi-management-content',
                    'admin-templates-content',
                    'super-admin-organizations-content',
                    'coach-students-content'
                ];

                // ç®¡ç†è€…ç³»ãƒšãƒ¼ã‚¸ã®å ´åˆã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’éš ã—ã€è¦ç´ ã‚’æœ€ä¸Šéƒ¨ã«ç§»å‹•
                if (adminPages.includes(contentId)) {
                    $('header').addClass('hidden');
                    // å¼·åˆ¶çš„ã«main-contentã®å…ˆé ­ã«ç§»å‹•ï¼ˆè¦‹ãˆãªã„è¦ç´ ã«ã‚ˆã‚‹ä½™ç™½æ’é™¤ï¼‰
                    $('.main-content').prepend($target);
                } else {
                    $('header').removeClass('hidden');
                }

                // ãƒšãƒ¼ã‚¸é·ç§»æ™‚ã«ãƒ•ãƒ­ãƒ¼ãƒˆãƒãƒ¼ã‚’éè¡¨ç¤ºã«ã—ã€ä½™ç™½ã‚’ãƒªã‚»ãƒƒãƒˆ
                $('#bulk-recommend-bar, #candidate-float-bar').addClass('hidden translate-y-full').removeClass('translate-y-0');
                $('#jobs-container, #candidate-results-container').css('padding-bottom', '0');

                // æ±‚äººæ¤œç´¢ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚ŒãŸå ´åˆã€ä¿å­˜ã•ã‚ŒãŸæ¤œç´¢æ¡ä»¶ã‚’é©ç”¨
                if (contentId === 'jobs-content') {
                    // loadSearchFiltersé–¢æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªï¼ˆåˆæœŸåŒ–å‰å¯¾ç­–ï¼‰
                    if (typeof loadSearchFilters === 'function' && typeof applySearchFilters === 'function') {
                        // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã®å ´åˆã®ã¿é©ç”¨ï¼ˆæœªãƒ­ãƒ¼ãƒ‰ã®å ´åˆã¯loadJobså†…ã§é©ç”¨ã•ã‚Œã‚‹ï¼‰
                        if (isSearchMasterLoaded) {
                            const savedFilters = loadSearchFilters();
                            if (savedFilters) {
                                console.log('Auto-applying saved filters for jobs page (Master loaded)');
                                applySearchFilters(savedFilters);
                            }
                        }
                    }
                }

                if (contentId === 'admin-data-management-content') {
                    if (typeof loadDataCleanupSettings === 'function') {
                        loadDataCleanupSettings();
                    }
                }

                // é…å»¶ãƒ­ãƒ¼ãƒ‰: åˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã®ã¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
                if (!loadedPages.has(contentId)) {
                    console.log(`Lazy loading data for: ${contentId}`);

                    try {
                        switch (contentId) {
                            case 'recommendations-content':
                                // æ¨è–¦ä¸€è¦§ã¯åˆå›ã®ã¿ãƒ­ãƒ¼ãƒ‰
                                if (typeof loadRecommendations === 'function') {
                                    await loadRecommendations();
                                }
                                break;

                            case 'admin-users-content':
                                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã¯åˆå›ã®ã¿ãƒ­ãƒ¼ãƒ‰
                                if (typeof loadUsers === 'function') {
                                    await loadUsers();
                                }
                                break;

                            case 'admin-companies-content':
                                // ä¼æ¥­ç®¡ç†ã¯åˆå›ã®ã¿ãƒ­ãƒ¼ãƒ‰
                                if (typeof loadCompanies === 'function') {
                                    await loadCompanies();
                                }
                                break;

                            case 'coach-students-content':
                                if (typeof loadCoachStudents === 'function') {
                                    await loadCoachStudents();
                                }
                                break;

                            // ä»–ã®ãƒšãƒ¼ã‚¸ã‚‚å¿…è¦ã«å¿œã˜ã¦è¿½åŠ 
                        }

                        loadedPages.add(contentId);
                    } catch (error) {
                        console.error(`Error lazy loading ${contentId}:`, error);
                    }
                } else {
                    console.log(`Using cached data for: ${contentId}`);
                }
            } finally {
                isChangingContent = false;
            }
        }

        // ========================
        // Audit Log Helper
        // ========================
        /**
         * æ“ä½œãƒ­ã‚°ã‚’è¨˜éŒ²ã™ã‚‹
         * @param {string} action - æ“ä½œã®ç¨®é¡
         * @param {string} targetType - å¯¾è±¡ã®ã‚¿ã‚¤ãƒ—
         * @param {string} targetId - å¯¾è±¡ã®ID
         * @param {object} details - è©³ç´°æƒ…å ±
         * @param {object} user - å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆçœç•¥æ™‚ã¯window.currentUserã‚’ä½¿ç”¨ï¼‰
         */
        async function logAuditAction(action, targetType, targetId, details = {}, user = null) {
            try {
                const actor = user || window.currentUser;

                if (!actor) {
                    console.warn('Cannot log action: user is null');
                    return;
                }

                const logEntry = {
                    user_id: actor.id,
                    organization_id: actor.organization_id,
                    action: action,
                    resource_type: targetType, // æ­£ã—ã„ã‚«ãƒ©ãƒ å: resource_type
                    resource_id: targetId,     // æ­£ã—ã„ã‚«ãƒ©ãƒ å: resource_id (æ¨æ¸¬)
                    // details: details,       // ã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ãªã„ãŸã‚é™¤å¤–
                    ip_address: null,
                    user_agent: navigator.userAgent,
                    created_at: new Date().toISOString()
                };

                // éåŒæœŸã§ãƒ­ã‚°ã‚’è¨˜éŒ²
                const { error } = await supabase
                    .from('audit_logs')
                    .insert(logEntry);

                if (error) {
                    console.error('Audit log insert error:', error);
                }

            } catch (error) {
                console.error('Failed to log audit action:', error);
            }
        }

        // ã‚ˆãä½¿ã†æ“ä½œã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆé–¢æ•°
        const auditLog = {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£
            userCreated: (userId, details) => logAuditAction('create', 'user', userId, details),
            userUpdated: (userId, details) => logAuditAction('update', 'user', userId, details),
            userDeleted: (userId, details) => logAuditAction('delete', 'user', userId, details),

            // æ±‚äººé–¢é€£
            jobCreated: (jobId, details) => logAuditAction('create', 'job', jobId, details),
            jobUpdated: (jobId, details) => logAuditAction('update', 'job', jobId, details),
            jobDeleted: (jobId, details) => logAuditAction('delete', 'job', jobId, details),

            // å¿œå‹Ÿé–¢é€£
            applicationSubmitted: (applicationId, details) => logAuditAction('apply', 'application', applicationId, details),

            // AIæ¨è–¦é–¢é€£
            recommendationCreated: (recommendationId, details) => logAuditAction('recommend', 'recommendation', recommendationId, details),
            bulkRecommendationExecuted: (count, details) => logAuditAction('bulk_recommend', 'recommendation', null, { count, ...details }),

            // èªè¨¼é–¢é€£ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ˜ç¤ºçš„ã«æ¸¡ã™ï¼‰
            userLoggedIn: (user) => logAuditAction('login', 'auth', user?.id || 'unknown', { email: user?.email }, user),
            userLoggedOut: () => logAuditAction('logout', 'auth', window.currentUser?.id || 'unknown', { email: window.currentUser?.email }),

            // ä¼æ¥­é–¢é€£
            companyCreated: (companyId, details) => logAuditAction('create', 'company', companyId, details),
            companyUpdated: (companyId, details) => logAuditAction('update', 'company', companyId, details),
            companyDeleted: (companyId, details) => logAuditAction('delete', 'company', companyId, details),

            // CSVé–¢é€£
            csvImported: (type, count, details) => logAuditAction('csv_import', type, null, { count, ...details }),

            // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé–¢é€£
            promptUpdated: (promptKey, details) => logAuditAction('update', 'prompt', promptKey, details)
        };


        // ========================
        // Authentication
        // ========================
        async function login(email, password) {
            showLoading()
            hideError('login-error')

            try {
                // Supabase Auth ã§ãƒ­ã‚°ã‚¤ãƒ³
                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                    email,
                    password
                })

                if (authError) throw authError

                const userId = authData.user.id;

                // ---------------------------------------------------------
                // çµ„ç¹”æ‰€å±æƒ…å ±ã®ç¢ºèª (Multi-tenant check)
                // ---------------------------------------------------------
                const { data: memberships, error: memError } = await supabase
                    .from('organization_members')
                    .select('organization_id, organizations(name, code, status, settings)')
                    .eq('user_id', userId);

                console.log('Login Debug: User ID', userId);
                console.log('Login Debug: Memberships found', memberships);
                if (memError) console.error('Login Debug: Membership Error', memError);

                if (memError) {
                    console.error('Membership fetch error:', memError);
                    throw new Error('æ‰€å±çµ„ç¹”æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                if (!memberships || memberships.length === 0) {
                    // æ‰€å±ãŒãªã„å ´åˆ (é€šå¸¸ã‚ã‚Šãˆãªã„ãŒã€ä¸æ•´åˆå¯¾ç­–)
                    throw new Error('æ‰€å±ã™ã‚‹çµ„ç¹”ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾— (Base Profile)
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', userId)
                    .maybeSingle();

                if (userError || !userData) {
                    throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                let targetOrgId = userData.organization_id; // Default to current setting
                let targetOrgName = '';

                // è¤‡æ•°çµ„ç¹”ã«æ‰€å±ã—ã¦ã„ã‚‹å ´åˆã€ã¾ãŸã¯ç¾åœ¨ã®è¨­å®šãŒç„¡åŠ¹ãªå ´åˆ
                if (memberships.length > 1) {
                    // é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é¸ã°ã›ã‚‹
                    // ã“ã“ã§ä¸€æ—¦å‡¦ç†ã‚’ä¸­æ–­ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’å¾…ã¤å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€Promiseã§ãƒ©ãƒƒãƒ—ã™ã‚‹å®Ÿè£…ã«ã™ã‚‹ã‹ã€
                    // ã‚ã‚‹ã„ã¯ã‚·ãƒ³ãƒ—ãƒ«ãªUIè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆã§å®Ÿè£…ã™ã‚‹ã€‚
                    // ã“ã“ã§ã¯ã€Œãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã€é¸æŠã•ã‚ŒãŸã‚‰å¾Œç¶šå‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã€é–¢æ•°ã«åˆ‡ã‚Šåˆ†ã‘ã‚‹ã®ãŒé©åˆ‡ã ãŒã€
                    // loginé–¢æ•°å†…ã§å®Œçµã•ã›ã‚‹ãŸã‚ã€ä¸€æ™‚çš„ã«UIã‚’è¡¨ç¤ºã—ã¦ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å¾…ã¤å½¢ã‚’ã¨ã‚‹ã€‚

                    hideLoading(); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸€æ—¦è§£é™¤

                    // çµ„ç¹”é¸æŠãƒ­ã‚¸ãƒƒã‚¯ (Promise wrapper)
                    const selectedOrg = await new Promise((resolve) => {
                        const modal = $('#org-select-modal');
                        const list = $('#org-select-list');
                        list.empty();

                        memberships.forEach(m => {
                            const org = m.organizations;
                            // åœæ­¢ä¸­ã®çµ„ç¹”ã¯é™¤å¤–ã™ã‚‹ãªã©å¯èƒ½ã ãŒã€ä¸€æ—¦ã™ã¹ã¦è¡¨ç¤º
                            const btn = $(`
                                <button class="w-full text-left px-4 py-3 bg-indigo-50 hover:bg-indigo-100 border border-indigo-200 rounded-lg transition items-center flex justify-between group">
                                    <div>
                                        <div class="font-bold text-indigo-900">${org.name}</div>
                                        <div class="text-xs text-indigo-500">${org.code || ''}</div>
                                    </div>
                                    <i class="fas fa-chevron-right text-indigo-300 group-hover:text-indigo-600"></i>
                                </button>
                            `);
                            btn.on('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                modal.addClass('hidden');
                                resolve({ id: m.organization_id, name: org.name });
                            });

                            list.append(btn);
                        });

                        modal.removeClass('hidden');
                    });

                    showLoading('ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ä¸­...'); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å†é–‹
                    targetOrgId = selectedOrg.id;
                    targetOrgName = selectedOrg.name;

                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçµ„ç¹”ã‚’æ›´æ–°ã—ã¦ãŠãï¼ˆæ¬¡å›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®å„ªå…ˆå€™è£œã¨ã—ã¦ï¼‰
                    // â€» RLSã‚¨ãƒ©ãƒ¼ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€å¤±æ•—ã—ã¦ã‚‚ç„¡è¦–ã™ã‚‹
                    await supabase.from('users').update({ organization_id: targetOrgId }).eq('id', userId);

                } else {
                    // 1ã¤ã ã‘ã®å ´åˆã€ãã‚Œã‚’ç¢ºå®š
                    targetOrgId = memberships[0].organization_id;
                    // targetOrgName = memberships[0].organizations.name; // selectã®æ§‹é€ ã«ã‚ˆã‚‹
                }

                // currentUserã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰
                // userDataã«ã¯å¤ã„ organization_id ãŒå…¥ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ä¸Šæ›¸ã
                const selectedMembership = memberships.find(m => m.organization_id === targetOrgId);
                currentUser = {
                    ...userData,
                    organization_id: targetOrgId,
                    organizations: {
                        name: targetOrgName || selectedMembership?.organizations?.name,
                        settings: selectedMembership?.organizations?.settings || {}
                    }
                };
                window.currentUser = currentUser;

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯ (åˆ©ç”¨åœæ­¢ä¸­ã®å ´åˆã¯ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ)
                if (userData.status === 'suspended') {
                    await supabase.auth.signOut();
                    currentUser = null;
                    window.currentUser = null;
                    throw new Error('ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯åˆ©ç”¨ãŒåœæ­¢ã•ã‚Œã¦ã„ã¾ã™ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚');
                }

                // ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´ã‚’è¨˜éŒ²
                await supabase
                    .from('login_history')
                    .insert({
                        organization_id: currentUser.organization_id,
                        user_id: currentUser.id,
                        name: currentUser.name,
                        email: currentUser.email,
                        user_agent: navigator.userAgent
                    })

                // ç®¡ç†è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¡¨ç¤ºåˆ¶å¾¡
                if (userData.role === 'org_admin' || userData.role === 'admin' || userData.role === 'super_admin') {
                    $('#admin-menu').removeClass('hidden')
                } else {
                    $('#admin-menu').addClass('hidden')
                }

                // ã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¡¨ç¤ºåˆ¶å¾¡
                if (userData.role === 'super_admin') {
                    $('#super-admin-menu').removeClass('hidden')
                } else {
                    $('#super-admin-menu').addClass('hidden')
                }

                // ã‚³ãƒ¼ãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¡¨ç¤ºåˆ¶å¾¡
                if (userData.role === 'coach') {
                    $('#coach-menu').removeClass('hidden')
                } else {
                    $('#coach-menu').addClass('hidden')
                }

                // å¤–éƒ¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è§£æãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¡¨ç¤ºåˆ¶å¾¡
                if (['org_admin', 'admin', 'super_admin', 'coach'].includes(userData.role)) {
                    $('#ai-scout-link').removeClass('hidden')
                } else {
                    $('#ai-scout-link').addClass('hidden')
                }

                // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ›´æ–°
                $('#user-name').text(currentUser.name)
                $('#user-role').text(getRoleLabel(currentUser.role))
                $('#org-name').text(currentUser.organizations?.name || '')
                $('#org-code-display').text(currentUser.organizations?.code ? `ã‚³ãƒ¼ãƒ‰: ${currentUser.organizations.code}` : '')

                // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¡¨ç¤ºåˆ¶å¾¡ï¼ˆæ±‚è·è€…ã¯éè¡¨ç¤ºï¼‰
                if (userData.role === 'candidate') {
                    $('#nav-dashboard').addClass('hidden')
                } else {
                    $('#nav-dashboard').removeClass('hidden')
                }

                // ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®åˆæœŸç”»é¢ã‚’è¨­å®š
                if (userData.role === 'candidate') {
                    // æ±‚è·è€…ã®å ´åˆã¯æ±‚äººæ¤œç´¢ç”»é¢ã‚’è¡¨ç¤º
                    await loadJobs()
                    showAppContent('jobs-content')
                    $('.nav-link[data-page="jobs"]').addClass('bg-indigo-50 text-indigo-600')
                } else {
                    // ãã®ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è¡¨ç¤º
                    await loadDashboard()
                    $('.nav-link[data-page="dashboard"]').addClass('bg-indigo-50 text-indigo-600')
                }

                loadNotifications()
                showPage('app-page')
                isInitialLoad = false;
                // $('#ai-search-agent-trigger').attr('style', 'display: flex !important'); // Temporarily OFF

                // ãƒ­ã‚°ã‚¤ãƒ³æ“ä½œã‚’è¨˜éŒ²ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™ï¼‰
                await auditLog.userLoggedIn(currentUser);



            } catch (error) {
                console.error('Login error:', error)
                showError('login-error', error.message || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ')
            } finally {
                hideLoading()
            }
        }

        async function signup(name, furigana, email, password, invitationToken, orgCode) {
            showLoading()
            hideError('signup-error')

            try {
                let organizationId = null;
                let role = 'candidate'; // Default role for public signup is Candidate
                let invitationId = null;

                // 1. æ‹›å¾…ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚‹å ´åˆã®æ¤œè¨¼
                if (invitationToken) {
                    const { data: invitation, error: invError } = await supabase
                        .rpc('get_invitation_by_token', { token_input: invitationToken })
                        .single()

                    if (invError || !invitation) {
                        throw new Error('ç„¡åŠ¹ãªæ‹›å¾…ãƒªãƒ³ã‚¯ã§ã™')
                    }
                    if (new Date(invitation.expires_at) < new Date()) {
                        throw new Error('æ‹›å¾…ãƒªãƒ³ã‚¯ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™')
                    }
                    if (invitation.accepted_at) {
                        throw new Error('ã“ã®æ‹›å¾…ãƒªãƒ³ã‚¯ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™')
                    }
                    organizationId = invitation.organization_id;
                    role = invitation.role;
                    invitationId = invitation.id;
                }
                // 2. çµ„ç¹”ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆã®æ¤œè¨¼
                else if (orgCode) {
                    const { data: orgData, error: orgError } = await supabase
                        .rpc('get_organization_name_by_code', { org_code: orgCode })

                    if (orgError || !orgData || orgData.length === 0) {
                        throw new Error('ç„¡åŠ¹ãªçµ„ç¹”ã‚³ãƒ¼ãƒ‰ã§ã™');
                    }
                    organizationId = orgData[0].id;
                    // role ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ 'user'
                } else {
                    throw new Error('æ‹›å¾…ãƒªãƒ³ã‚¯ã¾ãŸã¯çµ„ç¹”ã‚³ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™');
                }

                console.log('Attempting signup with:', { email, name, organizationId, role })

                // 3. Supabase Authã§ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            name: name,
                            // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä¿å­˜ã—ã¦ãŠããŒã€å®Ÿéš›ã®æ‰€å±ã¯users/organization_membersãƒ†ãƒ¼ãƒ–ãƒ«ã§ç®¡ç†
                            organization_id: organizationId
                        }
                    }
                });

                if (authError) throw authError;

                if (authData.user) {
                    console.log('Auth user created:', authData.user.id);

                    // 4. Usersãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆ
                    // NOTE: RLSã«ã‚ˆã‚Šã€è‡ªåˆ†è‡ªèº«ã®IDã§ã®ã¿INSERTå¯èƒ½
                    const { error: insertError } = await supabase
                        .from('users')
                        .insert({
                            id: authData.user.id,
                            email: email,
                            name: name,
                            furigana: furigana,
                            role: role,
                            organization_id: organizationId, // ãƒ¬ã‚¬ã‚·ãƒ¼äº’æ›
                            is_active: true
                        });

                    if (insertError) {
                        // æ—¢ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹é‡è¤‡ãªã©ï¼‰
                        if (insertError.code === '23505') {
                            console.log('User already exists in DB. Resolving ID and linking to this org...');

                            const { data: finalUserId, error: rpcError } = await supabase
                                .rpc('get_user_id_by_email', { target_email: email });

                            if (rpcError || !finalUserId) {
                                console.error('Failed to resolve existing user via RPC:', rpcError);
                                throw new Error('æ—¢å­˜ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
                            }

                            console.log('Target User ID resolved:', finalUserId);

                            const { error: memberError } = await supabase
                                .from('organization_members')
                                .insert({
                                    organization_id: organizationId,
                                    user_id: finalUserId,
                                    role: role
                                });

                            if (memberError) {
                                if (memberError.code === '23505') {
                                    console.log('User is already a member of this organization.');
                                } else {
                                    console.error('Failed to add existing user to members:', memberError);
                                    throw new Error('çµ„ç¹”ã¸ã®åŠ å…¥ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + memberError.message);
                                }
                            } else {
                                console.log('Successfully added existing user to organization_members.');
                            }
                        } else {
                            console.error('Unexpected DB insert error:', insertError);
                            throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + insertError.message);
                        }
                    }
                    else {
                        // æ–°ã—ããƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚ŒãŸå ´åˆã€ãƒˆãƒªã‚¬ãƒ¼ãŒè‡ªå‹•çš„ã« members ã«å…¥ã‚Œã‚‹ã‹ã€
                        // ã¾ãŸã¯æ‰‹å‹•ã§ï¼ˆãƒˆãƒªã‚¬ãƒ¼ãŒãªã„ç’°å¢ƒã®å ´åˆï¼‰è¿½åŠ ã‚’ç¢ºèª
                        console.log('New user record created successfully.');
                    }

                    // 5. æ‹›å¾…ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ãŸå ´åˆã¯ä½¿ç”¨æ¸ˆã¿ã«æ›´æ–°
                    if (invitationId) {
                        await supabase
                            .from('invitations')
                            .update({ accepted_at: new Date().toISOString() })
                            .eq('id', invitationId);
                    }

                    alert('ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                    showPage('login-page');
                } else {
                    // ãƒ¡ãƒ¼ãƒ«ç¢ºèªå¾…ã¡ç­‰ã®ã‚±ãƒ¼ã‚¹
                    alert('ç¢ºèªãƒ¡ãƒ¼ãƒ«ãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç™»éŒ²ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚');
                }
            } catch (error) {

                console.error('Signup error:', error)
                showError('signup-error', error.message || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ')
            } finally {
                hideLoading()
            }
        }


        async function logout() {
            showLoading()
            try {
                // æ¤œç´¢æ¡ä»¶ã‚’ã‚¯ãƒªã‚¢
                if (typeof window.clearSearch === 'function') window.clearSearch();
                if (typeof window.clearCandidateSearch === 'function') window.clearCandidateSearch();

                // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ“ä½œã‚’è¨˜éŒ²
                await auditLog.userLoggedOut();

                await supabase.auth.signOut()
                currentUser = null
                window.currentUser = null;
                showPage('login-page')
                $('#ai-search-agent-trigger').attr('style', 'display: none !important');
                $('#ai-search-agent-chat').attr('style', 'display: none !important');
            } catch (error) {
                console.error('Logout error:', error)
                alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ')
            } finally {
                hideLoading()
            }
        }

        // ========================
        // Jobs & Applications
        // ========================
        // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        let targetUsersCache = []
        // é¸æŠã•ã‚ŒãŸæ±‚äººIDã‚’ä¿æŒã™ã‚‹Set
        const selectedJobIds = new Set()
        // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ•ãƒ©ã‚°
        let isSearchMasterLoaded = false
        // ãŠæ°—ã«å…¥ã‚Šæ±‚äººID
        let favoriteJobIds = new Set()
        // ä¿å­˜ã•ã‚ŒãŸæ¤œç´¢æ¡ä»¶
        let savedSearches = []

        async function loadMasterDataForSearch() {
            if (isSearchMasterLoaded) return;
            if (!currentUser || !currentUser.organization_id) {
                console.warn('loadMasterDataForSearch: currentUser or organization_id is missing');
                return;
            }

            try {
                console.log('Loading master data for search...');

                // éƒ½é“åºœçœŒ
                const prefSelect = $('#search-prefecture');
                if (prefSelect.hasClass("select2-hidden-accessible")) {
                    prefSelect.select2('destroy');
                }
                prefSelect.empty();
                window.prefectures.forEach(pref => {
                    prefSelect.append(`<option value="${pref}">${pref}</option>`);
                });
                prefSelect.select2({
                    placeholder: "å‹¤å‹™åœ°ï¼ˆéƒ½é“åºœçœŒï¼‰",
                    allowClear: true,
                    width: '100%',
                    closeOnSelect: true
                });

                // é›‡ç”¨å½¢æ…‹ã€è·ç¨®ã‚«ãƒ†ã‚´ãƒªã€æ¥­ç•Œã‚«ãƒ†ã‚´ãƒªã‚’å–å¾—
                const { data: masters, error } = await supabase
                    .from('master_data')
                    .select('*')
                    .in('type', ['employment_type', 'job_category', 'industry_category'])
                    .eq('is_active', true)
                    .order('sort_order');

                if (error) {
                    console.error('Supabase master_data fetch error:', error);
                    throw error;
                }

                // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ« ã¾ãŸã¯ è‡ªç¤¾ç”¨ï¼‰
                const validMasters = masters.filter(m =>
                    m.organization_id === null || m.organization_id === currentUser.organization_id
                );

                if (validMasters.length === 0) {
                    console.warn('No valid master data found for organization:', currentUser.organization_id);
                }

                // é›‡ç”¨å½¢æ…‹
                const empSelect = $('#search-employment-type');
                if (empSelect.hasClass("select2-hidden-accessible")) {
                    empSelect.select2('destroy');
                }
                empSelect.empty();
                const uniqueEmps = [...new Set(validMasters.filter(m => m.type === 'employment_type').map(m => m.label))];
                uniqueEmps.forEach(label => {
                    empSelect.append(`<option value="${label}">${label}</option>`);
                });
                empSelect.select2({
                    placeholder: "é›‡ç”¨å½¢æ…‹ï¼ˆå…¨ã¦ï¼‰",
                    allowClear: true,
                    width: '100%',
                    closeOnSelect: true
                });

                // è·ç¨®ã‚«ãƒ†ã‚´ãƒª
                const catSelect = $('#search-job-category');
                if (catSelect.hasClass("select2-hidden-accessible")) {
                    catSelect.select2('destroy');
                }
                catSelect.empty();
                const uniqueCats = [...new Set(validMasters.filter(m => m.type === 'job_category').map(m => m.label))];
                uniqueCats.forEach(label => {
                    catSelect.append(`<option value="${label}">${label}</option>`);
                });
                catSelect.select2({
                    placeholder: "è·ç¨®ã‚«ãƒ†ã‚´ãƒªï¼ˆå…¨ã¦ï¼‰",
                    allowClear: true,
                    width: '100%',
                    closeOnSelect: true
                });

                // æ¥­ç•Œã‚«ãƒ†ã‚´ãƒª
                const indSelect = $('#search-industry-category');
                if (indSelect.hasClass("select2-hidden-accessible")) {
                    indSelect.select2('destroy');
                }
                indSelect.empty();
                const uniqueInds = [...new Set(validMasters.filter(m => m.type === 'industry_category').map(m => m.label))];
                uniqueInds.forEach(label => {
                    indSelect.append(`<option value="${label}">${label}</option>`);
                });
                indSelect.select2({
                    placeholder: "æ¥­ç•Œã‚«ãƒ†ã‚´ãƒªï¼ˆå…¨ã¦ï¼‰",
                    allowClear: true,
                    width: '100%',
                    closeOnSelect: true
                });

                // --- Sync Tags (re-apply after destroy/re-init) ---
                if (typeof setupPremiumSearchUI === 'function') {
                    setupPremiumSearchUI();
                }

                isSearchMasterLoaded = true
            } catch (error) {
                console.error('Load search master error:', error)
            }
        }

        // ========================
        // AI Matching Features
        // ========================

        async function loadTargetUsers() {
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('organization_id', currentUser.organization_id)
                    .neq('role', 'super_admin') // ã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…ã¯é™¤å¤–
                    .order('name', { ascending: true })

                if (error) throw error

                targetUsersCache = users || [];
                const select = $('#target-user-select');
                select.html('<option value="">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</option>');

                targetUsersCache.forEach(user => {
                    select.append(`<option value="${user.id}">${user.name} (${user.email})</option>`);
                });

            } catch (error) {
                console.error('Load target users error:', error);
            }
        }

        window.onTargetUserChange = function () {
            const userId = $('#target-user-select').val();
            updateBatchAiButton(); // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°

            if (!userId) return;

            const user = targetUsersCache.find(u => u.id === userId);
            if (!user) return;

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ (ä»¥å‰ã®å€¤ã‚’ã‚¯ãƒªã‚¢)
            $('#search-keyword').val('');
            $('#search-location').val(''); // è©³ç´°ã‚¨ãƒªã‚¢ã‚’ç¢ºå®Ÿã«ã‚¯ãƒªã‚¢
            $('#search-prefecture').val([]).trigger('change');
            $('#search-employment-type').val([]).trigger('change');
            $('#search-job-category').val([]).trigger('change');
            $('#search-industry-category').val([]).trigger('change');
            $('#search-salary-min').val('');
            $('#search-job-experience-ok').prop('checked', false);
            $('#search-industry-experience-ok').prop('checked', false);
            $('#search-is-remote').prop('checked', false);
            $('#search-exclude-matched').prop('checked', false);
            $('#search-favorites-only').prop('checked', false);

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¸Œæœ›æ¡ä»¶ã‚’æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚»ãƒƒãƒˆ
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¸Œæœ›æ¡ä»¶ã‚’æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚»ãƒƒãƒˆ
            if (user.desired_job_type) $('#search-job-category').val(user.desired_job_type).trigger('change');
            if (user.desired_location) {
                // é…åˆ—ãªã‚‰éƒ½é“åºœçœŒãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã¸ã‚»ãƒƒãƒˆã€‚æ–‡å­—åˆ—ï¼ˆè©³ç´°ï¼‰ã®å ´åˆã¯ã‚»ãƒƒãƒˆã—ãªã„
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›: å‹¤å‹™åœ°(è©³ç´°)ã®é …ç›®ã¯ã‚»ãƒƒãƒˆã—ãªã„
                if (Array.isArray(user.desired_location)) {
                    $('#search-prefecture').val(user.desired_location).trigger('change');
                    // å‰¯ä½œç”¨å¯¾ç­–: ãƒˆãƒªã‚¬ãƒ¼ã«ã‚ˆã£ã¦ã‚»ãƒƒãƒˆã•ã‚Œã¦ã—ã¾ã£ãŸå ´åˆã¯å³åº§ã«ã‚¯ãƒªã‚¢
                    $('#search-location').val('');
                }
            }
            if (user.desired_employment_type) $('#search-employment-type').val(user.desired_employment_type).trigger('change');
            if (user.desired_salary) $('#search-salary-min').val(Math.floor(user.desired_salary / 10000)); // ä¸‡å††å˜ä½

            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ç³»
            $('#search-job-experience-ok').prop('checked', user.desired_job_experience_ok);
            $('#search-industry-experience-ok').prop('checked', user.desired_industry_experience_ok);

            // è‡ªå‹•çš„ã«æ¤œç´¢ã‚’å®Ÿè¡Œ
            searchJobs();
        }

        window.toggleJobSelection = function (jobId) {
            if (selectedJobIds.has(jobId)) {
                selectedJobIds.delete(jobId);
            } else {
                selectedJobIds.add(jobId);
            }
            updateBatchAiButton();
            updateCandidateAiButton();
        }

        function updateBatchAiButton() {
            const btn = $('#batch-ai-btn');
            const count = selectedJobIds.size;
            const userId = $('#target-user-select').val();

            if (count > 0 && userId) {
                btn.prop('disabled', false).removeClass('opacity-50 cursor-not-allowed');
                btn.html(`<i class="fas fa-magic mr-2"></i>é¸æŠã—ãŸæ±‚äºº(${count}ä»¶)ã§AIç´¹ä»‹ã‚’å®Ÿè¡Œ`);
            } else {
                btn.prop('disabled', true).addClass('opacity-50 cursor-not-allowed');
                btn.html(`<i class="fas fa-magic mr-2"></i>é¸æŠã—ãŸæ±‚äººã§AIç´¹ä»‹ã‚’å®Ÿè¡Œ`);
            }
        }

        // ========================
        // AIæ¨è–¦ç”¨ã®åŒ¿ååŒ–å‡¦ç†
        // ========================

        /**
         * ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰å€‹äººæƒ…å ±ã‚’é™¤å»ãƒ»åŒ¿ååŒ–
         * @param {string} text - å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆ
         * @returns {string} - åŒ¿ååŒ–ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆ
         */
        function anonymizeText(text) {
            if (!text) return '';

            let anonymized = text;

            // åŒ¿ååŒ–ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ï¼ˆæƒ…å ±ä¸è¶³åˆ¤å®šã®åŸå› èª¿æŸ»ã®ãŸã‚ï¼‰
            // å¿…è¦ãªæƒ…å ±ã¾ã§ç½®æ›ã•ã‚Œã¦ã—ã¾ã£ã¦ã„ã‚‹å¯èƒ½æ€§ã‚’æ’é™¤
            return text;

            // å…·ä½“çš„ãªéƒ¨ç½²åã‚„å½¹è·ã‚’ä¸€èˆ¬åŒ–ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            // anonymized = anonymized
            //     .replace(/ç¬¬[0-9ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+[å–¶æ¥­é–‹ç™ºè£½é€ ]éƒ¨/g, 'æ‰€å±éƒ¨ç½²');

            return anonymized;
        }

        /**
         * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’åŒ¿ååŒ–ã—ã¦AIç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆ
         * @param {object} user - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
         * @returns {string} - åŒ¿ååŒ–ã•ã‚ŒãŸãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ†ã‚­ã‚¹ãƒˆ
         */
        function createAnonymizedUserProfile(user) {
            const safeString = (val) => {
                if (!val) return 'æœªè¨­å®š';
                if (typeof val === 'object') {
                    try { return JSON.stringify(val, null, 2); } catch (e) { return String(val); }
                }
                return String(val);
            };

            return `
                å¸Œæœ›è·ç¨®: ${safeString(user.desired_job_type)}
                å¸Œæœ›å‹¤å‹™åœ°: ${safeString(user.desired_location)}
                ã‚¹ã‚­ãƒ«: ${safeString(user.skills)}
                è·æ­´ãƒ»è‡ªå·±PR: ${safeString(user.work_history)}
                å¸Œæœ›å¹´å: ${user.desired_salary ? user.desired_salary + 'å††' : 'æœªè¨­å®š'}
                å­¦æ­´: ${safeString(user.academic_background)}
                è¨€èªã‚¹ã‚­ãƒ«: ${safeString(user.languages)}
                è³‡æ ¼: ${safeString(user.certifications)}
            `.trim();
        }

        window.runBatchAIRecommendation = async function () {
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° selectedTargetUserId ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°å¾“æ¥ã®selectå€¤
            let userId = typeof selectedTargetUserId !== 'undefined' ? selectedTargetUserId : $('#target-user-select').val();

            if (!userId) {
                alert('å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            if (selectedJobIds.size === 0) {
                alert('æ±‚äººã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            showLoading();
            try {
                // 1. æœ€æ–°ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ç›´æ¥å–å¾— (ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿)
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                    .eq('id', userId)
                    .single();

                if (userError || !userData) {
                    console.error('User fetch error:', userError);
                    throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã®ãƒ•ãƒ©ãƒƒãƒˆåŒ–
                const profile = Array.isArray(userData.candidate_profiles) ? userData.candidate_profiles[0] : userData.candidate_profiles;
                const user = { ...userData, ...profile }; // usersã¨profilesã‚’çµåˆ

                console.log('Fresh User Data fetched:', user);

                // ãƒ‡ãƒãƒƒã‚°ç”¨ã‚¢ãƒ©ãƒ¼ãƒˆ
                alert('ã€ç¢ºèªç”¨ã€‘AIã¸é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿(å†’é ­):\n' + userProfile.substring(0, 500));

                // 2. é¸æŠã•ã‚ŒãŸæ±‚äººãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const { data: selectedJobs, error: jobsError } = await supabase
                    .from('jobs')
                    .select('*')
                    .in('id', Array.from(selectedJobIds));

                if (jobsError) throw jobsError;

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’åŒ¿ååŒ–ã—ã¦æ§‹ç¯‰
                const userProfile = createAnonymizedUserProfile(user);
                console.log('User Data for AI:', user);
                console.log('Anonymized Profile Text:', userProfile);

                // Edge Function å‘¼ã³å‡ºã—
                const { data: recommendations, error: functionError } = await supabase.functions.invoke('score-ai-recommendations', {
                    body: {
                        userProfile,
                        jobs: selectedJobs.map(j => ({ id: j.id, title: j.title, description: j.description }))
                    }
                });

                if (functionError) throw functionError;

                if (!recommendations || recommendations.length === 0) {
                    throw new Error('AIã‹ã‚‰ã®å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                }

                // çµæœã‚’ä¿å­˜
                for (const rec of recommendations) {
                    // æ—¢å­˜ã®ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°å‰Šé™¤ã—ã¦ã‹ã‚‰æŒ¿å…¥
                    await supabase.from('recommendations')
                        .delete()
                        .eq('user_id', userId)
                        .eq('job_id', rec.job_id);

                    await supabase.from('recommendations').insert({
                        organization_id: currentUser.organization_id,
                        user_id: userId,
                        job_id: rec.job_id,
                        score: rec.score,
                        reason: rec.reason
                    });
                }

                alert(`${recommendations.length}ä»¶ã®ãƒãƒƒãƒãƒ³ã‚°åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸï¼\nã€ŒAIç´¹ä»‹ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰çµæœã‚’ç¢ºèªã§ãã¾ã™ã€‚`);
                selectedJobIds.clear();
                updateBatchAiButton();
                // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®è¡¨ç¤ºã‚’æ›´æ–°
                $('input[type="checkbox"][onchange^="toggleJobSelection"]').prop('checked', false);
                // æ±‚äººãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿ã—ã¦AIæ¨è–¦æ¸ˆã¿ãƒãƒƒã‚¸ã‚’è¡¨ç¤º
                searchJobs();

            } catch (error) {
                console.error('Batch AI error:', error);
                alert('AIåˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // æ±‚è·è€…ç”¨ã‚»ãƒ«ãƒ•AIãƒãƒƒãƒãƒ³ã‚°
        window.runCandidateSelfAIMatching = async function () {
            if (!currentUser || currentUser.role !== 'candidate') {
                alert('ã“ã®æ©Ÿèƒ½ã¯æ±‚è·è€…ã®ã¿åˆ©ç”¨ã§ãã¾ã™');
                return;
            }
            if (selectedJobIds.size === 0) {
                alert('æ±‚äººã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ï¼‰');
                return;
            }

            showLoading();
            try {
                // é¸æŠã•ã‚ŒãŸæ±‚äººãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const { data: selectedJobs, error: jobsError } = await supabase
                    .from('jobs')
                    .select('*')
                    .in('id', Array.from(selectedJobIds));

                if (jobsError) throw jobsError;

                // è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’åŒ¿ååŒ–ã—ã¦æ§‹ç¯‰
                const userProfile = createAnonymizedUserProfile(currentUser);

                // Edge Function å‘¼ã³å‡ºã—
                const { data: recommendations, error: functionError } = await supabase.functions.invoke('score-ai-recommendations', {
                    body: {
                        userProfile,
                        jobs: selectedJobs.map(j => ({ id: j.id, title: j.title, description: j.description }))
                    }
                });

                if (functionError) throw functionError;

                if (!recommendations || recommendations.length === 0) {
                    throw new Error('AIã‹ã‚‰ã®å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                }

                // çµæœã‚’ä¿å­˜
                for (const rec of recommendations) {
                    // æ—¢å­˜ã®ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°å‰Šé™¤ã—ã¦ã‹ã‚‰æŒ¿å…¥
                    await supabase.from('recommendations')
                        .delete()
                        .eq('user_id', currentUser.id)
                        .eq('job_id', rec.job_id);

                    await supabase.from('recommendations').insert({
                        organization_id: currentUser.organization_id,
                        user_id: currentUser.id,
                        job_id: rec.job_id,
                        score: rec.score,
                        reason: rec.reason
                    });
                }

                alert(`${recommendations.length}ä»¶ã®ãƒãƒƒãƒãƒ³ã‚°åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸï¼\nã€ŒAIæ¨è–¦ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰çµæœã‚’ç¢ºèªã§ãã¾ã™ã€‚`);
                selectedJobIds.clear();
                updateCandidateAiButton();
                // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®è¡¨ç¤ºã‚’æ›´æ–°
                $('input[type="checkbox"][onchange^="toggleJobSelection"]').prop('checked', false);
                // æ±‚äººãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿ã—ã¦AIæ¨è–¦æ¸ˆã¿ãƒãƒƒã‚¸ã‚’è¡¨ç¤º
                searchJobs();

            } catch (error) {
                console.error('Candidate AI matching error:', error);
                alert('AIåˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // æ±‚è·è€…ç”¨AIãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’æ›´æ–°
        function updateCandidateAiButton() {
            const btn = $('#candidate-ai-btn');
            if (selectedJobIds.size > 0) {
                btn.prop('disabled', false);
            } else {
                btn.prop('disabled', true);
            }
        }

        // ========================
        // Job Detail Modal
        // ========================
        window.showJobDetailModal = async function (jobId) {
            if (isModalLoading) return;
            console.log('--- showJobDetailModal Triggered ---', jobId);

            if (!jobId) {
                console.error('Error: jobId is undefined or null');
                return;
            }

            console.log('Step 1: check client');
            const client = window.supabase;
            console.log('Step 2: check user');
            const user = window.currentUser;
            console.log('Step 3: show loading');
            showLoading();
            isModalLoading = true;
            console.log('Step 4: entering try');
            try {
                console.log('Fetching job details for:', jobId);
                let { data: job, error } = await client
                    .from('jobs')
                    .select(`
                        *,
                        companies (
                            name,
                            industry,
                            website,
                            location,
                            description
                        ),
                        pic1:users!pic_user_id_1(name),
                        pic2:users!pic_user_id_2(name)
                    `)
                    .eq('id', jobId)
                    .single();

                if (error) {
                    console.log('Fetch error, trying fallback:', error);
                    const fallback = await client.from('jobs').select('*').eq('id', jobId).single();
                    job = fallback.data;
                    error = fallback.error;
                }

                if (error || !job) {
                    console.log('Final fetch error or no job:', error, job);
                    alert('æ±‚äººæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ãŸã‹ã€è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                    return;
                }

                console.log('Job details fetched:', job.title);
                $('#job-detail-title').text(job.title);

                if (user && (user.role === 'candidate' || user.role === 'user')) {
                    $('#job-tab-candidates').addClass('hidden');
                } else {
                    $('#job-tab-candidates').removeClass('hidden');
                }

                const companyName = job.companies ? job.companies.name : (job.company || 'ä¸æ˜');
                const companyIndustry = job.companies?.industry || job.industry_category || 'æœªè¨­å®š';
                const companyWebsite = job.companies?.website || '';
                const companyLocation = job.companies?.location || '';
                const companyDescription = job.companies?.description || '';

                const pic1Name = job.pic1?.name || (job.pic_user_id_1 ? 'ä¸æ˜' : '');
                const pic2Name = job.pic2?.name || (job.pic_user_id_2 ? 'ä¸æ˜' : '');
                const isAgent = user && ['org_admin', 'admin', 'coach', 'ca', 'super_admin'].includes(user.role);
                const canEditJob = user && ['super_admin', 'org_admin'].includes(user.role);

                const content = `
                    <!-- ä¼æ¥­æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="bg-gray-50 rounded-xl p-5 mb-6 border border-gray-100 shadow-sm transition hover:shadow-md">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-building mr-2 text-indigo-600"></i>ä¼æ¥­æƒ…å ±
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-3">
                                <div>
                                    <p class="text-xs text-gray-500 uppercase tracking-wider font-semibold">ä¼æ¥­å</p>
                                    <p class="text-gray-900 font-medium">${companyName}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500 uppercase tracking-wider font-semibold">æ¥­ç•Œ</p>
                                    <p class="text-gray-900">${companyIndustry}</p>
                                </div>
                                ${companyLocation ? `
                                <div>
                                    <p class="text-xs text-gray-500 uppercase tracking-wider font-semibold">æœ¬ç¤¾æ‰€åœ¨åœ°</p>
                                    <p class="text-gray-900">${companyLocation}</p>
                                </div>
                                ` : ''}
                                ${companyWebsite ? `
                                <div>
                                    <p class="text-xs text-gray-500 uppercase tracking-wider font-semibold">Webã‚µã‚¤ãƒˆ</p>
                                    <a href="${companyWebsite}" target="_blank" class="text-indigo-600 hover:text-indigo-800 transition flex items-center gap-1 group">
                                        <span class="truncate">${companyWebsite}</span>
                                        <i class="fas fa-external-link-alt text-[10px] group-hover:translate-x-0.5 group-hover:-translate-y-0.5 transition-transform"></i>
                                    </a>
                                </div>
                                ` : ''}
                            </div>
                            ${companyDescription ? `
                            <div class="md:border-l md:pl-6 border-gray-200">
                                <p class="text-xs text-gray-500 uppercase tracking-wider font-semibold mb-1">ä¼æ¥­æ¦‚è¦</p>
                                <p class="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">${companyDescription}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- åŸºæœ¬æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="mb-8">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-info-circle mr-2 text-indigo-600"></i>åŸºæœ¬æƒ…å ±
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <p class="text-xs text-gray-500 font-semibold mb-1">è·ç¨®ã‚«ãƒ†ã‚´ãƒª</p>
                                <p class="font-medium text-gray-900">${job.job_category || 'æœªè¨­å®š'}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 font-semibold mb-1">æ¥­ç•Œã‚«ãƒ†ã‚´ãƒª</p>
                                <p class="font-medium text-gray-900">${job.industry_category || 'æœªè¨­å®š'}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 font-semibold mb-1">é›‡ç”¨å½¢æ…‹</p>
                                <p class="font-medium text-gray-900">
                                    <span class="px-2 py-0.5 bg-indigo-50 text-indigo-700 border border-indigo-100 rounded text-xs">
                                        ${job.employment_type || 'æœªè¨­å®š'}
                                    </span>
                                </p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 font-semibold mb-1">å‹¤å‹™åœ°</p>
                                <p class="font-medium text-gray-900">
                                    <i class="fas fa-map-marker-alt mr-1 text-gray-400"></i>${job.location || 'æœªè¨­å®š'}
                                </p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 font-semibold mb-1">æƒ³å®šå¹´å</p>
                                <p class="font-bold text-indigo-600 text-lg">
                                    ${job.salary_min && job.salary_max ? `Â¥${(job.salary_min / 10000).toLocaleString()}ä¸‡ - ${(job.salary_max / 10000).toLocaleString()}ä¸‡` : 'å¿œç›¸è«‡'}
                                </p>
                            </div>
                            <div class="md:col-span-1">
                                <p class="text-xs text-gray-500 font-semibold mb-1">ãƒªãƒ¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯</p>
                                <p class="font-medium text-gray-900">
                                    <i class="fas ${job.is_remote ? 'fa-check text-green-500' : 'fa-times text-gray-400'} mr-1"></i>
                                    ${job.is_remote ? 'å¯èƒ½' : 'åŸºæœ¬çš„ã«ç„¡ã—'}
                                </p>
                            </div>
                            ${job.pdf_filename ? `
                            <div class="md:col-span-1">
                                <p class="text-xs text-gray-500 font-semibold mb-1">å–ã‚Šè¾¼ã¿ãƒ•ã‚¡ã‚¤ãƒ«å</p>
                                <p class="text-xs font-medium text-gray-600 truncate" title="${job.pdf_filename}">
                                    <i class="fas fa-file-pdf mr-1 text-red-500"></i>${job.pdf_filename}
                                </p>
                            </div>
                            ` : ''}
                            <div class="md:col-span-3 bg-slate-50 p-3 rounded-lg border border-slate-100">
                                <p class="text-xs text-gray-500 font-semibold mb-1">æ±‚äººURL</p>
                                ${job.url ? `
                                <a href="${job.url}" target="_blank" class="text-indigo-600 hover:underline flex items-center gap-1 group text-sm truncate">
                                    <i class="fas fa-link text-xs group-hover:rotate-45 transition-transform"></i>
                                    <span>${job.url}</span>
                                </a>
                                ` : '<span class="text-gray-400 text-sm italic">ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</span>'}
                            </div>
                        </div>
                    </div>

                    <!-- è·å‹™å†…å®¹ -->
                    <div class="mb-8">
                        <h4 class="font-bold text-lg mb-3 text-gray-900 flex items-center">
                            <i class="fas fa-clipboard-list mr-2 text-indigo-600"></i>è·å‹™å†…å®¹
                        </h4>
                        <div class="bg-white border border-gray-200 rounded-xl p-5 shadow-sm">
                            <p class="text-gray-800 whitespace-pre-wrap leading-relaxed">${job.description || 'è©³ç´°ã¯ä¼æ¥­ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„'}</p>
                        </div>
                    </div>

                    <!-- å¿œå‹Ÿè¦ä»¶ -->
                    <div class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-bold text-lg mb-3 text-gray-900 flex items-center">
                                <i class="fas fa-check-circle mr-2 text-indigo-600"></i>å¿…é ˆè¦ä»¶
                            </h4>
                            <div class="bg-white border border-gray-200 rounded-xl p-5 shadow-sm h-full">
                                <p class="text-gray-800 whitespace-pre-wrap text-sm leading-relaxed">${job.requirements || 'ç‰¹ã«ãªã—'}</p>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-bold text-lg mb-3 text-gray-900 flex items-center">
                                <i class="fas fa-star mr-2 text-indigo-600"></i>æ­“è¿è¦ä»¶
                            </h4>
                            <div class="bg-white border border-gray-200 rounded-xl p-5 shadow-sm h-full">
                                <p class="text-gray-800 whitespace-pre-wrap text-sm leading-relaxed">${job.welcome_requirements || 'ç‰¹ã«ãªã—'}</p>
                            </div>
                        </div>
                    </div>

                    <!-- çµŒé¨“ãƒ»å¯¾è±¡ -->
                    <div class="mb-8 bg-blue-50/50 rounded-xl p-5 border border-blue-100">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-user-check mr-2 text-indigo-600"></i>çµŒé¨“ãƒ»ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="flex items-center p-3 bg-white rounded-lg shadow-sm border border-blue-100">
                                <i class="fas ${job.job_experience_ok === 'å¯' ? 'fa-check-circle text-green-600' : 'fa-times-circle text-red-500'} text-xl mr-3"></i>
                                <div>
                                    <p class="text-[10px] text-gray-500 font-bold uppercase">è·ç¨®æœªçµŒé¨“</p>
                                    <p class="font-bold ${job.job_experience_ok === 'å¯' ? 'text-green-700' : 'text-gray-700'}">${job.job_experience_ok === 'å¯' ? 'æ­“è¿' : 'ä¸å¯'}</p>
                                </div>
                            </div>
                            <div class="flex items-center p-3 bg-white rounded-lg shadow-sm border border-blue-100">
                                <i class="fas ${job.industry_experience_ok === 'å¯' ? 'fa-check-circle text-green-600' : 'fa-times-circle text-red-500'} text-xl mr-3"></i>
                                <div>
                                    <p class="text-[10px] text-gray-500 font-bold uppercase">æ¥­ç•ŒæœªçµŒé¨“</p>
                                    <p class="font-bold ${job.industry_experience_ok === 'å¯' ? 'text-green-700' : 'text-gray-700'}">${job.industry_experience_ok === 'å¯' ? 'æ­“è¿' : 'ä¸å¯'}</p>
                                </div>
                            </div>
                            ${job.experience_level ? `
                            <div class="flex items-center p-3 bg-white rounded-lg shadow-sm border border-blue-100">
                                <i class="fas fa-chart-line text-xl text-indigo-500 mr-3"></i>
                                <div>
                                    <p class="text-[10px] text-gray-500 font-bold uppercase">æƒ³å®šçµŒé¨“ãƒ¬ãƒ™ãƒ«</p>
                                    <p class="font-bold text-gray-700">${job.experience_level}</p>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- å‹¤å‹™æ¡ä»¶ -->
                    <div class="mb-8">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-calendar-alt mr-2 text-indigo-600"></i>å‹¤å‹™æ¡ä»¶
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-gray-50 rounded-xl p-5 border border-gray-100">
                                <p class="text-xs text-gray-500 font-bold uppercase mb-3 flex items-center">
                                    <i class="fas fa-clock mr-1 text-gray-400"></i>å‹¤å‹™æ™‚é–“
                                </p>
                                <p class="text-sm text-gray-800 whitespace-pre-wrap">${job.work_hours || 'æœªè¨­å®š'}</p>
                            </div>
                            <div class="bg-gray-50 rounded-xl p-5 border border-gray-100">
                                <p class="text-xs text-gray-500 font-bold uppercase mb-3 flex items-center">
                                    <i class="fas fa-umbrella-beach mr-1 text-gray-400"></i>ä¼‘æ—¥ãƒ»ä¼‘æš‡
                                </p>
                                <p class="text-sm text-gray-800 whitespace-pre-wrap">${job.holidays || 'æœªè¨­å®š'}</p>
                            </div>
                            <div class="md:col-span-2 bg-gray-50 rounded-xl p-5 border border-gray-100">
                                <p class="text-xs text-gray-500 font-bold uppercase mb-3 flex items-center">
                                    <i class="fas fa-gift mr-1 text-gray-400"></i>ç¦åˆ©åšç”Ÿãƒ»å¾…é‡
                                </p>
                                <p class="text-sm text-gray-800 whitespace-pre-wrap">${job.benefits || 'æœªè¨­å®š'}</p>
                            </div>
                        </div>
                    </div>

                    <!-- é¸è€ƒãƒ—ãƒ­ã‚»ã‚¹ -->
                    ${job.interview_process ? `
                    <div class="mb-8">
                        <h4 class="font-bold text-lg mb-3 text-gray-900 flex items-center">
                            <i class="fas fa-tasks mr-2 text-indigo-600"></i>é¸è€ƒãƒ—ãƒ­ã‚»ã‚¹
                        </h4>
                        <div class="bg-white border border-gray-200 rounded-xl p-5 shadow-sm">
                            <p class="text-gray-800 whitespace-pre-wrap leading-relaxed">${job.interview_process}</p>
                        </div>
                    </div>
                    ` : ''}

                    <!-- ç¤¾å†…æ‹…å½“è€… (ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã¿è¡¨ç¤º) -->
                    ${isAgent && (pic1Name || pic2Name) ? `
                    <div class="mb-8 bg-slate-100 rounded-xl p-5 border border-slate-200">
                        <h4 class="font-bold text-base mb-3 text-slate-800 flex items-center">
                            <i class="fas fa-user-tie mr-2 text-slate-500"></i>ç¤¾å†…æ‹…å½“è€…
                        </h4>
                        <div class="flex gap-6">
                            ${pic1Name ? `
                            <div>
                                <p class="text-[10px] text-slate-500 font-bold uppercase">ãƒ¡ã‚¤ãƒ³æ‹…å½“</p>
                                <p class="text-sm font-bold text-slate-900">${pic1Name}</p>
                            </div>
                            ` : ''}
                            ${pic2Name ? `
                            <div>
                                <p class="text-[10px] text-slate-500 font-bold uppercase">ã‚µãƒ–æ‹…å½“</p>
                                <p class="text-sm font-bold text-slate-900">${pic2Name}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}

                    <!-- ç™»éŒ²ãƒ»æ›´æ–°æ—¥æ™‚ -->
                    <div class="flex justify-end text-[10px] text-gray-400 mt-2 mb-6">
                        <span class="mr-4">ç™»éŒ²æ—¥: ${new Date(job.created_at).toLocaleDateString()}</span>
                        <span>æœ€çµ‚æ›´æ–°æ—¥: ${new Date(job.updated_at).toLocaleDateString()}</span>
                    </div>

                    <div class="flex gap-3 pt-6 mt-6 border-t">
                        <button id="modal-fav-btn-${job.id}" onclick="toggleFavorite('${job.id}')" class="flex-1 px-6 py-3 border-2 ${typeof favoriteJobIds !== 'undefined' && favoriteJobIds.has(job.id) ? 'border-pink-500 text-pink-600' : 'border-gray-300 text-gray-700'} rounded-lg hover:bg-gray-50 font-medium transition shadow-sm flex items-center justify-center gap-2">
                            <i class="fas fa-heart ${typeof favoriteJobIds !== 'undefined' && favoriteJobIds.has(job.id) ? 'text-pink-500' : ''}"></i>
                            ${typeof favoriteJobIds !== 'undefined' && favoriteJobIds.has(job.id) ? 'ãŠæ°—ã«å…¥ã‚Šç™»éŒ²æ¸ˆã¿' : 'ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ '}
                        </button>
                        ${user && (user.role === 'candidate' || user.role === 'user') ? `
                        <button onclick="applyForJob('${job.id}')" class="flex-1 bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 font-medium transition shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                            <i class="fas fa-paper-plane"></i>å¿œå‹Ÿã™ã‚‹
                        </button>
                        ` : ''}
                        ${canEditJob ? `
                        <button onclick="closeJobDetailModal(); showJobForm('${job.id}')" class="flex-1 bg-amber-600 text-white px-6 py-3 rounded-lg hover:bg-amber-700 font-medium transition shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                            <i class="fas fa-edit"></i>æ±‚äººã‚’ç·¨é›†
                        </button>
                        ` : ''}
                    </div>
                `;

                console.log('Final step: Rendering to modal and forcing visibility.');
                $('#job-detail-tab-content').html(content);
                window.currentJobId = jobId;

                const modal = $('#job-detail-modal');
                if (modal.length === 0) {
                    console.error('CRITICAL: #job-detail-modal not found in DOM!');
                    alert('ã‚¨ãƒ©ãƒ¼: ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                    return;
                }

                // Move to body root to avoid parent clipping/z-index issues
                $('body').append(modal);

                console.log('Updating modal visibility...');
                modal.removeClass('hidden').attr('style', 'display: flex !important; z-index: 99999 !important; visibility: visible !important; opacity: 1 !important;');

                switchJobDetailTab('details');
                console.log('Modal show process complete - z-index 99999 applied');

            } catch (error) {
                console.error('Load job detail error:', error);
                alert('æ±‚äººè©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                isModalLoading = false;
                hideLoading();
            }
        }

        window.closeJobDetailModal = function () {
            console.log('--- closeJobDetailModal Triggered ---');
            $('#job-detail-modal').addClass('hidden').attr('style', 'display: none !important;');
        }

        // ============================================
        // æ±‚äººæ¨è–¦æ©Ÿèƒ½ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç”¨ï¼‰
        // ============================================

        let currentRecommendJobId = null;
        let currentRecommendTargetUserId = null;

        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹é¸æŠæ™‚ã®å‡¦ç†ã‚’æ›´æ–°
        window.toggleJobSelection = function (jobId) {
            const checkbox = $(`input[type="checkbox"][onclick*="toggleJobSelection('${jobId}')"]`);
            const card = checkbox.closest('.job-card');

            if (selectedJobIds.has(jobId)) {
                selectedJobIds.delete(jobId);
                if (card.length) card.removeClass('job-card-highlighted');
            } else {
                selectedJobIds.add(jobId);
                if (card.length) card.addClass('job-card-highlighted');
            }
            updateBulkRecommendBar();
        }

        // ä¸Šä½30ä»¶ã‚’ä¸€æ‹¬é¸æŠ
        window.selectTop30Jobs = function () {
            const checkboxes = $('.job-card input[type="checkbox"]:not(:disabled)').slice(0, 30);

            checkboxes.each(function () {
                const jobId = $(this).attr('onchange').match(/'([^']+)'/)[1];
                if (!selectedJobIds.has(jobId)) {
                    $(this).prop('checked', true);
                    selectedJobIds.add(jobId);
                    $(this).closest('.job-card').addClass('job-card-highlighted');
                }
            });

            updateBulkRecommendBar();

            // é€šçŸ¥
            const count = checkboxes.length;
            if (count > 0) {
                // ç°¡æ˜“çš„ãªé€šçŸ¥ï¼ˆãƒˆãƒ¼ã‚¹ãƒˆãŒã‚ã‚Œã°ãã‚ŒãŒè‰¯ã„ãŒã€ãªã‘ã‚Œã°ã‚¢ãƒ©ãƒ¼ãƒˆç­‰ã¯é¿ã‘ã‚‹ï¼‰
                console.log(`${count} ä»¶ã®æ±‚äººã‚’é¸æŠã—ã¾ã—ãŸ`);
            }
        }

        window.clearAllSelectedJobs = function () {
            selectedJobIds.clear();
            $('.job-checkbox').prop('checked', false);
            $('.job-card').removeClass('job-card-highlighted');
            updateBulkRecommendBar();
        }

        function updateBulkRecommendBar() {
            const count = selectedJobIds.size;
            $('#selected-jobs-count').text(count);

            const isAgent = currentUser && ['org_admin', 'admin', 'coach', 'ca', 'super_admin'].includes(currentUser.role);
            const isCandidate = currentUser && currentUser.role === 'candidate';
            const targetUserId = selectedTargetUserId;

            const bar = $('#bulk-recommend-bar');
            if (count > 0) {
                if (isAgent && targetUserId) {
                    bar.removeClass('hidden').removeClass('translate-y-full').addClass('translate-y-0');
                    bar.find('.bar-title').text('AIãƒãƒƒãƒ');
                    bar.find('.bar-button').text('AIãƒãƒƒãƒã‚’å®Ÿè¡Œ');
                    $('#jobs-container').css('padding-bottom', '120px');
                } else if (isCandidate) {
                    bar.removeClass('hidden').removeClass('translate-y-full').addClass('translate-y-0');
                    bar.find('.bar-title').text('AIãƒãƒƒãƒãƒ³ã‚°è¨ºæ–­');
                    bar.find('.bar-button').text('AIãƒãƒƒãƒãƒ³ã‚°ã™ã‚‹');
                    $('#jobs-container').css('padding-bottom', '120px');
                } else {
                    bar.addClass('translate-y-full');
                    setTimeout(() => { if (selectedJobIds.size === 0) bar.addClass('hidden'); }, 300);
                    $('#jobs-container').css('padding-bottom', '0');
                }
            } else {
                bar.addClass('translate-y-full');
                setTimeout(() => { if (selectedJobIds.size === 0) bar.addClass('hidden'); }, 300);
                $('#jobs-container').css('padding-bottom', '0');
            }

            // æ›´æ–°: ä¸Šéƒ¨ã®ãƒœã‚¿ãƒ³åˆ¶å¾¡
            const batchAiBtn = $('#batch-ai-btn');
            if (count > 0 && (isCandidate || (isAgent && targetUserId))) {
                batchAiBtn.prop('disabled', false).removeClass('opacity-50 cursor-not-allowed');
            } else {
                batchAiBtn.prop('disabled', true).addClass('opacity-50 cursor-not-allowed');
            }
        }

        window.openRecommendJobModal = async function (jobId) {
            currentRecommendJobId = jobId;

            if (!selectedTargetUserId) {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
                openCandidateSelectionModal();
                return;
            }

            const targetUserId = selectedTargetUserId;
            currentRecommendTargetUserId = targetUserId;

            // æ±‚äººæƒ…å ±ã‚’å–å¾—
            try {
                const { data: job, error } = await supabase
                    .from('jobs')
                    .select('*, companies(name)')
                    .eq('id', jobId)
                    .single();

                if (error) throw error;

                $('#recommend-job-title').text(job.title);

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
                const { data: user, error: userError } = await supabase
                    .from('users')
                    .select('name, email')
                    .eq('id', targetUserId)
                    .single();

                if (userError) throw userError;

                $('#recommend-target-user').text(`${user.name} (${user.email})`);
                $('#recommend-reason').val('');

                $('#recommend-job-modal').removeClass('hidden');

            } catch (error) {
                console.error('Failed to load job/user:', error);
                alert('æ±‚äººæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        window.closeRecommendJobModal = function () {
            $('#recommend-job-modal').addClass('hidden');
            currentRecommendJobId = null;
            currentRecommendTargetUserId = null;
        }

        // AIè‡ªå‹•ç”Ÿæˆ
        window.generateRecommendReason = async function () {
            if (!currentRecommendJobId || !currentRecommendTargetUserId) return;

            const btn = event.target.closest('button');
            const originalHtml = $(btn).html();
            $(btn).html('<i class="fas fa-spinner fa-spin mr-1"></i>ç”Ÿæˆä¸­...').prop('disabled', true);

            const type = $('#generate-reason-type').val() || 'recommendation';

            try {
                // Edge Functionã‚’å‘¼ã³å‡ºã—ã¦æ¨è–¦æ–‡ã‚’ç”Ÿæˆ
                const { data, error } = await supabase.functions.invoke('generate-recommendation-letter', {
                    body: {
                        jobId: currentRecommendJobId,
                        candidateId: currentRecommendTargetUserId,
                        type: type
                    }
                });

                if (error) throw error;

                if (data && data.success) {
                    $('#recommend-reason').val(data.text);
                } else {
                    throw new Error(data?.error || 'ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

            } catch (error) {
                console.error('Failed to generate reason:', error);

                // å¤±æ•—æ™‚ã¯ç°¡æ˜“ãƒ­ã‚¸ãƒƒã‚¯ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
                // ã“ã“ã§ã¯ç°¡æ˜“ãƒ­ã‚¸ãƒƒã‚¯ã‚’è©¦ã¿ã‚‹
                try {
                    const { data: job } = await supabase.from('jobs').select('*').eq('id', currentRecommendJobId).single();
                    const { data: user } = await supabase.from('users').select('*').eq('id', currentRecommendTargetUserId).single();
                    const reason = generateSimpleReason(job, user);
                    $('#recommend-reason').val(reason);
                    alert('AIç”Ÿæˆã«å¤±æ•—ã—ãŸãŸã‚ã€ç°¡æ˜“ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¾ã—ãŸ');
                } catch (e) {
                    alert('ãŠã™ã™ã‚ç†ç”±ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } finally {
                $(btn).html(originalHtml).prop('disabled', false);
            }
        }

        function generateSimpleReason(job, user) {
            const reasons = [];

            if (user.desired_job_category && job.job_category === user.desired_job_category) {
                reasons.push(`ã”å¸Œæœ›ã®è·ç¨®ã€Œ${job.job_category}ã€ã«åˆè‡´ã—ã¦ã„ã¾ã™`);
            }

            if (user.desired_location && job.location.includes(user.desired_location)) {
                reasons.push(`ã”å¸Œæœ›ã®å‹¤å‹™åœ°ã€Œ${user.desired_location}ã€ã«è©²å½“ã—ã¾ã™`);
            }

            if (user.desired_salary_min && job.salary_max >= user.desired_salary_min) {
                reasons.push(`ã”å¸Œæœ›å¹´å${user.desired_salary_min / 10000} ä¸‡å††ä»¥ä¸Šã®æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã™`);
            }

            if (job.is_remote && user.desired_remote) {
                reasons.push('ãƒªãƒ¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯å¯èƒ½ãªæ±‚äººã§ã™');
            }

            if (reasons.length === 0) {
                return `${user.name} æ§˜ã®ã”çµŒé¨“ã‚„ã‚¹ã‚­ãƒ«ã‚’æ´»ã‹ã›ã‚‹æ±‚äººã¨ã—ã¦ã”ç´¹ä»‹ã„ãŸã—ã¾ã™ã€‚${job.title} ã®ãƒã‚¸ã‚·ãƒ§ãƒ³ã¯ã€ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒƒãƒ—ã®è‰¯ã„æ©Ÿä¼šã¨ãªã‚‹ã¨è€ƒãˆã¦ãŠã‚Šã¾ã™ã€‚`;
            }

            return reasons.join('ã€‚') + 'ã€‚ãœã²ã”æ¤œè¨ãã ã•ã„ã€‚';
        }

        // æ¨è–¦ã‚’é€ä¿¡
        window.submitRecommendation = async function () {
            const reason = $('#recommend-reason').val().trim();

            if (!reason) {
                alert('ãŠã™ã™ã‚ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                console.log('Submitting recommendation:', {
                    organization_id: currentUser.organization_id,
                    user_id: currentRecommendTargetUserId,
                    job_id: currentRecommendJobId,
                    reason: reason,
                    score: 85,
                    recommended_by: currentUser.id
                });

                const { data, error } = await supabase
                    .from('recommendations')
                    .insert({
                        organization_id: currentUser.organization_id,
                        user_id: currentRecommendTargetUserId,
                        job_id: currentRecommendJobId,
                        reason: reason,
                        score: 85,
                        recommended_by: currentUser.id
                    })
                    .select('*, jobs(title, company)')
                    .single();

                if (error) {
                    console.error('Supabase error details:', error);
                    throw error;
                }

                // é€šçŸ¥ä½œæˆ (å€™è£œè€…ã¸)
                try {
                    await supabase.from('notifications').insert({
                        user_id: currentRecommendTargetUserId,
                        title: 'æ–°ã—ã„ãŠã™ã™ã‚æ±‚äººãŒã‚ã‚Šã¾ã™',
                        message: `${currentUser.name} ã•ã‚“ã‹ã‚‰ã€Œ${data.jobs.company} / ${data.jobs.title}ã€ã®ãŠã™ã™ã‚ãŒå±Šãã¾ã—ãŸã€‚`,
                        read: false,
                        metadata: {
                            page: 'recommendations',
                            recommendation_id: data.id
                        },
                        created_at: new Date().toISOString()
                    });
                } catch (notifyError) {
                    console.error('Candidate recommendation notification error:', notifyError);
                }

                alert('æ±‚äººã‚’ç´¹ä»‹ã—ã¾ã—ãŸ');
                closeRecommendJobModal();
                searchJobs(); // æ±‚äººãƒªã‚¹ãƒˆã‚’æ›´æ–°

            } catch (error) {
                console.error('Failed to submit recommendation:', error);
                alert(`æ¨è–¦ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message || JSON.stringify(error)} `);
            }
        }

        // ä¸€æ‹¬æ¨è–¦/AIãƒãƒƒãƒãƒ³ã‚°è¨ºæ–­ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        window.openBulkRecommendModal = async function () {
            // æ±‚è·è€…ã®å ´åˆã€è‡ªå‹•çš„ã«è‡ªåˆ†ã‚’å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚»ãƒƒãƒˆ
            if (currentUser && currentUser.role === 'candidate') {
                selectedTargetUserId = currentUser.id;
            }
            const isAgent = currentUser && ['org_admin', 'admin', 'coach', 'ca', 'super_admin'].includes(currentUser.role);
            const isCandidate = currentUser && currentUser.role === 'candidate';

            if (selectedJobIds.size === 0) {
                alert('æ±‚äººã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å ´åˆ: å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¿…è¦
            // æ±‚è·è€…ã®å ´åˆ: è‡ªåˆ†è‡ªèº«ãŒå¯¾è±¡
            let targetUserId;
            if (isAgent) {
                targetUserId = selectedTargetUserId;
                if (!targetUserId) {
                    alert('æ¨è–¦å…ˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }
            } else if (isCandidate) {
                targetUserId = currentUser.id;
            } else {
                alert('ã“ã®æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            currentRecommendTargetUserId = targetUserId;

            try {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
                const { data: user, error: userError } = await supabase
                    .from('users')
                    .select('name, email')
                    .eq('id', targetUserId)
                    .single();

                if (userError) throw userError;

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
                if (isCandidate) {
                    $('#bulk-recommend-modal-title').text('AIãƒãƒƒãƒãƒ³ã‚°è¨ºæ–­');
                    $('#bulk-recommend-target-user').text(`ã‚ãªãŸ(${user.name})`);
                } else {
                    $('#bulk-recommend-modal-title').text('AIãƒãƒƒãƒ');
                    $('#bulk-recommend-target-user').text(`${user.name} (${user.email})`);
                }

                $('#bulk-job-count').text(selectedJobIds.size);

                // é¸æŠã—ãŸæ±‚äººãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
                const jobIds = Array.from(selectedJobIds);
                const { data: jobs, error: jobsError } = await supabase
                    .from('jobs')
                    .select('id, title, companies(name)')
                    .in('id', jobIds);

                if (jobsError) throw jobsError;

                const jobsHtml = jobs.map(job => `
                    <div class="flex items-center justify-between p-2 bg-white rounded border">
                        <span class="text-sm text-gray-900">${job.title}</span>
                        <span class="text-xs text-gray-500">${job.companies?.name || ''}</span>
                    </div>
                `).join('');

                $('#bulk-jobs-list').html(jobsHtml);
                $('#bulk-recommend-modal').removeClass('hidden');

            } catch (error) {
                console.error('Failed to load data:', error);
                alert('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        window.closeBulkRecommendModal = function () {
            $('#bulk-recommend-modal').addClass('hidden');
        }

        // AIæ¨è–¦çµæœãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showAIResultModal(recommended, excluded, targetUserName) {
            const modalHtml = `
                <div class="ai-result-tabs">
                    <div class="ai-result-tab active" data-tab="recommended">
                        ç´¹ä»‹ (${recommended.length}ä»¶)
                    </div>
                    <div class="ai-result-tab" data-tab="excluded">
                        å¯¾è±¡å¤– (${excluded.length}ä»¶)
                    </div>
                </div>

                <div class="ai-result-content active" data-content="recommended">
                    ${recommended.length === 0 ? '<p class="text-gray-500 text-center py-8">ç´¹ä»‹ã™ã‚‹æ±‚äººãŒã‚ã‚Šã¾ã›ã‚“</p>' : ''}
                    ${recommended.map(r => renderAIResultItem(r, false)).join('')}
                </div>

                <div class="ai-result-content" data-content="excluded">
                    ${excluded.length === 0 ? '<p class="text-gray-500 text-center py-8">å¯¾è±¡å¤–ã®æ±‚äººãŒã‚ã‚Šã¾ã›ã‚“</p>' : ''}
                    ${excluded.map(r => renderAIResultItem(r, true)).join('')}
                </div>
        `;

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼ˆæ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨ï¼‰
            // ã“ã“ã§ã¯ç°¡æ˜“çš„ã«æ—¢å­˜ã®bulk-recommend-modalã®ä¸­èº«ã‚’æ›¸ãæ›ãˆã¦å†åˆ©ç”¨ã™ã‚‹ã‹ã€æ–°ã—ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½œã‚‹
            // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«æ§‹é€ ã‚’åˆ©ç”¨ã—ã¦ä¸­èº«ã‚’å·®ã—æ›¿ãˆã‚‹
            $('#bulk-recommend-modal h3').text(`${targetUserName} ã•ã‚“ã¸ã®AIç´¹ä»‹çµæœ`);
            $('#bulk-recommend-modal .modal-body').html(modalHtml); // .modal-bodyã‚¯ãƒ©ã‚¹ãŒå¿…è¦

            // ã‚‚ã—.modal-bodyãŒãªã„å ´åˆã¯ã€é©åˆ‡ãªã‚»ãƒ¬ã‚¯ã‚¿ã‚’æ¢ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€
            // ã“ã“ã§ã¯ä¸€æ—¦ã€bulk-recommend-modalã®ä¸­èº«ã‚’ç›´æ¥æ›¸ãæ›ãˆã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ã¨ã‚Šã¾ã™ã€‚
            // ãŸã ã—ã€é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ãªã©ã®æ©Ÿèƒ½ã¯ç¶­æŒã—ãŸã„ã®ã§ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ä¸­èº«ã‚’å‹•çš„ã«ç”Ÿæˆã™ã‚‹æ–¹ãŒå®‰å…¨ã§ã™ã€‚

            // æ–°ã—ã„ãƒ¢ãƒ¼ãƒ€ãƒ«HTMLã‚’bodyã«è¿½åŠ ï¼ˆã¾ã å­˜åœ¨ã—ãªã„å ´åˆï¼‰
            if ($('#ai-result-modal').length === 0) {
                $('body').append(`
                    <div id="ai-result-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" style="z-index: 10003;">
                        <div class="bg-white rounded-lg w-full max-w-3xl p-6 max-h-[90vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-gray-900">AIç´¹ä»‹çµæœ</h3>
                                <button onclick="$('#ai-result-modal').addClass('hidden')" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div id="ai-result-modal-content"></div>
                            <div class="flex justify-end mt-4 pt-4 border-t">
                                <button onclick="$('#ai-result-modal').addClass('hidden')" class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700">é–‰ã˜ã‚‹</button>
                            </div>
                        </div>
                    </div>
                `);
            }

            // AIè©³ç´°åˆ†æãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¿½åŠ ï¼ˆã¾ã å­˜åœ¨ã—ãªã„å ´åˆï¼‰
            if ($('#ai-detail-modal').length === 0) {
                $('body').append(`
                    <div id="ai-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" style="z-index: 10010;">
                        <div class="bg-white rounded-lg w-full max-w-4xl p-6 max-h-[90vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-gray-900">ğŸ“Š AIè©³ç´°åˆ†æ</h3>
                                <button onclick="closeAIDetailModal()" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <div id="ai-detail-modal-content"></div>
                            <div class="flex justify-end mt-4 pt-4 border-t">
                                <button onclick="closeAIDetailModal()" class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700">é–‰ã˜ã‚‹</button>
                            </div>
                        </div>
                    </div>
                `);
            }

            $('#ai-result-modal h3').text(`${targetUserName} ã•ã‚“ã¸ã®AIæ¨è–¦çµæœ`);
            $('#ai-result-modal-content').html(modalHtml);
            $('#ai-result-modal').removeClass('hidden');

            $('.ai-result-tab').off('click').on('click', function () {
                const tab = $(this).data('tab');
                $('.ai-result-tab').removeClass('active');
                $(this).addClass('active');
                $('.ai-result-content').removeClass('active');
                $(`.ai-result-content[data-content="${tab}"]`).addClass('active');
            });
        }

        function renderAIResultItem(result, isExcluded) {
            const itemClass = isExcluded ? 'ai-result-item excluded' : 'ai-result-item';
            const hasDetails = result.details && result.details.trim().length > 0;

            // ä¸€æ„ã®IDã‚’ç”Ÿæˆ
            const itemId = `ai-result-${result.job_id}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

            // detailsã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜ï¼ˆå¾Œã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ï¼‰
            if (hasDetails) {
                if (!window.aiResultDetails) window.aiResultDetails = {};
                window.aiResultDetails[itemId] = {
                    jobId: result.job_id,
                    jobTitle: result.job_title,
                    company: result.company,
                    score: result.score,
                    details: result.details
                };
            }

            return `
            <div class="${itemClass}">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-gray-900">${result.job_title}</h4>
                        <span class="text-sm font-bold ${isExcluded ? 'text-gray-600' : 'text-indigo-600'}">
                            ãƒãƒƒãƒåº¦: ${result.score}%
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">${result.company}</p>
                    <p class="text-sm text-gray-700 mb-3">${result.reason}</p>
                    <div class="flex gap-3 items-center">
                        <button 
                            class="text-xs text-blue-600 hover:text-blue-800 underline font-medium"
                            onclick="event.stopPropagation(); window.showJobDetailModal('${result.job_id}')"
                        >
                            <i class="fas fa-file-alt mr-1"></i>æ±‚äººè©³ç´°ã‚’è¦‹ã‚‹
                        </button>
                        ${hasDetails ? `
                            <button 
                                class="ai-detail-btn text-xs text-indigo-600 hover:text-indigo-800 underline"
                                data-item-id="${itemId}"
                                onclick="event.stopPropagation(); window.openAIDetail('${itemId}')"
                           >
                                ğŸ“Š è©³ç´°åˆ†æã‚’è¦‹ã‚‹
                            </button>
                        ` : ''
                }
                    </div>
                </div>
            `;
        }

        // è©³ç´°ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
        window.openAIDetail = function (itemId) {
            console.log('openAIDetail called with itemId:', itemId);
            console.log('Current aiResultDetails:', window.aiResultDetails);

            const data = window.aiResultDetails ? window.aiResultDetails[itemId] : null;
            if (data) {
                console.log('Found detail data:', data);
                showAIDetailModal(data.jobId, data.jobTitle, data.company, data.score, data.details);
            } else {
                console.error('AI detail data not found for itemId:', itemId);
                alert('è©³ç´°ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        };

        // AIè©³ç´°åˆ†æãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        window.showAIDetailModal = function (jobId, jobTitle, company, score, details) {
            const modalHtml = `
            <div class="mb-4">
                    <h4 class="text-lg font-bold text-gray-900 mb-1">${jobTitle}</h4>
                    <p class="text-sm text-gray-600 mb-2">${company}</p>
                    <div class="inline-block bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-bold">
                        ãƒãƒƒãƒåº¦: ${score}%
                    </div>
                </div>
            <div class="bg-gray-50 p-4 rounded-lg">
                <pre class="whitespace-pre-wrap text-sm text-gray-800 font-sans">${details}</pre>
            </div>
        `;

            $('#ai-detail-modal-content').html(modalHtml);
            $('#ai-detail-modal').removeClass('hidden');
        }

        window.closeAIDetailModal = function () {
            $('#ai-detail-modal').addClass('hidden');
        }

        // ä¸€æ‹¬æ¨è–¦/AIãƒãƒƒãƒãƒ³ã‚°è¨ºæ–­ã‚’é€ä¿¡
        // ä¸€æ‹¬æ¨è–¦/AIãƒãƒƒãƒãƒ³ã‚°è¨ºæ–­ã‚’é€ä¿¡
        window.submitBulkRecommendation = async function () {
            const btn = event.target.closest('button');
            const originalHtml = $(btn).html();
            $(btn).html('<i class="fas fa-spinner fa-spin mr-2"></i>å‡¦ç†ä¸­...').prop('disabled', true);

            const isCandidate = currentUser && currentUser.role === 'candidate';

            // å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®æ±ºå®š
            let targetUserId;
            let targetUserName;

            if (isCandidate) {
                targetUserId = currentUser.id;
                targetUserName = currentUser.name;
            } else {
                // ç®¡ç†è€…ãƒ»ã‚³ãƒ¼ãƒã®å ´åˆ
                if (!selectedTargetUserId) {
                    alert('AIç´¹ä»‹å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
                    $(btn).html(originalHtml).prop('disabled', false);
                    return;
                }
                targetUserId = selectedTargetUserId;
                targetUserName = selectedTargetUserName;
            }

            try {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
                const { data: userData, error: userFetchError } = await supabase
                    .from('users')
                    .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                    .eq('id', targetUserId)
                    .single();

                if (userFetchError) throw userFetchError;

                // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã®ãƒ•ãƒ©ãƒƒãƒˆåŒ– (AI-Matchingé–¢æ•°ã¸æ¸¡ã™ãŸã‚)
                const profile = Array.isArray(userData.candidate_profiles) ? userData.candidate_profiles[0] : userData.candidate_profiles;
                const user = { ...userData, ...profile };
                console.log('Sending User to AI-Matching:', user);

                // å„æ±‚äººã«å¯¾ã—ã¦æ¨è–¦ã‚’ä½œæˆ
                const jobIds = Array.from(selectedJobIds);
                const { data: jobs } = await supabase
                    .from('jobs')
                    .select('*, companies(*)')
                    .in('id', jobIds);

                // AIåˆ†æAPIã‚’å‘¼ã³å‡ºã™
                let recommendations = [];
                try {
                    const { data: aiResults, error: aiError } = await supabase.functions.invoke('ai-matching', {
                        body: { user, jobs }
                    });

                    if (aiError) throw aiError;

                    recommendations = aiResults.map(result => {
                        const job = jobs.find(j => j.id === result.job_id);
                        // ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã®ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ï¼ˆAIã‚¹ã‚³ã‚¢ãŒå–å¾—ã§ããªã‹ã£ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
                        const ruleBased = calculateClientSideMatchScores(job, user);

                        return {
                            organization_id: currentUser.organization_id,
                            user_id: targetUserId,
                            job_id: result.job_id,
                            reason: result.recommendation_reason || result.reason || 'AIãƒãƒƒãƒãƒ³ã‚°',
                            score: result.match_score || ruleBased.match_score || 0,
                            recommended_by: currentUser.id,
                            job_title: job ? job.title : '',
                            company: job ? (job.companies?.name || job.company) : '',
                            details: result.details, // è©³ç´°åˆ†æçµæœ
                            culture_score: result.culture_match_score || ruleBased.culture_match_score || 0
                        };
                    });
                } catch (e) {
                    console.warn('AI Matching Function failed, falling back to dummy logic:', e);
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆãƒ€ãƒŸãƒ¼ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
                    recommendations = jobs.map(job => {
                        const score = Math.floor(Math.random() * 65) + 30;
                        return {
                            organization_id: currentUser.organization_id,
                            user_id: targetUserId,
                            job_id: job.id,
                            reason: generateSimpleReason(job, user),
                            score: score,
                            recommended_by: currentUser.id,
                            job_title: job.title,
                            company: job.company
                        };
                    });
                }

                // DBã«ä¿å­˜ï¼ˆdetailsã¨culture_scoreã‚‚å«ã‚ã‚‹ï¼‰
                const dbRecommendations = recommendations.map(r => {
                    const { job_title, company, ...dbRecord } = r;
                    return dbRecord;
                });

                const { error } = await supabase
                    .from('recommendations')
                    .insert(dbRecommendations);

                if (error) throw error;

                // ãƒ­ã‚°è¨˜éŒ²
                await auditLog.bulkRecommendationExecuted(recommendations.length, {
                    target_user_id: targetUserId,
                    job_ids: Array.from(selectedJobIds)
                });

                // çµæœã‚’åˆ†é¡
                const recommended = recommendations.filter(r => r.score >= 50);
                const excluded = recommendations.filter(r => r.score < 50);

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                closeBulkRecommendModal();

                // çµæœãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                showAIResultModal(recommended, excluded, targetUserName);

                selectedJobIds.clear();
                updateBulkRecommendBar();
                searchJobs(); // æ±‚äººãƒªã‚¹ãƒˆã‚’æ›´æ–°

            } catch (error) {
                console.error('Failed to submit bulk recommendations:', error);
                alert('ä¸€æ‹¬æ¨è–¦ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
            } finally {
                $(btn).html(originalHtml).prop('disabled', false);
            }
        }

        // ============================================
        // æ±‚äººèµ·ç‚¹ãƒãƒƒãƒãƒ³ã‚°æ©Ÿèƒ½
        // ============================================

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        window.currentJobId = null;
        window.jobMatchesCache = [];

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
        window.switchJobDetailTab = function (tab) {
            // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
            $('.job-detail-tab').each(function () {
                $(this).removeClass('border-indigo-600 text-indigo-600');
                $(this).addClass('border-transparent text-gray-500');
            });

            if (tab === 'details') {
                $('#job-tab-details').removeClass('border-transparent text-gray-500');
                $('#job-tab-details').addClass('border-indigo-600 text-indigo-600');
                $('#job-detail-tab-content').removeClass('hidden');
                $('#job-candidates-tab-content').addClass('hidden');
            } else if (tab === 'candidates') {
                $('#job-tab-candidates').removeClass('border-transparent text-gray-500');
                $('#job-tab-candidates').addClass('border-indigo-600 text-indigo-600');
                $('#job-detail-tab-content').addClass('hidden');
                $('#job-candidates-tab-content').removeClass('hidden');

                // å€™è£œè€…ã‚¿ãƒ–ã‚’é–‹ã„ãŸã¨ãã«ã€ã¾ã ãƒãƒƒãƒãƒ³ã‚°ã‚’å®Ÿè¡Œã—ã¦ã„ãªã‘ã‚Œã°æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
                if (jobMatchesCache.length === 0) {
                    loadJobMatches();
                }
            }
        }

        // ãƒãƒƒãƒãƒ³ã‚°å®Ÿè¡Œ
        // ãƒãƒƒãƒãƒ³ã‚°å®Ÿè¡Œ (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰äºˆå‚™å®Ÿè£…)
        window.runJobMatching = async function () {
            if (!window.currentJobId || !currentUser) {
                alert('æ±‚äººæƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“');
                return;
            }

            const btn = $('#run-matching-btn');
            const originalHtml = btn.html();

            try {
                // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                btn.prop('disabled', true);
                btn.html('<i class="fas fa-spinner fa-spin mr-2"></i>ãƒãƒƒãƒãƒ³ã‚°ä¸­...');

                console.log('Running job matching (Client-Side) for job:', window.currentJobId);

                // 1. æ±‚äººæƒ…å ±ã‚’å–å¾—
                const { data: job, error: jobError } = await window.supabase
                    .from('jobs')
                    .select('*')
                    .eq('id', window.currentJobId)
                    .single();

                if (jobError) throw jobError;

                // 2. å€™è£œè€…ã‚’å–å¾—ï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«çµåˆï¼‰
                const { data: candidates, error: candError } = await window.supabase
                    .from('users')
                    .select('*, candidate_profiles(*)')
                    .eq('organization_id', currentUser.organization_id)
                    .eq('role', 'candidate');

                if (candError) throw candError;

                console.log(`Found ${candidates.length} candidates`);

                // 3. ãƒãƒƒãƒãƒ³ã‚°ã‚¹ã‚³ã‚¢è¨ˆç®—
                const matches = candidates.map(user => {
                    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã®çµåˆ
                    const profile = Array.isArray(user.candidate_profiles) ? (user.candidate_profiles[0] || {}) : (user.candidate_profiles || {});
                    const candidate = { ...user, ...profile };

                    // ã‚¹ã‚³ã‚¢è¨ˆç®—
                    const scores = calculateClientSideMatchScores(job, candidate);

                    return {
                        job_id: window.currentJobId,
                        candidate_id: user.id,
                        organization_id: currentUser.organization_id,
                        candidate: candidate, // Ensure candidate object is passed for rendering
                        ...scores,
                        recommendation_reason: generateClientSideRecommendationReason(job, candidate, scores),
                        recommendation_details: {
                            job_requirements: extractClientSideJobRequirements(job),
                            candidate_strengths: extractClientSideCandidateStrengths(candidate),
                            match_points: identifyClientSideMatchPoints(job, candidate, scores)
                        },
                        matched_at: new Date().toISOString()
                    };
                });

                // 4. ã‚¹ã‚³ã‚¢ã§ã‚½ãƒ¼ãƒˆ & ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                matches.sort((a, b) => b.match_score - a.match_score);
                const limit = 30;
                const topMatches = matches.filter(m => m.match_score >= 20).slice(0, limit); // å°‘ã—ç·©ã‚ã«20ç‚¹ä»¥ä¸Š

                console.log(`Top ${topMatches.length} matches calculated`);

                // 5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
                // DBã«å­˜åœ¨ã—ãªã„ã‚«ãƒ©ãƒ  (candidateãªã©) ã‚’é™¤å¤–ã—ã¦ä¿å­˜ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
                const upsertData = topMatches.map(({ candidate, ...rest }) => rest);

                const { error: insertError } = await window.supabase
                    .from('job_candidate_matches')
                    .upsert(upsertData, {
                        onConflict: 'job_id,candidate_id',
                        ignoreDuplicates: false
                    });

                if (insertError) throw insertError;

                // 4. çµæœè¡¨ç¤ºï¼ˆå…±é€šé–¢æ•°ã‚’ä½¿ç”¨ï¼‰
                renderMatchingResults(matches, '#job-candidates-list');

                alert(`${matches.length} ä»¶ã®å€™è£œè€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼ˆãƒãƒƒãƒ: ${matches.filter(m => m.match_score > 49).length} ä»¶ï¼‰`);

            } catch (error) {
                console.error('Job matching error:', error);
                alert('ãƒãƒƒãƒãƒ³ã‚°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
            } finally {
                // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                btn.prop('disabled', false);
                btn.html(originalHtml);
            }
        }

        // ============================================
        // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒãƒƒãƒãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯
        // ============================================

        const CRITICAL_KEYWORDS = [
            'ç¨å‹™', 'æ³•å‹™', 'çµŒç†', 'è²¡å‹™', 'ä¼šè¨ˆ', 'äººäº‹', 'åŠ´å‹™', 'æ¡ç”¨',
            'ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢', 'ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼', 'SE', 'é–‹ç™º', 'ã‚¤ãƒ³ãƒ•ãƒ©', 'ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰', 'ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰', ,
            'åŒ»å¸«', 'çœ‹è­·å¸«', 'è–¬å‰¤å¸«', 'å¼è­·å£«', 'ä¼šè¨ˆå£«', 'ç¨ç†å£«',
            'å–¶æ¥­', 'ã‚»ãƒ¼ãƒ«ã‚¹', 'ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°', 'åºƒå ±'
        ];
        const WELCOME_KEYWORDS = ['æœªçµŒé¨“', 'ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«', 'ä¸å•', 'æŒ‘æˆ¦', 'åˆå¿ƒè€…', 'ç¬¬äºŒæ–°å’'];

        function calculateClientSideMatchScores(job, candidate) {
            let skillScore = 50;
            let experienceScore = 50;
            let locationScore = 50;
            let salaryScore = 50;
            let cultureScore = 50;

            const jobReqs = extractClientSideSkills(job.requirements);
            const candSkills = extractClientSideSkills(candidate.skills);

            // Skill
            if (jobReqs.length > 0) {
                const matchCount = jobReqs.filter(js => candSkills.some(cs => cs.includes(js) || js.includes(cs))).length;
                skillScore = Math.min(100, (matchCount / jobReqs.length) * 100 + 20);
            } else {
                skillScore = candSkills.length > 0 ? 60 : 40;
            }

            // Experience (Title match)
            const jobTitle = (job.title || '').toLowerCase();
            const workHistory = (candidate.work_history || '').toLowerCase();
            if (workHistory.includes(jobTitle) || jobTitle.includes(candidate.desired_job_type || '#####')) {
                experienceScore = 80;
            } else if (workHistory.length > 10) {
                experienceScore = 60;
            }

            // Salary
            // Salary
            if (candidate.desired_salary) {
                // If candidate wants more than Job Max (and Max is set), it's a mismatch
                if (job.salary_max && candidate.desired_salary > job.salary_max) {
                    salaryScore = 20;
                } else if (job.salary_min) {
                    // If candidate matches Min or is reasonably within range
                    if (candidate.desired_salary <= job.salary_min * 1.2) salaryScore = 80;
                    else if (candidate.desired_salary <= job.salary_min * 1.5) salaryScore = 60;
                    else salaryScore = 40;
                }
            }

            // Keyword Count for Penalty
            const requirementsText = (job.requirements || '').toLowerCase();
            const candidateText = JSON.stringify(candidate).toLowerCase();
            const isUnskilledWelcome = WELCOME_KEYWORDS.some(w => (job.title + requirementsText).includes(w));

            let match_score = (skillScore * 0.4 + experienceScore * 0.3 + salaryScore * 0.3);

            // Simple Penalty
            if (!isUnskilledWelcome && match_score < 40) match_score *= 0.8;

            return {
                match_score: Math.round(match_score),
                skill_match_score: Math.round(skillScore),
                experience_match_score: Math.round(experienceScore),
                location_match_score: Math.round(locationScore),
                salary_match_score: Math.round(salaryScore),
                culture_match_score: Math.round(cultureScore)
            };
        }

        function extractClientSideSkills(text) {
            if (!text) return [];
            return text.split(/[,ã€\n\s]/).map(s => s.trim().toLowerCase()).filter(s => s.length > 1);
        }

        function generateClientSideRecommendationReason(job, candidate, scores) {
            if (scores.match_score >= 60) return 'æ¡ä»¶ãŒæ¦‚ã­ä¸€è‡´ã—ã¦ãŠã‚Šã€æœ‰åŠ›ãªå€™è£œã§ã™ã€‚';
            if (scores.skill_match_score >= 70) return 'ã‚¹ã‚­ãƒ«ã‚»ãƒƒãƒˆãŒãƒãƒƒãƒã—ã¦ã„ã¾ã™ãŒã€ä»–ã®æ¡ä»¶ã§èª¿æ•´ãŒå¿…è¦ã§ã™ã€‚';
            return 'ä¸€éƒ¨è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“ãŒã€ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«æ¡ç”¨ã¨ã—ã¦æ¤œè¨å¯èƒ½ã§ã™ã€‚'
        }

        function extractClientSideJobRequirements(job) {
            return { title: job.title, skills: extractClientSideSkills(job.requirements || '') };
        }
        function extractClientSideCandidateStrengths(candidate) {
            return { name: candidate.name, skills: extractClientSideSkills(candidate.skills || '') };
        }
        function identifyClientSideMatchPoints(job, candidate, scores) {
            const pts = [];
            if (scores.skill_match_score >= 60) pts.push('ã‚¹ã‚­ãƒ«');
            if (scores.experience_match_score >= 60) pts.push('çµŒé¨“');
            return pts;
        }

        // æ—¢å­˜ã®ãƒãƒƒãƒãƒ³ã‚°çµæœã‚’èª­ã¿è¾¼ã¿
        async function loadJobMatches() {
            if (!window.currentJobId || !currentUser) return;

            try {
                const { data, error } = await window.supabase
                    .from('job_candidate_matches')
                    .select('*, users(*)')
                    .eq('job_id', window.currentJobId)
                    .eq('organization_id', currentUser.organization_id)
                    .gte('match_score', 50)
                    .order('match_score', { ascending: false })
                    .limit(30);

                if (error) throw error;

                jobMatchesCache = data || [];

                // å€™è£œè€…æ•°ã‚’è¡¨ç¤º
                $('#job-candidates-count').text(jobMatchesCache.length);

                if (jobMatchesCache.length > 0) {
                    renderJobCandidates(jobMatchesCache);
                }

            } catch (error) {
                console.error('Load matches error:', error);
            }
        }

        // å…±é€šãƒãƒƒãƒãƒ³ã‚°çµæœãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•°
        function renderMatchingResults(matches, containerSelector) {
            const container = $(containerSelector);
            container.empty();

            if (!matches || matches.length === 0) {
                container.html(`
            <div class="text-center py-12 text-gray-500 shadow-sm border rounded-lg bg-white">
                        <i class="fas fa-search text-4xl mb-3"></i>
                        <p>ãƒãƒƒãƒã™ã‚‹å€™è£œè€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>
                    </div>
            `);
                return;
            }

            const okMatches = matches.filter(m => m.match_score > 49);
            const ngMatches = matches.filter(m => m.match_score <= 49);

            const containerId = containerSelector.replace('#', '');

            const headerHtml = `
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden mb-6">
                <div class="flex border-b border-gray-100 items-center">
                    <button onclick="switchMatchTab('${containerSelector}', 'ok')"
                        id="${containerId}-tab-ok"
                        class="flex-1 py-4 px-6 text-sm font-bold border-b-2 border-green-500 text-green-600 transition-all hover:bg-green-50">
                        <i class="fas fa-check-circle mr-2"></i>ãƒãƒƒãƒ: ${okMatches.length}ä»¶
                    </button>
                    <button onclick="switchMatchTab('${containerSelector}', 'ng')"
                        id="${containerId}-tab-ng"
                        class="flex-1 py-4 px-6 text-sm font-bold border-b-2 border-transparent text-gray-400 transition-all hover:bg-gray-50">
                        <i class="fas fa-times-circle mr-2"></i>NG: ${ngMatches.length}ä»¶
                    </button>
                    <div class="px-4 border-l border-gray-100">
                        <button onclick="$('${containerSelector}').html('<div class=\\'text-center py-12 text-gray-500 rounded-lg border bg-white shadow-sm\\'><i class=\\'fas fa-search text-4xl mb-3\\'></i><p>æ¡ä»¶ã‚’æŒ‡å®šã—ã¦æ¤œç´¢ã—ã¦ãã ã•ã„</p></div>')"
                            class="text-xs text-gray-400 hover:text-red-500 flex flex-col items-center gap-1 transition-colors">
                            <i class="fas fa-trash-alt"></i>
                            <span>ã‚¯ãƒªã‚¢</span>
                        </button>
                    </div>
                </div>
                </div>

                <div id="${containerId}-pane-ok" class="space-y-4">
                    ${okMatches.length > 0 ? okMatches.map(m => renderCandidateCard(m)).join('') : `
                        <div class="text-center py-16 bg-white border border-dashed border-gray-300 rounded-lg text-gray-400">
                            <i class="fas fa-info-circle mb-2 text-2xl"></i>
                            <p>ãƒãƒƒãƒã™ã‚‹å€™è£œè€…ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>
                        </div>
                    `}
                </div>
                <div id="${containerId}-pane-ng" class="space-y-4 hidden">
                    ${ngMatches.length > 0 ? ngMatches.map(m => renderCandidateCard(m)).join('') : `
                        <div class="text-center py-16 bg-white border border-dashed border-gray-300 rounded-lg text-gray-400">
                            <i class="fas fa-info-circle mb-2 text-2xl"></i>
                            <p>NGå€™è£œè€…ã¯ã„ã¾ã›ã‚“</p>
                        </div>
                    `}
                </div>
        `;

            container.html(headerHtml);
        }

        window.switchMatchTab = function (containerSelector, tab) {
            const containerId = containerSelector.replace('#', '');
            const tabOk = $(`#${containerId}-tab-ok`);
            const tabNg = $(`#${containerId}-tab-ng`);
            const paneOk = $(`#${containerId}-pane-ok`);
            const paneNg = $(`#${containerId}-pane-ng`);

            if (tab === 'ok') {
                tabOk.addClass('border-green-500 text-green-600').removeClass('border-transparent text-gray-400');
                tabNg.addClass('border-transparent text-gray-400').removeClass('border-red-500 text-red-600'); // red-500 if we want NG to be red, but image shows gray
                // Applying gray style for non-active as default in HTML, so here just toggle
                tabNg.addClass('border-transparent text-gray-400').removeClass('border-gray-600 text-gray-800');

                paneOk.removeClass('hidden');
                paneNg.addClass('hidden');
            } else {
                tabNg.addClass('border-gray-600 text-gray-800').removeClass('border-transparent text-gray-400');
                tabOk.addClass('border-transparent text-gray-400').removeClass('border-green-500 text-green-600');

                paneNg.removeClass('hidden');
                paneOk.addClass('hidden');
            }
        }

        // å€™è£œè€…ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º (Deprecated: use renderMatchingResults)
        function renderJobCandidates(matches) {
            renderMatchingResults(matches, '#job-candidates-list');
        }

        // å€™è£œè€…ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
        function renderCandidateCard(match) {
            const candidate = match.users || match.candidate || {};
            const matchScore = match.match_score || 0;
            const skillScore = match.skill_match_score || 0;
            const expScore = match.experience_match_score || 0;
            const locScore = match.location_match_score || 0;
            const salScore = match.salary_match_score || 0;
            const culScore = match.culture_match_score || 0;

            // ã‚¹ã‚³ã‚¢ã«å¿œã˜ãŸè‰²
            // ã‚¹ã‚³ã‚¢ã«å¿œã˜ãŸè‰²
            const getScoreColor = (score) => {
                if (score >= 80) return 'text-green-600 bg-green-50';
                if (score >= 60) return 'text-blue-600 bg-blue-50';
                if (score >= 50) return 'text-yellow-600 bg-yellow-50';
                return 'text-gray-500 bg-gray-100 border border-gray-200'; // NG (<= 49)
            };

            const getScoreBarColor = (score) => {
                if (score >= 80) return 'bg-green-500';
                if (score >= 60) return 'bg-blue-500';
                if (score >= 50) return 'bg-yellow-500';
                return 'bg-gray-300';
            };

            const renderScoreBar = (label, score, colorClass) => {
                return `
            <div class="text-center">
                        <div class="text-xs text-gray-500 mb-1">${label}</div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mb-1">
                            <div class="${colorClass} h-2 rounded-full transition-all" style="width: ${score}%"></div>
                        </div>
                        <div class="text-xs font-semibold text-gray-700">${score.toFixed(0)}%</div>
                    </div>
            `;
            };

            return `
            <div class="border rounded-lg p-6 hover:shadow-lg transition bg-white">
                <div class="flex justify-between items-start gap-4">
                    <div class="mr-2 pt-1 flex flex-col items-center">
                        <input type="checkbox"
                            class="candidate-select-checkbox h-5 w-5 rounded border-gray-300 focus:ring-indigo-500 cursor-pointer ${candidate.status === 'suspended' ? 'text-gray-400 bg-gray-100 cursor-not-allowed opacity-50' : 'text-indigo-600'}"
                            value="${candidate.id}"
                            ${candidate.status === 'suspended' ? 'disabled' : ''}>
                            ${candidate.status === 'suspended' ? '<span class="text-[10px] text-red-500 font-bold mt-1 nowrap">åœæ­¢ä¸­</span>' : ''}
                    </div>
                    <div class="flex-1">
                        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                        <div class="flex items-center gap-3 mb-3">
                            <h4 class="font-semibold text-lg text-gray-900">${candidate.name || 'åå‰æœªè¨­å®š'}</h4>
                            <span class="px-3 py-1 ${getScoreColor(matchScore)} rounded-full text-sm font-medium">
                                ãƒãƒƒãƒåº¦: ${matchScore.toFixed(1)}%
                            </span>
                            <span class="px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full ${candidate.management_status === 'inactive' ? 'bg-gray-200 text-gray-700' : 'bg-blue-100 text-blue-800'}">
                                ${candidate.management_status === 'inactive' ? 'æ´»å‹•çµ‚äº†' : 'æ´»å‹•ä¸­'}
                            </span>
                        </div>

                        <!-- åŸºæœ¬æƒ…å ± -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-4 text-sm text-gray-600">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-briefcase text-gray-400"></i>
                                <span>${window.formatArrayValue(candidate.desired_job_type)}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-map-marker-alt text-gray-400"></i>
                                <span>${window.formatArrayValue(candidate.desired_location)}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-yen-sign text-gray-400"></i>
                                <span>${window.formatSalaryValue(candidate.desired_salary)}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-envelope text-gray-400"></i>
                                <span class="text-xs">${candidate.email || ''}</span>
                            </div>
                        </div>

                        <!-- ãƒãƒƒãƒãƒ³ã‚°è©³ç´°ã‚¹ã‚³ã‚¢ -->
                        <div class="mb-4">
                            <div class="text-xs text-gray-500 mb-2">è©³ç´°ã‚¹ã‚³ã‚¢</div>
                            <div class="grid grid-cols-5 gap-2">
                                ${renderScoreBar('ã‚¹ã‚­ãƒ«', skillScore, getScoreBarColor(skillScore))}
                                ${renderScoreBar('çµŒé¨“', expScore, getScoreBarColor(expScore))}
                                ${renderScoreBar('å‹¤å‹™åœ°', locScore, getScoreBarColor(locScore))}
                                ${renderScoreBar('å¹´å', salScore, getScoreBarColor(salScore))}
                                ${renderScoreBar('æ–‡åŒ–', culScore, getScoreBarColor(culScore))}
                            </div>
                        </div>

                        <!-- AIè©•ä¾¡ç†ç”± -->
                        ${match.recommendation_reason ? `
                            <div class="${matchScore >= 50 ? 'bg-blue-50 border-blue-400' : 'bg-gray-50 border-gray-400'} border-l-4 p-3 mb-3">
                                <div class="flex items-start gap-2">
                                    <i class="fas ${matchScore >= 50 ? 'fa-lightbulb text-blue-600' : 'fa-clipboard-list text-gray-500'} mt-1"></i>
                                    <div class="flex-1">
                                        <p class="text-sm ${matchScore >= 50 ? 'text-blue-800' : 'text-gray-700'} font-medium">AIè©•ä¾¡ç†ç”±</p>
                                        <p class="text-sm ${matchScore >= 50 ? 'text-blue-700' : 'text-gray-600'}">${match.recommendation_reason}</p>
                                    </div>
                                </div>
                            </div>
                            ` : ''}

                        <!-- ã‚¹ã‚­ãƒ« -->
                        ${candidate.skills ? `
                            <div class="text-sm">
                                <span class="text-gray-600">ã‚¹ã‚­ãƒ«:</span>
                                <span class="text-gray-800">${window.formatArrayValue(candidate.skills)}</span>
                            </div>
                            ` : ''}
                    </div>

                    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                    <div class="flex flex-col gap-2">
                        <button onclick="viewCandidateProfile('${candidate.id}')" class="px-4 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 text-sm whitespace-nowrap">
                            <i class="fas fa-user mr-1"></i>è©³ç´°
                        </button>
                        <button onclick="showAdminUserModal('${candidate.id}')" class="px-4 py-2 bg-amber-50 text-amber-700 border border-amber-200 rounded hover:bg-amber-100 text-sm whitespace-nowrap">
                            <i class="fas fa-edit mr-1"></i>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†
                        </button>
                        <button onclick="openScoutModal('${match.id || ''}', '${candidate.id}')" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm whitespace-nowrap shadow-sm">
                            <i class="fas fa-magic mr-1"></i>ã‚¹ã‚«ã‚¦ãƒˆä½œæˆ
                        </button>
                        <button onclick="updateMatchStatus('${match.id || ''}', 'not_interested', '${candidate.id}')"
                            class="px-4 py-2 bg-red-100 text-red-700 rounded hover:bg-red-200 text-sm whitespace-nowrap">
                            <i class="fas fa-times mr-1"></i>å¯¾è±¡å¤–
                        </button>
                    </div>
                </div>
                </div>
            `;
        }

        // ã‚¹ã‚«ã‚¦ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®å¤‰æ•°
        let currentScoutMatchId = null;
        let currentScoutCandidateId = null;

        // ã‚¹ã‚«ã‚¦ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆAIç”Ÿæˆå®Ÿè¡Œï¼‰
        window.openScoutModal = async function (matchId, candidateId) {
            console.log('openScoutModal called:', { matchId, candidateId });

            let actualJobId = window.selectedTargetJobId || window.currentJobId;
            if (!actualJobId) {
                alert('å¯¾è±¡ã®æ±‚äººãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            let targetMatchId = (matchId && matchId !== 'undefined') ? matchId : null;

            // ãƒãƒƒãƒãƒ¬ã‚³ãƒ¼ãƒ‰ãŒãªã„å ´åˆã¯ä½œæˆã‚’è©¦ã¿ã‚‹
            if (!targetMatchId) {
                showLoading('æº–å‚™ä¸­...');
                try {
                    // æ—¢å­˜ã®ãƒãƒƒãƒãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª
                    const { data: existing, error: checkError } = await window.supabase
                        .from('job_candidate_matches')
                        .select('id')
                        .eq('job_id', actualJobId)
                        .eq('candidate_id', candidateId)
                        .maybeSingle();

                    if (checkError) throw checkError;

                    if (existing) {
                        targetMatchId = existing.id;
                    } else {
                        // æ–°è¦ä½œæˆ
                        const { data, error } = await window.supabase
                            .from('job_candidate_matches')
                            .insert({
                                job_id: actualJobId,
                                candidate_id: candidateId,
                                status: 'draft',
                                organization_id: currentUser.organization_id
                            })
                            .select('id')
                            .single();

                        if (error) throw error;
                        targetMatchId = data.id;
                    }
                } catch (e) {
                    console.error('Failed to create match for scout:', e);
                    alert('æº–å‚™ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
                    hideLoading();
                    return;
                } finally {
                    hideLoading();
                }
            }

            console.log('Match ID obtained:', targetMatchId);
            currentScoutMatchId = targetMatchId;
            currentScoutCandidateId = candidateId;

            // å€™è£œè€…åã‚’è¡¨ç¤º
            let candidateName = 'å€™è£œè€…';
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰æ¢ã™
            if (typeof jobMatchesCache !== 'undefined') {
                const m = jobMatchesCache.find(m => m.id === targetMatchId || (m.candidate && m.candidate.id === candidateId) || (m.users && m.id === targetMatchId));
                if (m) candidateName = (m.users ? m.users.name : (m.candidate ? m.candidate.name : 'å€™è£œè€…'));
            }
            if (candidateName === 'å€™è£œè€…') {
                // ã•ã‚‰ã«è©³ç´°ãƒœã‚¿ãƒ³ç­‰ã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã‚‹
                candidateName = $(`button[onclick *= "'${candidateId}'"]`).closest('.border').find('h3, .text-lg.font-bold').first().text().trim() || 'å€™è£œè€…';
            }

            console.log('Candidate name:', candidateName);
            $('#scout-candidate-name').text(candidateName);

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ï¼‰
            console.log('Opening scout modal...');
            $('#scout-subject').val('ç”Ÿæˆä¸­...');
            $('#scout-body').val('AIãŒã‚¹ã‚«ã‚¦ãƒˆæ–‡é¢ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...\nå°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚');

            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸Šéƒ¨ã«ç§»å‹•
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’bodyã®ç›´ä¸‹ã«ç§»å‹•ï¼ˆè¦ªè¦ç´ ã®hiddenã‚¯ãƒ©ã‚¹ã®å½±éŸ¿ã‚’å—ã‘ãªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰
            const modal = document.getElementById('scout-modal');
            if (modal && modal.parentElement.id !== 'body') {
                document.body.appendChild(modal);
            }

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            $('#scout-modal').removeClass('hidden').css('display', 'flex');

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            const isVisible = !$('#scout-modal').hasClass('hidden');
            const displayStyle = $('#scout-modal').css('display');
            console.log('Modal visibility after opening:', isVisible);
            console.log('Modal display style:', displayStyle);
            console.log('Modal element:', $('#scout-modal')[0]);

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å½“ã¦ã‚‹
            $('#scout-modal').focus();

            console.log('Calling generateScoutMessage...');
            await generateScoutMessage(actualJobId, currentScoutCandidateId, currentScoutMatchId);
            console.log('generateScoutMessage completed');

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒã¾ã è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            setTimeout(() => {
                const stillVisible = !$('#scout-modal').hasClass('hidden');
                console.log('Modal still visible after 100ms:', stillVisible);
                if (!stillVisible) {
                    console.error('Modal was closed unexpectedly!');
                }
            }, 100);
        }

        // ã‚¹ã‚«ã‚¦ãƒˆæ–‡é¢ç”Ÿæˆï¼ˆå†ç”Ÿæˆï¼‰
        window.regenerateScoutMessage = async function () {
            if (!currentScoutMatchId) return;
            const actualJobId = window.selectedTargetJobId || window.currentJobId;

            $('#scout-body').val('AIãŒã‚¹ã‚«ã‚¦ãƒˆæ–‡é¢ã‚’å†ç”Ÿæˆã—ã¦ã„ã¾ã™...');
            await generateScoutMessage(actualJobId, currentScoutCandidateId, currentScoutMatchId);
        }

        // Edge Functionã‚’å‘¼ã³å‡ºã—ã¦æ–‡é¢ç”Ÿæˆ
        async function generateScoutMessage(jobId, candidateId, matchId) {
            console.log('generateScoutMessage called with:', { jobId, candidateId, matchId });

            if (!jobId || !candidateId) {
                console.error('generateScoutMessage: Missing jobId or candidateId', { jobId, candidateId });
                throw new Error('job_id and candidate_id are required');
            }
            try {
                console.log('Calling Edge Function: generate-scout-message');
                const { data, error } = await window.supabase.functions.invoke('generate-scout-message', {
                    body: {
                        job_id: jobId,
                        candidate_id: candidateId,
                        match_id: matchId
                    }
                });

                console.log('Edge Function response:', { data, error });

                if (error) throw error;

                if (data.success) {
                    console.log('Scout message generated successfully');
                    $('#scout-subject').val(data.subject);
                    // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚ŒãŸæ”¹è¡Œæ–‡å­—ã‚’å®Ÿéš›ã®æ”¹è¡Œã«å¤‰æ›
                    const bodyWithNewlines = data.body.replace(/\\n/g, '\n');
                    $('#scout-body').val(bodyWithNewlines);
                } else {
                    throw new Error(data.error || 'ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

            } catch (error) {
                console.error('Scout generation error:', error);
                alert('ã‚¹ã‚«ã‚¦ãƒˆæ–‡é¢ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                $('#scout-body').val('ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            }
        }

        // ã‚¹ã‚«ã‚¦ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        window.closeScoutModal = function () {
            console.log('closeScoutModal called');
            console.trace('Stack trace:');
            $('#scout-modal').addClass('hidden').css('display', 'none');
            currentScoutMatchId = null;
            currentScoutCandidateId = null;
        }

        // ã‚¹ã‚«ã‚¦ãƒˆé€ä¿¡å‡¦ç†
        window.sendScoutMessage = async function () {
            if (!currentScoutMatchId) return;

            const subject = $('#scout-subject').val();
            const body = $('#scout-body').val();

            if (!subject || !body) {
                alert('ä»¶åã¨æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (!confirm('ã“ã®å†…å®¹ã§ã‚¹ã‚«ã‚¦ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            try {
                showLoading('ã‚¹ã‚«ã‚¦ãƒˆé€ä¿¡ä¸­...');

                // 1. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
                await updateMatchStatus(currentScoutMatchId, 'contacted');

                // 2. å€™è£œè€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
                const { data: candidate, error: userError } = await supabase
                    .from('users')
                    .select('email, name')
                    .eq('id', currentScoutCandidateId)
                    .single();

                if (userError || !candidate) {
                    console.warn('å€™è£œè€…æƒ…å ±ã®å–å¾—å¤±æ•—:', userError);
                    alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯æ›´æ–°ã•ã‚Œã¾ã—ãŸãŒã€å€™è£œè€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå–å¾—ã§ããªã‹ã£ãŸãŸã‚ãƒ¡ãƒ¼ãƒ«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚');
                } else if (!candidate.email) {
                    alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯æ›´æ–°ã•ã‚Œã¾ã—ãŸãŒã€å€™è£œè€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæœªç™»éŒ²ã®ãŸã‚ãƒ¡ãƒ¼ãƒ«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚');
                } else {
                    // 3. ãƒ¡ãƒ¼ãƒ«é€ä¿¡Functionå‘¼ã³å‡ºã— (Resend)
                    const { data: emailData, error: emailError } = await supabase.functions.invoke('send-email', {
                        body: {
                            type: 'scout',
                            to: candidate.email,
                            data: {
                                userName: candidate.name || 'æ±‚è·è€…',
                                subject: subject,
                                body: body,
                                scoutUrl: window.location.origin // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ãªã©ã®URL
                            }
                        }
                    });

                    if (emailError) {
                        console.error('Email sending failed:', emailError);
                        alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯æ›´æ–°ã•ã‚Œã¾ã—ãŸãŒã€ãƒ¡ãƒ¼ãƒ«é€ä¿¡APIã®å‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n(Resend API Keyã®è¨­å®šç­‰ã‚’ã”ç¢ºèªãã ã•ã„)');
                    } else {
                        console.log('Email sent successfully:', emailData);
                        alert('ã‚¹ã‚«ã‚¦ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸï¼\n(å€™è£œè€…ã¸ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚’è¡Œã„ã¾ã—ãŸ)');
                    }
                }

                closeScoutModal();

            } catch (error) {
                console.error('Send scout error:', error);
                alert('é€ä¿¡å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // ãƒãƒƒãƒãƒ³ã‚°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        window.updateMatchStatus = async function (matchId, status, candidateId) {
            let targetMatchId = (matchId && matchId !== 'undefined' && matchId !== '') ? matchId : null;
            let jobId = (typeof selectedTargetJobId !== 'undefined' ? selectedTargetJobId : null) || window.selectedTargetJobId || window.currentJobId;

            try {
                if (!targetMatchId) {
                    if (!jobId || !candidateId) {
                        alert('å¯¾è±¡ã®æ±‚äººã¾ãŸã¯å€™è£œè€…ã‚’ç‰¹å®šã§ãã¾ã›ã‚“');
                        return;
                    }

                    const { data, error } = await window.supabase
                        .from('job_candidate_matches')
                        .upsert({
                            job_id: jobId,
                            candidate_id: candidateId,
                            status: status,
                            organization_id: currentUser.organization_id
                        }, { onConflict: 'job_id, candidate_id' })
                        .select('id')
                        .single();

                    if (error) throw error;
                    targetMatchId = data.id;
                } else {
                    const { error } = await window.supabase
                        .from('job_candidate_matches')
                        .update({ status: status })
                        .eq('id', targetMatchId);

                    if (error) throw error;
                }

                // ç”»é¢ä¸Šã®è¡¨ç¤ºã‚’æ›´æ–°
                if (status === 'not_interested') {
                    // å¯¾è±¡å¤–ã®å ´åˆã¯ã‚«ãƒ¼ãƒ‰ã‚’ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆã—ã¦ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                    // ã‚»ãƒ¬ã‚¯ã‚¿ã‚’æŸ”è»Ÿã«ï¼ˆIDãŒã‚ã‚‹å ´åˆã¨ãªã„å ´åˆä¸¡æ–¹å¯¾å¿œï¼‰
                    let selector = `button[onclick *= "'${targetMatchId}', 'not_interested'"]`;
                    if (candidateId) selector += `, button[onclick *= "'${candidateId}')"]`;

                    const card = $(selector).closest('.border');
                    card.addClass('opacity-50 bg-gray-100');
                    card.find('button').prop('disabled', true);
                    card.find('.status-badge').remove();
                    card.find('.flex.justify-between').append('<span class="status-badge px-2 py-1 bg-red-100 text-red-800 text-xs rounded">å¯¾è±¡å¤–</span>');
                }

            } catch (error) {
                console.error('Update match status error:', error);
                alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                throw error;
            }
        }
        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: JSONé…åˆ—æ–‡å­—åˆ—ã‹ã‚‚ã—ã‚Œãªã„å€¤ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦é…åˆ—ã¾ãŸã¯æ–‡å­—åˆ—ã¨ã—ã¦è¿”ã™
        window.safeParseList = function (val) {
            if (!val) return null;
            if (Array.isArray(val)) return val;
            if (typeof val === 'string') {
                val = val.trim();
                if (val.startsWith('[') && val.endsWith(']')) {
                    try {
                        return JSON.parse(val);
                    } catch (e) {
                        // ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã®å ´åˆã‚„ã€ä¸æ­£ãªJSONã®å ´åˆã®ãƒªã‚«ãƒãƒª
                        try {
                            // ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚’ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã«ç½®æ›ã—ã¦å†ãƒˆãƒ©ã‚¤
                            return JSON.parse(val.replace(/'/g, '"'));
                        } catch (e2) {
                            return val;
                        }
                    }
                }
            }
            return val;
        }

        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: é…åˆ—ã¾ãŸã¯æ–‡å­—åˆ—ã‚’è¡¨ç¤ºç”¨ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        window.formatArrayValue = function (val) {
            const parsed = window.safeParseList(val);
            if (Array.isArray(parsed)) {
                return parsed.join(' / ');
            }
            return parsed || '-';
        }

        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: å¹´åã‚’è¡¨ç¤ºç”¨ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ (ä¸‡å††å˜ä½)
        window.formatSalaryValue = function (val) {
            if (!val) return '-';
            // æ•°å€¤ä»¥å¤–ã‚’é™¤å»
            const strVal = String(val).replace(/[^0-9]/g, '');
            if (!strVal) return val; // æ•°å€¤ãŒå«ã¾ã‚Œãªã„å ´åˆã¯ãã®ã¾ã¾è¿”ã™

            let num = parseInt(strVal);
            if (isNaN(num)) return val;

            // 10ä¸‡å††ä»¥ä¸Šã®å ´åˆã¯å††å˜ä½ã¨ã¿ãªã—ã¦10000ã§å‰²ã‚‹
            if (num >= 100000) {
                num = Math.round(num / 10000);
            }
            return num.toLocaleString() + 'ä¸‡å††';
        }

        // å€™è£œè€…ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤ºï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å°‚ç”¨ï¼‰
        window.viewCandidateProfile = async function (candidateId) {
            if (!candidateId) {
                alert('å€™è£œè€…IDãŒå–å¾—ã§ãã¾ã›ã‚“');
                return;
            }

            $('#interview-candidate-id').val(candidateId);
            showLoading();

            showLoading();
            try {
                // å€™è£œè€…æƒ…å ±ã‚’å–å¾—
                const { data: userData, error } = await window.supabase
                    .from('users')
                    .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                    .eq('id', candidateId)
                    .single();

                if (error) throw error;
                if (!userData) {
                    alert('å€™è£œè€…æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                    return;
                }

                // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’çµåˆï¼ˆãƒ•ãƒ©ãƒƒãƒˆåŒ–ï¼‰
                const profile = Array.isArray(userData.candidate_profiles) ? userData.candidate_profiles[0] : (userData.candidate_profiles || {});
                const candidate = { ...userData, ...profile };

                $('#candidate-detail-title').text(candidate.name || 'åå‰æœªè¨­å®š');
                $('#candidate-email-header').text(candidate.email || '');
                $('#candidate-avatar-header').text(candidate.name ? candidate.name.charAt(0) : '?');

                // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ¡ã‚¿æƒ…å ± (å¹´é½¢ã€æ€§åˆ¥ã€å±…ä½åœ°)
                const metaParts = [];
                if (candidate.age) metaParts.push(`${candidate.age}æ­³`);
                if (candidate.gender) metaParts.push(candidate.gender);
                if (candidate.current_location) metaParts.push(candidate.current_location);

                if (metaParts.length > 0) {
                    $('#candidate-header-meta').text(metaParts.join(' / ')).show();
                } else {
                    $('#candidate-header-meta').hide();
                }

                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆ (ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ã‚’é™¤ã„ãŸè©³ç´°)
                const content = `
                    <!-- 1. å¸Œæœ›æ¡ä»¶ -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-star mr-2 text-yellow-500"></i>å¸Œæœ›æ¡ä»¶
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600 mb-1">å¸Œæœ›è·ç¨®</p>
                                <p class="font-medium text-gray-900">${window.formatArrayValue(candidate.desired_job_type)}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-1">å¸Œæœ›å‹¤å‹™åœ°</p>
                                <p class="font-medium text-gray-900">${window.formatArrayValue(candidate.desired_location)}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-1">å¸Œæœ›å¹´å</p>
                                <p class="font-medium text-gray-900 text-lg text-indigo-600">
                                    ${window.formatSalaryValue(candidate.desired_salary)}
                                </p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-1">é›‡ç”¨å½¢æ…‹</p>
                                <p class="font-medium text-gray-900">${window.formatArrayValue(candidate.desired_employment_type)}</p>
                            </div>
                            <div class="col-span-1 md:col-span-2">
                                <p class="text-sm text-gray-600 mb-2">ã“ã ã‚ã‚Šæ¡ä»¶</p>
                                <div class="flex flex-wrap gap-2">
                                    ${candidate.desired_job_experience_ok ? '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">è·ç¨®æœªçµŒé¨“OK</span>' : ''}
                                    ${candidate.desired_industry_experience_ok ? '<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">æ¥­ç•ŒæœªçµŒé¨“OK</span>' : ''}
                                    ${!candidate.desired_job_experience_ok && !candidate.desired_industry_experience_ok ? '<span class="text-gray-400 text-sm">-</span>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. ã‚¹ã‚­ãƒ« -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-code mr-2 text-blue-500"></i>ã‚¹ã‚­ãƒ«
                        </h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-gray-800 whitespace-pre-wrap text-sm leading-relaxed">${candidate.skills || '-'}</p>
                        </div>
                    </div>

                    <!-- 3. è·æ­´æ¦‚è¦ -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-briefcase mr-2 text-green-500"></i>è·æ­´æ¦‚è¦
                        </h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-gray-800 whitespace-pre-wrap text-sm leading-relaxed">${candidate.work_history || '-'}</p>
                        </div>
                    </div>

                    <!-- 3.5 è©³ç´°è·æ­´ (æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿) -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-list-ul mr-2 text-indigo-500"></i>çµŒæ­´è©³ç´°
                        </h4>
                        <div class="space-y-4">
                            ${candidate.work_history_structured && Array.isArray(candidate.work_history_structured) && candidate.work_history_structured.length > 0
                        ? candidate.work_history_structured.map((wh, idx) => `
                                    <div class="border-l-4 border-indigo-200 pl-4 py-1">
                                        <div class="flex justify-between items-start mb-1">
                                            <h5 class="font-bold text-gray-900">${wh.company_name || 'åç§°æœªè¨­å®š'}</h5>
                                            <span class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-0.5 rounded">${wh.period || '-'}</span>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-1 mb-2">
                                            ${wh.industry ? `
                                                <div class="flex items-start text-xs text-gray-600">
                                                    <span class="font-semibold mr-1 w-16 flex-shrink-0 text-gray-400">æ¥­ç¨®:</span>
                                                    <span>${wh.industry}</span>
                                                </div>
                                            ` : ''}
                                            ${wh.job_category ? `
                                                <div class="flex items-start text-xs text-gray-600">
                                                    <span class="font-semibold mr-1 w-16 flex-shrink-0 text-gray-400">è·ç¨®:</span>
                                                    <span>${wh.job_category}</span>
                                                </div>
                                            ` : ''}
                                            ${wh.role ? `
                                                <div class="flex items-start text-xs text-gray-600">
                                                    <span class="font-semibold mr-1 w-16 flex-shrink-0 text-gray-400">å½¹è·:</span>
                                                    <span>${wh.role}</span>
                                                </div>
                                            ` : ''}
                                        </div>
                                        ${wh.description ? `
                                            <div class="text-sm text-gray-700 whitespace-pre-wrap leading-relaxed bg-white p-2 border border-gray-100 rounded">${wh.description}</div>
                                        ` : ''}
                                    </div>
                                `).join('')
                        : '<p class="text-gray-400 text-sm text-center py-4 italic">æ§‹é€ åŒ–ã•ã‚ŒãŸè·æ­´ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“</p>'
                    }
                        </div>
                    </div>

                    <!-- 4. å±¥æ­´æƒ…å ± -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-history mr-2 text-indigo-500"></i>å±¥æ­´æƒ…å ±
                        </h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-gray-800 whitespace-pre-wrap text-sm leading-relaxed">${candidate.history_info || '-'}</p>
                        </div>
                    </div>

                    <!-- 5. ç¤¾å†…ãƒãƒƒãƒãƒ³ã‚°æƒ…å ± -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-file-alt mr-2 text-gray-500"></i>ç¤¾å†…ãƒãƒƒãƒãƒ³ã‚°æƒ…å ±
                        </h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-gray-800 whitespace-pre-wrap text-sm leading-relaxed">${candidate.resume || '-'}</p>
                        </div>
                    </div>

                    <!-- 6. ç¤¾å†…ãƒ¡ãƒ¢ãƒ»å…±æœ‰äº‹é … -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-user-circle mr-2 text-pink-500"></i>ç¤¾å†…ãƒ¡ãƒ¢ãƒ»å…±æœ‰äº‹é …
                        </h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-gray-800 whitespace-pre-wrap text-sm leading-relaxed">${candidate.notes || candidate.self_pr || '-'}</p>
                        </div>
                    </div>

                    <!-- ãã®ä»–åŸºæœ¬æƒ…å ± (å¿…è¦æœ€ä½é™) -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <h4 class="font-bold text-lg mb-4 text-gray-900 flex items-center">
                            <i class="fas fa-info-circle mr-2 text-gray-500"></i>åŸºæœ¬æƒ…å ±
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600 mb-1">å¹´é½¢</p>
                                <p class="font-medium text-gray-900">${candidate.age ? candidate.age + 'æ­³' : '-'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-1">å­¦æ­´</p>
                                <p class="font-medium text-gray-900">${candidate.education || '-'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-1">é›»è©±ç•ªå·</p>
                                <p class="font-medium text-gray-900">${candidate.phone || '-'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-1">ç™»éŒ²æ—¥</p>
                                <p class="font-medium text-gray-900">${new Date(candidate.created_at).toLocaleDateString('ja-JP')}</p>
                            </div>
                        </div>
                    </div>
                `;

                console.log('Final step: Rendering to candidate preview and forcing visibility.');
                $('#candidate-preview-content').html(content);

                const modal = $('#candidate-preview-modal');
                if (modal.length === 0) {
                    console.error('CRITICAL: #candidate-preview-modal not found!');
                    return;
                }
                // Move to body to avoid parent clipping/z-index issues
                $('body').append(modal);

                console.log('Updating candidate preview visibility...');
                modal.removeClass('hidden').attr('style', 'display: flex !important; z-index: 40000 !important; visibility: visible !important; opacity: 1 !important;');

                // é›†ç´„ç”»é¢ç”¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
                loadInterviewHistory(candidateId);
                loadSelectionProgress(candidateId);

                console.log('viewCandidateProfile process complete');

            } catch (error) {
                console.error('Load candidate error:', error);
                alert('å€™è£œè€…æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            } finally {
                hideLoading();
            }
        }

        // å€™è£œè€…ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
        window.closeCandidatePreview = function () {
            console.log('--- closeCandidatePreview Triggered ---');
            $('#candidate-preview-modal').addClass('hidden').attr('style', 'display: none !important;');
        }

        // --- å€™è£œè€…è©³ç´°ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ ---
        window.switchCandidateDetailTab = function (tab) {
            $('.candidate-tab-content').addClass('hidden');
            $('.candidate-tab-btn').removeClass('active border-indigo-500 text-indigo-600').addClass('border-transparent text-gray-500');

            $(`#tab-content-${tab}`).removeClass('hidden');
            $(`#btn-tab-${tab}`).addClass('active border-indigo-500 text-indigo-600').removeClass('border-transparent text-gray-500');

            const candidateId = $('#interview-candidate-id').val();
            if (candidateId) {
                if (tab === 'interviews') loadInterviewHistory(candidateId);
                if (tab === 'progress') loadSelectionProgress(candidateId);
            }
        }

        // --- é¢è«‡å±¥æ­´æ©Ÿèƒ½ ---
        window.openInterviewRecordModal = function () {
            const candidateId = $('#interview-candidate-id').val() || $('#admin-user-id').val();
            console.log('Opening interview record modal for candidate:', candidateId);
            if (!candidateId) {
                alert('å€™è£œè€…ãŒç‰¹å®šã§ãã¾ã›ã‚“');
                return;
            }

            const modal = $('#interview-record-modal');
            $('body').append(modal); // Ensure it's at body level

            $('#interview-id').val('');
            $('#interview-candidate-id').val(candidateId);
            $('#interview-date').val(new Date().toISOString().split('T')[0]);
            $('#interview-content').val('');
            $('#interview-next-action').val('');

            modal.removeClass('hidden').attr('style', 'display: flex !important; z-index: 50000 !important;');
        }

        window.closeInterviewRecordModal = function () {
            console.log('Closing interview record modal');
            const modal = $('#interview-record-modal');
            modal.addClass('hidden').attr('style', 'display: none !important;');

            // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
            $('#interview-id').val('');
            $('#interview-content').val('');
            $('#interview-next-action').val('');
        }

        window.editInterviewRecord = async function (interviewId) {
            showLoading();
            try {
                const { data, error } = await supabase
                    .from('candidate_interviews')
                    .select('*')
                    .eq('id', interviewId)
                    .single();

                if (error) throw error;

                const modal = $('#interview-record-modal');
                $('body').append(modal);

                $('#interview-id').val(data.id);
                $('#interview-candidate-id').val(data.candidate_id);
                $('#interview-date').val(data.interview_date);
                $('#interview-type').val(data.interview_type);
                $('#interview-content').val(data.content);
                $('#interview-next-action').val(data.next_action);

                modal.removeClass('hidden').attr('style', 'display: flex !important; z-index: 50000 !important;');
            } catch (err) {
                console.error('Edit interview error:', err);
                alert('é¢è«‡è©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            } finally {
                hideLoading();
            }
        }

        // é¢è«‡å±¥æ­´ä¿å­˜ (å§”è­²ã‚’ä½¿ç”¨ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç¢ºå®Ÿã«ã™ã‚‹)
        $(document).off('submit', '#interview-record-form').on('submit', '#interview-record-form', async function (e) {
            e.preventDefault();
            console.log('Submitting interview record form');

            const candidateId = $('#interview-candidate-id').val();
            const interviewId = $('#interview-id').val();
            const date = $('#interview-date').val();
            const type = $('#interview-type').val();
            const content = $('#interview-content').val();
            const nextAction = $('#interview-next-action').val();

            if (!currentUser) {
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            if (!candidateId) {
                alert('å€™è£œè€…æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“');
                return;
            }

            showLoading('ä¿å­˜ä¸­...');
            try {
                const interviewData = {
                    organization_id: currentUser.organization_id,
                    candidate_id: candidateId,
                    interviewer_id: currentUser.id,
                    interview_date: date,
                    interview_type: type,
                    content: content,
                    next_action: nextAction
                };

                let result;
                if (interviewId) {
                    result = await supabase
                        .from('candidate_interviews')
                        .update(interviewData)
                        .eq('id', interviewId);
                } else {
                    result = await supabase
                        .from('candidate_interviews')
                        .insert(interviewData);
                }

                if (result.error) throw result.error;

                alert('é¢è«‡å±¥æ­´ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                closeInterviewRecordModal();
                loadInterviewHistory(candidateId);
            } catch (err) {
                console.error('Save interview history error:', err);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
            } finally {
                hideLoading();
            }
        });

        // é¢è«‡å±¥æ­´ãƒ­ãƒ¼ãƒ‰
        async function loadInterviewHistory(candidateId) {
            const container = $('#interview-list-container');
            container.html('<div class="text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>èª­ã¿è¾¼ã¿ä¸­...</div>');

            try {
                const { data, error } = await supabase
                    .from('candidate_interviews')
                    .select('*, users!interviewer_id(name)')
                    .eq('candidate_id', candidateId)
                    .order('interview_date', { ascending: false });

                if (error) throw error;

                if (!data || data.length === 0) {
                    container.html('<div class="text-center py-8 text-gray-500"><i class="fas fa-comments text-3xl mb-2 block"></i><p>é¢è«‡å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p></div>');
                    return;
                }

                const html = data.map(item => `
                    <div class="bg-white border border-gray-200 rounded-lg p-5 shadow-sm hover:shadow-md transition-shadow group">
                        <div class="flex justify-between items-start mb-3">
                            <span class="px-3 py-1 bg-indigo-50 text-indigo-700 text-xs font-bold rounded-full">${item.interview_type}</span>
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-500 font-medium">${new Date(item.interview_date).toLocaleDateString('ja-JP')}</span>
                                <button onclick="editInterviewRecord('${item.id}')" class="text-gray-400 hover:text-indigo-600 transition-colors opacity-0 group-hover:opacity-100">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                        <div class="text-sm text-gray-800 whitespace-pre-wrap leading-relaxed mb-4">${item.content}</div>
                        ${item.next_action ? `
                        <div class="bg-amber-50 border-l-4 border-amber-400 p-3 text-sm">
                            <p class="font-bold text-amber-800 mb-1"><i class="fas fa-bolt mr-2"></i>ãƒã‚¯ã‚¹ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³</p>
                            <p class="text-amber-700">${item.next_action}</p>
                        </div>
                        ` : ''}
                        <div class="mt-4 pt-3 border-t flex justify-end">
                            <span class="text-xs text-gray-400">æ‹…å½“: ${item.users?.name || 'ä¸æ˜'}</span>
                        </div>
                    </div>
                `).join('');

                container.html(html);
            } catch (err) {
                console.error('Load interview history error:', err);
                container.html('<div class="text-center py-8 text-red-500">å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>');
            }
        }

        // --- é¸è€ƒé€²æ—æ©Ÿèƒ½ ---
        async function loadSelectionProgress(candidateId) {
            const container = $('#selection-progress-container');
            container.html('<div class="text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>èª­ã¿è¾¼ã¿ä¸­...</div>');

            try {
                const { data, error } = await supabase
                    .from('applications')
                    .select('*, jobs(*, companies(name))')
                    .eq('user_id', candidateId)
                    .order('updated_at', { ascending: false });

                if (error) throw error;

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚¹ã‚¿ã‚’å–å¾—
                const { data: statusMasters } = await supabase
                    .from('master_data')
                    .select('label, value')
                    .eq('type', 'application_status')
                    .order('sort_order');

                const statuses = statusMasters && statusMasters.length > 0
                    ? statusMasters.map(m => m.label)
                    : ['æ›¸é¡é¸è€ƒä¸­', 'æ›¸é¡é¸è€ƒé€šé', 'ä¸€æ¬¡é¢æ¥äºˆå®š', 'ä¸€æ¬¡é¢æ¥å®Œäº†', 'äºŒæ¬¡é¢æ¥äºˆå®š', 'äºŒæ¬¡é¢æ¥å®Œäº†', 'æœ€çµ‚é¢æ¥äºˆå®š', 'æœ€çµ‚é¢æ¥å®Œäº†', 'å†…å®š', 'å†…å®šæ‰¿è«¾', 'å…¥ç¤¾ç¢ºèªæ¸ˆ', 'é¸è€ƒçµ‚äº†ï¼ˆæ›¸é¡ï¼‰', 'é¸è€ƒçµ‚äº†ï¼ˆé¢æ¥ï¼‰', 'é¸è€ƒçµ‚äº†ï¼ˆå†…å®šè¾é€€ï¼‰', 'é¸è€ƒçµ‚äº†ï¼ˆå……è¶³ã‚¯ãƒ­ãƒ¼ã‚ºï¼‰', 'é¸è€ƒçµ‚äº†ï¼ˆãã®ä»–ï¼‰'];

                if (!data || data.length === 0) {
                    container.html('<div class="text-center py-8 text-gray-500"><i class="fas fa-tasks text-3xl mb-2 block"></i><p>é€²è¡Œä¸­ã®é¸è€ƒã¯ã‚ã‚Šã¾ã›ã‚“</p></div>');
                    return;
                }

                const html = data.map(app => {
                    const job = app.jobs;
                    const companyName = job?.companies?.name || job?.company || 'ä¸æ˜';

                    return `
                    <div class="bg-white border rounded-lg p-5 shadow-sm">
                        <div class="flex justify-between items-start gap-4 mb-4">
                            <div>
                                <h5 class="font-bold text-lg text-gray-900">${job?.title || 'ä¸æ˜ãªæ±‚äºº'}</h5>
                                <p class="text-sm text-gray-600">${companyName}</p>
                            </div>
                            <div class="bg-indigo-50 text-indigo-700 px-4 py-2 rounded-lg font-bold">
                                ${app.status}
                            </div>
                        </div>
                        
                        <div class="pt-4 border-t space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wider">é¸è€ƒã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å¤‰æ›´</label>
                                <div class="flex gap-2">
                                    <select onchange="updateCandidateSelectionStatus('${app.id}', this.value, '${candidateId}')" 
                                        class="flex-1 px-4 py-2 border rounded-lg text-sm bg-indigo-50 border-indigo-200 focus:ring-2 focus:ring-indigo-500">
                                        <option value="">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¤‰æ›´...</option>
                                        ${statuses.map(s => `<option value="${s}" ${app.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                }).join('');

                container.html(html);
            } catch (err) {
                console.error('Load selection progress error:', err);
                container.html('<div class="text-center py-8 text-red-500">é€²æ—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>');
            }
        }

        // é¸è€ƒã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        window.updateCandidateSelectionStatus = async function (applicationId, newStatus, candidateId) {
            if (!newStatus) return;

            showLoading('æ›´æ–°ä¸­...');
            try {
                // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—ï¼ˆå±¥æ­´ç”¨ï¼‰
                const { data: currentApp } = await supabase
                    .from('applications')
                    .select('status')
                    .eq('id', applicationId)
                    .single();

                const oldStatus = currentApp?.status;

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
                const { error } = await supabase
                    .from('applications')
                    .update({ status: newStatus, updated_at: new Date().toISOString() })
                    .eq('id', applicationId);

                if (error) throw error;

                // å±¥æ­´ã«è¿½åŠ  (progress_historyãƒ†ãƒ¼ãƒ–ãƒ«ãŒã‚ã‚Œã°)
                try {
                    await supabase.from('progress_history').insert({
                        organization_id: currentUser.organization_id,
                        application_id: applicationId,
                        user_id: candidateId,
                        old_status: oldStatus,
                        new_status: newStatus,
                        changed_by: currentUser.id,
                        changed_by_name: currentUser.name
                    });
                } catch (histErr) {
                    console.warn('Failed to record progress history:', histErr);
                }

                alert('é¸è€ƒã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                loadSelectionProgress(candidateId);
            } catch (err) {
                console.error('Update selection status error:', err);
                alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
            } finally {
                hideLoading();
            }
        }

        // ============================================
        // å¤–éƒ¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è§£ææ©Ÿèƒ½
        // ============================================

        let uploadedFiles = [];
        let currentAnalysisHistoryId = null; // Store history ID for feedback

        window.openProfileAnalysisModal = function () {
            $('#profile-scout_management-tab-content').addClass('hidden');
            $('.profile-analysis-tab').removeClass('border-indigo-600 text-indigo-600').addClass('border-transparent text-gray-500');
            $('#profile-tab-new').removeClass('border-transparent text-gray-500').addClass('border-indigo-600 text-indigo-600');

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            setTimeout(() => {
                setupFileUploadHandlers();
            }, 100);
        }

        window.closeProfileAnalysisModal = function () {
            $('#profile-analysis-modal').addClass('hidden');
        }

        // ============================================
        // Scout Settings Modal Logic
        // ============================================

        window.openScoutSettingsModal = async function () {
            console.log('openScoutSettingsModal called');
            if (!currentUser) return;

            const modal = $('#scout-settings-modal');
            // Ensure modal is strict child of body for z-index to work
            if (modal.parent().get(0) !== document.body) {
                $('body').append(modal);
            }

            modal.removeClass('hidden').css('z-index', 10001);

            // Load current settings
            try {
                const { data, error } = await supabase
                    .from('user_scout_settings')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                if (data) {
                    $('#scout-style-active').prop('checked', data.is_active);
                    $('#scout-style-prompt').val(data.style_prompt || '');
                } else {
                    // No settings yet, reset to default
                    $('#scout-style-active').prop('checked', false);
                    $('#scout-style-prompt').val('');
                }
            } catch (e) {
                console.error('Error loading scout settings:', e);
            }
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        window.switchProfileAnalysisTab = function (tab) {
            // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
            $('.profile-analysis-tab').removeClass('border-indigo-600 text-indigo-600').addClass('border-transparent text-gray-500');
            $(`#profile-tab-${tab}`).removeClass('border-transparent text-gray-500').addClass('border-indigo-600 text-indigo-600');

            // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            $('#profile-new-tab-content').addClass('hidden');
            $('#profile-history-tab-content').addClass('hidden');
            $('#profile-scout_management-tab-content').addClass('hidden');
            $('#profile-analytics-tab-content').addClass('hidden');

            if (tab === 'new') {
                $('#profile-new-tab-content').removeClass('hidden');
                setTimeout(() => {
                    setupFileUploadHandlers();
                }, 0);
            } else if (tab === 'history') {
                $('#profile-history-tab-content').removeClass('hidden');
                loadProfileAnalysisHistory();
            } else if (tab === 'scout_management') {
                $('#profile-scout_management-tab-content').removeClass('hidden');
                loadScoutManagement();
            } else if (tab === 'analytics') {
                $('#profile-analytics-tab-content').removeClass('hidden');
                loadScoutAnalytics();
            }
        }

        // å±¥æ­´èª­ã¿è¾¼ã¿
        window.loadProfileAnalysisHistory = async function () {
            if (!currentUser) return;

            $('#history-list').html(`
            <div class="text-center py-12 text-gray-500">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                    <p>å±¥æ­´ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
                </div>
            `);

            try {
                // 1. çµ„ç¹”è¨­å®šã®å–å¾—
                const { data: orgData, error: orgError } = await window.supabase
                    .from('organizations')
                    .select('settings')
                    .eq('id', currentUser.organization_id)
                    .single();

                if (orgError) console.error('Org settings fetch error:', orgError); // Non-blocking

                const visibility = orgData?.settings?.analysis_history_visibility || 'all'; // Default to 'all'

                // 2. çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®å–å¾— (å€‹äºº & å…¨ä½“)
                // Note: RLSãŒOpenãªçŠ¶æ…‹å‰æã€‚StrictãªRLSã®å ´åˆã¯åˆ¥é€”RPCãŒå¿…è¦ã«ãªã‚‹ãŒã€ç¾åœ¨ã¯OpenModeã¨æƒ³å®šã€‚
                const { count: myCount, error: myCountError } = await window.supabase
                    .from('profile_analysis_history')
                    .select('*', { count: 'exact', head: true })
                    .eq('organization_id', currentUser.organization_id)
                    .eq('analyzed_by', currentUser.id);

                const { count: orgCount, error: orgCountError } = await window.supabase
                    .from('profile_analysis_history')
                    .select('*', { count: 'exact', head: true })
                    .eq('organization_id', currentUser.organization_id);

                // 3. ãƒªã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®å–å¾—
                let query = window.supabase
                    .from('profile_analysis_history')
                    .select('*')
                    .eq('organization_id', currentUser.organization_id)
                    .order('created_at', { ascending: false })
                    .limit(50);

                // Visibilityåˆ¶å¾¡: 'personal'ãªã‚‰è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã«çµã‚‹
                if (visibility === 'personal') {
                    query = query.eq('analyzed_by', currentUser.id);
                }

                const { data, error } = await query;

                if (error) throw error;

                // --- UI Rendering ---

                // çµ±è¨ˆè¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
                const statsHtml = `
            <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-indigo-50 rounded-lg p-4 text-center border border-indigo-100">
                            <p class="text-xs text-gray-500 font-bold mb-1">è‡ªåˆ†ã®è§£ææ•°</p>
                            <p class="text-2xl font-bold text-indigo-700">${myCount || 0}<span class="text-sm font-normal text-gray-500 ml-1">ä»¶</span></p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 text-center border border-gray-200">
                            <p class="text-xs text-gray-500 font-bold mb-1">çµ„ç¹”å…¨ä½“ã®è§£ææ•°</p>
                            <p class="text-2xl font-bold text-gray-700">${orgCount || 0}<span class="text-sm font-normal text-gray-500 ml-1">ä»¶</span></p>
                        </div>
                    </div>
            `;

                if (!data || data.length === 0) {
                    $('#history-list').html(statsHtml + `
            <div class="text-center py-12 text-gray-500 border-t border-gray-100 mt-4">
                            <i class="fas fa-inbox text-4xl mb-3"></i>
                            <p>è¡¨ç¤ºã§ãã‚‹è§£æå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
            `);
                    return;
                }

                // ãƒªã‚¹ãƒˆè¡¨ç¤º
                $('#history-list').html(statsHtml + '<div class="space-y-4">' + renderHistoryListHtml(data) + '</div>');

            } catch (error) {
                console.error('Load history error:', error);
                $('#history-list').html(`
            <div class="text-center py-12 text-red-500">
                        <i class="fas fa-exclamation-triangle text-4xl mb-3"></i>
                        <p>å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
                    </div>
            `);
            }
        }

        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: HTMLç”Ÿæˆéƒ¨åˆ†ã‚’åˆ†é›¢
        function renderHistoryListHtml(historyData) {
            return historyData.map(item => {
                const date = new Date(item.created_at).toLocaleString('ja-JP');
                let matches = item.matches;
                if (typeof matches === 'string') {
                    try { matches = JSON.parse(matches); } catch (e) { }
                }

                let matchCount = 0;
                if (matches && !Array.isArray(matches) && typeof matches === 'object') {
                    matchCount = (matches.skill?.length || 0) + (matches.industry?.length || 0) + (matches.mindset?.length || 0);
                } else if (Array.isArray(matches)) {
                    matchCount = matches.length;
                } else if (item.analysis_results) {
                    let ar = item.analysis_results;
                    if (typeof ar === 'string') { try { ar = JSON.parse(ar); } catch (e) { } }
                    matchCount = (ar.matches_skill?.length || 0) + (ar.matches_industry?.length || 0) + (ar.matches_mindset?.length || 0) + (ar.matches?.length || 0);
                }

                return `
            <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition cursor-pointer" onclick="viewHistoryDetail('${item.id}')">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1">
                        <p class="font-bold text-gray-900">${(item.title || item.candidate_summary || 'å€™è£œè€…æƒ…å ±').substring(0, 60)}...</p>
                        <p class="text-xs text-gray-500 mt-1">
                            <i class="far fa-clock mr-1"></i>${date}
                        </p>
                    </div>
                    <span class="px-2 py-1 bg-indigo-50 text-indigo-600 text-xs font-semibold rounded">
                        ${matchCount}ä»¶ã®æ±‚äººææ¡ˆ
                    </span>
                </div>
                </div>
            `;
            }).join('');
        }




        window.viewHistoryDetail = async function (historyId) {
            try {
                const { data, error } = await window.supabase
                    .from('profile_analysis_history')
                    .select('*')
                    .eq('id', historyId)
                    .single();

                if (error) throw error;

                // æ–°è¦è§£æã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆã¦çµæœã‚’è¡¨ç¤º
                switchProfileAnalysisTab('new');

                // ãƒ‡ãƒ¼ã‚¿ã®æ­£è¦åŒ–
                let matches = data.matches;
                if (typeof matches === 'string') {
                    try { matches = JSON.parse(matches); } catch (e) { }
                }

                let renderData = {
                    candidate_summary: data.candidate_summary,
                    title: data.title, // è¿½åŠ 
                    history_id: data.id,
                    success: true
                };

                // matchesãƒ‡ãƒ¼ã‚¿ã®å½¢çŠ¶ã«åˆã‚ã›ã¦å¤‰æ›
                if (matches && !Array.isArray(matches) && typeof matches === 'object') {
                    // æ–°å½¢å¼ { skill: [], ... } -> { matches_skill: [], ... }
                    renderData.matches_skill = matches.skill;
                    renderData.matches_industry = matches.industry;
                    renderData.matches_mindset = matches.mindset;
                } else if (Array.isArray(matches)) {
                    // æ—§å½¢å¼
                    renderData.matches = matches;
                } else if (data.analysis_results) {
                    // äºˆå‚™ã§ analysis_results ã‚‚è¦‹ã‚‹
                    let ar = data.analysis_results;
                    if (typeof ar === 'string') { try { ar = JSON.parse(ar); } catch (e) { } }
                    Object.assign(renderData, ar);
                }

                renderAnalysisResults(renderData);

            } catch (error) {
                console.error('View history detail error:', error);
                alert('å±¥æ­´ã®è©³ç´°è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function setupFileUploadHandlers() {
            // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
            $('#file-drop-area').off('click dragover dragleave drop');
            $('#profile-file-input').off('change');

            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            $('#file-drop-area').on('click', function (e) {
                // inputè¦ç´ è‡ªä½“ã®ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡è¦–
                if ($(e.target).is('#profile-file-input')) {
                    return;
                }
                e.preventDefault();
                e.stopPropagation();
                $('#profile-file-input')[0].click(); // DOMè¦ç´ ã¨ã—ã¦ç›´æ¥ã‚¯ãƒªãƒƒã‚¯
            });

            $('#profile-file-input').on('change', function (e) {
                e.stopPropagation(); // ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ã‚’åœæ­¢
                if (e.target.files && e.target.files.length > 0) {
                    handleFileUpload(Array.from(e.target.files));
                }
            });

            // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            $('#file-drop-area').on('dragover', function (e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).addClass('bg-indigo-50');
            });

            $('#file-drop-area').on('dragleave', function (e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).removeClass('bg-indigo-50');
            });

            $('#file-drop-area').on('drop', function (e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).removeClass('bg-indigo-50');
                if (e.originalEvent.dataTransfer.files.length > 0) {
                    handleFileUpload(Array.from(e.originalEvent.dataTransfer.files));
                }
            });

            // Paste event handling
            $(document).on('paste', function (e) {
                const items = (e.originalEvent.clipboardData || e.clipboardData).items;
                const files = [];
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        const file = items[i].getAsFile();
                        if (file) {
                            // Create a dummy name if not present (often 'image.png' from clipboard)
                            if (!file.name || file.name === 'image.png') {
                                const ext = items[i].type.split('/')[1];
                                const timestamp = new Date().getTime();
                                // Create a new File object with a custom name
                                const newFile = new File([file], `pasted_image_${timestamp}.${ext}`, { type: file.type });
                                files.push(newFile);
                            } else {
                                files.push(file);
                            }
                        }
                    }
                }
                if (files.length > 0) {
                    handleFileUpload(files);
                    // Optional: Provide visual feedback that a paste occurred
                    $('#file-drop-area').addClass('bg-indigo-50');
                    setTimeout(() => $('#file-drop-area').removeClass('bg-indigo-50'), 200);
                }
            });
        }

        function handleFileUpload(files) {
            uploadedFiles = files;
            const fileListHtml = files.map((file, index) => `
            <div class="flex items-center justify-between bg-gray-100 px-2 py-1 rounded">
                    <span class="text-gray-700 truncate flex-1">
                        <i class="fas ${file.type.includes('pdf') ? 'fa-file-pdf text-red-500' : 'fa-image text-blue-500'} mr-1"></i>
                        ${file.name}
                    </span>
                    <span class="text-gray-500 text-xs ml-2">${(file.size / 1024).toFixed(1)}KB</span>
                </div>
            `).join('');
            $('#file-list').html(fileListHtml);
        }

        window.resetProfileAnalysis = function () {
            uploadedFiles = [];
            $('#profile-file-input').val('');
            $('#file-list').empty();
            $('#profile-text-input').val('');
            $('#scout-instruction-text').val(''); // è¿½åŠ : æŒ‡ç¤ºãƒ†ã‚­ã‚¹ãƒˆã‚‚ã‚¯ãƒªã‚¢
            $('#scout-instruction-container').addClass('hidden'); // è¿½åŠ : æŒ‡ç¤ºã‚¨ãƒªã‚¢ã‚’éš ã™
            $('#analysis-placeholder').removeClass('hidden');
            $('#analysis-loading').addClass('hidden');
            $('#analysis-results').addClass('hidden');
            $('#suggested-jobs-container').empty();
        }

        window.analyzeProfile = async function (instruction = null, targetJobId = null) {
            if (!currentUser) return;

            // åˆå›è§£æï¼ˆæŒ‡ç¤ºãŒãªã„å ´åˆï¼‰ã¯æ–°è¦æ‰±ã„ã¨ã—ã¦IDã¨ã‚¿ã‚¤ãƒˆãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
            if (!instruction) {
                window.currentExternalCandidateId = null;
                // $('#candidate-title-input').val(''); // å‰Šé™¤: å…¥åŠ›ã•ã‚ŒãŸã‚¿ã‚¤ãƒˆãƒ«ã‚’ç¶­æŒã™ã‚‹
            }

            const textInput = $('#profile-text-input').val().trim();

            if (uploadedFiles.length === 0 && !textInput) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // UIæ›´æ–°
            $('#analyze-profile-btn').prop('disabled', true);
            $('#regenerate-scout-btn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>å†ç”Ÿæˆä¸­...'); // å†ç”Ÿæˆãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°

            // åˆå›è§£ææ™‚ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’éš ã—ã¦ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡¨ç¤º
            if (!instruction) {
                $('#analysis-placeholder').addClass('hidden');
                // $('#analysis-loading').removeClass('hidden'); // å…¨ç”»é¢ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
                showLoading('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è§£æä¸­...');
                $('#analysis-results').addClass('hidden');
            } else {
                // å†ç”Ÿæˆæ™‚ã¯çµæœã‚¨ãƒªã‚¢ã‚’åŠé€æ˜ã«ã™ã‚‹ãªã©ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒã‚ã‚‹ã¨è‰¯ã„ãŒã€ä»Šå›ã¯ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆã‚‹
                $('#analysis-results').addClass('opacity-50');
                showLoading('æŒ‡ç¤ºã«åŸºã¥ã„ã¦å†ç”Ÿæˆä¸­...');
            }

            try {
                // æœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Base64ã«å¤‰æ›ï¼ˆç”»åƒã¾ãŸã¯PDFï¼‰
                let base64Image = null;
                let mimeType = null;
                if (uploadedFiles.length > 0) {
                    const file = uploadedFiles[0];
                    if (file.type.startsWith('image/')) {
                        base64Image = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result);
                            reader.readAsDataURL(file);
                        });
                        mimeType = file.type;
                    } else if (file.type === 'application/pdf') {
                        // PDFã‚’ç”»åƒ(JPEG)ã«å¤‰æ›
                        try {

                            const arrayBuffer = await file.arrayBuffer();
                            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                            const page = await pdf.getPage(1); // 1ãƒšãƒ¼ã‚¸ç›®ã®ã¿
                            const viewport = page.getViewport({ scale: 2.0 });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;

                            await page.render({ canvasContext: context, viewport: viewport }).promise;
                            base64Image = canvas.toDataURL('image/jpeg');
                            mimeType = 'image/jpeg';
                        } catch (e) {
                            console.error('PDF conversion error:', e);
                            alert('PDFã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚');
                            throw e;
                        }
                    }
                }

                // Edge Functionå‘¼ã³å‡ºã—
                // Base64ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é™¤å»ã—ã¦é€ä¿¡
                const cleanBase64 = base64Image ? base64Image.replace(/^data:(.*);base64,/, '') : null;

                const { data, error } = await window.supabase.functions.invoke('analyze-external-profile', {
                    body: {
                        image: cleanBase64,
                        mime_type: mimeType || 'image/jpeg', // MIMEã‚¿ã‚¤ãƒ—ã‚‚æ˜ç¤ºçš„ã«é€ä¿¡
                        text_input: textInput || null,
                        title: $('#candidate-title-input').val().trim() || null, // è¿½åŠ : ã‚¿ã‚¤ãƒˆãƒ«ã‚’é€ä¿¡
                        organization_id: currentUser.organization_id,
                        user_id: currentUser.id,
                        instruction: instruction, // è¿½åŠ : ä¿®æ­£æŒ‡ç¤º
                        target_job_id: targetJobId
                    }
                });

                if (error) throw error;
                console.log('Analysis response data:', data); // Debug log

                if (data && data.success) {
                    renderAnalysisResults(data);

                    // Save result here (only on analysis, not on view)
                    // Removed to prevent auto-save: User must explicitly save via Scout or Register button
                    // if (window.saveExternalCandidateProfile) {
                    //     saveExternalCandidateProfile(data);
                    // }
                } else {
                    throw new Error(data.error || 'è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

            } catch (error) {
                console.error('Analysis error:', error);
                alert('è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                if (!instruction) {
                    $('#analysis-loading').addClass('hidden');
                    $('#analysis-placeholder').removeClass('hidden');
                }
            } finally {
                $('#analyze-profile-btn').prop('disabled', false);
                $('#regenerate-scout-btn').prop('disabled', false).html('<i class="fas fa-sync-alt mr-2"></i>æŒ‡ç¤ºã‚’åæ˜ ã—ã¦å†ç”Ÿæˆ');
                $('#analysis-results').removeClass('opacity-50');
                hideLoading();
            }
        }

        // å†ç”Ÿæˆãƒœã‚¿ãƒ³ã®ãƒãƒ³ãƒ‰ãƒ©
        window.regenerateScoutsWithInstruction = function () {
            const instruction = $('#scout-instruction-text').val().trim();
            if (!instruction) {
                alert('ä¿®æ­£æŒ‡ç¤ºã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            analyzeProfile(instruction);
        }

        let currentAnalysisMatches = [];
        let currentAnalysisOffset = 0;
        let analysisResultsData = null; // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
        const ANALYSIS_BATCH_SIZE = 3;

        window.renderAnalysisResults = function (data) {
            $('#analysis-loading').addClass('hidden');
            $('#analysis-results').removeClass('hidden');
            $('#scout-instruction-container').removeClass('hidden');

            // ã‚¿ã‚¤ãƒˆãƒ«ã‚’åæ˜ ï¼ˆæ—¢å­˜ã®å…¥åŠ›ãŒã‚ã‚‹å ´åˆã¯ä¸Šæ›¸ãã›ãšã€ç©ºã®å ´åˆã‚„å±¥æ­´è¡¨ç¤ºã®å ´åˆã®ã¿åæ˜ ã•ã›ãŸã„ãŒã€
            // å±¥æ­´è¡¨ç¤ºæ™‚ã¯data.titleã«å€¤ãŒå…¥ã£ã¦ã„ã‚‹ã¯ãšã€‚è§£æç›´å¾Œã‚‚data.titleã«åæ˜ ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã¨ä¸€è²«æ€§ãŒå‡ºã‚‹ã€‚
            if (data.title !== undefined) {
                $('#candidate-title-input').val(data.title || '');
            }

            window.currentAnalysisHistoryId = data.history_id || null;

            // Auto Save to External Candidates (New Feature)
            // Auto Save Removed from here to prevent duplicate on view
            // if (window.saveExternalCandidateProfile) {
            //     saveExternalCandidateProfile(data);
            // }
            currentAnalysisHistoryId = window.currentAnalysisHistoryId;

            if (!window.currentAnalysisHistoryId && data.save_error) {
                console.error('History ID is missing. Save error:', data.save_error);
                const errorDetail = typeof data.save_error === 'object' ? JSON.stringify(data.save_error, null, 2) : String(data.save_error);
                alert('ã€ã‚¨ãƒ©ãƒ¼ã€‘å±¥æ­´ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nè©³ç´°: ' + errorDetail);
            } else if (!window.currentAnalysisHistoryId) {
                console.warn('History ID is missing but no save error reported.');
            } else {
                console.log('Set GLOBAL history ID:', window.currentAnalysisHistoryId);
            }

            // Persist in DOM to be absolutely sure
            if ($('#current-analysis-history-id').length === 0) {
                $('#analysis-results').append('<input type="hidden" id="current-analysis-history-id">');
            }
            $('#current-analysis-history-id').val(window.currentAnalysisHistoryId || '');

            // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
            $('#candidate-summary-text').text(data.candidate_summary || 'è§£æçµæœãªã—');

            const container = $('#suggested-jobs-container');
            container.empty();

            // ä»»æ„ã®æ±‚äººé¸æŠãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
            container.append(`
            <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4 mb-6 flex items-center justify-between">
                    <div>
                        <h5 class="font-bold text-indigo-900">
                            <i class="fas fa-search-plus mr-2"></i>ãã®ä»–ã®æ±‚äººã§ã‚¹ã‚«ã‚¦ãƒˆã‚’ä½œæˆ
                        </h5>
                        <p class="text-sm text-indigo-700">ãŠã™ã™ã‚æ±‚äººä»¥å¤–ã®æ±‚äººã‚’æŒ‡å®šã—ã¦ã‚¹ã‚«ã‚¦ãƒˆæ–‡é¢ã‚’ä½œæˆã§ãã¾ã™ã€‚</p>
                    </div>
                    <button onclick="openJobSelectorForScout()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded shadow transition">
                        æ±‚äººã‚’é¸æŠ
                    </button>
                </div>
            `);

            // Debug log removed: console.log('Analysis results:', data);

            analysisResultsData = data; // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
            window.analysisResultsData = data; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ç”¨ã«å…¬é–‹

            // Debug log removed: console.log('Data keys:', Object.keys(data));
            // Debug log removed: console.log('Matches lengths:', {
            //     skill: data.matches_skill ? data.matches_skill.length : 'undefined',
            //     industry: data.matches_industry ? data.matches_industry.length : 'undefined',
            //     mindset: data.matches_mindset ? data.matches_mindset.length : 'undefined',
            //     legacy: data.matches ? data.matches.length : 'undefined'
            // });

            // æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ï¼ˆmatches_skillç­‰ï¼‰ãŒã‚ã‚‹å ´åˆã¯ã€ãã‚Œã‚’å„ªå…ˆã—ã¦çµ±åˆãƒ»ä½¿ç”¨ã™ã‚‹
            const hasStructuredMatches = (Array.isArray(data.matches_skill) && data.matches_skill.length > 0) ||
                (Array.isArray(data.matches_industry) && data.matches_industry.length > 0) ||
                (Array.isArray(data.matches_mindset) && data.matches_mindset.length > 0);

            // Debug log removed: console.log('Has structured matches:', hasStructuredMatches);

            if (hasStructuredMatches) {
                // æ–°å½¢å¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å¯¾å¿œ: matches_skill, matches_industry, matches_mindset ã‚’çµ±åˆ
                data.matches = [
                    ...(data.matches_skill || []).map(m => ({ ...m, category: 'skill' })),
                    ...(data.matches_industry || []).map(m => ({ ...m, category: 'industry' })),
                    ...(data.matches_mindset || []).map(m => ({ ...m, category: 'mindset' }))
                ];
                // Update global data reference
                analysisResultsData = data;
                // Debug log removed: console.log('Merged matches from structured data:', data.matches);
            }

            // ã‚«ãƒ†ã‚´ãƒªæƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ (ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°å¼·åˆ¶çš„ã«ã‚«ãƒ†ã‚´ãƒªã‚ã‚Šã¨ã¿ãªã™)
            const hasCategories = hasStructuredMatches || (data.matches && data.matches.length > 0 && data.matches.some(m => m.category));

            if (hasCategories) {
                // ã‚¿ãƒ–UIã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                const tabsHtml = `
            <div class="flex border-b border-gray-200 mb-4">
                        <button onclick="switchAnalysisTab('skill')" id="tab-skill" class="ai-result-tab flex-1 py-3 px-2 text-center text-sm font-bold border-b-2 transition-colors duration-200 text-indigo-600 border-indigo-600">
                            <i class="fas fa-tools mr-1"></i>ã‚¹ã‚­ãƒ«ãƒ»çµŒé¨“
                            <span class="group relative inline-block ml-1 text-left font-normal" onclick="event.stopPropagation()">
                                <i class="fas fa-question-circle text-gray-400 hover:text-indigo-500 cursor-help transition-colors"></i>
                                <div class="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none z-50 leading-relaxed font-normal">
                                    <div class="absolute top-[-6px] left-1/2 transform -translate-x-1/2 w-3 h-3 bg-gray-800 rotate-45"></div>
                                    å…·ä½“çš„ãªã‚¹ã‚­ãƒ«ã‚»ãƒƒãƒˆã‚„å®Ÿå‹™çµŒé¨“ãªã©ã€ã€Œå³æˆ¦åŠ›ã€ã¨ã—ã¦ã®é©åˆåº¦ãŒé«˜ã„æ±‚äººã§ã™ã€‚
                                </div>
                            </span>
                        </button>
                        <button onclick="switchAnalysisTab('industry')" id="tab-industry" class="ai-result-tab flex-1 py-3 px-2 text-center text-sm font-bold border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            <i class="fas fa-building mr-1"></i>æ¥­ç•Œãƒ»ãƒ‰ãƒ¡ã‚¤ãƒ³
                            <span class="group relative inline-block ml-1 text-left font-normal" onclick="event.stopPropagation()">
                                <i class="fas fa-question-circle text-gray-400 hover:text-indigo-500 cursor-help transition-colors"></i>
                                <div class="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none z-50 leading-relaxed font-normal">
                                    <div class="absolute top-[-6px] left-1/2 transform -translate-x-1/2 w-3 h-3 bg-gray-800 rotate-45"></div>
                                    æ¥­ç•ŒçŸ¥è­˜ã‚„å•†æµã®ç†è§£ãªã©ã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã®çµŒé¨“ãŒæ´»ã‹ã›ã‚‹æ±‚äººã§ã™ã€‚
                                </div>
                            </span>
                        </button>
                        <button onclick="switchAnalysisTab('mindset')" id="tab-mindset" class="ai-result-tab flex-1 py-3 px-2 text-center text-sm font-bold border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            <i class="fas fa-heart mr-1"></i>å¿—å‘æ€§
                            <span class="group relative inline-block ml-1 text-left font-normal" onclick="event.stopPropagation()">
                                <i class="fas fa-question-circle text-gray-400 hover:text-indigo-500 cursor-help transition-colors"></i>
                                <div class="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none z-50 leading-relaxed font-normal">
                                    <div class="absolute top-[-6px] left-1/2 transform -translate-x-1/2 w-3 h-3 bg-gray-800 rotate-45"></div>
                                    å€™è£œè€…ã®ã‚­ãƒ£ãƒªã‚¢å¿—å‘ã‚„äººæŸ„ã€ä¼æ¥­æ–‡åŒ–ï¼ˆã‚«ãƒ«ãƒãƒ£ãƒ¼ï¼‰ã¨ã®ç›¸æ€§ãŒè‰¯ã„æ±‚äººã§ã™ã€‚
                                </div>
                            </span>
                        </button>
                    </div>
            <div id="analysis-tab-content"></div>
        `;
                container.append(tabsHtml);

                // ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹æœ€åˆã®ã‚¿ãƒ–ã‚’é–‹ã
                if (data.matches_skill && data.matches_skill.length > 0) {
                    switchAnalysisTab('skill');
                } else if (data.matches_industry && data.matches_industry.length > 0) {
                    switchAnalysisTab('industry');
                } else if (data.matches_mindset && data.matches_mindset.length > 0) {
                    switchAnalysisTab('mindset');
                } else {
                    switchAnalysisTab('skill'); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                }

            } else {
                // å¾“æ¥è¡¨ç¤º (ãƒ•ãƒ©ãƒƒãƒˆãƒªã‚¹ãƒˆ)
                if (!data.matches || data.matches.length === 0) {
                    container.html('<p class="text-gray-500 text-center">ãƒãƒƒãƒã™ã‚‹æ±‚äººãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>');
                    $('#load-more-analysis-container').addClass('hidden');
                    return;
                }
                currentAnalysisMatches = data.matches;
                currentAnalysisOffset = 0;
                loadMoreAnalysisMatches();
            }

            // Load Moreãƒœã‚¿ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒŠ (å…±é€š)
            if ($('#load-more-analysis-container').length === 0) {
                container.after(`
            <div id="load-more-analysis-container" class="text-center mt-4 hidden">
                <button id="load-more-analysis-btn" onclick="loadMoreAnalysisMatches()"
                    class="px-6 py-2 bg-white border border-gray-300 rounded-full text-sm font-medium text-gray-700 hover:bg-gray-50 shadow-sm transition">
                    ã‚‚ã£ã¨è¦‹ã‚‹
                </button>
                    </div>
            `);
            }
        }

        window.switchAnalysisTab = function (tab) {
            // ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
            ['skill', 'industry', 'mindset'].forEach(t => {
                const btn = $(`#tab - ${t} `);
                if (t === tab) {
                    btn.removeClass('border-transparent text-gray-500 hover:text-gray-700')
                        .addClass('text-indigo-600 border-indigo-600');
                } else {
                    btn.removeClass('text-indigo-600 border-indigo-600')
                        .addClass('border-transparent text-gray-500 hover:text-gray-700');
                }
            });

            // ãƒ‡ãƒ¼ã‚¿åˆ‡ã‚Šæ›¿ãˆ (categoryãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°)
            if (analysisResultsData && analysisResultsData.matches) {
                currentAnalysisMatches = analysisResultsData.matches.filter(m => m.category === tab);
            } else {
                currentAnalysisMatches = [];
            }

            currentAnalysisOffset = 0;
            $('#analysis-tab-content').empty();
            $('#load-more-analysis-container').addClass('hidden');

            // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®è¡¨ç¤º
            if (currentAnalysisMatches.length === 0) {
                $('#analysis-tab-content').html('<p class="text-gray-400 text-center py-4">ã“ã®è¦³ç‚¹ã§ã®ãƒãƒƒãƒãƒ³ã‚°æ±‚äººã¯ã‚ã‚Šã¾ã›ã‚“</p>');
                return;
            }

            loadMoreAnalysisMatches();
        }

        window.loadMoreAnalysisMatches = function () {
            // ã‚¿ãƒ–å†…ã‹ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚’åˆ¤å®š
            let container = $('#analysis-tab-content');
            if (container.length === 0) {
                container = $('#suggested-jobs-container');
            }
            const nextMatches = currentAnalysisMatches.slice(currentAnalysisOffset, currentAnalysisOffset + ANALYSIS_BATCH_SIZE);

            // Store ID for feedback use (Moved from pagination loop)

            nextMatches.forEach(match => {
                const html = `
            <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm hover:shadow-md transition mb-4">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <h5 class="text-lg font-bold text-gray-900">${match.job_title}</h5>
                                ${match.match_score ? `<span class="px-2 py-0.5 bg-indigo-100 text-indigo-800 text-xs font-bold rounded-full">ãƒãƒƒãƒåº¦ ${match.match_score}%</span>` : ''}
                                <a href="#" onclick="showJobDetailModal('${match.job_id}'); return false;" 
                                    class="text-xs text-indigo-600 hover:text-indigo-800 underline ml-2">
                                    è©³ç´°ã‚’è¦‹ã‚‹
                                </a>
                            </div>
                            <p class="text-sm text-gray-600 mb-1">
                                <i class="fas fa-building text-gray-400 mr-1"></i>${match.company_name}
                            </p>
                            ${match.job_description ? `
                            <p class="text-xs text-gray-500 line-clamp-2 mt-2">${match.job_description.substring(0, 100)}...</p>
                            ` : ''}
                        </div>
                        <!-- Copy Button with Tooltip -->
                        <div class="relative group ml-4 inline-block">
                            <button onclick="copyToClipboard(this)" class="text-gray-400 hover:text-indigo-600 focus:outline-none">
                                <i class="far fa-copy text-xl"></i>
                            </button>
                            <div class="absolute bottom-full right-0 mb-2 w-40 p-2 bg-gray-800 text-white text-xs rounded shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none z-50 text-center font-normal">
                                <div class="absolute bottom-[-6px] right-3 w-3 h-3 bg-gray-800 rotate-45"></div>
                                æ–‡é¢ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
                            </div>
                        </div>

                        <!-- Save Button with Tooltip -->
                        <div class="relative group ml-2 inline-block">
                            <button onclick="saveScoutMessage(this, '${match.job_id}')" class="text-gray-400 hover:text-green-600 focus:outline-none">
                                <i class="fas fa-save text-xl"></i>
                            </button>
                            <div class="absolute bottom-full right-0 mb-2 w-64 p-3 bg-gray-800 text-white text-xs rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none z-50 leading-relaxed font-normal text-left">
                                <div class="absolute bottom-[-6px] right-3 w-3 h-3 bg-gray-800 rotate-45"></div>
                                <strong>ã‚¹ã‚«ã‚¦ãƒˆã‚’ä¿å­˜</strong><br>
                                ã“ã®å€™è£œè€…ã¨æ–‡é¢ã‚’ã€Œã‚¹ã‚«ã‚¦ãƒˆç®¡ç†ã€ã«ç™»éŒ²ã—ã¾ã™ã€‚ä¿å­˜ã™ã‚‹ã“ã¨ã§ã€é€ä¿¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ç®¡ç†ã‚„å€™è£œè€…ã®è¿½è·¡ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 p-3 rounded mb-4">
                        <p class="text-xs font-bold text-yellow-800 mb-1">
                            <i class="fas fa-lightbulb mr-1"></i>ãƒãƒƒãƒãƒ³ã‚°ç†ç”±
                        </p>
                        <p class="text-sm text-gray-700">${match.match_reason}</p>
                    </div>

                    <div class="border-t pt-4">
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-xs text-gray-500 font-bold">ç”Ÿæˆã•ã‚ŒãŸã‚¹ã‚«ã‚¦ãƒˆæ–‡é¢ (ç·¨é›†å¯)</p>
                            <span class="text-[10px] bg-indigo-100 text-indigo-600 px-1.5 py-0.5 rounded italic">ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç›´æ¥ç·¨é›†ã§ãã¾ã™</span>
                        </div>
                        <div class="bg-gray-50 p-4 rounded border border-gray-200 focus-within:border-indigo-300 focus-within:ring-1 focus-within:ring-indigo-100 transition-all">
                            <div class="flex items-center mb-2 border-b border-gray-200 pb-2">
                                <span class="text-sm font-bold text-gray-400 mr-2 flex-shrink-0">ä»¶å:</span>
                                <input type="text" class="scout-subject-input w-full font-bold text-gray-900 border-none bg-transparent focus:ring-0 text-sm p-0" value="${match.scout_subject}">
                            </div>
                            <textarea class="scout-body-textarea w-full text-gray-700 text-sm bg-transparent border-none focus:ring-0 p-0 resize-none overflow-hidden leading-relaxed" 
                                      oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'">${(match.scout_body || '').replace(/\\n/g, '\n')}</textarea>
                        </div>
                        
                        <!-- Feedback UI -->
                        <div class="flex justify-end items-center mt-2 space-x-2 feedback-container" data-job-id="${match.job_id}" data-history-id="${window.currentAnalysisHistoryId || ''}">
                            <span class="text-xs text-gray-400">ã“ã®æ–‡é¢ã®è©•ä¾¡:</span>
                            <button onclick="submitFeedback(this, 'good')" class="text-gray-400 hover:text-yellow-500 transition tooltip" data-tip="Good">
                                <i class="far fa-laugh text-lg"></i>
                            </button>
                            <button onclick="submitFeedback(this, 'soso')" class="text-gray-400 hover:text-yellow-500 transition tooltip" data-tip="So-so">
                                <i class="far fa-meh text-lg"></i>
                            </button>
                            <button onclick="submitFeedback(this, 'bad')" class="text-gray-400 hover:text-yellow-500 transition tooltip" data-tip="Bad">
                                <i class="far fa-frown text-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
                container.append(html);
            });

            currentAnalysisOffset += nextMatches.length;

            // Textareaã®åˆæœŸé«˜ã•ã‚’èª¿æ•´
            setTimeout(() => {
                $('.scout-body-textarea').trigger('input');
            }, 100);

            if (currentAnalysisOffset < currentAnalysisMatches.length) {
                $('#load-more-analysis-container').removeClass('hidden');
            } else {
                $('#load-more-analysis-container').addClass('hidden');
            }
        }

        /* =========================================
           Scout Style Personalization Logic
           ========================================= */



        window.analyzeScoutExamples = async function () {
            const examples = [];
            $('.scout-example-input').each(function () {
                const val = $(this).val().trim();
                if (val) examples.push(val);
            });

            if (examples.length === 0) {
                alert('ä¾‹æ–‡ã‚’å°‘ãªãã¨ã‚‚1ã¤å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const btn = $('#analyze-examples-btn');
            const originalText = btn.text();
            btn.text('åˆ†æä¸­...').prop('disabled', true);

            try {
                const { data, error } = await supabase.functions.invoke('analyze-scout-style', {
                    body: { examples }
                });

                if (error) throw error;
                if (!data.success) throw new Error(data.error);

                $('#scout-style-prompt').val(data.style_prompt);
                alert('æ–‡ä½“ã®åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸã€‚ã€Œè¨­å®šã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦é©ç”¨ã—ã¦ãã ã•ã„ã€‚');

            } catch (e) {
                console.error(e);
                alert('åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
            } finally {
                btn.text(originalText).prop('disabled', false);
            }
        }

        window.closeScoutSettingsModal = function () {
            $('#scout-settings-modal').addClass('hidden');
        }

        window.saveScoutSettings = async function () {
            const isActive = $('#scout-style-active').is(':checked');
            const prompt = $('#scout-style-prompt').val();

            try {
                const { error } = await supabase
                    .from('user_scout_settings')
                    .upsert({
                        user_id: currentUser.id,
                        style_prompt: prompt,
                        is_active: isActive,
                        updated_at: new Date().toISOString()
                    });

                if (error) throw error;
                alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                closeScoutSettingsModal();
            } catch (e) {
                console.error(e);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        window.submitFeedback = async function (btn, rating) {
            const container = $(btn).closest('.feedback-container');
            // Try to get history ID from DOM (hidden input is most reliable), then data-attr, then global
            const historyId = $('#current-analysis-history-id').val() || container.data('history-id') || window.currentAnalysisHistoryId;

            if (!historyId) {
                console.warn('No history ID found for feedback');
                return;
            }

            const jobId = container.data('job-id');
            // Find scout content nearby
            const scoutContent = $(btn).closest('.border-t').find('.scout-body-textarea').val() || $(btn).closest('.border-t').find('.scout-body-text').text();

            // Visual feedback
            container.find('button').addClass('text-gray-200').removeClass('text-yellow-500');
            $(btn).removeClass('text-gray-200').addClass('text-yellow-500');

            try {
                const { error } = await supabase
                    .from('scout_feedbacks')
                    .insert({
                        user_id: currentUser.id,
                        history_id: historyId,
                        job_id: jobId,
                        rating: rating,
                        scout_content: scoutContent
                    });

                if (error) throw error;
                console.log('Feedback submitted:', rating);
                // alert('è©•ä¾¡ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼'); // Optional: show distinct feedback
            } catch (e) {
                console.error('Feedback error:', e);
            }
        }

        /* =========================================
           Candidate Search & Matching Logic
           ========================================= */

        let isCandidateSearchInitialized = false;
        window.selectedTargetJobId = null;
        let allCandidateSearchJobs = [];

        async function loadCandidateSearch() {
            if (!currentUser) return;
            showLoading();
            try {
                await loadMasterDataForCandidateSearch();
                await loadAllJobsforSearch();

                // åˆå›æ¤œç´¢ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãªã—ï¼‰
                await searchCandidates();

            } catch (e) {
                console.error(e);
            } finally {
                hideLoading();
            }
        }

        async function loadMasterDataForCandidateSearch() {
            if (isCandidateSearchInitialized) return;

            // éƒ½é“åºœçœŒ
            const prefSelect = $('#c-search-prefecture');
            if (prefSelect.hasClass("select2-hidden-accessible")) {
                prefSelect.select2('destroy');
            }
            prefSelect.empty();
            window.prefectures.forEach(pref => {
                prefSelect.append(`<option value="${pref}">${pref}</option>`);
            });
            prefSelect.select2({ placeholder: "å‹¤å‹™åœ°ï¼ˆéƒ½é“åºœçœŒï¼‰", allowClear: true, width: '100%' });

            // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—
            const { data: masters } = await supabase
                .from('master_data')
                .select('*')
                .eq('is_active', true)
                .order('sort_order');

            const validMasters = masters.filter(m => m.organization_id === null || m.organization_id === currentUser.organization_id);

            // ----------------------------------------------------------------
            // 1. æ±‚è·è€…æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ç”¨ Select2
            // ----------------------------------------------------------------

            // é›‡ç”¨å½¢æ…‹
            const empSelect = $('#c-search-employment-type');
            if (empSelect.hasClass("select2-hidden-accessible")) {
                empSelect.select2('destroy');
            }
            empSelect.empty();
            const uniqueEmps = [...new Set(validMasters.filter(m => m.type === 'employment_type').map(m => m.label))];
            uniqueEmps.forEach(label => {
                empSelect.append(`<option value="${label}">${label}</option>`);
            });
            empSelect.select2({ placeholder: "é›‡ç”¨å½¢æ…‹", allowClear: true, width: '100%' });

            // è·ç¨®
            const catSelect = $('#c-search-job-category');
            if (catSelect.hasClass("select2-hidden-accessible")) {
                catSelect.select2('destroy');
            }
            catSelect.empty();
            const uniqueCats = [...new Set(validMasters.filter(m => m.type === 'job_category').map(m => m.label))];
            uniqueCats.forEach(label => {
                catSelect.append(`<option value="${label}">${label}</option>`);
            });
            catSelect.select2({ placeholder: "è·ç¨®ã‚«ãƒ†ã‚´ãƒª", allowClear: true, width: '100%' });

            // æ¥­ç•Œ
            const indSelect = $('#c-search-industry-category');
            if (indSelect.hasClass("select2-hidden-accessible")) {
                indSelect.select2('destroy');
            }
            indSelect.empty();
            const uniqueInds = [...new Set(validMasters.filter(m => m.type === 'industry_category').map(m => m.label))];
            uniqueInds.forEach(label => {
                indSelect.append(`<option value="${label}">${label}</option>`);
            });
            indSelect.select2({ placeholder: "æ¥­ç•Œã‚«ãƒ†ã‚´ãƒª", allowClear: true, width: '100%' });

            // ----------------------------------------------------------------
            // 2. å¯¾è±¡æ±‚äººæ¤œç´¢ç”¨ Select2 (è¿½åŠ )
            // ----------------------------------------------------------------

            // è·ç¨® (t-job-category)
            const tjCatSelect = $('#t-job-category');
            if (tjCatSelect.hasClass("select2-hidden-accessible")) {
                tjCatSelect.select2('destroy');
            }
            tjCatSelect.empty();
            const uniqueTjCats = [...new Set(validMasters.filter(m => m.type === 'job_category').map(m => m.label))];
            uniqueTjCats.forEach(label => {
                tjCatSelect.append(`<option value="${label}">${label}</option>`);
            });
            tjCatSelect.select2({ placeholder: "è·ç¨®ã§çµã‚Šè¾¼ã¿", allowClear: true, width: '100%' });

            // æ¥­ç•Œ (t-industry)
            const tjIndSelect = $('#t-industry');
            if (tjIndSelect.hasClass("select2-hidden-accessible")) {
                tjIndSelect.select2('destroy');
            }
            tjIndSelect.empty();
            const uniqueTjInds = [...new Set(validMasters.filter(m => m.type === 'industry_category').map(m => m.label))];
            uniqueTjInds.forEach(label => {
                tjIndSelect.append(`<option value="${label}">${label}</option>`);
            });
            tjIndSelect.select2({ placeholder: "æ¥­ç•Œã§çµã‚Šè¾¼ã¿", allowClear: true, width: '100%' });

            // å‹¤å‹™åœ° (t-location) - éƒ½é“åºœçœŒ
            const tjLocSelect = $('#t-location');
            if (tjLocSelect.hasClass("select2-hidden-accessible")) {
                tjLocSelect.select2('destroy');
            }
            tjLocSelect.empty();
            window.prefectures.forEach(pref => {
                tjLocSelect.append(`<option value="${pref}">${pref}</option>`);
            });
            tjLocSelect.select2({ placeholder: "å‹¤å‹™åœ°ã§çµã‚Šè¾¼ã¿", allowClear: true, width: '100%' });

            // Event Listeners for Target Job Search
            const onTargetJobFilterChange = () => {
                const term = $('#target-job-search').val().toLowerCase();
                // Call filter even if term is empty (to filter by dropdowns)
                // But wait, existing logic hid dropdown if term was empty.
                // Now we want to show it if dropdowns are selected?
                // Or just filter in background?
                // Current UI expects "Search Input" to trigger.
                // Let's modify filterAndShowTargetJobs to handle empty term if filters are present.
                filterAndShowTargetJobs(term);
            };

            $('#target-job-search').on('input', onTargetJobFilterChange);
            $('#t-job-category, #t-industry, #t-location').on('change', onTargetJobFilterChange);

            $('#clear-job-selection').on('click', function () {
                clearTargetJobSelection();
            });

            // Float Action Bar Setup
            const floatBar = $(`
            <div id="candidate-float-bar" class="fixed bottom-10 left-1/2 md:left-[calc(50%+125px)] transform -translate-x-1/2 z-50 bg-white border border-indigo-100 rounded-full shadow-2xl px-4 sm:px-8 py-3 sm:py-4 hidden flex items-center justify-between gap-3 sm:gap-8 transition-all duration-300 w-[92vw] sm:w-auto max-w-[700px]">
                    <div class="flex items-center">
                        <div class="bg-indigo-100 text-indigo-600 rounded-full w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center mr-2 sm:mr-3 shrink-0">
                            <i class="fas fa-users text-xs sm:text-base"></i>
                        </div>
                        <div class="leading-tight">
                            <span class="font-bold text-gray-800 block text-[10px] sm:text-sm">é¸æŠä¸­ã®å€™è£œè€…</span>
                            <span class="text-indigo-600 font-bold"><span id="c-selected-count" class="text-base sm:text-xl">0</span> <span class="text-[10px] sm:text-sm text-gray-500">å</span></span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 sm:gap-3">
                        <button onclick="clearAllSelectedCandidates()" class="bg-gray-100 text-gray-600 px-3 sm:px-4 py-2 sm:py-3 rounded-full hover:bg-gray-200 font-bold shadow hover:shadow-md transition flex items-center text-xs sm:text-sm">
                            <i class="fas fa-times sm:mr-2"></i><span class="hidden sm:inline">å…¨è§£é™¤</span>
                        </button>
                        <button id="btn-save-recommendations" onclick="saveCandidatesToRecommendations()" class="bg-indigo-600 text-white px-4 sm:px-8 py-2 sm:py-3 rounded-full hover:bg-indigo-700 font-bold shadow-lg hover:shadow-xl transition flex items-center transform hover:-translate-y-0.5 text-xs sm:text-sm">
                            <i class="fas fa-star mr-1 sm:mr-2"></i>ãŠã™ã™ã‚<span class="hidden sm:inline">æ±‚äººã«ä¿å­˜</span>
                        </button>
                    </div>
                </div>
            `);
            // bodyã«appendã—ã¦z-indexã‚’åŠ¹ã‹ã›ã‚‹ (ã¾ãŸã¯contentå†…ã§ã‚‚ã‚ˆã„ãŒfixedãªã®ã§bodyæ¨å¥¨)
            // ãŸã ã—Sidebarã¨ã®å…¼ã­åˆã„ã§ left ã‚’èª¿æ•´ã—ãŸã„ãŒã€Tailwindã® md:pl-64 (16rem=256px) ã‚’ä½¿ã†
            // style="left: 0; width: 100%;" ã¨ class="md:pl-64" ã‚’ä½µç”¨

            $('body').append(floatBar);

            // Handler
            $(document).on('change', '.candidate-select-checkbox', function () {
                const count = $('.candidate-select-checkbox:checked').length;
                $('#c-selected-count').text(count);

                const bar = $('#candidate-float-bar');

                // AIçµæœè¡¨ç¤ºä¸­ã®ã¿ãƒãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹ (æ±‚è·è€…æ¤œç´¢ãƒªã‚¹ãƒˆã§ã®AIãƒãƒƒãƒãƒ³ã‚°ãƒãƒ¼ã¯ä¸è¦ã¨ã®è¦æœ›)
                if (count > 0 && isAImatchingResultView) {
                    bar.removeClass('hidden').removeClass('translate-y-full').addClass('translate-y-0');
                    $('#candidate-results-container').css('padding-bottom', '100px');
                } else {
                    bar.addClass('translate-y-full');
                    setTimeout(() => {
                        if ($('.candidate-select-checkbox:checked').length === 0 || !isAImatchingResultView) bar.addClass('hidden');
                    }, 300);
                    $('#candidate-results-container').css('padding-bottom', '0');
                }
            });

            isCandidateSearchInitialized = true;
        }

        window.clearAllSelectedCandidates = function () {
            $('.candidate-select-checkbox').prop('checked', false);
            const bar = $('#candidate-float-bar');
            bar.addClass('translate-y-full');
            setTimeout(() => {
                bar.addClass('hidden');
            }, 300);
            $('#c-selected-count').text('0');
            $('#candidate-results-container').css('padding-bottom', '0');
        };

        async function loadAllJobsforSearch() {
            let query = supabase.from('jobs')
                .select('id, title, companies(name), requirements, salary_min, salary_max, job_category, industry_category, location, employment_type')
                .eq('status', 'active');

            if (currentUser && currentUser.organization_id) {
                query = query.eq('organization_id', currentUser.organization_id);
            }

            const { data } = await query;
            allCandidateSearchJobs = data || [];
        }

        window.filterAndShowTargetJobs = function (term) {
            const cats = $('#t-job-category').val() || [];
            const inds = $('#t-industry').val() || [];
            const locs = $('#t-location').val() || [];

            // If no input and no filters, hide
            if (!term && cats.length === 0 && inds.length === 0 && locs.length === 0) {
                $('#target-job-dropdown').addClass('hidden');
                return;
            }

            const filtered = allCandidateSearchJobs.filter(job => {
                const title = (job.title || '').toLowerCase();
                const comp = (job.companies?.name || '').toLowerCase();
                let match = true;

                // Text Match
                if (term) {
                    if (!title.includes(term) && !comp.includes(term)) match = false;
                }

                // Category Match
                if (match && cats.length > 0) {
                    // job.job_category is string or array
                    const jCats = Array.isArray(job.job_category) ? job.job_category : (job.job_category || '').split(',');
                    // Check intersection
                    const hasCat = cats.some(c => jCats.some(jc => jc.includes(c) || c.includes(jc)));
                    if (!hasCat) match = false;
                }

                // Industry Match
                if (match && inds.length > 0) {
                    const jInds = Array.isArray(job.industry_category) ? job.industry_category : (job.industry_category || '').split(',');
                    const hasInd = inds.some(i => jInds.some(ji => ji.includes(i) || i.includes(ji)));
                    if (!hasInd) match = false;
                }

                // Location Match
                if (match && locs.length > 0) {
                    const jLocs = Array.isArray(job.location) ? job.location : (job.location || '').split(',');
                    const hasLoc = locs.some(l => jLocs.some(jl => jl.includes(l) || l.includes(jl)));
                    if (!hasLoc) match = false;
                }

                return match;
            });

            const dropdown = $('#target-job-dropdown');
            if (filtered.length === 0) {
                dropdown.html('<div class="p-3 text-gray-500 text-sm">è©²å½“ã™ã‚‹æ±‚äººãŒã‚ã‚Šã¾ã›ã‚“</div>').removeClass('hidden');
                return;
            }

            const html = filtered.slice(0, 10).map(job => `
            <div class="p-2 hover:bg-indigo-50 cursor-pointer flex justify-between items-center border-b"
        onclick="window.selectTargetJob('${job.id}')">
            <div>
                <div class="font-medium text-gray-800">${job.title}</div>
                <div class="text-xs text-gray-500">${job.companies?.name || ''}</div>
            </div>
                </div>
            `).join('');

            dropdown.html(html).removeClass('hidden');
        }

        window.selectTargetJob = function (jobId) {
            console.log('selectTargetJob called', jobId);
            const job = allCandidateSearchJobs.find(j => j.id === jobId);
            if (!job) {
                console.error('Job not found in cache', jobId);
                return;
            }

            selectedTargetJobId = jobId;

            // è©³ç´°ãƒœã‚¿ãƒ³è¿½åŠ 
            $('#selected-job-title').html(`
                ${job.title}
        <button onclick="event.stopPropagation(); showJobDetailModal('${job.id}')" class="ml-2 text-indigo-600 hover:text-indigo-800 text-xs bg-indigo-50 px-2 py-1 rounded border border-indigo-200 transition-colors">
            <i class="fas fa-info-circle mr-1"></i>è©³ç´°
        </button>
        `);
            $('#selected-job-company').text(job.companies?.name || '-');

            $('#selected-job-display').removeClass('hidden');
            $('#target-job-input-wrapper').addClass('hidden');
            $('#target-job-dropdown').addClass('hidden');
            $('#job-ai-match-btn').prop('disabled', false);

            // æ¤œç´¢æ¡ä»¶ã‚’ã‚»ãƒƒãƒˆ
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            $('#c-search-keyword').val('');
            $('#c-search-location').val('');
            $('#c-search-prefecture').val(null).trigger('change');
            $('#c-search-job-category').val(null).trigger('change');
            $('#c-search-industry-category').val(null).trigger('change');
            $('#c-search-employment-type').val(null).trigger('change');
            $('#c-search-salary-min').val('');

            // ãƒ˜ãƒ«ãƒ‘ãƒ¼: é…åˆ—ã‹ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šæ–‡å­—åˆ—ã‚’é…åˆ—ã«æ­£è¦åŒ–
            const normalizeToArray = (val) => {
                if (!val) return [];
                if (Array.isArray(val)) return val;
                return val.split(',').map(s => s.trim());
            };

            // è·ç¨®
            if (job.job_category) {
                const vals = normalizeToArray(job.job_category);
                $('#c-search-job-category').val(vals).trigger('change');
            }

            // æ¥­ç•Œ
            if (job.industry_category) {
                const vals = normalizeToArray(job.industry_category);
                $('#c-search-industry-category').val(vals).trigger('change');
            }

            // é›‡ç”¨å½¢æ…‹
            if (job.employment_type) {
                const vals = normalizeToArray(job.employment_type);
                $('#c-search-employment-type').val(vals).trigger('change');
            }

            // å‹¤å‹™åœ° (éƒ½é“åºœçœŒæŠ½å‡º)
            if (job.location) {
                const locs = normalizeToArray(job.location);
                // è©³ç´°ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã«ã¯çµåˆã—ã¦ã‚»ãƒƒãƒˆ
                $('#c-search-location').val(locs.join(', '));

                // éƒ½é“åºœçœŒã‚’ã‚»ãƒƒãƒˆ
                const foundPrefs = [];
                locs.forEach(loc => {
                    const pref = window.prefectures.find(p => loc.startsWith(p));
                    if (pref) foundPrefs.push(pref);
                });

                if (foundPrefs.length > 0) {
                    $('#c-search-prefecture').val(foundPrefs).trigger('change');
                }
            }

            // çµ¦ä¸ (æœ€ä½å¹´å) - æ±‚äººã®æœ€ä½å¹´åä»¥ä¸Šã®å¸Œæœ›ã‚’æŒã¤äººã‚’æ¤œç´¢ï¼Ÿ 
            // ã„ã‚„ã€æ±‚è·è€…æ¤œç´¢ãªã®ã§ã€Œæ±‚äººã®æ¡ä»¶ã€ã«åˆã†äººã‚’æ¢ã™ã€‚
            // æ±‚è·è€…ã®å¸Œæœ›å¹´å <= æ±‚äººã®ä¸Šé™ï¼Ÿ
            // ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã‚»ãƒƒãƒˆã—ãªã„ã€ã¾ãŸã¯æ±‚äººã®Minã‚’å…¥ã‚Œã‚‹ã€‚
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›ã¯ã€Œæ¡ä»¶ã‚»ãƒƒãƒˆã€ã€‚æ±‚äººã®å±æ€§ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ã®ãŒè‡ªç„¶ã€‚
            // æ±‚äººãŒã€Œå¹´å500ä¸‡ã€œã€ãªã‚‰ã€å¸Œæœ›å¹´å500ä¸‡ãã‚‰ã„ã®äººã‚’æ¢ã™ã®ãŒç­‹ï¼Ÿ
            // ã„ã£ãŸã‚“ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¤æ–­ã«ä»»ã›ã‚‹ï¼‰ã‹ã€Minã‚’å…¥ã‚Œã‚‹ã€‚
            // if (job.salary_min) $('#c-search-salary-min').val(job.salary_min / 10000);

            // æ¤œç´¢è‡ªå‹•å®Ÿè¡Œ
            searchCandidates();
        }

        window.clearTargetJobSelection = function () {
            selectedTargetJobId = null;
            $('#selected-job-display').addClass('hidden');
            $('#target-job-input-wrapper').removeClass('hidden');
            $('#target-job-search').val('');
            $('#job-ai-match-btn').prop('disabled', true);
        }

        window.searchCandidatesImmediate = function () {
            searchCandidates();
        }

        window.clearCandidateSearch = function () {
            $('#c-search-keyword').val('');
            $('#c-tags-keyword').empty();
            $('input[name="c-search-keyword-mode"][value="OR"]').prop('checked', true);
            $('#c-search-location').val('');
            $('#c-tags-location').empty();

            // Slider reset
            $('#c-search-salary-slider').val(0);
            $('#c-search-salary-min').val(0);
            $('#c-salary-display').text('æŒ‡å®šãªã—');

            $('#c-search-prefecture').val(null).trigger('change');
            $('#c-search-job-category').val(null).trigger('change');
            $('#c-search-industry-category').val(null).trigger('change');
            $('#c-search-employment-type').val(null).trigger('change');
            $('#c-search-sort').val('created_at-desc');
            $('#c-search-management-status').val('active');
            $('#c-search-ai-prompt').val('');
            searchCandidates();
        }

        // ========================
        // Candidate Pagination Variables
        // ========================
        const CANDIDATES_PER_PAGE = 20;
        let currentCandidatePage = 1;
        let totalCandidatePages = 1;
        let currentCandidateFilters = {};
        let allCandidatesCache = []; // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã®å…¨å€™è£œè€…

        window.searchCandidates = async function searchCandidates(filters = {}, page = 1) {
            showLoading();
            $('#candidate-results-container').empty();

            // Build Query
            // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚¿ã‚°
            const kTags = [];
            $('#c-tags-keyword .premium-tag').each(function () {
                kTags.push($(this).text().trim().toLowerCase());
            });
            let keyword = $('#c-search-keyword').val().toLowerCase().trim();
            if (kTags.length > 0) {
                keyword = (keyword + ' ' + kTags.join(' ')).trim();
            }

            // ãƒ•ãƒªãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚¿ã‚°ï¼ˆå‹¤å‹™åœ°ï¼‰
            const fTags = [];
            $('#c-tags-location .premium-tag').each(function () {
                fTags.push($(this).text().trim());
            });
            let location = $('#c-search-location').val().trim();
            if (fTags.length > 0) {
                location = (location + ' ' + fTags.join(' ')).trim();
            }

            const pref = $('#c-search-prefecture').val(); // array
            const jobCat = $('#c-search-job-category').val(); // array
            const indCat = $('#c-search-industry-category').val(); // array
            const empType = $('#c-search-employment-type').val(); // array
            const minSal = $('#c-search-salary-min').val();
            const sort = $('#c-search-sort').val();
            const managementStatus = $('#c-search-management-status').val();
            const aiPrompt = $('#c-search-ai-prompt').val();

            try {
                let query = supabase.from('users')
                    .select('*, candidate_profiles(*)')
                    .eq('role', 'candidate')
                    .eq('organization_id', currentUser.organization_id);

                // ... (Auth Logic) ...
                const isAdmin = ['org_admin', 'admin', 'super_admin'].includes(currentUser.role);
                const isStaff = ['coach', 'ca', 'ra'].includes(currentUser.role);
                const limitView = currentUser.organizations && currentUser.organizations.settings && (currentUser.organizations.settings.limit_agent_view === true || currentUser.organizations.settings.limit_agent_view === 'true');

                if (!isAdmin && isStaff && limitView) {
                    query = query.eq('coach_id', currentUser.id);
                }

                const { data: users, error } = await query;
                if (error) throw error;

                // Client-side Filtering
                let results = users.map(u => {
                    const p = Array.isArray(u.candidate_profiles) ? u.candidate_profiles[0] : u.candidate_profiles;
                    return { ...u, ...p, id: u.id };
                });

                results = results.filter(u => u.status !== 'suspended');

                if (managementStatus && managementStatus !== 'all') {
                    results = results.filter(u => u.management_status === managementStatus || (managementStatus === 'active' && !u.management_status));
                }

                if (keyword) {
                    const keywords = keyword.split(/[\sã€€]+/).filter(k => k);
                    const mode = $('input[name="c-search-keyword-mode"]:checked').val() || 'OR';

                    if (keywords.length > 0) {
                        results = results.filter(u => {
                            if (mode === 'OR') {
                                // ã„ãšã‚Œã‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°OK
                                return keywords.some(k =>
                                    (u.name && u.name.toLowerCase().includes(k)) ||
                                    (u.skills && u.skills.toLowerCase().includes(k)) ||
                                    (u.work_history && u.work_history.toLowerCase().includes(k))
                                );
                            } else {
                                // å…¨ã¦ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ãªã‘ã‚Œã°ãªã‚‰ãªã„
                                return keywords.every(k =>
                                    (u.name && u.name.toLowerCase().includes(k)) ||
                                    (u.skills && u.skills.toLowerCase().includes(k)) ||
                                    (u.work_history && u.work_history.toLowerCase().includes(k))
                                );
                            }
                        });
                    }
                }

                if (location) {
                    results = results.filter(u =>
                        (u.desired_location && (Array.isArray(u.desired_location) ? u.desired_location.join(' ') : u.desired_location).toLowerCase().includes(location.toLowerCase()))
                    );
                }

                if (pref && pref.length > 0) {
                    results = results.filter(u => {
                        if (!u.desired_location) return false;
                        const uLocs = Array.isArray(u.desired_location) ? u.desired_location : u.desired_location.split(',');
                        return uLocs.some(ul => pref.some(p => ul.includes(p)));
                    });
                }

                if (jobCat && jobCat.length > 0) {
                    results = results.filter(u => {
                        if (!u.desired_job_type) return false;
                        const uVals = Array.isArray(u.desired_job_type) ? u.desired_job_type : u.desired_job_type.split(',');
                        return uVals.some(v => jobCat.some(c => v.includes(c)));
                    });
                }

                if (minSal) {
                    results = results.filter(u => (u.desired_salary || 0) / 10000 >= minSal);
                }

                // Sort
                if (sort === 'created_at-desc') results.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                else if (sort === 'age-asc') results.sort((a, b) => (a.age || 999) - (b.age || 999));
                else if (sort === 'age-desc') results.sort((a, b) => (b.age || 0) - (a.age || 0));
                else if (sort === 'salary-desc') results.sort((a, b) => (b.desired_salary || 0) - (a.desired_salary || 0));

                // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†
                currentCandidatePage = page;
                currentCandidateFilters = { ...filters, aiPrompt };
                allCandidatesCache = results;

                const totalCount = results.length;
                totalCandidatePages = Math.ceil(totalCount / CANDIDATES_PER_PAGE);

                // AIæ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’æ›´æ–°
                updateAISearchState('candidate', totalCount);

                // AI Ranking if prompt exists and not initial load and box is active
                const isAiBoxDisabled = $('#candidate-ai-search-box').hasClass('disabled');
                console.log('AI Prompt Trigger Check (Candidates):', { isInitialLoad, isAiBoxDisabled, prompt: aiPrompt, resultCount: totalCount });

                if (!isInitialLoad && !isAiBoxDisabled && aiPrompt && aiPrompt.trim().length > 0 && results.length > 0) {
                    showLoading('AIãŒæŒ‡ç¤ºå†…å®¹ã«åŸºã¥ãç²¾æŸ»ä¸­...');
                    try {
                        const topResults = results.slice(0, 50); // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè©•ä¾¡ã¯ä¸Šä½50ä»¶ã«åˆ¶é™
                        const { data: aiRanked, error: aiError } = await supabase.functions.invoke('score-ai-recommendations', {
                            body: {
                                type: 'candidate',
                                customInstruction: aiPrompt,
                                candidates: topResults
                            }
                        });

                        if (!aiError && aiRanked) {
                            console.log('AI Match Results (Candidates):', aiRanked);
                            // ã‚¹ã‚³ã‚¢ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°
                            results.forEach(u => {
                                const rank = aiRanked.find(r => r.id === u.id || r.user_id === u.id);
                                if (rank) {
                                    u.ai_score = rank.score;
                                    u.ai_reason = rank.reason;
                                }
                            });
                            // ã‚¹ã‚³ã‚¢é †ã«ã‚½ãƒ¼ãƒˆï¼ˆä¸Šä½50ä»¶ã®ã¿ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé †ã€æ®‹ã‚Šã¯å…ƒã®é †åºï¼‰
                            results.sort((a, b) => (b.ai_score || 0) - (a.ai_score || 0));
                        } else if (aiError) {
                            console.error('AI Ranking Edge Function error (Candidates):', aiError);
                            alert('AIã«ã‚ˆã‚‹ç²¾æŸ»ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                        }
                    } catch (err) {
                        console.error('AI Ranking error (Candidates):', err);
                        alert('AIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                    }
                    hideLoading();
                }

                const from = (page - 1) * CANDIDATES_PER_PAGE;
                const to = from + CANDIDATES_PER_PAGE;
                const paginatedResults = results.slice(from, to);

                console.log(`Loaded candidate page ${page}/${totalCandidatePages}, showing ${paginatedResults.length} candidates (total: ${totalCount})`);

                renderCandidateResults(paginatedResults, totalCount);

                renderCandidatePagination();

            } catch (e) {
                console.error(e);
            } finally {
                hideLoading();
            }
        }

        // å€™è£œè€…ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³UIã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderCandidatePagination() {
            const container = $('#candidate-pagination-container');
            if (!container.length) {
                // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ†ãƒŠãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
                $('#candidate-results-container').after('<div id="candidate-pagination-container" class="mt-6"></div>');
            }

            if (totalCandidatePages <= 1) {
                $('#candidate-pagination-container').html('');
                return;
            }

            const maxButtons = 5;
            let startPage = Math.max(1, currentCandidatePage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalCandidatePages, startPage + maxButtons - 1);

            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            let html = '<div class="flex justify-center items-center gap-2">';

            // å‰ã¸ãƒœã‚¿ãƒ³
            if (currentCandidatePage > 1) {
                html += `<button onclick="searchCandidates(currentCandidateFilters, ${currentCandidatePage - 1})" 
                    class="px-4 py-2 border rounded-lg hover:bg-gray-50 transition">
                    <i class="fas fa-chevron-left"></i> å‰ã¸
                </button>`;
            }

            // ãƒšãƒ¼ã‚¸ç•ªå·ãƒœã‚¿ãƒ³
            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === currentCandidatePage;
                html += `<button onclick="searchCandidates(currentCandidateFilters, ${i})" 
                    class="px-4 py-2 border rounded-lg transition ${isActive ? 'bg-indigo-600 text-white' : 'hover:bg-gray-50'}">
                    ${i}
                </button>`;
            }

            // æ¬¡ã¸ãƒœã‚¿ãƒ³
            if (currentCandidatePage < totalCandidatePages) {
                html += `<button onclick="searchCandidates(currentCandidateFilters, ${currentCandidatePage + 1})" 
                    class="px-4 py-2 border rounded-lg hover:bg-gray-50 transition">
                    æ¬¡ã¸ <i class="fas fa-chevron-right"></i>
                </button>`;
            }

            html += '</div>';
            html += `<div class="text-center mt-2 text-sm text-gray-600">
                ãƒšãƒ¼ã‚¸ ${currentCandidatePage} / ${totalCandidatePages}
            </div>`;

            $('#candidate-pagination-container').html(html);
        }

        // AIãƒãƒƒãƒãƒ³ã‚°å®Ÿè¡Œ (æ±‚äºº -> æ±‚è·è€…)
        // AIãƒãƒƒãƒãƒ³ã‚°å®Ÿè¡Œ (2æ®µéš: ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹é¸æŠœ -> AIè©³ç´°è©•ä¾¡)
        window.runJobToCandidateMatching = async function () {
            if (!selectedTargetJobId) {
                alert('å¯¾è±¡æ±‚äººã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸå€™è£œè€…ã‚’å–å¾—
            const checkedIds = $('.candidate-select-checkbox:checked').map((_, el) => $(el).val()).get();
            const isSubset = checkedIds.length > 0;

            console.log('Running Matching. Selected:', checkedIds.length);
            showLoading('å€™è£œè€…ã‚’æŠ½å‡ºä¸­...');

            try {
                const job = allCandidateSearchJobs.find(j => j.id === selectedTargetJobId);
                if (!job) throw new Error("Selected Job Not Found");

                let candidates = [];

                // å€™è£œè€…å–å¾—
                if (isSubset) {
                    const { data: users } = await supabase.from('users')
                        .select('*, candidate_profiles(*)')
                        .in('id', checkedIds);
                    if (users) candidates = users;
                } else {
                    const { data: users } = await supabase.from('users')
                        .select('*, candidate_profiles(*)')
                        .eq('role', 'candidate')
                        .eq('organization_id', currentUser.organization_id);
                    if (users) candidates = users;
                }

                // Normalization
                candidates = candidates.map(u => {
                    const p = Array.isArray(u.candidate_profiles) ? u.candidate_profiles[0] : u.candidate_profiles;
                    return { ...u, ...p, id: u.id };
                });

                // åœæ­¢ä¸­ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŠã‚ˆã³æ´»å‹•çµ‚äº†ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é™¤å¤–
                candidates = candidates.filter(u => u.status !== 'suspended' && u.management_status !== 'inactive');

                // 1. ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
                const scored = candidates.map(c => {
                    const scores = calculateClientSideMatchScores(job, c);
                    return {
                        candidate: c,
                        ...scores,
                        recommendation_reason: generateClientSideRecommendationReason(job, c, scores)
                    };
                });

                // ã‚¹ã‚³ã‚¢é †ã«ã‚½ãƒ¼ãƒˆ (ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹)
                scored.sort((a, b) => b.match_score - a.match_score);

                // 2. çµã‚Šè¾¼ã¿ (ä¸Šä½5åã‹ã¤ã‚¹ã‚³ã‚¢40ç‚¹ä»¥ä¸Š)
                const AI_EVAL_LIMIT = 30;
                const AI_EVAL_THRESHOLD = 40;

                const candidatesForAI = scored.filter(s => s.match_score >= AI_EVAL_THRESHOLD).slice(0, AI_EVAL_LIMIT);

                hideLoading();

                if (candidatesForAI.length === 0) {
                    alert('AIè©•ä¾¡ã‚’è¡Œã†åŸºæº–ï¼ˆã‚¹ã‚³ã‚¢40ç‚¹ä»¥ä¸Šï¼‰ã‚’æº€ãŸã™å€™è£œè€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                    renderCandidateResults([]);
                    return;
                }

                // ç¢ºèª
                const confirmMsg = `ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹è©•ä¾¡ã«ã‚ˆã‚Šã€ä¸Šä½${candidatesForAI.length} åã®å€™è£œè€…ã‚’æŠ½å‡ºã—ã¾ã—ãŸã€‚\nï¼ˆé–¾å€¤: 40ç‚¹ä»¥ä¸Š / æœ€å¤§30åï¼‰\n\nã“ã‚Œã‚‰ã®å€™è£œè€…ã«å¯¾ã—ã¦ã€ç”ŸæˆAIã«ã‚ˆã‚‹è©³ç´°è©•ä¾¡ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”¨ã„ãŸè©³ç´°åˆ†æã‚’è¡Œã„ã¾ã™ã€‚é‡ãŒå¤šã„å ´åˆã¯å°‘ã—æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ï¼‰`;

                if (!confirm(confirmMsg)) {
                    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸå ´åˆã¯ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã®çµæœã‚’è¡¨ç¤º
                    renderMatchingResults(scored, '#candidate-results-container');
                    alert(`AIè©•ä¾¡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚\nãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹è©•ä¾¡ã®çµæœï¼ˆå…¨${scored.length} ä»¶ï¼‰ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚`);
                    return;
                }

                // 3. AIè©•ä¾¡å®Ÿè¡Œ
                showLoading(`AIãŒæŠ½å‡ºã•ã‚ŒãŸ${candidatesForAI.length}åã®å€™è£œè€…ã‚’è©³ç´°è©•ä¾¡ä¸­...\nã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚`);

                // ä¸¦åˆ—å‡¦ç†ã§Edge Functionã‚’å‘¼ã³å‡ºã™
                const aiPromises = candidatesForAI.map(async (item) => {
                    try {


                        const { data, error } = await supabase.functions.invoke('ai-matching', {
                            body: {
                                user: item.candidate,
                                jobs: [job]
                            }
                        });

                        if (error) throw error;
                        if (!data || data.length === 0) throw new Error("No Data");

                        const result = data[0];

                        // ãƒãƒ¼ã‚¸
                        return {
                            ...item,
                            match_score: result.match_score || item.match_score,
                            recommendation_reason: result.recommendation_reason || result.reason,

                            // è©³ç´°ã‚¹ã‚³ã‚¢ã®ä¸Šæ›¸ã (AIçµæœã«ã‚ã‚Œã°å„ªå…ˆ)
                            skill_match_score: result.skill_match_score ?? item.skill_match_score,
                            experience_match_score: result.experience_match_score ?? item.experience_match_score,
                            location_match_score: result.location_match_score ?? item.location_match_score,
                            salary_match_score: result.salary_match_score ?? item.salary_match_score,
                            culture_match_score: result.culture_match_score ?? item.culture_match_score,

                            ai_details: result.details,
                            is_ai_evaluated: true
                        };

                    } catch (e) {
                        console.error('AI Error for', item.candidate.name, e);
                        return { ...item, recommendation_reason: item.recommendation_reason + ' (AIè©•ä¾¡ã‚¨ãƒ©ãƒ¼)' };
                    }
                });

                const aiResults = await Promise.all(aiPromises);

                // å†ã‚½ãƒ¼ãƒˆï¼ˆAIã‚¹ã‚³ã‚¢ã§é †ä½ãŒå¤‰ã‚ã‚‹å¯èƒ½æ€§ã‚ã‚Šï¼‰
                aiResults.sort((a, b) => b.match_score - a.match_score);

                // è¡¨ç¤º (AIè©•ä¾¡ã•ã‚ŒãŸã‚‚ã®ã ã‘ã‚’è¡¨ç¤º)
                isAImatchingResultView = true;

                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
                aiResults.forEach(r => {
                    const key = `${r.candidate.id}_${selectedTargetJobId}`;
                    aiResultCache[key] = r.ai_details;
                });

                renderMatchingResults(aiResults, '#candidate-results-container');

                // ãƒãƒ¼ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆæ¬¡ã¯ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ãŒå‡ºã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ï¼‰
                clearAllSelectedCandidates();

                alert(`AIè©³ç´°è©•ä¾¡ãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n${aiResults.length} åã®å€™è£œè€…ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚`);

            } catch (e) {
                console.error(e);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
            } finally {
                hideLoading();
            }
        }

        window.saveCandidatesToRecommendations = async function () {
            const checkedIds = $('.candidate-select-checkbox:checked').map((_, el) => $(el).val()).get();
            if (checkedIds.length === 0) return;
            if (!selectedTargetJobId) {
                alert('å¯¾è±¡ã®æ±‚äººãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            showLoading('ãŠã™ã™ã‚ã«ä¿å­˜ä¸­...');
            try {
                const recs = checkedIds.map(userId => {
                    const key = `${userId}_${selectedTargetJobId}`;
                    const details = aiResultCache[key];

                    const card = $(`.candidate-select-checkbox[value="${userId}"]`).closest('.border');
                    const scoreText = card.find('span:contains("ãƒãƒƒãƒåº¦:")').text();
                    const score = parseFloat(scoreText.replace('ãƒãƒƒãƒåº¦:', '').replace('%', '')) || 0;

                    return {
                        organization_id: currentUser.organization_id,
                        user_id: userId,
                        job_id: selectedTargetJobId,
                        score: score,
                        reason: card.find('.bg-blue-50 p, .bg-gray-50 p').first().text().trim() || 'AIãƒãƒƒãƒãƒ³ã‚°è©•ä¾¡æ¸ˆã¿',
                        recommended_by: currentUser.id,
                        details: details || null
                    };
                });

                console.log('Saving recommendations:', recs);

                // æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€insert/updateã‚’å€‹åˆ¥ã«å®Ÿè¡Œ
                for (const rec of recs) {
                    // æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª
                    const { data: existing, error: checkError } = await supabase
                        .from('recommendations')
                        .select('id')
                        .eq('user_id', rec.user_id)
                        .eq('job_id', rec.job_id)
                        .maybeSingle();

                    if (checkError) {
                        console.error('Check error:', checkError);
                        throw checkError;
                    }

                    if (existing) {
                        // æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°
                        const { error: updateError } = await supabase
                            .from('recommendations')
                            .update({
                                score: rec.score,
                                reason: rec.reason,
                                recommended_by: rec.recommended_by,
                                details: rec.details
                            })
                            .eq('id', existing.id);

                        if (updateError) throw updateError;
                    } else {
                        // æ–°è¦ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æŒ¿å…¥
                        const { error: insertError } = await supabase
                            .from('recommendations')
                            .insert(rec);

                        if (insertError) throw insertError;
                    }
                }

                alert(`${recs.length} åã‚’ã€ŒãŠã™ã™ã‚æ±‚äººã€ã«ä¿å­˜ã—ã¾ã—ãŸã€‚`);
                clearAllSelectedCandidates();
            } catch (e) {
                console.error('Failed to save recommendations:', e);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
            } finally {
                hideLoading();
            }
        };

        window.clearMatchResults = function () {
            $('#candidate-results-container').empty();
            $('#candidate-results-container').html(`
            <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-search text-4xl mb-3"></i>
                        <p>æ¡ä»¶ã‚’æŒ‡å®šã—ã¦æ¤œç´¢ã—ã¦ãã ã•ã„</p>
                    </div>
            `);
            // Also restore checkboxes? They are gone.
            // Reset Floating Bar
            $('#c-selected-count').text('0');
            $('#candidate-float-bar').addClass('translate-y-full').addClass('hidden');
            $('#candidate-results-container').css('padding-bottom', '0');
        }

        function renderCandidateResults(candidates, totalCount = null) {
            isAImatchingResultView = false;
            // ãƒãƒ¼ã‚’éš ã™
            $('#candidate-float-bar').addClass('translate-y-full').addClass('hidden');

            const container = $('#candidate-results-container');
            if (candidates.length === 0) {
                container.html('<div class="text-center p-8 text-gray-500">æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹æ±‚è·è€…ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>');
                animateCandidateCount(0);
                return;
            }

            // ä»¶æ•°è¡¨ç¤ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            animateCandidateCount(totalCount);

            if (totalCount !== null) {
                const resultInfo = `<div class="mb-4 text-sm text-gray-600">
                    æ¤œç´¢çµæœ: ${totalCount}å (${currentCandidatePage}ãƒšãƒ¼ã‚¸ç›®ã‚’è¡¨ç¤ºä¸­)
                </div>`;
                container.append(resultInfo);
            }

            const html = candidates.map(c => {
                return renderCandidateCard({
                    candidate: c,
                    // ãƒãƒƒãƒåº¦ãªã©ã¯ä¸€æ—¦0ã¾ãŸã¯æ¤œç´¢çµæœã‹ã‚‰ (æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯ã«ã‚ˆã£ã¦ã¯ã‚¹ã‚³ã‚¢ãŒå…¥ã‚‹)
                    match_score: c.ai_score || c.match_score || 0,
                    skill_match_score: c.skill_match_score || 0,
                    experience_match_score: c.experience_match_score || 0,
                    location_match_score: c.location_match_score || 0,
                    salary_match_score: c.salary_match_score || 0,
                    culture_match_score: c.culture_match_score || 0,
                    recommendation_reason: c.ai_reason || ''
                });
            }).join('');
            container.html(html);
        }

        window.copyToClipboard = function (btn) {
            const card = $(btn).closest('.bg-white');
            const subject = (card.find('.scout-subject-input').val() || card.find('p:contains("ä»¶å:")').text().replace('ä»¶å: ', '') || '').trim();
            const body = (card.find('.scout-body-textarea').val() || card.find('.scout-body-text').text() || '').trim();

            const textToCopy = `ä»¶å: ${subject} \n\n${body} `;

            navigator.clipboard.writeText(textToCopy).then(() => {
                const originalHtml = $(btn).html();
                $(btn).html('<i class="fas fa-check text-green-500 text-xl"></i>');
                setTimeout(() => {
                    $(btn).html(originalHtml);
                }, 2000);
            });
        }


        // ========================
        // Pagination Variables
        // ========================
        // Pagination Variables
        // ========================
        const ITEMS_PER_PAGE = 20;
        let currentJobPage = 1;
        let totalJobPages = 1;
        let currentJobFilters = {};
        let allJobsCache = []; // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥

        async function loadJobs(filters = {}, page = 1) {
            if (!currentUser) return

            showLoading()
            try {
                // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰
                await loadMasterDataForSearch()

                // ç®¡ç†è€…ãƒ»ã‚³ãƒ¼ãƒãƒ»CAãƒ»ã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…ç”¨ãƒ„ãƒ¼ãƒ«ã®è¡¨ç¤ºåˆ¶å¾¡
                // ç®¡ç†è€…ãƒ»ã‚³ãƒ¼ãƒãƒ»CAãƒ»RAãƒ»ã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…ç”¨ãƒ„ãƒ¼ãƒ«ã®è¡¨ç¤ºåˆ¶å¾¡
                if (['org_admin', 'admin', 'coach', 'ca', 'ra', 'super_admin'].includes(currentUser.role)) {
                    $('#admin-job-search-tools').removeClass('hidden')
                    $('#candidate-ai-matching-tools').addClass('hidden')

                    // é™¤å¤–ãƒ•ã‚£ãƒ«ã‚¿ã‚’å¸¸ã«è¡¨ç¤ºï¼ˆAdmin/Coachã¯ã‚¿ãƒ¼ã‚²ãƒƒãƒˆé¸æŠæ™‚ã®ã¿æ©Ÿèƒ½ã™ã‚‹ãŒã€UIã¨ã—ã¦ã¯è¡¨ç¤ºï¼‰
                    $('#exclude-matched-container').removeClass('hidden');

                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã®ãƒ­ãƒ¼ãƒ‰ï¼ˆæœªãƒ­ãƒ¼ãƒ‰ã®å ´åˆï¼‰
                    if (allCandidateUsers.length === 0) {
                        await loadCandidateUsers()
                    }
                } else if (currentUser.role === 'candidate') {
                    // æ±‚è·è€…ç”¨AIãƒãƒƒãƒãƒ³ã‚°ãƒ„ãƒ¼ãƒ«ã‚’è¡¨ç¤º
                    $('#admin-job-search-tools').addClass('hidden')
                    $('#candidate-ai-matching-tools').addClass('hidden')
                    $('#exclude-matched-container').removeClass('hidden');
                } else {
                    $('#admin-job-search-tools').addClass('hidden')
                    $('#candidate-ai-matching-tools').addClass('hidden')
                    $('#exclude-matched-container').addClass('hidden');
                }

                // ãŠæ°—ã«å…¥ã‚Šã¨ä¿å­˜ã•ã‚ŒãŸæ¤œç´¢æ¡ä»¶ã‚’ãƒ­ãƒ¼ãƒ‰
                await Promise.all([loadFavorites(), loadSavedSearchesList()])

                // ãƒã‚¹ã‚¿ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œã«ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨ï¼ˆåˆå›ãƒ­ãƒ¼ãƒ‰ï¼å¼•æ•°filtersãŒç©ºã®å ´åˆã®ã¿ï¼‰
                // executeSearchã‹ã‚‰ã®å‘¼ã³å‡ºã—ï¼ˆfiltersãŒã‚ã‚‹å ´åˆï¼‰ã¯å†é©ç”¨ã—ãªã„ã“ã¨ã§ç„¡é™ãƒ«ãƒ¼ãƒ—ã‚’é˜²ã
                if (Object.keys(filters).length === 0) {
                    const savedFilters = loadSearchFilters();
                    if (savedFilters) {
                        console.log('Applying saved filters after master load');
                        applySearchFilters(savedFilters);
                    }
                }


                let query = window.supabase
                    .from('jobs')
                    .select('*, companies(name)', { count: 'exact' })
                    .eq('organization_id', currentUser.organization_id)
                // .eq('status', 'active') // ä¸€æ™‚çš„ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ã‚’è§£é™¤ï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œãªã„å•é¡Œå¯¾å¿œï¼‰

                // ã‚½ãƒ¼ãƒˆé †ã®é©ç”¨ã¯æœ€å¾Œã«ç§»å‹•ã—ã¾ã—ãŸ

                // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ (AND/OR)
                if (filters.keyword) {
                    const keywords = filters.keyword.split(/[\sã€€]+/).filter(k => k) // ç©ºç™½ã§åˆ†å‰²
                    const mode = filters.keywordMode || 'OR'

                    if (keywords.length > 0) {
                        // Note: companies.name ã§ã®æ¤œç´¢ã¯Supabaseã®è¤‡é›‘ãªã‚¯ã‚¨ãƒªã«ãªã‚‹ãŸã‚ã€
                        // ã“ã“ã§ã¯ç°¡æ˜“çš„ã« title, description, company (legacy column) ã‚’å¯¾è±¡ã¨ã™ã‚‹ã‹ã€
                        // ã‚‚ã—ãã¯ companiesãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ¤œç´¢ã—ã¦IDã‚’å–å¾—ã—ã¦ã‹ã‚‰...ã¨ã„ã†æ‰‹é †ãŒå¿…è¦ã ãŒã€
                        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’è€ƒæ…®ã—ã€ä¸€æ—¦æ—¢å­˜ã® company ã‚«ãƒ©ãƒ ã‚‚æ¤œç´¢å¯¾è±¡ã«å«ã‚ã‚‹ï¼ˆãƒ‡ãƒ¼ã‚¿ç§»è¡Œæ¸ˆã¿ãªã‚‰ company ã‚«ãƒ©ãƒ ã«ã‚‚å€¤ãŒå…¥ã£ã¦ã„ã‚‹ã¯ãšï¼‰
                        // æœ¬æ¥çš„ã«ã¯ .or(`title.ilike.% ${ k }%, description.ilike.% ${ k }%, companies.name.ilike.% ${ k }% `) ã¨ã—ãŸã„ãŒã€
                        // ãƒã‚¹ãƒˆã—ãŸãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æ¤œç´¢ã¯æ§‹æ–‡ãŒç•°ãªã‚‹ã€‚
                        // æš«å®šå¯¾å¿œ: company (legacy) ã‚«ãƒ©ãƒ ãŒåŒæœŸã•ã‚Œã¦ã„ã‚‹å‰æã§æ¤œç´¢ã€‚
                        if (mode === 'OR') {
                            const conditions = keywords.map(k =>
                                `title.ilike.%${k}%,description.ilike.%${k}%,company.ilike.%${k}%`
                            ).join(',')
                            query = query.or(conditions)
                        } else {
                            keywords.forEach(k => {
                                query = query.or(`title.ilike.%${k}%,description.ilike.%${k}%,company.ilike.%${k}%`)
                            })
                        }
                    }
                }

                if (filters.location) {
                    query = query.ilike('location', `%${filters.location}%`)
                }
                if (filters.prefecture && filters.prefecture.length > 0) {
                    const prefs = Array.isArray(filters.prefecture) ? filters.prefecture : [filters.prefecture];
                    const conditions = prefs.map(p => `location.ilike.%${p}%`).join(',');
                    query = query.or(conditions);
                }
                if (filters.employmentType && filters.employmentType.length > 0) {
                    const types = Array.isArray(filters.employmentType) ? filters.employmentType : [filters.employmentType];
                    // å®Œå…¨ä¸€è‡´(in)ã‹ã‚‰éƒ¨åˆ†ä¸€è‡´(ilike)ã«å¤‰æ›´ã—ã¦ã€ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šãƒ‡ãƒ¼ã‚¿ç­‰ã«å¯¾å¿œ
                    const conditions = types.map(t => `employment_type.ilike.%${t}%`).join(',');
                    query = query.or(conditions);
                }
                if (filters.jobCategory && filters.jobCategory.length > 0) {
                    const cats = Array.isArray(filters.jobCategory) ? filters.jobCategory : [filters.jobCategory];
                    // å®Œå…¨ä¸€è‡´(in)ã‹ã‚‰éƒ¨åˆ†ä¸€è‡´(ilike)ã«å¤‰æ›´ + è¡¨è¨˜æºã‚Œå¯¾ç­–ï¼ˆæ‹¬å¼§é™¤å»ï¼‰
                    const conditions = cats.map(c => {
                        let cleanC = c.replace(/[\(ï¼ˆ].*?[\)ï¼‰]/g, '').trim();
                        if (!cleanC) cleanC = c;
                        return `job_category.ilike.%${cleanC}%`;
                    }).join(',');
                    query = query.or(conditions);
                }
                if (filters.industryCategory && filters.industryCategory.length > 0) {
                    const inds = Array.isArray(filters.industryCategory) ? filters.industryCategory : [filters.industryCategory];
                    const conditions = inds.map(i => {
                        let cleanI = i.replace(/[\(ï¼ˆ].*?[\)ï¼‰]/g, '').trim();
                        if (!cleanI) cleanI = i;
                        return `industry_category.ilike.%${cleanI}%`;
                    }).join(',');
                    query = query.or(conditions);
                }
                if (filters.salaryMin) {
                    const minVal = parseInt(filters.salaryMin) * 10000;
                    // å¹´åæ¡ä»¶ã‚’æº€ãŸã™ã‹ã€å¹´åæƒ…å ±ãŒãªã„(null)æ±‚äººã‚’è¡¨ç¤º
                    query = query.or(`salary_max.gte.${minVal}, salary_max.is.null`);
                }
                if (filters.jobExperienceOk) {
                    query = query.eq('job_experience_ok', 'å¯')
                }
                if (filters.industryExperienceOk) {
                    query = query.eq('industry_experience_ok', 'å¯')
                }
                if (filters.isRemote) {
                    query = query.eq('is_remote', true)
                }

                // ãŠæ°—ã«å…¥ã‚Šã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                if (filters.favoritesOnly) {
                    if (favoriteJobIds.size > 0) {
                        query = query.in('id', Array.from(favoriteJobIds));
                    } else {
                        // ãŠæ°—ã«å…¥ã‚ŠãŒ0ä»¶ã®å ´åˆã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„
                        // id.in.() ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€ã‚ã‚Šå¾—ãªã„æ¡ä»¶ã‚’å…¥ã‚Œã‚‹
                        query = query.eq('id', '00000000-0000-0000-0000-000000000000'); // Dummy UUID
                    }
                }

                // AIãƒãƒƒãƒãƒ³ã‚°æ¸ˆã¿é™¤å¤–
                if (filters.excludeMatched) {
                    const targetUserId = selectedTargetUserId || (currentUser.role === 'candidate' ? currentUser.id : null);

                    if (targetUserId) {
                        // æ¨è–¦æ¸ˆã¿æ±‚äººIDã‚’å–å¾—
                        const { data: recommendations } = await supabase
                            .from('recommendations')
                            .select('job_id')
                            .eq('user_id', targetUserId);

                        if (recommendations && recommendations.length > 0) {
                            const matchedJobIds = recommendations.map(r => r.job_id);
                            if (matchedJobIds.length > 0) {
                                query = query.not('id', 'in', `(${matchedJobIds.join(',')})`);
                            }
                        }
                    }
                }

                // ã‚½ãƒ¼ãƒˆé †ã®é©ç”¨
                const sortParam = filters.sort || 'created_at-desc';
                console.log('Applying sort:', sortParam);
                const [sortCol, sortOrder] = sortParam.split('-');
                query = query.order(sortCol, { ascending: sortOrder === 'asc' });

                // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³: ç·ä»¶æ•°ã‚’å–å¾— + æŒ‡å®šãƒšãƒ¼ã‚¸ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                currentJobPage = page;
                currentJobFilters = filters;

                const from = (page - 1) * ITEMS_PER_PAGE;
                const to = from + ITEMS_PER_PAGE - 1;

                console.log('Fetching jobs with pagination:', { from, to, page });

                // ã‚¯ã‚¨ãƒªã‚’å†æ§‹ç¯‰ã—ã¦companiesã¨ã®joinã‚’è¿½åŠ 
                // range()ã¨countå–å¾—ã‚’åŒæ™‚ã«è¡Œã†
                const { data: jobs, error, count } = await query
                    .range(from, to);

                console.log('Query result:', { jobs: jobs?.length, error, count });

                // AIæ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’æ›´æ–°
                updateAISearchState('job', count);

                // --- AI Ranking Logic (Jobs) ---
                const isAiBoxDisabled = $('#job-ai-search-box').hasClass('disabled');
                console.log('AI Prompt Trigger Check (Jobs):', { isInitialLoad, isAiBoxDisabled, prompt: filters.aiPrompt, resultCount: count });

                if (!isInitialLoad && !isAiBoxDisabled && filters.aiPrompt && filters.aiPrompt.trim().length > 0) {
                    showLoading('AIãŒæŒ‡ç¤ºå†…å®¹ã«åŸºã¥ãæ±‚äººã‚’ç²¾æŸ»ä¸­...');
                    try {
                        if (jobs && jobs.length > 0) {
                            const { data: aiRanked, error: aiError } = await supabase.functions.invoke('score-ai-recommendations', {
                                body: {
                                    type: 'job',
                                    customInstruction: filters.aiPrompt,
                                    jobs: jobs
                                }
                            });

                            console.log('AI Ranking Results (Jobs):', aiRanked);
                            if (!aiError && aiRanked) {
                                // AIã®ã‚¹ã‚³ã‚¢ã‚’ jobs ã«ãƒãƒƒãƒ”ãƒ³ã‚°
                                jobs.forEach(job => {
                                    const rank = aiRanked.find(r => r.job_id === job.id || r.id === job.id);
                                    if (rank) {
                                        job.ai_score = rank.score;
                                        job.ai_reason = rank.reason;
                                    }
                                });
                                // AIã‚¹ã‚³ã‚¢é †ã«ã‚½ãƒ¼ãƒˆ
                                jobs.sort((a, b) => (b.ai_score || 0) - (a.ai_score || 0));
                            } else if (aiError) {
                                console.error('AI Ranking Edge Function error (Jobs):', aiError);
                                alert('AIã«ã‚ˆã‚‹ç²¾æŸ»ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                            }
                        }
                    } catch (err) {
                        console.error('AI Ranking error (Jobs):', err);
                        alert('AIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                    }
                    hideLoading();
                }

                // ç·ãƒšãƒ¼ã‚¸æ•°ã‚’è¨ˆç®—
                totalJobPages = count ? Math.ceil(count / ITEMS_PER_PAGE) : 1;

                console.log(`Loaded page ${page}/${totalJobPages}, showing ${jobs?.length || 0} jobs (total: ${count})`);

                await renderJobs(jobs, count)
                renderJobPagination();
            } catch (error) {
                console.error('Load jobs error:', error)
                $('#jobs-container').html('<p class="text-red-500">æ±‚äººã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>')
            } finally {
                hideLoading()
            }
        }

        // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³UIã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderJobPagination() {
            console.log('renderJobPagination called:', { currentJobPage, totalJobPages });

            const container = $('#job-pagination-container');
            if (!container.length) {
                console.log('Creating pagination container');
                // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ†ãƒŠãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
                $('#jobs-container').after('<div id="job-pagination-container" class="mt-6"></div>');
            }

            if (totalJobPages <= 1) {
                console.log('Only 1 page, hiding pagination');
                $('#job-pagination-container').html('');
                return;
            }

            console.log('Rendering pagination UI');
            const maxButtons = 5; // è¡¨ç¤ºã™ã‚‹ãƒšãƒ¼ã‚¸ãƒœã‚¿ãƒ³ã®æœ€å¤§æ•°
            let startPage = Math.max(1, currentJobPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalJobPages, startPage + maxButtons - 1);

            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            let html = '<div class="flex justify-center items-center gap-2">';

            // å‰ã¸ãƒœã‚¿ãƒ³
            if (currentJobPage > 1) {
                html += `<button onclick="goToJobPage(${currentJobPage - 1})" 
                    class="px-4 py-2 border rounded-lg hover:bg-gray-50 transition">
                    <i class="fas fa-chevron-left"></i> å‰ã¸
                </button>`;
            }

            // ãƒšãƒ¼ã‚¸ç•ªå·ãƒœã‚¿ãƒ³
            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === currentJobPage;
                html += `<button onclick="goToJobPage(${i})" 
                    class="px-4 py-2 border rounded-lg transition ${isActive ? 'bg-indigo-600 text-white' : 'hover:bg-gray-50'}">
                    ${i}
                </button>`;
            }

            // æ¬¡ã¸ãƒœã‚¿ãƒ³
            if (currentJobPage < totalJobPages) {
                html += `<button onclick="goToJobPage(${currentJobPage + 1})" 
                    class="px-4 py-2 border rounded-lg hover:bg-gray-50 transition">
                    æ¬¡ã¸ <i class="fas fa-chevron-right"></i>
                </button>`;
            }

            html += '</div>';
            html += `<div class="text-center mt-2 text-sm text-gray-600">
                ãƒšãƒ¼ã‚¸ ${currentJobPage} / ${totalJobPages}
            </div>`;

            console.log('Setting pagination HTML');
            $('#job-pagination-container').html(html);
        }

        // æ±‚äººæ¤œç´¢ã®ãƒšãƒ¼ã‚¸ç§»å‹•
        window.goToJobPage = function (page) {
            loadJobs(currentJobFilters, page);
        }



        // æ¤œç´¢æ¡ä»¶ã®ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿
        // æ¤œç´¢æ¡ä»¶ã®ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿
        window.saveSearchFilters = function (filters) {
            if (!currentUser) {
                console.warn('Cannot save search filters: currentUser is null');
                return;
            }
            const key = `job_search_filters_${currentUser.id} `;
            localStorage.setItem(key, JSON.stringify(filters));
            console.log('Search filters saved:', filters);
        }

        window.loadSearchFilters = function () {
            if (!currentUser) {
                console.warn('Cannot load search filters: currentUser is null');
                return null;
            }
            const key = `job_search_filters_${currentUser.id} `;
            const saved = localStorage.getItem(key);
            console.log('Search filters loaded:', saved ? JSON.parse(saved) : 'none');
            return saved ? JSON.parse(saved) : null;
        }

        window.applySearchFilters = function applySearchFilters(filters) {
            if (!filters) return;

            console.log('Applying search filters:', filters);
            $('#search-keyword').val(filters.keyword || '');
            if (filters.keywordMode) {
                $(`input[name="search-keyword-mode"][value="${filters.keywordMode}"]`).prop('checked', true);
            }
            $('#search-location').val(filters.location || '');
            $('#search-prefecture').val(filters.prefecture || []).trigger('change');
            $('#search-employment-type').val(filters.employmentType || []).trigger('change');
            $('#search-job-category').val(filters.jobCategory || []).trigger('change');
            $('#search-industry-category').val(filters.industryCategory || []).trigger('change');
            $('#search-salary-min').val(filters.salaryMin || '');
            $('#search-job-experience-ok').prop('checked', !!filters.jobExperienceOk);
            $('#search-industry-experience-ok').prop('checked', !!filters.industryExperienceOk);
            $('#search-is-remote').prop('checked', !!filters.isRemote);
            $('#search-exclude-matched').prop('checked', !!filters.excludeMatched);
            $('#search-favorites-only').prop('checked', !!filters.favoritesOnly);
        }

        function animateJobCount(targetCount) {
            const display = $('#job-count-display-premium');
            const numberElement = display.find('#job-count-number');
            if (targetCount === null || targetCount === undefined) {
                display.addClass('hidden');
                return;
            }
            display.removeClass('hidden');
            const duration = 1200;
            const startTime = Date.now();
            const startValue = 0;
            function updateCount() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeProgress = 1 - Math.pow(1 - progress, 4);
                const currentValue = Math.floor(startValue + (targetCount - startValue) * easeProgress);
                numberElement.text(currentValue.toLocaleString());
                if (progress < 1) requestAnimationFrame(updateCount);
                else numberElement.text(targetCount.toLocaleString());
            }
            requestAnimationFrame(updateCount);
        }

        function animateCandidateCount(targetCount) {
            const display = $('#candidate-count-display-premium');
            const numberElement = display.find('#candidate-count-number');

            if (targetCount === null || targetCount === undefined) {
                display.addClass('hidden');
                return;
            }

            display.removeClass('hidden');

            const duration = 1200;
            const startTime = Date.now();
            const startValue = 0;

            function updateCount() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeProgress = 1 - Math.pow(1 - progress, 4);
                const currentValue = Math.floor(startValue + (targetCount - startValue) * easeProgress);

                numberElement.text(currentValue.toLocaleString());

                if (progress < 1) {
                    requestAnimationFrame(updateCount);
                } else {
                    numberElement.text(targetCount.toLocaleString());
                }
            }

            requestAnimationFrame(updateCount);
        }

        // --- Premium Search UI Support ---
        function setupPremiumSearchUI() {

            // Salary slider sync
            $('#search-salary-slider').on('input', function () {
                const val = $(this).val();
                $('#search-salary-min').val(val);
                $('#salary-display').text(val === '0' ? 'æŒ‡å®šãªã—' : val + ' ä¸‡å††ä»¥ä¸Š');
            });

            $('#c-search-salary-slider').on('input', function () {
                const val = $(this).val();
                $('#c-search-salary-min').val(val);
                $('#c-salary-display').text(val === '0' ? 'æŒ‡å®šãªã—' : val + ' ä¸‡å††ä»¥ä¸Š');
            });

            // Tag sync for Select2
            function syncTags(selectId, containerId, colorClass) {
                const $select = $('#' + selectId);
                const $container = $('#' + containerId);
                if (!$select.length || !$container.length) return;

                $select.off('change.syncTags').on('change.syncTags', function () {
                    // Select2ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
                    if (!$select.hasClass('select2-hidden-accessible')) return;

                    $container.empty();
                    const selected = $select.select2('data') || [];
                    selected.forEach(item => {
                        const $tag = $(`
                            <span class="premium-tag ${colorClass}">
                                ${item.text}
                                <i class="fas fa-times tag-remove ml-2 opacity-50 hover:opacity-100" data-id="${item.id}"></i>
                            </span>
                        `);
                        $tag.find('.tag-remove').on('click', function (e) {
                            e.stopPropagation();
                            const id = $(this).data('id');
                            const values = $select.val() || [];
                            const newValues = values.filter(v => v !== id.toString());
                            $select.val(newValues).trigger('change');
                        });
                        $container.append($tag);
                    });
                });
            }

            // Jobs
            syncTags('search-industry-category', 'tags-industry', 'tag-blue');
            syncTags('search-job-category', 'tags-job', 'tag-blue');
            syncTags('search-employment-type', 'tags-employment', 'tag-blue');
            syncTags('search-prefecture', 'tags-prefecture', 'tag-blue');

            // Candidates
            syncTags('c-search-industry-category', 'c-tags-industry', 'tag-blue');
            syncTags('c-search-job-category', 'c-tags-job', 'tag-blue');
            syncTags('c-search-employment-type', 'c-tags-employment', 'tag-blue');
            syncTags('c-search-prefecture', 'c-tags-prefecture', 'tag-blue');

            // Freelance Keyword Tagging
            function setupFreeword(inputId, containerId, syncFunc, colorClass = 'tag-amber') {
                const $input = $('#' + inputId);
                const $container = $('#' + containerId);
                if (!$input.length) return;

                $input.off('keypress').on('keypress', function (e) {
                    if (e.which === 13) {
                        e.preventDefault();
                        const val = $(this).val().trim();
                        if (val) {
                            addFreewordTag(val, $container, syncFunc, colorClass);
                            $(this).val('');
                        }
                    }
                });
            }

            function addFreewordTag(val, $container, syncFunc, colorClass) {
                // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                let exists = false;
                $container.find('.premium-tag').each(function () {
                    if ($(this).text().trim() === val) exists = true;
                });
                if (exists) return;

                const $tag = $(`
                    <span class="premium-tag ${colorClass}">
                        ${val}
                        <i class="fas fa-times tag-remove ml-2 opacity-50 hover:opacity-100"></i>
                    </span>
                `);
                $tag.find('.tag-remove').on('click', function () {
                    $tag.remove();
                    if (syncFunc) syncFunc();
                });
                $container.append($tag);
                if (syncFunc) syncFunc();
            }

            // Keyword tagging
            setupFreeword('search-keyword', 'tags-keyword', null, 'tag-indigo');
            setupFreeword('c-search-keyword', 'c-tags-keyword', null, 'tag-indigo');

            // Location tagging
            setupFreeword('search-location', 'tags-freeword', null, 'tag-amber');
            setupFreeword('c-search-location', 'c-tags-location', null, 'tag-amber');
        }

        // ãƒ‡ãƒã‚¦ãƒ³ã‚¹é–¢æ•°
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        const executeSearch = async function () {
            console.log('executeSearch called. Sort:', $('#search-sort').val());

            // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚¿ã‚°
            const kTags = [];
            $('#tags-keyword .premium-tag').each(function () {
                kTags.push($(this).text().trim().toLowerCase());
            });
            let keyword = $('#search-keyword').val().toLowerCase().trim();
            if (kTags.length > 0) {
                keyword = (keyword + ' ' + kTags.join(' ')).trim();
            }

            // ãƒ•ãƒªãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚¿ã‚°
            let freeword = $('#search-location').val().trim();
            const fTags = [];
            $('#tags-freeword .premium-tag').each(function () {
                fTags.push($(this).text().trim());
            });
            if (fTags.length > 0) {
                freeword = (freeword + ' ' + fTags.join(' ')).trim();
            }

            const filters = {
                keyword: keyword,
                keywordMode: $('input[name="search-keyword-mode"]:checked').val(),
                location: freeword,
                prefecture: $('#search-prefecture').val(),
                employmentType: $('#search-employment-type').val(),
                jobCategory: $('#search-job-category').val(),
                industryCategory: $('#search-industry-category').val(),
                salaryMin: $('#search-salary-min').val(),
                jobExperienceOk: $('#search-job-experience-ok').is(':checked'),
                industryExperienceOk: $('#search-industry-experience-ok').is(':checked'),
                isRemote: $('#search-is-remote').is(':checked'),
                excludeMatched: $('#search-exclude-matched').is(':checked'),
                favoritesOnly: $('#search-favorites-only').is(':checked'),
                sort: $('#search-sort').val(),
                aiPrompt: $('#search-ai-prompt').val()
            }

            // æ¤œç´¢æ¡ä»¶ã‚’ä¿å­˜
            saveSearchFilters(filters);

            await loadJobs(filters)
        };

        // ãƒ‡ãƒã‚¦ãƒ³ã‚¹ä»˜ãã®æ¤œç´¢å®Ÿè¡Œé–¢æ•°
        window.searchJobs = debounce(executeSearch, 500);

        // æ‰‹å‹•ã§å³æ™‚å®Ÿè¡Œã—ãŸã„å ´åˆï¼ˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ãªã©ï¼‰
        window.searchJobsImmediate = executeSearch;

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®åˆæœŸåŒ–
        function initSearchEventListeners() {
            const searchInputs = [
                '#search-keyword',
                '#search-salary-min'
            ];
            const searchSelects = [
                '#search-sort'
            ];
            const searchCheckboxes = [
                'input[name="search-keyword-mode"]',
                '#search-job-experience-ok',
                '#search-industry-experience-ok',
                '#search-is-remote',
                '#search-exclude-matched',
                '#search-favorites-only'
            ];

            // ä»¥å‰ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤ã—ã¦éš›è¨­å®šï¼ˆä¸€éƒ¨ã‚’è‡ªå‹•æ¤œç´¢å¯¾è±¡ã«ï¼‰
            // Select2ãªã©ã®changeã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚¿ã‚°åŒæœŸå´ã§ãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚æ…é‡ã«
            // ã“ã“ã§ã¯æ¤œç´¢ãƒœã‚¿ãƒ³ã§ã®å®Ÿè¡Œã‚’åŸºæœ¬ã¨ã™ã‚‹
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚‚å®Ÿè¡Œ
        $(document).ready(function () {
            initSearchEventListeners();
            setupPremiumSearchUI();
        });

        window.clearSearch = function () {
            // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã®ã‚¯ãƒªã‚¢
            $('#search-keyword').val('');
            $('#tags-keyword').empty();
            $('#search-location').val('');
            $('#tags-freeword').empty();
            $('#search-salary-min').val('0');
            $('#search-salary-slider').val(0);
            $('#salary-display').text('æŒ‡å®šãªã—');
            $('#search-ai-prompt').val('');

            // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ãƒªã‚»ãƒƒãƒˆ
            $('input[name="search-keyword-mode"][value="OR"]').prop('checked', true);

            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¯ãƒªã‚¢ (é †åºã‚’å‰ã«ç§»å‹•)
            $('#search-job-experience-ok').prop('checked', false);
            $('#search-industry-experience-ok').prop('checked', false);
            $('#search-is-remote').prop('checked', false);
            $('#search-exclude-matched').prop('checked', false);
            $('#search-favorites-only').prop('checked', false);

            // ã‚½ãƒ¼ãƒˆã®ãƒªã‚»ãƒƒãƒˆ
            $('#search-sort').val('created_at-desc');

            // Select2ã®ã‚¯ãƒªã‚¢ (ãƒˆãƒªã‚¬ãƒ¼ã«ã‚ˆã‚‹å†æ¤œç´¢ãŒèµ°ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚æœ€å¾Œã«)
            $('#search-prefecture').val([]).trigger('change');
            $('#search-employment-type').val([]).trigger('change');
            $('#search-job-category').val([]).trigger('change');
            $('#search-industry-category').val([]).trigger('change');

            // ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚£ãƒ«ã‚¿ã‚’ã‚¯ãƒªã‚¢ï¼ˆç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ä¸Šæ›¸ãï¼‰
            if (window.saveSearchFilters) window.saveSearchFilters({});

            // æœ€å¾Œã«æ¤œç´¢å®Ÿè¡Œ
            if (typeof loadJobs === 'function') loadJobs();
        }

        /**
         * ä¸Šä½30ä»¶ã‚’é¸æŠã™ã‚‹
         */
        window.selectTop30Jobs = function () {
            const checkboxes = $('.job-checkbox:not(:disabled)');
            if (checkboxes.length === 0) {
                alert('é¸æŠå¯èƒ½ãªæ±‚äººãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            let count = 0;
            checkboxes.each(function (index) {
                if (index < 30) {
                    if (!$(this).prop('checked')) {
                        $(this).trigger('click');
                        count++;
                    }
                }
            });
        }

        // ========================
        // Favorites & Saved Searches
        // ========================
        async function loadFavorites() {
            if (!currentUser) return
            try {
                const { data: favs, error } = await supabase
                    .from('favorites')
                    .select('job_id')
                    .eq('user_id', currentUser.id)

                if (error) throw error
                favoriteJobIds = new Set(favs.map(f => f.job_id))
            } catch (error) {
                console.error('Load favorites error:', error)
            }
        }

        // ãŠæ°—ã«å…¥ã‚Šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        window.openFavoritesModal = async function () {
            if (!currentUser) return;

            showLoading();
            try {
                // ãŠæ°—ã«å…¥ã‚Šæ±‚äººIDã‚’å–å¾—ï¼ˆå¿µã®ãŸã‚å†å–å¾—ï¼‰
                await loadFavorites();

                if (favoriteJobIds.size === 0) {
                    $('#favorites-list').html('<p class="text-center text-gray-500 py-8">ãŠæ°—ã«å…¥ã‚Šã«ç™»éŒ²ã•ã‚ŒãŸæ±‚äººã¯ã‚ã‚Šã¾ã›ã‚“</p>');
                    $('#favorites-modal').removeClass('hidden');
                    hideLoading();
                    return;
                }

                // æ±‚äººæƒ…å ±ã‚’å–å¾—
                const { data: jobs, error } = await supabase
                    .from('jobs')
                    .select('*, companies(name)')
                    .in('id', Array.from(favoriteJobIds));

                if (error) throw error;

                renderFavoriteJobs(jobs);
                $('#favorites-modal').removeClass('hidden');

            } catch (error) {
                console.error('Open favorites error:', error);
                alert('ãŠæ°—ã«å…¥ã‚Šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            } finally {
                hideLoading();
            }
        }

        // ãŠæ°—ã«å…¥ã‚Šæ±‚äººã®æç”»
        function renderFavoriteJobs(jobs) {
            const container = $('#favorites-list');
            container.empty();

            const html = jobs.map(job => `
            <div class="border-b border-gray-200 py-4 last:border-0">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h4 class="text-lg font-bold text-gray-900 hover:text-indigo-600 cursor-pointer"
                            onclick="showJobDetailModal('${job.id}')">${job.title}</h4>
                        <p class="text-sm text-gray-600">${job.companies?.name || job.company}</p>
                        <div class="flex items-center gap-3 mt-2 text-sm text-gray-500">
                            <span><i class="fas fa-map-marker-alt mr-1"></i>${job.location}</span>
                            <span><i class="fas fa-yen-sign mr-1"></i>${(job.salary_min / 10000).toLocaleString()}ä¸‡ - ${(job.salary_max / 10000).toLocaleString()}ä¸‡å††</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="showJobDetailModal('${job.id}')" class="text-indigo-600 hover:text-indigo-800 p-2 text-sm">
                            è©³ç´°
                        </button>
                        <button onclick="toggleFavorite('${job.id}'); $(this).closest('.border-b').remove();"
                            class="text-pink-500 hover:text-pink-700 p-2" title="ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å‰Šé™¤">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
                </div>
            `).join('');

            container.html(html);
        }

        window.closeFavoritesModal = function () {
            $('#favorites-modal').addClass('hidden');
        }

        window.toggleFavorite = async function (jobId) {
            if (!currentUser) return
            const isFav = favoriteJobIds.has(jobId)

            try {
                const updateButtons = (active) => {
                    // ãƒªã‚¹ãƒˆç”¨ã‚¢ã‚¤ã‚³ãƒ³
                    const listIcon = $(`#fav-btn-${jobId} i`);
                    if (active) {
                        listIcon.removeClass('far text-gray-400').addClass('fas text-pink-500');
                    } else {
                        listIcon.removeClass('fas text-pink-500').addClass('far text-gray-400');
                    }

                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ãƒœã‚¿ãƒ³
                    const modalBtn = $(`#modal-fav-btn-${jobId}`);
                    if (modalBtn.length) {
                        if (active) {
                            modalBtn.removeClass('border-gray-300 text-gray-700').addClass('border-pink-500 text-pink-600');
                            modalBtn.html('<i class="fas fa-heart mr-2"></i>ãŠæ°—ã«å…¥ã‚Šç™»éŒ²æ¸ˆã¿');
                        } else {
                            modalBtn.removeClass('border-pink-500 text-pink-600').addClass('border-gray-300 text-gray-700');
                            modalBtn.html('<i class="fas fa-heart mr-2"></i>ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ');
                        }
                    }
                };

                if (isFav) {
                    // Remove
                    const { error } = await supabase
                        .from('favorites')
                        .delete()
                        .eq('user_id', currentUser.id)
                        .eq('job_id', jobId)
                    if (error) throw error
                    favoriteJobIds.delete(jobId)
                    updateButtons(false);
                } else {
                    // Add
                    const { error } = await supabase
                        .from('favorites')
                        .insert({ user_id: currentUser.id, job_id: jobId })
                    if (error) throw error
                    favoriteJobIds.add(jobId)
                    updateButtons(true);
                }
            } catch (error) {
                console.error('Toggle favorite error:', error)
                alert('ãŠæ°—ã«å…¥ã‚Šã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ')
            }
        }

        async function loadSavedSearchesList() {
            if (!currentUser) return
            try {
                const { data: searches, error } = await supabase
                    .from('saved_searches')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })

                if (error) throw error
                savedSearches = searches

                const select = $('#saved-searches-select')
                select.empty()
                select.append('<option value="">ä¿å­˜ã—ãŸæ¤œç´¢æ¡ä»¶</option>')

                if (searches.length > 0) {
                    select.removeClass('hidden')
                    searches.forEach(s => {
                        select.append(`<option value="${s.id}">${s.name}</option>`)
                    })
                } else {
                    select.addClass('hidden')
                }
            } catch (error) {
                console.error('Load saved searches error:', error)
            }
        }

        window.saveSearchConditions = async function () {
            if (!currentUser) return
            const name = prompt('æ¤œç´¢æ¡ä»¶ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:')
            if (!name) return

            const criteria = {
                keyword: $('#search-keyword').val().trim(),
                keywordMode: $('input[name="search-keyword-mode"]:checked').val(),
                location: $('#search-location').val().trim(),
                prefecture: $('#search-prefecture').val(),
                employmentType: $('#search-employment-type').val(),
                jobCategory: $('#search-job-category').val(),
                industryCategory: $('#search-industry-category').val(),
                salaryMin: $('#search-salary-min').val(),
                jobExperienceOk: $('#search-job-experience-ok').is(':checked'),
                industryExperienceOk: $('#search-industry-experience-ok').is(':checked'),
                isRemote: $('#search-is-remote').is(':checked'),
                excludeMatched: $('#search-exclude-matched').is(':checked'),
                favoritesOnly: $('#search-favorites-only').is(':checked')
            }

            try {
                const { error } = await supabase
                    .from('saved_searches')
                    .insert({
                        user_id: currentUser.id,
                        name: name,
                        criteria: criteria
                    })

                if (error) throw error
                alert('æ¤œç´¢æ¡ä»¶ã‚’ä¿å­˜ã—ã¾ã—ãŸ')
                loadSavedSearchesList()
            } catch (error) {
                console.error('Save search error:', error)
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ')
            }
        }

        window.loadSavedSearch = function (searchId) {
            if (!searchId) return
            const search = savedSearches.find(s => s.id === searchId)
            if (!search) return

            const c = search.criteria
            $('#search-keyword').val(c.keyword || '')
            if (c.keywordMode) $(`input[name="search-keyword-mode"][value="${c.keywordMode}"]`).prop('checked', true)
            $('#search-location').val(c.location || '')
            $('#search-prefecture').val(c.prefecture || []).trigger('change')
            $('#search-employment-type').val(c.employmentType || []).trigger('change')
            $('#search-job-category').val(c.jobCategory || []).trigger('change')
            $('#search-industry-category').val(c.industryCategory || []).trigger('change')
            $('#search-salary-min').val(c.salaryMin || '0')
            $('#search-salary-slider').val(c.salaryMin || 0)
            $('#salary-display').text(!c.salaryMin || c.salaryMin === '0' ? 'æŒ‡å®šãªã—' : c.salaryMin + ' ä¸‡å††ä»¥ä¸Š')
            $('#search-job-experience-ok').prop('checked', !!c.jobExperienceOk)
            $('#search-industry-experience-ok').prop('checked', !!c.industryExperienceOk)
            $('#search-is-remote').prop('checked', !!c.isRemote)
            $('#search-exclude-matched').prop('checked', !!c.excludeMatched)
            $('#search-favorites-only').prop('checked', !!c.favoritesOnly)
            $('#search-favorites-only').prop('checked', !!c.favoritesOnly)

            // æ¤œç´¢å®Ÿè¡Œ
            searchJobs()
        }

        // AIæ¨è–¦æ¸ˆã¿æ±‚äººIDã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        let recommendedJobIds = new Set();

        async function renderJobs(jobs, totalCount = null) {
            const container = $('#jobs-container')
            container.empty()

            if (jobs.length === 0) {
                container.html('<p class="text-gray-500 text-center py-8">ç¾åœ¨å‹Ÿé›†ä¸­ã®æ±‚äººã¯ã‚ã‚Šã¾ã›ã‚“</p>')
                animateJobCount(0); // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’0ã«ãƒªã‚»ãƒƒãƒˆ
                return
            }

            // æ±‚äººä»¶æ•°ã‚’ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
            animateJobCount(totalCount);

            // æ¤œç´¢çµæœã®ä»¶æ•°è¡¨ç¤º
            if (totalCount !== null) {
                const resultInfo = `<div class="mb-4 text-sm text-gray-600">
                    æ¤œç´¢çµæœ: ${totalCount}ä»¶ (${currentJobPage}ãƒšãƒ¼ã‚¸ç›®ã‚’è¡¨ç¤ºä¸­)
                </div>`;
                container.append(resultInfo);
            }

            const isAdminOrCoach = currentUser && ['org_admin', 'admin', 'coach', 'ca', 'super_admin'].includes(currentUser.role)
            const isCandidate = currentUser && currentUser.role === 'candidate'

            // é¸æŠä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
            const selectedUserId = selectedTargetUserId;
            console.log('renderJobs - selectedUserId:', selectedUserId);

            // AIæ¨è–¦æ¸ˆã¿æ±‚äººIDã‚’å–å¾—
            // ç®¡ç†è€…/ã‚³ãƒ¼ãƒ/CAãŒå¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ã„ã‚‹å ´åˆã€ã¾ãŸã¯æ±‚è·è€…ãŒè‡ªåˆ†è‡ªèº«ã®å ´åˆ
            const targetUserId = isAdminOrCoach ? selectedUserId : (isCandidate ? currentUser.id : null);
            console.log('renderJobs - targetUserId:', targetUserId);

            let recommendedJobsMap = new Map(); // job_id -> score ã®ãƒãƒƒãƒ—
            let appliedJobIds = new Set();

            if (targetUserId) {
                try {
                    // AIæ¨è–¦æ¸ˆã¿æ±‚äººã¨ã‚¹ã‚³ã‚¢ã‚’å–å¾—
                    const { data: recommendations, error: recError } = await supabase
                        .from('recommendations')
                        .select('job_id, score')
                        .eq('user_id', targetUserId);

                    console.log('renderJobs - recommendations:', recommendations, 'error:', recError);

                    if (!recError && recommendations) {
                        recommendations.forEach(r => {
                            recommendedJobsMap.set(r.job_id, r.score);
                        });
                        recommendedJobIds = new Set(recommendations.map(r => r.job_id));
                    }

                    // å¿œå‹Ÿæ¸ˆã¿æ±‚äººã‚’å–å¾—
                    const { data: applications, error: appError } = await supabase
                        .from('applications')
                        .select('job_id')
                        .eq('user_id', targetUserId);

                    if (!appError && applications) {
                        appliedJobIds = new Set(applications.map(a => a.job_id));
                    }
                } catch (error) {
                    console.error('Failed to load recommendations/applications:', error);
                }
            }

            // ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«å¤‰æ›´
            container.attr('class', 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6');

            const html = jobs.map(job => {
                const isSelected = selectedJobIds.has(job.id)
                const isRecommended = recommendedJobIds.has(job.id)
                const recommendationScore = recommendedJobsMap.get(job.id)
                const isApplied = appliedJobIds.has(job.id)
                const showCheckbox = isAdminOrCoach || isCandidate

                // çµ¦ä¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆç°¡æ˜“ï¼‰
                const formatSalary = (val) => val ? (val / 10000).toLocaleString() + 'ä¸‡' : '-';

                return `
                <div class="bg-white border border-gray-200 rounded-lg p-5 shadow-sm hover:shadow-md transition flex flex-col h-full relative ${isSelected ? 'ring-2 ring-indigo-500 bg-indigo-50' : ''} ${isRecommended ? 'ring-2 ring-purple-400' : ''}">
                    
                    <div class="flex justify-between items-start mb-3">
                         <div class="flex items-center z-10">
                            ${showCheckbox ? `
                                <input type="checkbox" 
                                    class="job-checkbox w-5 h-5 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 mr-2 cursor-pointer ${isRecommended ? 'opacity-50 cursor-not-allowed' : ''}"
                                    onclick="event.stopPropagation(); toggleJobSelection('${job.id}')"
                                    ${isSelected ? 'checked' : ''}
                                    ${isRecommended ? 'disabled' : ''}>
                            ` : ''}
                         </div>
                         <div class="flex items-center gap-2 z-10">
                            ${isRecommended ? `<span class="text-xs font-bold text-white bg-gradient-to-r from-purple-500 to-indigo-600 px-2 py-1 rounded-full shadow-sm"><i class="fas fa-robot mr-1"></i>${recommendationScore}%</span>` : ''}
                            ${isApplied ? `<span class="text-xs font-bold text-green-700 bg-green-100 px-2 py-1 rounded-full"><i class="fas fa-check mr-1"></i>å¿œå‹Ÿæ¸ˆ</span>` : ''}
                            <button id="fav-btn-${job.id}" onclick="event.stopPropagation(); toggleFavorite('${job.id}')" class="text-gray-400 hover:text-pink-500 transition p-1">
                                <i class="${favoriteJobIds.has(job.id) ? 'fas text-pink-500' : 'far'} fa-heart text-xl"></i>
                            </button>
                         </div>
                    </div>

                    <div class="flex-grow cursor-pointer" onclick="showJobDetailModal('${job.id}')">
                        <h3 class="font-bold text-lg text-gray-900 mb-2 leading-snug line-clamp-2 hover:text-indigo-600 transition">
                            ${job.title}
                        </h3>
                        
                        <p class="text-xs font-medium text-gray-500 mb-3 line-clamp-1"><i class="far fa-building mr-1"></i>${job.companies?.name || job.company}</p>
                        
                        <div class="flex flex-wrap gap-2 mb-4">
                            ${job.job_category ? `<span class="px-2 py-1 text-xs bg-indigo-50 text-indigo-700 rounded border border-indigo-100">${job.job_category}</span>` : ''}
                            ${job.is_remote ? `<span class="px-2 py-1 text-xs bg-emerald-50 text-emerald-700 rounded border border-emerald-100">ãƒªãƒ¢ãƒ¼ãƒˆå¯</span>` : ''}
                            ${job.tags && Array.isArray(job.tags) ? job.tags.slice(0, 2).map(tag => `<span class="px-2 py-1 text-xs bg-gray-50 text-gray-600 rounded border border-gray-200">${tag}</span>`).join('') : ''}
                        </div>

                        <div class="space-y-2 text-sm text-gray-600 mb-4 border-t border-gray-100 pt-3">
                            <div class="flex items-start gap-2">
                                <i class="fas fa-map-marker-alt mt-1 text-gray-400 w-4 text-center"></i>
                                <span class="line-clamp-1">${job.location || 'å‹¤å‹™åœ°æœªå®š'}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-yen-sign text-gray-400 w-4 text-center"></i>
                                <span>${formatSalary(job.salary_min)} - ${formatSalary(job.salary_max)}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-briefcase text-gray-400 w-4 text-center"></i>
                                <span>${job.employment_type || '-'}</span>
                            </div>
                        </div>

                        ${job.ai_score ? `
                        <div class="mb-4 bg-indigo-50 border-l-4 border-indigo-500 p-3 rounded-r">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[10px] font-bold bg-indigo-600 text-white px-1.5 py-0.5 rounded">AI SEARCH</span>
                                <span class="text-xs font-bold text-indigo-700">åˆè‡´ç‡: ${job.ai_score}%</span>
                            </div>
                            <p class="text-[11px] text-indigo-600 line-clamp-3 leading-relaxed">${job.ai_reason || ''}</p>
                        </div>
                        ` : ''}

                        ${job.welcome_requirements ? `
                        <div class="mb-2">
                            <span class="font-bold text-gray-700 block text-xs mb-1">ã€å°šå¯è¦ä»¶ã€‘</span>
                            <p class="text-xs text-gray-500 line-clamp-2">${job.welcome_requirements}</p>
                        </div>
                        ` : ''}
                    </div>

                    <div class="pt-4 mt-auto border-t border-gray-100 flex flex-col gap-2">
                        ${isAdminOrCoach ? `
                        <div class="flex gap-2 mb-1">
                             ${!isRecommended ? `
                            <button onclick="event.stopPropagation(); openRecommendJobModal('${job.id}')" 
                                class="flex-1 bg-amber-500 text-white py-1.5 rounded text-xs font-bold hover:bg-amber-600 transition">
                                <i class="fas fa-star mr-1"></i>ç´¹ä»‹
                            </button>
                            ` : ''}
                            ${!isApplied ? `
                            <button onclick="event.stopPropagation(); applyForJob('${job.id}', '${targetUserId || ''}')" 
                                class="flex-1 bg-indigo-600 text-white py-1.5 rounded text-xs font-bold hover:bg-indigo-700 transition">
                                <i class="fas fa-paper-plane mr-1"></i>ä»£ç†å¿œå‹Ÿ
                            </button>
                            ` : ''}
                        </div>
                        ` : ''}
                    
                        <button onclick="event.stopPropagation(); showJobDetailModal('${job.id}')" class="w-full bg-slate-700 text-white text-sm font-bold py-2.5 rounded-lg hover:bg-slate-800 transition shadow-sm hover:shadow">
                            è©³ç´°ã‚’è¦‹ã‚‹
                        </button>
                    </div>
                </div>
            `}).join('')

            container.html(html)
        }

        // ========================
        // Email Notification Utility
        // ========================
        async function sendEmail(type, to, data) {
            try {
                const { data: result, error } = await supabase.functions.invoke('send-email', {
                    body: { type, to, data }
                })

                if (error) throw error
                console.log('Email sent successfully:', result)
                return true
            } catch (error) {
                console.error('Failed to send email:', error)
                // ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’é˜»å®³ã—ãªã„ã‚ˆã†ã€ãƒ­ã‚°å‡ºåŠ›ã®ã¿ã§falseã‚’è¿”ã™
                return false
            }
        }

        window.applyForJob = async function (jobId, targetUserId = null) {
            const isProxy = !!targetUserId;
            const applicantId = targetUserId || currentUser.id;

            const confirmMsg = isProxy ? 'ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä»£ç†ã¨ã—ã¦æ±‚äººã«å¿œå‹Ÿã—ã¾ã™ã‹ï¼Ÿ' : 'ã“ã®æ±‚äººã«å¿œå‹Ÿã—ã¾ã™ã‹ï¼Ÿ';
            if (!confirm(confirmMsg)) return;

            showLoading()
            try {
                // å¿œå‹Ÿè€…æƒ…å ±ã‚’å–å¾—
                let applicant = currentUser;
                if (isProxy) {
                    const { data: user, error } = await supabase
                        .from('users')
                        .select('*')
                        .eq('id', applicantId)
                        .single();
                    if (error) throw error;
                    applicant = user;
                }

                const { data: application, error } = await supabase
                    .from('applications')
                    .insert({
                        organization_id: currentUser.organization_id,
                        user_id: applicantId,
                        job_id: jobId,
                        status: 'å¿œå‹Ÿå®Œäº†'
                    })
                    .select('*, jobs(title, company)')
                    .single()

                if (error) throw error

                // ãƒ­ã‚°è¨˜éŒ²
                await auditLog.applicationSubmitted(application.id, {
                    job_id: jobId,
                    applicant_id: applicantId,
                    is_proxy: isProxy
                });

                // é€šçŸ¥ä½œæˆå‡¦ç†
                try {
                    // 1. ç®¡ç†è€…ã‚’å–å¾—
                    const { data: admins } = await supabase
                        .from('users')
                        .select('id')
                        .eq('organization_id', currentUser.organization_id)
                        .in('role', ['org_admin', 'admin'])

                    // 2. æ‹…å½“ã‚³ãƒ¼ãƒã‚’å–å¾—
                    let coachId = applicant.coach_id

                    // é€šçŸ¥å¯¾è±¡è€…ã®ãƒªã‚¹ãƒˆä½œæˆï¼ˆé‡è¤‡æ’é™¤ï¼‰
                    const notifyUserIds = new Set(admins?.map(a => a.id) || [])
                    if (coachId) notifyUserIds.add(coachId)

                    const jobTitle = application.jobs.title
                    const companyName = application.jobs.company

                    // é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    const message = isProxy
                        ? `${currentUser.name} ã•ã‚“ãŒ ${applicant.name} ã•ã‚“ã®ä»£ç†ã§ã€Œ${companyName} / ${jobTitle}ã€ã«å¿œå‹Ÿã—ã¾ã—ãŸã€‚`
                        : `${applicant.name} ã•ã‚“ãŒã€Œ${companyName} / ${jobTitle}ã€ã«å¿œå‹Ÿã—ã¾ã—ãŸã€‚`;

                    // é€šçŸ¥ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆ
                    const notifications = Array.from(notifyUserIds).map(uid => ({
                        user_id: uid,
                        title: 'æ–°è¦å¿œå‹ŸãŒã‚ã‚Šã¾ã—ãŸ',
                        message: message,
                        read: false,
                        metadata: {
                            page: 'admin-applicants',
                            application_id: application.id,
                            user_id: applicantId
                        },
                        created_at: new Date().toISOString()
                    }))

                    if (notifications.length > 0) {
                        await supabase.from('notifications').insert(notifications)
                    }

                    // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ (å¿œå‹Ÿè€…ã¸)
                    await sendEmail('application_submitted', applicant.email, {
                        userName: applicant.name,
                        jobTitle: jobTitle,
                        companyName: companyName
                    })

                } catch (notifyError) {
                    console.error('Notification/Email error:', notifyError)
                    // é€šçŸ¥ã‚¨ãƒ©ãƒ¼ã¯ãƒ¡ã‚¤ãƒ³å‡¦ç†ã‚’æ­¢ã‚ãªã„
                }

                alert('å¿œå‹ŸãŒå®Œäº†ã—ã¾ã—ãŸï¼')
                loadDashboard() // çµ±è¨ˆæ›´æ–°
            } catch (error) {
                console.error('Application error:', error)
                if (error.code === '23505') { // Unique violation
                    alert('ã™ã§ã«ã“ã®æ±‚äººã«ã¯å¿œå‹Ÿæ¸ˆã¿ã§ã™')
                } else {
                    alert('å¿œå‹Ÿã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
                }
            } finally {
                hideLoading()
            }
        }

        // ========================
        // Applications History
        // ========================
        // Applications History
        // ========================
        let applicationsCache = [];
        let currentCandidateStatusFilter = 'all';

        window.setCandidateApplicationStatusFilter = function (status) {
            currentCandidateStatusFilter = status;

            // UIæ›´æ–°
            $('.candidate-status-filter').removeClass('active bg-indigo-600 text-white border-indigo-600').addClass('bg-white text-gray-600 border-gray-200 hover:bg-gray-50');
            $(`.candidate-status-filter[data-status="${status}"]`).addClass('active bg-indigo-600 text-white border-indigo-600').removeClass('bg-white text-gray-600 border-gray-200 hover:bg-gray-50');

            filterCandidateApplications();
        };

        window.filterCandidateApplications = function () {
            const searchText = $('#application-search-input').val().toLowerCase();

            let filtered = applicationsCache;

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            if (currentCandidateStatusFilter !== 'all') {
                const group = window.statusGroups ? window.statusGroups[currentCandidateStatusFilter] : null;
                if (group) {
                    filtered = filtered.filter(app => group.values.includes(app.status));
                } else {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                    filtered = filtered.filter(app => {
                        if (currentCandidateStatusFilter === 'applied') {
                            return app.status === 'å¿œå‹Ÿå®Œäº†' || !app.status;
                        } else if (currentCandidateStatusFilter === 'screening_docs') {
                            return ['æ›¸é¡é¸è€ƒä¸­', 'æ›¸é¡é¸è€ƒé€šé', 'pending', 'screening'].includes(app.status);
                        } else if (currentCandidateStatusFilter === 'screening_interviews') {
                            return ['ä¸€æ¬¡é¢æ¥äºˆå®š', 'ä¸€æ¬¡é¢æ¥å®Œäº†', 'äºŒæ¬¡é¢æ¥äºˆå®š', 'äºŒæ¬¡é¢æ¥å®Œäº†', 'æœ€çµ‚é¢æ¥äºˆå®š', 'æœ€çµ‚é¢æ¥å®Œäº†', 'interview'].includes(app.status);
                        } else if (currentCandidateStatusFilter === 'offered') {
                            return app.status === 'offered' || app.status === 'å†…å®š' || app.status === 'å†…å®šæ‰¿è«¾';
                        } else if (currentCandidateStatusFilter === 'closed') {
                            return ['rejected', 'withdrawn'].includes(app.status) || (app.status && app.status.startsWith('é¸è€ƒçµ‚äº†'));
                        }
                        return true;
                    });
                }
            }

            // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢
            if (searchText) {
                filtered = filtered.filter(app =>
                    (app.jobs && app.jobs.title && app.jobs.title.toLowerCase().includes(searchText)) ||
                    (app.jobs && app.jobs.company && app.jobs.company.toLowerCase().includes(searchText))
                );
            }

            renderApplications(filtered);
        };

        async function loadApplications() {
            if (!currentUser) return

            showLoading()
            try {
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚¹ã‚¿ã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ§‹ç¯‰
                await loadApplicationStatuses();

                let query = supabase
                    .from('applications')
                    .select('*, jobs(*), users!applications_user_id_fkey(name), recommendation_text, resume_document_url, recommendation_letter_url')
                    .order('updated_at', { ascending: false })

                if (currentUser.role === 'super_admin' || currentUser.role === 'org_admin' || currentUser.role === 'admin') {
                    // ç®¡ç†è€…: çµ„ç¹”å†…ã®å…¨å¿œå‹Ÿ
                    query = query.eq('organization_id', currentUser.organization_id)
                } else if (currentUser.role === 'coach') {
                    // ã‚³ãƒ¼ãƒ: æ‹…å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¿œå‹Ÿ
                    // ã¾ãšæ‹…å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
                    const { data: assignedUsers } = await supabase
                        .from('users')
                        .select('id')
                        .eq('coach_id', currentUser.id)

                    const assignedUserIds = assignedUsers?.map(u => u.id) || []

                    if (assignedUserIds.length > 0) {
                        query = query.in('user_id', assignedUserIds)
                    } else {
                        // æ‹…å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ãªã„å ´åˆã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„
                        renderApplications([])
                        hideLoading()
                        return
                    }
                } else {
                    // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼: è‡ªèº«ã®å¿œå‹Ÿ
                    query = query.eq('user_id', currentUser.id)
                }

                const { data: applications, error } = await query
                if (error) throw error

                applicationsCache = applications || [];
                filterCandidateApplications();
            } catch (error) {
                console.error('Load applications error:', error)
                console.error('Error details:', JSON.stringify(error, null, 2))
                $('#applications-container').html(`<p class="text-red-500">å¿œå‹Ÿå±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message || JSON.stringify(error)}</p>`)
            } finally {
                hideLoading()
            }
        }

        function renderApplications(applications) {
            const container = $('#applications-container')
            container.empty()

            if (applications.length === 0) {
                container.html('<p class="text-gray-500 text-center py-8">ã¾ã å¿œå‹Ÿã—ã¦ã„ã¾ã›ã‚“</p>')
                return
            }

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨­å®šï¼ˆãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
            let statusConfig = {
                'pending': { label: 'æ›¸é¡é¸è€ƒä¸­', color: 'bg-yellow-100 text-yellow-800' },
                'screening': { label: 'æ›¸é¡é¸è€ƒä¸­', color: 'bg-yellow-100 text-yellow-800' },
                'interview': { label: 'é¢æ¥äºˆå®š', color: 'bg-blue-100 text-blue-800' },
                'offered': { label: 'å†…å®š', color: 'bg-green-100 text-green-800' },
                'rejected': { label: 'ä¸åˆæ ¼', color: 'bg-red-100 text-red-800' },
                'withdrawn': { label: 'è¾é€€', color: 'bg-gray-100 text-gray-800' },
                'applied': { label: 'å¿œå‹Ÿå®Œäº†', color: 'bg-indigo-100 text-indigo-800' },
                'å¿œå‹Ÿå®Œäº†': { label: 'å¿œå‹Ÿå®Œäº†', color: 'bg-indigo-100 text-indigo-800' }
            };

            // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ä¸Šæ›¸ã
            if (typeof applicationStatuses !== 'undefined' && applicationStatuses.length > 0) {
                applicationStatuses.forEach(s => {
                    statusConfig[s.value] = {
                        label: s.label,
                        color: s.metadata?.color || (s.value === 'å¿œå‹Ÿå®Œäº†' ? 'bg-indigo-100 text-indigo-800' : 'bg-yellow-50 text-yellow-700 border border-yellow-200')
                    };
                });
            }

            const html = applications.map(app => {
                const status = statusConfig[app.status] || statusConfig['pending']
                const appliedDate = new Date(app.updated_at).toLocaleDateString('ja-JP')

                return `
                    <div class="bg-white border border-gray-200 rounded-lg p-6 mb-4 hover:shadow-md transition">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <h3 class="text-xl font-bold text-gray-900">${app.jobs ? app.jobs.title : 'ä¸æ˜ãªæ±‚äºº'}</h3>
                                </div>
                                <p class="text-gray-600">${app.jobs ? app.jobs.company : '-'}</p>
                                ${app.jobs?.pdf_filename ? `
                                <div class="flex items-center gap-2 mt-1 text-xs text-gray-500 bg-gray-50 px-2 py-1 rounded w-fit">
                                    <i class="fas fa-file-pdf text-red-500"></i>
                                    <span class="truncate max-w-[200px]" title="${app.jobs.pdf_filename}">${app.jobs.pdf_filename}</span>
                                </div>
                                ` : ''}
                                ${app.jobs?.url ? `
                                <div class="flex items-center gap-2 mt-1 text-xs">
                                    <i class="fas fa-link text-indigo-400"></i>
                                    <a href="${app.jobs.url}" target="_blank" class="text-indigo-600 hover:underline truncate max-w-[300px]">${app.jobs.url}</a>
                                </div>
                                ` : ''}
                                ${app.users ? `<p class="text-sm text-indigo-600 mt-1"><i class="fas fa-user mr-1"></i>å¿œå‹Ÿè€…: ${app.users.name}</p>` : ''}
                            </div>
                            <div class="flex flex-col items-end gap-2">
                                <span class="px-3 py-1 rounded-full text-sm font-medium ${status.color}">
                                    ${status.label}
                                </span>
                                ${['org_admin', 'admin', 'super_admin', 'coach', 'ca', 'ra'].includes(currentUser.role) ? `
                                <button onclick="openRecommendationModal('${app.id}')" class="text-sm font-medium flex items-center ${app.recommendation_text ? 'text-green-600 hover:text-green-800' : 'text-indigo-600 hover:text-indigo-800'}">
                                    <i class="fas ${app.recommendation_text ? 'fa-check-circle' : 'fa-file-alt'} mr-1"></i>
                                    ${app.recommendation_text ? 'æ¨è–¦æ–‡ç·¨é›†' : 'æ¨è–¦æ–‡ä½œæˆ'}
                                </button>
                                <button onclick="generateDocument('${app.id}', 'resume')" class="text-sm font-medium flex items-center ${app.resume_document_url ? 'text-blue-600 hover:text-blue-800' : 'text-blue-600 hover:text-blue-800'}">
                                    <i class="fas ${app.resume_document_url ? 'fa-download' : 'fa-file-word'} mr-1"></i>
                                    ${app.resume_document_url ? 'è·å‹™çµŒæ­´æ›¸DL' : 'è·å‹™çµŒæ­´æ›¸ä½œæˆ'}
                                </button>
                                <button onclick="generateDocument('${app.id}', 'recommendation')" class="text-sm font-medium flex items-center ${app.recommendation_letter_url ? 'text-purple-600 hover:text-purple-800' : 'text-purple-600 hover:text-purple-800'}">
                                    <i class="fas ${app.recommendation_letter_url ? 'fa-download' : 'fa-file-word'} mr-1"></i>
                                    ${app.recommendation_letter_url ? 'æ¨è–¦çŠ¶DL' : 'æ¨è–¦çŠ¶ä½œæˆ'}
                                </button>
                                <button onclick="openProgressModal('${app.id}')"
                                    class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition flex items-center gap-2">
                                    <i class="fas fa-tasks"></i>
                                    <span>é€²æ—ç®¡ç†</span>
                                </button>
                                ` : ''}
                            </div>
                        </div>

                        <div class="flex items-center gap-4 text-sm text-gray-600 mb-3">
                            <span><i class="fas fa-map-marker-alt mr-1"></i> ${app.jobs?.location || 'å‹¤å‹™åœ°ä¸æ˜'}</span>
                            <span><i class="fas fa-briefcase mr-1"></i> ${app.jobs?.employment_type || '-'}</span>
                            <span><i class="fas fa-calendar mr-1"></i> å¿œå‹Ÿæ—¥: ${appliedDate}</span>
                        </div>

                        ${app.jobs?.salary_max ? `
                        <div class="text-sm text-gray-700 mb-3">
                            <i class="fas fa-yen-sign mr-1"></i>
                            æƒ³å®šå¹´å: ${(app.jobs.salary_min / 10000).toLocaleString()}ä¸‡ - ${(app.jobs.salary_max / 10000).toLocaleString()}ä¸‡å††
                        </div>
                        ` : ''}

                        <p class="text-gray-600 text-sm line-clamp-2">${app.jobs?.description || 'æ±‚äººæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'}</p>
                    </div>
                `
            }).join('')

            container.html(html)
        }

        // ========================
        // ========================
        // Progress Management
        // ========================
        let currentApplicationData = null;
        let applicationStatuses = [];

        function getSelectionStatusLabel(value) {
            if (!value) return '-';
            // ã™ã§ã«æ—¥æœ¬èªï¼ˆãƒ©ãƒ™ãƒ«ï¼‰ã®å ´åˆã¯ãã®ã¾ã¾è¿”ã™
            if (/^[^\x00-\x7F]+$/.test(value)) return value;

            // ãƒã‚¹ã‚¿ã‹ã‚‰æ¤œç´¢
            if (applicationStatuses && applicationStatuses.length > 0) {
                const status = applicationStatuses.find(s => s.value === value);
                if (status) return status.label;
            }

            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            const labels = {
                'pending': 'æ›¸é¡é¸è€ƒä¸­',
                'screening': 'æ›¸é¡é¸è€ƒä¸­',
                'interview': 'é¢æ¥äºˆå®š',
                'offered': 'å†…å®š',
                'rejected': 'ä¸åˆæ ¼',
                'withdrawn': 'è¾é€€',
                'applied': 'å¿œå‹Ÿå®Œäº†',
                'å¿œå‹Ÿå®Œäº†': 'å¿œå‹Ÿå®Œäº†'
            };
            return labels[value] || value;
        }

        window.openProgressModal = async function (applicationId) {
            showLoading();
            try {
                // å¿œå‹Ÿæƒ…å ±ã‚’å–å¾— (emailã‚‚å–å¾—)
                const { data: application, error: appError } = await supabase
                    .from('applications')
                    .select('*, jobs(title, company), users!applications_user_id_fkey(name, email)')
                    .eq('id', applicationId)
                    .single();

                if (appError) throw appError;

                currentApplicationData = application;
                $('#progress-application-id').val(applicationId);
                $('#progress-job-title').text(application.jobs.title);
                $('#progress-company-name').text(application.jobs.company);
                $('#progress-user-name').text(`å¿œå‹Ÿè€…: ${application.users.name}`);
                $('#progress-current-status').data('code', application.status || 'applied').val(getSelectionStatusLabel(application.status || 'applied'));

                // ãƒ¨ãƒŸæƒ…å ±ã®ã‚»ãƒƒãƒˆ
                $('#progress-expected-revenue').val(application.expected_revenue || '');
                $('#progress-probability-rate').val(application.probability_rate || '0');
                $('#progress-expected-start-date').val(application.expected_start_date || '');
                $('#progress-yomi-notes').val(application.yomi_notes || '');

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
                await loadApplicationStatuses();

                // é€²æ—å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
                await loadProgressHistory(applicationId);

                $('#progress-modal').removeClass('hidden');
            } catch (error) {
                console.error('Open progress modal error:', error);
                alert('é€²æ—æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            } finally {
                hideLoading();
            }
        };

        window.closeProgressModal = function () {
            $('#progress-modal').addClass('hidden');
            $('#progress-update-form')[0].reset();
            currentApplicationData = null;
        };

        async function loadApplicationStatuses() {
            try {
                const { data: masters, error } = await supabase
                    .from('master_data')
                    .select('*')
                    .eq('type', 'application_status')
                    .eq('is_active', true)
                    .order('sort_order');

                if (error) throw error;

                const validMasters = masters.filter(m =>
                    m.organization_id === null || m.organization_id === currentUser.organization_id
                );

                applicationStatuses = validMasters;

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ç”¨ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹
                const select = $('#progress-new-status');
                if (select.length) {
                    select.html('<option value="">é¸æŠã—ã¦ãã ã•ã„</option>');
                    validMasters.forEach(m => {
                        select.append(`<option value="${m.value}">${m.label}</option>`);
                    });
                }

                // ä¸€æ‹¬æ›´æ–°ç”¨ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹
                const bulkSelect = $('#bulk-new-status');
                if (bulkSelect.length) {
                    bulkSelect.empty();
                    validMasters.forEach(m => {
                        bulkSelect.append($('<option>').val(m.value).text(m.label));
                    });
                }

                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã®å‹•çš„ç”Ÿæˆ
                renderStatusFilters(validMasters);

            } catch (error) {
                console.error('Load application statuses error:', error);
            }
        }

        function renderStatusFilters(statuses) {
            // ã‚°ãƒ«ãƒ¼ãƒ—åŒ– (metadata.group ãŒã‚ã‚‹ã‚‚ã®ã‚’å„ªå…ˆ)
            const groups = {};
            statuses.forEach(s => {
                const group = s.metadata?.group;
                const groupLabel = s.metadata?.group_label;
                if (group && groupLabel) {
                    if (!groups[group]) {
                        groups[group] = { label: groupLabel, values: [], sort_order: s.sort_order };
                    }
                    groups[group].values.push(s.value);
                    // ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®æœ€å°ã®sort_orderã‚’ã‚°ãƒ«ãƒ¼ãƒ—ã®ä¸¦ã³é †ã¨ã™ã‚‹
                    if (s.sort_order < groups[group].sort_order) {
                        groups[group].sort_order = s.sort_order;
                    }
                }
            });

            // ã‚°ãƒ«ãƒ¼ãƒ—ã‚’sort_orderé †ã«ä¸¦ã³æ›¿ãˆ
            const sortedGroupKeys = Object.keys(groups).sort((a, b) => groups[a].sort_order - groups[b].sort_order);

            // 1. ç®¡ç†è€…ç”¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            const adminContainer = $('#admin-applicant-status-filters');
            if (adminContainer.length) {
                let html = '';
                sortedGroupKeys.forEach(key => {
                    const isActive = adminApplicantStatusFilter === key;
                    html += `<button onclick="setAdminApplicantStatusFilter('${key}')" 
                        class="status-filter-btn ${isActive ? 'active bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-50'} px-4 py-2 rounded-lg text-sm font-bold border transition-all" 
                        data-status="${key}">${groups[key].label}</button>`;
                });
                html += `<button onclick="setAdminApplicantStatusFilter('all')" 
                    class="status-filter-btn ${adminApplicantStatusFilter === 'all' ? 'active bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-50'} px-4 py-2 rounded-lg text-sm font-bold border transition-all" 
                    data-status="all">ã™ã¹ã¦</button>`;
                adminContainer.html(html);
            }

            // 2. å€™è£œè€…ç”¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            const candidateContainer = $('.candidate-status-filter').parent();
            if (candidateContainer.length) {
                let html = `<button onclick="setCandidateApplicationStatusFilter('all')" 
                    class="candidate-status-filter ${currentCandidateStatusFilter === 'all' ? 'active bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'} whitespace-nowrap px-4 py-2 rounded-lg text-sm font-bold border transition-all" 
                    data-status="all">ã™ã¹ã¦</button>`;

                sortedGroupKeys.forEach(key => {
                    const isActive = currentCandidateStatusFilter === key;
                    html += `<button onclick="setCandidateApplicationStatusFilter('${key}')" 
                        class="candidate-status-filter ${isActive ? 'active bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'} whitespace-nowrap px-4 py-2 rounded-lg text-sm font-bold border transition-all" 
                        data-status="${key}">${groups[key].label}</button>`;
                });
                candidateContainer.html(html);
            }

            window.statusGroups = groups;
        }

        async function loadProgressHistory(applicationId) {
            try {
                const { data: history, error } = await supabase
                    .from('progress_history')
                    .select('*')
                    .eq('application_id', applicationId)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                renderProgressTimeline(history || []);
            } catch (error) {
                console.error('Load progress history error:', error);
                $('#progress-timeline').html('<p class="text-red-500 text-sm">å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>');
            }
        }

        function renderProgressTimeline(history) {
            const container = $('#progress-timeline');
            container.empty();

            if (history.length === 0) {
                container.html('<p class="text-gray-500 text-sm">ã¾ã é€²æ—å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>');
                return;
            }

            const html = history.map((item, index) => {
                const date = new Date(item.created_at).toLocaleString('ja-JP');
                const isLast = index === history.length - 1;

                return `
                    <div class="flex gap-4">
                        <div class="flex flex-col items-center">
                            <div class="w-3 h-3 rounded-full ${isLast ? 'bg-gray-300' : 'bg-indigo-600'}"></div>
                            ${!isLast ? '<div class="w-0.5 h-full bg-gray-200 mt-1"></div>' : ''}
                        </div>
                        <div class="flex-1 pb-6">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-semibold text-gray-900">${getSelectionStatusLabel(item.old_status) || 'æ–°è¦'} â†’ ${getSelectionStatusLabel(item.new_status)}</span>
                                <span class="text-xs text-gray-500">${date}</span>
                            </div>
                            ${item.changed_by_name ? `<p class="text-sm text-gray-600 mb-1">å¤‰æ›´è€…: ${item.changed_by_name}</p>` : ''}
                            ${item.notes ? `<p class="text-sm text-gray-700 bg-gray-50 p-2 rounded">${item.notes}</p>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            container.html(html);
        }

        $('#progress-update-form').on('submit', async function (e) {
            e.preventDefault();
            showLoading();

            const applicationId = $('#progress-application-id').val();
            const oldStatus = $('#progress-current-status').data('code');
            const newStatus = $('#progress-new-status').val();
            const notes = $('#progress-notes').val();

            try {
                // 1. å¿œå‹Ÿã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
                const { error: updateError } = await supabase
                    .from('applications')
                    .update({
                        status: newStatus,
                        expected_revenue: $('#progress-expected-revenue').val() ? parseInt($('#progress-expected-revenue').val()) : null,
                        probability_rate: parseInt($('#progress-probability-rate').val()) || 0,
                        expected_start_date: $('#progress-expected-start-date').val() || null,
                        yomi_notes: $('#progress-yomi-notes').val() || null,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', applicationId);

                if (updateError) throw updateError;

                // 2. é€²æ—å±¥æ­´ã‚’è¨˜éŒ²
                const { error: historyError } = await supabase
                    .from('progress_history')
                    .insert({
                        organization_id: currentUser.organization_id,
                        application_id: applicationId,
                        user_id: currentApplicationData.user_id,
                        old_status: oldStatus,
                        new_status: newStatus,
                        notes: notes,
                        changed_by: currentUser.id,
                        changed_by_name: currentUser.name
                    });

                if (historyError) throw historyError;

                // 3. é€šçŸ¥ä½œæˆ (æ±‚è·è€…ã¸)
                try {
                    const statusLabel = getSelectionStatusLabel(newStatus);
                    await supabase.from('notifications').insert({
                        user_id: currentApplicationData.user_id,
                        title: 'é¸è€ƒã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ',
                        message: `ã€Œ${currentApplicationData.jobs.company} / ${currentApplicationData.jobs.title}ã€ã®é¸è€ƒçŠ¶æ³ãŒã€Œ${statusLabel}ã€ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚`,
                        read: false,
                        metadata: {
                            page: 'applications',
                            application_id: applicationId
                        },
                        created_at: new Date().toISOString()
                    });
                } catch (notifyError) {
                    console.error('Candidate notification error:', notifyError);
                }

                // 4. ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´æ™‚)
                if (currentApplicationData && currentApplicationData.users && currentApplicationData.users.email) {
                    await sendEmail('status_changed', currentApplicationData.users.email, {
                        userName: currentApplicationData.users.name,
                        jobTitle: currentApplicationData.jobs.title,
                        companyName: currentApplicationData.jobs.company,
                        oldStatus: oldStatus,
                        newStatus: newStatus
                    });
                }

                alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸ');

                // 4. ç”»é¢ã‚’æ›´æ–°
                $('#progress-current-status').data('code', newStatus).val(getSelectionStatusLabel(newStatus));
                $('#progress-notes').val('');
                $('#progress-new-status').val('');

                await loadProgressHistory(applicationId);
                loadApplications(); // å¿œå‹Ÿä¸€è¦§ã‚‚æ›´æ–°

            } catch (error) {
                console.error('Update progress error:', error);
                alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                hideLoading();
            }
        });

        // ========================
        // AI Recommendations
        // ========================
        // ========================
        // Recommendation Pagination Variables
        // ========================
        const RECOMMENDATIONS_PER_PAGE = 20;
        let currentRecommendationPage = 1;
        let totalRecommendationPages = 1;
        let allRecommendationsCache = []; // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã®å…¨æ¨è–¦

        async function loadRecommendations(page = 1) {
            // window.currentUserã‚’ä½¿ç”¨ï¼ˆã‚¹ã‚³ãƒ¼ãƒ—å•é¡Œã‚’å›é¿ï¼‰
            const currentUser = window.currentUser;

            if (!currentUser) {
                console.error('currentUser is null in loadRecommendations');
                hideLoading();
                alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                showPage('login-page');
                return;
            }

            showLoading()
            try {
                // CAãƒ­ãƒ¼ãƒ«ã‚‚ç®¡ç†è€…/ã‚³ãƒ¼ãƒæ ã«è¿½åŠ 
                const isAdminOrCoach = ['org_admin', 'admin', 'coach', 'ca', 'super_admin'].includes(currentUser.role);

                // 1. æ¨è–¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                let query = supabase
                    .from('recommendations')
                    .select('*, jobs(*), users!recommendations_user_id_fkey(id, name, email)')
                    .order('score', { ascending: false });

                if (isAdminOrCoach) {
                    // ç®¡ç†è€…/ã‚³ãƒ¼ãƒã®å ´åˆã¯çµ„ç¹”å†…ã®å…¨æ¨è–¦ã‚’å–å¾—
                    query = query.eq('organization_id', currentUser.organization_id);
                } else {
                    // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®æ¨è–¦ã®ã¿
                    query = query.eq('user_id', currentUser.id);
                }

                let { data: recs, error } = await query;
                if (error) throw error;

                console.log('Loaded recommendations:', recs); // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°

                // 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ï¼ˆç®¡ç†è€…/ã‚³ãƒ¼ãƒã®å ´åˆï¼‰
                let users = [];
                let allCandidates = []; // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ç”¨ã®å…¨å€™è£œè€…ãƒªã‚¹ãƒˆ

                if (isAdminOrCoach) {
                    // 2-1. æ¨è–¦ãƒ‡ãƒ¼ã‚¿ã«é–¢é€£ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
                    if (recs.length > 0) {
                        const userIds = [...new Set(recs.map(r => r.user_id))];
                        const { data: recUsers, error: usersError } = await supabase
                            .from('users')
                            .select('id, name, email, coach_id')
                            .in('id', userIds);

                        if (!usersError && recUsers) {
                            users = recUsers;
                        }
                    }

                    // 2-2. çµ„ç¹”å†…ã®å…¨æ±‚è·è€…ã‚’å–å¾—ï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ç”¨ï¼‰
                    // ã‚³ãƒ¼ãƒ/CAã®å ´åˆã¯æ‹…å½“æ±‚è·è€…ã®ã¿ã€ãã‚Œä»¥å¤–ã¯çµ„ç¹”å†…å…¨å“¡
                    let candidateQuery = supabase
                        .from('users')
                        .select('id, name, email, coach_id')
                        .eq('organization_id', currentUser.organization_id)
                        .eq('role', 'candidate');

                    if (currentUser.role === 'coach' || currentUser.role === 'ca') {
                        candidateQuery = candidateQuery.eq('coach_id', currentUser.id);
                    }
                    // æ´»å‹•çµ‚äº†ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é™¤å¤–
                    candidateQuery = candidateQuery.neq('management_status', 'inactive');

                    const { data: candidates, error: candidateError } = await candidateQuery;
                    if (!candidateError && candidates) {
                        allCandidates = candidates;
                    }

                    // ã‚³ãƒ¼ãƒã¾ãŸã¯CAã®å ´åˆã¯æ¨è–¦ãƒ‡ãƒ¼ã‚¿ã‚‚æ‹…å½“æ±‚è·è€…ã®ã¿ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                    if (currentUser.role === 'coach' || currentUser.role === 'ca') {
                        const assignedUserIds = allCandidates.map(u => u.id);
                        // usersãƒªã‚¹ãƒˆã‚‚ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                        users = users.filter(u => assignedUserIds.includes(u.id));
                        // æ¨è–¦ãƒ‡ãƒ¼ã‚¿ã‚‚ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                        // æ³¨æ„: recsã¯constã§ã¯ãªã„ãŒã€å†ä»£å…¥ã™ã‚‹ãŸã‚ã«letã§å®£è¨€ã—ç›´ã™ã‹ã€ã“ã“ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ãŸæ–°ã—ã„é…åˆ—ã‚’ä½¿ã†
                        // ã“ã“ã§ã¯recsã®å†…å®¹ã‚’ç›´æ¥æ›¸ãæ›ãˆã‚‹ã“ã¨ã¯ã§ããªã„ã®ã§ã€renderã«æ¸¡ã™éš›ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¸ˆã¿ã®ã‚‚ã®ã‚’æ¸¡ã™
                    }

                    // æ¨è–¦ãƒ‡ãƒ¼ã‚¿ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ãƒãƒ¼ã‚¸
                    recs.forEach(rec => {
                        rec.users = users.find(u => u.id === rec.user_id) || allCandidates.find(u => u.id === rec.user_id);
                    });
                }

                // ã‚³ãƒ¼ãƒ/CAã®å ´åˆã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°é©ç”¨
                let finalRecs = recs;
                if (currentUser.role === 'coach' || currentUser.role === 'ca') {
                    const assignedUserIds = allCandidates.map(u => u.id);
                    finalRecs = recs.filter(r => assignedUserIds.includes(r.user_id));
                }

                // å¿œå‹Ÿæ¸ˆã¿æ±‚äººã‚’å–å¾—
                let appliedJobIds = new Set();

                if (isAdminOrCoach) {
                    // ç®¡ç†è€…/ã‚³ãƒ¼ãƒã®å ´åˆ: å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¿œå‹Ÿæ¸ˆã¿æ±‚äººã‚’å–å¾—
                    try {
                        const { data: applications } = await supabase
                            .from('applications')
                            .select('job_id, user_id')
                            .eq('organization_id', currentUser.organization_id);

                        if (applications) {
                            // å…¨ã¦ã®å¿œå‹Ÿæ¸ˆã¿æ±‚äººIDã‚’Setã«æ ¼ç´
                            appliedJobIds = new Set(applications.map(a => a.job_id));
                        }
                    } catch (error) {
                        console.error('Failed to load applications:', error);
                    }
                } else {
                    // æ±‚è·è€…ã®å ´åˆ: è‡ªåˆ†ã®å¿œå‹Ÿæ¸ˆã¿æ±‚äººã®ã¿å–å¾—
                    try {
                        const { data: applications } = await supabase
                            .from('applications')
                            .select('job_id')
                            .eq('user_id', currentUser.id);

                        if (applications) {
                            appliedJobIds = new Set(applications.map(a => a.job_id));
                        }
                    } catch (error) {
                        console.error('Failed to load applications:', error);
                    }
                }

                renderRecommendations(finalRecs, isAdminOrCoach, allCandidates, appliedJobIds);

            } catch (error) {
                console.error('Load recommendations error:', error)
                $('#recommendations-container').html('<p class="text-red-500">æ¨è–¦ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>')
            } finally {
                hideLoading()
            }
        }

        // ç¾åœ¨ã®ã‚¿ãƒ–çŠ¶æ…‹ã‚’ä¿æŒ
        let currentRecommendationTab = 'matches';
        let allRecommendations = [];
        let isAdminOrCoachView = false;
        let allCandidatesList = []; // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ç”¨
        let currentSelectedUserId = ''; // é¸æŠä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
        let appliedJobIdsCache = new Set(); // å¿œå‹Ÿæ¸ˆã¿æ±‚äººID

        let currentSortOption = 'date-desc'; // ã‚½ãƒ¼ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³åˆæœŸå€¤ï¼ˆè¿½åŠ æ—¥é †ï¼‰

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
        window.switchRecommendationTab = function (tab) {
            currentRecommendationTab = tab;
            currentRecommendationPage = 1; // ãƒšãƒ¼ã‚¸ç•ªå·ã‚’ãƒªã‚»ãƒƒãƒˆ

            // ã‚¿ãƒ–ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
            $('.rec-tab').removeClass('border-indigo-600 text-indigo-600').addClass('border-transparent text-gray-500');
            $(`#rec-tab-${tab}`).removeClass('border-transparent text-gray-500').addClass('border-indigo-600 text-indigo-600');

            // æ¨è–¦çµæœã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            renderRecommendations(allRecommendations, isAdminOrCoachView, allCandidatesList, appliedJobIdsCache);
        }

        // ã‚½ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆé–¢æ•°
        window.sortRecommendations = function (option) {
            currentSortOption = option;
            currentRecommendationPage = 1; // ãƒšãƒ¼ã‚¸ç•ªå·ã‚’ãƒªã‚»ãƒƒãƒˆ
            renderRecommendations(allRecommendations, isAdminOrCoachView, allCandidatesList, appliedJobIdsCache);
        }

        window.renderRecommendations = function (recs, isAdminOrCoach, candidates, appliedJobIds) {
            // å¼•æ•°çœç•¥æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            if (recs === undefined) recs = allRecommendations;
            if (isAdminOrCoach === undefined) isAdminOrCoach = isAdminOrCoachView;
            if (candidates === undefined) candidates = allCandidatesList;
            if (appliedJobIds === undefined) appliedJobIds = appliedJobIdsCache;

            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
            allRecommendations = recs;
            isAdminOrCoachView = isAdminOrCoach;
            allCandidatesList = candidates;
            appliedJobIdsCache = appliedJobIds;

            const container = $('#recommendations-container');

            // è¦‹é€ã‚Šæ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
            const dismissedKey = (window.currentUser ? `dismissed_recs_${window.currentUser.id}` : 'dismissed_recs_temp');
            const dismissed = new Set(JSON.parse(localStorage.getItem(dismissedKey) || '[]'));

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let displayRecs = recs;
            if (currentSelectedUserId) {
                displayRecs = recs.filter(r => r.user_id === currentSelectedUserId);
            }

            // ã‚¿ãƒ–ã«å¿œã˜ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let filteredRecs = displayRecs.filter(rec => {
                const isDismissed = dismissed.has(rec.job_id);
                if (currentRecommendationTab === 'matches') {
                    // ææ¡ˆã‚¿ãƒ–: ã‚¹ã‚³ã‚¢50%ä»¥ä¸Š ã‹ã¤ è¦‹é€ã‚Šã§ãªã„
                    return rec.score >= 50 && !isDismissed;
                } else {
                    // ã‚¢ãƒ³ãƒãƒƒãƒã‚¿ãƒ–: ã‚¹ã‚³ã‚¢49%ä»¥ä¸‹ ã¾ãŸã¯ è¦‹é€ã‚Šæ¸ˆã¿
                    return rec.score < 50 || isDismissed;
                }
            });

            // ã‚½ãƒ¼ãƒˆå‡¦ç†

            filteredRecs.sort((a, b) => {
                // è¦‹é€ã‚Šæ¸ˆã¿ã‚’å¾Œã‚ã¸
                const aDis = dismissed.has(a.job_id) ? 1 : 0;
                const bDis = dismissed.has(b.job_id) ? 1 : 0;
                if (aDis !== bDis) return aDis - bDis;

                const [key, order] = currentSortOption.split('-');
                let valA, valB;

                if (key === 'score') {
                    valA = a.score;
                    valB = b.score;
                } else if (key === 'date') {
                    valA = new Date(a.created_at).getTime();
                    valB = new Date(b.created_at).getTime();
                }

                if (order === 'asc') {
                    return valA - valB;
                } else {
                    return valB - valA;
                }
            });

            // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†
            allRecommendationsCache = filteredRecs;
            const totalCount = filteredRecs.length;
            totalRecommendationPages = Math.ceil(totalCount / RECOMMENDATIONS_PER_PAGE);

            const from = (currentRecommendationPage - 1) * RECOMMENDATIONS_PER_PAGE;
            const to = from + RECOMMENDATIONS_PER_PAGE;
            const paginatedRecs = filteredRecs.slice(from, to);

            console.log(`Loaded recommendation page ${currentRecommendationPage}/${totalRecommendationPages}, showing ${paginatedRecs.length} recommendations (total: ${totalCount})`);

            // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ ï¼† ã‚½ãƒ¼ãƒˆï¼‰ã®æ§‹ç¯‰
            let controlsHtml = '<div class="flex flex-wrap items-center justify-between mb-6 gap-4">';

            // å·¦å´: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ (ç®¡ç†è€…ã®ã¿)
            if (isAdminOrCoach) {
                // candidatesãƒªã‚¹ãƒˆãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°æ¨è–¦ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æŠ½å‡ºï¼ˆå¾Œæ–¹äº’æ›ï¼‰
                const userList = candidates.length > 0 ? candidates : [...new Map(recs.map(r => [r.users?.id, r.users])).values()].filter(u => u);

                controlsHtml += `
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-medium text-gray-700 whitespace-nowrap">æ±‚è·è€…:</label>
                        <div class="w-64">
                            <select id="rec-user-filter" onchange="filterRecommendations(this.value)" class="select2 w-full">
                                <option value="">å…¨å“¡</option>
                                ${userList.map(u => `<option value="${u.id}" ${u.id === currentSelectedUserId ? 'selected' : ''}>${u.name} (${u.email || 'ãƒ¡ãƒ¼ãƒ«ãªã—'})</option>`).join('')}
                            </select>
                        </div>
                    </div>
                `;
            } else {
                controlsHtml += '<div></div>'; // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ç”¨ã®ã‚¹ãƒšãƒ¼ã‚µãƒ¼
            }

            // å³å´: ã‚½ãƒ¼ãƒˆï¼ˆå†å®Ÿè¡Œãƒœã‚¿ãƒ³ã¯å‰Šé™¤ï¼‰
            controlsHtml += `
                <div class="flex items-center gap-2 ml-auto">
                    ${isAdminOrCoach ? `
                    <button onclick="reRunSelectedRecommendations()" class="bg-white text-indigo-600 border border-indigo-200 px-3 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-indigo-50 transition flex items-center gap-2 whitespace-nowrap">
                        <i class="fas fa-sync-alt"></i> å†åˆ¤å®š
                    </button>
                    
                    <button onclick="openRecommendationMessageModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-indigo-700 transition flex items-center gap-2 whitespace-nowrap">
                        <i class="fas fa-envelope"></i> ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ
                    </button>
                    ` : ''}

                    <div class="flex items-center gap-2 ml-2 pl-4 border-l">
                        <label class="text-sm font-medium text-gray-700 whitespace-nowrap"><i class="fas fa-sort mr-1"></i></label>
                        <select onchange="sortRecommendations(this.value)" class="px-3 py-2 border rounded-lg text-sm cursor-pointer hover:bg-gray-50 border-gray-200">
                            <option value="score-desc" ${currentSortOption === 'score-desc' ? 'selected' : ''}>ãƒãƒƒãƒåº¦é †</option>
                            <option value="date-desc" ${currentSortOption === 'date-desc' ? 'selected' : ''}>æ–°ç€é †</option>
                            <option value="date-asc" ${currentSortOption === 'date-asc' ? 'selected' : ''}>å¤ã„é †</option>
                        </select>
                    </div>
                </div>
            `;
            controlsHtml += '</div>';

            // ä»¶æ•°è¡¨ç¤ºã‚’è¿½åŠ 
            if (totalCount > 0) {
                controlsHtml += `<div class="mb-4 text-sm text-gray-600">
                    æ¤œç´¢çµæœ: ${totalCount}ä»¶ (${currentRecommendationPage}ãƒšãƒ¼ã‚¸ç›®ã‚’è¡¨ç¤ºä¸­)
                </div>`;
            }

            container.empty();

            if (paginatedRecs.length === 0 && totalCount === 0) {
                const tabLabel = currentRecommendationTab === 'matches' ? 'æ¨è–¦' : 'ã‚¢ãƒ³ãƒãƒƒãƒ';
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ãŒãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¨ã€æœ¬å½“ã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¤‰ãˆã‚‹
                let message = `${tabLabel}ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“`;
                let subMessage = isAdminOrCoach ? 'æ±‚äººæ¤œç´¢ç”»é¢ã‹ã‚‰å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦AIæ¨è–¦ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚' : 'ã‚ãªãŸã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã«åŸºã¥ã„ã¦ã€æœ€é©ãªæ±‚äººã‚’AIãŒåˆ†æã—ã¾ã™ã€‚';

                if (currentSelectedUserId) {
                    const selectedUser = candidates.find(u => u.id === currentSelectedUserId);
                    if (selectedUser) {
                        message = `${selectedUser.name} ã•ã‚“ã®${tabLabel}ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“`;
                        subMessage = 'æ±‚äººæ¤œç´¢ç”»é¢ã‹ã‚‰ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦AIæ¨è–¦ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚';
                    }
                }

                container.html(controlsHtml + `
                    <div class="text-center py-12">
                        <div class="mb-4">
                            <i class="fas fa-robot text-6xl text-indigo-200"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">${message}</h3>
                        <p class="text-gray-600 mb-6">${subMessage}</p>
                        ${!isAdminOrCoach ? `
                        <button onclick="generateAIRecommendations()" 
                            class="bg-indigo-600 text-white px-8 py-3 rounded-lg hover:bg-indigo-700 transition font-bold shadow-lg">
                            <i class="fas fa-magic mr-2"></i>AIåˆ†æã‚’é–‹å§‹ã™ã‚‹
                        </button>
                        ` : ''}
                    </div>
                `)
                return
            }

            const html = controlsHtml + `
                <div id="recommendations-list">
            ` + paginatedRecs.map(rec => {
                const matchColor = rec.score >= 50 ? 'bg-indigo-600' : 'bg-gray-500';
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒãªã„å ´åˆã®ã‚¬ãƒ¼ãƒ‰
                const userName = rec.users ? rec.users.name : 'ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼';
                const userEmail = rec.users ? rec.users.email : '';
                const isApplied = appliedJobIds.has(rec.job_id);

                // è¦‹é€ã‚Šãƒã‚§ãƒƒã‚¯
                const isDismissed = dismissed.has(rec.job_id);
                const cardStyle = isDismissed ? 'bg-gray-100 opacity-60' : 'bg-white border-gray-200 hover:shadow-md';

                return `
                <div class="${cardStyle} border rounded-lg p-6 transition mb-4 relative overflow-hidden group cursor-pointer rec-card" 
                     data-user-id="${rec.user_id}" 
                     data-job-id="${rec.job_id}"
                     onclick="showJobDetailModal('${rec.job_id}')">
                    ${isAdminOrCoach ? `
                    <div class="absolute top-0 left-0 p-3 z-20" onclick="event.stopPropagation()">
                        <div class="bg-white rounded-md shadow-sm border border-gray-200 p-1 flex items-center justify-center">
                            <input type="checkbox" class="w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 rec-checkbox cursor-pointer" 
                                   value="${rec.id}" data-job-id="${rec.job_id}" data-user-id="${rec.user_id}">
                        </div>
                    </div>
                    ` : ''}
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow cursor-pointer relative" onclick="window.customShowJobDetailModal('${rec.job_id}')">
                    <div class="flex flex-col md:flex-row gap-6">
                        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ (å·¦å´) -->
                        <div class="flex-1">
                            ${isAdminOrCoach ? `
                            <div class="flex items-center gap-2 mb-3">
                                <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-bold whitespace-nowrap">
                                    ${rec.users.name || 'æ±‚è·è€…'} æ§˜
                                </span>
                                ${isApplied ? `<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold"><i class="fas fa-check-circle mr-1"></i>å¿œå‹Ÿæ¸ˆã¿</span>` : ''}
                                ${isDismissed ? `<span class="bg-gray-200 text-gray-600 px-2 py-1 rounded text-xs font-bold"><i class="fas fa-eye-slash mr-1"></i>è¦‹é€ã‚Š</span>` : ''}
                            </div>
                            ` : ''}
                            ${!isAdminOrCoach && isApplied ? `
                            <div class="flex items-center gap-2 mb-3">
                                <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold"><i class="fas fa-check-circle mr-1"></i>å¿œå‹Ÿæ¸ˆã¿</span>
                            </div>
                            ` : ''}

                            <h3 class="text-xl font-bold text-gray-900 mb-1 group-hover:text-indigo-600 transition leading-tight">${rec.jobs.title}</h3>
                            <p class="text-gray-600 font-medium mb-1">${rec.jobs.company}</p>
                            
                            <div class="flex flex-wrap gap-x-4 gap-y-1 mb-3">
                                ${rec.jobs.pdf_filename ? `
                                <div class="flex items-center gap-1 text-[10px] text-gray-500 bg-gray-50 px-1.5 py-0.5 rounded border border-gray-100">
                                    <i class="fas fa-file-pdf text-red-400"></i>
                                    <span class="truncate max-w-[150px]" title="${rec.jobs.pdf_filename}">${rec.jobs.pdf_filename}</span>
                                </div>
                                ` : ''}
                                ${rec.jobs.url ? `
                                <div class="flex items-center gap-1 text-[10px] text-gray-400">
                                    <i class="fas fa-link"></i>
                                    <span class="truncate max-w-[200px]" title="${rec.jobs.url}">${rec.jobs.url}</span>
                                </div>
                                ` : ''}
                            </div>
                            
                            <!-- æ±‚äººæ¦‚è¦ï¼ˆæŠœç²‹ï¼‰ -->
                            <p class="text-sm text-gray-500 mb-4 line-clamp-2">
                                ${rec.jobs.description || 'è©³ç´°æƒ…å ±ã¯æ±‚äººè©³ç´°ã‚’ã”è¦§ãã ã•ã„ã€‚'}
                            </p>

                            <!-- AIåˆ†æçµæœ (ã‚¹ã‚­ãƒ«ãƒãƒƒãƒ & ç¤¾é¢¨) -->
                            ${(() => {
                        const text = rec.match_reason || rec.reason || '';
                        let skillReason = text;
                        let cultureRank = '', cultureReason = '';

                        const skillMatch = text.match(/ãƒãƒƒãƒåº¦è©•ä¾¡[\s\S]*?ç†ç”±[:ï¼š]([\s\S]*?)(?=ç·åˆè©•ä¾¡|ç¤¾é¢¨|$)/);
                        if (skillMatch) skillReason = skillMatch[1].trim();

                        const cultureMatch = text.match(/ç¤¾é¢¨ãƒ»ã‚«ãƒ«ãƒãƒ£ãƒ¼ã®ãƒ•ã‚£ãƒƒãƒˆåº¦è©•ä¾¡[\s\S]*?è©•ä¾¡[:ï¼š]\s*([A-E\-])[\s\S]*?ç†ç”±[:ï¼š]([\s\S]*)/);
                        if (cultureMatch) {
                            cultureRank = cultureMatch[1].trim();
                            cultureReason = cultureMatch[2].trim();
                        }

                        const getRankLabelColor = (r) => {
                            if (['A', 'B'].includes(r)) return 'bg-sky-100 text-sky-800 border-sky-200';
                            if (r === 'C') return 'bg-gray-100 text-gray-800 border-gray-200';
                            if (['D', 'E'].includes(r)) return 'bg-orange-100 text-orange-800 border-orange-200';
                            return 'bg-gray-100 text-gray-600 border-gray-200';
                        };

                        return `
                                <div class="bg-blue-50 border border-blue-100 rounded-md p-3 mb-2">
                                    <div class="flex items-start">
                                        <div class="w-1 self-stretch bg-blue-600 rounded-full mr-3 mt-1 mb-1"></div>
                                        <div>
                                            <h4 class="text-blue-700 font-bold text-sm mb-1">ã‚¹ã‚­ãƒ«ãƒãƒƒãƒ</h4>
                                            <p class="text-sm text-gray-800 leading-relaxed">${skillReason}</p>
                                        </div>
                                    </div>
                                </div>
                                ${cultureRank && cultureRank !== '-' ? `
                                <div class="mt-2 flex items-start text-sm">
                                    <span class="flex-shrink-0 inline-block px-2 py-0.5 border text-xs font-bold rounded mr-2 ${getRankLabelColor(cultureRank)}">
                                        ç¤¾é¢¨: ${cultureRank}
                                    </span>
                                    <p class="text-gray-600 text-xs leading-relaxed self-center">
                                        ${cultureReason}
                                    </p>
                                </div>
                                ` : ''}
                                `;
                    })()}
                            
                            <!-- æ“ä½œãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
                            <div class="mt-4 flex gap-3">
                                ${!isApplied ? `
                                    <button onclick="event.stopPropagation(); applyForJob('${rec.job_id}', '${rec.user_id}')" 
                                        class="text-sm bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-700 transition">
                                        ${isAdminOrCoach ? 'ä»£ç†å¿œå‹Ÿ' : 'å¿œå‹Ÿã™ã‚‹'}
                                    </button>
                                    ${rec.score >= 50 && !isDismissed ? `
                                    <button onclick="event.stopPropagation(); window.dismissRecommendation('${rec.job_id}')" 
                                        class="text-sm bg-white text-gray-600 border border-gray-300 px-3 py-2 rounded hover:bg-gray-50 transition">
                                        è¦‹é€ã‚‹
                                    </button>
                                    ` : ''}
                                ` : ''}
                                ${isAdminOrCoach ? `
                                <button onclick="event.stopPropagation(); window.editRecommendationReason('${rec.id}')" 
                                    class="text-xs text-gray-500 hover:text-indigo-600 underline ml-auto self-center">
                                    <i class="fas fa-edit"></i> ç†ç”±ç·¨é›†
                                </button>
                                ` : ''}
                            </div>
                        </div>

                        <!-- ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« (å³å´: å¹´åãƒ»ãƒªãƒ³ã‚¯ãƒ»AIã‚¹ã‚³ã‚¢) -->
                        <div class="w-full md:w-48 flex flex-col items-end gap-6 border-l border-gray-100 pl-6 md:pt-2">
                            
                            <!-- ä¼æ¥­å & å¹´å -->
                            <div class="text-right">
                                <p class="text-sm font-bold text-gray-800 mb-1">${rec.jobs.company}</p>
                                <p class="text-lg font-bold text-orange-500">
                                    ${rec.jobs.salary_min ? `${Math.floor(rec.jobs.salary_min / 10000)}ä¸‡å††` : ''} 
                                    ${rec.jobs.salary_max ? `~ ${Math.floor(rec.jobs.salary_max / 10000)}ä¸‡å††` : ''}
                                </p>
                            </div>

                            <!-- ãƒªãƒ³ã‚¯ (ç¸¦æ›¸ãé¢¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ) -->
                            ${rec.jobs.url ? `
                            <a href="${rec.jobs.url}" target="_blank" onclick="event.stopPropagation();" 
                               class="writing-vertical-rl text-indigo-600 hover:text-indigo-800 text-sm font-medium tracking-widest border-r-2 border-indigo-100 pr-2 h-24 flex items-center justify-center hover:border-indigo-300 transition">
                               ãƒªãƒ³ã‚¯ã‚’é–‹ã <i class="fas fa-external-link-alt mb-2 transform rotate-90"></i>
                            </a>
                            ` : ''}

                            <!-- AIã‚¹ã‚³ã‚¢ -->
                            <div class="text-center mt-auto">
                                <i class="fas fa-robot text-3xl text-indigo-500 mb-1"></i>
                                <div class="text-lg font-bold text-indigo-900 leading-tight">AI</div>
                                <div class="text-xl font-bold text-indigo-900 leading-none">(${rec.score}ç‚¹)</div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                `;
            }).join('') + '</div>';

            container.html(html);

            // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³UIã‚’è¿½åŠ 
            renderRecommendationPagination();

            // Select2ã‚’åˆæœŸåŒ–
            if (isAdminOrCoach) {
                $('#rec-user-filter').select2({
                    placeholder: "æ±‚è·è€…ã‚’é¸æŠ",
                    allowClear: true,
                    language: "ja",
                    width: '100%'
                });
            }
        }

        // æ¨è–¦ä¸€è¦§ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³UIã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderRecommendationPagination() {
            const container = $('#recommendation-pagination-container');
            if (!container.length) {
                // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ†ãƒŠãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
                $('#recommendations-container').after('<div id="recommendation-pagination-container" class="mt-6"></div>');
            }

            if (totalRecommendationPages <= 1) {
                $('#recommendation-pagination-container').html('');
                return;
            }

            const maxButtons = 5;
            let startPage = Math.max(1, currentRecommendationPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalRecommendationPages, startPage + maxButtons - 1);

            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            let html = '<div class="flex justify-center items-center gap-2">';

            // å‰ã¸ãƒœã‚¿ãƒ³
            if (currentRecommendationPage > 1) {
                html += `<button onclick="goToRecommendationPage(${currentRecommendationPage - 1})" 
                    class="px-4 py-2 border rounded-lg hover:bg-gray-50 transition">
                    <i class="fas fa-chevron-left"></i> å‰ã¸
                </button>`;
            }

            // ãƒšãƒ¼ã‚¸ç•ªå·ãƒœã‚¿ãƒ³
            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === currentRecommendationPage;
                html += `<button onclick="goToRecommendationPage(${i})" 
                    class="px-4 py-2 border rounded-lg transition ${isActive ? 'bg-indigo-600 text-white' : 'hover:bg-gray-50'}">
                    ${i}
                </button>`;
            }

            // æ¬¡ã¸ãƒœã‚¿ãƒ³
            if (currentRecommendationPage < totalRecommendationPages) {
                html += `<button onclick="goToRecommendationPage(${currentRecommendationPage + 1})" 
                    class="px-4 py-2 border rounded-lg hover:bg-gray-50 transition">
                    æ¬¡ã¸ <i class="fas fa-chevron-right"></i>
                </button>`;
            }

            html += '</div>';
            html += `<div class="text-center mt-2 text-sm text-gray-600">
                ãƒšãƒ¼ã‚¸ ${currentRecommendationPage} / ${totalRecommendationPages}
            </div>`;

            $('#recommendation-pagination-container').html(html);
        }

        // æ¨è–¦ä¸€è¦§ã®ãƒšãƒ¼ã‚¸ç§»å‹•
        window.goToRecommendationPage = function (page) {
            currentRecommendationPage = page;
            renderRecommendations();
        }


        // é¸æŠã—ãŸæ±‚äººã®AIå†åˆ¤å®š
        window.reRunSelectedRecommendations = async function () {
            const checkboxes = $('.rec-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('å†åˆ¤å®šã™ã‚‹æ±‚äººã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (!confirm(`${checkboxes.length}ä»¶ã®æ±‚äººã«ã¤ã„ã¦AIãƒãƒƒãƒãƒ³ã‚°ã‚’å†å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆç¾åœ¨ã®åˆ¤å®šçµæœã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼‰`)) {
                return;
            }

            showLoading();
            try {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
                const userJobMap = {}; // { userId: [{jobId, recId}...] }

                checkboxes.each(function () {
                    const userId = $(this).data('user-id');
                    const jobId = $(this).data('job-id');
                    const recId = $(this).val();
                    if (!userId || !jobId) return; // ã‚¬ãƒ¼ãƒ‰
                    if (!userJobMap[userId]) userJobMap[userId] = [];
                    userJobMap[userId].push({ jobId, recId });
                });

                let totalSuccess = 0;
                let totalErrors = 0;

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«å‡¦ç†
                for (const userId of Object.keys(userJobMap)) {
                    const items = userJobMap[userId];
                    const jobIds = items.map(i => i.jobId);
                    // Always fetch fresh & complete data from DB to ensure AI has full context
                    // allCandidatesList only provides basic info (id, name)
                    const { data: dbUser } = await supabase.from('users')
                        .select('*, candidate_profiles(*)')
                        .eq('id', userId)
                        .single();

                    let userDataForAI = null;

                    if (dbUser) {
                        const profile = Array.isArray(dbUser.candidate_profiles) ? dbUser.candidate_profiles[0] : dbUser.candidate_profiles;
                        userDataForAI = { ...dbUser, ...profile, id: userId };
                        console.log('Fetched full user data for Re-Analysis:', userDataForAI.name);
                    } else {
                        // Fallback logic
                        const user = allCandidatesList.find(u => u.id === userId);
                        if (user) {
                            const profile = Array.isArray(user.candidate_profiles) ? user.candidate_profiles[0] : user.candidate_profiles;
                            userDataForAI = { ...user, ...profile, id: userId };
                        } else {
                            const sampleRec = allRecommendations.find(r => r.user_id === userId);
                            if (sampleRec && sampleRec.users) {
                                userDataForAI = { ...sampleRec.users, id: userId };
                            }
                        }
                    }

                    if (!userDataForAI) {
                        console.error('User data missing for AI reruun');
                        totalErrors += jobIds.length;
                        continue;
                    }

                    // æ±‚äººæƒ…å ±ã®å–å¾— (allRecommendationsã‹ã‚‰æ¢ã™)
                    // rec.jobs ãŒå¿…è¦
                    const jobs = jobIds.map(jobId => {
                        const rec = allRecommendations.find(r => r.job_id === jobId && r.user_id === userId);
                        return rec ? rec.jobs : null;
                    }).filter(j => j);

                    if (jobs.length === 0) continue;

                    console.log(`Re-analyzing for user ${userDataForAI.name || userId}: `, jobs.length, 'jobs');

                    const { data: results, error } = await supabase.functions.invoke('ai-matching', {
                        body: {
                            user: userDataForAI,
                            jobs: jobs
                        }
                    });

                    if (error) throw error;

                    // çµæœã®ä¿å­˜
                    const upsertData = results.map(res => {
                        // å‹å¤‰æ›ã®ä¸ä¸€è‡´ã‚’é˜²ããŸã‚ == ã‚’ä½¿ç”¨
                        const original = items.find(i => i.jobId == res.job_id);
                        return {
                            id: original ? original.recId : undefined,
                            organization_id: userDataForAI.organization_id || currentUser.organization_id, // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¿½åŠ 
                            user_id: userId,
                            job_id: res.job_id,
                            score: res.match_score,
                            reason: res.recommendation_reason || res.reason,
                            details: res.details
                        };
                    });

                    const { error: upsertError } = await supabase
                        .from('recommendations')
                        .upsert(upsertData);

                    if (upsertError) {
                        console.error('Upsert error:', upsertError);
                        totalErrors += jobIds.length;
                    } else {
                        totalSuccess += jobIds.length;
                    }
                }

                alert(`å†åˆ¤å®šãŒå®Œäº†ã—ã¾ã—ãŸã€‚\næˆåŠŸ: ${totalSuccess} ä»¶\nå¤±æ•—: ${totalErrors} ä»¶`);

                // ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿
                if (typeof loadRecommendations === 'function') {
                    loadRecommendations();
                }

            } catch (error) {
                console.error('Re-run error:', error);
                alert('å†åˆ¤å®šä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // ãŠã™ã™ã‚ç†ç”±ã®ç·¨é›†
        window.editRecommendationReason = function (recId) {
            console.log('Edit Recommendation Reason requested for ID:', recId);

            const rec = allRecommendations.find(r => r.id === recId) ||
                (typeof allRecommendationsCache !== 'undefined' ? allRecommendationsCache.find(r => r.id === recId) : null);

            if (!rec) {
                console.error('Data not found for ID:', recId);
                alert('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const currentReason = rec.reason || rec.match_reason || '';

            // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒã‚ã‚Œã°å‰Šé™¤
            $('#dynamic-edit-rec-modal').remove();

            // ãƒ¢ãƒ¼ãƒ€ãƒ«HTMLã‚’å®šç¾©
            const modalHtml = `
            <div id="dynamic-edit-rec-modal"
                class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4" 
                style="z-index: 9999999 !important; position: fixed !important; top:0; left:0; width:100%; height:100%;">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden transform transition-all" onclick="event.stopPropagation()">
                    <div class="bg-indigo-600 px-6 py-4 flex justify-between items-center text-white">
                        <h3 class="text-lg font-bold flex items-center gap-2 m-0">
                            <i class="fas fa-edit"></i> ãŠã™ã™ã‚ç†ç”±ã®ç·¨é›†
                        </h3>
                        <button onclick="$('#dynamic-edit-rec-modal').remove()" class="text-white hover:text-indigo-200 transition-colors text-2xl border-none bg-transparent cursor-pointer">&times;</button>
                    </div>

                    <div class="p-6">
                        <input type="hidden" id="edit-rec-reason-id" value="${recId}">
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ãŠã™ã™ã‚ç†ç”±ã®å…¥åŠ›</label>
                            <textarea id="edit-rec-reason-text" rows="10" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-800 leading-relaxed transition-all"
                                placeholder="${rec.score >= 50 ? 'ãŠã™ã™ã‚ã®ç†ç”±ã‚’è©³ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„...' : 'ä¸ä¸€è‡´ã®ç†ç”±ã‚’å…·ä½“çš„ã«å…¥åŠ›ã—ã¦ãã ã•ã„...'}">${currentReason}</textarea>
                            <p class="mt-2 text-xs text-gray-500">â€»ä¿å­˜ã•ã‚Œã‚‹ã¨æ±‚è·è€…ç”»é¢ã«ã‚‚å³æ™‚åæ˜ ã•ã‚Œã¾ã™ã€‚</p>
                        </div>

                        <div class="flex justify-end gap-3 mt-8">
                            <button onclick="$('#dynamic-edit-rec-modal').remove()" 
                                class="px-6 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium transition-colors cursor-pointer bg-white">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onclick="saveRecommendationReason()" 
                                class="px-8 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold shadow-md transition-all cursor-pointer border-none">å¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹</button>
                        </div>
                    </div>
                </div>
            </div>`;

            $('body').append(modalHtml);
            console.log('Dynamic modal created and added to body. Displaying now.');
        }

        window.closeEditRecReasonModal = function () {
            $('#dynamic-edit-rec-modal').remove();
            // å¿µã®ãŸã‚æ—§IDã®æ–¹ã‚‚æ¶ˆã™
            $('#edit-recommendation-reason-modal').addClass('hidden').attr('style', 'display: none !important;');
        }

        window.saveRecommendationReason = async function () {
            const recId = $('#edit-rec-reason-id').val();
            const newReason = $('#edit-rec-reason-text').val();

            showLoading();
            try {
                const user = window.currentUser;

                const { error } = await supabase
                    .from('recommendations')
                    .update({
                        reason: newReason,
                        recommended_by: user.id
                    })
                    .eq('id', recId);

                if (error) throw error;

                alert('ãŠã™ã™ã‚ç†ç”±ã‚’æ›´æ–°ã—ã¾ã—ãŸ');

                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
                const rec = allRecommendations.find(r => r.id === recId) ||
                    (typeof allRecommendationsCache !== 'undefined' ? allRecommendationsCache.find(r => r.id === recId) : null);
                if (rec) {
                    rec.reason = newReason;
                    rec.recommended_by = user.id;
                }

                closeEditRecReasonModal();
                // å†æç”»
                renderRecommendations();
            } catch (error) {
                console.error('Update reason error:', error);
                alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // æ¨è–¦çµæœã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        window.filterRecommendations = function (userId) {
            currentSelectedUserId = userId;
            currentRecommendationPage = 1; // ãƒšãƒ¼ã‚¸ç•ªå·ã‚’ãƒªã‚»ãƒƒãƒˆ
            // å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¦ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ã‚’é©ç”¨
            renderRecommendations(allRecommendations, isAdminOrCoachView, allCandidatesList, appliedJobIdsCache);
        }

        window.generateAIRecommendations = async function () {
            if (!confirm('AIåˆ†æã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿï¼ˆã“ã‚Œã«ã¯æ•°ç§’ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰')) return

            showLoading()
            try {
                // 1. æ±‚äººãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const { data: jobs } = await supabase
                    .from('jobs')
                    .select('*')
                    .eq('organization_id', currentUser.organization_id)
                    .eq('status', 'active')

                if (!jobs || jobs.length === 0) throw new Error('åˆ†æå¯¾è±¡ã®æ±‚äººãŒã‚ã‚Šã¾ã›ã‚“')

                // 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼ˆDBã‹ã‚‰å–å¾—ï¼‰
                const userProfile = `
                å¸Œæœ›è·ç¨®: ${currentUser.desired_job_type || 'æœªè¨­å®š'}
                å¸Œæœ›å‹¤å‹™å‹¤å‹™åœ°: ${currentUser.desired_location || 'æœªè¨­å®š'}
                ã‚¹ã‚­ãƒ«: ${currentUser.skills || 'æœªè¨­å®š'}
                è·æ­´ãƒ»è‡ªå·±PR: ${currentUser.work_history || 'æœªè¨­å®š'}
                `

                // 3. Edge Function å‘¼ã³å‡ºã—
                // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§Gemini APIã‚’å®Ÿè¡Œã—ã€APIã‚­ãƒ¼ã‚’éš è”½ã—ã¾ã™
                const { data: recommendations, error: functionError } = await supabase.functions.invoke('score-ai-recommendations', {
                    body: {
                        userProfile,
                        jobs: jobs.map(j => ({ id: j.id, title: j.title, description: j.description }))
                    }
                })

                if (functionError) {
                    throw functionError
                }

                if (!recommendations || recommendations.length === 0) {
                    throw new Error('AIã‹ã‚‰ã®å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆå€™è£œãªã—ï¼‰')
                }

                // 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ï¼ˆupsertæ–¹å¼ï¼šæ—¢å­˜ã¯æ›´æ–°ã€æ–°è¦ã¯è¿½åŠ ï¼‰
                for (const rec of recommendations) {
                    // æ—¢å­˜ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª
                    const { data: existing } = await supabase
                        .from('recommendations')
                        .select('id')
                        .eq('user_id', currentUser.id)
                        .eq('job_id', rec.job_id)
                        .maybeSingle();

                    if (existing) {
                        // æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°
                        await supabase
                            .from('recommendations')
                            .update({
                                score: rec.score,
                                reason: rec.reason,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', existing.id);
                    } else {
                        // æ–°è¦ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æŒ¿å…¥
                        await supabase.from('recommendations').insert({
                            organization_id: currentUser.organization_id,
                            user_id: currentUser.id,
                            job_id: rec.job_id,
                            score: rec.score,
                            reason: rec.reason
                        });
                    }
                }

                alert('AIåˆ†æãŒå®Œäº†ã—ã¾ã—ãŸï¼')
                loadRecommendations()
                loadDashboard()

            } catch (error) {
                console.error('AI generation error:', error)
                alert('AIåˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
            } finally {
                hideLoading()
            }
        }

        // ========================
        // æ¨è–¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé–¢é€£
        // ========================
        let currentTemplates = [];

        window.openRecommendationMessageModal = async function () {
            const checkboxes = $('.rec-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å«ã‚ã‚‹æ±‚äººã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const targetUserIds = [...new Set(checkboxes.map((_, el) => $(el).data('user-id')).get())];
            if (targetUserIds.length > 1) {
                alert('ç•°ãªã‚‹æ±‚è·è€…ã®æ±‚äººãŒæ··åœ¨ã—ã¦ã„ã¾ã™ã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆã¯1äººã®æ±‚è·è€…ã”ã¨ã«è¡Œã£ã¦ãã ã•ã„ã€‚');
                return;
            }

            const targetUserId = targetUserIds[0];
            const targetUser = allCandidatesList.find(u => u.id === targetUserId);

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            $('#recommendation-message-modal').removeClass('hidden');

            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰
            await loadEmailTemplates();

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
            generateRecommendationMessage();
        };

        window.closeRecommendationMessageModal = function () {
            $('#recommendation-message-modal').addClass('hidden');
        };

        window.loadEmailTemplates = async function () {
            try {
                const { data, error } = await supabase
                    .from('email_templates')
                    .select('*')
                    .eq('organization_id', currentUser.organization_id)
                    .order('is_default', { ascending: false })
                    .order('name');

                if (error) throw error;
                currentTemplates = data || [];

                // æ¨è–¦ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠãƒ—ãƒ«ãƒ€ã‚¦ãƒ³
                const select = $('#message-template-select');
                if (select.length) {
                    select.empty();
                    currentTemplates.forEach(t => {
                        select.append(`<option value="${t.id}" ${t.is_default ? 'selected' : ''}>${t.name}</option>`);
                    });
                }

                // ç®¡ç†ç”»é¢ã®ãƒªã‚¹ãƒˆè¡¨ç¤º
                renderEmailTemplatesList();
            } catch (error) {
                console.error('Failed to load email templates:', error);
            }
        };

        window.applyMessageTemplate = function (templateId) {
            generateRecommendationMessage();
        };

        window.generateRecommendationMessage = function () {
            const checkboxes = $('.rec-checkbox:checked');
            const templateId = $('#message-template-select').val();
            const template = currentTemplates.find(t => t.id === templateId);

            if (!template) {
                $('#recommendation-message-body').val('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const targetUserId = checkboxes.first().data('user-id');
            const targetUser = allCandidatesList.find(u => u.id === targetUserId);

            // é¸æŠã•ã‚ŒãŸæ±‚äººæ¨è–¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const selectedRecIds = checkboxes.map((_, el) => $(el).val()).get();
            const selectedRecs = allRecommendations.filter(r => selectedRecIds.includes(r.id));

            // å¤‰æ•°ã®çµ„ã¿ç«‹ã¦
            let jobDetailsText = '';
            let jobListText = '';
            let reasonsText = '';

            selectedRecs.forEach((rec, idx) => {
                const job = rec.jobs;
                const driveUrl = job.url || 'URLãªã—';

                // AIå‡ºåŠ›ãƒ†ã‚­ã‚¹ãƒˆã®å–å¾—ã¨ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
                let fullText = rec.details || rec.reason || rec.recommendation_reason || rec.match_reason || '';

                // ãƒ„ãƒ¼ãƒ«ãƒ­ã‚°ã®é™¤å»ï¼ˆå¿µã®ãŸã‚ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã‚‚å®Ÿæ–½ï¼‰
                const headerIndex = fullText.indexOf('ãƒãƒƒãƒåº¦è©•ä¾¡');
                if (headerIndex !== -1) fullText = fullText.substring(headerIndex);
                fullText = fullText.replace(/tool_code[\s\S]*?print\(.*?\)/g, '')
                    .replace(/thought\n[\s\S]*?(?=\n\n|\Z)/g, '')
                    .replace(/^```[\s\S]*?```/gm, '')
                    .trim();

                // å„è¦ç´ ã®æŠ½å‡º
                let matchReason = '';
                let cultureGrade = '-';
                let cultureReason = '';

                // ãƒãƒƒãƒåº¦åŒºç”»ã®æŠ½å‡º
                const matchSectionMatch = fullText.match(/ãƒãƒƒãƒåº¦è©•ä¾¡([\s\S]*?)(?:ç¤¾é¢¨ãƒ»ã‚«ãƒ«ãƒãƒ£ãƒ¼|$)/);
                if (matchSectionMatch) {
                    const m = matchSectionMatch[1].match(/ç†ç”±[:ï¼š]\s*([^\n]+)/);
                    if (m) matchReason = m[1].trim();
                } else {
                    // åŒºç”»ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€æœ€åˆã®ã€Œç†ç”±:ã€ã‚’æ¡ç”¨
                    const m = fullText.match(/ç†ç”±[:ï¼š]\s*([^\n]+)/);
                    if (m) matchReason = m[1].trim();
                }

                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å…¨ãæŠ½å‡ºã§ããªã‘ã‚Œã°å…¨æ–‡ã‚’ä½¿ç”¨ï¼ˆãŸã ã—çŸ­ã‚ã«ã™ã‚‹ï¼‰
                if (!matchReason && fullText) {
                    matchReason = fullText.length > 100 ? fullText.substring(0, 100) + '...' : fullText;
                }

                // ç¤¾é¢¨åŒºç”»ã®æŠ½å‡º
                const cultureSectionMatch = fullText.match(/ç¤¾é¢¨ãƒ»ã‚«ãƒ«ãƒãƒ£ãƒ¼ã®ãƒ•ã‚£ãƒƒãƒˆåº¦è©•ä¾¡([\s\S]*)/);
                if (cultureSectionMatch) {
                    const section = cultureSectionMatch[1];
                    const gm = section.match(/è©•ä¾¡[:ï¼š]\s*([A-E\-])/);
                    if (gm) cultureGrade = gm[1];
                    const rm = section.match(/ç†ç”±[:ï¼š]\s*([^\n]+)/);
                    if (rm) cultureReason = rm[1].trim();
                }

                // 1. jobDetails (ç†æƒ³ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ)
                jobDetailsText += `æ±‚äºº${idx + 1}\n`;
                jobDetailsText += `ä¼æ¥­åï¼š ${job.company}\n`;
                jobDetailsText += `æ±‚äººåï¼š ${job.title}\n`;
                jobDetailsText += `ãƒãƒƒãƒåº¦ï¼š ${rec.score}ç‚¹ (${matchReason})\n`;
                jobDetailsText += `ç¤¾é¢¨ãƒãƒƒãƒï¼š ${cultureGrade} (${cultureReason})\n`;
                jobDetailsText += `æ±‚äººIDï¼š ${driveUrl}\n\n`;

                // 2. jobList (ç†ç”±ãªã—)
                jobListText += `ã€æ¡ˆä»¶ ${idx + 1}ã€‘ ${job.company} / ${job.title}\n`;
                jobListText += `è©³ç´°URL: ${driveUrl}\n\n`;

                // 3. recommendationReason (ç†ç”±ã®ã¿ãƒªã‚¹ãƒˆ - ãƒãƒƒãƒåº¦ç†ç”±ã‚’ä½¿ç”¨)
                if (matchReason) {
                    if (selectedRecs.length > 1) {
                        reasonsText += `â–  ${job.company} (${job.title})\n${matchReason}\n\n`;
                    } else {
                        reasonsText = matchReason;
                    }
                }
            });

            // å¤‰æ•°ç½®æ›
            const rawUserName = targetUser ? targetUser.name || 'æ±‚è·è€…' : 'æ±‚è·è€…';
            const cleanUserName = rawUserName.replace(/æ§˜$/, '');

            const body = template.body_template
                .replace(/{{userName}}/g, cleanUserName)
                .replace(/{{agentName}}/g, currentUser.name || '')
                .replace(/{{jobDetails}}/g, jobDetailsText.trim())
                .replace(/{{jobList}}/g, jobListText.trim())
                .replace(/{{jobDetailsCount}}/g, selectedRecs.length)
                .replace(/{{recommendationReason}}/g, reasonsText.trim());

            $('#recommendation-message-body').val(body);
        };

        window.copyRecommendationMessage = function () {
            const body = $('#recommendation-message-body').val();
            if (!body) return;
            navigator.clipboard.writeText(body).then(() => {
                alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            });
        };

        window.sendRecommendationEmail = async function () {
            const checkboxes = $('.rec-checkbox:checked');
            const targetUserId = checkboxes.first().data('user-id');
            const body = $('#recommendation-message-body').val();
            const templateId = $('#message-template-select').val();
            const template = currentTemplates.find(t => t.id === templateId);

            if (!body) {
                alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ãŒç©ºã§ã™');
                return;
            }

            // æ±‚è·è€…æƒ…å ±ã‚’å–å¾—
            const { data: user, error } = await supabase
                .from('users')
                .select('name, email')
                .eq('id', targetUserId)
                .single();

            if (error || !user || !user.email) {
                alert('å€™è£œè€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªã§ãã¾ã›ã‚“ã€‚');
                return;
            }

            if (!confirm(`${user.name} ã•ã‚“ï¼ˆ${user.email}ï¼‰ã«ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }

            $('#send-recommendation-email-btn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>é€ä¿¡ä¸­...');

            try {
                // sendEmail(type, to, data)
                const success = await sendEmail('recommendation', user.email, {
                    userName: user.name,
                    subject: template.subject || 'ã€æ±‚äººã®ã”ç´¹ä»‹ã€‘',
                    body: body,
                    scoutUrl: `${window.location.origin}/#recommendations`
                });

                if (success) {
                    alert('ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚');
                    closeRecommendationMessageModal();
                } else {
                    alert('ãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }
            } catch (error) {
                console.error('Email send error:', error);
                alert('é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            } finally {
                $('#send-recommendation-email-btn').prop('disabled', false).html('<i class="fas fa-paper-plane mr-2"></i>å€™è£œè€…ã¸ãƒ¡ãƒ¼ãƒ«é€ä¿¡');
            }
        };

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªã‚¹ãƒˆè¡¨ç¤ºï¼ˆç®¡ç†ç”»é¢ç”¨ï¼‰
        window.renderEmailTemplatesList = function () {
            const container = $('#email-templates-list');
            if (!container.length) return;
            container.empty();

            if (currentTemplates.length === 0) {
                container.html('<div class="col-span-full py-12 text-center text-gray-500 bg-gray-50 border-2 border-dashed rounded-xl">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>');
                return;
            }

            currentTemplates.forEach(t => {
                const card = `
                    <div class="bg-white border ${t.is_default ? 'border-indigo-600 ring-1 ring-indigo-600' : 'border-gray-200'} p-5 rounded-xl shadow-sm hover:shadow-md transition group">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-bold text-gray-900">${t.name}</h4>
                                ${t.is_default ? '<span class="inline-block mt-1 text-[10px] bg-indigo-100 text-indigo-700 font-bold px-2 py-0.5 rounded uppercase">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</span>' : ''}
                            </div>
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition">
                                <button onclick="editEmailTemplate('${t.id}')" class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition" title="ç·¨é›†">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteEmailTemplate('${t.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="å‰Šé™¤">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 line-clamp-3 mb-4 leading-relaxed">${t.body_template.substring(0, 100)}...</p>
                        <div class="text-[10px] text-gray-400 border-t pt-3">
                            <i class="far fa-clock mr-1"></i>æœ€çµ‚æ›´æ–°: ${new Date(t.updated_at).toLocaleDateString()}
                        </div>
                    </div>
                `;
                container.append(card);
            });
        };

        window.openEmailTemplateModal = function (template = null) {
            $('#email-template-modal').removeClass('hidden');
            if (template) {
                $('#template-modal-title').text('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç·¨é›†');
                $('#template-id').val(template.id);
                $('#template-name').val(template.name);
                $('#template-subject').val(template.subject);
                $('#template-body').val(template.body_template);
                $('#template-is-default').prop('checked', template.is_default);
            } else {
                $('#template-modal-title').text('æ–°è¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ');
                $('#template-id').val('');
                $('#template-name').val('');
                $('#template-subject').val('');
                $('#template-body').val('');
                $('#template-is-default').prop('checked', currentTemplates.length === 0);
            }
        };

        window.closeEmailTemplateModal = function () {
            $('#email-template-modal').addClass('hidden');
        };

        window.editEmailTemplate = function (id) {
            const template = currentTemplates.find(t => t.id === id);
            if (template) openEmailTemplateModal(template);
        };

        window.saveEmailTemplate = async function () {
            const id = $('#template-id').val();
            const name = $('#template-name').val();
            const subject = $('#template-subject').val();
            const body = $('#template-body').val();
            const isDefault = $('#template-is-default').prop('checked');

            if (!name || !body) {
                alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã¨æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            showLoading();
            try {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è§£é™¤ï¼ˆãã®çµ„ç¹”å†…ã§ä¸€ã¤ã ã‘ã«åˆ¶é™ï¼‰
                if (isDefault) {
                    await supabase
                        .from('email_templates')
                        .update({ is_default: false })
                        .eq('organization_id', currentUser.organization_id);
                }

                const data = {
                    organization_id: currentUser.organization_id,
                    name: name,
                    subject: subject,
                    body_template: body,
                    is_default: isDefault,
                    updated_at: new Date().toISOString()
                };

                let error;
                if (id) {
                    const { error: err } = await supabase.from('email_templates').update(data).eq('id', id);
                    error = err;
                } else {
                    const { error: err } = await supabase.from('email_templates').insert(data);
                    error = err;
                }

                if (error) throw error;

                alert('ä¿å­˜ã—ã¾ã—ãŸ');
                closeEmailTemplateModal();
                loadEmailTemplates();
            } catch (error) {
                console.error('Error saving template:', error);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            } finally {
                hideLoading();
            }
        };

        window.deleteEmailTemplate = async function (id) {
            if (!confirm('ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;

            showLoading();
            try {
                const { error } = await supabase.from('email_templates').delete().eq('id', id);
                if (error) throw error;
                loadEmailTemplates();
            } catch (error) {
                console.error('Error deleting template:', error);
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            } finally {
                hideLoading();
            }
        };

        // ========================
        // Profile
        // ========================

        async function loadMasterDataForProfile(user) {
            try {
                // Select2ã®åˆæœŸåŒ–ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¿½åŠ å¾Œã«è¡Œã†ãŸã‚ã€ã“ã“ã§ã¯å‰Šé™¤
                /*
                $('.select2').select2({
                    language: "ja",
                    width: 'resolve'
                });
                */

                // éƒ½é“åºœçœŒã®è¨­å®š
                const setPrefectureOptions = (selector) => {
                    const select = $(selector);
                    select.empty().append('<option value="">éƒ½é“åºœçœŒ</option>');
                    prefectures.forEach(pref => {
                        select.append(`<option value="${pref}">${pref}</option>`);
                    });
                };
                setPrefectureOptions('#profile-prefecture');
                setPrefectureOptions('#reg-prefecture');
                setPrefectureOptions('#admin-user-prefecture');

                // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒæœªãƒ­ãƒ¼ãƒ‰ã®å ´åˆã¯ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
                if (masterJobCategories.length === 0 || masterIndustries.length === 0) {
                    await initMasterDataDropdowns();
                }

                // é›‡ç”¨å½¢æ…‹ã‚’å–å¾— (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¾ãŸã¯master_dataã‹ã‚‰)
                let validMasters;

                if (masterDataCache.isValid() && masterDataCache.employmentTypes) {
                    console.log('Using cached employment types');
                    validMasters = masterDataCache.employmentTypes;
                } else {
                    console.log('Fetching employment types from database');

                    const { data: masters, error } = await supabase
                        .from('master_data')
                        .select('type, label, value, organization_id, sort_order') // å¿…è¦ãªã‚«ãƒ©ãƒ ã®ã¿å–å¾—
                        .eq('type', 'employment_type')
                        .eq('is_active', true)
                        .order('sort_order')

                    if (error) throw error

                    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°: è‡ªç¤¾å°‚ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                    // 1. ã¾ãšè‡ªç¤¾å°‚ç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                    const orgSpecific = masters.filter(m => m.organization_id === currentUser.organization_id);

                    // 2. ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                    const globalData = masters.filter(m => m.organization_id === null);

                    // 3. è‡ªç¤¾å°‚ç”¨ãƒ‡ãƒ¼ã‚¿ã§æ—¢ã«å­˜åœ¨ã™ã‚‹labelã‚’è¨˜éŒ² (valueã§ã¯ãªãlabelã§åˆ¤å®š)
                    const orgSpecificLabels = new Set(orgSpecific.map(m => m.label));

                    // 4. ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€è‡ªç¤¾å°‚ç”¨ãƒ‡ãƒ¼ã‚¿ã¨é‡è¤‡ã—ãªã„ã‚‚ã®ã ã‘ã‚’å–å¾—
                    const nonDuplicateGlobal = globalData.filter(m => !orgSpecificLabels.has(m.label));

                    // 5. è‡ªç¤¾å°‚ç”¨ãƒ‡ãƒ¼ã‚¿ã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’çµåˆ
                    validMasters = [...orgSpecific, ...nonDuplicateGlobal];

                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
                    masterDataCache.employmentTypes = validMasters;
                    if (!masterDataCache.lastUpdated) {
                        masterDataCache.lastUpdated = Date.now();
                    }
                }

                console.log('Employment types after filtering:', validMasters.map(m => `${m.label} (org: ${m.organization_id ? 'custom' : 'global'}, value: ${m.value})`));

                // é›‡ç”¨å½¢æ…‹ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ç”Ÿæˆ
                const empTargets = ['#profile-employment-type', '#reg-employment-type', '#admin-user-employment-type'];
                empTargets.forEach(s => {
                    const select = $(s);

                    // Select2ãŒæ—¢ã«åˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ç ´æ£„
                    if (select.hasClass("select2-hidden-accessible")) {
                        select.select2('destroy');
                    }

                    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†ç”Ÿæˆ
                    select.empty();
                    validMasters.forEach(m => {
                        select.append(`<option value="${m.value}">${m.label}</option>`);
                    });
                });

                // è·ç¨®ã‚«ãƒ†ã‚´ãƒªã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ç”Ÿæˆ (å…±é€šãƒã‚¹ã‚¿ä½¿ç”¨)
                const jobTargets = ['#profile-job-type', '#reg-job-type', '#admin-user-job-type'];
                jobTargets.forEach(s => {
                    const select = $(s);

                    // Select2ãŒæ—¢ã«åˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ç ´æ£„
                    if (select.hasClass("select2-hidden-accessible")) {
                        select.select2('destroy');
                    }

                    select.empty();
                    masterJobCategories.forEach(c => {
                        select.append(`<option value="${c}">${c}</option>`);
                    });
                });

                // æ¥­ç•Œã‚«ãƒ†ã‚´ãƒªã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ç”Ÿæˆ (å…±é€šãƒã‚¹ã‚¿ä½¿ç”¨)
                const indTargets = ['#profile-industry', '#reg-industry', '#admin-user-industry'];
                indTargets.forEach(s => {
                    const select = $(s);

                    // Select2ãŒæ—¢ã«åˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ç ´æ£„
                    if (select.hasClass("select2-hidden-accessible")) {
                        select.select2('destroy');
                    }

                    select.empty();
                    masterIndustries.forEach(i => {
                        select.append(`<option value="${i}">${i}</option>`);
                    });
                });

                // Select2ã®åˆæœŸåŒ–ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®šå¾Œã«å®Ÿè¡Œï¼‰
                // æ—¢å­˜ã®Select2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç ´æ£„ï¼ˆselectè¦ç´ ã®ã¿å¯¾è±¡ï¼‰
                $('select.select2').each(function () {
                    if ($(this).hasClass("select2-hidden-accessible")) {
                        try {
                            $(this).select2('destroy');
                        } catch (e) {
                            console.warn('Failed to destroy Select2:', e);
                        }
                    }
                });

                // ç®¡ç†è€…ç”¨ãƒ•ã‚©ãƒ¼ãƒ ã®Select2ã¯ç‰¹åˆ¥ãªè¨­å®šãŒå¿…è¦
                $('#admin-user-job-type, #admin-user-industry, #admin-user-employment-type, #admin-user-prefecture').select2({
                    language: "ja",
                    width: '100%',
                    closeOnSelect: false,
                    allowClear: true,
                    placeholder: 'é¸æŠã—ã¦ãã ã•ã„'
                });

                // ãã®ä»–ã®Select2ã¯æ¨™æº–è¨­å®šï¼ˆselectè¦ç´ ã®ã¿ï¼‰
                $('select.select2').not('#admin-user-job-type, #admin-user-industry, #admin-user-employment-type, #admin-user-prefecture').each(function () {
                    if (!$(this).hasClass("select2-hidden-accessible")) {
                        $(this).select2({
                            language: "ja",
                            width: 'resolve'
                        });
                    }
                });

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¸æŠå€¤ã‚’ã‚»ãƒƒãƒˆ (ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†æ™‚ã®ã¿)
                if (user) {
                    console.log('Before parse:', user.desired_location, typeof user.desired_location);

                    // å€¤ã‚’æ­£è¦åŒ–ï¼ˆJSONæ–‡å­—åˆ—ãªã‚‰ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ï¼‰
                    user.desired_job_type = window.safeParseList(user.desired_job_type);
                    user.desired_industry = window.safeParseList(user.desired_industry);
                    user.desired_employment_type = window.safeParseList(user.desired_employment_type);
                    user.desired_location = window.safeParseList(user.desired_location);

                    console.log('After parse:', user.desired_location, Array.isArray(user.desired_location));

                    const setSelect2Val = (selectId, val) => {
                        if (!val) return;
                        if (Array.isArray(val)) {
                            $(selectId).val(val).trigger('change');
                        } else {
                            const v = val.toString().includes(',') ? val.split(',') : [val];
                            $(selectId).val(v).trigger('change');
                        }
                    };

                    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ•ã‚©ãƒ¼ãƒ 
                    setSelect2Val('#profile-employment-type', user.desired_employment_type);
                    setSelect2Val('#profile-job-type', user.desired_job_type);
                    setSelect2Val('#profile-industry', user.desired_industry);

                    // ç®¡ç†è€…ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ 
                    console.log('Setting admin user form values:', {
                        employment_type: user.desired_employment_type,
                        job_type: user.desired_job_type,
                        industry: user.desired_industry
                    });
                    setSelect2Val('#admin-user-employment-type', user.desired_employment_type);
                    setSelect2Val('#admin-user-job-type', user.desired_job_type);
                    setSelect2Val('#admin-user-industry', user.desired_industry);

                    // å€¤ãŒæ­£ã—ãã‚»ãƒƒãƒˆã•ã‚ŒãŸã‹ç¢ºèª
                    setTimeout(() => {
                        console.log('Verification - Values after setting:', {
                            employment_type: $('#admin-user-employment-type').val(),
                            job_type: $('#admin-user-job-type').val(),
                            industry: $('#admin-user-industry').val()
                        });
                    }, 50);

                    // å‹¤å‹™åœ°ã®åˆ†å‰²ã‚»ãƒƒãƒˆ
                    if (user.desired_location) {
                        let locations = Array.isArray(user.desired_location) ? user.desired_location : [user.desired_location];

                        // è¦ç´ å†…ã«ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯å±•é–‹ã™ã‚‹ (ä¾‹: ["A/B"] -> ["A", "B"])
                        let flatLocations = [];
                        locations.forEach(loc => {
                            if (typeof loc === 'string') {
                                // åŠè§’/å…¨è§’ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã€ã‚«ãƒ³ãƒã€èª­ç‚¹ã€ã‚¹ãƒšãƒ¼ã‚¹ã§åˆ†å‰²
                                const parts = loc.split(/[\/\uff0f,ã€\s]+/).map(s => s.trim()).filter(s => s);
                                if (parts.length > 0) {
                                    flatLocations.push(...parts);
                                } else {
                                    flatLocations.push(loc);
                                }
                            } else {
                                flatLocations.push(loc);
                            }
                        });
                        locations = flatLocations;
                        console.log('Flat locations:', locations);

                        const matchedPrefs = [];
                        const unmatched = [];

                        locations.forEach(loc => {
                            // "æ±äº¬éƒ½" or "æ±äº¬éƒ½xxxåŒº" ã®å ´åˆã€"æ±äº¬éƒ½" ã‚’æŠ½å‡ºã—ã¦ãƒãƒƒãƒã•ã›ã‚‹
                            let found = false;
                            for (const pref of prefectures) {
                                if (loc === pref || loc.startsWith(pref)) {
                                    if (!matchedPrefs.includes(pref)) {
                                        matchedPrefs.push(pref);
                                    }
                                    const rest = loc.substring(pref.length);
                                    if (rest) unmatched.push(rest);
                                    found = true;
                                    break;
                                }
                            }
                            if (!found) {
                                unmatched.push(loc);
                            }
                        });

                        console.log('Matched Prefs:', matchedPrefs);
                        console.log('Unmatched:', unmatched);

                        // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«ã‚»ãƒƒãƒˆï¼ˆè¤‡æ•°é¸æŠï¼‰
                        $('#profile-prefecture').val(matchedPrefs).trigger('change');
                        $('#admin-user-prefecture').val(matchedPrefs).trigger('change');

                        // æ®‹ã‚Šã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã«ã‚»ãƒƒãƒˆ
                        console.log('Finalizing location sets...');
                        const restStr = unmatched.join(' / ');
                        $('#profile-city').val(restStr);
                        $('#admin-user-city').val(restStr);

                        // æ€§åˆ¥ã¨ç¾ä½æ‰€ã®ã‚»ãƒƒãƒˆ
                        $('#profile-gender').val(user.gender || '');
                        $('#admin-user-gender').val(user.gender || '');

                        // éƒ½é“åºœçœŒãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®åˆæœŸåŒ– (ç¾ä½æ‰€ç”¨)
                        const prefSelects = $('#profile-current-location, #admin-user-current-location');
                        prefSelects.empty().append('<option value="">éƒ½é“åºœçœŒã‚’é¸æŠ</option>');
                        prefectures.forEach(p => {
                            prefSelects.append(`<option value="${p}">${p}</option>`);
                        });
                        $('#profile-current-location').val(user.current_location || '');
                        $('#admin-user-current-location').val(user.current_location || '');

                    }
                    console.log('loadMasterDataForProfile: Done');
                }

            } catch (error) {
                console.error('Load profile master error:', error);
                throw error;
            }
        }
        async function loadProfile() {
            if (!currentUser) return

            showLoading()
            try {
                // usersãƒ†ãƒ¼ãƒ–ãƒ«ã¨candidate_profilesã‚’çµåˆã—ã¦å–å¾—
                const { data: userData, error } = await supabase
                    .from('users')
                    .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                    .eq('id', currentUser.id)
                    .single()

                if (error) throw error

                // ãƒ•ãƒ©ãƒƒãƒˆåŒ–ï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
                const profile = Array.isArray(userData.candidate_profiles) ? userData.candidate_profiles[0] : userData.candidate_profiles;
                const user = { ...userData, ...profile };
                user.id = userData.id;

                // Update local currentUser cache
                currentUser = user

                // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ & å€¤ã‚»ãƒƒãƒˆ
                await loadMasterDataForProfile(user);

                // Fill form
                $('#profile-name').val(user.name)
                $('#profile-furigana').val(user.furigana || '')
                $('#profile-email').val(user.email)
                $('#profile-phone').val(user.phone || '')
                $('#profile-birth-date').val(user.birth_date || '')
                $('#profile-age').val(user.age || '')

                // è·ç¨®ã€æ¥­ç•Œã€é›‡ç”¨å½¢æ…‹ã€å‹¤å‹™åœ°ã¯ loadMasterDataForProfile ã§ã‚»ãƒƒãƒˆæ¸ˆã¿

                $('#profile-salary').val(user.desired_salary ? Math.floor(user.desired_salary / 10000) : '')
                $('#profile-freewords').val(user.desired_freewords || '')
                $('#profile-job-experience-ok').prop('checked', user.desired_job_experience_ok)
                $('#profile-industry-experience-ok').prop('checked', user.desired_industry_experience_ok)

                $('#profile-skills').val(user.skills || '')
                $('#profile-history').val(user.work_history || '')
                $('#profile-work-history-detail').val(user.work_history_detail || '')
                $('#profile-history-info').val(user.history_info || '')

                $('#profile-current-salary').val(user.current_salary ? user.current_salary / 10000 : '')
                $('#profile-academic').val(user.education || user.academic_background || '')
                $('#profile-languages').val(user.languages || '')
                $('#profile-certifications').val(user.certifications || '')
                $('#profile-start-date').val(user.available_start_date || '')

                // è©³ç´°è·æ­´
                $('#profile-work-history-list').empty();
                if (user.work_history_structured && Array.isArray(user.work_history_structured)) {
                    user.work_history_structured.forEach(item => addWorkHistoryItemToContainer('#profile-work-history-list', item));
                }
                updateJobChangeCountInContainer('#profile-work-history-list', '#profile-job-change-count');

                // ç¤¾å†…ç”¨æƒ…å ±ã®ã‚»ãƒƒãƒˆ & è¡¨ç¤ºåˆ¶å¾¡
                $('#profile-drive-url').val(user.drive_folder_url || '')
                $('#profile-notebooklm-url').val(user.notebooklm_url || '')
                $('#profile-line-url').val(user.line_url || '')
                $('#profile-resume-detail').val(user.resume || '')
                $('#profile-notes').val(user.notes || '')

                if (['admin', 'org_admin', 'super_admin', 'coach', 'ca', 'ra'].includes(currentUser.role)) {
                    $('#internal-profile-info').removeClass('hidden')
                } else {
                    $('#internal-profile-info').addClass('hidden')
                }

            } catch (error) {
                console.error('Load profile error:', error)
                alert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ')
            } finally {
                hideLoading()
            }
        }

        $('#profile-form').on('submit', async function (e) {
            e.preventDefault()
            showLoading()

            const salaryNum = $('#profile-salary').val() ? parseInt($('#profile-salary').val()) * 10000 : null;

            // usersãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°ç”¨
            const userUpdates = {
                email: $('#profile-email').val().trim(),
                furigana: $('#profile-furigana').val().trim(),
                updated_at: new Date().toISOString()
            }

            // candidate_profilesãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°ç”¨
            const profileUpdates = {
                desired_job_type: $('#profile-job-type').val() ? $('#profile-job-type').val().join(',') : null,
                desired_industry: $('#profile-industry').val() ? $('#profile-industry').val().join(',') : null,
                desired_location: (() => {
                    const prefs = $('#profile-prefecture').val();
                    const city = $('#profile-city').val() || '';
                    if (Array.isArray(prefs) && prefs.length > 0) {
                        let loc = prefs.join(',');
                        if (city) {
                            if (prefs.length > 1) {
                                loc += ' ' + city;
                            } else {
                                loc = prefs[0] + city;
                            }
                        }
                        return loc;
                    } else if (prefs) {
                        return prefs + city;
                    }
                    return city || null;
                })(),
                desired_employment_type: $('#profile-employment-type').val() ? $('#profile-employment-type').val().join(',') : null,
                desired_salary: salaryNum,
                desired_freewords: $('#profile-freewords').val().trim(),
                desired_job_experience_ok: $('#profile-job-experience-ok').is(':checked'),
                desired_industry_experience_ok: $('#profile-industry-experience-ok').is(':checked'),
                skills: $('#profile-skills').val().trim(),
                work_history: $('#profile-history').val().trim(),
                work_history_detail: $('#profile-work-history-detail').val().trim(),
                history_info: $('#profile-history-info').val().trim(),
                current_salary: $('#profile-current-salary').val() ? parseInt($('#profile-current-salary').val()) * 10000 : null,
                education: $('#profile-academic').val().trim(),
                languages: $('#profile-languages').val().trim(),
                certifications: $('#profile-certifications').val().trim(),
                available_start_date: $('#profile-start-date').val() || null,
                birth_date: $('#profile-birth-date').val() || null,
                age: $('#profile-age').val() ? parseInt($('#profile-age').val()) : null,
                gender: $('#profile-gender').val() || null,
                current_location: $('#profile-current-location').val() || null,
                phone: $('#profile-phone').val().trim() || null,

                // è©³ç´°è·æ­´ã®å–å¾—
                work_history_structured: (() => {
                    const list = [];
                    $('#profile-work-history-list .work-history-item').each(function () {
                        list.push({
                            company_name: $(this).find('.wh-company').val(),
                            period: $(this).find('.wh-period').val(),
                            industry: $(this).find('.wh-industry').val(),
                            job_category: $(this).find('.wh-job-category').val(),
                            role: $(this).find('.wh-role').val(),
                            description: $(this).find('.wh-description').val()
                        });
                    });
                    return list;
                })(),
                job_change_count: parseInt($('#profile-job-change-count').val()) || 0,

                updated_at: new Date().toISOString()
            }

            // ç¤¾å†…ç”¨æƒ…å ±ã®è¿½åŠ  (æ¨©é™ãŒã‚ã‚‹å ´åˆã®ã¿ã€ä¸”ã¤users/profilesã«åˆ†æ•£ã—ã¦ä¿å­˜)
            if (['admin', 'org_admin', 'super_admin', 'coach', 'ca', 'ra'].includes(currentUser.role)) {
                // usersãƒ†ãƒ¼ãƒ–ãƒ«å´
                userUpdates.drive_folder_url = $('#profile-drive-url').val().trim() || null;
                userUpdates.notebooklm_url = $('#profile-notebooklm-url').val().trim() || null;
                userUpdates.line_url = $('#profile-line-url').val().trim() || null;

                // profilesãƒ†ãƒ¼ãƒ–ãƒ«å´
                profileUpdates.resume = $('#profile-resume-detail').val().trim() || null;
                profileUpdates.notes = $('#profile-notes').val().trim() || null;
            }

            try {
                // 1. usersãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
                const { error: userError } = await supabase
                    .from('users')
                    .update(userUpdates)
                    .eq('id', currentUser.id)

                if (userError) throw userError

                // 2. candidate_profilesãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–° (upsert)
                const { error: profileError } = await supabase
                    .from('candidate_profiles')
                    .upsert({ user_id: currentUser.id, ...profileUpdates }, { onConflict: 'user_id' });

                if (profileError) throw profileError

                // Update local cache
                Object.assign(currentUser, userUpdates, profileUpdates)

                alert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼')
            } catch (error) {
                console.error('Save profile error:', error)
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
            } finally {
                hideLoading()
            }
        })

        // ========================
        // Admin: Job Management
        // ========================
        let adminJobsCache = [];
        const ADMIN_JOBS_PER_PAGE = 20;
        let currentAdminJobPage = 1;
        let totalAdminJobPages = 1;

        async function loadCoachStudents() {
            if (!currentUser) {
                console.warn('loadCoachStudents: currentUser is null');
                return;
            }
            console.log('loadCoachStudents START', {
                userId: currentUser.id,
                role: currentUser.role,
                orgId: currentUser.organization_id
            });
            showLoading()
            try {
                // æ‹…å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
                let studentQuery = supabase
                    .from('users')
                    .select('*')
                    .eq('coach_id', currentUser.id)
                    .eq('organization_id', currentUser.organization_id)
                    .order('created_at', { ascending: false });

                console.log('Executing studentQuery...');
                const { data: users, error } = await studentQuery;

                if (error) {
                    console.error('studentQuery error:', error);
                    throw error;
                }

                console.log(`Loaded ${users ? users.length : 0} assigned students`);
                renderCoachStudents(users || [])
            } catch (error) {
                console.error('Load students error:', error)
                alert('æ‹…å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error));
            } finally {
                hideLoading()
            }
        }

        function renderCoachStudents(users) {
            console.log('renderCoachStudents START', users);
            const container = $('#coach-students-container')
            if (container.length === 0) {
                console.error('Error: #coach-students-container not found');
                return;
            }
            container.empty()

            if (!users || users.length === 0) {
                console.log('No assigned students to render');
                container.html('<tr><td colspan="4" class="px-6 py-8 text-center text-gray-500">æ‹…å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“</td></tr>')
                return
            }

            const html = users.map(u => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${u.name || 'åå‰ãªã—'}</div>
                        <div class="text-sm text-gray-500">${u.email || '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${u.created_at ? new Date(u.created_at).toLocaleDateString() : '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <!-- ã“ã“ã«é€²æ—çŠ¶æ³ï¼ˆå¿œå‹Ÿæ•°ãªã©ï¼‰ã‚’è¡¨ç¤ºã§ãã‚‹ã¨è‰¯ã„ -->
                        -
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="viewCandidateProfile('${u.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">
                            è©³ç´°
                        </button>
                    </td>
                </tr>
            `).join('')

            container.html(html)
            console.log('renderCoachStudents DONE');
        }

        // ========================
        // Admin: Job CSV Import
        // ========================
        window.showJobCsvImportModal = function () {
            console.log('DEBUG: showJobCsvImportModal called');
            $('#job-csv-file').val('');
            $('#job-csv-preview').addClass('hidden').empty();
            const $modal = $('#admin-job-csv-modal');
            // è¦ç´ ã‚’bodyã¸ç§»å‹•ï¼ˆäºŒé‡å¯¾ç­–ï¼‰
            $modal.appendTo('body');
            // å¼·åˆ¶çš„ã«è¡¨ç¤ºçŠ¶æ…‹ã«ã™ã‚‹
            $modal.removeClass('hidden').attr('style', 'display: flex !important; z-index: 100000 !important;');
            console.log('DEBUG: Modal visibility forced. visible check:', $modal.is(':visible'));
        }

        window.closeJobCsvImportModal = function () {
            $('#admin-job-csv-modal').addClass('hidden').attr('style', '');
        }

        window.downloadJobCsvTemplate = function (e) {
            e.preventDefault();

            if (typeof jobFields === 'undefined') {
                alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®šç¾©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            // ãƒ˜ãƒƒãƒ€ãƒ¼ç”Ÿæˆ (ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã®å…ˆé ­ã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°ãƒ©ãƒ™ãƒ«)
            // ã“ã‚Œã«ã‚ˆã‚Šã€è¿½åŠ ã•ã‚ŒãŸå…¨é …ç›®ï¼ˆURLã€ç¦åˆ©åšç”Ÿãªã©ï¼‰ãŒè‡ªå‹•çš„ã«åæ˜ ã•ã‚Œã‚‹
            const headers = jobFields.map(f => {
                const name = f.aliases && f.aliases.length > 0 ? f.aliases[0] : f.label;
                return `"${name}"`; // ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã‚€
            });

            // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿1
            const sample1Values = jobFields.map(f => {
                switch (f.key) {
                    case 'title': return 'æ³•äººå–¶æ¥­ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼';
                    case 'company': return 'æ ªå¼ä¼šç¤¾ABC';
                    case 'salary_min': return '600'; // ä¸‡å††
                    case 'salary_max': return '900'; // ä¸‡å††
                    case 'location': return 'æ±äº¬éƒ½æ¸¯åŒº';
                    case 'description': return 'å–¶æ¥­ãƒãƒ¼ãƒ ã®ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã€æˆ¦ç•¥ç«‹æ¡ˆæ¥­å‹™ã‚’ãŠä»»ã›ã—ã¾ã™ã€‚';
                    case 'requirements': return 'æ³•äººå–¶æ¥­çµŒé¨“5å¹´ä»¥ä¸Š';
                    case 'welcome_requirements': return 'ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆçµŒé¨“ãŒã‚ã‚Œã°å°šå¯';
                    case 'work_hours': return '9:00 - 18:00';
                    case 'holidays': return 'åœŸæ—¥ç¥ã€å¹´æœ«å¹´å§‹';
                    case 'employment_type': return 'æ­£ç¤¾å“¡';
                    case 'benefits': return 'ç¤¾ä¼šä¿é™ºå®Œå‚™ã€äº¤é€šè²»å…¨é¡æ”¯çµ¦';
                    case 'is_remote': return 'å¯'; // ã¾ãŸã¯ 'ã‚ã‚Š', 'true'
                    case 'experience_level': return 'ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆçµŒé¨“è€…';
                    case 'industry': return 'ITãƒ»é€šä¿¡';
                    case 'url': return 'https://example.com/recruit/sales-mgr';
                    default: return '';
                }
            });
            const sample1 = sample1Values.map(v => `"${v}"`).join(',');

            // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿2
            const sample2Values = jobFields.map(f => {
                switch (f.key) {
                    case 'title': return 'Webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢';
                    case 'company': return 'ãƒ†ãƒƒã‚¯æ ªå¼ä¼šç¤¾';
                    case 'salary_min': return '500';
                    case 'salary_max': return '800';
                    case 'location': return 'ãƒ•ãƒ«ãƒªãƒ¢ãƒ¼ãƒˆ';
                    case 'description': return 'è‡ªç¤¾ã‚µãƒ¼ãƒ“ã‚¹ã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã‚’æ‹…å½“ã—ã¦ã„ãŸã ãã¾ã™ã€‚';
                    case 'requirements': return 'Javaã§ã®é–‹ç™ºçµŒé¨“3å¹´ä»¥ä¸Š';
                    case 'welcome_requirements': return 'AWSã®é‹ç”¨çµŒé¨“';
                    case 'work_hours': return 'ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ã‚¿ã‚¤ãƒ åˆ¶';
                    case 'holidays': return 'å®Œå…¨é€±ä¼‘2æ—¥åˆ¶';
                    case 'employment_type': return 'æ­£ç¤¾å“¡';
                    case 'benefits': 'æ›¸ç±è³¼å…¥è£œåŠ©ã€ãƒªãƒ¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯æ‰‹å½“';
                    case 'is_remote': return 'ã¯ã„';
                    case 'experience_level': return 'å®Ÿå‹™çµŒé¨“3å¹´ä»¥ä¸Š';
                    case 'industry': return 'Webã‚µãƒ¼ãƒ“ã‚¹';
                    case 'url': return 'https://example.com/recruit/engineer';
                    default: return '';
                }
            });
            const sample2 = sample2Values.map(v => `"${v}"`).join(',');

            const csvContent = headers.join(',') + "\n" + sample1 + "\n" + sample2;
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "job_import_template.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.processJobCsvImport = function () {
            const fileInput = document.getElementById('job-csv-file');
            const file = fileInput.files[0];

            if (!file) {
                alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // å…±é€šã®CSVå‡¦ç†ãƒ•ãƒ­ãƒ¼ï¼ˆãƒãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼‰ã¸å§”è­²
            processCSVFile(file, 'jobs');

            // ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã¯é–‰ã˜ã‚‹
            if (typeof closeJobCsvImportModal === 'function') {
                closeJobCsvImportModal();
            }
        }

        // window.executeCSVImport is defined below in the main CSV processing section


        window.exportJobsCsv = async function () {
            const searchText = $('#admin-job-search').val().trim();
            showLoading('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­...');

            try {
                let query = supabase
                    .from('jobs')
                    .select('*, companies(name)')
                    .eq('organization_id', currentUser.organization_id)
                    .is('deleted_at', null);

                if (searchText) {
                    query = query.or(`title.ilike.%${searchText}%,company.ilike.%${searchText}%`);
                }

                query = query.order('created_at', { ascending: false }).limit(5000); // 5000ä»¶ã¾ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯èƒ½ã«

                const { data: allJobs, error } = await query;

                if (error) throw error;

                if (!allJobs || allJobs.length === 0) {
                    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }

                const csvData = allJobs.map(job => ({
                    title: job.title,
                    company: job.companies ? job.companies.name : job.company,
                    salary_min: job.salary_min,
                    salary_max: job.salary_max,
                    location: job.location,
                    description: job.description,
                    requirements: job.requirements,
                    welcome_requirements: job.welcome_requirements,
                    created_at: new Date(job.created_at).toLocaleString()
                }));

                const csv = Papa.unparse(csvData);
                const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `jobs_export_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error('Export error:', error);
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            } finally {
                hideLoading();
            }
        }

        window.loadAdminJobs = async function (page = 1, searchText = '') {
            if (!currentUser) return

            // UIæ›´æ–°: Googleãƒ‰ãƒ©ã‚¤ãƒ–ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
            const orgSettings = currentUser.organizations?.settings || {};
            $('#admin-job-drive-import-btn').toggleClass('hidden', !orgSettings.drive_import_enabled);

            showLoading()
            try {
                let query = supabase
                    .from('jobs')
                    .select('*, companies(name)', { count: 'exact' }) // Join with companies
                    .eq('organization_id', currentUser.organization_id)
                    .is('deleted_at', null)

                if (searchText) {
                    query = query.or(`title.ilike.%${searchText}%,company.ilike.%${searchText}%`)
                }

                query = query.order('created_at', { ascending: false })

                // Pagination
                currentAdminJobPage = page;
                const from = (page - 1) * ADMIN_JOBS_PER_PAGE;
                const to = from + ADMIN_JOBS_PER_PAGE - 1;

                const { data: jobs, error, count } = await query.range(from, to);

                if (error) throw error

                totalAdminJobPages = count ? Math.ceil(count / ADMIN_JOBS_PER_PAGE) : 1;
                adminJobsCache = jobs || [];
                renderAdminJobs(adminJobsCache, count);
                renderAdminJobPagination();
            } catch (error) {
                console.error('Load admin jobs error:', error)
                $('#admin-jobs-container').html('<p class="text-red-500">æ±‚äººã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>')
            } finally {
                hideLoading()
            }
        }

        const debouncedLoadAdminJobs = debounce((text) => loadAdminJobs(1, text), 500);

        window.filterAdminJobs = function () {
            const searchText = $('#admin-job-search').val().trim();
            debouncedLoadAdminJobs(searchText);
        }

        function renderAdminJobPagination() {
            const container = $('#admin-job-pagination-container');
            if (!container.length) {
                $('#admin-jobs-container').after('<div id="admin-job-pagination-container" class="mt-6 flex justify-center gap-2"></div>');
            }
            const $container = $('#admin-job-pagination-container');

            if (totalAdminJobPages <= 1) {
                $container.html('');
                return;
            }

            let html = '';
            // Previous
            html += `<button onclick="loadAdminJobs(${currentAdminJobPage - 1}, $('#admin-job-search').val())" 
                        class="px-3 py-1 rounded border ${currentAdminJobPage === 1 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'hover:bg-gray-100 text-gray-700'}" 
                        ${currentAdminJobPage === 1 ? 'disabled' : ''}>å‰ã¸</button>`;

            // Page numbers (simplified)
            const maxButtons = 5;
            let start = Math.max(1, currentAdminJobPage - 2);
            let end = Math.min(totalAdminJobPages, start + maxButtons - 1);
            if (end - start + 1 < maxButtons) {
                start = Math.max(1, end - maxButtons + 1);
            }

            for (let i = start; i <= end; i++) {
                html += `<button onclick="loadAdminJobs(${i}, $('#admin-job-search').val())" 
                            class="px-3 py-1 rounded border ${i === currentAdminJobPage ? 'bg-indigo-600 text-white' : 'hover:bg-gray-100 text-gray-700'}">${i}</button>`;
            }

            // Next
            html += `<button onclick="loadAdminJobs(${currentAdminJobPage + 1}, $('#admin-job-search').val())" 
                        class="px-3 py-1 rounded border ${currentAdminJobPage === totalAdminJobPages ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'hover:bg-gray-100 text-gray-700'}" 
                        ${currentAdminJobPage === totalAdminJobPages ? 'disabled' : ''}>æ¬¡ã¸</button>`;

            $container.html(html);
        }

        function renderAdminJobs(jobs, totalCount) {
            const container = $('#admin-jobs-container')
            container.empty()

            // ä»¶æ•°è¡¨ç¤ºã‚’è¿½åŠ 
            if (totalCount !== undefined) {
                container.append(`<p class="text-sm text-gray-600 mb-4">å…¨ ${totalCount.toLocaleString()} ä»¶ä¸­ ${jobs.length} ä»¶ã‚’è¡¨ç¤º</p>`);
            }

            if (jobs.length === 0) {
                container.append('<p class="text-gray-500 text-center py-8">è©²å½“ã™ã‚‹æ±‚äººãŒã‚ã‚Šã¾ã›ã‚“</p>')
                return
            }

            const statusBadge = (status) => {
                const config = {
                    'active': { label: 'å…¬é–‹ä¸­', color: 'bg-green-100 text-green-800' },
                    'draft': { label: 'ä¸‹æ›¸ã', color: 'bg-gray-100 text-gray-800' },
                    'closed': { label: 'å‹Ÿé›†çµ‚äº†', color: 'bg-red-100 text-red-800' }
                }
                const s = config[status] || config['draft']
                return `<span class="px-2 py-1 rounded text-xs font-medium ${s.color}">${s.label}</span>`
            }

            const html = jobs.map(job => `
                <div class="bg-white border border-gray-200 rounded-lg p-6 mb-4">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h3 class="text-lg font-bold text-gray-900">${job.title}</h3>
                                ${statusBadge(job.status)}
                            </div>
                            <p class="text-gray-600 text-sm">${job.companies ? job.companies.name : job.company}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick='openEditJobModal("${job.id}")' class="text-indigo-600 hover:text-indigo-800 px-3 py-1 text-sm">
                                <i class="fas fa-edit mr-1"></i>ç·¨é›†
                            </button>
                            <button onclick="deleteJob('${job.id}')" class="text-red-600 hover:text-red-800 px-3 py-1 text-sm">
                                <i class="fas fa-trash mr-1"></i>å‰Šé™¤
                            </button>
                        </div>
                    </div>
                    <p class="text-gray-600 text-sm line-clamp-2">${job.description || ''}</p>
                </div>
            `).join('')

            container.html(html)
        }

        window.deleteJob = async function (jobId) {
            if (!confirm('ã“ã®æ±‚äººã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return

            showLoading()
            try {
                const { error } = await supabase
                    .from('jobs')
                    .update({ deleted_at: new Date().toISOString() })
                    .eq('id', jobId)

                if (error) throw error

                alert('å‰Šé™¤ã—ã¾ã—ãŸ')
                loadAdminJobs()
            } catch (error) {
                console.error('Delete job error:', error)
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
            } finally {
                hideLoading()
            }
        }

        // æ¥­ç¨®ãƒã‚¹ã‚¿ä¸€æ‹¬æ›´æ–°ç”¨é–¢æ•°
        window.updateIndustryCategoriesMaster = async function () {
            if (!currentUser || !currentUser.organization_id) {
                alert('çµ„ç¹”æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
                return;
            }
            if (currentUser.role !== 'super_admin') {
                alert('ã“ã®æ“ä½œã¯ã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…ã®ã¿å¯èƒ½ã§ã™ã€‚');
                return;
            }
            if (!confirm('è‡ªçµ„ç¹”ã®æ¥­ç¨®ãƒã‚¹ã‚¿ã‚’åˆæœŸåŒ–ã—ã¦ã€æ–°ã—ã„ãƒªã‚¹ãƒˆã§æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ\næ—¢å­˜ã®æ¥­ç¨®ã‚«ãƒ†ã‚´ãƒªã¯å…¨ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) return;

            const newIndustryCategories = [
                "ITãƒ»é€šä¿¡ãƒ»ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ",
                "ãƒ¡ãƒ¼ã‚«ãƒ¼ï¼ˆæ©Ÿæ¢°ãƒ»é›»æ°—ãƒ»é›»å­ï¼‰",
                "ãƒ¡ãƒ¼ã‚«ãƒ¼ï¼ˆç´ æãƒ»åŒ–å­¦ãƒ»é£Ÿå“ãƒ»ãã®ä»–ï¼‰",
                "å•†ç¤¾ï¼ˆç·åˆãƒ»å°‚é–€ï¼‰",
                "é‡‘èãƒ»ä¿é™º",
                "å»ºè¨­ãƒ»ä¸å‹•ç”£ãƒ»ä½å®…",
                "ç‰©æµãƒ»é‹è¼¸",
                "æµé€šãƒ»å°å£²ãƒ»ã‚µãƒ¼ãƒ“ã‚¹",
                "åºƒå‘Šãƒ»å‡ºç‰ˆãƒ»ãƒã‚¹ã‚³ãƒŸ",
                "ã‚³ãƒ³ã‚µãƒ«ãƒ†ã‚£ãƒ³ã‚°ãƒ»èª¿æŸ»",
                "äººæã‚µãƒ¼ãƒ“ã‚¹",
                "åŒ»ç™‚ãƒ»åŒ»è–¬ãƒ»ç¦ç¥‰",
                "æ•™è‚²ãƒ»å®˜å…¬åºãƒ»ãã®ä»–",
                "ã‚¨ãƒãƒ«ã‚®ãƒ¼ãƒ»ã‚¤ãƒ³ãƒ•ãƒ©",
                "æ—…è¡Œãƒ»å®¿æ³Šãƒ»ãƒ¬ã‚¸ãƒ£ãƒ¼",
                "ãã®ä»–"
            ];

            try {
                // 1. æ—¢å­˜ã®æ¥­ç¨®ã‚«ãƒ†ã‚´ãƒªã‚’å‰Šé™¤ (è‡ªçµ„ç¹”ã®ã¿å¯¾è±¡)
                const { error: deleteError } = await supabase
                    .from('master_data')
                    .delete()
                    .eq('type', 'industry_category')
                    .eq('organization_id', currentUser.organization_id);

                if (deleteError) throw deleteError;

                // 2. æ–°ã—ã„æ¥­ç¨®ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ 
                const insertData = newIndustryCategories.map((label, index) => ({
                    type: 'industry_category',
                    label: label,
                    value: label,
                    sort_order: (index + 1) * 10,
                    is_active: true,
                    organization_id: currentUser.organization_id
                }));

                const { error } = await supabase
                    .from('master_data')
                    .insert(insertData);

                if (error) throw error;

                alert('æ¥­ç¨®ãƒã‚¹ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ');
                // ãƒã‚¹ã‚¿ç®¡ç†ç”»é¢ãŒé–‹ã„ã¦ã„ã‚Œã°å†èª­ã¿è¾¼ã¿
                if ($('#admin-master-content').is(':visible')) {
                    loadMasterData();
                }

            } catch (error) {
                console.error('Failed to update industry categories:', error);
                alert('æ¥­ç¨®ãƒã‚¹ã‚¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        window.deleteUser = async function (userId) {
            if (!confirm('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆè«–ç†å‰Šé™¤ã•ã‚Œã€ä¸€è¦§ã‹ã‚‰éè¡¨ç¤ºã«ãªã‚Šã¾ã™ï¼‰')) return

            showLoading()
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ deleted_at: new Date().toISOString() })
                    .eq('id', userId)

                if (error) throw error

                alert('å‰Šé™¤ã—ã¾ã—ãŸ')

                // ãƒªãƒ­ãƒ¼ãƒ‰
                if ($('#admin-users-content').is(':visible')) {
                    loadAdminUsers();
                } else if ($('#admin-candidates-content').is(':visible')) {
                    loadAdminCandidates();
                }
            } catch (error) {
                console.error('Delete user error:', error)
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
            } finally {
                hideLoading()
            }
        }

        window.openEditJobModal = function (jobId) {
            showJobForm(jobId)
        }

        // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é¸æŠè‚¢ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        async function loadMasterOptions(type, selectId, selectedValue = null) {
            try {
                const { data: masters, error } = await supabase
                    .from('master_data')
                    .select('*')
                    .eq('type', type)
                    .eq('is_active', true)
                    .order('sort_order', { ascending: true })

                if (error) throw error

                // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ« ã¾ãŸã¯ è‡ªç¤¾ç”¨ï¼‰
                const validMasters = masters.filter(m =>
                    m.organization_id === null || m.organization_id === currentUser.organization_id
                )

                const select = $(`#${selectId}`)
                select.empty()

                if (validMasters.length > 0) {
                    validMasters.forEach(m => {
                        const option = $('<option></option>').val(m.value).text(m.label)
                        if (selectedValue && m.value === selectedValue) {
                            option.prop('selected', true)
                        }
                        select.append(option)
                    })
                } else {
                    // ãƒã‚¹ã‚¿ãŒãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                    const fallbacks = {
                        'employment_type': ['æ­£ç¤¾å“¡', 'å¥‘ç´„ç¤¾å“¡', 'æ´¾é£ç¤¾å“¡', 'æ¥­å‹™å§”è¨—'],
                        'job_category': ['ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢', 'å–¶æ¥­', 'ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼', 'ãã®ä»–']
                    }
                    const options = fallbacks[type] || []
                    options.forEach(opt => {
                        const option = $('<option></option>').val(opt).text(opt)
                        if (selectedValue && opt === selectedValue) {
                            option.prop('selected', true)
                        }
                        select.append(option)
                    })
                }
            } catch (error) {
                console.error(`Load master options error (${type}):`, error)
            }
        }

        window.showJobForm = async function (jobId = null) {
            // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒæœªãƒ­ãƒ¼ãƒ‰ãªã‚‰ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
            if (masterJobCategories.length === 0 || masterIndustries.length === 0) {
                await initMasterDataDropdowns();
            }

            $('#job-form')[0].reset()
            $('#job-id').val('')
            $('#job-drive-pdf-url').val('') // Clear hidden field


            try {
                // ä¼æ¥­é¸æŠè‚¢ï¼ˆSelect2ï¼‰ã®åˆæœŸåŒ–
                const select = $('#job-company-select');

                // Select2 ã‚’ä¸€åº¦ç ´æ£„
                if (select.hasClass('select2-hidden-accessible')) {
                    select.select2('destroy');
                }
                select.empty();

                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ç‰¹å®šã®ä¼æ¥­ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãã®ä¼æ¥­æƒ…å ±ã‚’å–å¾—ã—ã¦é¸æŠè‚¢ã«è¿½åŠ 
                if (jobId) {
                    try {
                        // æ±‚äººæƒ…å ±ã‚’å–å¾—ã—ã¦ä¼šç¤¾IDã‚’ç¢ºèª
                        const { data: jobInfo } = await supabase.from('jobs').select('company_id').eq('id', jobId).single();
                        if (jobInfo && jobInfo.company_id) {
                            const { data: comp } = await supabase.from('companies').select('id, name').eq('id', jobInfo.company_id).single();
                            if (comp) {
                                select.append(new Option(comp.name, comp.id, true, true));
                            }
                        }
                    } catch (e) {
                        console.error('Failed to pre-fetch company for job edit:', e);
                    }
                }

                // Select2 ã‚’ AJAX ãƒ¢ãƒ¼ãƒ‰ã§åˆæœŸåŒ–
                select.select2({
                    placeholder: "ä¼æ¥­ã‚’æ¤œç´¢ã¾ãŸã¯é¸æŠ",
                    allowClear: true,
                    width: '100%',
                    dropdownParent: $('#job-modal'),
                    language: {
                        searching: function () { return "æ¤œç´¢ä¸­..."; },
                        noResults: function () { return "è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"; },
                        inputTooShort: function () { return "1æ–‡å­—ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„"; }
                    },
                    ajax: {
                        delay: 250,
                        transport: async function (params, success, failure) {
                            try {
                                const searchText = params.data.q;
                                let query = supabase
                                    .from('companies')
                                    .select('id, name')
                                    .eq('organization_id', currentUser.organization_id)
                                    .is('deleted_at', null)
                                    .order('name');

                                if (searchText) {
                                    query = query.ilike('name', `%${searchText}%`);
                                }

                                const { data, error } = await query.limit(20);
                                if (error) throw error;

                                let results = data.map(c => ({ id: c.id, text: c.name }));

                                // ã€Œæ–°è¦ä¼æ¥­ã‚’ä½œæˆã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ¤œç´¢çµæœã®å…ˆé ­ã«è¿½åŠ 
                                if (!searchText || "+ æ–°è¦ä¼æ¥­ã‚’ä½œæˆ".includes(searchText)) {
                                    results.unshift({ id: 'new', text: '+ æ–°è¦ä¼æ¥­ã‚’ä½œæˆ' });
                                }

                                success({ results });
                            } catch (e) {
                                console.error('Select2 Fetch Error:', e);
                                failure(e);
                            }
                        }
                    }
                });

                // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã®è¨­å®š
                select.off('change').on('change', function () {
                    handleCompanySelect($(this).val());
                });

            } catch (e) {
                console.error('Failed to load companies for select:', e);
            }

            // æ‹…å½“è€…ãƒªã‚¹ãƒˆã®ãƒ­ãƒ¼ãƒ‰ (ç®¡ç†è€…ãƒ»ã‚³ãƒ¼ãƒãƒ»CA)
            try {
                const { data: picUsers } = await supabase
                    .from('users')
                    .select('id, name')
                    .eq('organization_id', currentUser.organization_id)
                    .in('role', ['admin', 'super_admin', 'coach', 'ca', 'org_admin'])
                    .neq('management_status', 'inactive')
                    .order('name');

                const picSelect1 = $('#job-pic-user-1');
                const picSelect2 = $('#job-pic-user-2');

                const defaultOption = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
                picSelect1.empty().append(defaultOption);
                picSelect2.empty().append(defaultOption);

                if (picUsers) {
                    picUsers.forEach(u => {
                        const option = `<option value="${u.id}">${u.name}</option>`;
                        picSelect1.append(option);
                        picSelect2.append(option);
                    });
                }
            } catch (e) {
                console.error('Failed to load users for PIC select:', e);
            }

            // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–ï¼ˆå€¤ãªã—ï¼‰
            populateSelectOptions('job-employment-type', ['æ­£ç¤¾å“¡', 'å¥‘ç´„ç¤¾å“¡', 'æ´¾é£ç¤¾å“¡', 'æ¥­å‹™å§”è¨—']);

            populateSelectOptions('job-category', masterJobCategories);
            populateSelectOptions('job-industry-category', masterIndustries);

            if (jobId) {
                $('#job-modal-title').text('æ±‚äººç·¨é›†')
                $('#job-id').val(jobId)

                // ç·¨é›†æ™‚ã¯ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã‚»ãƒƒãƒˆ
                const { data: job } = await supabase
                    .from('jobs')
                    .select('*')
                    .eq('id', jobId)
                    .single()

                if (job) {
                    $('#job-title').val(job.title)
                    $('#job-company-id').val(job.company_id)
                    // Select2 ã®å€¤ã‚’ã‚»ãƒƒãƒˆ
                    $('#job-company-select').val(job.company_id).trigger('change');

                    $('#job-location').val(job.location)
                    if (job.salary_min) $('#job-salary-min').val(job.salary_min / 10000)
                    if (job.salary_max) $('#job-salary-max').val(job.salary_max / 10000)
                    $('#job-description').val(job.description)
                    $('#job-work-hours').val(job.work_hours)
                    $('#job-holidays').val(job.holidays)
                    $('#job-benefits').val(job.benefits)
                    $('#job-interview-process').val(job.interview_process)
                    // Requirements and Welcome Requirements
                    $('#job-requirements').val(job.requirements || '')
                    $('#job-welcome-requirements').val(job.welcome_requirements || '')

                    // è¿½åŠ é …ç›®
                    $('#job-url').val(job.url || '');
                    $('#job-pic-user-1').val(job.pic_user_id_1 || '');
                    $('#job-pic-user-2').val(job.pic_user_id_2 || '');
                    $('#job-pdf-filename').val(job.pdf_filename || '');

                    // Google Drive URLã®èª­ã¿è¾¼ã¿
                    const orgSettings = currentUser.organizations?.settings || {};
                    const driveCol = orgSettings.drive_column || 'pdf_url';
                    $('#job-drive-pdf-url').val(job[driveCol] || '');


                    $('#job-employment-type').val(job.employment_type)
                    $('#job-is-remote').prop('checked', job.is_remote)
                    $('#job-experience-ok').prop('checked', job.job_experience_ok === 'å¯')
                    $('#job-industry-experience-ok').prop('checked', job.industry_experience_ok === 'å¯')

                    // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿é¸æŠè‚¢ã®å†è¨­å®š (selected valueã‚’åæ˜ )
                    // populateSelectOptions ã¯ãƒã‚¹ã‚¿ã«ãªã„å€¤ã‚‚è¿½åŠ ã—ã¦ãã‚Œã‚‹
                    populateSelectOptions('job-category', masterJobCategories, job.job_category);
                    populateSelectOptions('job-industry-category', masterIndustries, job.industry_category);
                }
            } else {
                $('#job-modal-title').text('æ±‚äººä½œæˆ')
                // æ–°è¦ä½œæˆæ™‚ã¯ Select2 ã‚’ãƒªã‚»ãƒƒãƒˆ
                $('#job-company-select').val('').trigger('change');
            }
            $('#job-modal').removeClass('hidden')
        }

        window.handleCompanySelect = function (value) {
            if (value === 'new') {
                // æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ããªã©ã®å‡¦ç†ãŒå¿…è¦ã ãŒã€
                // ã“ã“ã§ã¯ç°¡æ˜“çš„ã«ã€Œä¼æ¥­ç®¡ç†ç”»é¢ã§ä½œæˆã—ã¦ãã ã•ã„ã€ã¨æ¡ˆå†…ã™ã‚‹ã‹ã€
                // ã‚ã‚‹ã„ã¯CompanyModalã‚’é‡ã­ã¦é–‹ãã€‚
                // é‡ã­ã¦é–‹ãã®ã¯Z-indexç®¡ç†ãŒé¢å€’ãªã®ã§ã€ä¸€æ—¦ã‚¢ãƒ©ãƒ¼ãƒˆã§æ¡ˆå†…ã€‚
                if (confirm('æ–°ã—ã„ä¼æ¥­ã‚’ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ\nOKã‚’æŠ¼ã™ã¨ä¼æ¥­ç™»éŒ²ç”»é¢ãŒé–‹ãã¾ã™ã€‚\nï¼ˆç¾åœ¨ã®å…¥åŠ›å†…å®¹ã¯ç ´æ£„ã•ã‚Œã¾ã™ï¼‰')) {
                    closeJobModal();
                    showCompanyForm();
                } else {
                    $('#job-company-select').val('');
                }
            } else {
                $('#job-company-id').val(value);
            }
        }

        window.closeJobModal = function () {
            $('#job-modal').addClass('hidden')
            $('#job-form')[0].reset()
        }

        $('#job-form').on('submit', async function (e) {
            e.preventDefault()
            showLoading()

            const jobId = $('#job-id').val()
            const salaryMin = $('#job-salary-min').val()
            const salaryMax = $('#job-salary-max').val()

            const jobData = {
                organization_id: currentUser.organization_id,
                title: $('#job-title').val(),
                company_id: $('#job-company-id').val(),
                company: $('#job-company-select option:selected').text(), // Legacy support but required by DB constraint
                location: $('#job-location').val(),
                employment_type: $('#job-employment-type').val(),
                salary_min: salaryMin ? parseInt(salaryMin) * 10000 : null,
                salary_max: salaryMax ? parseInt(salaryMax) * 10000 : null,
                job_category: $('#job-category').val() || null,
                industry_category: $('#job-industry-category').val() || null,
                job_experience_ok: $('#job-experience-ok').is(':checked') ? 'å¯' : 'ä¸å¯',
                industry_experience_ok: $('#job-industry-experience-ok').is(':checked') ? 'å¯' : 'ä¸å¯',
                description: $('#job-description').val(),
                requirements: $('#job-requirements').val(),
                welcome_requirements: $('#job-welcome-requirements').val(),
                status: $('#job-status').val(),
                is_remote: $('#job-is-remote').is(':checked'),
                work_hours: $('#job-work-hours').val(),
                holidays: $('#job-holidays').val(),
                benefits: $('#job-benefits').val(),
                interview_process: $('#job-interview-process').val(),
                url: $('#job-url').val() || null,
                pic_user_id_1: $('#job-pic-user-1').val() || null,
                pic_user_id_2: $('#job-pic-user-2').val() || null,
                pdf_filename: $('#job-pdf-filename').val() || null,
                updated_at: new Date().toISOString()
            }

            // Google Drive URLã®å‹•çš„ã‚«ãƒ©ãƒ ä¿å­˜
            const orgSettings = currentUser.organizations?.settings || {};
            const drivePdfUrl = $('#job-drive-pdf-url').val();
            if (drivePdfUrl) {
                const driveCol = orgSettings.drive_column || 'pdf_url';
                jobData[driveCol] = drivePdfUrl;
            }

            if (!jobData.company_id) {
                alert('ä¼æ¥­ã‚’é¸æŠã—ã¦ãã ã•ã„');
                hideLoading();
                return;
            }

            try {
                if (jobId) {
                    // Update
                    const { error } = await supabase
                        .from('jobs')
                        .update(jobData)
                        .eq('id', jobId)

                    if (error) throw error

                    // ãƒ­ã‚°è¨˜éŒ²
                    await auditLog.jobUpdated(jobId, { title: jobData.title });

                    alert('æ±‚äººã‚’æ›´æ–°ã—ã¾ã—ãŸ')
                } else {
                    // Create
                    const { data: newJob, error } = await supabase
                        .from('jobs')
                        .insert(jobData)
                        .select()
                        .single()

                    if (error) throw error

                    // ãƒ­ã‚°è¨˜éŒ²
                    if (newJob) {
                        await auditLog.jobCreated(newJob.id, { title: jobData.title });
                    }

                    alert('æ±‚äººã‚’ä½œæˆã—ã¾ã—ãŸ')
                }

                closeJobModal()
                loadAdminJobs()
            } catch (error) {
                console.error('Save job error:', error)
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
            } finally {
                hideLoading()
            }
        })

        // ========================
        // ========================
        // Admin: Candidate Management
        // ========================
        let adminCandidatesCache = [];
        // ========================
        // Admin: User Edit Modal Logic
        // ========================
        let adminCoachesCache = [];

        async function loadAdminCoaches() {
            // ã‚³ãƒ¼ãƒã€CAã€RAã«åŠ ãˆã¦ç®¡ç†è€…ã‚‚æ‹…å½“è€…ã¨ã—ã¦å–å¾—å¯èƒ½ã«ã™ã‚‹
            const { data: coaches } = await supabase
                .from('users')
                .select('id, name, role, status, management_status')
                .eq('organization_id', currentUser.organization_id)
                .in('role', ['coach', 'ca', 'ra', 'admin', 'org_admin']);
            // åœæ­¢ä¸­ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯ç®¡ç†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œæ´»å‹•çµ‚äº†ã€ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é™¤å¤–
            adminCoachesCache = (coaches || []).filter(u => u.status !== 'suspended' && (u.management_status !== 'inactive'));
        }

        window.showAdminUserModal = async function (userId) {
            console.log('showAdminUserModal called with userId:', userId);
            if (!currentUser) return;

            // Reset modal ready flag to prevent premature submission
            isModalReady = false;

            // ã‚³ãƒ¼ãƒãƒªã‚¹ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ï¼ˆæœªãƒ­ãƒ¼ãƒ‰ã®å ´åˆï¼‰
            if (adminCoachesCache.length === 0) {
                await loadAdminCoaches();
            }

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
            const { data: userData, error } = await supabase
                .from('users')
                .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                .eq('id', userId)
                .single();

            if (error || !userData) {
                console.error('Error fetching user:', error);
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                return;
            }

            console.log('Fetched userData:', userData);
            console.log('candidate_profiles:', userData.candidate_profiles);

            // ãƒ•ãƒ©ãƒƒãƒˆåŒ–
            const profile = Array.isArray(userData.candidate_profiles) ? userData.candidate_profiles[0] : userData.candidate_profiles;
            const user = { ...userData, ...profile };
            user.id = userData.id; // IDç¢ºä¿

            console.log('Merged user object:', {
                desired_job_type: user.desired_job_type,
                desired_industry: user.desired_industry,
                desired_employment_type: user.desired_employment_type,
                desired_location: user.desired_location
            });

            // æ¨©é™ãƒã‚§ãƒƒã‚¯: ã‚³ãƒ¼ãƒ/CA/RAã¯æ‹…å½“æ±‚è·è€…ã®ã¿ç·¨é›†å¯èƒ½
            if (['coach', 'ca', 'ra'].includes(currentUser.role)) {
                if (user.role !== 'candidate' || user.coach_id !== currentUser.id) {
                    alert('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç·¨é›†ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
            }

            // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’ã‚»ãƒƒãƒˆ
            $('#admin-user-id').val(user.id);
            $('#admin-user-name').val(user.name);
            $('#admin-user-furigana').val(user.furigana || '');
            $('#admin-user-email').val(user.email);
            $('#admin-user-new-password').val(''); // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ (æ–°è¦è¿½åŠ )

            // æ¨©é™ãƒ©ãƒ™ãƒ«ã®æ›´æ–°
            const $roleSelect = $('#admin-user-role');
            $roleSelect.find('option[value="org_admin"]').text(getRoleLabel('org_admin'));
            $roleSelect.find('option[value="admin"]').text(getRoleLabel('admin'));
            $roleSelect.find('option[value="coach"]').text(getRoleLabel('coach'));
            $roleSelect.find('option[value="candidate"]').text(getRoleLabel('candidate'));

            $roleSelect.val(user.role);
            $('#admin-user-status').val(user.status || 'active');
            $('#admin-user-management-status').val(user.management_status || 'active');

            // æ¨©é™å¤‰æ›´ã®åˆ¶å¾¡: ç®¡ç†è€…ã®ã¿å¯èƒ½
            if (['org_admin', 'admin', 'super_admin'].includes(currentUser.role)) {
                $('#admin-user-role-container').show();
                $('#admin-user-coach-container').show();
                $('#admin-user-coach').prop('disabled', false);

                // ãƒãƒ¼ãƒ ãƒªã‚¹ãƒˆã®ãƒ­ãƒ¼ãƒ‰
                const { data: teams } = await window.supabase
                    .from('teams')
                    .select('*')
                    .eq('organization_id', currentUser.organization_id)
                    .order('display_order');

                if (teams) {
                    const teamSelect = $('#admin-user-team');
                    teamSelect.empty().append('<option value="">æœªè¨­å®š</option>');
                    teams.forEach(t => {
                        const indent = '&nbsp;'.repeat((t.level - 1) * 4);
                        teamSelect.append(`<option value="${t.id}">${indent}${t.name}</option>`);
                    });
                    if (user.team_id) teamSelect.val(user.team_id);
                }
            } else {
                $('#admin-user-role-container').hide();
                $('#admin-user-coach-container').hide();
                $('#admin-user-team').closest('div').hide();
            }

            // æ±‚è·è€…ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤ºåˆ¶å¾¡
            if (user.role === 'candidate') {
                $('#admin-candidate-fields').removeClass('hidden');

                // ã‚³ãƒ¼ãƒãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®ç”Ÿæˆ
                const coachSelect = $('#admin-user-coach');
                coachSelect.empty();
                coachSelect.append('<option value="">æœªè¨­å®š</option>');
                adminCoachesCache.forEach(c => {
                    const roleLabel = `(${getRoleLabel(c.role)})`;
                    coachSelect.append(`<option value="${c.id}">${c.name} ${roleLabel}</option>`);
                });
                if (user.coach_id) {
                    coachSelect.val(user.coach_id);
                }

                // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ & å€¤ã‚»ãƒƒãƒˆ
                try {
                    console.log('Loading master data for user:', user);
                    await loadMasterDataForProfile(user);

                    // loadMasterDataForProfileå†…ã§æ—¢ã«Select2ã®åˆæœŸåŒ–ã¨å€¤ã®ã‚»ãƒƒãƒˆãŒå®Œäº†ã—ã¦ã„ã‚‹
                    console.log('Master data loaded and values set successfully');
                } catch (err) {
                    console.error('Failed to load master data:', err);
                    // ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã‚‚ãƒ•ã‚©ãƒ¼ãƒ ã¯é–‹ãã‚ˆã†ã«ã™ã‚‹ï¼ˆãŸã ã—å€¤ã¯ã‚»ãƒƒãƒˆã•ã‚Œãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ï¼‰
                }

                const salary = user.desired_salary ? Math.floor(user.desired_salary / 10000) : '';
                // ç•°å¸¸å€¤ï¼ˆ10å„„å††ä»¥ä¸Šãªã©ã€Int32ä¸Šé™ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ç”±æ¥ã®å€¤ï¼‰ã¯è¡¨ç¤ºã—ãªã„
                // ç•°å¸¸å€¤ï¼ˆ10å„„å††ä»¥ä¸Šãªã©ã€Int32ä¸Šé™ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ç”±æ¥ã®å€¤ï¼‰ã¯è¡¨ç¤ºã—ãªã„
                $('#admin-user-salary').val(salary > 100000 ? '' : salary);
                $('#admin-user-birth-date').val(user.birth_date || '');
                $('#admin-user-age').val(user.age || '');
                $('#admin-user-education').val(user.education || '');
                $('#admin-user-skills').val(user.skills || '');
                $('#admin-user-history').val(user.work_history || '');
                $('#admin-user-work-history-detail').val(user.work_history_detail || '');
                $('#admin-user-history-info').val(user.history_info || '');


                // è¿½åŠ è©³ç´°é …ç›®ã®ã‚»ãƒƒãƒˆ
                $('#admin-user-phone').val(user.phone || '');
                $('#admin-user-job-exp-ok').prop('checked', user.desired_job_experience_ok);
                $('#admin-user-industry-exp-ok').prop('checked', user.desired_industry_experience_ok);
                $('#admin-user-work-history-detail').val(user.work_history || '');
                $('#admin-user-resume-detail').val(user.resume || '');
                $('#admin-user-notes').val(user.notes || '');
                $('#admin-user-drive-url').val(user.drive_folder_url || '');
                $('#admin-user-notebooklm-url').val(user.notebooklm_url || '');
                $('#admin-user-line-url').val(user.line_url || '');

                // è©³ç´°è·æ­´
                console.log('Rendering work history list...');
                $('#work-history-list').empty();
                if (user.work_history_structured && Array.isArray(user.work_history_structured)) {
                    user.work_history_structured.forEach(item => addWorkHistoryItem(item));
                }
                updateJobChangeCount();
                console.log('Work history rendering complete');

            } else {
                console.log('User is not a candidate, skipping candidate fields');
                $('#admin-candidate-fields').addClass('hidden');
            }
            console.log('Forcing modal visibility (z-index 99999)...');
            const modal = $('#admin-user-modal');
            if (modal.length === 0) {
                console.error('CRITICAL: #admin-user-modal not found!');
                return;
            }
            // Move to body to avoid parent clipping
            $('body').append(modal);
            modal.removeClass('hidden').attr('style', 'display: flex !important; z-index: 99999 !important; visibility: visible !important; opacity: 1 !important;');
            console.log('showAdminUserModal process finished');

            // Set modal ready flag after everything is loaded
            setTimeout(() => {
                isModalReady = true;
                console.log('Modal is now ready for submission');
            }, 100);
        }

        window.closeAdminUserModal = function () {
            console.log('--- closeAdminUserModal Triggered ---');
            console.trace('closeAdminUserModal called from:');

            // Reset the ready flag
            isModalReady = false;

            $('#admin-user-modal').addClass('hidden').attr('style', 'display: none !important;');
        }

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°å‡¦ç† (æ–°è¦è¿½åŠ )
        window.updateUserPassword = async function () {
            const userId = $('#admin-user-id').val();
            const newPassword = $('#admin-user-new-password').val();

            if (!userId) {
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            if (!newPassword || newPassword.length < 6) {
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (!confirm('æœ¬å½“ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            showLoading();
            try {
                const { data, error } = await supabase.functions.invoke('update-user-password', {
                    body: { userId, newPassword }
                });

                if (error) throw error;
                if (data && data.success === false) throw new Error(data.error);

                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                $('#admin-user-new-password').val(''); // ã‚¯ãƒªã‚¢
            } catch (error) {
                console.error('Password update error:', error);
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // è·æ­´ãƒªã‚¹ãƒˆæ“ä½œé–¢æ•° (æ±ç”¨åŒ–)
        window.addWorkHistoryItemToContainer = function (containerSelector, data = {}) {
            const container = $(containerSelector);
            const count = container.children().length;
            if (count >= 10) {
                alert('è·æ­´é …ç›®ã¯æœ€å¤§10ä»¶ã¾ã§ã§ã™ã€‚');
                return;
            }
            const index = count + 1;
            const targetCountId = containerSelector === '#work-history-list' ? '#admin-user-job-change-count' : '#profile-job-change-count';

            const $item = $(`
                <div class="work-history-item bg-gray-50 p-4 rounded-lg border border-gray-200 relative mb-4">
                    <button type="button" onclick="$(this).closest('.work-history-item').remove(); updateJobChangeCountInContainer('${containerSelector}', '${targetCountId}');" 
                        class="absolute top-2 right-2 text-gray-400 hover:text-red-500 w-6 h-6 flex items-center justify-center rounded-full hover:bg-gray-200 transition">
                        <i class="fas fa-times"></i>
                    </button>
                    <h5 class="text-sm font-bold text-indigo-700 mb-2">è·æ­´ ${index}</h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">ä¼šç¤¾å</label>
                            <input type="text" class="wh-company w-full px-3 py-2 border rounded text-sm bg-white" placeholder="ä¼šç¤¾å">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">åœ¨ç±æœŸé–“</label>
                            <input type="text" class="wh-period w-full px-3 py-2 border rounded text-sm bg-white" placeholder="ä¾‹: 2020/04 - 2023/03">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">æ‰€å±ä¼æ¥­ã®æ¥­ç¨®</label>
                            <input type="text" class="wh-industry w-full px-3 py-2 border rounded text-sm bg-white" placeholder="ä¾‹: ITãƒ»é€šä¿¡" list="master-industry-list">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">è·ç¨®</label>
                            <input type="text" class="wh-job-category w-full px-3 py-2 border rounded text-sm bg-white" placeholder="ä¾‹: æ³•äººå–¶æ¥­" list="master-job-category-list">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="block text-xs text-gray-500 mb-1">å½¹å‰²ãƒ»å½¹è·</label>
                        <input type="text" class="wh-role w-full px-3 py-2 border rounded text-sm bg-white" placeholder="å½¹å‰²ãƒ»å½¹è·">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">è·å‹™å†…å®¹</label>
                        <textarea class="wh-description w-full px-3 py-2 border rounded text-sm bg-white" rows="3" placeholder="è·å‹™å†…å®¹"></textarea>
                    </div>
                </div>
            `);

            $item.find('.wh-company').val(data.company_name || '');
            $item.find('.wh-period').val(data.period || '');
            $item.find('.wh-industry').val(data.industry || '');
            $item.find('.wh-job-category').val(data.job_category || '');
            $item.find('.wh-role').val(data.role || '');
            $item.find('.wh-description').val(data.description || '');

            container.append($item);

            // ä¼šç¤¾åãŒå…¥åŠ›ã•ã‚ŒãŸã‚‰å†è¨ˆç®—
            $item.find('.wh-company').on('input', function () {
                updateJobChangeCountInContainer(containerSelector, targetCountId);
            });

            updateJobChangeCountInContainer(containerSelector, targetCountId);
        };

        window.updateJobChangeCountInContainer = function (containerSelector, countIdSelector) {
            const container = $(containerSelector);
            const companies = new Set();
            container.find('.wh-company').each(function () {
                const val = $(this).val().trim();
                if (val) companies.add(val);
            });
            const count = companies.size;
            $(countIdSelector).val(count);
            // ç•ªå·æŒ¯ã‚Šç›´ã—
            container.find('.work-history-item').each(function (i) {
                $(this).find('h5').text(`è·æ­´ ${i + 1}`);
            });
        };

        // æ—§é–¢æ•°ã‚’ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¨ã—ã¦æ®‹ã™ (äº’æ›æ€§ç¶­æŒ)
        window.addWorkHistoryItem = function (data = {}) {
            addWorkHistoryItemToContainer('#work-history-list', data);
        };
        window.updateJobChangeCount = function () {
            updateJobChangeCountInContainer('#work-history-list', '#admin-user-job-change-count');
        };

        // ç®¡ç†è€…ç”¨: PDFã‹ã‚‰ã®è‡ªå‹•å…¥åŠ›ãƒãƒ³ãƒ‰ãƒ©
        window.handleAdminUserPdfUpload = async function (input) {
            if (input.files.length === 0) return;

            if (!confirm('PDFã‚’è§£æã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã«è‡ªå‹•å…¥åŠ›ã—ã¾ã™ã‹ï¼Ÿ\nâ€»æ—¢å­˜ã®å…¥åŠ›å†…å®¹ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚')) {
                input.value = '';
                return;
            }

            showLoading('PDFã‚’è§£æä¸­...');
            try {
                let combinedText = '';
                for (let i = 0; i < input.files.length; i++) {
                    combinedText += await extractTextFromPDF(input.files[i]);
                }

                // AIè§£æå®Ÿè¡Œ
                let result = await analyzeDocumentWithAI(combinedText, 'resume');

                // é…åˆ—ã§è¿”ã£ã¦ããŸå ´åˆã¯æœ€åˆã®è¦ç´ ã‚’ä½¿ã†
                if (Array.isArray(result)) {
                    result = result[0] || {};
                }

                console.log('PDF Analysis Result:', result);

                // --- ãƒ•ã‚©ãƒ¼ãƒ ã¸ã®åæ˜  ---

                // åŸºæœ¬æƒ…å ±
                if (result.name) $('#admin-user-name').val(result.name);
                if (result.furigana || result.kana) $('#admin-user-furigana').val(result.furigana || result.kana);
                if (result.email) $('#admin-user-email').val(result.email);

                // å¹´é½¢ãƒ»ç”Ÿå¹´æœˆæ—¥ (æ¨å®šå€¤ãŒã‚ã‚Œã°)
                if (result.age) $('#admin-user-age').val(result.age);

                // å¹´å
                if (result.current_salary) {
                    $('#admin-user-salary').val(result.current_salary / 10000); // ä¸‡å††å˜ä½
                }

                // å­¦æ­´
                if (result.academic_background) {
                    $('#admin-user-education').val(result.academic_background);
                }

                // ã‚¹ã‚­ãƒ«
                if (result.skills) {
                    $('#admin-user-skills').val(result.skills);
                }

                // è·æ­´
                if (result.work_history) {
                    $('#admin-user-history').val(result.work_history);
                }
                if (result.work_history_detail) {
                    $('#admin-user-work-history-detail').val(result.work_history_detail);
                }

                // æ§‹é€ åŒ–ã•ã‚ŒãŸè·æ­´
                if (result.work_history_structured && Array.isArray(result.work_history_structured)) {
                    $('#work-history-list').empty();
                    result.work_history_structured.forEach(item => addWorkHistoryItem(item));
                    updateJobChangeCount();
                }

                // --- ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•ãƒãƒƒãƒãƒ³ã‚° (è·ç¨®ãƒ»æ¥­ç•Œ) ---

                // è·ç¨®
                if (result.desired_job_type || result.job_sub_category) {
                    // æŠ½å‡ºã•ã‚ŒãŸå€¤ãƒªã‚¹ãƒˆ
                    const extractedJobs = [result.desired_job_type, result.job_sub_category].flat().filter(Boolean);

                    const matchedJobs = [];
                    extractedJobs.forEach(val => {
                        const match = findClosestMasterValue(val, masterJobCategories);
                        if (match && !matchedJobs.includes(match)) {
                            matchedJobs.push(match);
                        }
                    });

                    if (matchedJobs.length > 0) {
                        console.log('Matched Job Categories:', matchedJobs);
                        // Select2ã®å€¤ã‚’ã‚»ãƒƒãƒˆã—ã¦é€šçŸ¥
                        $('#admin-user-job-type').val(matchedJobs).trigger('change');
                    }
                }

                // æ¥­ç•Œ
                if (result.desired_industry) {
                    const extractedIndustries = [result.desired_industry].flat().filter(Boolean);

                    const matchedIndustries = [];
                    extractedIndustries.forEach(val => {
                        const match = findClosestMasterValue(val, masterIndustries);
                        if (match && !matchedIndustries.includes(match)) {
                            matchedIndustries.push(match);
                        }
                    });

                    if (matchedIndustries.length > 0) {
                        console.log('Matched Industries:', matchedIndustries);
                        $('#admin-user-industry').val(matchedIndustries).trigger('change');
                    }
                }

                alert('è§£æãŒå®Œäº†ã—ã€ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›ã—ã¾ã—ãŸã€‚');

            } catch (error) {
                console.error('PDF analysis error:', error);
                alert('è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                hideLoading();
                input.value = '';
            }
        }

        // Flag to prevent premature submission
        let isModalReady = false;

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¿å­˜å‡¦ç†
        $('#admin-user-form').off('submit').on('submit', async function (e) {
            console.log('=== FORM SUBMIT TRIGGERED ===');
            console.log('isModalReady:', isModalReady);
            console.log('Event:', e);

            e.preventDefault();
            e.stopPropagation();

            if (!currentUser) {
                console.warn('No current user, aborting submit');
                return;
            }

            // Prevent submission if modal is not fully loaded
            if (!isModalReady) {
                console.warn('Modal not ready for submission yet - BLOCKING SUBMIT');
                return false;
            }

            const userId = $('#admin-user-id').val();
            const role = $('#admin-user-role').val();

            console.log('Proceeding with save - userId:', userId, 'role:', role);

            if (!userId) {
                console.error('No user ID found');
                return false;
            }

            // Usersãƒ†ãƒ¼ãƒ–ãƒ«ç”¨æ›´æ–°ãƒ‡ãƒ¼ã‚¿
            const updates = {
                name: $('#admin-user-name').val().trim(),
                furigana: $('#admin-user-furigana').val().trim(),
                email: $('#admin-user-email').val().trim(),
                status: $('#admin-user-status').val(),
                management_status: $('#admin-user-management-status').val(),
                updated_at: new Date().toISOString()
            };

            if (['org_admin', 'admin', 'super_admin'].includes(currentUser.role)) {
                updates.role = role;
                updates.team_id = $('#admin-user-team').val() || null;
            }

            // candidateå›ºæœ‰ã®Usersãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°é …ç›®
            if (role === 'candidate') {
                if (['org_admin', 'admin', 'super_admin'].includes(currentUser.role)) {
                    updates.coach_id = $('#admin-user-coach').val() || null;
                }
                updates.drive_folder_url = $('#admin-user-drive-url').val().trim() || null;
                updates.notebooklm_url = $('#admin-user-notebooklm-url').val().trim() || null;
                updates.line_url = $('#admin-user-line-url').val().trim() || null;
            }

            showLoading();
            try {
                console.log('Updating users table with:', updates);

                // 1. usersãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
                const { data: updatedUser, error: usersError } = await supabase
                    .from('users')
                    .update(updates)
                    .eq('id', userId)
                    .select();

                console.log('Users table update result:', { data: updatedUser, error: usersError });

                if (usersError) {
                    console.error('Users table update failed:', usersError);
                    throw usersError;
                }

                if (!updatedUser || updatedUser.length === 0) {
                    console.warn('âš ï¸ No rows were updated in users table. This might be an RLS policy issue.');
                    alert('è­¦å‘Š: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚RLSãƒãƒªã‚·ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }

                // 2. candidate_profilesãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–° (role === 'candidate' ã®å ´åˆã®ã¿)
                const currentRole = $('#admin-user-role').val();
                if (currentRole === 'candidate') {
                    const jobType = $('#admin-user-job-type').val();
                    const industry = $('#admin-user-industry').val();
                    const prefs = $('#admin-user-prefecture').val();
                    const city = $('#admin-user-city').val() || '';

                    console.log('=== Form Values Debug ===');
                    console.log('Job Type:', jobType);
                    console.log('Industry:', industry);
                    console.log('Prefs:', prefs);
                    console.log('City:', city);

                    let locationStr = '';
                    if (Array.isArray(prefs) && prefs.length > 0) {
                        locationStr = prefs.join(',');
                        if (city && prefs.length > 1) locationStr += ' ' + city;
                        else if (city) locationStr = prefs[0] + city;
                    } else if (prefs) locationStr = prefs + city;
                    else if (city) locationStr = city;

                    const empType = $('#admin-user-employment-type').val();

                    console.log('Location String:', locationStr);
                    console.log('Employment Type:', empType);

                    // è©³ç´°è·æ­´ãƒªã‚¹ãƒˆ
                    const workHistoryList = [];
                    $('#work-history-list .work-history-item').each(function () {
                        workHistoryList.push({
                            company_name: $(this).find('.wh-company').val(),
                            period: $(this).find('.wh-period').val(),
                            industry: $(this).find('.wh-industry').val(),
                            job_category: $(this).find('.wh-job-category').val(),
                            role: $(this).find('.wh-role').val(),
                            description: $(this).find('.wh-description').val()
                        });
                    });

                    // å€¤ã®å–å¾—
                    const workHistorySummary = $('#admin-user-history').val().trim();
                    const workHistoryDetailText = $('#admin-user-work-history-detail').val().trim();
                    const resumeDetailText = $('#admin-user-resume-detail').val().trim();
                    const notes = $('#admin-user-notes').val();

                    // æ˜ç¤ºçš„ã«ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒ‡å®šã—ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
                    const profileUpdates = {
                        desired_job_type: jobType ? jobType.join(',') : null,
                        desired_industry: industry ? industry.join(',') : null,
                        desired_location: locationStr,
                        desired_employment_type: empType ? empType.join(',') : null,
                        desired_salary: $('#admin-user-salary').val() ? parseInt($('#admin-user-salary').val()) * 10000 : null,
                        skills: $('#admin-user-skills').val().trim(),

                        // work_historyã¨detailã‚’åˆ¥ã€…ã«ä¿å­˜
                        work_history: workHistorySummary,
                        work_history_detail: workHistoryDetailText,
                        history_info: $('#admin-user-history-info').val().trim(),

                        // æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿
                        work_history_structured: workHistoryList,
                        job_change_count: parseInt($('#admin-user-job-change-count').val()) || 0,

                        desired_job_experience_ok: $('#admin-user-job-exp-ok').is(':checked'),
                        desired_industry_experience_ok: $('#admin-user-industry-exp-ok').is(':checked'),

                        // ã‚«ãƒ©ãƒ åã®ä¿®æ­£ (DBã«å­˜åœ¨ã—ãªã„ _detail ã‚«ãƒ©ãƒ ã‚’ä½¿ã‚ãªã„)
                        resume: resumeDetailText,

                        notes: notes,
                        birth_date: $('#admin-user-birth-date').val() || null,
                        age: $('#admin-user-age').val() ? parseInt($('#admin-user-age').val()) : null,
                        gender: $('#admin-user-gender').val() || null,
                        current_location: $('#admin-user-current-location').val() || null,
                        education: $('#admin-user-education').val().trim() || null,
                        phone: $('#admin-user-phone').val().trim() || null,
                        updated_at: new Date().toISOString()
                    };

                    console.log('Upserting profile:', profileUpdates); // Debug

                    const { error: profileError } = await supabase
                        .from('candidate_profiles')
                        .upsert({ user_id: userId, ...profileUpdates }, { onConflict: 'user_id' });

                    if (profileError) throw profileError;
                }

                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                closeAdminUserModal();

                // ãƒªãƒ­ãƒ¼ãƒ‰
                if ($('#admin-users-content').is(':visible')) loadAdminUsers();
                else if ($('#admin-candidates-content').is(':visible')) loadAdminCandidates();

            } catch (error) {
                console.error('Update user error:', error);
                alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                hideLoading();
            }
        });

        async function loadAdminCandidates() {
            if (!currentUser) return
            showLoading()
            try {
                console.log('loadAdminCandidates - currentUser:', currentUser);
                console.log('loadAdminCandidates - role:', currentUser.role);

                // çµ„ç¹”è¨­å®šã‚’ç¢ºèªï¼ˆé–²è¦§åˆ¶é™ï¼‰
                let limitView = false;
                if (['coach', 'ca', 'ra'].includes(currentUser.role)) {
                    const { data: org } = await supabase
                        .from('organizations')
                        .select('settings')
                        .eq('id', currentUser.organization_id)
                        .single();

                    console.log('loadAdminCandidates - org settings:', org);
                    if (org && org.settings && org.settings.limit_agent_view) {
                        limitView = true;
                        console.log('loadAdminCandidates - limit_agent_view is enabled');
                    }
                }

                // roleãŒcandidateã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
                let query = supabase
                    .from('users')
                    .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                    .eq('organization_id', currentUser.organization_id)
                    .eq('role', 'candidate')
                    .is('deleted_at', null)
                    .order('created_at', { ascending: false });

                // é–²è¦§åˆ¶é™ãŒæœ‰åŠ¹ãªå ´åˆã€æ‹…å½“è€…ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                if (limitView) {
                    console.log('loadAdminCandidates - filtering by coach_id:', currentUser.id);
                    query = query.eq('coach_id', currentUser.id);
                }

                const { data: users, error } = await query;

                console.log('loadAdminCandidates - query result:', { users, error });
                console.log('loadAdminCandidates - number of users:', users?.length || 0);

                if (error) throw error

                // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ãƒ©ãƒƒãƒˆåŒ–ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ï¼‰
                const flattenedUsers = users.map(u => {
                    const profile = Array.isArray(u.candidate_profiles) ? u.candidate_profiles[0] : u.candidate_profiles;
                    const combined = { ...u, ...profile };
                    // idã ã‘ã¯usersã®ã‚‚ã®ã‚’ç¶­æŒï¼ˆåŒã˜ã¯ãšã ãŒå¿µã®ãŸã‚ï¼‰
                    combined.id = u.id;
                    return combined;
                });

                adminCandidatesCache = flattenedUsers || [];
                renderAdminCandidates(adminCandidatesCache);
                // ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãŒã‚ã£ãŸãŸã‚ã€æ¤œç´¢ç”»é¢ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚æ›´æ–°å¾…ã¡çŠ¶æ…‹ã«ã™ã‚‹
                shouldReloadCandidates = true;
            } catch (error) {
                console.error('Load candidates error:', error)
                alert('æ±‚è·è€…ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ')
            } finally {
                hideLoading()
            }
        }

        function renderAdminCandidates(users) {
            const container = $('#admin-candidates-container')
            container.empty()

            if (users.length === 0) {
                container.html('<tr><td colspan="4" class="px-6 py-8 text-center text-gray-500">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹æ±‚è·è€…ã¯ã„ã¾ã›ã‚“</td></tr>')
                return
            }

            const html = users.map(u => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${u.name}</div>
                        <div class="text-sm text-gray-500">${u.email}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900 font-medium">${window.formatArrayValue(u.desired_job_type)}</div>
                        <div class="text-xs text-gray-500">${window.formatArrayValue(u.desired_location)}</div>
                        <div class="text-xs text-indigo-600 mt-1 font-bold">${window.formatSalaryValue(u.desired_salary)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="mb-1">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${u.status === 'suspended' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                ${u.status === 'suspended' ? 'åœæ­¢ä¸­' : 'åˆ©ç”¨ä¸­'}
                            </span>
                        </div>
                        <div>
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${u.management_status === 'inactive' ? 'bg-gray-200 text-gray-700' : 'bg-blue-100 text-blue-800'}">
                                ${u.management_status === 'inactive' ? 'æ´»å‹•çµ‚äº†' : 'æ´»å‹•ä¸­'}
                            </span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="viewCandidateProfile('${u.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">
                            è©³ç´°
                        </button>
                        <button onclick="deleteUser('${u.id}')" class="text-red-600 hover:text-red-900">
                            å‰Šé™¤
                        </button>
                    </td>
                </tr>
            `).join('')

            container.html(html)
        }

        window.showUserProfile = async function (userId) {
            try {
                const { data: userData, error } = await supabase
                    .from('users')
                    .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                    .eq('id', userId)
                    .single();

                if (error) throw error;

                // ãƒ•ãƒ©ãƒƒãƒˆåŒ–
                const profile = Array.isArray(userData.candidate_profiles) ? userData.candidate_profiles[0] : userData.candidate_profiles;
                const user = { ...userData, ...profile };
                user.id = userData.id;

                const info = `
åå‰: ${user.name}
ãƒ¡ãƒ¼ãƒ«: ${user.email}
å¸Œæœ›è·ç¨®: ${window.formatArrayValue(user.desired_job_type)}
å¸Œæœ›å‹¤å‹™åœ°: ${window.formatArrayValue(user.desired_location)}
å¸Œæœ›å¹´å: ${window.formatSalaryValue(user.desired_salary)}
ã‚¹ã‚­ãƒ«: ${window.formatArrayValue(user.skills)}
è·æ­´: ${user.work_history || '-'}
                `;
                alert(info);
            } catch (e) {
                console.error(e);
                alert('æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ========================
        // Admin: AI Prompts
        // ========================
        async function loadPrompts() {
            // ã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…ä»¥å¤–ã¯ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯
            if (!currentUser || currentUser.role !== 'super_admin') {
                alert('æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
                showPage('dashboard');
                return;
            }
            showLoading();
            try {
                // master_dataã‹ã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾— (è‡ªçµ„ç¹”ã®ã‚‚ã®)
                const { data: prompts, error } = await supabase
                    .from('master_data')
                    .select('*')
                    .eq('type', 'prompt')
                    .eq('organization_id', currentUser.organization_id)
                    .in('value', ['ai_matching_scoring', 'ai_recommendation_reason', 'recommendation_letter', 'scout_message']);

                if (error) throw error;

                const defaultScoring = `
ã‚ãªãŸã¯æ¸©ã‹ã¿ã®ã‚ã‚‹è»¢è·æ”¯æ´ã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã§ã‚ã‚Šã€ä¼æ¥­æ–‡åŒ–ã¨äººæã®ãƒ•ã‚£ãƒƒãƒˆåˆ†æã®å°‚é–€å®¶ã§ã™ã€‚
ä»¥ä¸‹ã®æ±‚äººã¨æ±‚è·è€…æƒ…å ±ã‹ã‚‰ã€ãƒãƒƒãƒåº¦ã‚’åˆ†æã—ã€**æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ã¿**ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚
åˆ†æã®è©³ç´°ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆã€Œ1.è·å‹™çµŒæ­´ã®ãƒãƒƒãƒåº¦ã€ãªã©ï¼‰ã¯ä¸€åˆ‡å‡ºåŠ›ã›ãšã€çµæœã®ã¿ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚

ã€æ±‚è·è€…æƒ…å ±ã€‘
- åŸºæœ¬æƒ…å ±: å¹´é½¢ \${userData.age} / å¸Œæœ›å¹´å \${userData.desired_salary}
- å¸Œæœ›æ¡ä»¶: \${userData.desired_industry} / \${userData.desired_job_type} / \${userData.desired_location}
- æœªçµŒé¨“OKã®å¸Œæœ›: è·ç¨®[\${userProfile.desired_job_experience_ok ? 'ã¯ã„' : 'ã„ã„ãˆ'}] / æ¥­ç¨®[\${userProfile.desired_industry_experience_ok ? 'ã¯ã„' : 'ã„ã„ãˆ'}]
- ã‚¹ã‚­ãƒ«ãƒ»PRãƒ»å‚™è€ƒ: \${userData.notes}
- å±¥æ­´æ›¸/çµŒæ­´æ›¸: \${userData.resume}
- è·å‹™çµŒæ­´è©³ç´°: \${userData.work_history}
- ç¤¾å†…ãƒãƒƒãƒãƒ³ã‚°æƒ…å ±: \${userData.matching_info}
- ç¤¾å†…ãƒ¡ãƒ¢ãƒ»å…±æœ‰äº‹é …: \${userData.internal_info}
- ãã®ä»–è£œè¶³: \${userData.other_info}

ã€æ±‚äººæƒ…å ±ã€‘
- ä¼æ¥­å: \${jobDetails.company}
- è·ç¨®: \${jobDetails.title}
- æ¥­ç¨®: \${jobDetails.industrycategory}
- è·ç¨®ã‚«ãƒ†ã‚´ãƒª: \${jobDetails.jobcategory}
- çµ¦ä¸: \${jobDetails.salary}
- å‹¤å‹™åœ°: \${jobDetails.location}
- é›‡ç”¨å½¢æ…‹: \${jobDetails.employment_type}
- æ¥­å‹™å†…å®¹: \${jobDetails.description}
- å¿…é ˆã‚¹ã‚­ãƒ«: \${jobDetails.qualifications}
- ä¼æ¥­æ–‡åŒ–ãƒ»ç‰¹å¾´: \${jobDetails.company_info}

ã€é‡è¦ï¼šä¼æ¥­æ–‡åŒ–ã®åˆ†æã«ã¤ã„ã¦ã€‘
ãƒ»ä¼æ¥­æƒ…å ±ã®ä¸è¶³ã‚„æ·±ã„åˆ†æãŒå¿…è¦ãªå ´åˆã¯ã€ä¼æ¥­åï¼ˆ\${jobDetails.company}ï¼‰ã«åŸºã¥ãã€Webæ¤œç´¢æ©Ÿèƒ½ã‚’æ´»ç”¨ã—ã¦å®Ÿéš›ã®ã‚¯ãƒã‚³ãƒŸã‚„çµŒå–¶ç†å¿µã‚’è£œå®Œã—ã¦ãã ã•ã„ã€‚

---
ã€å‡ºåŠ›ã«ãŠã‘ã‚‹çµ¶å¯¾éµå®ˆã®åˆ¶ç´„ã€‘
1. åˆ†æã®è©³ç´°ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆã€Œ1.è·å‹™çµŒæ­´ã®ãƒãƒƒãƒåº¦ã€ãªã©ã®åŒºåˆ†ã‘ã‚„èª¬æ˜ï¼‰ã¯çµ¶å¯¾ã«æ›¸ãå‡ºã•ãªã„ã§ãã ã•ã„ã€‚
2. æŒ‡å®šã•ã‚ŒãŸãƒ©ãƒ™ãƒ«ï¼ˆã€Œè©•ä¾¡: ã€ã€Œç†ç”±: ã€ç­‰ï¼‰ä»¥å¤–ã§å§‹ã¾ã‚‹æ–‡ç« ã‚’å‡ºåŠ›ã—ãªã„ã§ãã ã•ã„ã€‚
3. Markdownè¨˜å·ï¼ˆ#ã€*ã€**ã€> ç­‰ï¼‰ã¯ä½¿ç”¨ç¦æ­¢ã§ã™ã€‚
4. å„é …ç›®ã®æ–‡å­—æ•°åˆ¶é™ã‚’1æ–‡å­—ã§ã‚‚è¶…ãˆãªã„ã§ãã ã•ã„ã€‚
5. ç†ç”±ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã¯æ”¹è¡Œã›ãšã€ãã‚Œãã‚Œ1æ–‡ï¼ˆ80æ–‡å­—ä»¥å†…/60æ–‡å­—ä»¥å†…ï¼‰ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚

å›ç­”å½¢å¼ï¼š

è©•ä¾¡: [ãƒ©ãƒ³ã‚¯A-Eã‚’1æ–‡å­—]
ç†ç”±: [80æ–‡å­—ä»¥å†…ã§ç°¡æ½”ã«ã€‚æ”¹è¡Œã›ãš1æ–‡ã§è¨˜è¿°]

ç·åˆè©•ä¾¡: [æ•°å€¤]ç‚¹

ãƒãƒƒãƒã™ã‚‹ç‚¹
ãƒ»[è¦ç‚¹ã€‚30æ–‡å­—ä»¥å†…]
ãƒ»[è¦ç‚¹ã€‚30æ–‡å­—ä»¥å†…]

ä»Šå¾Œã®ã•ã‚‰ãªã‚‹æˆé•·ãƒ»æŒ‘æˆ¦ãŒæœŸå¾…ã•ã‚Œã‚‹ç‚¹
ãƒ»[è¦ç‚¹ã€‚30æ–‡å­—ä»¥å†…]
ãƒ»[è¦ç‚¹ã€‚30æ–‡å­—ä»¥å†…]

ã‚¢ãƒ‰ãƒã‚¤ã‚¹
[60æ–‡å­—ä»¥å†…ã€‚æ”¹è¡Œã›ãš1æ–‡ã§è¨˜è¿°]
`;

                const defaultReason = `
ã‚ãªãŸã¯æ¸©ã‹ã¿ã®ã‚ã‚‹ã‚­ãƒ£ãƒªã‚¢ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã§ã™ã€‚
ä»¥ä¸‹ã®æ±‚è·è€…ã«å¯¾ã—ã¦ã€ã“ã®æ±‚äººã‚’ç´¹ä»‹ã™ã‚‹ç†ç”±ã‚’300æ–‡å­—ç¨‹åº¦ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚
æ±‚è·è€…ã®ã“ã‚Œã¾ã§ã®çµŒé¨“ã‚„å¼·ã¿ã‚’å°Šé‡ã—ã€ãã‚Œã‚‰ãŒæ±‚äººã®ç‰¹å¾´ã‚„ä¼æ¥­ã®é­…åŠ›ã¨ã©ã®ã‚ˆã†ã«çµã³ã¤ãã‹ã‚’ã€ãƒã‚¸ãƒ†ã‚£ãƒ–ã‹ã¤é­…åŠ›çš„ã«ä¼ãˆã¦ãã ã•ã„ã€‚

ã€æ±‚è·è€…æƒ…å ±ã€‘
- åŸºæœ¬æƒ…å ±: å¹´é½¢ \${userData.age} / å¸Œæœ›å¹´å \${userData.desired_salary}
- å¸Œæœ›æ¡ä»¶: \${userData.desired_industry} / \${userData.desired_job_type}
- ã‚¹ã‚­ãƒ«ãƒ»PR: \${userData.notes}
- å±¥æ­´æ›¸/çµŒæ­´æ›¸: \${userData.resume}
- è·å‹™çµŒæ­´è©³ç´°: \${userData.work_history}
- ç¤¾å†…ãƒãƒƒãƒãƒ³ã‚°æƒ…å ±: \${userData.matching_info}

ã€æ±‚äººæƒ…å ±ã€‘
- ä¼æ¥­å: \${jobDetails.company}
- è·ç¨®: \${jobDetails.title}
- é­…åŠ›ãƒ»æ¥­å‹™å†…å®¹: \${jobDetails.description}

æ§‹æˆ:
1. æŒ¨æ‹¶ã¨ç´¹ä»‹ã®æ„å›³
2. æ±‚è·è€…ã®å¼·ã¿ã¨æ±‚äººã®æ¥ç‚¹
3. ã“ã®æ±‚äººã«æŒ‘æˆ¦ã™ã‚‹ãƒ¡ãƒªãƒƒãƒˆãƒ»æˆé•·å¯èƒ½æ€§
4. æ¸©ã‹ã„å¿œæ´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
`;

                const defaultRecommendationLetter = `
ã‚ãªãŸã¯äººæç´¹ä»‹ä¼šç¤¾ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®æ±‚è·è€…ã‚’ä¼æ¥­ã«æ¨è–¦ã™ã‚‹ãŸã‚ã®æ¨è–¦æ–‡ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
400-600æ–‡å­—ç¨‹åº¦ã§ã€ä»¥ä¸‹ã®æ§‹æˆã§ä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€æ±‚è·è€…æƒ…å ±ã€‘
- æ°å: \${userData.name}
- å¹´é½¢: \${userData.age}
- ç¾è·: \${userData.current_position || 'N/A'}
- ã‚¹ã‚­ãƒ«ãƒ»çµŒé¨“: \${userData.notes}
- ã‚¢ãƒ”ãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒˆ: \${userData.self_pr || 'N/A'}

ã€å¿œå‹Ÿå…ˆä¼æ¥­ãƒ»æ±‚äººã€‘
- ä¼æ¥­å: \${jobDetails.company}
- è·ç¨®: \${jobDetails.title}

æ§‹æˆ:
1. å†’é ­ã®æŒ¨æ‹¶
2. æ±‚è·è€…ã®å¼·ã¿ã¨å®Ÿç¸¾
3. æ±‚äººã¨ã®ãƒãƒƒãƒãƒ³ã‚°ç†ç”±
4. æ¨è–¦ã®çµã³
`;

                const defaultScoutMessage = `
ã‚ãªãŸã¯ä¼æ¥­ã®æ¡ç”¨æ‹…å½“è€…ã§ã™ã€‚ä»¥ä¸‹ã®æ±‚è·è€…ã«å¯¾ã—ã¦ã€é­…åŠ›çš„ãªã‚¹ã‚«ã‚¦ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€æ±‚è·è€…æƒ…å ±ã€‘
- æ°å: \${candidateName}
- ç¾è·: \${currentPosition}
- ã‚¹ã‚­ãƒ«ãƒ»çµŒé¨“: \${skills}
- å¸Œæœ›æ¡ä»¶: \${desiredConditions}

ã€è‡ªç¤¾ãƒ»æ±‚äººæƒ…å ±ã€‘
- ä¼æ¥­å: \${companyName}
- è·ç¨®: \${jobTitle}
- æ¥­å‹™å†…å®¹: \${jobDescription}
- é­…åŠ›: \${companyStrengths}
- å¾…é‡: \${benefits}

ä»¥ä¸‹ã®æ§‹æˆã§ã€300-500æ–‡å­—ç¨‹åº¦ã®ã‚¹ã‚«ã‚¦ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š

1. æ±‚è·è€…ã¸ã®æ•¬æ„ã¨é–¢å¿ƒã®è¡¨æ˜
2. è‡ªç¤¾ãƒ»æ±‚äººã®é­…åŠ›
3. æ±‚è·è€…ã®ã‚¹ã‚­ãƒ«ã¨ã®ãƒãƒƒãƒãƒ³ã‚°
4. é¢è«‡ãƒ»å¿œå‹Ÿã¸ã®èª˜å°
`;


                let scoringContent = defaultScoring.trim();
                let reasonContent = defaultReason.trim();
                let recommendationLetterContent = defaultRecommendationLetter.trim();
                let scoutMessageContent = defaultScoutMessage.trim();
                let jobDescriptionContent = '';
                let csvMappingContent = '';
                let externalProfileAnalysisContent = '';

                // Helper for decode
                function decodeBase64(str) {
                    if (!str) return '';
                    try { return decodeURIComponent(escape(atob(str))); }
                    catch (e) { return str; }
                }

                // System Prompts Load
                try {
                    const { data: sysPrompts } = await supabase.from('system_prompts').select('*').in('key', ['job_description', 'csv_field_mapping', 'external_profile_analysis_prompt']);
                    if (sysPrompts) {
                        const jp = sysPrompts.find(p => p.key === 'job_description');
                        if (jp) jobDescriptionContent = decodeBase64(jp.content);
                        const cmp = sysPrompts.find(p => p.key === 'csv_field_mapping');
                        if (cmp) csvMappingContent = decodeBase64(cmp.content);
                        const epa = sysPrompts.find(p => p.key === 'external_profile_analysis_prompt');
                        if (epa) externalProfileAnalysisContent = decodeBase64(epa.content);
                    }
                } catch (e) { console.error('System prompts load error', e); }

                if (prompts) {
                    const scoring = prompts.find(p => p.value === 'ai_matching_scoring');
                    const reason = prompts.find(p => p.value === 'ai_recommendation_reason');
                    const letter = prompts.find(p => p.value === 'recommendation_letter');
                    const scout = prompts.find(p => p.value === 'scout_message');

                    if (scoring) scoringContent = decodeBase64(scoring.label);
                    if (reason) reasonContent = decodeBase64(reason.label);
                    if (letter) recommendationLetterContent = decodeBase64(letter.label);
                    if (scout) scoutMessageContent = decodeBase64(scout.label);
                }

                $('#prompt-scoring').val(scoringContent);
                $('#prompt-reason').val(reasonContent);
                $('#prompt-recommendation-letter').val(recommendationLetterContent);
                $('#prompt-scout-message').val(scoutMessageContent);
                $('#prompt-job-description').val(jobDescriptionContent);
                $('#prompt-csv-mapping').val(csvMappingContent);
                $('#prompt-external-profile-analysis').val(externalProfileAnalysisContent);

            } catch (error) {
                console.error('Load prompts error:', error);
                alert('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            } finally {
                hideLoading();
            }
        }

        window.savePrompts = async function () {
            if (!currentUser || currentUser.role !== 'super_admin') {
                alert('ã“ã®æ“ä½œã¯ã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…ã®ã¿å¯èƒ½ã§ã™ã€‚');
                return;
            }
            if (!confirm('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šã‚’ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ')) return;

            showLoading();
            try {
                const scoringContent = $('#prompt-scoring').val();
                const reasonContent = $('#prompt-reason').val();
                const recommendationLetterContent = $('#prompt-recommendation-letter').val();
                const scoutMessageContent = $('#prompt-scout-message').val();
                const jobDescriptionContent = $('#prompt-job-description').val();
                const csvMappingContent = $('#prompt-csv-mapping').val();
                const externalProfileAnalysisContent = $('#prompt-external-profile-analysis').val();

                const updates = [
                    { key: 'ai_matching_scoring', content: scoringContent, sort_order: 10 },
                    { key: 'ai_recommendation_reason', content: reasonContent, sort_order: 20 },
                    { key: 'recommendation_letter', content: recommendationLetterContent, sort_order: 30 },
                    { key: 'scout_message', content: scoutMessageContent, sort_order: 40 }
                ];

                // 0. system_prompts ä¿å­˜ (Super Admin Only but guard is at top)
                // Encoding Helpers
                function encodeBase64(str) {
                    if (!str) return null;
                    try { return btoa(unescape(encodeURIComponent(str))); }
                    catch (e) { return str; }
                }
                function decodeBase64(str) {
                    if (!str) return '';
                    try { return decodeURIComponent(escape(atob(str))); }
                    catch (e) { return str; }
                }

                // 0. Payload Preparation (Encode for WAF bypass)
                // 1. System Prompts Upsert (Super Admin Only)
                if (jobDescriptionContent) {
                    const { error } = await supabase.from('system_prompts').upsert({ key: 'job_description', content: encodeBase64(jobDescriptionContent) }, { onConflict: 'key' });
                    if (error) console.error('SysPrompt error:', error);
                }
                if (csvMappingContent) {
                    const { error } = await supabase.from('system_prompts').upsert({ key: 'csv_field_mapping', content: encodeBase64(csvMappingContent) }, { onConflict: 'key' });
                    if (error) console.error('SysPrompt error:', error);
                }
                if (externalProfileAnalysisContent) {
                    const { error } = await supabase.from('system_prompts').upsert({ key: 'external_profile_analysis_prompt', content: encodeBase64(externalProfileAnalysisContent) }, { onConflict: 'key' });
                    if (error) console.error('SysPrompt error:', error);
                }

                // 2. Master Data Update
                // Delete existing
                const { error: deleteError } = await supabase
                    .from('master_data')
                    .delete()
                    .eq('type', 'prompt')
                    .eq('organization_id', currentUser.organization_id);

                if (deleteError) throw deleteError;

                // Insert new
                const insertData = updates.map(u => ({
                    type: 'prompt',
                    label: encodeBase64(u.content),
                    value: u.key,
                    sort_order: u.sort_order,
                    is_active: true,
                    organization_id: currentUser.organization_id
                }));

                const { error: insertError } = await supabase
                    .from('master_data')
                    .insert(insertData);

                if (insertError) throw insertError;

                alert('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('Save prompts error:', error);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error));
            } finally {
                hideLoading();
            }
        }

        window.filterAdminCandidates = function () {
            const searchText = $('#admin-candidate-search').val().toLowerCase();
            if (!searchText) {
                renderAdminCandidates(adminCandidatesCache);
                return;
            }
            const filtered = adminCandidatesCache.filter(u =>
                (u.name && u.name.toLowerCase().includes(searchText)) ||
                (u.email && u.email.toLowerCase().includes(searchText)) ||
                (u.desired_job_type && u.desired_job_type.toLowerCase().includes(searchText))
            );
            renderAdminCandidates(filtered);
        }

        // ========================
        // Admin: User Management
        // ========================
        let adminUsersCache = [];
        // ========================
        // Admin: User CSV Import
        // ========================
        window.showUserCsvImportModal = function () {
            $('#user-csv-file').val('');
            $('#user-csv-preview').addClass('hidden').empty();
            $('#admin-user-csv-modal').removeClass('hidden');
        }

        // ã‚¨ã‚¤ãƒªã‚¢ã‚¹: openUserCsvImportModal
        window.openUserCsvImportModal = window.showUserCsvImportModal;

        window.closeUserCsvImportModal = function () {
            $('#admin-user-csv-modal').addClass('hidden').attr('style', '');
        }

        window.calculateAge = function (birthDateStr, targetSelector) {
            if (!birthDateStr) return;
            const birthDate = new Date(birthDateStr);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            $(targetSelector).val(age);
        }

        window.downloadUserCsvTemplate = function (e) {
            e.preventDefault();

            if (typeof userFields === 'undefined') {
                alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®šç¾©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            const headers = userFields.map(f => {
                const name = f.aliases && f.aliases.length > 0 ? f.aliases[0] : f.label;
                return `"${name}"`;
            });

            // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
            const sample1Values = userFields.map(f => {
                switch (f.key) {
                    case 'name': return 'å±±ç”° å¤ªéƒ';
                    case 'email': return 'yamada@example.com';
                    case 'role': return 'candidate';
                    case 'birth_date': return '1990-01-01';
                    case 'age': return '34';
                    case 'education': return 'æ—©ç¨²ç”°å¤§å­¦ å•†å­¦éƒ¨ å’æ¥­';
                    case 'desired_job_type': return 'ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢';
                    case 'desired_location': return 'æ±äº¬éƒ½,ç¥å¥ˆå·çœŒ';
                    case 'desired_salary': return '600';
                    case 'skills': return 'JavaScriptãƒ»Python';
                    case 'work_history': return 'â—‹â—‹æ ªå¼ä¼šç¤¾ã§Webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦3å¹´å‹¤å‹™';
                    case 'academic_background': return 'â—‹â—‹å¤§å­¦æƒ…å ±å­¦éƒ¨å’æ¥­';
                    case 'languages': return 'è‹±èª(TOEIC800ç‚¹)';
                    case 'certifications': return 'åŸºæœ¬æƒ…å ±æŠ€è¡“è€…';
                    case 'matching_info': return 'ãƒãƒƒãƒãƒ³ã‚°æƒ…å ±ã‚µãƒ³ãƒ—ãƒ«';
                    case 'internal_info': return 'ç¤¾å†…æƒ…å ±ã‚µãƒ³ãƒ—ãƒ«';
                    case 'other_info': return 'ãã®ä»–æƒ…å ±ã‚µãƒ³ãƒ—ãƒ«';
                    default: return '';
                }
            });
            const sample1 = sample1Values.map(v => `"${v}"`).join(',');

            const sample2Values = userFields.map(f => {
                switch (f.key) {
                    case 'name': return 'éˆ´æœ¨ èŠ±å­';
                    case 'email': return 'suzuki@example.com';
                    case 'role': return 'candidate';
                    case 'birth_date': return '1995-05-15';
                    case 'age': return '29';
                    case 'education': return 'æ…¶æ‡‰ç¾©å¡¾å¤§å­¦ æ³•å­¦éƒ¨ å’æ¥­';
                    case 'desired_job_type': return 'å–¶æ¥­';
                    case 'desired_location': return 'å¤§é˜ªåºœ,å…µåº«çœŒ';
                    case 'desired_salary': return '500';
                    case 'skills': return 'å–¶æ¥­çµŒé¨“5å¹´';
                    case 'work_history': return 'â–³â–³æ ªå¼ä¼šç¤¾ã§æ³•äººå–¶æ¥­ã¨ã—ã¦5å¹´å‹¤å‹™';
                    case 'academic_background': return 'â—‹â—‹å¤§å­¦çµŒæ¸ˆå­¦éƒ¨å’æ¥­';
                    case 'languages': return 'è‹±èª(æ—¥å¸¸ä¼šè©±ãƒ¬ãƒ™ãƒ«)';
                    case 'certifications': return 'æ™®é€šè‡ªå‹•è»Šå…è¨±';
                    default: return '';
                }
            });
            const sample2 = sample2Values.map(v => `"${v}"`).join(',');

            const csvContent = headers.join(',') + "\n" + sample1 + "\n" + sample2;
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "user_import_template.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.downloadCandidateCsvTemplate = function (e) {
            e.preventDefault();
            const csvContent = "name,email,password,age,desired_job_type,desired_location,desired_salary,skills,work_history,academic_background,languages,certifications,matching_info,internal_info,other_info\nå±±ç”°å¤ªéƒ,yamada@example.com,pass123,28,ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢,\"æ±äº¬éƒ½,ç¥å¥ˆå·çœŒ\",600,JavaScriptãƒ»Python,â—‹â—‹æ ªå¼ä¼šç¤¾ã§Webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦3å¹´å‹¤å‹™,â—‹â—‹å¤§å­¦æƒ…å ±å­¦éƒ¨å’æ¥­,è‹±èª(TOEIC800ç‚¹),åŸºæœ¬æƒ…å ±æŠ€è¡“è€…,ãƒãƒƒãƒãƒ³ã‚°æƒ…å ±ã‚µãƒ³ãƒ—ãƒ«,ç¤¾å†…æƒ…å ±ã‚µãƒ³ãƒ—ãƒ«,ãã®ä»–æƒ…å ±ã‚µãƒ³ãƒ—ãƒ«\néˆ´æœ¨èŠ±å­,suzuki@example.com,pass456,32,å–¶æ¥­,\"å¤§é˜ªåºœ,å…µåº«çœŒ\",500,å–¶æ¥­çµŒé¨“5å¹´,â–³â–³æ ªå¼ä¼šç¤¾ã§æ³•äººå–¶æ¥­ã¨ã—ã¦5å¹´å‹¤å‹™,â—‹â—‹å¤§å­¦çµŒæ¸ˆå­¦éƒ¨å’æ¥­,è‹±èª(æ—¥å¸¸ä¼šè©±ãƒ¬ãƒ™ãƒ«),æ™®é€šè‡ªå‹•è»Šå…è¨±,,,";
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' }); // BOMä»˜ã
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "candidate_import_template.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.processUserCsvImport = function () {
            const fileInput = document.getElementById('user-csv-file');
            const file = fileInput.files[0];

            if (!file) {
                alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            showLoading('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...');

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: async function (results) {
                    hideLoading();

                    const data = results.data;
                    if (data.length === 0) {
                        alert('ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                        return;
                    }

                    // CSVã®ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆã‚«ãƒ©ãƒ åï¼‰ã‚’å–å¾—
                    const csvHeaders = Object.keys(data[0]);

                    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜ï¼ˆæ—¢å­˜ã®CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ•ãƒ­ãƒ¼ã§ä½¿ç”¨ï¼‰
                    currentCSVData = data;
                    currentCSVHeaders = csvHeaders;
                    currentImportType = 'candidates'; // æ±‚è·è€…å°‚ç”¨

                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    closeUserCsvImportModal();

                    // AIãƒãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼ˆæ—¢å­˜ã®é–¢æ•°ã‚’ä½¿ç”¨ï¼‰
                    showCSVMappingModal('users'); // 'users' ã‚¿ã‚¤ãƒ—ã‚’ä½¿ç”¨ï¼ˆuserFieldsã‚’å‚ç…§ï¼‰
                },
                error: function (error) {
                    hideLoading();
                    console.error('CSV parse error:', error);
                    alert('CSVã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            });
        }

        window.exportUsersCsv = function () {
            if (!adminUsersCache || adminUsersCache.length === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const csvData = adminUsersCache.map(user => ({
                name: user.name,
                email: user.email,
                role: user.role,
                created_at: new Date(user.created_at).toLocaleString()
            }));

            const csv = Papa.unparse(csvData);
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `users_export_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function loadAdminUsers() {
            if (!currentUser) return
            showLoading()
            try {
                // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ï¼ˆè‡ªçµ„ç¹”ã®ã¿ï¼‰
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                    .eq('organization_id', currentUser.organization_id)
                    .neq('role', 'candidate')
                    .is('deleted_at', null)
                    .order('created_at', { ascending: false })

                if (error) throw error

                // ãƒ•ãƒ©ãƒƒãƒˆåŒ–ï¼ˆä¸€è¦§è¡¨ç¤ºã§ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ãŒå¿…è¦ãªå ´åˆã®ãŸã‚ï¼‰
                const flattenedUsers = (users || []).map(u => {
                    const profile = Array.isArray(u.candidate_profiles) ? u.candidate_profiles[0] : u.candidate_profiles;
                    return { ...u, ...profile, id: u.id };
                });

                adminUsersCache = flattenedUsers;
                renderAdminUsers(adminUsersCache);
            } catch (error) {
                console.error('Load users error:', error)
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ')
            } finally {
                hideLoading()
            }
        }

        function renderAdminUsers(users) {
            const container = $('#admin-users-container')
            const infoContainer = $('#org-info-display'); // Placeholder for Org Info
            container.empty()

            // Display Organization Code for Org Admins
            if (currentUser && ['org_admin', 'admin'].includes(currentUser.role)) {
                if ($('#org-code-info').length === 0) {
                    // Add Org Code Display Area if not exists
                    const headerSection = $('#admin-users-content h2').parent();
                    // Fetch Org Code async
                    (async () => {
                        const { data, error } = await supabase.from('organizations').select('code').eq('id', currentUser.organization_id).single();
                        if (data && data.code) {
                            headerSection.append(`
                                <div id="org-code-info" class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg inline-block">
                                    <span class="text-sm text-blue-800 font-bold">çµ„ç¹”ã‚³ãƒ¼ãƒ‰: </span>
                                    <span class="text-lg font-mono text-blue-900 mx-2">${data.code}</span>
                                    <span class="text-xs text-gray-500">ï¼ˆã“ã®ã‚³ãƒ¼ãƒ‰ã‚’æ±‚è·è€…ã«å…±æœ‰ã—ã¦ãã ã•ã„ï¼‰</span>
                                </div>
                             `);
                        }
                    })();
                }
            }

            if (users.length === 0) {
                container.html('<tr><td colspan="4" class="px-6 py-8 text-center text-gray-500">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“</td></tr>')
                return
            }

            const html = users.map(u => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${u.name}</div>
                        <div class="text-sm text-gray-500">${u.email}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getRoleBadgeColor(u.role)}">
                            ${getRoleLabel(u.role)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="mb-1">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${u.status === 'suspended' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                ${u.status === 'suspended' ? 'åœæ­¢ä¸­' : 'åˆ©ç”¨ä¸­'}
                            </span>
                        </div>
                        <div>
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${u.management_status === 'inactive' ? 'bg-gray-200 text-gray-700' : 'bg-blue-100 text-blue-800'}">
                                ${u.management_status === 'inactive' ? 'æ´»å‹•çµ‚äº†' : 'æ´»å‹•ä¸­'}
                            </span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${new Date(u.created_at).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="viewCandidateProfile('${u.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">
                            è©³ç´°
                        </button>
                        <button onclick="deleteUser('${u.id}')" class="text-red-600 hover:text-red-900">
                            å‰Šé™¤
                        </button>
                    </td>
                </tr>
            `).join('')

            container.html(html)
        }

        function getRoleLabel(role) {
            const roles = {
                'super_admin': 'ã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…',
                'org_admin': 'çµ„ç¹”ç®¡ç†è€…',
                'admin': 'ç®¡ç†è€…',
                'coach': 'CAãƒ»RA',
                'ca': 'CA',
                'ra': 'RA',
                'candidate': 'æ±‚è·è€…'
            };

            // çµ„ç¹”ã”ã¨ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºåç§°ã‚’ç¢ºèª
            let customLabel = null;
            if (window.currentUser && window.currentUser.organizations && window.currentUser.organizations.settings) {
                const labels = window.currentUser.organizations.settings.role_labels || {};

                // ç‰¹å®šã®ãƒ­ãƒ¼ãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹
                if (labels && labels[role]) {
                    customLabel = labels[role];
                }
                // ca, ra ã®å ´åˆã¯ coach ã®è¨­å®šã‚’æµç”¨ã™ã‚‹ï¼ˆå€‹åˆ¥ã«è¨­å®šã•ã‚Œã¦ã„ãªã‘ã‚Œã°ï¼‰
                else if ((role === 'ca' || role === 'ra') && labels && labels['coach']) {
                    customLabel = labels['coach'];
                }
            }

            return customLabel || roles[role] || role;
        }

        function getRoleBadgeColor(role) {
            const colors = {
                'super_admin': 'bg-purple-100 text-purple-800',
                'org_admin': 'bg-blue-100 text-blue-800',
                'admin': 'bg-indigo-100 text-indigo-800',
                'coach': 'bg-yellow-100 text-yellow-800',
                'candidate': 'bg-green-100 text-green-800'
            };
            return colors[role] || 'bg-gray-100 text-gray-800';
        }

        window.filterAdminUsers = function () {
            const searchText = $('#admin-user-search').val().toLowerCase();
            if (!searchText) {
                renderAdminUsers(adminUsersCache);
                return;
            }
            const filtered = adminUsersCache.filter(u =>
                (u.name && u.name.toLowerCase().includes(searchText)) ||
                (u.email && u.email.toLowerCase().includes(searchText))
            );
            renderAdminUsers(filtered);
        }

        window.editUserRole = async function (userId, currentRole) {
            const newRole = prompt('æ–°ã—ã„ãƒ­ãƒ¼ãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (admin, coach, candidate):', currentRole);
            if (newRole && newRole !== currentRole) {
                if (!['admin', 'coach', 'candidate'].includes(newRole)) {
                    alert('ç„¡åŠ¹ãªãƒ­ãƒ¼ãƒ«ã§ã™');
                    return;
                }
                try {
                    const { error } = await supabase
                        .from('users')
                        .update({ role: newRole })
                        .eq('id', userId);

                    if (error) throw error;
                    alert('æ¨©é™ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                    loadAdminUsers();
                } catch (e) {
                    console.error(e);
                    alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }
        }

        // ========================
        // User Registration
        // ========================
        window.showUserRegistrationModal = async function (type) {
            $('#user-registration-form')[0].reset();
            $('#reg-resume-filename').text('');

            // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–
            await loadMasterDataForProfile(null);

            // Select2ã®æ—¢å­˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç ´æ£„ã—ã¦ã‹ã‚‰å†åˆæœŸåŒ–
            $('#reg-job-type, #reg-industry, #reg-employment-type, #reg-prefecture').each(function () {
                if ($(this).hasClass("select2-hidden-accessible")) {
                    $(this).select2('destroy');
                }
            });

            // Select2åˆæœŸåŒ–ï¼ˆè¤‡æ•°é¸æŠã®æ“ä½œæ€§å‘ä¸Šï¼‰
            $('#reg-job-type, #reg-industry, #reg-employment-type, #reg-prefecture').select2({
                width: '100%',
                closeOnSelect: false,
                allowClear: true,
                placeholder: 'é¸æŠã—ã¦ãã ã•ã„',
                language: 'ja'
            });

            if (type === 'candidate') {
                $('#user-reg-title').text('æ–°è¦æ±‚è·è€…ç™»éŒ²');
                $('#reg-role').val('candidate');
                $('#reg-role-section').addClass('hidden');
                $('#reg-candidate-fields').removeClass('hidden');
            } else {
                $('#user-reg-title').text('æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²');
                $('#reg-role').val('');

                // æ¨©é™ãƒ©ãƒ™ãƒ«ã®æ›´æ–°
                const $regRoleSelect = $('#reg-role-select');
                $regRoleSelect.empty();
                $regRoleSelect.append(`<option value="admin">${getRoleLabel('admin')}</option>`);
                $regRoleSelect.append(`<option value="coach">${getRoleLabel('coach')}</option>`);
                $regRoleSelect.append(`<option value="org_admin">${getRoleLabel('org_admin')}</option>`);

                $('#reg-role-section').removeClass('hidden');
                $('#reg-candidate-fields').addClass('hidden');
            }

            $('#user-registration-modal').removeClass('hidden');
        }

        window.closeUserRegistrationModal = function () {
            $('#user-registration-modal').addClass('hidden');
        }

        // ç™»éŒ²ç”¨è·æ­´ãƒªã‚¹ãƒˆæ“ä½œé–¢æ•°
        window.addRegWorkHistoryItem = function (data = {}) {
            const count = $('#reg-work-history-list').children().length;
            if (count >= 10) return;
            const index = count + 1;
            const $item = $(`
                <div class="reg-work-history-item bg-gray-50 p-4 rounded-lg border border-gray-200 relative mb-2">
                    <button type="button" onclick="$(this).closest('.reg-work-history-item').remove(); updateRegJobChangeCount();" 
                        class="absolute top-2 right-2 text-gray-400 hover:text-red-500 w-6 h-6 flex items-center justify-center rounded-full hover:bg-gray-200 transition">
                        <i class="fas fa-times"></i>
                    </button>
                    <h5 class="text-sm font-bold text-indigo-700 mb-2">è·æ­´ ${index}</h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">ä¼šç¤¾å</label>
                            <input type="text" class="wh-company w-full px-3 py-2 border rounded text-sm bg-white" placeholder="ä¼šç¤¾å">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">åœ¨ç±æœŸé–“</label>
                            <input type="text" class="wh-period w-full px-3 py-2 border rounded text-sm bg-white" placeholder="ä¾‹: 2020/04 - 2023/03">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">æ‰€å±ä¼æ¥­ã®æ¥­ç¨®</label>
                            <input type="text" class="wh-industry w-full px-3 py-2 border rounded text-sm bg-white" placeholder="ä¾‹: ITãƒ»é€šä¿¡" list="master-industry-list">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">è·ç¨®</label>
                            <input type="text" class="wh-job-category w-full px-3 py-2 border rounded text-sm bg-white" placeholder="ä¾‹: æ³•äººå–¶æ¥­" list="master-job-category-list">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="block text-xs text-gray-500 mb-1">å½¹å‰²ãƒ»å½¹è·</label>
                        <input type="text" class="wh-role w-full px-3 py-2 border rounded text-sm bg-white" placeholder="å½¹å‰²ãƒ»å½¹è·">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">è·å‹™å†…å®¹</label>
                        <textarea class="wh-description w-full px-3 py-2 border rounded text-sm bg-white" rows="3" placeholder="è·å‹™å†…å®¹"></textarea>
                    </div>
                </div>
            `);

            $item.find('.wh-company').val(data.company_name || '');
            $item.find('.wh-period').val(data.period || '');
            $item.find('.wh-industry').val(data.industry || '');
            $item.find('.wh-job-category').val(data.job_category || '');
            $item.find('.wh-role').val(data.role || '');
            $item.find('.wh-description').val(data.description || '');

            $('#reg-work-history-list').append($item);

            // ä¼šç¤¾åãŒå…¥åŠ›ã•ã‚ŒãŸã‚‰å†è¨ˆç®—
            $item.find('.wh-company').on('input', function () {
                updateRegJobChangeCount();
            });

            updateRegJobChangeCount();
        };

        window.updateRegJobChangeCount = function () {
            const companies = new Set();
            $('#reg-work-history-list .wh-company').each(function () {
                const val = $(this).val().trim();
                if (val) companies.add(val);
            });
            const count = companies.size;
            $('#reg-job-change-count').val(count);
            $('#reg-work-history-list .reg-work-history-item').each(function (i) {
                $(this).find('h5').text(`è·æ­´ ${i + 1}`);
            });
        };

        window.handleRegResumeUpload = async function (input) {
            if (input.files.length === 0) return;

            const fileNames = Array.from(input.files).map(f => f.name).join(', ');
            $('#reg-resume-filename').text(fileNames);

            showLoading();
            try {
                let combinedText = '';
                for (let i = 0; i < input.files.length; i++) {
                    const text = await extractTextFromPDF(input.files[i]);
                    combinedText += `--- File ${i + 1} ---\n${text}\n`;
                }

                let result = await analyzeDocumentWithAI(combinedText, 'resume');

                // é…åˆ—ã§è¿”ã£ã¦ããŸå ´åˆã¯æœ€åˆã®è¦ç´ ã‚’ä½¿ã†
                if (Array.isArray(result)) {
                    result = result[0] || {};
                }

                // ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
                // åå‰ãƒ»ãµã‚ŠãŒãª
                if (result.name) $('#reg-name').val(result.name);
                if (result.furigana || result.kana) $('#reg-furigana').val(result.furigana || result.kana);

                if (result.desired_job_type) $('#reg-job-type').val(result.desired_job_type);
                if (result.desired_location) $('#reg-location').val(result.desired_location);
                if (result.desired_employment_type) $('#reg-employment-type').val(result.desired_employment_type);
                if (result.desired_salary) $('#reg-salary').val(Math.floor(result.desired_salary / 10000));
                if (result.skills) $('#reg-skills').val(result.skills);
                if (result.work_history) $('#reg-history').val(result.work_history);
                if (result.work_history_detail) $('#reg-work-history-detail').val(result.work_history_detail);
                if (result.resume) $('#reg-resume-detail').val(result.resume); // resumeã¯è©³ç´°ãƒ†ã‚­ã‚¹ãƒˆæ‰±ã„

                // æ§‹é€ åŒ–ã•ã‚ŒãŸè·æ­´
                if (result.work_history_structured && Array.isArray(result.work_history_structured)) {
                    $('#reg-work-history-list').empty();
                    result.work_history_structured.forEach(item => addRegWorkHistoryItem(item));
                    updateRegJobChangeCount();
                }

                alert('è§£æãŒå®Œäº†ã—ã€ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›ã—ã¾ã—ãŸã€‚\nå†…å®¹ã‚’ç¢ºèªã—ã¦ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚');
            } catch (error) {
                console.error('Resume analysis error:', error);
                alert('è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        window.handleUserRegistration = async function (event) {
            event.preventDefault();

            let email = $('#reg-email').val().trim();
            let password = $('#reg-password').val();
            const name = $('#reg-name').val().trim();
            const furigana = $('#reg-furigana').val().trim();

            let role = $('#reg-role').val();
            if (!role) {
                // hiddenå€¤ãŒãªã„å ´åˆã¯ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®å€¤ã‚’ä½¿ç”¨ï¼ˆç®¡ç†è€…ãƒ»ã‚³ãƒ¼ãƒç™»éŒ²æ™‚ï¼‰
                role = $('#reg-role-select').val();
            }

            if (!role) {
                // ãƒ­ãƒ¼ãƒ«é¸æŠãŒãªã„å ´åˆã¯ç®¡ç†è€…ç™»éŒ²ç”»é¢ã‹ã‚‰ã®å‘¼ã³å‡ºã—ã¨ã¿ãªã™ï¼ˆé€šå¸¸ã¯ã‚ã‚Šãˆãªã„ãŒå¿µã®ãŸã‚ï¼‰
                // ã—ã‹ã— showUserRegistrationModal('candidate') ã§ã¯ hidden ã«ã—ã¦ 'candidate' ã‚’ã‚»ãƒƒãƒˆã—ã¦ã„ã‚‹
                // ã“ã“ã§ã¯ãƒ•ã‚©ãƒ¼ãƒ ã®å€¤ã‚’ç¢ºèª
                if ($('#reg-candidate-fields').is(':visible') || $('#user-reg-title').text().includes('æ±‚è·è€…')) {
                    role = 'candidate';
                } else {
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ admin ã«ã™ã‚‹ï¼ˆuser ã¯DBåˆ¶ç´„é•åã«ãªã‚‹ãŸã‚ï¼‰
                    role = 'admin';
                }
            }

            // æ±‚è·è€…ã®å ´åˆã€ãƒ¡ã‚¢ãƒ‰ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æœªå…¥åŠ›ãªã‚‰è‡ªå‹•ç”Ÿæˆ
            if (role === 'candidate') {
                if (!email) {
                    const uuid = crypto.randomUUID();
                    email = `candidate-${Date.now()}-${uuid.substring(0, 8)}@placeholder.local`;
                }

                if (!password) {
                    password = crypto.randomUUID();
                }
            }

            if ((role !== 'candidate' && (!email || !password)) || !name) {
                alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            showLoading();
            try {
                // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã®æ§‹ç¯‰ï¼ˆæ±‚è·è€…ã®å ´åˆï¼‰
                const profileData = {};
                if (role === 'candidate') {
                    const jobType = $('#reg-job-type').val();
                    profileData.desired_job_type = jobType ? jobType.join(',') : null;

                    const industry = $('#reg-industry').val();
                    profileData.desired_industry = industry ? industry.join(',') : null;

                    const prefs = $('#reg-prefecture').val(); // é…åˆ—ã¾ãŸã¯æ–‡å­—åˆ—
                    const city = $('#reg-city').val() || '';
                    let location = '';

                    if (Array.isArray(prefs) && prefs.length > 0) {
                        location = prefs.join(',');
                        if (city) {
                            // è¤‡æ•°é¸æŠæ™‚ã¯ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã€å˜ä¸€ã®å ´åˆã¯çµåˆï¼ˆå¾“æ¥äº’æ›ï¼‰
                            if (prefs.length > 1) {
                                location += ' ' + city;
                            } else {
                                location = prefs[0] + city;
                            }
                        }
                    } else if (prefs) {
                        // æ–‡å­—åˆ—ã®å ´åˆï¼ˆå˜ä¸€é¸æŠè¨­å®šãªã©ã®å ´åˆï¼‰
                        location = prefs + city;
                    } else if (city) {
                        location = city;
                    }
                    profileData.desired_location = location || null;

                    const empType = $('#reg-employment-type').val();
                    profileData.desired_employment_type = empType ? empType.join(',') : null;
                    const salary = $('#reg-salary').val();
                    profileData.desired_salary = salary ? parseInt(salary) * 10000 : null;
                    profileData.skills = $('#reg-skills').val() || null;
                    profileData.work_history = $('#reg-history').val() || null;
                    profileData.work_history_detail = $('#reg-work-history-detail').val() || null;
                    profileData.resume = $('#reg-resume-detail').val() || null;

                    // æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿åé›†
                    const workHistoryList = [];
                    $('#reg-work-history-list .reg-work-history-item').each(function () {
                        workHistoryList.push({
                            company_name: $(this).find('.wh-company').val(),
                            period: $(this).find('.wh-period').val(),
                            industry: $(this).find('.wh-industry').val(),
                            job_category: $(this).find('.wh-job-category').val(),
                            role: $(this).find('.wh-role').val(),
                            description: $(this).find('.wh-description').val()
                        });
                    });
                    profileData.work_history_structured = workHistoryList;
                    profileData.job_change_count = parseInt($('#reg-job-change-count').val()) || 0;
                }

                const requestBody = {
                    email,
                    password,
                    name,
                    furigana,
                    role,
                    organizationId: currentUser.organization_id,
                    profileData
                };



                console.log('Sending user registration request:', requestBody);

                // Edge Functionå‘¼ã³å‡ºã—
                const { data, error } = await supabase.functions.invoke('create-user', {
                    body: requestBody
                });

                console.log('Edge Function response:', { data, error });

                if (error) {
                    // ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’å–å¾—
                    console.error('Edge Function error details:', error);

                    // FunctionsHttpErrorã®å ´åˆã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã‚’ç¢ºèª
                    if (error.context) {
                        console.error('Error context:', error.context);
                    }

                    throw error;
                }

                // dataã«ã‚¨ãƒ©ãƒ¼æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã‚‚ãƒã‚§ãƒƒã‚¯
                if (data && data.error) {
                    console.error('Edge Function returned error:', data);
                    throw new Error(data.error + (data.details ? '\nè©³ç´°: ' + data.details : ''));
                }

                // æ‹›å¾…ãƒ¡ãƒ¼ãƒ«é€ä¿¡
                if (email) {
                    const orgName = currentUser.organizations ? currentUser.organizations.name : 'RightJob';
                    const loginUrl = window.location.origin;

                    // éåŒæœŸã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ•ãƒ­ãƒ¼ã¯æ­¢ã‚ãªã„ï¼‰
                    sendEmail('invitation', email, {
                        organizationName: orgName,
                        invitationUrl: loginUrl
                    }).catch(e => console.error('Failed to send invitation email:', e));
                }

                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
                closeUserRegistrationModal();

                // ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
                if (role === 'candidate') {
                    loadAdminCandidates();
                } else {
                    loadAdminUsers();
                }

            } catch (error) {
                console.error('User registration error:', error);

                // ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                let errorMessage = 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n';

                if (error.message) {
                    errorMessage += 'ã‚¨ãƒ©ãƒ¼: ' + error.message + '\n';
                }

                // error.contextãŒResponseã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã®å‡¦ç†
                if (error.context) {
                    try {
                        // Responseã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ
                        if (error.context instanceof Response) {
                            const responseText = await error.context.text();
                            console.log('Response text:', responseText);

                            try {
                                const errorBody = JSON.parse(responseText);
                                if (errorBody.error) {
                                    errorMessage += '\nè©³ç´°: ' + errorBody.error;
                                }
                                if (errorBody.details) {
                                    errorMessage += '\n' + errorBody.details;
                                }
                            } catch (parseError) {
                                // JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ãŸå ´åˆã€ãƒ†ã‚­ã‚¹ãƒˆã‚’ãã®ã¾ã¾è¡¨ç¤º
                                errorMessage += '\nè©³ç´°: ' + responseText;
                            }
                        }
                        // bodyãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚‹å ´åˆ
                        else if (error.context.body) {
                            const errorBody = typeof error.context.body === 'string'
                                ? JSON.parse(error.context.body)
                                : error.context.body;

                            if (errorBody.error) {
                                errorMessage += '\nè©³ç´°: ' + errorBody.error;
                            }
                            if (errorBody.details) {
                                errorMessage += '\n' + errorBody.details;
                            }
                        }
                    } catch (e) {
                        console.error('Failed to parse error context:', e);
                    }
                }

                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ—¥æœ¬èªåŒ–ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¸ç½®æ›ï¼‰
                if (errorMessage.includes('already been registered') || errorMessage.includes('User already registered')) {
                    errorMessage = 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ\n\nã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚\nåˆ¥ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€ç®¡ç†è€…ã«ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                } else if (errorMessage.includes('Password should be at least')) {
                    errorMessage = 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ\n\nãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„ã€‚';
                }

                alert(errorMessage);
            } finally {
                hideLoading();
            }
        }

        // Admin: Applicant Management
        // ========================
        let adminApplicantsCache = [];

        async function loadAdminApplicants() {
            if (!currentUser) return

            showLoading()
            try {
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚¹ã‚¿ã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ§‹ç¯‰
                await loadApplicationStatuses();

                const { data: applications, error } = await supabase
                    .from('applications')
                    .select('*, jobs(*), users!applications_user_id_fkey(*)')
                    .eq('organization_id', currentUser.organization_id)
                    .order('updated_at', { ascending: false })

                if (error) throw error

                adminApplicantsCache = applications || [];
                filterAdminApplicants();
            } catch (error) {
                console.error('Load admin applicants error:', error)
                $('#admin-applicants-container').html('<p class="text-red-500">å¿œå‹Ÿè€…ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>')
            } finally {
                hideLoading()
            }
        }

        let adminApplicantStatusFilter = 'applied';
        let selectedAdminApplicantIds = new Set();

        window.setAdminApplicantStatusFilter = function (status) {
            adminApplicantStatusFilter = status;

            // UIæ›´æ–°
            $('.status-filter-btn').removeClass('active bg-indigo-600 text-white border-indigo-600').addClass('bg-white text-gray-600 border-gray-300 hover:bg-gray-50');
            $(`.status-filter-btn[data-status="${status}"]`).addClass('active bg-indigo-600 text-white border-indigo-600').removeClass('bg-white text-gray-600 border-gray-300 hover:bg-gray-50');

            filterAdminApplicants();
        };

        window.filterAdminApplicants = function () {
            const searchText = $('#admin-applicant-search').val().toLowerCase();

            let filtered = adminApplicantsCache;

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            if (adminApplicantStatusFilter !== 'all') {
                const group = window.statusGroups ? window.statusGroups[adminApplicantStatusFilter] : null;
                if (group) {
                    filtered = filtered.filter(app => group.values.includes(app.status));
                } else {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                    filtered = filtered.filter(app => {
                        if (adminApplicantStatusFilter === 'applied') {
                            return app.status === 'å¿œå‹Ÿå®Œäº†' || !app.status;
                        } else if (adminApplicantStatusFilter === 'screening_docs') {
                            return ['æ›¸é¡é¸è€ƒä¸­', 'æ›¸é¡é¸è€ƒé€šé', 'pending', 'screening'].includes(app.status);
                        } else if (adminApplicantStatusFilter === 'screening_interviews') {
                            return ['ä¸€æ¬¡é¢æ¥äºˆå®š', 'ä¸€æ¬¡é¢æ¥å®Œäº†', 'äºŒæ¬¡é¢æ¥äºˆå®š', 'äºŒæ¬¡é¢æ¥å®Œäº†', 'æœ€çµ‚é¢æ¥äºˆå®š', 'æœ€çµ‚é¢æ¥å®Œäº†', 'interview'].includes(app.status);
                        } else if (adminApplicantStatusFilter === 'offered') {
                            return app.status === 'offered' || app.status === 'å†…å®š' || app.status === 'å†…å®šæ‰¿è«¾';
                        } else if (adminApplicantStatusFilter === 'contracted') {
                            return app.status === 'contracted' || app.status === 'å…¥ç¤¾ç¢ºèªæ¸ˆ';
                        } else if (adminApplicantStatusFilter === 'closed') {
                            return ['rejected', 'withdrawn'].includes(app.status) || (app.status && app.status.startsWith('é¸è€ƒçµ‚äº†'));
                        }
                        return true;
                    });
                }
            }

            // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢
            if (searchText) {
                filtered = filtered.filter(app =>
                    (app.users && app.users.name && app.users.name.toLowerCase().includes(searchText)) ||
                    (app.jobs && app.jobs.title && app.jobs.title.toLowerCase().includes(searchText)) ||
                    (app.jobs && app.jobs.company && app.jobs.company.toLowerCase().includes(searchText))
                );
            }

            renderAdminApplicants(filtered);
        }

        window.toggleAllAdminApplicants = function (checked) {
            if (checked) {
                const visibleCheckboxes = $('.admin-applicant-checkbox');
                visibleCheckboxes.each(function () {
                    $(this).prop('checked', true);
                    selectedAdminApplicantIds.add($(this).val());
                });
            } else {
                const visibleCheckboxes = $('.admin-applicant-checkbox');
                visibleCheckboxes.each(function () {
                    $(this).prop('checked', false);
                    selectedAdminApplicantIds.delete($(this).val());
                });
            }
            updateAdminApplicantSelectionUI();
        };

        window.toggleAdminApplicantSelection = function (id, checked) {
            if (checked) {
                selectedAdminApplicantIds.add(id);
            } else {
                selectedAdminApplicantIds.delete(id);
            }
            updateAdminApplicantSelectionUI();
        };

        window.openBulkStatusUpdateModal = function () {
            if (selectedAdminApplicantIds.size === 0) return;

            $('#bulk-status-target-count').text(`${selectedAdminApplicantIds.size}ä»¶ã®å¿œå‹Ÿã‚’é¸æŠä¸­`);

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ãƒã‚¹ã‚¿ã‹ã‚‰èª­ã¿è¾¼ã¿
            const select = $('#bulk-new-status');
            select.empty();

            const options = (typeof applicationStatuses !== 'undefined' && applicationStatuses.length > 0)
                ? applicationStatuses
                : [
                    { value: 'pending', label: 'æ›¸é¡é¸è€ƒä¸­' },
                    { value: 'interview', label: 'é¢æ¥äºˆå®š' },
                    { value: 'offered', label: 'å†…å®š' },
                    { value: 'contracted', label: 'å…¥ç¤¾æ±ºå®š' },
                    { value: 'rejected', label: 'ä¸åˆæ ¼' },
                    { value: 'withdrawn', label: 'è¾é€€' }
                ];

            options.forEach(opt => {
                select.append($('<option>').val(opt.value || opt.label).text(opt.label));
            });

            $('#bulk-status-modal').removeClass('hidden');
        };

        window.closeBulkStatusModal = function () {
            $('#bulk-status-modal').addClass('hidden');
        };

        window.submitBulkStatusUpdate = async function () {
            const newStatus = $('#bulk-new-status').val();
            if (!newStatus) return;

            const count = selectedAdminApplicantIds.size;
            if (!confirm(`${count}ä»¶ã®å¿œå‹Ÿã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œ${$('#bulk-new-status option:selected').text()}ã€ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            showLoading();
            try {
                const ids = Array.from(selectedAdminApplicantIds);

                // Supabaseã§æ›´æ–°
                const { error } = await supabase
                    .from('applications')
                    .update({ status: newStatus })
                    .in('id', ids);

                if (error) throw error;

                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°
                ids.forEach(id => {
                    const idx = adminApplicantsCache.findIndex(a => a.id === id);
                    if (idx !== -1) adminApplicantsCache[idx].status = newStatus;
                });

                // ãƒ­ã‚°ï¼ˆå…¨ä»¶åˆ†ã¯é‡ã„ã®ã§ä»£è¡¨ã—ã¦1ã¤ã€ã¾ãŸã¯æ¦‚è¦ã‚’è¨˜éŒ²ã€‚ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«å®Œäº†é€šçŸ¥ï¼‰
                await logAction('bulk_update', 'application', ids[0], { count: ids.length, status: newStatus });

                alert(`${count}ä»¶ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä¸€æ‹¬æ›´æ–°ã—ã¾ã—ãŸ`);
                closeBulkStatusModal();

                // é¸æŠã‚’å…¨è§£é™¤
                selectedAdminApplicantIds.clear();
                $('#admin-applicant-select-all').prop('checked', false);
                updateAdminApplicantSelectionUI();

                // å†æç”»
                filterAdminApplicants();

            } catch (error) {
                console.error('Bulk update error:', error);
                alert('ä¸€æ‹¬æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                hideLoading();
            }
        };

        function updateAdminApplicantSelectionUI() {
            const count = selectedAdminApplicantIds.size;
            $('#admin-applicant-selection-count').text(`${count}ä»¶é¸æŠä¸­`);

            const btn = $('#admin-bulk-status-btn');
            if (count > 0) {
                btn.prop('disabled', false).removeClass('text-indigo-300 border-indigo-100 italic cursor-not-allowed').addClass('text-indigo-600 border-indigo-600 hover:bg-indigo-50');
            } else {
                btn.prop('disabled', true).addClass('text-indigo-300 border-indigo-100 italic cursor-not-allowed').removeClass('text-indigo-600 border-indigo-600 hover:bg-indigo-50');
            }
        }

        function renderAdminApplicants(applications) {
            const container = $('#admin-applicants-container')
            container.empty()

            if (applications.length === 0) {
                container.html('<p class="text-gray-500 text-center py-8">å¿œå‹Ÿè€…ãŒã„ã¾ã›ã‚“</p>')
                return
            }

            const statusOptions = (typeof applicationStatuses !== 'undefined' && applicationStatuses.length > 0)
                ? applicationStatuses.map(s => s.value)
                : ['pending', 'screening', 'interview', 'offered', 'rejected', 'withdrawn', 'å¿œå‹Ÿå®Œäº†'];

            const statusLabels = (typeof applicationStatuses !== 'undefined' && applicationStatuses.length > 0)
                ? applicationStatuses.reduce((acc, s) => ({ ...acc, [s.value]: s.label }), {})
                : {
                    'pending': 'æ›¸é¡é¸è€ƒä¸­',
                    'screening': 'æ›¸é¡é¸è€ƒä¸­',
                    'interview': 'é¢æ¥äºˆå®š',
                    'offered': 'å†…å®š',
                    'rejected': 'ä¸åˆæ ¼',
                    'withdrawn': 'è¾é€€',
                    'å¿œå‹Ÿå®Œäº†': 'å¿œå‹Ÿå®Œäº†'
                };

            const html = applications.map(app => {
                // nullãƒã‚§ãƒƒã‚¯
                const userName = app.users?.name || 'ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼';
                const jobTitle = app.jobs?.title || 'ä¸æ˜ãªæ±‚äºº';
                const companyName = app.jobs?.company || '-';
                const updatedDate = app.updated_at ? new Date(app.updated_at).toLocaleDateString('ja-JP') : '-';
                const isSelected = selectedAdminApplicantIds.has(app.id);

                return `
                <div class="bg-white border ${isSelected ? 'border-indigo-300 ring-2 ring-indigo-100' : 'border-gray-200'} rounded-lg p-6 mb-4 hover:shadow-md transition-shadow">
                    <div class="flex items-start gap-4">
                        <div class="pt-1">
                            <input type="checkbox" class="admin-applicant-checkbox w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer" 
                                value="${app.id}" ${isSelected ? 'checked' : ''} onchange="toggleAdminApplicantSelection('${app.id}', this.checked)">
                        </div>
                        <div class="flex-1">
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <h3 class="text-lg font-bold text-gray-900">${userName}</h3>
                                        <span class="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded">ID: ${app.id.substring(0, 8)}</span>
                                    </div>
                                    <div class="space-y-1 mb-2">
                                        <p class="text-blue-600 font-bold"><i class="fas fa-building mr-1"></i>${companyName}</p>
                                        <p class="text-gray-800 font-medium">${jobTitle}</p>
                                    </div>
                                    <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs text-gray-500">
                                        <span><i class="far fa-calendar-alt mr-1"></i>${updatedDate}æ›´æ–°</span>
                                        ${app.users?.email ? `<span><i class="far fa-envelope mr-1"></i>${app.users.email}</span>` : ''}
                                    </div>
                                </div>
                                <div class="flex flex-col gap-3 items-end">
                                    <div class="flex items-center gap-2">
                                        <label class="text-xs font-bold text-gray-500">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</label>
                                        <select onchange="updateApplicationStatus('${app.id}', this.value)" class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm font-bold focus:ring-2 focus:ring-indigo-500 outline-none">
                                            ${statusOptions.map(s => `
                                                <option value="${s}" ${app.status === s ? 'selected' : ''}>${statusLabels[s] || s}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="openRecommendationModal('${app.id}')" class="px-3 py-1.5 text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-lg text-sm font-bold transition flex items-center gap-1">
                                            <i class="fas fa-file-alt"></i> æ¨è–¦
                                        </button>
                                        <button onclick="openProgressModal('${app.id}')" class="px-3 py-1.5 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-bold transition">
                                            è©³ç´°
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }).join('')

            container.html(html)
        }

        window.updateApplicationStatus = async function (applicationId, newStatus) {
            showLoading()
            try {
                // 1. ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—ï¼ˆå±¥æ­´ç”¨ï¼‰
                const { data: currentApp, error: fetchError } = await supabase
                    .from('applications')
                    .select('status, user_id, organization_id')
                    .eq('id', applicationId)
                    .single();

                if (fetchError) throw fetchError;
                const oldStatus = currentApp.status;

                // 2. å¿œå‹Ÿã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
                const { error: updateError } = await supabase
                    .from('applications')
                    .update({
                        status: newStatus,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', applicationId)

                if (updateError) throw updateError

                // 3. é€²æ—å±¥æ­´ã‚’è¨˜éŒ²
                await supabase.from('progress_history').insert({
                    organization_id: currentApp.organization_id || currentUser.organization_id,
                    application_id: applicationId,
                    user_id: currentApp.user_id,
                    old_status: oldStatus,
                    new_status: newStatus,
                    changed_by: currentUser.id,
                    changed_by_name: currentUser.name
                });

                // 4. ãƒ­ã‚°è¨˜éŒ² (ç›£æŸ»ç”¨)
                await logAction('update', 'application', applicationId, { status: newStatus })

                alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸ')

                // 5. ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ã¨å†æç”»
                if (typeof adminApplicantsCache !== 'undefined') {
                    const idx = adminApplicantsCache.findIndex(a => a.id === applicationId);
                    if (idx !== -1) adminApplicantsCache[idx].status = newStatus;
                    filterAdminApplicants();
                }

                if (typeof applicationsCache !== 'undefined') {
                    const idx = applicationsCache.findIndex(a => a.id === applicationId);
                    if (idx !== -1) applicationsCache[idx].status = newStatus;
                    filterCandidateApplications();
                }

            } catch (error) {
                console.error('Update status error:', error)
                alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
                loadAdminApplicants() // Reload to revert
            } finally {
                hideLoading()
            }
        }

        // ========================
        // Admin: Company Management
        // ========================
        let companiesCache = []; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦æ¤œç´¢ã«ä½¿ç”¨
        let searchTimeout = null;
        async function loadCompanies(searchText = '') {
            if (!currentUser) return
            showLoading()
            console.log('--- loadCompanies START ---', searchText ? `(Search: ${searchText})` : '');
            try {
                const targetOrgId = currentUser.organization_id;

                // åŸºæœ¬ã‚¯ã‚¨ãƒª
                let query = supabase
                    .from('companies')
                    .select('*')
                    .eq('organization_id', targetOrgId)
                    .order('created_at', { ascending: false });

                // è«–ç†å‰Šé™¤å¯¾å¿œ
                query = query.or('deleted_at.is.null');

                // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰æ¤œç´¢ã®é©ç”¨
                if (searchText) {
                    // search_vectorã‚«ãƒ©ãƒ ãªã©ãŒãªã„å ´åˆã¯ã€ilikeã§å€‹åˆ¥ã«ãƒ•ã‚£ãƒ«ã‚¿ã™ã‚‹
                    // æ³¨æ„: Supabaseã® or å¥å†…ã§ ilike ã‚’ä½¿ç”¨ã™ã‚‹å½¢å¼
                    query = query.or(`name.ilike.%${searchText}%,industry.ilike.%${searchText}%,location.ilike.%${searchText}%`);
                }

                const { data: companies, error } = await query;

                if (error) {
                    console.error('Supabase query error in loadCompanies:', error);
                    throw error;
                }

                console.log('Companies loaded. Count:', companies ? companies.length : 0);

                // æ¤œç´¢ä¸­ã§ãªã„å ´åˆã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
                if (!searchText) {
                    companiesCache = companies || [];
                }

                renderCompanies(companies || []);
            } catch (error) {
                console.error('Load companies error detail:', error)
                alert('ä¼æ¥­ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:\n' + (error.message || JSON.stringify(error)))
            } finally {
                console.log('--- loadCompanies END ---');
                hideLoading()
            }
        }

        function renderCompanies(companies) {
            const container = $('#companies-container')
            container.empty()

            // å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            $('#select-all-companies').prop('checked', false);
            updateBulkDeleteButton();

            if (companies.length === 0) {
                container.html('<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ä¼æ¥­ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>')
                return
            }

            const html = companies.map(c => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="checkbox" class="company-checkbox rounded text-indigo-600 focus:ring-indigo-500" value="${c.id}" onchange="updateBulkDeleteButton()">
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium text-gray-900 break-words">${c.name}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-600 break-words">${c.industry || '-'}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-600 break-words">${c.location || '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${c.website ? `<a href="${c.website}" target="_blank" class="text-indigo-600 hover:underline text-sm"><i class="fas fa-external-link-alt mr-1"></i>ãƒªãƒ³ã‚¯</a>` : '<span class="text-sm text-gray-400">-</span>'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick='editCompany(${JSON.stringify(c).replace(/'/g, "&#39;")})' class="text-indigo-600 hover:text-indigo-900 mr-3">
                            <i class="fas fa-edit"></i> ç·¨é›†
                        </button>
                        <button onclick="deleteCompany('${c.id}')" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash"></i> å‰Šé™¤
                        </button>
                    </td>
                </tr>
            `).join('')

            container.html(html)
        }

        window.toggleAllCompanies = function (source) {
            $('.company-checkbox').prop('checked', source.checked);
            updateBulkDeleteButton();
        }

        window.updateBulkDeleteButton = function () {
            const selectedCount = $('.company-checkbox:checked').length;
            $('#selected-companies-count').text(selectedCount);
            if (selectedCount > 0) {
                $('#bulk-delete-companies').removeClass('hidden');
            } else {
                $('#bulk-delete-companies').addClass('hidden');
            }
        }

        window.bulkDeleteCompanies = async function () {
            const selectedIds = $('.company-checkbox:checked').map(function () {
                return $(this).val();
            }).get();

            if (selectedIds.length === 0) return;

            if (!confirm(`${selectedIds.length}ä»¶ã®ä¼æ¥­ã‚’ä¸€æ‹¬å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                return;
            }

            showLoading('ä¸€æ‹¬å‰Šé™¤ä¸­...');
            try {
                // è«–ç†å‰Šé™¤ (deleted_at ã‚’æ›´æ–°)
                const { error } = await supabase
                    .from('companies')
                    .update({ deleted_at: new Date().toISOString() })
                    .in('id', selectedIds);

                if (error) throw error;

                alert(`${selectedIds.length}ä»¶ã®ä¼æ¥­ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
                loadCompanies();
            } catch (error) {
                console.error('Bulk delete error:', error);
                alert('ä¸€æ‹¬å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        window.filterCompanies = function () {
            const searchText = $('#company-search').val().trim();

            // å…¥åŠ›ã®ãŸã³ã«ã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé£›ã°ãªã„ã‚ˆã†ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†
            if (searchTimeout) clearTimeout(searchTimeout);

            searchTimeout = setTimeout(() => {
                loadCompanies(searchText);
            }, 500); // 500mså¾…æ©Ÿã—ã¦ã‹ã‚‰å®Ÿè¡Œ
        }

        window.showCompanyForm = function () {
            $('#company-modal-title').text('ä¼æ¥­ç™»éŒ²')
            $('#company-form')[0].reset()
            $('#company-id').val('')
            populateSelectOptions('company-industry', masterIndustries); // ãƒã‚¹ã‚¿åˆæœŸåŒ–
            $('#company-modal').removeClass('hidden')
        }

        window.closeCompanyModal = function () {
            $('#company-modal').addClass('hidden')
        }

        window.editCompany = function (company) {
            $('#company-modal-title').text('ä¼æ¥­ç·¨é›†')
            $('#company-id').val(company.id)
            $('#company-name').val(company.name)
            // $('#company-industry').val(company.industry) // populateSelectOptionsã§è¨­å®š
            populateSelectOptions('company-industry', masterIndustries, company.industry);
            $('#company-location').val(company.location)
            $('#company-website').val(company.website)
            $('#company-description').val(company.description)
            $('#company-modal').removeClass('hidden')
        }

        window.handleCompanySubmit = async function (e) {
            e.preventDefault()
            if (!currentUser) return;

            showLoading()
            try {
                const id = $('#company-id').val()
                const orgId = currentUser.organization_id || $('#admin-user-org').val(); // super_adminã®å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

                if (!orgId) {
                    throw new Error('çµ„ç¹”IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚');
                }

                const companyData = {
                    organization_id: orgId,
                    name: $('#company-name').val(),
                    industry: $('#company-industry').val(),
                    location: $('#company-location').val(),
                    website: $('#company-website').val(),
                    description: $('#company-description').val()
                }

                console.log('--- Company registration attempt ---');
                console.log('Data:', companyData);
                console.log('Mode:', id ? 'Update' : 'Insert');

                let result;
                if (id) {
                    result = await supabase.from('companies').update(companyData).eq('id', id).select();
                } else {
                    result = await supabase.from('companies').insert(companyData).select();
                }

                console.log('Supabase full response:', result);

                if (result.error) {
                    console.error('Supabase error detail:', result.error);
                    let errMsg = result.error.message;
                    if (result.error.code === '42501') {
                        errMsg = 'æ¨©é™ï¼ˆRLSï¼‰ã‚¨ãƒ©ãƒ¼ã§ã™ã€‚ç®¡ç†è€…ã®çµ„ç¹”IDè¨­å®šã¾ãŸã¯SQLãƒãƒªã‚·ãƒ¼ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚';
                    }
                    throw new Error(errMsg);
                }

                console.log('Success result:', result.data);
                closeCompanyModal()
                if (typeof loadCompanies === 'function') loadCompanies();
                alert('ä¼æ¥­ã®ç™»éŒ²ã«æˆåŠŸã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('Final caught error:', error)
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:\n' + error.message);
            } finally {
                hideLoading()
            }
        }

        window.deleteCompany = async function (id) {
            if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆè«–ç†å‰Šé™¤ã•ã‚Œã€ä¸€è¦§ã‹ã‚‰éè¡¨ç¤ºã«ãªã‚Šã¾ã™ï¼‰')) return

            showLoading()
            try {
                const { error } = await supabase
                    .from('companies')
                    .update({ deleted_at: new Date().toISOString() })
                    .eq('id', id)
                if (error) throw error

                alert('å‰Šé™¤ã—ã¾ã—ãŸ')
                loadCompanies()
            } catch (error) {
                console.error('Delete company error:', error)
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
            } finally {
                hideLoading()
            }
        }

        // ========================
        // Admin: CSV Import
        // ========================


        // ========================
        // CSV Import Logic
        // ========================

        // ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®šç¾©
        const jobFields = [
            { key: 'title', label: 'æ±‚äººã‚¿ã‚¤ãƒˆãƒ«', required: true, aliases: ['ã‚¿ã‚¤ãƒˆãƒ«', 'æ±‚äººå', 'è·ç¨®å'] },
            { key: 'company', label: 'ä¼æ¥­å', required: true, aliases: ['ä¼šç¤¾å', 'ä¼æ¥­'] },
            { key: 'job_category', label: 'è·ç¨®ã‚«ãƒ†ã‚´ãƒªãƒ¼', aliases: ['è·ç¨®', 'ã‚«ãƒ†ã‚´ãƒªãƒ¼'] },
            { key: 'employment_type', label: 'é›‡ç”¨å½¢æ…‹', aliases: ['é›‡ç”¨ã‚¿ã‚¤ãƒ—', 'å‹¤å‹™å½¢æ…‹'] },
            { key: 'location', label: 'å‹¤å‹™åœ°', aliases: ['å ´æ‰€', 'ä½æ‰€', 'å‹¤å‹™å ´æ‰€'] },
            { key: 'salary_min', label: 'æœ€ä½å¹´å(ä¸‡å††)', aliases: ['å¹´åä¸‹é™', 'æœ€ä½çµ¦ä¸'] },
            { key: 'salary_max', label: 'æœ€é«˜å¹´å(ä¸‡å††)', aliases: ['å¹´åä¸Šé™', 'æœ€é«˜çµ¦ä¸'] },
            { key: 'description', label: 'è·å‹™å†…å®¹', aliases: ['ä»•äº‹å†…å®¹', 'è©³ç´°'] },
            { key: 'requirements', label: 'å¿…é ˆè¦ä»¶', aliases: ['å¿œå‹Ÿè³‡æ ¼', 'å¿…é ˆã‚¹ã‚­ãƒ«'] },
            { key: 'welcome_requirements', label: 'æ­“è¿è¦ä»¶', aliases: ['æ­“è¿ã‚¹ã‚­ãƒ«', 'å°šå¯'] },
            { key: 'benefits', label: 'ç¦åˆ©åšç”Ÿ', aliases: ['å¾…é‡', 'ç¦åˆ©'] },
            { key: 'is_remote', label: 'ãƒªãƒ¢ãƒ¼ãƒˆå¯å¦', aliases: ['ãƒªãƒ¢ãƒ¼ãƒˆ', 'åœ¨å®…'] },
            { key: 'experience_level', label: 'çµŒé¨“ãƒ¬ãƒ™ãƒ«', aliases: ['çµŒé¨“å¹´æ•°', 'ãƒ¬ãƒ™ãƒ«'] },
            { key: 'industry', label: 'æ¥­ç•Œ', aliases: ['æ¥­ç¨®', 'ç”£æ¥­'] },
            { key: 'url', label: 'æ±‚äººURL', aliases: ['URL', 'ãƒªãƒ³ã‚¯', 'ã‚µã‚¤ãƒˆ', 'ãƒšãƒ¼ã‚¸'] },
            { key: 'job_experience_ok', label: 'è·ç¨®æœªçµŒé¨“OK', aliases: ['è·ç¨®æœªçµŒé¨“', 'æœªçµŒé¨“å¯', 'è·ç¨®æœªçµŒé¨“æ­“è¿'] },
            { key: 'industry_experience_ok', label: 'æ¥­ç¨®æœªçµŒé¨“OK', aliases: ['æ¥­ç•ŒæœªçµŒé¨“', 'æ¥­ç¨®æœªçµŒé¨“', 'æ¥­ç•ŒæœªçµŒé¨“æ­“è¿'] },
            { key: 'work_hours', label: 'å‹¤å‹™æ™‚é–“', aliases: ['å°±æ¥­æ™‚é–“', 'æ‹˜æŸæ™‚é–“'] },
            { key: 'holidays', label: 'ä¼‘æ—¥ä¼‘æš‡', aliases: ['ä¼‘æ—¥', 'ä¼‘æš‡'] },
            { key: 'interview_process', label: 'é¸è€ƒãƒ—ãƒ­ã‚»ã‚¹', aliases: ['é¸è€ƒã®æµã‚Œ', 'æ¡ç”¨ãƒ•ãƒ­ãƒ¼'] }
        ];

        const companyFields = [
            { key: 'name', label: 'ä¼æ¥­å', required: true, aliases: ['ä¼šç¤¾å', 'ä¼æ¥­', 'Name'] },
            { key: 'industry', label: 'æ¥­ç•Œ', aliases: ['æ¥­ç¨®', 'ç”£æ¥­', 'Industry'] },
            { key: 'location', label: 'æ‰€åœ¨åœ°', aliases: ['å ´æ‰€', 'ä½æ‰€', 'æœ¬éƒ¨æ‰€åœ¨åœ°', 'Location'] },
            { key: 'website', label: 'Webã‚µã‚¤ãƒˆ', aliases: ['URL', 'ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ', 'HP', 'Website'] },
            { key: 'description', label: 'ä¼æ¥­èª¬æ˜', aliases: ['ä¼šç¤¾æ¦‚è¦', 'è©³ç´°', 'Description'] }
        ];

        const userFields = [
            // åŸºæœ¬æƒ…å ±
            { key: 'name', label: 'æ°å', required: true, aliases: ['åå‰', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å', 'æ°å'] },
            { key: 'email', label: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', required: true, aliases: ['ãƒ¡ãƒ¼ãƒ«', 'Email', 'E-mail'] },
            { key: 'password', label: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰', required: false, aliases: ['ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰', 'Password', 'pass'] },
            { key: 'role', label: 'æ¨©é™(candidate/coach/...)', aliases: ['ãƒ­ãƒ¼ãƒ«', 'å½¹å‰²'] },
            { key: 'birth_date', label: 'ç”Ÿå¹´æœˆæ—¥', aliases: ['èª•ç”Ÿæ—¥', 'ç”Ÿã‚Œ'] },
            { key: 'age', label: 'å¹´é½¢', aliases: ['æ­³', 'å¹´é½¢'] },
            { key: 'education', label: 'å­¦æ­´', aliases: ['å­¦æ ¡', 'å¤§å­¦', 'å­¦éƒ¨', 'å­¦æ­´'] },

            // å¸Œæœ›æ¡ä»¶
            { key: 'desired_job_type', label: 'å¸Œæœ›è·ç¨®', aliases: ['å¸Œæœ›è·ç¨®å', 'è·ç¨®'] },
            { key: 'desired_location', label: 'å¸Œæœ›å‹¤å‹™åœ°', aliases: ['å¸Œæœ›å ´æ‰€', 'å‹¤å‹™åœ°'] },
            { key: 'desired_salary', label: 'å¸Œæœ›å¹´å(ä¸‡å††)', aliases: ['å¸Œæœ›çµ¦ä¸', 'å¹´å'] },

            // ã‚¹ã‚­ãƒ«ãƒ»çµŒæ­´
            { key: 'skills', label: 'ã‚¹ã‚­ãƒ«', aliases: ['æŠ€è¡“', 'æŠ€èƒ½', 'ä¿æœ‰ã‚¹ã‚­ãƒ«'] },
            { key: 'work_history', label: 'è·æ­´ãƒ»è‡ªå·±PR', aliases: ['çµŒæ­´', 'è‡ªå·±ç´¹ä»‹', 'è·å‹™çµŒæ­´'] },
            { key: 'academic_background', label: 'å­¦æ­´', aliases: ['æœ€çµ‚å­¦æ­´', 'å­¦æ ¡', 'å‡ºèº«æ ¡'] },
            { key: 'certifications', label: 'è³‡æ ¼', aliases: ['å…è¨±', 'ä¿æœ‰è³‡æ ¼'] },
            { key: 'languages', label: 'è¨€èªã‚¹ã‚­ãƒ«', aliases: ['èªå­¦', 'èªå­¦åŠ›'] },

            // ç®¡ç†ç”¨æƒ…å ±ï¼ˆæœ¬äººéè¡¨ç¤ºï¼‰
            { key: 'matching_info', label: 'ãƒãƒƒãƒãƒ³ã‚°æƒ…å ±', aliases: ['ãƒãƒƒãƒãƒ³ã‚°ãƒ¡ãƒ¢', 'ãƒãƒƒãƒãƒ³ã‚°'] },
            { key: 'internal_info', label: 'ç¤¾å†…æƒ…å ±', aliases: ['ç¤¾å†…ãƒ¡ãƒ¢', 'å†…éƒ¨æƒ…å ±'] },
            { key: 'other_info', label: 'ãã®ä»–æƒ…å ±', aliases: ['ãã®ä»–', 'å‚™è€ƒ2'] }
        ];

        let currentCSVData = [];
        let currentImportType = ''; // 'jobs' or 'users'
        let currentCSVHeaders = [];

        // CSVãƒ‘ãƒ¼ã‚¹é–¢æ•°ï¼ˆæ—¢å­˜ã®ã‚‚ã®ã‚’å¼·åŒ–ï¼‰
        function parseCSV(text) {
            const lines = text.split(/\r\n|\n/).filter(line => line.trim() !== '');
            if (lines.length < 2) return [];

            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));

            const data = [];
            for (let i = 1; i < lines.length; i++) {
                // ç°¡æ˜“çš„ãªCSVãƒ‘ãƒ¼ã‚¹ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€å¼•ç”¨ç¬¦å¯¾å¿œã¯å®Œå…¨ã§ã¯ãªã„ï¼‰
                // æœ¬æ ¼çš„ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆPapaParseãªã©ï¼‰ã®ä½¿ç”¨ãŒæ¨å¥¨ã•ã‚Œã‚‹ãŒã€ã“ã“ã§ã¯ç°¡æ˜“å®Ÿè£…
                const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
                if (values.length === headers.length) {
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = values[index];
                    });
                    data.push(obj);
                }
            }
            return { headers, data };
        }

        window.importJobsCSV = function () {
            handleCSVUpload('jobs');
        }

        window.importUsersCSV = function () {
            handleCSVUpload('users');
        }

        window.showCompanyCsvImportModal = function () {
            $('#admin-company-csv-modal').removeClass('hidden');
        }

        window.closeCompanyCsvImportModal = function () {
            $('#admin-company-csv-modal').addClass('hidden').attr('style', '');
        }

        window.processCompanyCsvImport = function () {
            const fileInput = document.getElementById('company-csv-file');
            const file = fileInput.files[0];

            if (!file) {
                alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            processCSVFile(file, 'companies');

            if (typeof closeCompanyCsvImportModal === 'function') {
                closeCompanyCsvImportModal();
            }
        }

        window.downloadCompanyCsvTemplate = function (event) {
            if (event) event.preventDefault();
            const headers = companyFields.map(f => f.label);
            const csvContent = headers.join(',') + "\n" +
                '"æ ªå¼ä¼šç¤¾ã‚µãƒ³ãƒ—ãƒ«","ITãƒ»é€šä¿¡","æ±äº¬éƒ½æ¸‹è°·åŒº","https://example.com","ãƒ†ãƒƒã‚¯ç³»ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ã§ã™ã€‚"';
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "company_import_template.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.toggleUpsertKey = function () {
            const isChecked = $('#csv-upsert-mode').is(':checked');
            if (isChecked) {
                $('#csv-upsert-key-container').removeClass('hidden');
                updateUpsertKeyOptions();
            } else {
                $('#csv-upsert-key-container').addClass('hidden');
            }
        }

        function updateUpsertKeyOptions() {
            const select = $('#csv-upsert-key');
            const currentValue = select.val();
            select.empty();

            const fields = currentImportType === 'jobs' ? jobFields :
                currentImportType === 'companies' ? companyFields : userFields;

            let hasOption = false;
            fields.forEach(f => {
                // ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹é …ç›®ã®ã¿é¸æŠè‚¢ã«ã™ã‚‹
                const mapping = $(`.mapping-select[data-key="${f.key}"]`).val();
                if (mapping) {
                    const selected = f.key === currentValue ? 'selected' : '';
                    select.append(`<option value="${f.key}" ${selected}>${f.label} (${f.key})</option>`);
                    hasOption = true;
                }
            });

            if (!hasOption) {
                select.append('<option value="">-- ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¦ãã ã•ã„ --</option>');
            }
        }

        function handleCSVUpload(type) {
            const fileInput = type === 'jobs' ? $('#csv-jobs-file')[0] : $('#csv-users-file')[0]; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨inputãŒå¿…è¦ãªã‚‰è¿½åŠ 
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ã®inputãŒãªã„å ´åˆã¯ä¸€æ™‚çš„ã«ä½œæˆã—ã¦ã‚¯ãƒªãƒƒã‚¯
            if (type === 'users' && !$('#csv-users-file').length) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.csv';
                input.onchange = e => processCSVFile(e.target.files[0], type);
                input.click();
                return;
            }

            if (!fileInput.files.length) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            processCSVFile(fileInput.files[0], type);
        }

        function processCSVFile(file, type) {
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true, // ç©ºè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
                complete: function (results) {
                    console.log('Parsed results:', results);

                    const data = results.data;
                    const headers = results.meta.fields;

                    if (!data || data.length === 0) {
                        alert('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                        return;
                    }

                    currentCSVData = data;
                    currentCSVHeaders = headers;
                    currentImportType = type;

                    showCSVMappingModal(type);
                },
                error: function (error) {
                    console.error('CSV parse error:', error);
                    alert('CSVã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            });
        }

        function showCSVMappingModal(type) {
            const fields = type === 'jobs' ? jobFields :
                type === 'companies' ? companyFields : userFields;
            const tbody = $('#csv-mapping-tbody');
            tbody.empty();

            // ã‚¢ãƒƒãƒ—ã‚µãƒ¼ãƒˆè¨­å®šã®åˆæœŸåŒ–
            $('#csv-upsert-mode').prop('checked', false);
            $('#csv-upsert-key-container').addClass('hidden');

            // ä¿å­˜æ¸ˆã¿è¨­å®šã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
            // candidatesã‚¿ã‚¤ãƒ—ã®å ´åˆã¯ã€usersã®è¨­å®šã‚’èª­ã¿è¾¼ã‚€
            const mappingType = (currentImportType === 'candidates') ? 'users' : type;
            updateSavedMappingSelect(mappingType);
            $('#new-mapping-name').val(''); // å…¥åŠ›æ¬„ã‚¯ãƒªã‚¢

            fields.forEach(field => {
                // è‡ªå‹•ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯
                let selectedHeader = '';
                // å®Œå…¨ä¸€è‡´ã¾ãŸã¯ã‚¨ã‚¤ãƒªã‚¢ã‚¹ä¸€è‡´ã‚’æ¢ã™
                const match = currentCSVHeaders.find(h =>
                    h === field.key ||
                    h === field.label ||
                    (field.aliases && field.aliases.some(alias => h.includes(alias)))
                );
                if (match) selectedHeader = match;

                const options = currentCSVHeaders.map(h =>
                    `<option value="${h}" ${h === selectedHeader ? 'selected' : ''}>${h}</option>`
                ).join('');

                const previewValue = currentCSVData.length > 0 && selectedHeader ? currentCSVData[0][selectedHeader] : '-';

                const row = `
                    <tr>
                        <td class="px-6 py-4 text-sm font-medium text-gray-900 border-b">
                            ${field.label} ${field.required ? '<span class="text-red-500">*</span>' : ''}
                            <div class="text-xs text-gray-500">${field.key}</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500 border-b">
                            <select class="mapping-select w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" data-key="${field.key}">
                                <option value="">(ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãªã„)</option>
                                ${options}
                            </select>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500 mapping-preview border-b break-all" data-key="${field.key}">
                            <div class="max-h-24 overflow-y-auto w-full">
                                ${previewValue}
                            </div>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });

            // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹å¤‰æ›´æ™‚ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ã¨ã‚¢ãƒƒãƒ—ã‚µãƒ¼ãƒˆã‚­ãƒ¼é¸æŠè‚¢æ›´æ–°
            $('.mapping-select').on('change', function () {
                const key = $(this).data('key');
                const header = $(this).val();
                const previewCell = $(`.mapping-preview[data-key="${key}"]`);
                const val = currentCSVData.length > 0 && header ? currentCSVData[0][header] : '-';
                previewCell.text(val);

                // ã‚¢ãƒƒãƒ—ã‚µãƒ¼ãƒˆã‚­ãƒ¼ã®é¸æŠè‚¢ã‚’æ›´æ–°
                if ($('#csv-upsert-mode').is(':checked')) {
                    updateUpsertKeyOptions();
                }
            });

            $('#csv-mapping-modal').removeClass('hidden');
        }

        // ========================
        // Mapping Settings Logic
        // ========================
        const MAPPING_STORAGE_KEY = 'csv_mapping_settings';

        function getSavedMappings(type) {
            try {
                const saved = localStorage.getItem(MAPPING_STORAGE_KEY);
                if (!saved) return [];
                const settings = JSON.parse(saved);
                // ç¾åœ¨ã®çµ„ç¹”ã¨ã‚¿ã‚¤ãƒ—ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                return settings.filter(s => s.type === type && s.organization_id === currentUser.organization_id);
            } catch (e) {
                console.error('Failed to load mappings', e);
                return [];
            }
        }

        function updateSavedMappingSelect(type) {
            const mappings = getSavedMappings(type);
            const select = $('#saved-mapping-select');
            select.empty();
            select.append('<option value="">-- è¨­å®šã‚’é¸æŠ --</option>');
            mappings.forEach(m => {
                select.append(`<option value="${m.name}">${m.name}</option>`);
            });
        }

        window.applySavedMapping = function (name) {
            if (!name) return;

            // candidatesã‚¿ã‚¤ãƒ—ã®å ´åˆã¯ã€usersã®è¨­å®šã‚‚èª­ã¿è¾¼ã‚€
            let importType = currentImportType;
            if (importType === 'candidates') {
                importType = 'users';
            }

            const mappings = getSavedMappings(importType);
            const target = mappings.find(m => m.name === name);
            if (!target) return;

            // ãƒãƒƒãƒ”ãƒ³ã‚°é©ç”¨
            for (const [key, header] of Object.entries(target.mapping)) {
                const select = $(`.mapping-select[data-key="${key}"]`);
                if (select.length) {
                    // CSVãƒ˜ãƒƒãƒ€ãƒ¼ã«ãã®å€¤ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
                    // å­˜åœ¨ã—ãªã„å ´åˆã¯ã€è­¦å‘Šã‚’å‡ºã•ãšã«ç©ºã«ã™ã‚‹ã‹ã€ãã®ã¾ã¾ã«ã™ã‚‹ã‹ã€‚
                    // ã“ã“ã§ã¯ã€ãƒ˜ãƒƒãƒ€ãƒ¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿é©ç”¨ã™ã‚‹
                    if (currentCSVHeaders.includes(header)) {
                        select.val(header).trigger('change');
                    }
                }
            }
        }

        window.saveCurrentMapping = function () {
            const name = $('#new-mapping-name').val().trim();
            if (!name) {
                alert('è¨­å®šåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const mapping = {};
            let hasMapping = false;
            $('.mapping-select').each(function () {
                const key = $(this).data('key');
                const val = $(this).val();
                if (val) {
                    mapping[key] = val;
                    hasMapping = true;
                }
            });

            if (!hasMapping) {
                alert('ä¿å­˜ã™ã‚‹ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®šãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå°‘ãªãã¨ã‚‚1ã¤ã¯ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¦ãã ã•ã„ï¼‰');
                return;
            }

            try {
                const saved = localStorage.getItem(MAPPING_STORAGE_KEY);
                let settings = saved ? JSON.parse(saved) : [];

                // candidatesã‚¿ã‚¤ãƒ—ã®å ´åˆã¯ã€usersã¨ã—ã¦ä¿å­˜
                const saveType = (currentImportType === 'candidates') ? 'users' : currentImportType;

                // æ—¢å­˜ãƒã‚§ãƒƒã‚¯
                const idx = settings.findIndex(s => s.name === name && s.type === saveType && s.organization_id === currentUser.organization_id);

                const newSetting = {
                    name,
                    type: saveType,
                    organization_id: currentUser.organization_id,
                    mapping,
                    updated_at: new Date().toISOString()
                };

                if (idx >= 0) {
                    if (!confirm(`è¨­å®šã€Œ${name}ã€ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ`)) return;
                    settings[idx] = newSetting;
                } else {
                    settings.push(newSetting);
                }

                localStorage.setItem(MAPPING_STORAGE_KEY, JSON.stringify(settings));
                alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');

                // ä¿å­˜æ¸ˆã¿è¨­å®šã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
                const mappingType = (currentImportType === 'candidates') ? 'users' : currentImportType;
                updateSavedMappingSelect(mappingType);
                $('#saved-mapping-select').val(name);

            } catch (e) {
                console.error('Save error', e);
                alert('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        window.deleteSavedMapping = function () {
            const name = $('#saved-mapping-select').val();
            if (!name) {
                alert('å‰Šé™¤ã™ã‚‹è¨­å®šã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (!confirm(`è¨­å®šã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;

            try {
                const saved = localStorage.getItem(MAPPING_STORAGE_KEY);
                if (!saved) return;

                let settings = JSON.parse(saved);
                settings = settings.filter(s => !(s.name === name && s.type === currentImportType && s.organization_id === currentUser.organization_id));

                localStorage.setItem(MAPPING_STORAGE_KEY, JSON.stringify(settings));
                alert('è¨­å®šã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                updateSavedMappingSelect(currentImportType);
                $('#new-mapping-name').val('');

            } catch (e) {
                console.error('Delete error', e);
                alert('è¨­å®šã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        window.closeCSVMappingModal = function () {
            $('#csv-mapping-modal').addClass('hidden');
            currentCSVData = [];
            currentCSVHeaders = [];
        }

        window.autoMapWithAI = async function () {
            if (!currentCSVHeaders || currentCSVHeaders.length === 0) {
                alert('è§£æå¯¾è±¡ã®CSVãƒ˜ãƒƒãƒ€ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const fields = currentImportType === 'jobs' ? jobFields : userFields;

            // AIã«é€ã‚‹æƒ…å ±
            // è£œè¶³æƒ…å ±ã¨ã—ã¦æ—¢å­˜ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚‚æ¸¡ã™ã“ã¨ã§ç²¾åº¦å‘ä¸Šã‚’å›³ã‚‹
            const inputData = {
                csv_headers: currentCSVHeaders,
                system_fields: fields.map(f => ({
                    key: f.key,
                    label: f.label,
                    description: f.aliases ? f.aliases.join(', ') : ''
                }))
            };

            const btn = $(event.currentTarget);
            const originalContent = btn.html();
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>AIè§£æä¸­...');

            try {
                // analyzeDocumentWithAI ã¯æ—¢å­˜ã®é–¢æ•° (å†…éƒ¨ã§Edge Functionã‚’å‘¼ã¶)
                // ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦JSONæ–‡å­—åˆ—ã‚’æ¸¡ã™
                // prompt_key 'csv_field_mapping' (Step 435ã§è¿½åŠ ) ã‚’æŒ‡å®š
                const promptDetail = JSON.stringify(inputData, null, 2);

                const result = await analyzeDocumentWithAI(promptDetail, 'csv_field_mapping');

                let mapping = null;
                // çµæœãŒæ–‡å­—åˆ—(JSONæ–‡å­—åˆ—)ã®å ´åˆã¨ã€æ—¢ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã«å¯¾å¿œ
                if (typeof result === 'string') {
                    try {
                        // Markdownã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯é™¤å»
                        const cleanJson = result.replace(/^```json\s*|\s*```$/g, '').trim();
                        mapping = JSON.parse(cleanJson);
                    } catch (e) {
                        console.error('JSON parse error from AI', e);
                    }
                } else if (typeof result === 'object') {
                    mapping = result;
                }

                if (mapping) {
                    console.log('AI Mapping Result:', mapping);
                    let count = 0;

                    // æ—¢å­˜ã®é¸æŠã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ã‹ã©ã†ã‹ï¼Ÿ -> æ—¢å­˜ã‚’ç”Ÿã‹ã—ã¤ã¤ã€æœªå‰²å½“ã‚’åŸ‹ã‚ã‚‹ã€ã‚ã‚‹ã„ã¯ä¸Šæ›¸ãã™ã‚‹
                    // ã“ã“ã§ã¯ã€Œç©ºæ¬„ã€ã¾ãŸã¯ã€ŒAIãŒã‚ˆã‚Šç¢ºåº¦ã®é«˜ã„ææ¡ˆã‚’ã—ã¦ããŸã€å ´åˆã«é©ç”¨ã™ã‚‹ãŒã€
                    // ã‚·ãƒ³ãƒ—ãƒ«ã«ã€ŒAIã®ææ¡ˆã‚’å…¨é©ç”¨ï¼ˆä¸Šæ›¸ãï¼‰ã€ã¨ã™ã‚‹ã€‚
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ°—ã«å…¥ã‚‰ãªã‘ã‚Œã°æ‰‹å‹•ã§æˆ»ã›ã‚‹ã€‚

                    for (const [key, header] of Object.entries(mapping)) {
                        // ãƒ˜ãƒƒãƒ€ãƒ¼ãŒCSVã«æœ¬å½“ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
                        if (currentCSVHeaders.includes(header)) {
                            const select = $(`.mapping-select[data-key="${key}"]`);
                            if (select.length) {
                                // æ—¢ã«å€¤ãŒå…¥ã£ã¦ã„ã¦ã‚‚ä¸Šæ›¸ãã™ã‚‹
                                select.val(header).trigger('change');
                                count++;
                            }
                        }
                    }
                    alert(`${count}ä»¶ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è‡ªå‹•ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¾ã—ãŸã€‚\nçµæœã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚`);
                } else {
                    alert('AIã«ã‚ˆã‚‹è§£æçµæœã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }

            } catch (err) {
                console.error('AI Auto Map Error:', err);
                alert('AIå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err.message);
            } finally {
                btn.prop('disabled', false).html(originalContent);
            }
        }

        window.previewAIAnalysis = async function () {
            if (!currentCSVData || currentCSVData.length === 0) {
                alert('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            if (currentImportType !== 'jobs') {
                alert('ç¾åœ¨ã€æ±‚äººãƒ‡ãƒ¼ã‚¿ã®AIè§£æãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã¿å¯¾å¿œã—ã¦ã„ã¾ã™');
                return;
            }

            const btn = $(event.currentTarget);
            const originalContent = btn.html();
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>è§£æä¸­...');

            try {
                const row = currentCSVData[0];
                // å…¨ã‚«ãƒ©ãƒ ã‚’ãƒ†ã‚­ã‚¹ãƒˆåŒ–
                const text = Object.entries(row).map(([k, v]) => `${k}: ${v}`).join('\n');

                const options = {
                    job_categories: typeof masterJobCategories !== 'undefined' ? masterJobCategories : [],
                    industry_categories: typeof masterIndustries !== 'undefined' ? masterIndustries : []
                };

                // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚­ãƒ¼ã¯ 'job_description'
                let aiResult = await analyzeDocumentWithAI(text, 'job_description', options);

                // é…åˆ—ã§è¿”ã£ã¦ãã‚‹å ´åˆã¸ã®å¯¾å¿œ
                if (Array.isArray(aiResult)) aiResult = aiResult[0] || {};

                if (typeof aiResult === 'string') {
                    try { aiResult = JSON.parse(aiResult.replace(/```json|```/g, '').trim()); } catch (e) { }
                }

                // ã‚­ãƒ¼ã®æ­£è¦åŒ– (AIã®æºã‚‰ãå¸å)
                if (aiResult.industry_category && !aiResult.industry) aiResult.industry = aiResult.industry_category;
                // ãƒªãƒ¢ãƒ¼ãƒˆå¯å¦ã®è¡¨ç¤ºç”¨å¤‰æ›
                if (aiResult.is_remote === true || aiResult.is_remote === 'true') aiResult.is_remote = 'å¯';
                if (aiResult.is_remote === false || aiResult.is_remote === 'false') aiResult.is_remote = 'ä¸å¯';

                console.log('AI Preview Result:', aiResult);

                // çµæœã‚’è¡¨ç¤º
                $('.ai-preview-badge').remove(); // æ—¢å­˜ã®ãƒãƒƒã‚¸æ¶ˆå»

                let matchCount = 0;
                for (const [key, value] of Object.entries(aiResult)) {
                    if (value === null || value === undefined || value === '') continue;

                    // keyåãŒ jobFields ã® key ã¨ä¸€è‡´ã™ã‚‹ã‚‚ã®ã‚’æ¢ã™
                    const select = $(`.mapping-select[data-key="${key}"]`);
                    if (select.length) {
                        const rowEl = select.closest('tr');
                        const previewCell = rowEl.find('td:last-child');

                        // å€¤ãŒé•·ã„å ´åˆã¯åˆ‡ã‚Šè©°ã‚ã‚‹
                        let displayValue = String(value);
                        if (displayValue.length > 30) displayValue = displayValue.substring(0, 30) + '...';

                        previewCell.append(`
                            <div class="ai-preview-badge mt-2 text-xs text-indigo-700 bg-indigo-50 border border-indigo-200 rounded px-2 py-1 shadow-sm">
                                <strong class="block text-indigo-900 mb-0.5"><i class="fas fa-robot mr-1"></i>AIè§£æ</strong>
                                ${displayValue}
                            </div>
                        `);
                        matchCount++;
                    }
                }

                if (matchCount > 0) {
                    alert(`1ä»¶ç›®ã®è§£æãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n${matchCount}é …ç›®ã®AIè§£æçµæœã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ—ã«è¡¨ç¤ºã—ã¾ã—ãŸã€‚`);
                } else {
                    alert('AIè§£æã‚’å®Ÿè¡Œã—ã¾ã—ãŸãŒã€è¡¨ç¤ºã§ãã‚‹é …ç›®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\nè§£æçµæœ: ' + JSON.stringify(aiResult, null, 2));
                }

            } catch (e) {
                console.error(e);
                alert('è§£æå¤±æ•—: ' + e.message);
            } finally {
                btn.prop('disabled', false).html(originalContent);
            }
        }

        let suspectedDuplicates = [];
        window.closeSuspectedDuplicatesModal = function () {
            $('#suspected-duplicates-modal').addClass('hidden');
            suspectedDuplicates = [];
        };

        window.toggleDuplicateCheckAll = function (el) {
            $('.duplicate-row-check').prop('checked', $(el).is(':checked'));
        };

        window.importSelectedDuplicates = async function () {
            const selectedIndices = [];
            $('.duplicate-row-check:checked').each(function () {
                selectedIndices.push(parseInt($(this).val()));
            });

            if (selectedIndices.length === 0) {
                alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹æ±‚äººã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            if (!confirm(`${selectedIndices.length}ä»¶ã®æ±‚äººã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ`)) return;

            showLoading('é¸æŠã—ãŸé‡è¤‡ç–‘ã„æ±‚äººã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...');
            let successCount = 0;
            let failedCount = 0;
            const errors = [];

            try {
                for (const index of selectedIndices) {
                    const item = suspectedDuplicates[index];
                    try {
                        const { error } = await supabase.from('jobs').insert(item.data);
                        if (error) throw error;
                        successCount++;
                    } catch (err) {
                        console.error('Manual import error:', err);
                        failedCount++;
                        errors.push({ row: item.row, error: err.message });
                    }
                }

                alert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†\næˆåŠŸ: ${successCount}ä»¶\nå¤±æ•—: ${failedCount}ä»¶${failedCount > 0 ? '\n\nã‚¨ãƒ©ãƒ¼å†…å®¹:\n' + errors.map(e => `${e.row}è¡Œç›®: ${e.error}`).join('\n') : ''}`);
                closeSuspectedDuplicatesModal();
                if (typeof loadAdminJobs === 'function') loadAdminJobs();
            } catch (err) {
                alert('å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err.message);
            } finally {
                hideLoading();
            }
        };

        window.executeCSVImport = async function () {
            showLoading();
            suspectedDuplicates = [];
            try {
                const mapping = {};
                let missingRequired = [];
                const fields = currentImportType === 'jobs' ? jobFields :
                    currentImportType === 'companies' ? companyFields : userFields;

                const isUpsert = $('#csv-upsert-mode').is(':checked');
                const upsertKey = $('#csv-upsert-key').val();

                if (isUpsert && !upsertKey) {
                    alert('ã‚¢ãƒƒãƒ—ã‚µãƒ¼ãƒˆã‚’æœ‰åŠ¹ã«ã™ã‚‹å ´åˆã¯ã€æ›´æ–°ã‚­ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
                    hideLoading();
                    return;
                }

                // ãƒãƒƒãƒ”ãƒ³ã‚°æƒ…å ±ã®åé›†
                $('.mapping-select').each(function () {
                    const key = $(this).data('key');
                    const header = $(this).val();
                    if (header) {
                        mapping[key] = header;
                    } else {
                        const field = fields.find(f => f.key === key);
                        if (field && field.required) {
                            // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å¿…é ˆãƒã‚§ãƒƒã‚¯ã‚’çµ„ç¹”è¨­å®šã«åŸºã¥ã„ã¦ã‚¹ã‚­ãƒƒãƒ—
                            if ((currentImportType === 'users' || currentImportType === 'candidates') && field.key === 'email') {
                                if (currentUser.organizations && currentUser.organizations.settings && currentUser.organizations.settings.candidate_email_required === false) {
                                    return; // ã‚¹ã‚­ãƒƒãƒ—
                                }
                            }
                            missingRequired.push(field.label);
                        }
                    }
                });

                if (missingRequired.length > 0) {
                    alert(`å¿…é ˆé …ç›®ãŒãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¦ã„ã¾ã›ã‚“: ${missingRequired.join(', ')}`);
                    hideLoading();
                    return;
                }

                let successCount = 0;
                let failedCount = 0;
                let skipCount = 0;
                const errors = [];
                const skips = [];

                const salaryUnit = $('input[name="csv-salary-unit"]:checked').val() || 'auto';

                for (let i = 0; i < currentCSVData.length; i++) {
                    const row = currentCSVData[i];
                    // ãƒ‡ãƒ¼ã‚¿è¡Œæ•°ï¼ˆ1å§‹ã¾ã‚Šï¼‰
                    const csvRowNumber = i + 1;
                    // è¡¨ç¤ºç”¨è¡Œæ•°ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ãŒã‚ã‚‹ãŸã‚ +1ï¼‰
                    const displayRowNumber = i + 2;

                    try {
                        const importData = {};
                        // ãƒãƒƒãƒ”ãƒ³ã‚°ã«åŸºã¥ã„ã¦ãƒ‡ãƒ¼ã‚¿å¤‰æ›
                        for (const [key, header] of Object.entries(mapping)) {
                            let value = row[header];

                            // æ•°å€¤å¤‰æ›ãŒå¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å‡¦ç†
                            if (['salary_min', 'salary_max', 'desired_salary'].includes(key)) {
                                if (value) {
                                    value = String(value).replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
                                    const numStr = value.replace(/[^0-9]/g, '');
                                    const num = parseInt(numStr);
                                    if (!isNaN(num)) {
                                        if (salaryUnit === 'man') {
                                            value = num * 10000;
                                        } else if (salaryUnit === 'yen') {
                                            value = num;
                                        } else {
                                            // auto
                                            value = num < 10000 ? num * 10000 : num;
                                        }
                                    } else {
                                        value = null;
                                    }
                                } else {
                                    value = null;
                                }
                            }

                            if (key === 'is_remote') {
                                value = ['true', 'yes', '1', 'å¯', 'ã‚ã‚Š', 'æœ‰', 'ok', 'ã€‡', 'â—¯'].includes(String(value).toLowerCase());
                            }

                            if (key === 'job_experience_ok' || key === 'industry_experience_ok') {
                                const isPos = ['true', 'yes', '1', 'å¯', 'ã‚ã‚Š', 'æœ‰', 'ok', 'ã€‡', 'â—¯'].includes(String(value).toLowerCase());
                                value = isPos ? 'å¯' : 'ä¸å¯';
                            }

                            importData[key] = value;
                        }

                        importData.organization_id = currentUser.organization_id;

                        if (currentImportType === 'jobs') {
                            // AIè‡ªå‹•è£œå®Œ
                            const useAI = $('#csv-ai-augment').is(':checked');
                            if (useAI) {
                                const jobText = Object.entries(row).map(([k, v]) => `${k}: ${v}`).join('\n');
                                const options = {
                                    job_categories: typeof masterJobCategories !== 'undefined' ? masterJobCategories : [],
                                    industry_categories: typeof masterIndustries !== 'undefined' ? masterIndustries : []
                                };
                                try {
                                    let aiResult = await analyzeDocumentWithAI(jobText, 'job_description', options);
                                    if (Array.isArray(aiResult)) aiResult = aiResult[0] || {};
                                    if (aiResult) {
                                        if (!importData.job_category && aiResult.job_category) importData.job_category = aiResult.job_category;
                                        if (!importData.industry_category && aiResult.industry_category) importData.industry_category = aiResult.industry_category;
                                        if (!importData.is_remote) {
                                            if (aiResult.is_remote === true || aiResult.is_remote === 'true') importData.is_remote = 'å¯';
                                            else if (aiResult.is_remote === false || aiResult.is_remote === 'false') importData.is_remote = 'ä¸å¯';
                                            else if (aiResult.is_remote) importData.is_remote = aiResult.is_remote;
                                        }
                                        if (!importData.industry) importData.industry = aiResult.industry || aiResult.industry_category;

                                        if (aiResult.requirements) {
                                            if (!importData.requirements || importData.requirements.length < 10 || aiResult.requirements.length > importData.requirements.length) {
                                                importData.requirements = aiResult.requirements;
                                            }
                                        }
                                        if (aiResult.welcome_requirements) {
                                            if (!importData.welcome_requirements || importData.welcome_requirements.length < 5 || aiResult.welcome_requirements.length > importData.welcome_requirements.length) {
                                                importData.welcome_requirements = aiResult.welcome_requirements;
                                            }
                                        }

                                        if (!importData.description && aiResult.description) importData.description = aiResult.description;
                                        if (!importData.work_hours && aiResult.work_hours) importData.work_hours = aiResult.work_hours;
                                        if (!importData.holidays && aiResult.holidays) importData.holidays = aiResult.holidays;
                                        if (!importData.benefits && aiResult.benefits) importData.benefits = aiResult.benefits;
                                        if (!importData.interview_process && aiResult.interview_process) importData.interview_process = aiResult.interview_process;
                                        if (!importData.employment_type && aiResult.employment_type) importData.employment_type = aiResult.employment_type;
                                    }
                                } catch (e) { console.error('AI error:', e); }
                            }

                            if (!importData.title) throw new Error('æ±‚äººã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™');
                            if (!importData.company) throw new Error('ä¼æ¥­åã¯å¿…é ˆã§ã™');

                            // ä¼æ¥­IDã®è§£æ±º
                            let companyId = null;
                            const { data: existingCompany } = await supabase
                                .from('companies')
                                .select('id')
                                .eq('organization_id', currentUser.organization_id)
                                .eq('name', importData.company)
                                .maybeSingle();

                            if (existingCompany) {
                                companyId = existingCompany.id;
                            } else {
                                const { data: newCompany, error: createError } = await supabase
                                    .from('companies')
                                    .insert({
                                        organization_id: currentUser.organization_id,
                                        name: importData.company,
                                        location: importData.location || 'æœªå®š'
                                    })
                                    .select()
                                    .single();
                                if (createError) throw new Error(`ä¼æ¥­ä½œæˆã‚¨ãƒ©ãƒ¼: ${createError.message}`);
                                companyId = newCompany.id;
                            }
                            importData.company_id = companyId;
                            importData.status = 'active';

                            if (importData.industry) {
                                let val = importData.industry;
                                if (typeof masterIndustries !== 'undefined') {
                                    const match = masterIndustries.find(m => m.label === val || m.value === val);
                                    if (match) val = match.value;
                                }
                                importData.industry_category = val;
                                delete importData.industry;
                            }

                            if (importData.job_category) {
                                let val = importData.job_category;
                                if (typeof masterJobCategories !== 'undefined') {
                                    const match = masterJobCategories.find(m => m.label === val || m.value === val);
                                    if (match) val = match.value;
                                }
                                importData.job_category = val;
                            }

                            // é‡è¤‡ç–‘ã„ã®ãƒã‚§ãƒƒã‚¯ (title, company_id, location ãŒä¸€è‡´ã™ã‚‹å ´åˆ)
                            if (!isUpsert) {
                                const { data: suspect, error: suspectError } = await supabase
                                    .from('jobs')
                                    .select('id')
                                    .eq('organization_id', currentUser.organization_id)
                                    .eq('company_id', companyId)
                                    .eq('title', importData.title)
                                    .eq('location', importData.location || '')
                                    .is('deleted_at', null)
                                    .maybeSingle();

                                if (suspect) {
                                    suspectedDuplicates.push({
                                        row: displayRowNumber,
                                        data: importData,
                                        company: importData.company,
                                        title: importData.title,
                                        location: importData.location
                                    });
                                    skipCount++;
                                    skips.push(displayRowNumber);
                                    continue;
                                }
                            }

                            // ã‚¢ãƒƒãƒ—ã‚µãƒ¼ãƒˆå‡¦ç†
                            if (isUpsert && upsertKey && importData[upsertKey]) {
                                const { data: existingRecord } = await supabase
                                    .from('jobs')
                                    .select('id')
                                    .eq('organization_id', currentUser.organization_id)
                                    .eq(upsertKey, importData[upsertKey])
                                    .is('deleted_at', null)
                                    .maybeSingle();

                                if (existingRecord) {
                                    const { error } = await supabase.from('jobs').update(importData).eq('id', existingRecord.id);
                                    if (error) throw error;
                                } else {
                                    const { error } = await supabase.from('jobs').insert(importData);
                                    if (error) throw error;
                                }
                            } else {
                                const { error } = await supabase.from('jobs').insert(importData);
                                if (error) throw error;
                            }

                        } else if (currentImportType === 'companies') {
                            if (!importData.name) throw new Error('ä¼æ¥­åã¯å¿…é ˆã§ã™');

                            if (isUpsert && upsertKey && importData[upsertKey]) {
                                const { data: existingRecord } = await supabase
                                    .from('companies')
                                    .select('id')
                                    .eq('organization_id', currentUser.organization_id)
                                    .eq(upsertKey, importData[upsertKey])
                                    .maybeSingle();

                                if (existingRecord) {
                                    const { error } = await supabase.from('companies').update(importData).eq('id', existingRecord.id);
                                    if (error) throw error;
                                } else {
                                    const { error } = await supabase.from('companies').insert(importData);
                                    if (error) throw error;
                                }
                            } else {
                                const { error } = await supabase.from('companies').insert(importData);
                                if (error) throw error;
                            }

                        } else if (currentImportType === 'users') {
                            if (!importData.role) importData.role = 'candidate';
                            let emailRequired = true;
                            if (importData.role === 'candidate' && currentUser.organizations?.settings?.candidate_email_required === false) {
                                emailRequired = false;
                            }

                            if (!importData.email) {
                                if (emailRequired) throw new Error('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¿…é ˆã§ã™');
                                importData.email = `candidate-${Date.now()}-${crypto.randomUUID().substring(0, 8)}@placeholder.local`;
                            }
                            if (!importData.name) throw new Error('æ°åã¯å¿…é ˆã§ã™');

                            if (isUpsert && upsertKey && importData[upsertKey]) {
                                const { data: existingRecord } = await supabase
                                    .from('users')
                                    .select('id')
                                    .eq('organization_id', currentUser.organization_id)
                                    .eq(upsertKey, importData[upsertKey])
                                    .maybeSingle();

                                if (existingRecord) {
                                    const { error } = await supabase.from('users').update(importData).eq('id', existingRecord.id);
                                    if (error) throw error;
                                } else {
                                    const { error } = await supabase.from('users').insert(importData);
                                    if (error) throw error;
                                }
                            } else {
                                const { data: existingUser } = await supabase.from('users').select('id').eq('email', importData.email).maybeSingle();
                                if (existingUser) throw new Error(`æ—¢ã«å­˜åœ¨ã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™: ${importData.email}`);

                                const { error } = await supabase.from('users').insert(importData);
                                if (error) throw error;
                            }

                        } else if (currentImportType === 'candidates') {
                            importData.role = 'candidate';

                            if (!currentUser.organizations || !currentUser.organizations.settings || currentUser.role === 'super_admin') {
                                try {
                                    const { data: freshOrg } = await supabase.from('organizations').select('settings').eq('id', currentUser.organization_id).single();
                                    if (freshOrg) {
                                        if (!currentUser.organizations) currentUser.organizations = {};
                                        currentUser.organizations.settings = freshOrg.settings;
                                    }
                                } catch (e) { console.warn('Failed to refresh org settings before import', e); }
                            }

                            const orgSettings = (Array.isArray(currentUser.organizations) ? currentUser.organizations[0]?.settings : currentUser.organizations?.settings) || {};
                            const emailRequired = orgSettings.candidate_email_required !== false;
                            const passwordRequired = orgSettings.candidate_password_required !== false;

                            if (!importData.email || importData.email.trim() === '') {
                                if (emailRequired) throw new Error('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¿…é ˆã§ã™');
                                importData.email = `candidate-${Date.now()}-${Math.random().toString(36).substring(2, 10)}@placeholder.local`;
                            }
                            if (!importData.password || importData.password.trim() === '') {
                                if (passwordRequired) throw new Error('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¿…é ˆã§ã™');
                                importData.password = `dummyPass${Math.random().toString(36).substring(2, 15)}`;
                            }
                            if (!importData.name || importData.name.trim() === '') throw new Error('æ°åã¯å¿…é ˆã§ã™');

                            const { data, error } = await supabase.functions.invoke('create-user', {
                                body: {
                                    email: importData.email,
                                    password: importData.password,
                                    name: importData.name,
                                    role: 'candidate',
                                    organizationId: currentUser.organization_id,
                                    upsert: isUpsert,
                                    profileData: {
                                        age: importData.age || null,
                                        desired_job_type: importData.desired_job_type ?
                                            (typeof importData.desired_job_type === 'string' ? importData.desired_job_type.split(/[,ã€\uff0c\uff0f\sã€€]+/).map(s => s.trim()).filter(Boolean) : importData.desired_job_type) : null,
                                        desired_location: importData.desired_location ?
                                            (typeof importData.desired_location === 'string' ? importData.desired_location.split(/[,ã€\uff0c\uff0f\sã€€]+/).map(s => s.trim()).filter(Boolean) : importData.desired_location) : null,
                                        desired_salary: importData.desired_salary || null,
                                        skills: importData.skills || null,
                                        work_history: importData.work_history || null,
                                        academic_background: importData.academic_background || null,
                                        languages: importData.languages || null,
                                        certifications: importData.certifications || null,
                                        matching_info: importData.matching_info || null,
                                        internal_info: importData.internal_info || null,
                                        other_info: importData.other_info || null
                                    }
                                }
                            });

                            if (error || !data.success) throw new Error(error?.message || data?.error || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆå¤±æ•—');
                        }

                        successCount++;
                    } catch (err) {
                        console.error(`Row ${displayRowNumber} error:`, err);
                        failedCount++;
                        errors.push({ row: displayRowNumber, data: row, error: err.message || JSON.stringify(err) });
                    }
                }

                await supabase.from('csv_imports').insert({
                    organization_id: currentUser.organization_id,
                    user_id: currentUser.id,
                    import_type: currentImportType,
                    file_name: 'import.csv',
                    total_rows: currentCSVData.length,
                    success_rows: successCount,
                    failed_rows: failedCount,
                    errors: errors
                });

                closeCSVMappingModal();
                let message = `ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†\næˆåŠŸ: ${successCount}ä»¶\nå¤±æ•—: ${failedCount}ä»¶\nã‚¹ã‚­ãƒƒãƒ—: ${skipCount}ä»¶`;

                if (failedCount > 0) {
                    message += `\n\nã‚¨ãƒ©ãƒ¼ã¨ãªã£ãŸCSVè¡Œ:\n` + errors.map(e => `${e.row}è¡Œç›®`).join(', ');
                    if (errors.length > 5) {
                        message += `\n(ã‚¨ãƒ©ãƒ¼å†…å®¹ [æœ€åˆã®5ä»¶]: ` + errors.slice(0, 5).map(e => `${e.row}è¡Œç›®: ${e.error}`).join('\n') + `)`;
                    } else {
                        message += `\n(ã‚¨ãƒ©ãƒ¼å†…å®¹: ` + errors.map(e => `${e.row}è¡Œç›®: ${e.error}`).join('\n') + `)`;
                    }
                }

                if (skipCount > 0) {
                    message += `\n\né‡è¤‡ç–‘ã„ã§ã‚¹ã‚­ãƒƒãƒ—ã—ãŸCSVè¡Œ:\n` + skips.join(', ');
                }

                alert(message);

                if (suspectedDuplicates.length > 0) {
                    const tbody = $('#suspected-duplicates-tbody');
                    tbody.empty();
                    suspectedDuplicates.forEach((item, index) => {
                        const row = `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <input type="checkbox" class="duplicate-row-check rounded text-indigo-600" value="${index}">
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-gray-500">${item.row}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-amber-600 font-medium">é‡è¤‡ã®ç–‘ã„</td>
                                <td class="px-6 py-4 whitespace-nowrap">${item.company}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${item.title}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${item.location || '-'}</td>
                            </tr>
                        `;
                        tbody.append(row);
                    });
                    $('#suspected-duplicates-modal').removeClass('hidden');
                }

                if (currentImportType === 'jobs') { if (typeof loadAdminJobs === 'function') loadAdminJobs(); }
                else if (currentImportType === 'companies') { if (typeof loadCompanies === 'function') loadCompanies(); }
                else if (currentImportType === 'users' || currentImportType === 'candidates') { if (typeof loadAdminUsers === 'function') loadAdminUsers(); }
                if (typeof loadCSVHistory === 'function') loadCSVHistory();

            } catch (err) {
                console.error('Import process error:', err);
                alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†ä¸­ã«è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err.message);
            } finally {
                hideLoading();
            }
        };


        async function loadCSVHistory() {
            try {
                const orgSettings = (Array.isArray(currentUser.organizations) ? currentUser.organizations[0]?.settings : currentUser.organizations?.settings) || {};
                const driveImportEnabled = orgSettings.drive_import_enabled === true;
                $('#admin-drive-import-section').toggleClass('hidden', !driveImportEnabled);
                $('#admin-job-drive-import-btn').toggleClass('hidden', !driveImportEnabled);

                const { data: history, error } = await supabase
                    .from('csv_imports')
                    .select('*')
                    .eq('organization_id', currentUser.organization_id)
                    .order('created_at', { ascending: false })
                    .limit(10)

                if (error) throw error

                const container = $('#csv-history-container')
                container.empty()

                if (history.length === 0) {
                    container.html('<p class="text-gray-500 text-sm">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>')
                    return
                }

                const html = history.map(h => `
                    <div class="border-b py-3 last:border-0">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-medium text-sm">${h.file_name}</span>
                            <span class="text-xs text-gray-500">${new Date(h.created_at).toLocaleString('ja-JP')}</span>
                        </div>
                        <div class="text-xs flex gap-4">
                            <span class="text-green-600">æˆåŠŸ: ${h.success_rows}</span>
                            <span class="text-red-600">å¤±æ•—: ${h.failed_rows}</span>
                            <span class="text-gray-600">ã‚¿ã‚¤ãƒ—: ${h.import_type}</span>
                        </div>
                    </div>
                `).join('')

                container.html(html)
            } catch (error) {
                console.error('Load CSV history error:', error)
            }
        }

        // ========================
        // Admin: Audit Logs
        // ========================
        async function logAction(action, entityType, entityId, details = {}) {
            if (!currentUser) return

            try {
                await supabase.from('audit_logs').insert({
                    organization_id: currentUser.organization_id,
                    user_id: currentUser.id,
                    action: action,
                    entity_type: entityType,
                    entity_id: entityId,
                    details: details,
                    user_agent: navigator.userAgent
                })
            } catch (error) {
                console.error('Log action error:', error)
            }
        }

        window.loadAuditLogs = async function () {
            if (!currentUser) return

            showLoading()
            try {
                let query = supabase
                    .from('audit_logs')
                    .select('*, users(name)')
                    .eq('organization_id', currentUser.organization_id)
                    .order('created_at', { ascending: false })
                    .limit(50)

                const filterAction = $('#log-filter-action').val()
                if (filterAction) {
                    query = query.eq('action', filterAction)
                }

                const { data: logs, error } = await query

                if (error) throw error

                const container = $('#audit-logs-container')
                container.empty()

                if (logs.length === 0) {
                    container.html('<p class="text-gray-500 text-center py-8">ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</p>')
                    return
                }

                const actionLabels = {
                    'create': { label: 'ä½œæˆ', color: 'bg-green-100 text-green-800' },
                    'update': { label: 'æ›´æ–°', color: 'bg-blue-100 text-blue-800' },
                    'delete': { label: 'å‰Šé™¤', color: 'bg-red-100 text-red-800' },
                    'login': { label: 'ãƒ­ã‚°ã‚¤ãƒ³', color: 'bg-gray-100 text-gray-800' },
                    'logout': { label: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ', color: 'bg-gray-100 text-gray-800' },
                    'apply': { label: 'å¿œå‹Ÿ', color: 'bg-indigo-100 text-indigo-800' },
                    'recommend': { label: 'AIæ¨è–¦', color: 'bg-purple-100 text-purple-800' },
                    'bulk_recommend': { label: 'ä¸€æ‹¬AIæ¨è–¦', color: 'bg-purple-100 text-purple-800' },
                    'csv_import': { label: 'CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ', color: 'bg-yellow-100 text-yellow-800' }
                }

                const html = logs.map(log => {
                    const action = actionLabels[log.action] || { label: log.action, color: 'bg-gray-100 text-gray-800' }
                    const details = log.details ? JSON.stringify(log.details, null, 2) : 'è©³ç´°ãªã—';
                    const targetType = log.resource_type || log.target_type || log.entity_type || 'ä¸æ˜';

                    return `
                        <div class="bg-white border border-gray-200 rounded-lg p-4 mb-3 text-sm">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center gap-2">
                                    <span class="px-2 py-1 rounded text-xs font-medium ${action.color}">${action.label}</span>
                                    <span class="font-bold text-gray-900">${log.users?.name || 'ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼'}</span>
                                    <span class="text-gray-500">ãŒ ${targetType} ã‚’æ“ä½œã—ã¾ã—ãŸ</span>
                                </div>
                                <span class="text-xs text-gray-400">${new Date(log.created_at).toLocaleString('ja-JP')}</span>
                            </div>
                            <details class="mt-2">
                                <summary class="cursor-pointer text-xs text-indigo-600 hover:text-indigo-800">è©³ç´°ã‚’è¡¨ç¤º</summary>
                                <pre class="mt-2 p-2 bg-gray-50 rounded text-xs overflow-x-auto">${details}</pre>
                            </details>
                        </div>
                    `
                }).join('')

                container.html(html)
            } catch (error) {
                console.error('Load audit logs error:', error)
                $('#audit-logs-container').html('<p class="text-red-500">ãƒ­ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>')
            } finally {
                hideLoading()
            }
        }



        // ========================
        // Admin: Prompt Settings
        // ========================
        // ========================
        // Multi-tenant: Organization Switching
        // ========================
        window.showOrgSelectModalForSwitch = async function () {
            if (!currentUser) return;
            showLoading('æ‰€å±çµ„ç¹”ã‚’å–å¾—ä¸­...');
            try {
                // user_idã ã‘ã§ãªãã€å¿µã®ãŸã‚ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒä¸€è‡´ã™ã‚‹å…¨æ‰€å±ã‚’å–å¾—
                // â€» organization_members ã« email ã‚«ãƒ©ãƒ ã¯ãªã„ãŸã‚ã€usersãƒ†ãƒ¼ãƒ–ãƒ«ã‚’çµŒç”±ã—ã¦å–å¾—
                const { data: memberships, error } = await supabase
                    .from('organization_members')
                    .select('organization_id, role, organizations(name, code), users!inner(email)')
                    .eq('users.email', currentUser.email);

                console.log('Switch Modal Debug: All memberships for email', currentUser.email, ':', memberships);

                if (error) {
                    console.error('Switch Modal Debug: Error fetching memberships:', error);
                    throw error;
                }

                if (!memberships || memberships.length === 0) {
                    console.warn('Switch Modal Debug: No memberships found for user', currentUser.id);
                }

                const modal = $('#org-select-modal');
                const list = $('#org-select-list');
                list.empty();

                memberships.forEach(m => {
                    const org = m.organizations;
                    const isCurrent = m.organization_id === currentUser.organization_id;
                    const btn = $(`
                        <button class="w-full text-left px-4 py-3 ${isCurrent ? 'bg-indigo-600 text-white' : 'bg-gray-50 text-gray-900 hover:bg-indigo-50'} border rounded-lg transition items-center flex justify-between group">
                            <div>
                                <div class="font-bold">${org.name} ${isCurrent ? '<span class="text-[10px] ml-2 font-normal">(ç¾åœ¨é¸æŠä¸­)</span>' : ''}</div>
                                <div class="text-xs ${isCurrent ? 'text-indigo-200' : 'text-gray-500'}">Role: ${m.role}</div>
                            </div>
                            <i class="fas fa-chevron-right ${isCurrent ? 'text-white' : 'text-gray-300'}"></i>
                        </button>
                    `);
                    btn.on('click', async (e) => {
                        e.preventDefault();
                        if (isCurrent) {
                            modal.addClass('hidden');
                            return;
                        }
                        await switchOrganization(m.organization_id, m.role, org.name);
                        modal.addClass('hidden');
                    });
                    list.append(btn);
                });

                hideLoading();
                modal.removeClass('hidden');
            } catch (error) {
                console.error('Fetch memberships error:', error);
                alert('çµ„ç¹”æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                hideLoading();
            }
        };

        async function switchOrganization(orgId, role, orgName) {
            showLoading(`${orgName} ã«åˆ‡ã‚Šæ›¿ãˆä¸­...`);
            try {
                // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¾åœ¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçµ„ç¹”ã‚’æ›´æ–°
                await supabase.from('users').update({
                    organization_id: orgId,
                    role: role // æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯äº’æ›ã®ãŸã‚usersã®roleã‚‚ä¸€å¿œæ›´æ–°ï¼ˆRLSãŒé€šã‚‹å ´åˆã®ã¿ï¼‰
                }).eq('id', currentUser.id);

                // 2. ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’æ›´æ–°
                currentUser.organization_id = orgId;
                currentUser.role = role;
                currentUser.organizations = { name: orgName };
                window.currentUser = currentUser;

                // 3. UIã®è¡¨ç¤ºã‚’åˆæœŸåŒ–
                $('#user-role').text(getRoleLabel(role));
                $('#org-name').text(orgName);
                $('#org-code-display').text(''); // çµ„ç¹”ã‚³ãƒ¼ãƒ‰ã¯å¾Œã§æ›´æ–°ã•ã‚Œã‚‹

                // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®å†æ§‹ç¯‰ï¼ˆå½¹å‰²ã«å¿œã˜ã¦è¡¨ç¤º/éè¡¨ç¤ºï¼‰
                loadedPages.clear(); // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
                updateMenuVisibility(role);

                // 4. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸æˆ»ã‚‹
                await loadDashboard();
                showAppContent('dashboard-content');
                $('.nav-link').removeClass('bg-indigo-50 text-indigo-600');
                $('.nav-link[data-page="dashboard"]').addClass('bg-indigo-50 text-indigo-600');

                alert(`${orgName} ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ`);
            } catch (error) {
                console.error('Switch organization error:', error);
                alert('åˆ‡ã‚Šæ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
            } finally {
                hideLoading();
            }
        }

        function updateMenuVisibility(role) {
            const adminRoles = ['org_admin', 'admin', 'super_admin'];
            const staffRoles = ['org_admin', 'admin', 'coach', 'ca', 'ra', 'super_admin'];

            if (adminRoles.includes(role)) $('#admin-menu').removeClass('hidden');
            else $('#admin-menu').addClass('hidden');

            if (role === 'super_admin') $('#super-admin-menu').removeClass('hidden');
            else $('#super-admin-menu').addClass('hidden');

            if (staffRoles.includes(role)) {
                $('#coach-menu').removeClass('hidden');
                $('#ai-scout-link').removeClass('hidden');
                $('#nav-candidate-search').removeClass('hidden');
            } else {
                $('#coach-menu').addClass('hidden');
                $('#ai-scout-link').addClass('hidden');
                $('#nav-candidate-search').addClass('hidden');
            }

            if (role === 'candidate') $('#nav-dashboard').addClass('hidden');
            else $('#nav-dashboard').removeClass('hidden');
        }

        // ========================
        // Super Admin: Organization Management
        // ========================
        let superAdminOrgsCache = [];

        async function loadSuperAdminOrganizations() {
            console.log('--- loadSuperAdminOrganizations START ---');
            if (!currentUser) {
                console.error('loadSuperAdminOrganizations: currentUser is missing');
                return;
            }
            console.log('Current user role:', currentUser.role);
            if (currentUser.role !== 'super_admin') {
                console.warn('loadSuperAdminOrganizations: User is not super_admin');
                return;
            }

            showLoading();
            try {
                console.log('Fetching organizations from Supabase...');
                const { data: orgs, error } = await supabase
                    .from('organizations')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Supabase fetch error:', error);
                    throw error;
                }

                console.log('Orgs fetched:', orgs ? orgs.length : 0);
                superAdminOrgsCache = orgs || [];
                renderSuperAdminOrganizations(superAdminOrgsCache);
            } catch (error) {
                console.error('Load organizations error:', error);
                const $errContainer = $('#super-admin-organizations-container');
                if ($errContainer.length) {
                    $errContainer.html('<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message + '</td></tr>');
                } else {
                    console.error('Error container NOT FOUND');
                }
            } finally {
                hideLoading();
                console.log('--- loadSuperAdminOrganizations END ---');
            }
        }

        function renderSuperAdminOrganizations(orgs) {
            console.log('renderSuperAdminOrganizations called with', orgs.length, 'orgs');
            const container = $('#super-admin-organizations-container');
            console.log('Container found:', container.length);

            if (container.length === 0) {
                console.error('CRITICAL: #super-admin-organizations-container NOT FOUND IN DOM');
                return;
            }

            container.empty();

            if (orgs.length === 0) {
                console.log('No orgs to display.');
                container.html('<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">çµ„ç¹”ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>');
                return;
            }

            const html = orgs.map(org => {
                const statusColors = {
                    'active': 'bg-green-100 text-green-800',
                    'suspended': 'bg-red-100 text-red-800',
                    'cancelled': 'bg-gray-100 text-gray-800'
                };
                const statusLabel = {
                    'active': 'æœ‰åŠ¹',
                    'suspended': 'åœæ­¢ä¸­',
                    'cancelled': 'è§£ç´„æ¸ˆ'
                };
                const planLabel = {
                    'free': 'Free',
                    'standard': 'Standard',
                    'premium': 'Premium'
                };

                return `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${org.name}</div>
                        <div class="text-xs text-gray-500">ID: ${org.id}</div>
                        <div class="text-xs text-indigo-600 font-mono mt-1">Code: ${org.code || '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                            ${planLabel[org.plan_type] || org.plan_type || 'Free'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColors[org.status] || 'bg-gray-100 text-gray-800'}">
                            ${statusLabel[org.status] || org.status || 'Active'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${org.max_users || 5}å
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${org.valid_until ? new Date(org.valid_until).toLocaleDateString('ja-JP') : '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="showOrganizationModal('${org.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">
                            <i class="fas fa-edit"></i> ç·¨é›†
                        </button>
                        <button onclick="generateInvitationForOrg('${org.id}')" class="text-green-600 hover:text-green-900">
                            <i class="fas fa-user-plus"></i> æ‹›å¾…URLç™ºè¡Œ
                        </button>
                    </td>
                </tr>
                `;
            }).join('');

            container.html(html);
        }

        window.showOrganizationModal = function (orgId = null) {
            console.log('showOrganizationModal called with ID:', orgId);
            try {
                const form = $('#organization-form')[0];
                if (!form) {
                    console.error('Organization form not found');
                    return;
                }
                form.reset();
                $('#org-id').val('');

                if (orgId) {
                    const org = superAdminOrgsCache.find(o => o.id === orgId);
                    if (org) {
                        $('#org-modal-title').text('çµ„ç¹”ç·¨é›†');
                        $('#org-id').val(org.id);
                        $('#org-name-input').val(org.name);
                        $('#org-plan').val(org.plan_type || 'free');
                        $('#org-status').val(org.status || 'active');
                        $('#org-max-users').val(org.max_users || 5);
                        if (org.valid_until) {
                            $('#org-valid-until').val(new Date(org.valid_until).toISOString().split('T')[0]);
                        }
                        // ç·¨é›†æ™‚ã¯åˆæœŸç®¡ç†è€…å…¥åŠ›æ¬„ã‚’éš ã™
                        $('#org-initial-admin-fields').addClass('hidden');
                        $('#org-admin-name').removeAttr('required');
                        $('#org-admin-email').removeAttr('required');

                        // è¨­å®šã®èª­ã¿è¾¼ã¿
                        const settings = org.settings || {};
                        $('#org-setting-email-required').prop('checked', settings.candidate_email_required !== false); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆtrue
                        $('#org-setting-password-required').prop('checked', settings.candidate_password_required !== false); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆtrue
                        $('#org-setting-limit-agent-view').prop('checked', settings.limit_agent_view === true); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆfalse

                        // Google Drive è¨­å®šã®èª­ã¿è¾¼ã¿
                        const driveEnabled = settings.drive_transfer_enabled === true;
                        $('#org-setting-drive-transfer-enabled').prop('checked', driveEnabled);
                        $('#org-setting-drive-gas-url').val(settings.drive_gas_url || '');
                        $('#org-setting-drive-column').val(settings.drive_column || 'pdf_url');
                        $('#drive-transfer-settings-container').toggleClass('hidden', !driveEnabled);

                        // Google Drive ã‚¤ãƒ³ãƒãƒ¼ãƒˆè¨­å®šã®èª­ã¿è¾¼ã¿
                        const driveImportEnabled = settings.drive_import_enabled === true;
                        $('#org-setting-drive-import-enabled').prop('checked', driveImportEnabled);
                        $('#org-setting-drive-import-gas-url').val(settings.drive_import_gas_url || '');
                        $('#drive-import-settings-container').toggleClass('hidden', !driveImportEnabled);

                        // æ±‚äººé‡è¤‡ä¸€æ‹¬ç¢ºèªè¨­å®š
                        $('#org-setting-bulk-duplicate-confirm').prop('checked', settings.bulk_duplicate_confirm_enabled === true);

                        // ãƒ­ãƒ¼ãƒ«åç§°ã®èª­ã¿è¾¼ã¿
                        const roleLabels = settings.role_labels || {};
                        $('#org-role-label-org_admin').val(roleLabels.org_admin || '');
                        $('#org-role-label-admin').val(roleLabels.admin || '');
                        $('#org-role-label-coach').val(roleLabels.coach || '');
                        $('#org-role-label-candidate').val(roleLabels.candidate || '');
                    } else {
                        console.warn(`Organization with ID ${orgId} not found in cache.`);
                    }
                } else {
                    $('#org-modal-title').text('æ–°è¦çµ„ç¹”ä½œæˆ');
                    $('#org-plan').val('free');
                    $('#org-status').val('active');
                    $('#org-max-users').val(5);
                    // æ–°è¦æ™‚ã¯åˆæœŸç®¡ç†è€…å…¥åŠ›æ¬„ã‚’è¡¨ç¤º
                    $('#org-initial-admin-fields').removeClass('hidden');
                    $('#org-admin-name').attr('required', 'required');
                    $('#org-admin-email').attr('required', 'required');

                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
                    $('#org-setting-email-required').prop('checked', true);
                    $('#org-setting-password-required').prop('checked', true);
                }

                console.log('Toggling modal visibility...');
                const $modal = $('#organization-modal');
                console.log('Modal found:', $modal.length);
                if ($modal.length > 0) {
                    $modal.removeClass('hidden').css('z-index', '1000000');
                    console.log('Modal hidden class removed. Current display:', $modal.css('display'));
                } else {
                    console.error('CRITICAL: #organization-modal NOT FOUND IN DOM');
                }
            } catch (error) {
                console.error('Error in showOrganizationModal:', error);
                alert('ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        window.closeOrganizationModal = function () {
            $('#organization-modal').addClass('hidden');
        }

        // çµ„ç¹”ä¿å­˜å‡¦ç†
        $('#organization-form').on('submit', async function (e) {
            e.preventDefault();
            if (!currentUser || currentUser.role !== 'super_admin') return;

            const orgId = $('#org-id').val();
            const orgData = {
                name: $('#org-name-input').val().trim(),
                plan_type: $('#org-plan').val(),
                status: $('#org-status').val(),
                max_users: parseInt($('#org-max-users').val()),
                valid_until: $('#org-valid-until').val() ? new Date($('#org-valid-until').val()).toISOString() : null,
                updated_at: new Date().toISOString()
            };

            // slugã®æ‰±ã„
            if (!orgId) {
                orgData.slug = 'org-' + Date.now().toString(36) + '-' + Math.random().toString(36).substring(2, 7);
                // ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ (8æ¡ã®ãƒ©ãƒ³ãƒ€ãƒ ãªè‹±æ•°å­—)
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let code = '';
                for (let i = 0; i < 8; i++) {
                    code += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                orgData.code = code;
            }

            // ç¾åœ¨ã®è¨­å®šã‚’å–å¾—ã—ã¦ãƒãƒ¼ã‚¸
            let currentSettings = {};
            if (orgId && typeof superAdminOrgsCache !== 'undefined') {
                const existingOrg = superAdminOrgsCache.find(o => o.id === orgId);
                if (existingOrg && existingOrg.settings) {
                    currentSettings = existingOrg.settings;
                }
            }

            orgData.settings = {
                ...currentSettings,
                candidate_email_required: $('#org-setting-email-required').is(':checked'),
                candidate_password_required: $('#org-setting-password-required').is(':checked'),
                limit_agent_view: $('#org-setting-limit-agent-view').is(':checked'),
                drive_transfer_enabled: $('#org-setting-drive-transfer-enabled').is(':checked'),
                drive_gas_url: $('#org-setting-drive-gas-url').val().trim() || null,
                drive_column: $('#org-setting-drive-column').val().trim() || 'pdf_url',
                drive_import_enabled: $('#org-setting-drive-import-enabled').is(':checked'),
                drive_import_gas_url: $('#org-setting-drive-import-gas-url').val().trim() || null,
                bulk_duplicate_confirm_enabled: $('#org-setting-bulk-duplicate-confirm').is(':checked'),
                role_labels: {
                    org_admin: $('#org-role-label-org_admin').val().trim() || null,
                    admin: $('#org-role-label-admin').val().trim() || null,
                    coach: $('#org-role-label-coach').val().trim() || null,
                    candidate: $('#org-role-label-candidate').val().trim() || null
                }
            };

            // åˆæœŸç®¡ç†è€…æƒ…å ±ï¼ˆæ–°è¦ä½œæˆæ™‚ã®ã¿ï¼‰
            const adminName = $('#org-admin-name').val().trim();
            const adminEmail = $('#org-admin-email').val().trim();

            showLoading();
            try {
                if (orgId) {
                    // æ›´æ–° (Direct DB Update)
                    const { error } = await supabase
                        .from('organizations')
                        .update(orgData)
                        .eq('id', orgId);

                    if (error) throw error;

                    alert('ä¿å­˜ã—ã¾ã—ãŸ');

                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
                    if (typeof superAdminOrgsCache !== 'undefined') {
                        const idx = superAdminOrgsCache.findIndex(o => o.id === orgId);
                        if (idx !== -1) {
                            superAdminOrgsCache[idx] = { ...superAdminOrgsCache[idx], ...orgData };
                        }
                    }

                    // ç¾åœ¨ã®çµ„ç¹”æƒ…å ±ã‚’æ›´æ–°
                    if (currentUser && currentUser.organization_id === orgId) {
                        currentUser.organizations = { ...currentUser.organizations, ...orgData };
                    }

                } else {
                    // æ–°è¦ä½œæˆ (Direct DB Insert)
                    const { data: newOrgData, error: createError } = await supabase
                        .from('organizations')
                        .insert(orgData)
                        .select()
                        .single();

                    if (createError) throw createError;

                    const newOrg = newOrgData;

                    // æ‹›å¾…çŠ¶ã®ä½œæˆ
                    const token = crypto.randomUUID();
                    const expiresAt = new Date();
                    expiresAt.setDate(expiresAt.getDate() + 7); // 7æ—¥é–“æœ‰åŠ¹

                    const { error: inviteError } = await supabase
                        .from('invitations')
                        .insert({
                            organization_id: newOrg.id,
                            email: adminEmail,
                            role: 'org_admin',
                            token: token,
                            expires_at: expiresAt.toISOString()
                        });

                    if (inviteError) {
                        console.error('Invitation error:', inviteError);
                        alert('çµ„ç¹”ã¯ä½œæˆã•ã‚Œã¾ã—ãŸãŒã€æ‹›å¾…çŠ¶ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + inviteError.message);
                    } else {
                        const inviteUrl = `${window.location.origin}${window.location.pathname}?token=${token}`;

                        // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ (Client Side Mock/Impl)
                        await sendEmail('invitation', adminEmail, {
                            organizationName: newOrg.name,
                            invitationUrl: inviteUrl
                        });

                        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã§æ‹›å¾…URLã‚’è¡¨ç¤º
                        showInvitationUrlModal(newOrg.name, adminEmail, inviteUrl);
                    }
                }

                if (!($('#invitation-url-modal').hasClass('hidden') === false)) {
                    // æ‹›å¾…URLãƒ¢ãƒ¼ãƒ€ãƒ«ãŒå‡ºã¦ã„ãªã„å ´åˆã®ã¿é–‰ã˜ã‚‹
                    closeOrganizationModal();
                }

                loadSuperAdminOrganizations();

            } catch (error) {
                console.error('Save organization error:', error);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                hideLoading();
            }
        });

        // æ‹›å¾…URLãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®é–¢æ•°
        function showInvitationUrlModal(orgName, email, url) {
            $('#invite-org-name').text(orgName);
            $('#invite-admin-email').text(email);
            $('#invitation-url-display').val(url);
            $('#invitation-url-modal').removeClass('hidden');
        }

        window.closeInvitationUrlModal = function () {
            $('#invitation-url-modal').addClass('hidden');
        }

        window.copyInvitationUrl = function () {
            const urlInput = document.getElementById('invitation-url-display');
            urlInput.select();
            urlInput.setSelectionRange(0, 99999); // ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ

            navigator.clipboard.writeText(urlInput.value).then(() => {
                alert('URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
        }

        window.sendInvitationEmail = async function () {
            const email = $('#invite-admin-email').text();
            const url = $('#invitation-url-display').val();
            const orgName = $('#invite-org-name').text();

            if (!confirm('æ‹›å¾…ãƒ¡ãƒ¼ãƒ«ã‚’å†é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ')) return;

            showLoading();
            try {
                const success = await sendEmail('invitation', email, {
                    organizationName: orgName,
                    invitationUrl: url
                });

                if (success) {
                    alert('æ‹›å¾…ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
                } else {
                    alert('ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Resend invitation error:', error);
                alert('é€ä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            } finally {
                hideLoading();
            }
        }

        // æ—¢å­˜çµ„ç¹”ã¸ã®æ‹›å¾…URLç™ºè¡Œ
        window.generateInvitationForOrg = async function (orgId) {
            const org = superAdminOrgsCache.find(o => o.id === orgId);
            if (!org) {
                alert('çµ„ç¹”æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            const adminName = prompt('ç®¡ç†è€…ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (!adminName || !adminName.trim()) return;

            const adminEmail = prompt('ç®¡ç†è€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (!adminEmail || !adminEmail.trim()) return;

            // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç°¡æ˜“ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!adminEmail.includes('@')) {
                alert('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            showLoading();
            try {
                // æ—¢å­˜ã®æ‹›å¾…ã‚’å‰Šé™¤ï¼ˆåŒã˜çµ„ç¹”ã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®çµ„ã¿åˆã‚ã›ï¼‰
                await supabase
                    .from('invitations')
                    .delete()
                    .eq('organization_id', orgId)
                    .eq('email', adminEmail.trim());

                const token = crypto.randomUUID();
                const expiresAt = new Date();
                expiresAt.setDate(expiresAt.getDate() + 7); // 7æ—¥é–“æœ‰åŠ¹

                const { error: inviteError } = await supabase
                    .from('invitations')
                    .insert({
                        organization_id: orgId,
                        email: adminEmail.trim(),
                        role: 'org_admin',
                        token: token,
                        expires_at: expiresAt.toISOString()
                    });

                if (inviteError) throw inviteError;

                const inviteUrl = `${window.location.origin}${window.location.pathname}?token=${token}`;

                // ãƒ¡ãƒ¼ãƒ«é€ä¿¡
                await sendEmail('invitation', adminEmail.trim(), {
                    organizationName: org.name,
                    invitationUrl: inviteUrl
                });

                showInvitationUrlModal(org.name, adminEmail.trim(), inviteUrl);

            } catch (error) {
                console.error('Invitation creation failed:', error);
                alert('æ‹›å¾…URLã®ç™ºè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                hideLoading();
            }
        }



        window.showPromptForm = function () {
            $('#prompt-modal-title').text('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ')
            $('#prompt-form')[0].reset()
            $('#prompt-id').val('')
            $('#prompt-is-active').prop('checked', true)

            // Global option is only for super_admin
            if (currentUser.role === 'super_admin') {
                $('#prompt-is-global').parent().show()
                $('#prompt-is-global').prop('checked', false)
            } else {
                $('#prompt-is-global').parent().hide()
                $('#prompt-is-global').prop('checked', false)
            }

            // Enable inputs
            $('#prompt-name').prop('disabled', false)
            $('#prompt-template').prop('disabled', false)
            $('#prompt-is-active').prop('disabled', false)
            $('#prompt-is-global').prop('disabled', false)
            $('#prompt-submit-btn').show()

            $('#prompt-modal').removeClass('hidden')
        }

        window.editPrompt = function (prompt) {
            $('#prompt-modal-title').text('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›†')
            $('#prompt-id').val(prompt.id)
            $('#prompt-name').val(prompt.name)
            $('#prompt-template').val(prompt.prompt_template)
            $('#prompt-is-active').prop('checked', prompt.is_active)
            $('#prompt-is-global').prop('checked', prompt.is_global)

            // Global option visibility
            if (currentUser.role === 'super_admin') {
                $('#prompt-is-global').parent().show()
            } else {
                $('#prompt-is-global').parent().hide()
            }

            // Enable inputs
            $('#prompt-name').prop('disabled', false)
            $('#prompt-template').prop('disabled', false)
            $('#prompt-is-active').prop('disabled', false)
            $('#prompt-is-global').prop('disabled', false)
            $('#prompt-submit-btn').show()

            $('#prompt-modal').removeClass('hidden')
        }

        window.viewPrompt = function (prompt) {
            $('#prompt-modal-title').text('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé–²è¦§')
            $('#prompt-id').val(prompt.id)
            $('#prompt-name').val(prompt.name)
            $('#prompt-template').val(prompt.prompt_template)
            $('#prompt-is-active').prop('checked', prompt.is_active)
            $('#prompt-is-global').prop('checked', prompt.is_global)

            // Global option visibility
            if (currentUser.role === 'super_admin') {
                $('#prompt-is-global').parent().show()
            } else {
                $('#prompt-is-global').parent().hide()
            }

            // Disable inputs
            $('#prompt-name').prop('disabled', true)
            $('#prompt-template').prop('disabled', true)
            $('#prompt-is-active').prop('disabled', true)
            $('#prompt-is-global').prop('disabled', true)
            $('#prompt-submit-btn').hide()

            $('#prompt-modal').removeClass('hidden')
        }

        window.closePromptModal = function () {
            $('#prompt-modal').addClass('hidden')
            $('#prompt-form')[0].reset()
        }

        $('#prompt-form').on('submit', async function (e) {
            e.preventDefault()
            showLoading()

            const promptId = $('#prompt-id').val()
            const isGlobal = $('#prompt-is-global').is(':checked')

            // If not super admin, force is_global to false and set organization_id
            let orgId = null
            if (currentUser.role === 'super_admin') {
                orgId = isGlobal ? null : currentUser.organization_id // Or maybe super admin can create for specific org? For now, if not global, assign to their org (which might be null or a system org)
                // Actually, if super admin creates a non-global prompt, it should probably be global or assigned to a specific org. 
                // For simplicity, super admin creates global prompts by default or "system" prompts.
                // If isGlobal is false, let's set it to null (global) or current org.
                // Let's stick to: isGlobal -> orgId = null. !isGlobal -> orgId = currentUser.organization_id
            } else {
                orgId = currentUser.organization_id
            }

            const promptData = {
                name: $('#prompt-name').val(),
                prompt_template: $('#prompt-template').val(),
                is_active: $('#prompt-is-active').is(':checked'),
                is_global: isGlobal,
                organization_id: orgId,
                updated_at: new Date().toISOString()
            }

            if (!promptId) {
                promptData.created_by = currentUser.id
            }

            try {
                if (promptId) {
                    const { error } = await supabase
                        .from('ai_prompts')
                        .update(promptData)
                        .eq('id', promptId)
                    if (error) throw error
                    alert('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ')
                } else {
                    const { error } = await supabase
                        .from('ai_prompts')
                        .insert(promptData)
                    if (error) throw error
                    alert('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ')
                }

                closePromptModal()
                loadPrompts()
            } catch (error) {
                console.error('Save prompt error:', error)
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
            } finally {
                hideLoading()
            }
        })

        // ========================
        // Admin: Master Data
        // ========================
        window.switchMasterTab = function (type) {
            $('#master-filter-type').val(type);

            // Update tab styles
            $('.master-tab').each(function () {
                const onclick = $(this).attr('onclick');
                if (onclick.includes(`'${type}'`)) {
                    $(this).removeClass('border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300')
                        .addClass('border-indigo-500 text-indigo-600');
                } else {
                    $(this).removeClass('border-indigo-500 text-indigo-600')
                        .addClass('border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300');
                }
            });

            loadMasterData();
        }

        window.updateMasterSortOrder = async function (id, direction) {
            if (!currentUser) return;

            try {
                // Get current item
                const { data: currentItem, error: fetchError } = await supabase
                    .from('master_data')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (fetchError) throw fetchError;

                // Find adjacent item
                let query = supabase
                    .from('master_data')
                    .select('*')
                    .eq('type', currentItem.type);

                if (currentItem.organization_id) {
                    query = query.eq('organization_id', currentItem.organization_id);
                } else {
                    query = query.is('organization_id', null);
                }

                if (direction === 'up') {
                    // Find item with smaller sort_order (closest)
                    query = query.lt('sort_order', currentItem.sort_order).order('sort_order', { ascending: false }).limit(1);
                } else {
                    // Find item with larger sort_order (closest)
                    query = query.gt('sort_order', currentItem.sort_order).order('sort_order', { ascending: true }).limit(1);
                }

                const { data: adjacentItems, error: adjError } = await query;

                if (adjError) throw adjError;

                if (adjacentItems.length === 0) return; // No item to swap with

                const adjacentItem = adjacentItems[0];

                // Swap sort_order
                const { error: update1 } = await supabase
                    .from('master_data')
                    .update({ sort_order: adjacentItem.sort_order })
                    .eq('id', currentItem.id);

                if (update1) throw update1;

                const { error: update2 } = await supabase
                    .from('master_data')
                    .update({ sort_order: currentItem.sort_order })
                    .eq('id', adjacentItem.id);

                if (update2) throw update2;

                loadMasterData();

            } catch (error) {
                console.error('Sort update error:', error);
                alert('ä¸¦ã³é †ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        async function loadMasterOrganizations() {
            try {
                const { data: orgs, error } = await supabase
                    .from('organizations')
                    .select('id, name')
                    .order('name');

                if (error) throw error;

                const select = $('#master-filter-org');
                const currentVal = select.val();
                select.html('<option value="">å…¨ã¦ã®çµ„ç¹”ã‚’è¡¨ç¤º</option>');

                if (orgs) {
                    orgs.forEach(org => {
                        select.append(`<option value="${org.id}">${org.name}</option>`);
                    });
                }
                if (currentVal) select.val(currentVal);
            } catch (e) {
                console.error('Failed to load organizations for filter:', e);
            }
        }

        window.loadMasterData = async function () {
            // æ¨©é™ãƒã‚§ãƒƒã‚¯
            if (!currentUser || !['super_admin', 'org_admin', 'admin'].includes(currentUser.role)) {
                alert('æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
                showPage('dashboard');
                return;
            }

            // ã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…ã®å ´åˆã€çµ„ç¹”ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºãƒ»ãƒ­ãƒ¼ãƒ‰
            if (currentUser.role === 'super_admin') {
                $('#master-org-filter-container').removeClass('hidden');
                // æ—¢ã«ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã§ãªã‘ã‚Œã°ãƒ­ãƒ¼ãƒ‰ (optionãŒ1ã¤ä»¥ä¸‹ãªã‚‰)
                if ($('#master-filter-org option').length <= 1) {
                    await loadMasterOrganizations();
                }
            } else {
                $('#master-org-filter-container').addClass('hidden');
            }

            showLoading()
            try {
                let query = supabase
                    .from('master_data')
                    .select('*, organizations(name)')
                    .order('type', { ascending: true })
                    .order('sort_order', { ascending: true })

                const filterType = $('#master-filter-type').val()
                if (filterType) {
                    query = query.eq('type', filterType)
                }

                // çµ„ç¹”ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                if (currentUser.role === 'super_admin') {
                    const orgFilter = $('#master-filter-org').val();
                    if (orgFilter) {
                        query = query.eq('organization_id', orgFilter);
                    }
                } else {
                    // ä¸€èˆ¬ç®¡ç†è€…: è‡ªçµ„ç¹” ã¾ãŸã¯ ã‚°ãƒ­ãƒ¼ãƒãƒ«
                    query = query.or(`organization_id.eq.${currentUser.organization_id},organization_id.is.null`);
                }

                const { data: masters, error } = await query

                if (error) throw error

                const container = $('#master-data-container')
                container.empty()

                if (masters.length === 0) {
                    container.html('<p class="text-gray-500 text-center py-8">ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>')
                    return
                }

                const typeLabels = {
                    'employment_type': 'é›‡ç”¨å½¢æ…‹',
                    'job_category': 'è·ç¨®ã‚«ãƒ†ã‚´ãƒª',
                    'industry_category': 'æ¥­ç¨®ã‚«ãƒ†ã‚´ãƒª',
                    'selection_status': 'é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'
                }

                const html = masters.map(m => {
                    const isGlobal = m.organization_id === null
                    const isMyOrg = m.organization_id === currentUser.organization_id
                    // ã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…ã¯å…¨ã¦ç·¨é›†å¯èƒ½ã€‚çµ„ç¹”ç®¡ç†è€…ã¯è‡ªçµ„ç¹”ã®ã‚‚ã®ã®ã¿ç·¨é›†å¯èƒ½ã€‚
                    const canEdit = currentUser.role === 'super_admin' || (isMyOrg && ['org_admin', 'admin'].includes(currentUser.role))

                    let badge = ''
                    let orgName = ''

                    if (isGlobal) {
                        badge = '<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">ã‚°ãƒ­ãƒ¼ãƒãƒ«</span>'
                    } else {
                        orgName = m.organizations ? m.organizations.name : 'Unknown Org';
                        if (isMyOrg) {
                            badge = `<span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded">è‡ªç¤¾ç”¨</span>`
                        } else {
                            badge = `<span class="px-2 py-1 bg-gray-100 text-gray-800 text-xs rounded">${orgName}</span>`
                        }
                    }

                    return `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 mb-3 flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            ${canEdit ? `
                            <div class="flex flex-col gap-1">
                                <button onclick="updateMasterSortOrder('${m.id}', 'up')" class="text-gray-400 hover:text-indigo-600 p-1 hover:bg-gray-100 rounded transition">
                                    <i class="fas fa-chevron-up text-xs"></i>
                                </button>
                                <button onclick="updateMasterSortOrder('${m.id}', 'down')" class="text-gray-400 hover:text-indigo-600 p-1 hover:bg-gray-100 rounded transition">
                                    <i class="fas fa-chevron-down text-xs"></i>
                                </button>
                            </div>
                            ` : ''}
                            <div>
                                <div class="flex items-center gap-3 mb-1">
                                    <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded">${typeLabels[m.type] || m.type}</span>
                                    <span class="font-bold text-gray-900">${m.label}</span>
                                    <span class="text-sm text-gray-500">(${m.value})</span>
                                    ${!m.is_active ? '<span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded">ç„¡åŠ¹</span>' : ''}
                                    ${badge}
                                </div>
                                <div class="flex gap-2 text-xs text-gray-400">
                                    <span>è¡¨ç¤ºé †: ${m.sort_order}</span>
                                    ${m.organization_id ? `<span>çµ„ç¹”: ${orgName}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            ${canEdit ? `
                            <button onclick='editMaster(${JSON.stringify(m).replace(/'/g, "&#39;")})' class="text-indigo-600 hover:text-indigo-800 text-sm px-3 py-1">
                                <i class="fas fa-edit mr-1"></i>ç·¨é›†
                            </button>
                            <button onclick="deleteMaster('${m.id}')" class="text-red-600 hover:text-red-800 text-sm px-3 py-1">
                                <i class="fas fa-trash mr-1"></i>å‰Šé™¤
                            </button>
                            ` : `
                            <span class="text-gray-400 text-xs px-3 py-1"><i class="fas fa-lock mr-1"></i>ç·¨é›†ä¸å¯</span>
                            `}
                        </div>
                    </div>
                `}).join('')

                container.html(html)
            } catch (error) {
                console.error('Load master data error:', error)
                $('#master-data-container').html('<p class="text-red-500">ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>')
            } finally {
                hideLoading()
            }
        }

        window.showMasterForm = function () {
            $('#master-modal-title').text('ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ä½œæˆ')
            $('#master-form')[0].reset()
            $('#master-id').val('')
            $('#master-organization-id').val('')
            $('#master-is-active').prop('checked', true)

            // Global option
            if (currentUser.role === 'super_admin') {
                $('#master-is-global-container').show()
                $('#master-is-global').prop('checked', false)
            } else {
                $('#master-is-global-container').hide()
                $('#master-is-global').prop('checked', false)
            }

            $('#master-modal').removeClass('hidden')
        }

        window.editMaster = function (master) {
            $('#master-modal-title').text('ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ç·¨é›†')
            $('#master-id').val(master.id)
            $('#master-organization-id').val(master.organization_id || '')
            $('#master-type').val(master.type)
            $('#master-label').val(master.label)
            $('#master-value').val(master.value)
            $('#master-sort').val(master.sort_order)
            $('#master-is-active').prop('checked', master.is_active)

            const isGlobal = master.organization_id === null
            $('#master-is-global').prop('checked', isGlobal)

            // Global option visibility
            if (currentUser.role === 'super_admin') {
                $('#master-is-global-container').show()
            } else {
                $('#master-is-global-container').hide()
            }

            $('#master-modal').removeClass('hidden')
        }

        window.closeMasterModal = function () {
            $('#master-modal').addClass('hidden')
            $('#master-form')[0].reset()
        }

        window.deleteMaster = async function (id) {
            if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return

            showLoading()
            try {
                const { error } = await supabase
                    .from('master_data')
                    .delete()
                    .eq('id', id)

                if (error) throw error
                loadMasterData()
            } catch (error) {
                console.error('Delete master error:', error)
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
            } finally {
                hideLoading()
            }
        }

        $('#master-form').on('submit', async function (e) {
            e.preventDefault()
            showLoading()

            const id = $('#master-id').val()
            const isGlobal = $('#master-is-global').is(':checked')

            // Logic for organization_id
            // Logic for organization_id
            let orgId = null
            if (currentUser.role === 'super_admin') {
                if (isGlobal) {
                    orgId = null
                } else {
                    const currentOrgId = $('#master-organization-id').val()
                    const filterOrgId = $('#master-filter-org').val()

                    if (id && currentOrgId) {
                        // ç·¨é›†æ™‚ã‹ã¤ã€å…ƒã€…çµ„ç¹”IDãŒã‚ã‚‹å ´åˆã¯ç¶­æŒ
                        orgId = currentOrgId
                    } else if (filterOrgId && !id) { // æ–°è¦ä½œæˆæ™‚ã§ãƒ•ã‚£ãƒ«ã‚¿ãŒã‚ã‚‹å ´åˆ
                        orgId = filterOrgId
                    } else if (!id) {
                        // æ–°è¦ä½œæˆæ™‚ã§ãƒ•ã‚£ãƒ«ã‚¿ã‚‚ãªã„å ´åˆã€ã¨ã‚Šã‚ãˆãšè‡ªçµ„ç¹”ï¼ˆã“ã‚Œã¯é‹ç”¨ã«ã‚ˆã‚‹ãŒï¼‰
                        orgId = currentUser.organization_id
                    } else {
                        // ç·¨é›†æ™‚ã ãŒå…ƒãŒGlobalã ã£ãŸå ´åˆã§ã€Globalãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ãŸã‚±ãƒ¼ã‚¹ãªã©
                        // -> ã“ã“ã¯é›£ã—ã„ãŒã€ä¸€æ—¦è‡ªãƒ¦ãƒ‹ãƒ¼ã‚¯çµ„ç¹”IDã«ã™ã‚‹ã‹ã€ã‚¨ãƒ©ãƒ¼ã«ã™ã‚‹ã‹ã€‚
                        // ç¾çŠ¶ã¯è‡ªçµ„ç¹”IDã«ã™ã‚‹
                        orgId = currentUser.organization_id
                    }
                }
            } else {
                orgId = currentUser.organization_id
            }

            const data = {
                type: $('#master-type').val(),
                label: $('#master-label').val(),
                value: $('#master-value').val(),
                sort_order: parseInt($('#master-sort').val()) || 0,
                is_active: $('#master-is-active').is(':checked'),
                organization_id: orgId,
                updated_at: new Date().toISOString()
            }

            try {
                if (id) {
                    const { error } = await supabase
                        .from('master_data')
                        .update(data)
                        .eq('id', id)
                    if (error) throw error
                } else {
                    const { error } = await supabase
                        .from('master_data')
                        .insert(data)
                    if (error) throw error
                }

                closeMasterModal()
                loadMasterData()
            } catch (error) {
                console.error('Save master error:', error)
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
            } finally {
                hideLoading()
            }
        })
        async function loadNotifications() {
            if (!currentUser) return

            try {
                const { data: notifications, error } = await supabase
                    .from('notifications')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(20)

                if (error) throw error

                const unreadCount = notifications.filter(n => !n.read).length

                if (unreadCount > 0) {
                    $('#notification-badge').text(unreadCount).removeClass('hidden')
                } else {
                    $('#notification-badge').addClass('hidden')
                }

                renderNotifications(notifications)
            } catch (error) {
                console.error('Load notifications error:', error)
            }
        }

        function renderNotifications(notifications) {
            const container = $('#notification-list')
            container.empty()

            if (notifications.length === 0) {
                container.html('<p class="p-4 text-gray-500 text-center text-sm">é€šçŸ¥ã¯ã‚ã‚Šã¾ã›ã‚“</p>')
                return
            }

            const html = notifications.map(notif => {
                const metadata = notif.metadata || {};
                const hasLink = !!metadata.page;

                return `
                <div class="p-4 border-b hover:bg-gray-50 cursor-pointer ${notif.read ? 'bg-white' : 'bg-blue-50'} transition-colors" 
                     onclick="markAsRead('${notif.id}', ${JSON.stringify(metadata).replace(/"/g, '&quot;')})">
                    <div class="flex justify-between items-start mb-1">
                        <h4 class="font-bold text-sm text-gray-900">${notif.title}</h4>
                        <div class="flex items-center gap-2">
                             ${!notif.read ? '<span class="w-2.5 h-2.5 bg-indigo-600 rounded-full shadow-sm shadow-indigo-200"></span>' : ''}
                        </div>
                    </div>
                    <p class="text-xs text-gray-600 leading-relaxed">${notif.message}</p>
                    <div class="flex justify-between items-center mt-2">
                        <p class="text-[10px] text-gray-400 font-medium">${new Date(notif.created_at).toLocaleString('ja-JP')}</p>
                        ${hasLink ? '<span class="text-[10px] font-bold text-indigo-600 flex items-center gap-1">è©³ç´°ã‚’è¦‹ã‚‹ <i class="fas fa-chevron-right text-[8px]"></i></span>' : ''}
                    </div>
                </div>
            `;
            }).join('')

            container.html(html)
        }

        window.markAsRead = async function (notificationId, metadata = null) {
            try {
                // å…ˆã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ï¼ˆUIåæ˜ ã‚’å„ªå…ˆï¼‰
                const { error } = await supabase
                    .from('notifications')
                    .update({ read: true })
                    .eq('id', notificationId)

                if (error) throw error;

                // ãƒãƒƒã‚¸ã®å³æ™‚æ›´æ–°
                loadNotifications()

                // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°é·ç§»
                if (metadata && metadata.page) {
                    console.log('Redirecting to:', metadata.page);
                    showPage(metadata.page);

                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–¢é€£ã—ã¦ã„ã‚‹å ´åˆã¯é–‹ãï¼ˆä»»æ„ï¼‰
                    if (metadata.application_id && metadata.page === 'admin-applicants') {
                        // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨ã—ãŸã‚Šã€ç‰¹å®šã®é …ç›®ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹ãªã©ã®å‡¦ç†ã‚‚å¯èƒ½
                    }
                }

                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹
                $('#notification-dropdown').addClass('hidden');

            } catch (error) {
                console.error('Mark as read error:', error)
            }
        }

        // ========================
        // PDF & AI Analysis
        // ========================
        async function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        async function transferFileToGoogleDrive(file, gasUrl) {
            try {
                const base64 = await fileToBase64(file);
                const payload = {
                    filename: file.name,
                    base64: base64,
                    mimeType: file.type || 'application/pdf'
                };

                const response = await fetch(gasUrl, {
                    method: 'POST',
                    mode: 'cors', // Enable CORS
                    body: JSON.stringify(payload),
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8', // Plain text to avoid complex CORS preflights in GAS
                    }
                });

                if (!response.ok) throw new Error('Network response was not ok');

                const result = await response.json();
                if (result.status === 'success') {
                    return result.url;
                } else {
                    throw new Error(result.message || 'Unknown error from GAS');
                }
            } catch (err) {
                console.error('transferFileToGoogleDrive error:', err);
                throw err;
            }
        }

        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer()
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise
            let fullText = ''

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i)
                const textContent = await page.getTextContent()
                const pageText = textContent.items.map(item => item.str).join(' ')
                fullText += pageText + '\n'
            }

            return fullText
        }

        async function analyzeDocumentWithAI(text, type, options = {}) {
            // Edge Function 'analyze-document' ã‚’å‘¼ã³å‡ºã™
            // type: 'resume' | 'job_description'
            const { data, error } = await supabase.functions.invoke('analyze-document', {
                body: { text, type, options }
            })

            if (error) throw error
            return data
        }

        // æ–‡å­—åˆ—ã®é¡ä¼¼åº¦ã‚’è¨ˆç®—ï¼ˆãƒ¬ãƒ¼ãƒ™ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³è·é›¢ãƒ™ãƒ¼ã‚¹ï¼‰
        function calculateSimilarity(str1, str2) {
            if (!str1 || !str2) return 0;

            const s1 = str1.toLowerCase().trim();
            const s2 = str2.toLowerCase().trim();

            // å®Œå…¨ä¸€è‡´
            if (s1 === s2) return 1.0;

            // éƒ¨åˆ†ä¸€è‡´ãƒã‚§ãƒƒã‚¯
            if (s1.includes(s2) || s2.includes(s1)) return 0.8;

            // ãƒ¬ãƒ¼ãƒ™ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³è·é›¢ã‚’è¨ˆç®—
            const matrix = [];
            for (let i = 0; i <= s1.length; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= s2.length; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= s1.length; i++) {
                for (let j = 1; j <= s2.length; j++) {
                    if (s1.charAt(i - 1) === s2.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }

            const distance = matrix[s1.length][s2.length];
            const maxLength = Math.max(s1.length, s2.length);
            return 1 - (distance / maxLength);
        }

        // ãƒã‚¹ã‚¿å€¤ã‹ã‚‰æœ€ã‚‚é¡ä¼¼ã—ãŸå€¤ã‚’è¦‹ã¤ã‘ã‚‹
        function findClosestMasterValue(extractedValue, masterValues) {
            if (!extractedValue || !masterValues || masterValues.length === 0) {
                return null;
            }

            let bestMatch = null;
            let bestScore = 0;

            for (const masterValue of masterValues) {
                const score = calculateSimilarity(extractedValue, masterValue);
                if (score > bestScore) {
                    bestScore = score;
                    bestMatch = masterValue;
                }
            }

            // é¡ä¼¼åº¦ãŒ0.3ä»¥ä¸Šã®å ´åˆã®ã¿æ¡ç”¨ï¼ˆã‚ã¾ã‚Šã«ã‚‚é•ã†å ´åˆã¯ null ã‚’è¿”ã™ï¼‰
            return bestScore >= 0.3 ? bestMatch : null;
        }

        window.handleResumeUpload = async function (input) {
            if (input.files.length === 0) return

            if (!confirm('PDFã‚’è§£æã—ã¦ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã«è‡ªå‹•å…¥åŠ›ã—ã¾ã™ã‹ï¼Ÿ\nâ€»æ—¢å­˜ã®å…¥åŠ›å†…å®¹ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚')) {
                input.value = ''
                return
            }

            showLoading()
            try {
                let combinedText = ''
                for (let i = 0; i < input.files.length; i++) {
                    const text = await extractTextFromPDF(input.files[i])
                    combinedText += `--- File ${i + 1} ---\n${text}\n`
                }

                let result = await analyzeDocumentWithAI(combinedText, 'resume');

                // é…åˆ—ã§è¿”ã£ã¦ããŸå ´åˆã¯æœ€åˆã®è¦ç´ ã‚’ä½¿ã†
                if (Array.isArray(result)) {
                    result = result[0] || {};
                }

                console.log('Resume Analysis Result:', result);

                // --- ãƒ•ã‚©ãƒ¼ãƒ ã¸ã®åæ˜  ---

                // åå‰ã¯readonlyã ãŒã€ãµã‚ŠãŒãªãªã©ã¯åæ˜ 
                if (result.furigana || result.kana) $('#profile-furigana').val(result.furigana || result.kana);
                if (result.email) $('#profile-email').val(result.email);
                if (result.phone) $('#profile-phone').val(result.phone);
                if (result.age) $('#profile-age').val(result.age);

                // å­¦æ­´
                if (result.education || result.academic_background) {
                    $('#profile-academic').val(result.education || result.academic_background);
                }

                // ã‚¹ã‚­ãƒ«
                if (result.skills) {
                    $('#profile-skills').val(result.skills);
                }

                // è·æ­´æ¦‚è¦
                if (result.work_history) {
                    $('#profile-history').val(result.work_history);
                }

                // è·å‹™çµŒæ­´ (è©³ç´°ãƒ†ã‚­ã‚¹ãƒˆ)
                if (result.work_history_detail) {
                    $('#profile-work-history-detail').val(result.work_history_detail);
                }

                // æ¨å®šå¹´å (ä¸‡å††å˜ä½)
                if (result.current_salary) {
                    $('#profile-current-salary').val(result.current_salary / 10000);
                }

                // æ§‹é€ åŒ–ã•ã‚ŒãŸè·æ­´ (è©³ç´°è·æ­´)
                if (result.work_history_structured && Array.isArray(result.work_history_structured)) {
                    $('#profile-work-history-list').empty();
                    result.work_history_structured.forEach(item => addWorkHistoryItemToContainer('#profile-work-history-list', item));
                    updateJobChangeCountInContainer('#profile-work-history-list', '#profile-job-change-count');
                }

                // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨ã®ãƒãƒƒãƒãƒ³ã‚° (è·ç¨®ãƒ»æ¥­ç•Œ)
                if (result.desired_job_type) {
                    const extractedJobs = [result.desired_job_type].flat().filter(Boolean);
                    const matchedJobs = [];
                    extractedJobs.forEach(val => {
                        const match = findClosestMasterValue(val, masterJobCategories);
                        if (match && !matchedJobs.includes(match)) matchedJobs.push(match);
                    });
                    if (matchedJobs.length > 0) {
                        $('#profile-job-type').val(matchedJobs).trigger('change');
                    }
                }

                if (result.desired_industry) {
                    const extractedIndustries = [result.desired_industry].flat().filter(Boolean);
                    const matchedIndustries = [];
                    extractedIndustries.forEach(val => {
                        const match = findClosestMasterValue(val, masterIndustries);
                        if (match && !matchedIndustries.includes(match)) matchedIndustries.push(match);
                    });
                    if (matchedIndustries.length > 0) {
                        $('#profile-industry').val(matchedIndustries).trigger('change');
                    }
                }

                alert('PDFã®è§£æãŒå®Œäº†ã—ã¾ã—ãŸã€‚\nå†…å®¹ã‚’ç¢ºèªãƒ»ä¿®æ­£ã—ãŸä¸Šã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚');
            } catch (error) {
                console.error('Resume analysis error:', error)
                alert('è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
            } finally {
                hideLoading()
                input.value = ''
            }
        }

        window.handleJobPdfUpload = async function (input) {
            if (input.files.length === 0) return

            const fileCount = input.files.length;
            const confirmMsg = fileCount > 1
                ? `${fileCount}ä»¶ã®PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ã—ã¾ã™ã€‚\nãã‚Œãã‚Œè§£æã—ã€å€‹åˆ¥ã®æ±‚äººã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ`
                : 'PDFã‚’è§£æã—ã¦æ±‚äººãƒ•ã‚©ãƒ¼ãƒ ã«è‡ªå‹•å…¥åŠ›ã—ã¾ã™ã‹ï¼Ÿ\nâ€»æ—¢å­˜ã®å…¥åŠ›å†…å®¹ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚';

            if (!confirm(confirmMsg)) {
                input.value = ''
                return
            }

            const isBulkMode = fileCount > 1;
            showLoading('PDFã‚’è§£æä¸­...')

            importResultSuccessFiles = [];
            importResultErrorFiles = [];

            try {
                const options = {
                    job_categories: typeof masterJobCategories !== 'undefined' ? masterJobCategories : [],
                    industry_categories: typeof masterIndustries !== 'undefined' ? masterIndustries : []
                };

                const orgSettings = currentUser.organizations?.settings || {};
                const bulkConfirmEnabled = orgSettings.bulk_duplicate_confirm_enabled === true;

                for (let i = 0; i < fileCount; i++) {
                    const file = input.files[i];
                    console.log(`Processing file ${i + 1}/${fileCount}: ${file.name}`);

                    try {
                        const text = await extractTextFromPDF(file);
                        if (!text || text.trim().length === 0) {
                            throw new Error('ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
                        }

                        await processParsedJobText(text, file, options, isBulkMode);
                        if (isBulkMode && !bulkConfirmEnabled) {
                            importResultSuccessFiles.push(file.name);
                        }
                    } catch (err) {
                        console.error(`Error processing ${file.name}:`, err);
                        importResultErrorFiles.push({ name: file.name, message: err.message });
                    }
                }

                if (isBulkMode) {
                    if (bulkConfirmEnabled && pendingBulkJobs.length > 0) {
                        hideLoading();
                        renderBulkConfirmList();
                        // é€”ä¸­ã§ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ãŸå ´åˆã‚‚ã€å¾Œã§è¦‹ã›ãŸã„ãŒã€ã¾ãšã¯ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã¸
                        $('#job-bulk-confirm-modal').removeClass('hidden');
                    } else {
                        hideLoading();
                        showImportResult(importResultSuccessFiles, importResultErrorFiles);
                        closeJobModal();
                        loadAdminJobs();
                    }
                } else if (importResultErrorFiles.length > 0) {
                    hideLoading();
                    showImportResult([], importResultErrorFiles);
                }

            } catch (error) {
                console.error('Job analysis error:', error)
                alert('è§£æå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message)
            } finally {
                hideLoading()
                input.value = ''
            }
        }

        // Common logic for processing job text
        async function processParsedJobText(text, file, options, isBulkMode) {
            let result = await analyzeDocumentWithAI(text, 'job_description', options);
            if (Array.isArray(result)) result = result[0] || {};

            if (!result.title || !result.company) {
                throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${file.name}ã€ã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã¾ãŸã¯ä¼šç¤¾åã‚’ç‰¹å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚`);
            }

            const orgSettings = currentUser.organizations?.settings || {};
            const bulkConfirmEnabled = orgSettings.bulk_duplicate_confirm_enabled === true;

            // Check duplicates
            const { data: duplicates } = await supabase
                .from('jobs')
                .select('id, title, company')
                .eq('organization_id', currentUser.organization_id)
                .or(`title.eq."${result.title}", company.eq."${result.company}"`)
                .limit(3);

            let companyId = null;
            const { data: ec } = await supabase.from('companies').select('id').eq('organization_id', currentUser.organization_id).eq('name', result.company).single();
            if (ec) {
                companyId = ec.id;
            } else {
                const { data: nc } = await supabase.from('companies').insert({ organization_id: currentUser.organization_id, name: result.company, location: result.location }).select().single();
                companyId = nc.id;
            }

            const jobData = {
                organization_id: currentUser.organization_id,
                title: result.title,
                company_id: companyId,
                company: result.company,
                location: result.location || 'æœªå®š',
                salary_min: result.salary_min || null,
                salary_max: result.salary_max || null,
                description: result.description || '',
                requirements: result.requirements || '',
                welcome_requirements: result.welcome_requirements || '',
                work_hours: result.work_hours || null,
                holidays: result.holidays || null,
                benefits: result.benefits || null,
                interview_process: result.interview_process || null,
                employment_type: result.employment_type || 'æ­£ç¤¾å“¡',
                is_remote: result.is_remote || false,
                job_experience_ok: result.job_experience_ok ? 'å¯' : 'ä¸å¯',
                industry_experience_ok: result.industry_experience_ok ? 'å¯' : 'ä¸å¯',
                job_category: findClosestMasterValue(result.job_category, masterJobCategories),
                industry_category: findClosestMasterValue(result.industry_category, masterIndustries),
                pdf_filename: file.name,
                status: 'active'
            };

            if (isBulkMode && bulkConfirmEnabled) {
                pendingBulkJobs.push({ file, result, jobData, duplicates: duplicates || [] });
                return;
            }

            // Transfer to Drive if enabled (or use existing driveUrl from Drive import)
            const driveCol = orgSettings.drive_column || 'pdf_url';
            if (file.driveUrl) {
                jobData[driveCol] = file.driveUrl;
            } else if (orgSettings.drive_transfer_enabled && orgSettings.drive_gas_url && file.size) {
                try {
                    const driveUrl = await transferFileToGoogleDrive(file, orgSettings.drive_gas_url);
                    if (driveUrl) {
                        jobData[driveCol] = driveUrl;
                    }
                } catch (e) { console.error('Drive transfer failed:', e); }
            }

            if (!isBulkMode) {
                // Fill form
                $('#job-title').val(result.title);
                $('#job-company-name').val(result.company);
                $('#job-location').val(result.location || '');
                $('#job-salary-min').val(result.salary_min / 10000 || '');
                $('#job-salary-max').val(result.salary_max / 10000 || '');
                $('#job-description').val(result.description || '');
                $('#job-requirements').val(result.requirements || '');
                $('#job-welcome-requirements').val(result.welcome_requirements || '');
                $('#job-work-hours').val(result.work_hours || '');
                $('#job-holidays').val(result.holidays || '');
                $('#job-benefits').val(result.benefits || '');
                $('#job-interview-process').val(result.interview_process || '');
                $('#job-category').val(jobData.job_category);
                $('#job-industry-category').val(jobData.industry_category);
                $('#job-employment-type').val(result.employment_type || 'æ­£ç¤¾å“¡');
                $('#job-is-remote').prop('checked', !!result.is_remote);
                $('#job-experience-ok').prop('checked', !!result.job_experience_ok);
                $('#job-industry-experience-ok').prop('checked', !!result.industry_experience_ok);

                if (jobData[orgSettings.drive_column || 'pdf_url']) {
                    $('#job-drive-pdf-url').val(jobData[orgSettings.drive_column || 'pdf_url']);
                }
                $('#job-pdf-filename').val(file.name);

                alert('PDFã®è§£æãŒå®Œäº†ã—ã¾ã—ãŸã€‚å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            } else {
                const { error } = await supabase.from('jobs').insert(jobData);
                if (error) throw error;
            }
        }

        window.closeDriveImportModal = function () {
            $('#drive-import-modal').addClass('hidden').attr('style', '');
        }

        // Google Drive Import functions
        window.driveFilesCache = [];

        window.openDriveImportModal = async function () {
            console.log('DEBUG: openDriveImportModal called');
            const user = window.currentUser || currentUser;
            const orgSettings = user?.organizations?.settings || {};
            if (!orgSettings.drive_import_enabled || !orgSettings.drive_import_gas_url) {
                console.warn('DEBUG: Drive import settings missing:', orgSettings);
                alert('Googleãƒ‰ãƒ©ã‚¤ãƒ–ã‚¤ãƒ³ãƒãƒ¼ãƒˆè¨­å®šãŒæœªå®Œäº†ã§ã™ã€‚ç®¡ç†è€…è¨­å®šï¼ˆçµ„ç¹”è¨­å®šï¼‰ã§GAS URLãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const $modal = $('#drive-import-modal');
            // è¦ç´ ã‚’bodyã¸ç§»å‹•
            $modal.appendTo('body');
            $modal.removeClass('hidden').attr('style', 'display: flex !important; z-index: 100000 !important;');
            console.log('DEBUG: Drive modal shown/forced');

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ãƒªã‚»ãƒƒãƒˆ
            $('#drive-filter-search').val('');
            $('#drive-filter-date-from').val('');
            $('#drive-filter-sort').val('newest');

            $('#drive-file-list').empty();
            $('#drive-import-count').text('0ä»¶é¸æŠ');
            $('#execute-drive-import-btn').prop('disabled', true);
            $('#drive-import-status').attr('class', 'mb-4 p-4 bg-blue-50 text-blue-700 rounded-lg flex items-center gap-3 border border-blue-100')
                .html('<i class="fas fa-spinner fa-spin"></i><p class="text-sm">Googleãƒ‰ãƒ©ã‚¤ãƒ–ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­...</p>');

            try {
                const response = await fetch(orgSettings.drive_import_gas_url, {
                    method: 'POST', mode: 'cors', body: JSON.stringify({ action: 'list_files' }),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                });
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);

                window.driveFilesCache = result.files || [];
                if (window.driveFilesCache.length === 0) {
                    $('#drive-import-status').attr('class', 'mb-4 p-4 bg-amber-50 text-amber-700 rounded-lg flex items-center gap-3 border border-amber-100')
                        .html('<i class="fas fa-exclamation-triangle"></i><p class="text-sm">ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¯èƒ½ãªæ±‚äººPDFãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>');
                    return;
                }

                $('#drive-import-status').attr('class', 'mb-4 p-4 bg-green-50 text-green-700 rounded-lg flex items-center gap-3 border border-green-100')
                    .html('<i class="fas fa-check-circle"></i><p class="text-sm">' + window.driveFilesCache.length + 'ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚</p>');

                $('#drive-file-select-all').prop('checked', false);
                applyDriveFileFilters();
            } catch (err) {
                $('#drive-import-status').attr('class', 'mb-4 p-4 bg-red-50 text-red-700 rounded-lg flex items-center gap-3 border border-red-100').html(`<i class="fas fa-times-circle"></i><p class="text-sm">ã‚¨ãƒ©ãƒ¼: ${err.message}</p>`);
            }
        };

        window.applyDriveFileFilters = function () {
            const searchText = $('#drive-filter-search').val().toLowerCase();
            const dateFrom = $('#drive-filter-date-from').val();
            const sortType = $('#drive-filter-sort').val();

            let filtered = [...window.driveFilesCache];

            // 1. ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢
            if (searchText) {
                filtered = filtered.filter(f => f.name.toLowerCase().includes(searchText));
            }

            // 2. æ—¥ä»˜æ¤œç´¢ (æ›´æ–°æ—¥ãŒæŒ‡å®šæ—¥ä»¥é™ã®ã‚‚ã®)
            if (dateFrom) {
                const fromTs = new Date(dateFrom).getTime();
                filtered = filtered.filter(f => new Date(f.modified).getTime() >= fromTs);
            }

            // 3. ã‚½ãƒ¼ãƒˆ
            if (sortType === 'newest') {
                filtered.sort((a, b) => new Date(b.modified) - new Date(a.modified));
            } else if (sortType === 'oldest') {
                filtered.sort((a, b) => new Date(a.modified) - new Date(b.modified));
            } else if (sortType === 'name') {
                filtered.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
            }

            renderDriveFileList(filtered);
            updateDriveImportCount();

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã®å…¨é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            $('#drive-file-select-all').prop('checked', false);
        };

        window.toggleDriveAllCheckboxes = function (checked) {
            $('input[name="drive-file-item"]:visible').prop('checked', checked);
            updateDriveImportCount();
        };

        function renderDriveFileList(files) {
            const container = $('#drive-file-list');
            container.empty();
            $('#drive-file-list-count').text(`${files.length}ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«`);
            files.forEach(file => {
                container.append(`
                    <div class="bg-white border rounded-lg p-3 flex items-center gap-3 hover:border-blue-400 cursor-pointer transition">
                        <input type="checkbox" name="drive-file-item" data-id="${file.id}" data-name="${file.name}" class="h-5 w-5 text-blue-600" onchange="updateDriveImportCount()">
                        <div class="flex-1 min-w-0" onclick="$(this).siblings('input').click()">
                            <div class="font-bold text-gray-900 truncate text-sm">${file.name}</div>
                            <div class="flex items-center gap-2 mt-0.5">
                                <span class="text-[10px] text-blue-600 font-medium bg-blue-50 px-1.5 rounded border border-blue-100">
                                    <i class="far fa-calendar-alt mr-1"></i>${new Date(file.modified).toLocaleDateString()}
                                </span>
                                <span class="text-[10px] text-gray-500">
                                    <i class="far fa-file mr-1"></i>${(file.size / 1024).toFixed(0)} KB
                                </span>
                            </div>
                        </div>
                        <a href="${file.url}" target="_blank" class="text-gray-400 hover:text-blue-600"><i class="fas fa-external-link-alt text-xs"></i></a>
                    </div>
                `);
            });
        }

        window.updateDriveImportCount = function () {
            const count = $('input[name="drive-file-item"]:checked').length;
            $('#drive-import-count').text(`${count}ä»¶é¸æŠ`);
            $('#execute-drive-import-btn').prop('disabled', count === 0);
        };

        window.executeDriveImport = async function () {
            const selected = [];
            $('input[name="drive-file-item"]:checked').each(function () { selected.push({ id: $(this).data('id'), name: $(this).data('name') }); });
            if (selected.length === 0) return;
            if (!confirm(`${selected.length}ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ`)) return;

            const orgSettings = currentUser.organizations?.settings || {};
            showLoading('Googleãƒ‰ãƒ©ã‚¤ãƒ–ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...');

            importResultSuccessFiles = [];
            importResultErrorFiles = [];
            pendingBulkJobs = [];

            try {
                const options = { job_categories: typeof masterJobCategories !== 'undefined' ? masterJobCategories : [], industry_categories: typeof masterIndustries !== 'undefined' ? masterIndustries : [] };
                const bulkConfirmEnabled = orgSettings.bulk_duplicate_confirm_enabled === true;

                for (let i = 0; i < selected.length; i++) {
                    const f = selected[i];
                    $('#drive-import-status p').text(`ã€${i + 1}/${selected.length}ã€‘è§£æä¸­: ${f.name}`);
                    try {
                        const res = await fetch(orgSettings.drive_import_gas_url, { method: 'POST', mode: 'cors', body: JSON.stringify({ action: 'get_file', fileId: f.id }), headers: { 'Content-Type': 'text/plain;charset=utf-8' } });
                        const data = await res.json();
                        if (data.status !== 'success') throw new Error(data.message);

                        const bin = atob(data.base64);
                        const bytes = new Uint8Array(bin.length);
                        for (let j = 0; j < bin.length; j++) bytes[j] = bin.charCodeAt(j);
                        const pdf = await pdfjsLib.getDocument({ data: bytes }).promise;
                        let text = '';
                        for (let p = 1; p <= pdf.numPages; p++) {
                            const pg = await pdf.getPage(p);
                            const tc = await pg.getTextContent();
                            text += tc.items.map(it => it.str).join(' ') + '\n';
                        }
                        if (!text.trim()) throw new Error('PDFã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆã‚¹ã‚­ãƒ£ãƒ³ç”»åƒãªã©ã®å¯èƒ½æ€§ï¼‰');

                        const fakeFile = { name: f.name, size: bytes.length, driveUrl: data.url };
                        await processParsedJobText(text, fakeFile, options, true);

                        if (!bulkConfirmEnabled) {
                            importResultSuccessFiles.push(f.name);
                        }
                    } catch (e) {
                        console.error(e);
                        importResultErrorFiles.push({ name: f.name, message: e.message });
                    }
                }
                $('#drive-import-modal').addClass('hidden');
                if (bulkConfirmEnabled && pendingBulkJobs.length > 0) {
                    renderBulkConfirmList();
                    $('#job-bulk-confirm-modal').removeClass('hidden');
                }
                else {
                    showImportResult(importResultSuccessFiles, importResultErrorFiles);
                    loadAdminJobs();
                }
            } catch (err) { alert('ã‚¨ãƒ©ãƒ¼: ' + err.message); } finally { hideLoading(); }
        }

        // --- æ±‚äººä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨é–¢æ•° ---
        window.closeJobBulkConfirmModal = function () {
            if (pendingBulkJobs.length > 0 && !confirm('ç¢ºèªå¾…ã¡ã®æ±‚äººãŒã‚ã‚Šã¾ã™ãŒã€è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            $('#job-bulk-confirm-modal').addClass('hidden');
            pendingBulkJobs = [];
        }

        window.renderBulkConfirmList = function () {
            const container = $('#job-bulk-list');
            container.empty();

            pendingBulkJobs.forEach((item, index) => {
                const hasDuplicate = item.duplicates && item.duplicates.length > 0;
                const dupHtml = hasDuplicate
                    ? item.duplicates.map(d => `<div class="text-red-500 font-medium">${d.company} / ${d.title}</div>`).join('')
                    : '';

                const statusBadge = hasDuplicate
                    ? '<span class="px-2 py-0.5 bg-red-100 text-red-700 text-[10px] rounded font-bold">é‡è¤‡ç–‘ã„</span>'
                    : '<span class="px-2 py-0.5 bg-green-100 text-green-700 text-[10px] rounded font-bold">è§£æå®Œäº†</span>';

                const html = `
                    <div class="bg-white border rounded-lg p-4 shadow-sm hover:border-indigo-300 transition ${hasDuplicate ? 'border-red-100 bg-red-50/10' : ''}">
                        <label class="flex items-start cursor-pointer">
                            <input type="checkbox" name="bulk-job-item" data-index="${index}" class="form-checkbox h-5 w-5 text-indigo-600 rounded mt-1 mr-4" onchange="updateBulkSelectCount()" ${!hasDuplicate ? 'checked' : ''}>
                            <div class="flex-1">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex items-center gap-2">
                                        <h4 class="font-bold text-gray-900 overflow-hidden text-ellipsis">${item.result.company} / ${item.result.title}</h4>
                                        ${statusBadge}
                                    </div>
                                    <span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded truncate ml-2">ğŸ“„ ${item.file.name}</span>
                                </div>
                                <div class="text-xs text-gray-500 space-y-1">
                                    <div><i class="fas fa-map-marker-alt mr-1"></i>${item.result.location || '-'}</div>
                                    ${hasDuplicate ? `
                                    <div class="mt-2 pt-2 border-t border-dashed border-red-200">
                                        <p class="font-bold text-red-600 mb-1"><i class="fas fa-exclamation-triangle mr-1"></i>é‡è¤‡ã®å¯èƒ½æ€§ã‚ã‚Š:</p>
                                        <div class="pl-2 border-l-2 border-red-200 ml-1">
                                            ${dupHtml}
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </label>
                    </div>
                `;
                container.append(html);
            });
            updateBulkSelectCount();
        }

        window.updateBulkSelectCount = function () {
            const count = $('input[name="bulk-job-item"]:checked').length;
            const total = pendingBulkJobs.length;
            $('#job-bulk-count').text(`${total}ä»¶ä¸­ ${count}ä»¶é¸æŠ`);
            $('#job-bulk-select-all').prop('checked', count === total && total > 0);
        }

        window.toggleAllBulkJobs = function (checked) {
            $('input[name="bulk-job-item"]').prop('checked', checked);
            updateBulkSelectCount();
        }

        window.executeBulkJobImport = async function () {
            const selectedIndexes = [];
            $('input[name="bulk-job-item"]:checked').each(function () {
                selectedIndexes.push(parseInt($(this).data('index')));
            });

            if (selectedIndexes.length === 0) {
                alert('ç™»éŒ²ã™ã‚‹æ±‚äººã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (!confirm(`${selectedIndexes.length}ä»¶ã®æ±‚äººã‚’ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            showLoading('é¸æŠã—ãŸæ±‚äººã‚’ç™»éŒ²ä¸­...');
            // importResultSuccessFiles, importResultErrorFiles ã¯æ—¢å­˜ã®parsingæ™‚ã®çµæœï¼ˆerrorï¼‰ã‚’å¼•ãç¶™ããŸã‚ã€ã‚¯ãƒªã‚¢ã—ãªã„

            try {
                for (const idx of selectedIndexes) {
                    const item = pendingBulkJobs[idx];
                    const { result, file, jobData: precalcJobData } = item;

                    let jobData = precalcJobData;
                    if (!jobData) {
                        // å¾Œæ–¹äº’æ›æ€§ã¾ãŸã¯å®‰å…¨ç­–ï¼šå†è¨ˆç®—ã¾ãŸã¯ä»¥å‰ã®ãƒ­ã‚¸ãƒƒã‚¯
                        let companyId = null;
                        const { data: existingCompany } = await supabase
                            .from('companies')
                            .select('id')
                            .eq('organization_id', currentUser.organization_id)
                            .eq('name', result.company)
                            .single();

                        if (existingCompany) {
                            companyId = existingCompany.id;
                        } else {
                            const { data: newCompany } = await supabase
                                .from('companies')
                                .insert({
                                    organization_id: currentUser.organization_id,
                                    name: result.company,
                                    location: result.location
                                })
                                .select()
                                .single();
                            companyId = newCompany.id;
                        }

                        jobData = {
                            organization_id: currentUser.organization_id,
                            title: result.title,
                            company_id: companyId,
                            company: result.company,
                            location: result.location || 'æœªå®š',
                            salary_min: result.salary_min || null,
                            salary_max: result.salary_max || null,
                            description: result.description || '',
                            requirements: result.requirements || '',
                            welcome_requirements: result.welcome_requirements || '',
                            employment_type: result.employment_type || 'æ­£ç¤¾å“¡',
                            is_remote: result.is_remote || false,
                            pdf_filename: file.name,
                            status: 'active'
                        };
                    }

                    // Google Drive è»¢é€ï¼ˆè¨­å®šãŒã‚ã‚Œã°ã€æ—¢å­˜URLãŒãªã‘ã‚Œã°ï¼‰
                    const driveCol = orgSettings.drive_column || 'pdf_url';
                    if (file.driveUrl) {
                        jobData[driveCol] = file.driveUrl;
                    } else if (orgSettings.drive_transfer_enabled && orgSettings.drive_gas_url) {
                        try {
                            const driveUrl = await transferFileToGoogleDrive(file, orgSettings.drive_gas_url);
                            if (driveUrl) {
                                jobData[driveCol] = driveUrl;
                            }
                        } catch (e) {
                            console.error('Drive transfer failed in bulk confirm:', e);
                        }
                    }

                    const { error } = await supabase.from('jobs').insert(jobData);
                    if (error) {
                        console.error('Bulk import error for job:', result.title, error);
                        importResultErrorFiles.push({ name: file.name, message: error.message });
                    } else {
                        importResultSuccessFiles.push(file.name);
                    }
                }

                showImportResult(importResultSuccessFiles, importResultErrorFiles);
                pendingBulkJobs = [];
                $('#job-bulk-confirm-modal').addClass('hidden');
                loadAdminJobs();
            } catch (err) {
                console.error('executeBulkJobImport error:', err);
                alert('ä¸€æ‹¬ç™»éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            } finally {
                hideLoading();
            }
        }



        // Dashboard
        // ========================
        let dashboardChartInstances = {};
        let currentDashboardPeriod = 'month';

        async function loadDashboard() {
            if (!currentUser) return

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
            $('#user-name').text(currentUser.name)
            $('#user-role').text(getRoleLabel(currentUser.role))
            $('#org-name').text(currentUser.organizations?.name || '')
            $('#org-code-display').text(currentUser.organizations?.code ? `ã‚³ãƒ¼ãƒ‰: ${currentUser.organizations.code}` : '')

            const contentArea = $('#dashboard-content');
            contentArea.empty(); // å…¨ä½“ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†æ§‹ç¯‰

            // 1. KPI Stats Area
            const statsGrid = $('<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" id="dashboard-stats"></div>');
            contentArea.append(statsGrid);

            // 2. Charts Area (Agent only)
            const isAgent = ['super_admin', 'org_admin', 'admin', 'coach', 'ca', 'ra'].includes(currentUser.role);
            if (isAgent) {
                const controlsHtml = `
                    <div class="flex flex-wrap justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800"><i class="fas fa-chart-line mr-2"></i>é€²æ—ãƒ»æ­©ç•™ã¾ã‚Šåˆ†æ</h3>
                        <div class="flex gap-2 bg-gray-100 p-1 rounded-lg">
                            <button onclick="changeDashboardPeriod('day')" class="px-4 py-1 rounded-md text-sm font-medium transition ${currentDashboardPeriod === 'day' ? 'bg-white text-indigo-600 shadow' : 'text-gray-500 hover:text-gray-700'}">æ—¥æ¬¡</button>
                            <button onclick="changeDashboardPeriod('week')" class="px-4 py-1 rounded-md text-sm font-medium transition ${currentDashboardPeriod === 'week' ? 'bg-white text-indigo-600 shadow' : 'text-gray-500 hover:text-gray-700'}">é€±æ¬¡</button>
                            <button onclick="changeDashboardPeriod('month')" class="px-4 py-1 rounded-md text-sm font-medium transition ${currentDashboardPeriod === 'month' ? 'bg-white text-indigo-600 shadow' : 'text-gray-500 hover:text-gray-700'}">æœˆæ¬¡</button>
                            <button onclick="changeDashboardPeriod('year')" class="px-4 py-1 rounded-md text-sm font-medium transition ${currentDashboardPeriod === 'year' ? 'bg-white text-indigo-600 shadow' : 'text-gray-500 hover:text-gray-700'}">å¹´æ¬¡</button>
                        </div>
                    </div>
                `;
                contentArea.append(controlsHtml);

                const chartGrid = $(`
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8" id="dashboard-charts">
                        <div class="bg-white rounded-lg shadow p-6">
                            <h4 class="font-bold text-gray-700 mb-4">å·¥ç¨‹åˆ¥ æ­©ç•™ã¾ã‚Š (ãƒ•ã‚¡ãƒãƒ«)</h4>
                            <canvas id="funnelChart"></canvas>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <h4 class="font-bold text-gray-700 mb-4">ç´¯ç©æ¨ç§» (ãƒˆãƒ¬ãƒ³ãƒ‰)</h4>
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                `);
                contentArea.append(chartGrid);
            }

            // Load Data & Render
            try {
                // --- KPI Cards Logic (Same as before) ---
                if (['super_admin', 'org_admin', 'admin'].includes(currentUser.role)) {
                    const { count: jobCount } = await supabase.from('jobs').select('*', { count: 'exact', head: true }).eq('organization_id', currentUser.organization_id).eq('status', 'active');
                    const { count: userCount } = await supabase.from('users').select('*', { count: 'exact', head: true }).eq('organization_id', currentUser.organization_id).eq('role', 'user');
                    const { count: appCount } = await supabase.from('applications').select('*', { count: 'exact', head: true }).eq('organization_id', currentUser.organization_id);

                    renderDashboardCards(statsGrid, [
                        { label: 'æœ‰åŠ¹æ±‚äººä»¶æ•°', value: jobCount || 0, icon: 'fa-briefcase', color: 'indigo' },
                        { label: 'ç™»éŒ²æ±‚è·è€…æ•°', value: userCount || 0, icon: 'fa-users', color: 'green' },
                        { label: 'ç·å¿œå‹Ÿæ•°', value: appCount || 0, icon: 'fa-file-alt', color: 'purple' }
                    ]);
                } else if (['coach', 'ca', 'ra'].includes(currentUser.role)) {
                    const { data: assignedUsers } = await supabase.from('users').select('id').eq('coach_id', currentUser.id);
                    const assignedUserIds = assignedUsers?.map(u => u.id) || [];
                    let candidateAppCount = 0;
                    if (assignedUserIds.length > 0) {
                        const { count } = await supabase.from('applications').select('*', { count: 'exact', head: true }).in('user_id', assignedUserIds);
                        candidateAppCount = count || 0;
                    }
                    const { count: aiRecoCount } = await supabase.from('recommendations').select('*', { count: 'exact', head: true }).eq('created_by', currentUser.id);
                    renderDashboardCards(statsGrid, [
                        { label: 'æ‹…å½“æ±‚è·è€…æ•°', value: assignedUserIds.length, icon: 'fa-user-friends', color: 'indigo' },
                        { label: 'æ‹…å½“è€…ã®å¿œå‹Ÿæ•°', value: candidateAppCount, icon: 'fa-file-contract', color: 'green' },
                        { label: 'AIæ¨è–¦å®Ÿæ–½æ•°', value: aiRecoCount || 0, icon: 'fa-robot', color: 'pink' }
                    ]);
                } else {
                    const { count: appCount } = await supabase.from('applications').select('*', { count: 'exact', head: true }).eq('user_id', currentUser.id);
                    const { count: recoCount } = await supabase.from('recommendations').select('*', { count: 'exact', head: true }).eq('user_id', currentUser.id);
                    renderDashboardCards(statsGrid, [
                        { label: 'å¿œå‹Ÿä¸­ã®æ±‚äºº', value: appCount || 0, icon: 'fa-file-alt', color: 'indigo' },
                        { label: 'ã‚ãªãŸã¸ã®AIæ¨è–¦', value: recoCount || 0, icon: 'fa-star', color: 'purple' },
                        { label: 'é–²è¦§ã—ãŸæ±‚äºº', value: '-', icon: 'fa-eye', color: 'gray' }
                    ]);
                }

                // --- Charts Rendering Logic ---
                if (isAgent) {
                    await renderDashboardCharts();
                }

            } catch (error) {
                console.error('Dashboard load error:', error);
                statsGrid.html('<p class="col-span-3 text-red-500 text-center py-4">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>');
            }
        }

        window.changeDashboardPeriod = (period) => {
            currentDashboardPeriod = period;
            loadDashboard(); // Reload (Optimally should only reload charts, but strict implementation needs clean state)
        };

        async function renderDashboardCharts() {
            // æ—¢å­˜ãƒãƒ£ãƒ¼ãƒˆã®ç ´æ£„
            if (dashboardChartInstances.funnel) dashboardChartInstances.funnel.destroy();
            if (dashboardChartInstances.trend) dashboardChartInstances.trend.destroy();

            // Safety Check
            if (typeof Chart === 'undefined') {
                console.error('Dashboard: Chart.js library is not loaded');
                return;
            }
            if (!document.getElementById('funnelChart') || !document.getElementById('trendChart')) {
                console.error('Dashboard: Chart canvas elements not found');
                return;
            }

            // 1. ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾— (é€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹)
            let { data: statusMasters } = await supabase
                .from('master_data')
                .select('*')
                .eq('type', 'application_status')
                .order('sort_order', { ascending: true });

            // ãƒã‚¹ã‚¿ãŒãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            if (!statusMasters || statusMasters.length === 0) {
                statusMasters = [
                    { label: 'æ›¸é¡é¸è€ƒ', value: 'æ›¸é¡é¸è€ƒä¸­', sort_order: 10 },
                    { label: 'ä¸€æ¬¡é¢æ¥', value: 'ä¸€æ¬¡é¢æ¥äºˆå®š', sort_order: 40 },
                    { label: 'äºŒæ¬¡é¢æ¥', value: 'äºŒæ¬¡é¢æ¥äºˆå®š', sort_order: 60 },
                    { label: 'æœ€çµ‚é¢æ¥', value: 'æœ€çµ‚é¢æ¥äºˆå®š', sort_order: 80 },
                    { label: 'å†…å®š', value: 'å†…å®š', sort_order: 100 }
                ];
            }
            // çµ„ç¹”ãƒ•ã‚£ãƒ«ã‚¿ãƒ»ã‚°ãƒ­ãƒ¼ãƒãƒ«é™¤å¤–ãªã©ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯ç°¡æ˜“åŒ–ï¼ˆå…¨å–å¾—æ¸ˆãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼‰
            // çµ„ç¹”IDã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹å ´åˆã¯ .eq('organization_id', currentUser.organization_id) å¿…è¦ã ãŒã€
            // ä¸Šè¨˜ã‚¯ã‚¨ãƒªã§ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚‚å–ã£ã¦ãã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã€JSå´ã§ãƒ•ã‚£ãƒ«ã‚¿ãŒå®‰å…¨ã€‚
            statusMasters = statusMasters.filter(m => m.organization_id === currentUser.organization_id || m.is_global);


            // 2. å¿œå‹Ÿãƒ‡ãƒ¼ã‚¿å–å¾— (å…¨é‡å–å¾—ã—ã¦JSé›†è¨ˆ - ãƒ‡ãƒ¼ã‚¿é‡ãŒå¤šã„å ´åˆã¯RPCæ¨å¥¨)
            // 'created_at' does not exist in applications table, using 'applied_at' instead.
            let query = supabase.from('applications').select('applied_at, status, updated_at');

            if (currentUser.role === 'coach' || currentUser.role === 'ca') {
                // ã‚³ãƒ¼ãƒã®å ´åˆã¯æ‹…å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿
                const { data: assignedUsers } = await supabase.from('users').select('id').eq('coach_id', currentUser.id);
                const ids = assignedUsers?.map(u => u.id) || [];
                if (ids.length > 0) query = query.in('user_id', ids);
                else query = query.eq('id', '00000000-0000-0000-0000-000000000000'); // No hits
            } else {
                query = query.eq('organization_id', currentUser.organization_id);
            }

            // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿
            const now = new Date();
            let startDate = new Date();
            if (currentDashboardPeriod === 'day') startDate.setDate(now.getDate() - 7); // ç›´è¿‘7æ—¥
            else if (currentDashboardPeriod === 'week') startDate.setMonth(now.getMonth() - 1); // ç›´è¿‘4é€±
            else if (currentDashboardPeriod === 'month') startDate.setMonth(now.getMonth() - 6); // ç›´è¿‘6ãƒ¶æœˆ
            else if (currentDashboardPeriod === 'year') startDate.setFullYear(now.getFullYear() - 1); // ç›´è¿‘1å¹´

            query = query.gte('applied_at', startDate.toISOString());

            const { data: applications, error } = await query;

            if (error) {
                console.error('Dashboard: Applications fetch error:', error);
                $('#dashboard-charts').prepend('<div class="col-span-2 text-red-500 bg-red-50 p-4 rounded">ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ' + error.message + '</div>');
                // ã‚¨ãƒ©ãƒ¼è©³ç´°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ’ãƒ³ãƒˆã‚’è¿½åŠ 
                if (error.code === '42703') { // Undefined column
                    $('#dashboard-charts').prepend('<div class="col-span-2 text-yellow-600 bg-yellow-50 p-2 rounded text-sm mt-2">ãƒ’ãƒ³ãƒˆ: ã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚DBã‚¹ã‚­ãƒ¼ãƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>');
                }
                return;
            }

            if (!applications || applications.length === 0) {
                console.log('Dashboard: No applications data found for this period');
                // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã§ã‚‚ç©ºã®ãƒãƒ£ãƒ¼ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ã‹ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹
                // ã“ã“ã§ã¯å‡¦ç†ã‚’ç¶šè¡Œã—ã¦ç©ºã®ãƒãƒ£ãƒ¼ãƒˆã‚’è¡¨ç¤ºã•ã›ã‚‹ï¼ˆ0ä»¶ã®ç¢ºèªã®ãŸã‚ï¼‰
            } else {
                console.log('Dashboard: Applications loaded:', applications.length);
            }

            // å®‰å…¨ç­–: nullã®å ´åˆã¯ç©ºé…åˆ—ã«ã™ã‚‹
            const validApplications = applications || [];

            // --- é›†è¨ˆãƒ­ã‚¸ãƒƒã‚¯ ---

            // A. ãƒ•ã‚¡ãƒãƒ«é›†è¨ˆ (å˜ç´”ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰ã®ç´¯ç©æ¨è¨ˆ)
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®sort_orderé †ã«ä¸¦ã¹ã‚‹
            statusMasters.sort((a, b) => a.sort_order - b.sort_order);

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã”ã¨ã®ä»¶æ•°
            const statusCounts = {};
            validApplications.forEach(app => {
                // éƒ¨åˆ†ä¸€è‡´ãªã©ã§æŸ”è»Ÿã«ãƒãƒƒãƒãƒ³ã‚°
                const match = statusMasters.find(m => app.status === m.value || app.status?.includes(m.value));
                const key = match ? match.label : 'ãã®ä»–';
                statusCounts[key] = (statusCounts[key] || 0) + 1;
            });

            // ç´¯ç©è¨ˆç®— (ç°¡æ˜“ãƒ­ã‚¸ãƒƒã‚¯: sort_orderãŒå¾Œã‚ã®ã‚‚ã®ã¯å‰ã®ã‚‚ã®ã‚‚é€šéã—ãŸã¨ä»®å®š)
            // â€»æ³¨æ„: 'ä¸åˆæ ¼' 'è¾é€€' ãªã©ã®ãƒã‚¬ãƒ†ã‚£ãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é™¤å¤–ã™ã‚‹ã‹ã€ãã‚Œã‚‰ã‚’ 'åˆ°é”ã—ãŸæœ€é«˜ãƒ•ã‚§ãƒ¼ã‚º' ã¨ã—ã¦æ‰±ã†ã‹ã€‚
            // ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ä¸»è¦ãƒ•ã‚§ãƒ¼ã‚ºã‚’è¡¨ç¤ºå¯¾è±¡ã¨ã™ã‚‹ã€‚
            const displayPhases = statusMasters.filter(m => m.sort_order <= 120); // å…¥ç¤¾ç¢ºèªã¾ã§
            const funnelLabels = displayPhases.map(m => m.label);
            const funnelData = displayPhases.map((phase, idx) => {
                // ã“ã®ãƒ•ã‚§ãƒ¼ã‚ºä»¥é™ã®ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®åˆè¨ˆ (ã“ã®ãƒ•ã‚§ãƒ¼ã‚ºã«åˆ°é”ã—ãŸç·æ•°)
                // å®Ÿéš›ã«ã¯ã€Œä¸åˆæ ¼ã€ãªã©ã‚‚è€ƒæ…®ã™ã¹ãã ãŒã€ä¸åˆæ ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®sort_orderãŒ200ç•ªå°ãªã‚‰ã€
                // æ›¸é¡ä¸åˆæ ¼(200)ã¯æ›¸é¡é€šé(30)ã«å«ã¾ã‚Œãªã„ã€‚
                // ç°¡æ˜“çš„ã«ã€Œç´¯ç©ã€ã¨ã—ã¦ãƒãƒ£ãƒ¼ãƒˆã«ã™ã‚‹ã€‚

                // ã“ã“ã§ã¯ã€Œç¾åœ¨ãã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«ã‚ã‚‹æ•°ã€ã‚’ã¾ãšå‡ºã™
                // const count = applications.filter(a => a.status === phase.value).length;
                // return count;

                // è¦ä»¶ã¯ã€Œå·¥ç¨‹ã”ã¨ã®æ­©ç•™ã¾ã‚Šã€ãªã®ã§ã€ã€Œé€šéæ•°ã€ãƒ™ãƒ¼ã‚¹ãŒæœ›ã¾ã—ã„ã€‚
                // ç°¡æ˜“ãƒ­ã‚¸ãƒƒã‚¯: sort_orderãŒè‡ªåˆ†ä»¥ä¸Šã®ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ã‚’åˆè¨ˆã™ã‚‹
                const passedCount = validApplications.filter(a => {
                    const m = statusMasters.find(mst => mst.value === a.status);
                    return m && m.sort_order >= phase.sort_order;
                }).length;
                return passedCount;
            });

            // æ­©ç•™ã¾ã‚Šç‡è¨ˆç®— (ç›´å‰ã¨æ¯”è¼ƒ)
            // const yieldRates = funnelData.map((val, i) => i === 0 ? '100%' : Math.round((val / funnelData[i-1])*100) + '%');

            dashboardChartInstances.funnel = new Chart(document.getElementById('funnelChart'), {
                type: 'bar',
                data: {
                    labels: funnelLabels,
                    datasets: [{
                        label: 'åˆ°é”æ•°(ç´¯ç©)',
                        data: funnelData,
                        backgroundColor: 'rgba(79, 70, 229, 0.6)',
                        borderColor: 'rgb(79, 70, 229)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterLabel: function (context) {
                                    const val = context.raw;
                                    const prev = context.dataset.data[context.dataIndex - 1]; // å‰ã®ãƒ•ã‚§ãƒ¼ã‚º
                                    if (context.dataIndex === 0 || !prev) return 'é–‹å§‹';
                                    const rate = Math.round((val / prev) * 100);
                                    return `æ­©ç•™ã¾ã‚Š: ${rate}%`;
                                }
                            }
                        }
                    }
                }
            });

            // B. ãƒˆãƒ¬ãƒ³ãƒ‰é›†è¨ˆ (æœˆæ¬¡/é€±æ¬¡ æ¨ç§»)
            // æœŸé–“ã”ã¨ã®ãƒ©ãƒ™ãƒ«ç”Ÿæˆ
            const trendLabels = [];
            const trendDataMap = { 'all': [] }; // ç·å¿œå‹Ÿæ•°æ¨ç§»
            // ä¸»è¦ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã®æ¨ç§»ã‚‚å‡ºã—ãŸã„ãŒã€ãƒ­ã‚°ãŒãªã„ã®ã§ã€Œã„ã¤å¤‰ã‚ã£ãŸã‹ã€ä¸æ˜ã€‚
            // ã—ãŸãŒã£ã¦ãƒˆãƒ¬ãƒ³ãƒ‰ã¯ã€Œå¿œå‹Ÿç™ºç”Ÿæ—¥ãƒ™ãƒ¼ã‚¹ã®å¿œå‹Ÿæ•°ã€ã®ã¿æ­£ç¢ºã«å‡ºã›ã‚‹ã€‚

            // å˜ä½ã”ã¨ã®é›†è¨ˆ
            const dateMap = {};
            validApplications.forEach(app => {
                // Use applied_at for date calculation
                const d = new Date(app.applied_at || app.updated_at); // Fallback to updated_at if applied_at is null
                let key = '';
                if (currentDashboardPeriod === 'day') key = `${d.getMonth() + 1}/${d.getDate()}`;
                else if (currentDashboardPeriod === 'week') {
                    // é€±ç•ªå·ãªã© (ç°¡æ˜“çš„ã«æœˆ/é€±)
                    const week = Math.ceil(d.getDate() / 7);
                    key = `${d.getMonth() + 1}æœˆç¬¬${week}é€±`;
                }
                else if (currentDashboardPeriod === 'month') key = `${d.getFullYear()}/${d.getMonth() + 1}`;
                else if (currentDashboardPeriod === 'year') key = `${d.getFullYear()}`;

                dateMap[key] = (dateMap[key] || 0) + 1;
            });

            // æ™‚é–“é †ã«ã‚½ãƒ¼ãƒˆã—ã¦é…åˆ—åŒ–
            const sortedKeys = Object.keys(dateMap).sort(); // æ–‡å­—åˆ—ã‚½ãƒ¼ãƒˆã ãŒYYYY/MMç³»ãªã‚‰æ¦‚ã­OK
            // â€»æ—¥ä»˜é †ã‚½ãƒ¼ãƒˆã¯å³å¯†ã«ã¯Dateãƒ‘ãƒ¼ã‚¹ãŒå¿…è¦ã ãŒçœç•¥

            dashboardChartInstances.trend = new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: {
                    labels: sortedKeys,
                    datasets: [{
                        label: 'æ–°è¦å¿œå‹Ÿæ•°',
                        data: sortedKeys.map(k => dateMap[k]),
                        borderColor: 'rgb(16, 185, 129)',
                        tension: 0.1,
                        fill: true,
                        backgroundColor: 'rgba(16, 185, 129, 0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰æç”»ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (å¤‰æ›´ãªã—)
        function renderDashboardCards(container, cards) {
            const html = cards.map(c => `
                <div class="bg-white rounded-lg shadow p-6 transform transition hover:-translate-y-1 duration-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">${c.label}</p>
                            <p class="text-3xl font-bold text-${c.color}-600 mt-2">${c.value}</p>
                        </div>
                        <div class="w-12 h-12 bg-${c.color}-100 rounded-full flex items-center justify-center">
                            <i class="fas ${c.icon} text-${c.color}-600 text-xl"></i>
                        </div>
                    </div>
                </div>
            `).join('');

            container.html(html);
        }



        // ========================
        // Event Handlers
        // ========================
        // ========================
        // å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠæ©Ÿèƒ½
        // ========================
        // æ±‚è·è€…é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
        // ========================

        window.openCandidateSelectionModal = async function () {
            if (allCandidateUsers.length === 0) {
                await loadCandidateUsers();
            }
            renderModalCandidateList();
            $('#candidate-selection-modal').removeClass('hidden');
        };

        window.closeCandidateSelectionModal = function () {
            $('#candidate-selection-modal').addClass('hidden');
        };

        function renderModalCandidateList(filter = '') {
            const container = $('#modal-candidate-list');
            const users = allCandidateUsers.filter(u =>
                u.name.toLowerCase().includes(filter.toLowerCase()) ||
                (u.email && u.email.toLowerCase().includes(filter.toLowerCase()))
            );

            if (users.length === 0) {
                container.html('<p class="text-center py-4 text-gray-500 text-sm">è©²å½“ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“</p>');
                return;
            }

            const html = users.map(u => `
                <div onclick="selectCandidateFromModal('${u.id}', '${escapeHtml(u.name)}', '${escapeHtml(u.email)}')"
                    class="p-3 bg-white border rounded hover:border-indigo-500 hover:bg-indigo-50 cursor-pointer transition-colors flex justify-between items-center">
                    <div>
                        <div class="font-bold text-gray-900">${u.name}</div>
                        <div class="text-xs text-gray-500">${u.email || ''}</div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300"></i>
                </div>
            `).join('');
            container.html(html);
        }

        $('#modal-candidate-search').on('input', function () {
            renderModalCandidateList($(this).val());
        });

        window.selectCandidateFromModal = function (userId, userName, userEmail) {
            selectTargetUser(userId, userName, userEmail);
            closeCandidateSelectionModal();

            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰æœ¬æ¥ã®ç´¹ä»‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
            if (currentRecommendJobId) {
                setTimeout(() => {
                    openRecommendJobModal(currentRecommendJobId);
                }, 100);
            }
        };

        function escapeHtml(str) {
            if (!str) return '';
            return str
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // å€™è£œãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
        async function loadCandidateUsers() {
            if (!window.currentUser) return; // currentUserãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„

            try {
                let query = supabase
                    .from('users')
                    .select('*, candidate_profiles!fk_candidate_profiles_user(*)')
                    .eq('organization_id', window.currentUser.organization_id)
                    .in('role', ['candidate', 'user'])
                    .order('name', { ascending: true });

                // ã‚³ãƒ¼ãƒã®å ´åˆã¯æ‹…å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã«çµã‚Šè¾¼ã¿
                if (window.currentUser.role === 'coach') {
                    query = query.eq('coach_id', window.currentUser.id);
                }

                const { data: users, error } = await query;

                if (error) throw error;

                // ãƒ•ãƒ©ãƒƒãƒˆåŒ– (candidate_profilesã®ä¸­èº«ã‚’ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã«ãƒãƒ¼ã‚¸)
                const flattenedUsers = (users || []).map(u => {
                    const profile = Array.isArray(u.candidate_profiles) ? u.candidate_profiles[0] : u.candidate_profiles;
                    const combined = { ...u, ...profile };
                    // IDã¯usersã®ã‚‚ã®ã‚’å„ªå…ˆ
                    combined.id = u.id;
                    return combined;
                });

                allCandidateUsers = flattenedUsers;
                targetUsersCache = flattenedUsers; // æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã¨ã®äº’æ›æ€§ã®ãŸã‚
                shouldReloadCandidates = false; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°å®Œäº†
                console.log('Loaded candidate users:', allCandidateUsers.length);
            } catch (error) {
                console.error('Failed to load candidate users:', error);
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«è¡¨ç¤º
        function filterAndShowTargetUsers(searchTerm) {
            const filtered = allCandidateUsers.filter(user => {
                if (user.status === 'suspended') return false;
                const name = (user.name || '').toLowerCase();
                const email = (user.email || '').toLowerCase();
                return name.includes(searchTerm) || email.includes(searchTerm);
            });

            const dropdown = $('#target-user-dropdown');

            if (filtered.length === 0) {
                dropdown.html('<div class="p-3 text-gray-500 text-sm">è©²å½“ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“</div>').removeClass('hidden');
                return;
            }

            const html = filtered.map(user => `
                <div class="target-user-option" data-user-id="${user.id}">
                    <div class="user-name font-medium text-gray-800">${user.name || 'No Name'}</div>
                    <div class="user-email text-sm text-gray-500">${user.email || 'No Email'}</div>
                </div>
            `).join('');

            dropdown.html(html).removeClass('hidden');
        }

        // å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ
        function selectTargetUser(userId, userName, userEmail) {
            selectedTargetUserId = userId;
            selectedTargetUserName = userName;
            selectedTargetUserEmail = userEmail;

            $('#selected-user-name').html(`
                ${userName} 
                <button onclick="event.stopPropagation(); showAdminUserModal('${userId}')" class="ml-2 text-indigo-600 hover:text-indigo-800 text-xs bg-indigo-50 px-2 py-1 rounded border border-indigo-200 transition-colors">
                    <i class="fas fa-address-card mr-1"></i>è©³ç´°
                </button>
            `);
            $('#selected-user-email').text(userEmail);
            $('#selected-user-display').removeClass('hidden');
            $('#target-user-dropdown').addClass('hidden');
            $('#target-user-search').val('');
            $('#target-user-input-wrapper').addClass('hidden'); // å…¥åŠ›æ¬„ã‚’éš ã™

            // è¿½åŠ UIã‚’è¡¨ç¤º
            $('#exclude-matched-container').removeClass('hidden');
            $('#select-top-30-btn').removeClass('hidden');

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¦æ¤œç´¢æ¡ä»¶ã«ã‚»ãƒƒãƒˆ
            const user = allCandidateUsers.find(u => u.id === userId);
            if (user) {
                console.log('Setting search filters from user profile:', user);

                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä¸€æ—¦ãƒªã‚»ãƒƒãƒˆ
                $('#search-keyword').val('');
                $('#search-location').val('');
                $('#search-salary-min').val('');
                $('#search-job-category').val(null).trigger('change');
                $('#search-industry-category').val(null).trigger('change');
                $('#search-employment-type').val(null).trigger('change');
                $('#search-prefecture').val(null).trigger('change');
                $('#search-job-experience-ok').prop('checked', false);
                $('#search-industry-experience-ok').prop('checked', false);
                // $('#search-is-remote').prop('checked', false); // ãƒªãƒ¢ãƒ¼ãƒˆå¯ã¯ä¿æŒã—ã¦ã‚‚ã„ã„ã‹ã‚‚ã—ã‚Œãªã„ãŒãƒªã‚»ãƒƒãƒˆæ¨å¥¨

                // ãƒ˜ãƒ«ãƒ‘ãƒ¼: é…åˆ—ã‹ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šæ–‡å­—åˆ—ã‚’é…åˆ—ã«æ­£è¦åŒ–
                // ãƒ˜ãƒ«ãƒ‘ãƒ¼: é…åˆ—ã‹ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šæ–‡å­—åˆ—ã‚’é…åˆ—ã«æ­£è¦åŒ–
                const normalizeToArray = (val) => {
                    if (!val) return [];
                    if (Array.isArray(val)) return val;
                    // JSONæ–‡å­—åˆ—ã£ã½ã„å ´åˆã¯ãƒ‘ãƒ¼ã‚¹ã‚’è©¦ã¿ã‚‹
                    if (typeof val === 'string') {
                        const trimmed = val.trim();
                        if (trimmed.startsWith('[') && trimmed.endsWith(']')) {
                            try {
                                return JSON.parse(trimmed);
                            } catch (e) {
                                console.warn('JSON Parse failed for profile data:', val);
                            }
                        }
                        // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šãªã©
                        return filteredSplit(val); // filteredSplitãŒã‚ã‚Œã°ä½¿ã†ãŒã€ãªã‘ã‚Œã°split
                    }
                    return val.toString().split(',').map(s => s.trim());
                };

                const filteredSplit = (val) => {
                    return val.split(/[,ã€\s]+/).map(s => s.trim()).filter(s => s.length > 0);
                }

                // è·ç¨®
                if (user.desired_job_type) {
                    const vals = normalizeToArray(user.desired_job_type);
                    $('#search-job-category').val(vals).trigger('change');
                }

                // æ¥­ç•Œ
                if (user.desired_industry) {
                    const vals = normalizeToArray(user.desired_industry);
                    $('#search-industry-category').val(vals).trigger('change');
                }

                // é›‡ç”¨å½¢æ…‹
                if (user.desired_employment_type) {
                    const vals = normalizeToArray(user.desired_employment_type);
                    $('#search-employment-type').val(vals).trigger('change');
                }

                // å‹¤å‹™åœ°
                if (user.desired_location) {
                    const locs = normalizeToArray(user.desired_location);

                    // è©³ç´°ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã¸ã®ã‚»ãƒƒãƒˆã¯é™¤å¤– (ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›)
                    // $('#search-location').val(locs.join(', '));

                    // éƒ½é“åºœçœŒã‚’ã‚»ãƒƒãƒˆ
                    const foundPrefs = [];
                    locs.forEach(loc => {
                        const pref = window.prefectures.find(p => loc.startsWith(p));
                        if (pref) foundPrefs.push(pref);
                    });

                    if (foundPrefs.length > 0) {
                        $('#search-prefecture').val(foundPrefs).trigger('change');
                        // å‰¯ä½œç”¨å¯¾ç­–: ãƒˆãƒªã‚¬ãƒ¼ã«ã‚ˆã£ã¦ã‚»ãƒƒãƒˆã•ã‚Œã¦ã—ã¾ã£ãŸå ´åˆã¯å³åº§ã«ã‚¯ãƒªã‚¢
                        $('#search-location').val('');
                    }
                }

                // æœ€ä½å¹´å
                if (user.desired_salary) {
                    $('#search-salary-min').val(user.desired_salary / 10000);
                }

                // æœªçµŒé¨“OKæ¡ä»¶
                if (user.desired_job_experience_ok) {
                    $('#search-job-experience-ok').prop('checked', true);
                }
                if (user.desired_industry_experience_ok) {
                    $('#search-industry-experience-ok').prop('checked', true);
                }
            }

            // æ¤œç´¢ã‚’å†å®Ÿè¡Œã—ã¦é™¤å¤–ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨
            searchJobs();

            console.log('Selected target user:', userName, userId);
            updateBulkRecommendBar(); // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
        }

        // å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠã‚’ã‚¯ãƒªã‚¢
        function clearTargetUserSelection() {
            selectedTargetUserId = null;
            selectedTargetUserName = null;
            selectedTargetUserEmail = null;

            $('#selected-user-display').addClass('hidden');
            $('#target-user-search').val('');
            $('#target-user-input-wrapper').removeClass('hidden'); // å…¥åŠ›æ¬„ã‚’è¡¨ç¤º

            // è¿½åŠ UIã‚’éè¡¨ç¤º (Adminã®å ´åˆã¯å¸¸ã«è¡¨ç¤ºã™ã‚‹æ–¹é‡ã«å¤‰ãˆãŸãŒã€ä¸€å¿œã‚¯ãƒ©ã‚¹åˆ¶å¾¡ã‚’æ®‹ã™)
            // $('#exclude-matched-container').addClass('hidden'); 
            $('#select-top-30-btn').addClass('hidden');
            $('#search-exclude-matched').prop('checked', false); // ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™

            // æ¤œç´¢ã‚’å†å®Ÿè¡Œ
            searchJobs();

            console.log('Cleared target user selection');
            updateBulkRecommendBar(); // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
        }

        // ã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…ç”¨ï¼šçµ„ç¹”åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
        async function initOrgSwitcher() {
            try {
                // å…¨çµ„ç¹”ã‚’å–å¾—
                const { data: orgs, error } = await supabase
                    .from('organizations')
                    .select('id, name')
                    .order('name');

                if (error) throw error;

                const switcher = $('#org-switcher');
                switcher.empty();

                // è‡ªåˆ†ã®æ‰€å±çµ„ç¹”ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ã‚‚é¸æŠè‚¢ã«å«ã‚ã‚‹ã‹ã€ã‚ã‚‹ã„ã¯ã€Œé¸æŠè§£é™¤ã€ã§æˆ»ã‚‹ã‹
                // ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«å…¨çµ„ç¹”ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã—ã€ç¾åœ¨ã®organization_idã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹

                orgs.forEach(org => {
                    const option = $('<option>').val(org.id).text(org.name);
                    if (org.id === currentUser.organization_id) {
                        option.prop('selected', true);
                    }
                    switcher.append(option);
                });

                // è¡¨ç¤º
                $('#org-switcher-container').removeClass('hidden');

                // Select2ã‚’é©ç”¨
                switcher.select2({
                    width: '300px',
                    placeholder: 'çµ„ç¹”ã‚’é¸æŠ...',
                    allowClear: false,
                    dropdownAutoWidth: true,
                    language: {
                        noResults: function () {
                            return "è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
                        }
                    }
                });

                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                switcher.off('change').on('change', function () {
                    const newOrgId = $(this).val();
                    if (newOrgId) {
                        localStorage.setItem('super_admin_target_org_id', newOrgId);
                    } else {
                        localStorage.removeItem('super_admin_target_org_id');
                    }
                    // ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦è¨­å®šã‚’åæ˜ 
                    location.reload();
                });

            } catch (error) {
                console.error('Failed to init org switcher:', error);
            }
        }

        $(document).ready(function () {
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒéè¡¨ç¤ºã®è¦ªè¦ç´ å†…ã«é–‰ã˜è¾¼ã‚ã‚‰ã‚Œã‚‹ã®ã‚’é˜²ããŸã‚ã€bodyç›´ä¸‹ã¸ç§»å‹•
            $('#admin-job-csv-modal, #admin-user-csv-modal, #admin-company-csv-modal, #drive-import-modal, #data-merge-modal').appendTo('body');

            // Organization Code Validation
            $('#check-org-code').on('click', async function () {
                const code = $('#signup-org-code').val().trim();
                const errorEl = $('#org-code-error');
                const nameEl = $('#org-name-display');
                const inputEl = $('#signup-org-code');

                if (!code) {
                    errorEl.text('ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„').removeClass('hidden');
                    nameEl.addClass('hidden');
                    inputEl.removeClass('border-green-500 bg-green-50');
                    return;
                }

                try {
                    errorEl.addClass('hidden');
                    const { data, error } = await supabase.rpc('get_organization_name_by_code', { org_code: code });

                    if (error) throw error;

                    if (data && data.length > 0) {
                        nameEl.text(`å‚åŠ çµ„ç¹”: ${data[0].name}`).removeClass('hidden');
                        inputEl.addClass('border-green-500 bg-green-50');
                    } else {
                        errorEl.text('ç„¡åŠ¹ãªçµ„ç¹”ã‚³ãƒ¼ãƒ‰ã§ã™').removeClass('hidden');
                        nameEl.addClass('hidden');
                        inputEl.removeClass('border-green-500 bg-green-50');
                    }
                } catch (err) {
                    console.error('Check Error:', err);
                    errorEl.text('ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ').removeClass('hidden');
                }
            });

            // ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ 
            $('#login-form').on('submit', async function (e) {
                e.preventDefault()
                const email = $('#login-email').val().trim()
                const password = $('#login-password').val()
                await login(email, password)
            })

            // ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ 
            $('#signup-form').on('submit', async function (e) {
                e.preventDefault()
                const name = $('#signup-name').val().trim()
                const furigana = $('#signup-furigana').val().trim()
                const email = $('#signup-email').val().trim()
                const password = $('#signup-password').val()
                const token = $('#invitation-token').val()
                const orgCode = $('#signup-org-code').val().trim()
                await signup(name, furigana, email, password, token, orgCode)
            })


            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            $('#logout-btn').on('click', logout)

            // é€šçŸ¥ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³
            $('#notification-btn').on('click', function (e) {
                e.stopPropagation()
                $('#notification-dropdown').toggleClass('hidden')
                loadNotifications()
            })

            // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            $(document).on('click', function () {
                $('#notification-dropdown').addClass('hidden')
            })

            $('#notification-dropdown').on('click', function (e) {
                e.stopPropagation()
            })

            // Prevent admin user modal from closing when clicking inside
            $('#admin-user-modal').on('click', function (e) {
                // Only close if clicking on the backdrop (the modal itself, not its children)
                if (e.target === this) {
                    // Don't close automatically - user must click the X button or Cancel
                    e.stopPropagation();
                }
            });

            // Prevent clicks inside modal content from bubbling
            $('#admin-user-modal > div').on('click', function (e) {
                e.stopPropagation();
            });

            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
            $('#show-signup').on('click', function (e) {
                e.preventDefault()
                showPage('signup-page')
            })

            $('#show-login').on('click', function (e) {
                e.preventDefault()
                showPage('login-page')
            })

            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
            $('.nav-link').on('click', function (e) {
                e.preventDefault()
                const page = $(this).data('page')

                $('.nav-link').removeClass('bg-indigo-50 text-indigo-600')
                $(this).addClass('bg-indigo-50 text-indigo-600')

                showAppContent(`${page}-content`)
                $(document).trigger('page-switched', [page])

                if (page === 'jobs') {
                    // ä¿å­˜ã•ã‚ŒãŸæ¤œç´¢æ¡ä»¶ã‚’é©ç”¨
                    const savedFilters = loadSearchFilters();
                    if (savedFilters) {
                        applySearchFilters(savedFilters);
                        loadJobs(savedFilters);
                    } else {
                        loadJobs();
                    }

                    // ç®¡ç†è€…ãƒ»ã‚³ãƒ¼ãƒã®å ´åˆã€å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠUIã‚’è¡¨ç¤º
                    if (window.currentUser && ['org_admin', 'admin', 'super_admin', 'coach', 'ca'].includes(window.currentUser.role)) {
                        if (allCandidateUsers.length === 0 || shouldReloadCandidates) {
                            loadCandidateUsers();
                        }

                        // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ç™»éŒ²ï¼ˆé‡è¤‡ç™»éŒ²é˜²æ­¢ã®ãŸã‚offã—ã¦ã‹ã‚‰onï¼‰
                        $('#target-user-search').off('input focus click').on('input focus click', function () {
                            const searchTerm = $(this).val().toLowerCase();
                            filterAndShowTargetUsers(searchTerm);
                        });

                        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ä»¥å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‰ã˜ã‚‹
                        $(document).on('click', function (e) {
                            if (!$(e.target).closest('#target-user-input-wrapper').length && !$(e.target).closest('#target-user-dropdown').length) {
                                $('#target-user-dropdown').addClass('hidden');
                            }
                        });

                        $('#clear-user-selection').off('click').on('click', function () {
                            clearTargetUserSelection();
                        });

                        $(document).off('click', '.target-user-option').on('click', '.target-user-option', function () {
                            const userId = $(this).data('user-id');
                            const userName = $(this).find('.user-name').text();
                            const userEmail = $(this).find('.user-email').text();
                            selectTargetUser(userId, userName, userEmail);
                        });
                    }
                } else if (page === 'applications') {
                    loadApplications()
                } else if (page === 'recommendations') {
                    loadRecommendations()
                } else if (page === 'profile') {
                    loadProfile()
                } else if (page === 'admin-jobs') {
                    loadAdminJobs()
                } else if (page === 'admin-companies') {
                    loadCompanies()
                } else if (page === 'admin-applicants') {
                    loadAdminApplicants()
                } else if (page === 'admin-candidates') {
                    loadAdminCandidates()
                } else if (page === 'admin-users') {
                    loadAdminUsers()
                } else if (page === 'admin-csv') {
                    loadCSVHistory()
                } else if (page === 'admin-logs') {
                    loadAuditLogs()
                } else if (page === 'admin-settings') {
                    loadAdminSettings()
                } else if (page === 'admin-prompts') {
                    loadPrompts()
                } else if (page === 'admin-master') {
                    loadMasterData()
                } else if (page === 'super-admin-organizations') {
                    loadSuperAdminOrganizations()
                } else if (page === 'coach-students') {
                    loadCoachStudents()
                } else if (page === 'candidate-search') {
                    loadCandidateSearch()
                } else if (page === 'kpi-dashboard') {
                    loadKPIDashboard()
                } else if (page === 'ai-scout') {
                    // AIã‚¹ã‚«ã‚¦ãƒˆãƒšãƒ¼ã‚¸ã®åˆæœŸåŒ–
                    switchProfileAnalysisTab('new');
                }

                const titles = {
                    'dashboard': 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰',
                    'jobs': 'æ±‚äººæ¤œç´¢',
                    'ai-scout': 'AIã‚¹ã‚«ã‚¦ãƒˆ',
                    'applications': 'å¿œå‹Ÿãƒ»é¸è€ƒçŠ¶æ³',
                    'recommendations': 'ãŠã™ã™ã‚æ±‚äºº',
                    'profile': 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«',
                    'admin-jobs': 'æ±‚äººç®¡ç†',
                    'admin-companies': 'ä¼æ¥­ç®¡ç†',
                    'admin-applicants': 'å¿œå‹Ÿè€…ç®¡ç†',
                    'admin-candidates': 'æ±‚è·è€…ç®¡ç†',
                    'admin-users': 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†',
                    'admin-csv': 'CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ',
                    'admin-logs': 'æ“ä½œãƒ­ã‚°',
                    'admin-prompts': 'AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š',
                    'admin-master': 'ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ç®¡ç†',
                    'super-admin-organizations': 'çµ„ç¹”ç®¡ç†',
                    'coach-students': 'æ‹…å½“æ±‚è·è€…ç®¡ç†',
                    'candidate-search': 'æ±‚è·è€…æ¤œç´¢',
                    'kpi-dashboard': 'KPIãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰'
                }
                $('#page-title').text(titles[page] || page)
            })

            // ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼
            // ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¶å¾¡
            function toggleSidebar() {
                $('.sidebar').toggleClass('open');
                $('#sidebar-overlay').toggleClass('active');
            }

            $('#mobile-menu-btn').on('click', function (e) {
                e.stopPropagation();
                toggleSidebar();
            });

            $('#sidebar-overlay').on('click', function () {
                toggleSidebar();
            });

            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã‚¯ãƒªãƒƒã‚¯æ™‚ã«é–‰ã˜ã‚‹ï¼ˆãƒ¢ãƒã‚¤ãƒ«ã®ã¿ï¼‰
            $('.nav-link').on('click', function () {
                if ($(window).width() < 768) {
                    $('.sidebar').removeClass('open');
                    $('#sidebar-overlay').removeClass('active');
                }
            });

            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰æ‹›å¾…ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
            const urlParams = new URLSearchParams(window.location.search)
            const token = urlParams.get('token')
            if (token) {
                $('#invitation-token').val(token)
                showPage('signup-page')
            }

            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
            supabase.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¦ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸
                    supabase
                        .from('users')
                        .select('*, organizations(*), organization_members!inner(role)')
                        .eq('id', session.user.id)
                        .eq('organization_members.organization_id', session.user.user_metadata.organization_id || null) // æš«å®š
                        .single()
                        .then(async ({ data }) => {
                            if (!data) {
                                // organization_members è¾¼ã¿ã§å†å–å¾—ï¼ˆã‚ˆã‚Šç¢ºå®Ÿãªæ–¹æ³•ï¼‰
                                const { data: userData } = await supabase
                                    .from('users')
                                    .select('*, organizations(*)')
                                    .eq('id', session.user.id)
                                    .single();

                                const { data: memData } = await supabase
                                    .from('organization_members')
                                    .select('role')
                                    .eq('user_id', session.user.id)
                                    .eq('organization_id', userData.organization_id)
                                    .single();

                                data = { ...userData, role: memData ? memData.role : userData.role };
                            }

                            if (data) {
                                currentUser = data
                                window.currentUser = data;
                                console.log('Session restored for:', currentUser.name, 'Role:', currentUser.role);

                                // ã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…ã®å ´åˆã€çµ„ç¹”åˆ‡ã‚Šæ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯ã‚’é©ç”¨
                                if (currentUser.role === 'super_admin') {
                                    const targetOrgId = localStorage.getItem('super_admin_target_org_id');
                                    if (targetOrgId && targetOrgId !== currentUser.organization_id) {
                                        // åˆ‡ã‚Šæ›¿ãˆå…ˆã®çµ„ç¹”æƒ…å ±ã‚’å–å¾—
                                        const { data: targetOrg } = await supabase
                                            .from('organizations')
                                            .select('*')
                                            .eq('id', targetOrgId)
                                            .single();

                                        if (targetOrg) {
                                            // çµ„ç¹”IDã¨çµ„ç¹”æƒ…å ±ã‚’ä¸Šæ›¸ãï¼ˆãƒ¡ãƒ¢ãƒªä¸Šã®ã¿ï¼‰
                                            currentUser.organization_id = targetOrgId;
                                            currentUser.organizations = targetOrg;
                                            console.log('Super Admin: Switched to organization', targetOrg.name, targetOrgId);
                                        }
                                    }
                                    // çµ„ç¹”åˆ‡ã‚Šæ›¿ãˆUIã®åˆæœŸåŒ–
                                    initOrgSwitcher();
                                }

                                // UIåæ˜ 
                                $('#user-name').text(currentUser.name);
                                $('#user-role').text(getRoleLabel(currentUser.role));
                                $('#org-name').text(currentUser.organizations ? currentUser.organizations.name : '');
                                $('#org-code-display').text(currentUser.organizations?.code ? `ã‚³ãƒ¼ãƒ‰: ${currentUser.organizations.code}` : '');

                                // ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºã®æ›´æ–°
                                updateMenuVisibility(currentUser.role);

                                // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸

                                // loadDashboardã®å‘¼ã³å‡ºã—ã‚’ãƒ­ãƒ¼ãƒ«ã§åˆ†å²
                                if (currentUser.role === 'candidate') {
                                    await loadJobs();
                                    showAppContent('jobs-content');
                                    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                                    $('.nav-link').removeClass('bg-indigo-50 text-indigo-600');
                                    $('.nav-link[data-page="jobs"]').addClass('bg-indigo-50 text-indigo-600');
                                } else {
                                    loadDashboard();
                                    // é€šå¸¸ã®ãƒ•ãƒ­ãƒ¼ã§ã¯showPage('app-page')ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹ãŒã€å¿µã®ãŸã‚
                                    $('.nav-link[data-page="dashboard"]').addClass('bg-indigo-50 text-indigo-600');
                                }

                                loadNotifications()
                                initMasterDataDropdowns(); // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                                showPage('app-page')
                                isInitialLoad = false;
                            }
                        })
                }
            })
        })
    </script>

    <!-- Scout Settings Modal -->
    <div id="scout-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
        style="z-index: 10001;">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-magic mr-2 text-indigo-600"></i>AIã‚¹ã‚«ã‚¦ãƒˆæ–‡ä½“è¨­å®š
                </h2>
                <button onclick="closeScoutSettingsModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-6">
                <!-- Activation Toggle -->
                <div class="bg-indigo-50 border border-indigo-100 rounded-lg p-4 flex items-center justify-between">
                    <div>
                        <h3 class="font-bold text-indigo-900">è‡ªåˆ†ã®æ–‡ä½“ã‚’é©ç”¨ã™ã‚‹</h3>
                        <p class="text-xs text-indigo-700 mt-1">ONã«ã™ã‚‹ã¨ã€ã‚ãªãŸã®æ™®æ®µã®ãƒ¡ãƒ¼ãƒ«ã‚„éå»ã®ã‚¹ã‚«ã‚¦ãƒˆæ–‡ã‚’å­¦ç¿’ã—ã€AIãŒã€Œã‚ãªãŸã‚‰ã—ã„ã€æ–‡é¢ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="scout-style-active" class="sr-only peer">
                        <div
                            class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600">
                        </div>
                    </label>
                </div>

                <!-- Style Analysis Section -->
                <div>
                    <h3 class="font-bold text-gray-800 mb-2">æ™®æ®µã®ãƒ¡ãƒ¼ãƒ«ã‹ã‚‰æ–‡ä½“ã‚’åˆ†æãƒ»è‡ªå‹•ç”Ÿæˆ</h3>
                    <p class="text-sm text-gray-600 mb-4">
                        éå»ã«é€ã£ãŸã‚¹ã‚«ã‚¦ãƒˆãƒ¡ãƒ¼ãƒ«ã‚„ã€æ™®æ®µã®æ¥­å‹™é€£çµ¡ãªã©ã‚’3ä»¶ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ã‚ãªãŸã®å£èª¿ã€ä¸å¯§ã•ã®åº¦åˆã„ã€æ”¹è¡Œã®ã‚¯ã‚»ãªã©ã‚’AIãŒåˆ†æã—ã¾ã™ã€‚
                    </p>

                    <div id="scout-examples-area" class="space-y-3 mb-4">
                        <textarea class="scout-example-input w-full border rounded p-2 text-sm h-20"
                            placeholder="ä¾‹æ–‡1: ã¯ã˜ã‚ã¾ã—ã¦ã€æ ªå¼ä¼šç¤¾ã€‡ã€‡ã®ç”°ä¸­ã¨ç”³ã—ã¾ã™..."></textarea>
                        <textarea class="scout-example-input w-full border rounded p-2 text-sm h-20"
                            placeholder="ä¾‹æ–‡2: å…ˆæ—¥ã¯ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚æ¬¡å›ã®ä»¶ã§ã™ãŒ..."></textarea>
                        <textarea class="scout-example-input w-full border rounded p-2 text-sm h-20"
                            placeholder="ä¾‹æ–‡3: ï¼ˆå¿…é ˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€å¤šã„ã»ã©ç²¾åº¦ãŒä¸ŠãŒã‚Šã¾ã™ï¼‰"></textarea>
                    </div>
                    <button id="analyze-examples-btn" onclick="analyzeScoutExamples()"
                        class="w-full bg-white border-2 border-indigo-600 text-indigo-600 font-bold py-2 rounded hover:bg-indigo-50 transition">
                        <i class="fas fa-microscope mr-2"></i>åˆ†æã—ã¦ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç”Ÿæˆ
                    </button>
                </div>

                <div class="border-t pt-6">
                    <label class="block font-bold text-gray-800 mb-2">
                        ç”Ÿæˆã•ã‚ŒãŸã‚¹ã‚¿ã‚¤ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆç·¨é›†å¯ï¼‰
                    </label>
                    <textarea id="scout-style-prompt" rows="6"
                        class="w-full border border-gray-300 rounded-lg p-3 text-sm font-mono bg-gray-50 focus:bg-white transition"
                        placeholder="åˆ†æçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚æ‰‹å‹•ã§å…¥åŠ›ãƒ»ä¿®æ­£ã‚‚å¯èƒ½ã§ã™ã€‚"></textarea>
                </div>
            </div>
            <div class="p-6 border-t bg-gray-50 flex justify-end gap-3 rounded-b-lg">
                <button onclick="closeScoutSettingsModal()"
                    class="px-4 py-2 text-gray-600 hover:text-gray-800">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="saveScoutSettings()"
                    class="px-6 py-2 bg-indigo-600 text-white font-bold rounded shadow hover:bg-indigo-700 transition">
                    è¨­å®šã‚’ä¿å­˜
                </button>
            </div>
        </div>
    </div>

    <!-- Favorites Modal -->
    <div id="favorites-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg w-full max-w-2xl mx-4 max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-heart text-pink-500 mr-2"></i>ãŠæ°—ã«å…¥ã‚Šæ±‚äºº
                </h3>
                <button onclick="closeFavoritesModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="favorites-list" class="p-6 overflow-y-auto flex-1">
                <!-- Favorites will be rendered here -->
            </div>
            <div class="p-4 border-t border-gray-200 bg-gray-50 rounded-b-lg text-right">
                <button onclick="closeFavoritesModal()"
                    class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    é–‰ã˜ã‚‹
                </button>
            </div>
        </div>
    </div>

    <div id="recommendation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
        style="z-index: 10002;">
        <div class="bg-white rounded-lg w-full max-w-3xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-file-alt text-indigo-600 mr-2"></i>ä¼æ¥­ã¸ã®æ¨è–¦æ–‡ä½œæˆ
                </h3>
                <button onclick="closeRecommendationModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="mb-6">
                <p class="text-gray-600 mb-4">
                    AIãŒæ±‚è·è€…ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¨æ±‚äººæƒ…å ±ã‚’åˆ†æã—ã€äººäº‹æ‹…å½“è€…ã«éŸ¿ãæ¨è–¦æ–‡ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚
                    ç”Ÿæˆã•ã‚ŒãŸæ–‡ç« ã¯è‡ªç”±ã«ç·¨é›†ã§ãã¾ã™ã€‚
                </p>

                <div class="flex justify-end mb-4">
                    <button onclick="generateRecommendation()" id="generate-recommendation-btn"
                        class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 flex items-center gap-2">
                        <i class="fas fa-magic"></i>
                        <span>AIã§æ¨è–¦æ–‡ã‚’ç”Ÿæˆã™ã‚‹</span>
                    </button>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">æ¨è–¦æ–‡</label>
                    <textarea id="recommendation-text" rows="15"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        placeholder="ã“ã“ã«æ¨è–¦æ–‡ãŒç”Ÿæˆã•ã‚Œã¾ã™..."></textarea>
                </div>
            </div>

            <div class="flex justify-end gap-3 pt-4 border-t">
                <button onclick="closeRecommendationModal()"
                    class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="saveRecommendation()"
                    class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                    <i class="fas fa-save mr-2"></i>ä¿å­˜ã™ã‚‹
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentRecommendationAppId = null;

        // æ¨è–¦æ–‡ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        window.openRecommendationModal = async function (applicationId) {
            console.log('openRecommendationModal called with ID:', applicationId);
            currentRecommendationAppId = applicationId;

            // æ—¢å­˜ã®æ¨è–¦æ–‡ã‚’å–å¾—
            try {
                if (!window.supabase) {
                    throw new Error('Supabase client is not initialized');
                }

                const { data: app, error } = await window.supabase
                    .from('applications')
                    .select('recommendation_text')
                    .eq('id', applicationId)
                    .single();

                if (error) throw error;

                console.log('Fetched application data:', app);

                const modal = $('#recommendation-modal');
                console.log('Modal element found:', modal.length > 0);

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’bodyã®æœ€å¾Œã«ç§»å‹•ã—ã¦ã€è¦ªè¦ç´ ã®å½±éŸ¿ã‚’å—ã‘ãªã„ã‚ˆã†ã«ã™ã‚‹
                $('body').append(modal);

                $('#recommendation-text').val(app.recommendation_text || '');

                // å¼·åˆ¶çš„ã«è¡¨ç¤º
                modal.removeClass('hidden');
                modal.attr('style', 'display: flex !important; z-index: 99999 !important;');

                console.log('Modal moved to body end and forced to display');
                // alert('æ¨è–¦æ–‡ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã¾ã—ãŸ'); // ãƒ‡ãƒãƒƒã‚°ç”¨ã‚¢ãƒ©ãƒ¼ãƒˆ

            } catch (error) {
                console.error('Failed to fetch recommendation:', error);
                alert('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error));
            }
        }

        // æ¨è–¦æ–‡ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        window.closeRecommendationModal = function () {
            // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä¸Šæ›¸ãã—ã¦éè¡¨ç¤ºã«ã™ã‚‹
            $('#recommendation-modal').addClass('hidden').css('display', 'none');
            currentRecommendationAppId = null;
        }

        // AIã§æ¨è–¦æ–‡ã‚’ç”Ÿæˆ
        window.generateRecommendation = async function () {
            console.log('generateRecommendation called');
            if (!currentRecommendationAppId) {
                console.error('No currentRecommendationAppId set');
                return;
            }

            const btn = $('#generate-recommendation-btn');
            const originalHtml = btn.html();
            btn.html('<i class="fas fa-spinner fa-spin mr-2"></i>ç”Ÿæˆä¸­...').prop('disabled', true);

            try {
                if (!window.supabase) throw new Error('Supabase client not initialized');

                console.log('Invoking generate-recommendation-letter for:', currentRecommendationAppId);
                const { data, error } = await window.supabase.functions.invoke('generate-recommendation-letter', {
                    body: { applicationId: currentRecommendationAppId }
                });

                if (error) throw error;
                if (!data.success) throw new Error(data.error || 'ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');

                console.log('Generation success:', data);
                $('#recommendation-text').val(data.text);

            } catch (error) {
                console.error('Failed to generate recommendation:', error);
                alert('æ¨è–¦æ–‡ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error));
            } finally {
                btn.html(originalHtml).prop('disabled', false);
            }
        }


        // ========================================
        // è·å‹™çµŒæ­´æ›¸ãƒ»æ¨è–¦çŠ¶ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½
        // ========================================

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentDocumentApplicationId = null;
        let currentDocumentType = null;
        let currentDocumentData = null;


        // è·å‹™çµŒæ­´æ›¸ãƒ»æ¨è–¦çŠ¶ã‚’ç”Ÿæˆï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºç‰ˆï¼‰
        window.generateDocument = async function (applicationId, type) {
            console.log('generateDocument called:', { applicationId, type });

            currentDocumentApplicationId = applicationId;
            currentDocumentType = type;

            console.log('About to call modal function for type:', type);

            if (type === 'resume') {
                console.log('Calling window.openResumePreviewModal');
                window.openResumePreviewModal(applicationId);
            } else {
                console.log('Calling window.openRecommendationDocPreviewModal');
                window.openRecommendationDocPreviewModal(applicationId);
            }

            console.log('Modal function called');
        }

        // è·å‹™çµŒæ­´æ›¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        window.openResumePreviewModal = async function (applicationId) {
            console.log('openResumePreviewModal START, applicationId:', applicationId);

            const modal = $('#resume-preview-modal');
            console.log('Modal element found:', modal.length);

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’bodyã®ç›´ä¸‹ã«ç§»å‹•ï¼ˆè¦ªè¦ç´ ã®å½±éŸ¿ã‚’å—ã‘ãªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰
            modal.appendTo('body');

            modal.removeClass('hidden').css('display', 'flex');
            console.log('Modal display set to flex');

            // ç”Ÿæˆä¸­è¡¨ç¤º
            $('#resume-generating').show();
            $('#resume-preview-content').hide();
            $('#resume-error').hide();
            console.log('Loading state shown');

            try {
                console.log('Calling Edge Function...');
                // Edge Functionã‚’å‘¼ã³å‡ºã—ã¦AIç”Ÿæˆ
                const { data, error } = await window.supabase.functions.invoke('generate-application-document', {
                    body: {
                        applicationId: applicationId,
                        type: 'resume'
                    },
                    headers: {
                        'x-user-id': currentUser?.id || ''
                    }
                });

                console.log('Edge Function response:', { data, error });

                if (error) throw error;
                if (!data.success) throw new Error(data.error);

                currentDocumentData = data.documentData;
                console.log('Document data received:', currentDocumentData);

                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«è¡¨ç¤º
                $('#resume-summary').val(data.documentData.summary || '');
                $('#resume-work-history').val(formatWorkHistory(data.documentData.work_history));
                $('#resume-strengths').val(formatList(data.documentData.strengths || data.documentData.match_highlights));
                $('#resume-skills').val(formatSkills(data.documentData.skills));
                $('#resume-self-pr').val(data.documentData.self_pr || '');
                $('#resume-motivation').val(data.documentData.motivation || 'å¿—æœ›å‹•æ©Ÿã‚’è¨˜å…¥ã—ã¦ãã ã•ã„');

                console.log('Form fields populated');

                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                $('#resume-generating').hide();
                $('#resume-preview-content').show();
                console.log('Preview content shown');

            } catch (error) {
                console.error('Resume generation error:', error);
                $('#resume-generating').hide();
                $('#resume-error-message').text(error.message || 'ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                $('#resume-error').show();
            }
        }

        // æ¨è–¦çŠ¶ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        window.openRecommendationDocPreviewModal = async function (applicationId) {
            const modal = $('#recommendation-doc-preview-modal');

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’bodyã®ç›´ä¸‹ã«ç§»å‹•ï¼ˆè¦ªè¦ç´ ã®å½±éŸ¿ã‚’å—ã‘ãªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰
            modal.appendTo('body');

            modal.removeClass('hidden').css('display', 'flex');

            // ç”Ÿæˆä¸­è¡¨ç¤º
            $('#recommendation-doc-generating').show();
            $('#recommendation-doc-preview-content').hide();
            $('#recommendation-doc-error').hide();

            try {
                // Edge Functionã‚’å‘¼ã³å‡ºã—ã¦AIç”Ÿæˆ
                const { data, error } = await window.supabase.functions.invoke('generate-application-document', {
                    body: {
                        applicationId: applicationId,
                        type: 'recommendation'
                    },
                    headers: {
                        'x-user-id': currentUser?.id || ''
                    }
                });

                if (error) throw error;
                if (!data.success) throw new Error(data.error);

                currentDocumentData = data.documentData;

                // æ¨è–¦çŠ¶ã‚’æ•´å½¢ã—ã¦è¡¨ç¤º
                const formattedText = formatRecommendationLetter(data.documentData);
                $('#recommendation-doc-full-text').val(formattedText);

                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                $('#recommendation-doc-generating').hide();
                $('#recommendation-doc-preview-content').show();

            } catch (error) {
                console.error('Recommendation generation error:', error);
                $('#recommendation-doc-generating').hide();
                $('#recommendation-doc-error-message').text(error.message || 'ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                $('#recommendation-doc-error').show();
            }
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        window.closeResumePreviewModal = function () {
            $('#resume-preview-modal').addClass('hidden').css('display', 'none');
            currentDocumentApplicationId = null;
            currentDocumentData = null;
        }

        window.closeRecommendationDocPreviewModal = function () {
            $('#recommendation-doc-preview-modal').addClass('hidden').css('display', 'none');
            currentDocumentApplicationId = null;
            currentDocumentData = null;
        }

        // å†ç”Ÿæˆ
        window.regenerateResume = async function () {
            if (currentDocumentApplicationId) {
                await openResumePreviewModal(currentDocumentApplicationId);
            }
        }

        window.regenerateRecommendationDoc = async function () {
            if (currentDocumentApplicationId) {
                await openRecommendationDocPreviewModal(currentDocumentApplicationId);
            }
        }

        // Wordå‡ºåŠ›
        window.downloadResumeWord = async function () {
            showLoading('Wordæ–‡æ›¸ã‚’ç”Ÿæˆä¸­...');

            try {
                // ç·¨é›†ã•ã‚ŒãŸå†…å®¹ã‚’å–å¾—
                const editedData = {
                    summary: $('#resume-summary').val(),
                    work_history_text: $('#resume-work-history').val(),
                    strengths_text: $('#resume-strengths').val(),
                    skills_text: $('#resume-skills').val(),
                    self_pr: $('#resume-self-pr').val(),
                    motivation: $('#resume-motivation').val()
                };

                // HTMLãƒ™ãƒ¼ã‚¹ã®Wordæ–‡æ›¸ã‚’ç”Ÿæˆï¼ˆç”»åƒã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’å†ç¾ï¼‰
                const today = new Date();
                const dateStr = `${today.getFullYear()}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥ç¾åœ¨`;

                const htmlContent = `
<!DOCTYPE html>
<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
<head>
    <meta charset='utf-8'>
    <title>è·å‹™çµŒæ­´æ›¸</title>
    <style>
        @page {
            size: A4;
            margin: 20mm;
        }
        body { 
            font-family: 'MS Gothic', 'MS Mincho', 'Meiryo', sans-serif; 
            font-size: 10.5pt;
            line-height: 1.6; 
            margin: 0;
            padding: 20px;
        }
        .header {
            position: relative;
            margin-bottom: 20px;
        }
        .title { 
            text-align: center; 
            font-size: 16pt; 
            font-weight: bold;
            letter-spacing: 8px;
            margin-bottom: 10px;
        }
        .date-name {
            text-align: right;
            font-size: 10pt;
            line-height: 1.8;
        }
        .section-title {
            font-size: 11pt;
            font-weight: bold;
            margin-top: 15px;
            margin-bottom: 8px;
            padding-left: 2px;
        }
        .section-title::before {
            content: 'â– ';
            margin-right: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 10pt;
        }
        th, td {
            border: 1px solid #000;
            padding: 6px 8px;
            vertical-align: top;
            line-height: 1.7;
        }
        th {
            background-color: #ffffff;
            font-weight: normal;
            text-align: left;
        }
        .work-history-table th {
            width: 15%;
        }
        .work-history-table td {
            width: 85%;
        }
        .skill-table th {
            width: 25%;
            font-weight: normal;
        }
        .skill-table td {
            width: 75%;
        }
        .content {
            white-space: pre-wrap;
            line-height: 1.7;
        }
        .subsection {
            font-weight: bold;
            margin-top: 8px;
            margin-bottom: 4px;
        }
        .indent {
            padding-left: 1em;
        }
        p {
            margin: 8px 0;
            line-height: 1.8;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">è·å‹™çµŒæ­´æ›¸</div>
        <div class="date-name">
            ${dateStr}<br>
            æ°åã€€${currentUser?.user_metadata?.full_name || ''}
        </div>
    </div>
    
    <div class="section-title">è·å‹™è¦ç´„</div>
    <p class="content">${editedData.summary.replace(/\n/g, '<br>')}</p>
    
    <div class="section-title">è·å‹™çµŒæ­´</div>
    <table class="work-history-table">
        <tr>
            <td colspan="2" class="content">${editedData.work_history_text.replace(/\n/g, '<br>')}</td>
        </tr>
    </table>
    
    <div class="section-title">PCã‚¹ã‚­ãƒ«</div>
    <table class="skill-table">
        ${editedData.skills_text.split('\n').filter(line => line.trim()).map(line => {
                    const parts = line.split(/[ï¼š:]/);
                    if (parts.length >= 2) {
                        return `<tr><th>${parts[0].trim()}</th><td>${parts.slice(1).join(':').trim()}</td></tr>`;
                    } else {
                        return `<tr><td colspan="2">${line}</td></tr>`;
                    }
                }).join('\n        ')}
    </table>
    
    <div class="section-title">è‡ªå·±PR</div>
    <p class="content">${editedData.self_pr.replace(/\n/g, '<br>')}</p>
    
    <div class="section-title">å¿—æœ›å‹•æ©Ÿ</div>
    <p class="content">${editedData.motivation.replace(/\n/g, '<br>')}</p>
    
    <div style="text-align: right; margin-top: 30px;">ä»¥ä¸Š</div>
</body>
</html>`;

                // Blobã‚’ä½œæˆã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const blob = new Blob(['\ufeff', htmlContent], {
                    type: 'application/msword'
                });

                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `è·å‹™çµŒæ­´æ›¸_${currentDocumentApplicationId}.doc`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                closeResumePreviewModal();

                alert('è·å‹™çµŒæ­´æ›¸ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ!');

            } catch (error) {
                console.error('Word generation error:', error);
                alert(`ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        window.downloadRecommendationDocWord = async function () {
            showLoading('Wordæ–‡æ›¸ã‚’ç”Ÿæˆä¸­...');

            try {
                const content = $('#recommendation-doc-full-text').val();

                // HTMLãƒ™ãƒ¼ã‚¹ã®Wordæ–‡æ›¸ã‚’ç”Ÿæˆ
                const htmlContent = `
<!DOCTYPE html>
<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
<head>
    <meta charset='utf-8'>
    <title>æ¨è–¦çŠ¶</title>
    <style>
        body { font-family: 'MS Gothic', 'Meiryo', sans-serif; line-height: 1.8; margin: 40px; }
        h1 { text-align: center; font-size: 24px; margin-bottom: 30px; }
        p { margin: 10px 0; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>æ¨è–¦çŠ¶</h1>
    <p>${content.replace(/\n/g, '<br>')}</p>
</body>
</html>`;

                // Blobã‚’ä½œæˆã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const blob = new Blob(['\ufeff', htmlContent], {
                    type: 'application/msword'
                });

                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `æ¨è–¦çŠ¶_${currentDocumentApplicationId}.doc`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                closeRecommendationDocPreviewModal();

                alert('æ¨è–¦çŠ¶ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ!');

            } catch (error) {
                console.error('Word generation error:', error);
                alert(`ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
        window.formatWorkHistory = function (workHistory) {
            if (!Array.isArray(workHistory)) return '';

            return workHistory.map((item, index) => {
                let text = `${index + 1}.${item.period || ''}\n`;
                text += `   ${item.company || ''} - ${item.position || ''}\n`;
                text += `   ${item.description || ''}\n`;
                if (item.skills_used && item.skills_used.length > 0) {
                    text += `   ä½¿ç”¨ã‚¹ã‚­ãƒ«: ${item.skills_used.join(', ')}\n`;
                }
                return text;
            }).join('\n');
        }

        window.formatList = function (items) {
            if (Array.isArray(items)) {
                return items.map((s, i) => `â€¢ ${s}`).join('\n');
            }
            return items || '';
        }

        window.formatSkills = function (skills) {
            if (!skills) return '';

            let text = '';
            if (skills.technical && Array.isArray(skills.technical)) {
                text += `æŠ€è¡“ã‚¹ã‚­ãƒ«: ${skills.technical.join(', ')}\n`;
            }
            if (skills.business && Array.isArray(skills.business)) {
                text += `ãƒ“ã‚¸ãƒã‚¹ã‚¹ã‚­ãƒ«: ${skills.business.join(', ')}\n`;
            }
            if (skills.certifications && Array.isArray(skills.certifications)) {
                text += `è³‡æ ¼: ${skills.certifications.join(', ')}`;
            }
            return text;
        }

        window.formatRecommendationLetter = function (data) {
            let text = `${data.date || new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' })}ç¾åœ¨\n\n`;
            text += `${data.recipient || 'æ¡ç”¨ã”æ‹…å½“è€…æ§˜'}\n\n`;
            text += `ä»¶å: ${data.subject || 'å€™è£œè€…æ¨è–¦ã®ä»¶'}\n\n`;
            text += `${data.greeting || 'æ‹å•“ æ™‚ä¸‹ã¾ã™ã¾ã™ã”æ¸…æ „ã®ã“ã¨ã¨ãŠæ…¶ã³ç”³ã—ä¸Šã’ã¾ã™ã€‚'}\n\n`;
            text += `${data.introduction || ''}\n\n`;

            if (data.candidate_overview) {
                text += `ã€å€™è£œè€…æ¦‚è¦ã€‘\n${data.candidate_overview}\n\n`;
            }

            if (data.match_points && Array.isArray(data.match_points)) {
                text += `ã€ãƒãƒƒãƒãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆã€‘\n`;
                data.match_points.forEach((point, index) => {
                    if (typeof point === 'object') {
                        text += `\n${index + 1}. ${point.title || ''} \n`;
                        text += `${point.description || ''} \n`;
                    } else {
                        text += `${index + 1}. ${point} \n`;
                    }
                });
                text += `\n`;
            }

            if (data.strengths && Array.isArray(data.strengths)) {
                text += `ã€å€™è£œè€…ã®å¼·ã¿ã€‘\n`;
                data.strengths.forEach((strength, index) => {
                    text += `${index + 1}. ${strength} \n`;
                });
                text += `\n`;
            }

            if (data.why_recommend) {
                text += `ã€æ¨è–¦ç†ç”±ã€‘\n${data.why_recommend} \n\n`;
            }

            text += `${data.closing || 'ä½•å’ã”æ¤œè¨ã®ã»ã©ã€ã‚ˆã‚ã—ããŠé¡˜ã„ç”³ã—ä¸Šã’ã¾ã™ã€‚'} \n\n`;
            text += `${data.signature || 'æ•¬å…·'} `;

            return text;
        }


        // æ¨è–¦æ–‡ã‚’ä¿å­˜
        window.saveRecommendation = async function () {
            if (!currentRecommendationAppId) return;

            const text = $('#recommendation-text').val();
            if (!text) {
                alert('æ¨è–¦æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            showLoading();
            try {
                if (!window.supabase) throw new Error('Supabase client not initialized');

                const { error } = await window.supabase
                    .from('applications')
                    .update({
                        recommendation_text: text,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentRecommendationAppId);

                if (error) throw error;

                alert('æ¨è–¦æ–‡ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                closeRecommendationModal();

                // ãƒªã‚¹ãƒˆã‚’æ›´æ–° (å­˜åœ¨ã™ã‚‹å ´åˆã®ã¿)
                if (typeof loadAdminApplicants === 'function') {
                    loadAdminApplicants();
                } else if (typeof loadApplications === 'function') {
                    loadApplications();
                }

            } catch (error) {
                console.error('Failed to save recommendation:', error);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error));
            } finally {
                hideLoading();
            }
        }

        // ========================
        // æ–°æ©Ÿèƒ½: ãŠæ°—ã«å…¥ã‚Šè¦‹é€ã‚Š & ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ¤œç´¢
        // ========================

        // ãŠã™ã™ã‚æ±‚äººã‚’è¦‹é€ã‚‹ï¼ˆæœ€ä¸‹éƒ¨ã¸ç§»å‹•ï¼†ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆï¼‰
        // ãŠã™ã™ã‚æ±‚äººã‚’è¦‹é€ã‚‹ï¼ˆæœ€ä¸‹éƒ¨ã¸ç§»å‹•ï¼†ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆï¼‰
        window.dismissRecommendation = function (jobId) {
            if (!window.currentUser) return;

            // è¦–è¦šçš„ãªå³æ™‚ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚«ãƒ¼ãƒ‰ã‚’ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆï¼‰
            const card = $(`.rec-card[data-job-id="${jobId}"]`);
            if (card.length > 0) {
                card.css({
                    'opacity': '0.3',
                    'filter': 'grayscale(100%)',
                    'pointer-events': 'none',
                    'transition': 'all 0.4s ease'
                });
            }

            const key = `dismissed_recs_${window.currentUser.id}`;
            let dismissed = JSON.parse(localStorage.getItem(key) || '[]');

            if (!dismissed.includes(jobId)) {
                dismissed.push(jobId);
                localStorage.setItem(key, JSON.stringify(dismissed));

                // å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†æç”»ï¼ˆã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆã‚’è¦‹ã›ã‚‹ãŸã‚ï¼‰
                setTimeout(() => {
                    if (typeof renderRecommendations === 'function') {
                        renderRecommendations();
                    }
                }, 400);
            }
        }

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ¡ä»¶ã§æ¤œç´¢
        window.searchByProfile = async function () {
            const user = (typeof currentUser !== 'undefined' ? currentUser : window.currentUser);
            if (!user || user.role !== 'candidate') {
                console.warn('searchByProfile: Invalid user or role', user);
                return;
            }

            if (window.showLoading) window.showLoading();

            try {
                // æœ€æ–°ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’å–å¾— (currentUserãŒå¤ã„å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚)
                const { data: profileData, error: profileError } = await window.supabase
                    .from('candidate_profiles')
                    .select('*')
                    .eq('user_id', user.id)
                    .maybeSingle();

                if (profileError) throw profileError;

                // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒãªã„å ´åˆã¯è­¦å‘Š
                if (!profileData) {
                    alert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€æ¡ä»¶ã‚’è‡ªå‹•ã‚»ãƒƒãƒˆã§ãã¾ã›ã‚“ã€‚å…ˆã«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’ãƒãƒ¼ã‚¸
                const fullUser = { ...user, ...profileData };

                // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾— (IDã¨Labelã®å¯¾å¿œãŒå¿…è¦ãªãŸã‚)
                const { data: masters } = await window.supabase
                    .from('master_data')
                    .select('type, label, value, organization_id')
                    .in('type', ['job_category', 'industry_category', 'employment_type'])
                    .eq('is_active', true);

                // è‡ªç¤¾ã¾ãŸã¯å…±é€šãƒã‚¹ã‚¿
                const validMasters = masters ? masters.filter(m =>
                    m.organization_id === null || m.organization_id === user.organization_id
                ) : [];

                const mapToLabel = (inputStr, type) => {
                    if (inputStr === null || inputStr === undefined || inputStr === '') return [];

                    // JSONé…åˆ—ã€ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šæ–‡å­—åˆ—ã€ã‚ã‚‹ã„ã¯å˜ä¸€ã®å€¤ã‚’å‡¦ç†
                    let inputs = [];
                    if (Array.isArray(inputStr)) {
                        inputs = inputStr;
                    } else if (typeof inputStr === 'string') {
                        if (inputStr.startsWith('[') && inputStr.endsWith(']')) {
                            try { inputs = JSON.parse(inputStr); } catch (e) { inputs = [inputStr]; }
                        } else {
                            inputs = inputStr.split(',').map(s => s.trim()).filter(Boolean);
                        }
                    } else {
                        inputs = [inputStr];
                    }

                    const typeMasters = validMasters.filter(m => m.type === type);

                    return inputs.map(val => {
                        // value (ID) ã§æ¤œç´¢ (ç·©ã„æ¯”è¼ƒ)
                        const byId = typeMasters.find(m => m.value == val);
                        if (byId) return byId.label;

                        // label ã§æ¤œç´¢
                        const byLabel = typeMasters.find(m => m.label == val);
                        if (byLabel) return byLabel.label;

                        // ãƒãƒƒãƒã—ãªã‘ã‚Œã°ãã®ã¾ã¾è¿”ã™
                        return val;
                    });
                };

                // æœ€ä½å¹´åã®æ•´å½¢
                let salaryMin = '';
                if (fullUser.desired_salary) {
                    let salaryVal = fullUser.desired_salary;
                    // æ–‡å­—åˆ—ãªã‚‰æ•°å€¤ã®ã¿æŠ½å‡º
                    if (typeof salaryVal === 'string') {
                        salaryVal = parseInt(salaryVal.replace(/[^0-9]/g, '')) || 0;
                    }
                    // 1ä¸‡å€ï¼ˆä¾‹: 500ä¸‡ï¼‰ä»¥ä¸Šãªã‚‰1ä¸‡ã§å‰²ã‚‹
                    if (salaryVal >= 10000) {
                        salaryMin = Math.floor(salaryVal / 10000);
                    } else {
                        salaryMin = salaryVal;
                    }
                }

                const filters = {
                    jobCategory: mapToLabel(fullUser.desired_job_type, 'job_category'),
                    industryCategory: mapToLabel(fullUser.desired_industry, 'industry_category'),
                    prefecture: fullUser.desired_location ?
                        (Array.isArray(fullUser.desired_location) ? fullUser.desired_location :
                            String(fullUser.desired_location).startsWith('[') ? JSON.parse(fullUser.desired_location) :
                                String(fullUser.desired_location).split(/[,ã€]/).map(s => s.trim()))
                        : [],
                    employmentType: mapToLabel(fullUser.desired_employment_type, 'employment_type'),
                    salaryMin: salaryMin,
                    jobExperienceOk: !!fullUser.desired_job_experience_ok,
                    industryExperienceOk: !!fullUser.desired_industry_experience_ok,
                    isRemote: false // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã«é …ç›®ãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                };

                console.log('Searching by profile (mapped):', filters);

                // æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š
                if (window.applySearchFilters) {
                    window.applySearchFilters(filters);
                } else if (typeof applySearchFilters === 'function') {
                    applySearchFilters(filters);
                }

                // æ¤œç´¢å®Ÿè¡Œ
                if (typeof searchJobsImmediate === 'function') {
                    searchJobsImmediate();
                } else if (typeof loadJobs === 'function') {
                    loadJobs(filters);
                }

            } catch (e) {
                console.error('Search by profile error:', e);
                alert('æ¤œç´¢æ¡ä»¶ã®é©ç”¨ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e.message || e));
            } finally {
                if (window.hideLoading) window.hideLoading();
            }
        }

        /* ============================================================ */
        /*  Scout Management & Specific Job Scout Generation Logic      */
        /* ============================================================ */

        window.loadScoutManagement = async function () {
            if (!currentUser) return;
            const container = $('#scout-management-list');
            container.html('<div class="text-center py-12"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto"></div></div>');

            try {
                // 1. çµ„ç¹”è¨­å®šã®å–å¾—
                const { data: orgData } = await supabase
                    .from('organizations')
                    .select('settings')
                    .eq('id', currentUser.organization_id)
                    .single();
                const visibility = orgData?.settings?.scout_history_visibility || 'all';

                // 2. çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®å–å¾— (ã‚¹ã‚«ã‚¦ãƒˆé€ä¿¡æ•°: sent/replied/interview/hired/rejected)
                // Note: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ 'generated' (ä¸‹æ›¸ã) ã¯é™¤å¤–ã™ã‚‹ã®ãŒä¸€èˆ¬çš„ã ãŒã€å±¥æ­´ã¨ã—ã¦å«ã‚ã¦ã‚‚è‰¯ã„ã€‚ã“ã“ã§ã¯ 'generated' ä»¥å¤–ã‚’ã‚«ã‚¦ãƒ³ãƒˆã¨ã™ã‚‹ã‹ã€å…¨éƒ¨å«ã‚€ã‹ã€‚
                // ä¸€èˆ¬çš„ã«ã€Œå±¥æ­´ã€ã¯é€ä¿¡æ¸ˆã¿ã‚’æŒ‡ã™ã“ã¨ãŒå¤šã„ã€‚
                const validStatuses = ['sent', 'replied', 'interview', 'rejected', 'hired'];

                // å€‹äºº
                const { count: myCount } = await supabase
                    .from('scout_messages')
                    .select('*', { count: 'exact', head: true })
                    .eq('organization_id', currentUser.organization_id)
                    .eq('created_by', currentUser.id)
                    .in('status', validStatuses);

                // å…¨ä½“
                const { count: orgCount } = await supabase
                    .from('scout_messages')
                    .select('*', { count: 'exact', head: true })
                    .eq('organization_id', currentUser.organization_id)
                    .in('status', validStatuses);


                // 3. å€™è£œè€…ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
                const { data: candidates, error: cError } = await supabase
                    .from('external_candidates')
                    .select('*')
                    .eq('organization_id', currentUser.organization_id)
                    .order('created_at', { ascending: false });

                if (cError) {
                    if (cError.code === '42P01') {
                        container.html('<div class="text-center py-8 text-gray-500">æ©Ÿèƒ½æº–å‚™ä¸­ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«æœªä½œæˆï¼‰</div>');
                        return;
                    }
                    throw cError;
                }

                // 4. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
                let messages = [];
                // Check if candidates exist
                if (candidates && candidates.length > 0) {
                    const candidateIds = candidates.map(c => c.id);
                    try {
                        let msgQuery = supabase
                            .from('scout_messages')
                            .select('*, jobs(title, companies(name))')
                            .in('external_candidate_id', candidateIds)
                            .order('created_at', { ascending: false });

                        // Visibilityåˆ¶å¾¡
                        if (visibility === 'personal') {
                            msgQuery = msgQuery.eq('created_by', currentUser.id);
                        }

                        const { data: msgs, error: mError } = await msgQuery;
                        if (!mError) {
                            messages = msgs;

                            // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®å–å¾— (ä½œæˆè€…è¡¨ç¤ºç”¨)
                            if (messages.length > 0) {
                                const userIds = [...new Set(messages.map(m => m.created_by).filter(id => id))];
                                if (userIds.length > 0) {
                                    const { data: users } = await supabase
                                        .from('users')
                                        .select('id, name')
                                        .in('id', userIds);

                                    const userMap = {};
                                    if (users) users.forEach(u => userMap[u.id] = u.name);

                                    messages.forEach(m => {
                                        m.sender_name = userMap[m.created_by] || '-';
                                    });
                                }
                            }
                        }
                    } catch (e) { console.warn('scout_messages fetch failed', e); }
                }

                // 5. çµ±è¨ˆUIã®è¡¨ç¤ºã¨ãƒªã‚¹ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                const statsHtml = `
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-indigo-50 rounded-lg p-4 text-center border border-indigo-100">
                            <p class="text-xs text-gray-500 font-bold mb-1">è‡ªåˆ†ã®ã‚¹ã‚«ã‚¦ãƒˆé€ä¿¡æ•°</p>
                            <p class="text-2xl font-bold text-indigo-700">${myCount || 0}<span class="text-sm font-normal text-gray-500 ml-1">ä»¶</span></p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 text-center border border-gray-200">
                            <p class="text-xs text-gray-500 font-bold mb-1">çµ„ç¹”å…¨ä½“ã®ã‚¹ã‚«ã‚¦ãƒˆé€ä¿¡æ•°</p>
                            <p class="text-2xl font-bold text-gray-700">${orgCount || 0}<span class="text-sm font-normal text-gray-500 ml-1">ä»¶</span></p>
                        </div>
                    </div>
                `;

                if (!candidates || candidates.length === 0) {
                    container.html(statsHtml + '<div class="text-center py-8 text-gray-500">ç™»éŒ²ã•ã‚ŒãŸå€™è£œè€…ã¯ã„ã¾ã›ã‚“</div>');
                    return;
                }

                container.html(statsHtml + '<div class="space-y-4" id="scout-list-content"></div>');

                // ãƒªã‚¹ãƒˆã®ä¸­èº«ã‚’åˆ¥ã®é–¢æ•°ã§æç”»ã™ã‚‹ãªã©ã€ã‚ã‚‹ã„ã¯ã“ã“ã§ç›´æ¥å‘¼ã³å‡ºã—
                // æ—¢å­˜ã® renderScoutManagementList ã¯ container.html() ã‚’ä¸Šæ›¸ãã—ã¦ã—ã¾ã†ã®ã§ã€
                // container ã®ä¸­ã® div ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã™ã‚‹ã‚ˆã†ã«èª¿æ•´ãŒå¿…è¦ã€‚
                // ã—ã‹ã— renderScoutManagementList ã¯ windowé–¢æ•°ã¨ã—ã¦å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã€‚
                // ã“ã“ã§å‘¼ã³å‡ºã™éš›ã«ã€targetã‚’å¤‰ãˆã‚‹ã‹ã€renderScoutManagementList ã‚’ä¿®æ­£ã™ã‚‹ã€‚
                // ä¿®æ­£ã™ã‚‹ã®ãŒæ—©ã„ã€‚

                // æ—¢å­˜é–¢æ•°ã‚’å‘¼ã³å‡ºã™ãŒã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ Element ID ãŒå›ºå®šã•ã‚Œã¦ã„ã‚‹ ('scout-management-list')ã€‚
                // ã“ã‚Œã ã¨ STATS ãŒæ¶ˆãˆã¦ã—ã¾ã†ã€‚
                // è§£æ±ºç­–: renderScoutManagementList ã«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚³ãƒ³ãƒ†ãƒŠã‚’æ¸¡ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€ã‚‚ã—ãã¯
                // renderScoutManagementList ã®ä¸­èº«ã‚’ã“ã“ã«ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–/ãƒªãƒ•ã‚¡ã‚¯ã‚¿ã™ã‚‹ã€‚
                // ã“ã“ã§ã¯å®‰ç›´ã«ã€renderScoutManagementList ã‚’å‘¼ã³å‡ºã—ãŸå¾Œã§ã€STATS ã‚’ prepend ã™ã‚‹ã®ã¯ã¡ã‚‰ã¤ãã€‚
                // renderScoutManagementList ã‚’ä¿®æ­£ã—ã‚ˆã†ã€‚

                renderScoutManagementList(candidates, messages || [], '#scout-list-content');

            } catch (e) {
                console.error('Load Scout Management Error:', e);
                container.html('<div class="text-center py-8 text-red-500">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>');
            }
        };

        window.renderScoutManagementList = function (candidates, messages, targetSelector = '#scout-management-list') {
            const container = $(targetSelector);

            if (!candidates || candidates.length === 0) {
                container.html('<div class="text-center py-8 text-gray-500">ç™»éŒ²ã•ã‚ŒãŸå€™è£œè€…ã¯ã„ã¾ã›ã‚“</div>');
                return;
            }

            const rows = candidates.map(c => {
                const cMessages = messages.filter(m => m.external_candidate_id === c.id);
                const lastMsg = cMessages.length > 0 ? cMessages[0] : null;
                const currentStatus = lastMsg ? lastMsg.status : (c.status || 'new');

                const jobTitle = lastMsg?.jobs?.title || '-';
                const companyName = lastMsg?.jobs?.companies?.name || '';
                const lastJobTitle = lastMsg ? (companyName ? `${companyName} ${jobTitle} ` : jobTitle) : '-';
                const lastScoutDate = lastMsg ? new Date(lastMsg.created_at).toLocaleDateString() : '-';
                const senderName = lastMsg ? (lastMsg.sender_name || 'ä¸æ˜') : '-';

                // Status Dropdown
                const statusOptions = [
                    { val: 'new', label: 'æ–°è¦' },
                    { val: 'generated', label: 'æ–‡é¢ä½œæˆæ¸ˆ' },
                    { val: 'sent', label: 'é€ä¿¡æ¸ˆ' },
                    { val: 'replied', label: 'è¿”ä¿¡ã‚ã‚Š' },
                    { val: 'interview', label: 'é¢è«‡è¨­å®š' },
                    { val: 'rejected', label: 'è¾é€€/ä¸æ¡ç”¨' },
                    { val: 'hired', label: 'æ¡ç”¨æ±ºå®š' }
                ];

                const statusChangeHandler = lastMsg
                    ? `onchange="updateScoutStatus('${lastMsg.id}', this.value)"`
                    : `disabled title="ã‚¹ã‚«ã‚¦ãƒˆã‚’ä½œæˆã™ã‚‹ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¤‰æ›´ã§ãã¾ã™"`;

                const statusSelect = `
                    <select ${statusChangeHandler} class="text-xs border border-gray-300 rounded px-2 py-1 bg-white text-gray-700 w-28">
                    ${statusOptions.map(opt => `<option value="${opt.val}" ${currentStatus === opt.val ? 'selected' : ''}>${opt.label}</option>`).join('')}
                    </select>
                `;

                // Title display
                const displayTitle = c.custom_title || 'åç§°æœªè¨­å®š';
                const subText = c.custom_title
                    ? (c.parsed_data?.candidate_summary ? c.parsed_data.candidate_summary.substring(0, 30) + '...' : (c.profile_text || '').substring(0, 30) + '...')
                    : (c.profile_text || '').substring(0, 30) + '...';

                return `
                    <tr>
                        <td class="px-6 py-4">
                            <div class="text-sm font-bold text-gray-900 truncate" style="max-width: 250px;" title="${c.profile_text}">
                                ${displayTitle}
                            </div>
                            <div class="text-xs text-gray-500">
                                ${subText}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${new Date(c.created_at).toLocaleDateString()}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            ${senderName}
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900 truncate" style="max-width: 200px;" title="${lastJobTitle}">${lastJobTitle}</div>
                            <div class="text-xs text-gray-500">${lastScoutDate}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${statusSelect}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="viewExternalCandidateDetail('${c.id}')" class="text-indigo-600 hover:text-indigo-900 bg-indigo-50 hover:bg-indigo-100 px-3 py-1 rounded transition">
                                <i class="fas fa-file-alt mr-1"></i>è©³ç´°ãƒ»å±¥æ­´
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            const tableHtml = `
                    <div class="overflow-x-auto border border-gray-200 rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å€™è£œè€… / ç®¡ç†ID</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç™»éŒ²æ—¥</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å®Ÿè¡Œè€…</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç›´è¿‘ã‚¹ã‚«ã‚¦ãƒˆ</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${rows}
                        </tbody>
                    </table>
                </div>
                `;

            container.html(tableHtml);
        }

        window.viewExternalCandidateDetail = async function (candidateId) {
            try {
                const { data: candidate, error } = await supabase
                    .from('external_candidates')
                    .select('*')
                    .eq('id', candidateId)
                    .single();

                if (error) throw error;

                if (!candidate.parsed_data) {
                    alert("è§£æãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
                    return;
                }

                window.currentExternalCandidateId = candidate.id;

                switchProfileAnalysisTab('new');

                if (candidate.profile_text) {
                    $('#profile-text-input').val(candidate.profile_text);
                }

                // Set custom title
                if (candidate.custom_title) {
                    $('#candidate-title-input').val(candidate.custom_title);
                } else {
                    $('#candidate-title-input').val('');
                }

                renderAnalysisResults(candidate.parsed_data);

                document.getElementById('analysis-results').scrollIntoView({ behavior: 'smooth' });

            } catch (e) {
                console.error('View detail error:', e);
                alert("è©³ç´°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
            }
        }

        window.updateScoutStatus = async function (scoutId, newStatus) {
            if (!confirm(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œ${newStatus}ã€ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`)) {
                loadScoutManagement(); // Revert selection UI by reloading
                return;
            }

            try {
                // Update scout_messages
                const { error: msgError } = await supabase
                    .from('scout_messages')
                    .update({ status: newStatus, updated_at: new Date().toISOString() })
                    .eq('id', scoutId);

                if (msgError) throw msgError;

                // Also update external_candidates status for consistency if needed
                // For now, mainly tracking scout message status.

                alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                loadScoutManagement(); // Reload list
            } catch (e) {
                console.error('Status update failed:', e);
                alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        window.fetchActiveJobs = async function () {
            const { data } = await supabase
                .from('jobs')
                .select('id, title')
                .eq('organization_id', currentUser.organization_id)
                .eq('status', 'active')
                .order('created_at', { ascending: false })
                .limit(20);
            return data;
        }

        // Job Selector Modal Logic
        let scoutJobSelectorInitialized = false;

        window.openJobSelectorForScout = function () {
            $('#job-selection-modal').removeClass('hidden');

            // Initialize Prefectures if needed
            if (!scoutJobSelectorInitialized && window.prefectures) {
                const select = $('#selector-search-prefecture');
                window.prefectures.forEach(p => {
                    select.append(`< option value = "${p}" > ${p}</option > `);
                });
                scoutJobSelectorInitialized = true;
            }

            // Reset results if empty
            if ($('#selector-job-results').children().length === 0) {
                $('#selector-job-results').html('<div class="text-center py-8 text-gray-400">æ¤œç´¢æ¡ä»¶ã‚’å…¥åŠ›ã—ã¦æ¤œç´¢ã—ã¦ãã ã•ã„</div>');
            }
        };

        window.closeJobSelectorForScout = function () {
            $('#job-selection-modal').addClass('hidden');
        };

        window.searchJobsForScout = async function () {
            if (!currentUser) return;

            const company = $('#selector-search-company').val().trim();
            const prefecture = $('#selector-search-prefecture').val();
            const keyword = $('#selector-search-keyword').val().trim();

            const container = $('#selector-job-results');
            container.html('<div class="text-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto"></div></div>');

            try {
                let query = supabase
                    .from('jobs')
                    .select('id, title, company, location, description, updated_at')
                    .eq('organization_id', currentUser.organization_id)
                    .eq('status', 'active');

                if (company) {
                    query = query.ilike('company', `%${company}%`);
                }

                if (prefecture) {
                    query = query.ilike('location', `%${prefecture}%`);
                }

                if (keyword) {
                    // search title and description
                    query = query.or(`title.ilike.%${keyword}%, description.ilike.%${keyword}%`);
                }

                query = query.order('updated_at', { ascending: false }).limit(50);

                const { data, error } = await query;

                if (error) throw error;

                if (!data || data.length === 0) {
                    container.html('<div class="text-center py-8 text-gray-500">æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹æ±‚äººã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>');
                    return;
                }

                const html = data.map(job => `
                <div class="bg-gray-50 hover:bg-gray-100 p-3 rounded border border-gray-200 flex justify-between items-center transition">
                        <div class="flex-1 min-w-0 mr-4">
                            <h5 class="font-bold text-gray-800 truncate">${job.title}</h5>
                            <p class="text-xs text-gray-600 truncate">
                                <i class="fas fa-building mr-1"></i>${job.company || 'ä¼šç¤¾åãªã—'}
                                <span class="mx-2 text-gray-300">|</span>
                                <i class="fas fa-map-marker-alt mr-1"></i>${job.location || 'å‹¤å‹™åœ°ãªã—'}
                            </p>
                            <p class="text-xs text-gray-400 mt-1 truncate">${(job.description || '').substring(0, 50)}...</p>
                        </div>
                        <button onclick="selectJobForScout('${job.id}')" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold py-2 px-4 rounded whitespace-nowrap">
                            é¸æŠ
                        </button>
                    </div>
                `).join('');

                container.html(html);

            } catch (e) {
                console.error('Job search error:', e);
                container.html('<div class="text-center py-8 text-red-500">æ¤œç´¢ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>');
            }
        }

        window.selectJobForScout = async function (jobId) {
            // Close modal
            closeJobSelectorForScout();

            // Fetch full job details (reuse existing query or just simple fetch)
            // generateScoutForSelectedJob expects {id, title} at minimum
            try {
                const { data: job, error } = await supabase.from('jobs').select('id, title').eq('id', jobId).single();
                if (error || !job) {
                    alert('æ±‚äººæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }
                generateScoutForSelectedJob(job);
            } catch (e) {
                console.error(e);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        window.generateScoutForSelectedJob = async function (job) {
            const instruction = `ä»¥ä¸‹ã®ç‰¹å®šã®æ±‚äººã«å¯¾ã™ã‚‹ã‚¹ã‚«ã‚¦ãƒˆæ–‡é¢ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚\n(ä»–ã®æ±‚äººã¯ç„¡è¦–ã—ã¦ã€ã“ã®æ±‚äººã«çµã£ã¦ææ¡ˆã—ã¦ãã ã•ã„) \n\nã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ±‚äººæƒ…å ±ã€‘\næ±‚äººå: ${job.title} \næ±‚äººID: ${job.id} `;
            $('#scout-instruction-text').val(instruction);
            analyzeProfile(instruction, job.id);
        }
        window.resetProfileAnalysis = function () {
            uploadedFiles = [];
            $('#profile-file-input').val('');
            $('#file-list').empty();
            $('#profile-text-input').val('');
            $('#candidate-title-input').val(''); // Clear title
            $('#scout-instruction-text').val('');
            $('#scout-instruction-container').addClass('hidden');
            $('#analysis-placeholder').removeClass('hidden');
            $('#analysis-loading').addClass('hidden');
            $('#analysis-results').addClass('hidden');
            $('#suggested-jobs-container').empty();
            window.currentAnalysisHistoryId = null;
            window.currentExternalCandidateId = null; // Clear candidate ID
            if ($('#current-analysis-history-id').length) $('#current-analysis-history-id').val('');
        }

        /* ... existing analyzeProfile ... */

        window.saveExternalCandidateProfile = async function (analysisData) {
            try {
                const customTitle = $('#candidate-title-input').val().trim();
                const payload = {
                    organization_id: currentUser.organization_id,
                    profile_text: analysisData.candidate_summary,
                    parsed_data: analysisData,
                    status: 'new',
                    custom_title: customTitle || null,
                    updated_at: new Date().toISOString()
                };

                // DEBUG: Check payload
                console.log('Saving External Candidate. Payload:', payload);
                console.log('Current User Org ID:', currentUser?.organization_id);
                if (!currentUser?.organization_id) {
                    alert('ã‚¨ãƒ©ãƒ¼: çµ„ç¹”IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                // DEBUG: Check RLS Function result
                try {
                    const { data: dbOrgId, error: rpcError } = await supabase.rpc('get_my_org_id');
                    console.log('RPC get_my_org_id result:', dbOrgId, rpcError);

                    if (dbOrgId !== currentUser.organization_id) {
                        alert(`ã€é‡è¦ã€‘IDä¸ä¸€è‡´æ¤œå‡º\nDBä¸Šã®çµ„ç¹”ID: ${dbOrgId} \nã‚¢ãƒ—ãƒªä¸Šã®çµ„ç¹”ID: ${currentUser.organization_id} \n\nã“ã‚ŒãŒåŸå› ã§ä¿å­˜ãŒæ‹’å¦ã•ã‚Œã¦ã„ã¾ã™ã€‚`);
                    } else {
                        console.log('Org IDs match confirmed.');
                    }
                } catch (e) {
                    console.error('RPC Error:', e);
                }

                let resultData, resultError;

                if (window.currentExternalCandidateId) {
                    // Update existing
                    const { data, error } = await supabase
                        .from('external_candidates')
                        .update(payload)
                        .eq('id', window.currentExternalCandidateId)
                        .select();
                    resultData = data;
                    resultError = error;
                } else {
                    // Insert new
                    const { data, error } = await supabase
                        .from('external_candidates')
                        .insert(payload)
                        .select();
                    resultData = data;
                    resultError = error;
                }

                if (resultData && resultData[0]) {
                    window.currentExternalCandidateId = resultData[0].id; // Ensure ID is set
                }

                // ã‚¿ãƒ–ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚‰ãƒªãƒ­ãƒ¼ãƒ‰
                if (!$('#profile-scout_management-tab-content').hasClass('hidden')) {
                    loadScoutManagement();
                }
            } catch (e) {
                console.error('Failed to save to external_candidates', e);
            }
        }

        window.saveScoutMessage = async function (btn, jobId) {
            const container = $(btn).closest('.bg-white'); // Card container
            const subject = (container.find('.scout-subject-input').val() || container.find('p:contains("ä»¶å:")').text().replace('ä»¶å: ', '') || '').trim();
            const body = (container.find('.scout-body-textarea').val() || container.find('.scout-body-text').text() || '').trim();

            if (!subject || !body) {
                alert('ã‚¹ã‚«ã‚¦ãƒˆæ–‡é¢ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                return;
            }

            if (!confirm('ã“ã®ã‚¹ã‚«ã‚¦ãƒˆæ–‡é¢ã‚’ã€Œé€ä¿¡æ¸ˆã¿ã€ã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ')) return;

            if (!window.currentExternalCandidateId) {
                // Not yet saved to DB. Save profile first.
                if (window.analysisResultsData && window.saveExternalCandidateProfile) {
                    try {
                        await window.saveExternalCandidateProfile(window.analysisResultsData);
                    } catch (e) {
                        console.error('Failed to save profile before scout:', e);
                    }
                }
            }

            if (!window.currentExternalCandidateId) {
                alert("å€™è£œè€…æƒ…å ±ã®ä¿å­˜ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚\nDBã¸ã®ä¿å­˜ãŒå¤±æ•—ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\n(migration_scout_features.sqlãŒæ­£ã—ãå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„)");
                return;
            }

            try {
                // Insert into scout_messages
                const { error } = await supabase.from('scout_messages').insert({
                    organization_id: currentUser.organization_id,
                    external_candidate_id: window.currentExternalCandidateId,
                    job_id: jobId,
                    subject: subject,
                    message_body: body,
                    status: 'sent',
                    sent_at: new Date().toISOString(),
                    created_by: currentUser.id
                });

                if (error) throw error;

                alert('ã‚¹ã‚«ã‚¦ãƒˆã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
                $(btn).removeClass('text-gray-400').addClass('text-green-600').text('é€ä¿¡æ¸ˆ').prop('disabled', true);

                if (!$('#profile-scout_management-tab-content').hasClass('hidden')) {
                    loadScoutManagement();
                }

            } catch (e) {
                console.error('Save scout error:', e);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        /* ---------------------------------------------------- */
        /*  Analytics Logic                                     */
        /* ---------------------------------------------------- */

        window.loadScoutAnalytics = async function () {
            if (!currentUser) return;
            const userStatsContainer = $('#analytics-user-stats');
            const orgStatsContainer = $('#analytics-org-stats');
            const detailsContainer = $('#analytics-details-container');

            try {
                // Fetch ALL messages for the organization
                // We need status and created_by
                const { data: messages, error } = await supabase
                    .from('scout_messages')
                    .select('id, status, created_by, created_at')
                    .eq('organization_id', currentUser.organization_id);

                if (error) throw error;

                if (!messages || messages.length === 0) {
                    userStatsContainer.html('<div class="col-span-2 text-center text-gray-500">ãƒ‡ãƒ¼ã‚¿ãªã—</div>');
                    orgStatsContainer.html('<div class="col-span-2 text-center text-gray-500">ãƒ‡ãƒ¼ã‚¿ãªã—</div>');
                    return;
                }

                // --- Calculate Stats ---
                const calculateStats = (msgs) => {
                    const totalSent = msgs.filter(m => ['sent', 'replied', 'interview', 'rejected', 'hired'].includes(m.status)).length;
                    const replied = msgs.filter(m => ['replied', 'interview', 'rejected', 'hired'].includes(m.status)).length;
                    const interview = msgs.filter(m => ['interview', 'hired'].includes(m.status)).length;

                    const replyRate = totalSent > 0 ? ((replied / totalSent) * 100).toFixed(1) : '0.0';
                    const interviewRate = totalSent > 0 ? ((interview / totalSent) * 100).toFixed(1) : '0.0';

                    return { totalSent, replied, interview, replyRate, interviewRate };
                };

                const orgStats = calculateStats(messages);
                const userData = messages.filter(m => m.created_by === currentUser.id);
                const userStats = calculateStats(userData);

                // --- Render Stats ---
                const renderStatItem = (label, value, unit = '', subText = '') => `
                <div class="bg-indigo-50 rounded p-3 text-center">
                        <div class="text-xs text-gray-500 font-bold mb-1">${label}</div>
                        <div class="text-2xl font-bold text-indigo-700">${value}<span class="text-sm font-normal text-gray-600 ml-1">${unit}</span></div>
                        ${subText ? `<div class="text-xs text-gray-400 mt-1">${subText}</div>` : ''}
                    </div>
                `;

                orgStatsContainer.html(`
                    ${renderStatItem('ç·é€ä¿¡æ•°', orgStats.totalSent, 'ä»¶')}
                    ${renderStatItem('è¿”ä¿¡æ•°', orgStats.replied, 'ä»¶', `è¿”ä¿¡ç‡: ${orgStats.replyRate}%`)}
                    ${renderStatItem('é¢è«‡è¨­å®šæ•°', orgStats.interview, 'ä»¶', `é¢è«‡ç‡: ${orgStats.interviewRate}%`)}
            `);

                userStatsContainer.html(`
                    ${renderStatItem('ç·é€ä¿¡æ•°', userStats.totalSent, 'ä»¶')}
                    ${renderStatItem('è¿”ä¿¡æ•°', userStats.replied, 'ä»¶', `è¿”ä¿¡ç‡: ${userStats.replyRate}%`)}
                    ${renderStatItem('é¢è«‡è¨­å®šæ•°', userStats.interview, 'ä»¶', `é¢è«‡ç‡: ${userStats.interviewRate}%`)}
            `);

                // --- Render Details Table (Org Wide) ---
                // Shows breakdown by status
                const statuses = ['sent', 'replied', 'interview', 'rejected', 'hired'];
                const statusLabels = { sent: 'é€ä¿¡æ¸ˆ(æœªèª­/æœªè¿”ä¿¡)', replied: 'è¿”ä¿¡ã‚ã‚Š', interview: 'é¢è«‡è¨­å®š', rejected: 'è¾é€€/ä¸æ¡ç”¨', hired: 'æ¡ç”¨æ±ºå®š' };

                const rows = statuses.map(s => {
                    const count = messages.filter(m => m.status === s).length;
                    const rate = orgStats.totalSent > 0 ? ((count / orgStats.totalSent) * 100).toFixed(1) : '0.0';
                    return `
                <tr>
                            <td class="px-6 py-4 text-sm text-gray-900">${statusLabels[s]}</td>
                            <td class="px-6 py-4 text-sm text-gray-900 text-right">${count} ä»¶</td>
                            <td class="px-6 py-4 text-sm text-gray-500 text-right">${rate} %</td>
                        </tr>
                `;
                }).join('');

                detailsContainer.html(`
                <table class="min-w-full divide-y divide-gray-200 border border-gray-200 rounded">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">ä»¶æ•°</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">æ§‹æˆæ¯”</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${rows}
                        </tbody>
                    </table>
                `);

            } catch (e) {
                console.error("Analytics Error:", e);
                userStatsContainer.html('<p class="text-red-500">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>');
            }
        }
        // ========================
        // Admin Settings
        // ========================
        window.loadAdminSettings = async function () {
            if (!currentUser) return;

            try {
                // çµ„ç¹”æƒ…å ±ã‚’å–å¾—
                const { data: org, error } = await supabase
                    .from('organizations')
                    .select('settings')
                    .eq('id', currentUser.organization_id)
                    .single();

                if (error) throw error;

                // è¨­å®šå€¤ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
                const settings = org.settings || {};
                const visibility = settings.analysis_history_visibility || 'all';
                const scoutVisibility = settings.scout_history_visibility || 'all';

                $('input[name="setting-history-visibility"][value="' + visibility + '"]').prop('checked', true);
                $('input[name="setting-scout-visibility"][value="' + scoutVisibility + '"]').prop('checked', true);

            } catch (error) {
                console.error('Load admin settings error:', error);
                alert('è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        };

        window.saveAdminSettings = async function () {
            if (!currentUser) return;

            if (!confirm('è¨­å®šã‚’ä¿å­˜ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;

            try {
                // 1. ç¾åœ¨ã®è¨­å®šã‚’å–å¾—ï¼ˆãƒãƒ¼ã‚¸ã™ã‚‹ãŸã‚ï¼‰
                const { data: currentOrg, error: fetchError } = await supabase
                    .from('organizations')
                    .select('settings')
                    .eq('id', currentUser.organization_id)
                    .single();

                if (fetchError) throw fetchError;

                let newSettings = currentOrg.settings || {};

                // 2. ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å€¤ã‚’å–å¾—ã—ã¦æ›´æ–°
                const visibility = $('input[name="setting-history-visibility"]:checked').val();
                const scoutVisibility = $('input[name="setting-scout-visibility"]:checked').val();

                newSettings.analysis_history_visibility = visibility;
                newSettings.scout_history_visibility = scoutVisibility;

                // 3. ä¿å­˜ (RPCã‚’ä½¿ç”¨)
                const { error: updateError } = await supabase
                    .rpc('update_organization_settings', { new_settings: newSettings });

                if (updateError) throw updateError;

                alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');

            } catch (error) {
                console.error('Save admin settings error:', error);
                alert('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error.details || JSON.stringify(error)));
            }
        };

        // ============================================
        // KPI Dashboard Logic
        // ============================================
        let kpiChartFunnel = null;
        let kpiChartActivity = null;

        async function loadKPIDashboard() {
            const currentUser = window.currentUser;
            const supabase = window.supabase;
            if (!currentUser || !currentUser.organization_id) return;

            window.showLoading('KPIãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆä¸­...');

            try {
                // 1. Get Filters
                const period = $('#kpi-filter-period').val();
                const userIdFilter = $('#kpi-filter-user').val();

                // 2. Fetch Data
                // Fetch Applications (with Job and User info)
                let query = supabase
                    .from('applications')
                    .select('*, jobs!inner(title, salary_min, salary_max, company), users!applications_user_id_fkey!inner(name, coach_id)')
                    .eq('jobs.organization_id', currentUser.organization_id);

                // Period Filter
                const now = new Date();
                let startDate;
                if (period === 'this_month') startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                else if (period === 'last_month') startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                else if (period === 'this_quarter') startDate = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
                else if (period === 'this_year') startDate = new Date(now.getFullYear(), 0, 1);

                if (startDate) {
                    query = query.gte('updated_at', startDate.toISOString());
                }

                if (userIdFilter) {
                    query = query.eq('users.coach_id', userIdFilter);
                }

                const { data: applications, error } = await query;
                if (error) throw error;

                // Load Coaches for Mapping and Filter
                const { data: allCoaches } = await window.supabase
                    .from('users')
                    .select('id, name')
                    .eq('organization_id', currentUser.organization_id)
                    .in('role', ['coach', 'admin', 'org_admin', 'super_admin']);

                const coachNameMap = {};
                if (allCoaches) {
                    allCoaches.forEach(c => {
                        coachNameMap[c.id] = c.name;
                        // Populate filter if empty (or missing)
                        if ($('#kpi-filter-user option[value="' + c.id + '"]').length === 0) {
                            $('#kpi-filter-user').append(`< option value = "${c.id}" > ${c.name}</option > `);
                        }
                    });
                }

                const summary = calculateKPISummary(applications || []);
                const funnelData = calculateKPIFunnel(applications || []);
                const activityData = calculateKPIActivity(applications || [], coachNameMap);
                const stagnantCases = identifyStagnantCases(applications || []);

                renderKPICards(summary);
                renderKPIFunnelChart(funnelData);
                renderKPIActivityChart(activityData);
                renderKPIStagnantTable(stagnantCases);

            } catch (e) {
                console.error('KPI Load Error:', e);
            } finally {
                window.hideLoading();
            }
        }

        function calculateKPISummary(apps) {
            let revenue = 0;
            let candidates = 0;
            let success = 0;
            const PROB = { 'pending': 0, 'applied': 0.1, 'interviewing': 0.3, 'offered': 0.8, 'rejected': 0, 'withdrawn': 0 };
            const FEE_RATE = 0.35;

            apps.forEach(app => {
                if (!['rejected', 'withdrawn', 'pending'].includes(app.status)) candidates++;
                if (app.status === 'offered') success++;
                const salary = app.jobs.salary_min || 4000000;
                const prob = PROB[app.status] || 0;
                revenue += (salary * FEE_RATE * prob);
            });
            return { revenue, candidates, success };
        }

        function calculateKPIFunnel(apps) {
            const counts = { 'applied': 0, 'interviewing': 0, 'offered': 0 };
            apps.forEach(app => {
                const s = app.status;
                if (['applied', 'interviewing', 'offered'].includes(s)) counts['applied']++;
                if (['interviewing', 'offered'].includes(s)) counts['interviewing']++;
                if (['offered'].includes(s)) counts['offered']++;
            });
            return counts;
        }

        function calculateKPIActivity(apps, nameMap) {
            const activity = {};
            apps.forEach(app => {
                const cid = app.users.coach_id;
                const name = cid ? (nameMap && nameMap[cid] ? nameMap[cid] : 'Unknown') : 'æœªã‚¢ã‚µã‚¤ãƒ³';

                if (!activity[name]) activity[name] = 0;
                activity[name]++;
            });
            return activity;
        }

        function identifyStagnantCases(apps) {
            const now = new Date();
            const thresholdDays = 5;
            const stagnant = [];
            apps.forEach(app => {
                if (['rejected', 'withdrawn', 'offered'].includes(app.status)) return;
                const lastUpdate = new Date(app.updated_at);
                const diffDays = Math.ceil(Math.abs(now - lastUpdate) / (1000 * 60 * 60 * 24));
                if (diffDays >= thresholdDays) stagnant.push({ ...app, days_stagnant: diffDays });
            });
            return stagnant;
        }

        function renderKPICards(summary) {
            $('#kpi-metric-revenue').text(`Â¥${Math.floor(summary.revenue / 10000).toLocaleString()} ä¸‡`);
            $('#kpi-metric-candidates').text(summary.candidates);
            $('#kpi-metric-success').text(summary.success);
            fetchActiveJobs().then(jobs => { if (jobs) $('#kpi-metric-jobs').text(jobs.length); });
        }

        function renderKPIFunnelChart(data) {
            const ctx = document.getElementById('kpi-funnel-chart');
            if (!ctx) return;
            if (kpiChartFunnel) kpiChartFunnel.destroy();
            kpiChartFunnel = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['æ›¸é¡é¸è€ƒ/æ¨è–¦', 'é¢æ¥ä¸­', 'å†…å®š/æˆç´„'],
                    datasets: [{
                        label: 'å€™è£œè€…æ•°',
                        data: [data.applied, data.interviewing, data.offered],
                        backgroundColor: ['rgba(99, 102, 241, 0.5)', 'rgba(167, 139, 250, 0.5)', 'rgba(16, 185, 129, 0.5)'],
                        borderColor: ['rgb(99, 102, 241)', 'rgb(167, 139, 250)', 'rgb(16, 185, 129)'],
                        borderWidth: 1
                    }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function renderKPIActivityChart(activityData) {
            const ctx = document.getElementById('kpi-activity-chart');
            if (!ctx) return;
            if (kpiChartActivity) kpiChartActivity.destroy();
            kpiChartActivity = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: Object.keys(activityData),
                    datasets: [{ label: 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°', data: Object.values(activityData), backgroundColor: 'rgba(59, 130, 246, 0.5)' }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }

        function renderKPIStagnantTable(cases) {
            const tbody = $('#kpi-stagnant-table-body');
            tbody.empty();
            $('#stagnant-cases-count').text(`${cases.length} ä»¶`);
            if (cases.length === 0) {
                tbody.html('<tr><td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">åœæ»ã—ã¦ã„ã‚‹æ¡ˆä»¶ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>');
                return;
            }
            cases.forEach(c => {
                const tr = `<tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${c.users.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${c.jobs.title}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">${c.status}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(c.updated_at).toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">ID: ${c.users.coach_id || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><button class="text-indigo-600 hover:text-indigo-900">è©³ç´°</button></td></tr>`;
                tbody.append(tr);
            });
        }

        // --- AI Search Agent Logic ---
        window.toggleAISearchChat = function () {
            const chat = $('#ai-search-agent-chat');
            const isVisible = chat.is(':visible');
            if (isVisible) {
                chat.fadeOut(200, () => chat.css('display', 'none'));
            } else {
                chat.css('display', 'flex').hide().fadeIn(300);
                $('#ai-search-agent-trigger .notification-dot').hide();
                $('#ai-chat-input').focus();
            }
        };

        window.sendAIChatMessage = async function () {
            const input = $('#ai-chat-input');
            const text = input.val().trim();
            if (!text) return;

            // Clear input and add user bubble
            input.val('');
            addChatBubble('user', text);

            // Show typing indicator
            $('#chat-typing').show();
            scrollToBottom();

            try {
                // Determine current context (what page am I on?)
                const currentPage = $('.nav-link.active').data('page') || 'dashboard';

                const { data, error } = await supabase.functions.invoke('ai-search-agent', {
                    body: {
                        prompt: text,
                        currentContext: currentPage
                    }
                });

                if (error) throw error;

                // Hide typing
                $('#chat-typing').hide();

                if (data.explanation) {
                    addChatBubble('ai', data.explanation);
                }

                if (data.filters) {
                    applyAISearchFilters(data.searchType, data.filters);
                }

            } catch (error) {
                console.error('AI Search Error:', error);
                $('#chat-typing').hide();
                addChatBubble('ai', 'ã™ã¿ã¾ã›ã‚“ã€æ¤œç´¢å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ç½®ã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            }
            scrollToBottom();
        };

        function addChatBubble(role, text) {
            const container = $('#ai-chat-body');
            const bubble = $(`<div class="chat-bubble ${role}">${text}</div>`);
            container.append(bubble);
            scrollToBottom();
        }

        function scrollToBottom() {
            const container = $('#ai-chat-body');
            container.scrollTop(container[0].scrollHeight);
        }

        // Helper to match Select2 values by text label
        function setSelect2ByLabels($element, labels) {
            if (!labels || labels.length === 0) return;
            const values = [];
            $element.find('option').each(function () {
                const optText = $(this).text().trim();
                const optValue = $(this).val();
                if (labels.some(l => optText.includes(l) || l.includes(optText))) {
                    values.push(optValue);
                }
            });
            if (values.length > 0) {
                $element.val(values).trigger('change');
            }
        }

        async function applyAISearchFilters(type, filters) {
            console.log('Applying AI Filters:', type, filters);

            if (type === 'job') {
                // Switch to jobs page
                $(`.nav-link[data-page="jobs"]`).click();

                // Clear previous search if AI suggests it (Contextual behavior)
                if (filters.shouldClear !== false) { // Default to clear if not explicitly additive
                    if (window.clearSearch) window.clearSearch();
                }

                // Set keyword tags (split by spaces, tabs, or commas)
                if (filters.keyword) {
                    const words = filters.keyword.split(/[\s,ã€\t]+/).filter(w => w.length > 0);
                    const $input = $('#search-keyword');
                    words.forEach(word => {
                        $input.val(word);
                        const event = jQuery.Event("keypress");
                        event.which = 13;
                        $input.trigger(event);
                    });
                    // Clear the input after processing tags
                    $input.val('');

                    // Set mode if specified, default to AND
                    const mode = filters.keyword_mode || 'AND';
                    $(`input[name="search-keyword-mode"][value="${mode}"]`).prop('checked', true);
                }

                // Set location
                if (filters.location) {
                    const locations = filters.location.split(/[\s,ã€\t]+/).filter(l => l.length > 0);
                    const $locInput = $('#search-location');
                    locations.forEach(loc => {
                        $locInput.val(loc);
                        const event = jQuery.Event("keypress");
                        event.which = 13;
                        $locInput.trigger(event);
                    });
                    $locInput.val('');
                }

                // Set salary
                if (filters.salary_min) {
                    $('#search-salary-slider').val(filters.salary_min).trigger('input');
                }

                // Multi-selects (Select2)
                if (filters.prefectures && filters.prefectures.length > 0) {
                    setSelect2ByLabels($('#search-prefecture'), filters.prefectures);
                }
                if (filters.job_categories && filters.job_categories.length > 0) {
                    setSelect2ByLabels($('#search-job-category'), filters.job_categories);
                }
                if (filters.industry_categories && filters.industry_categories.length > 0) {
                    setSelect2ByLabels($('#search-industry-category'), filters.industry_categories);
                }
                if (filters.employment_types && filters.employment_types.length > 0) {
                    setSelect2ByLabels($('#search-employment-type'), filters.employment_types);
                }

                // Experience flags
                if (filters.job_experience_ok) {
                    $('#search-job-experience-ok').prop('checked', true);
                }
                if (filters.industry_experience_ok) {
                    $('#search-industry-experience-ok').prop('checked', true);
                }

                // Trigger search
                setTimeout(() => {
                    if (window.searchJobsImmediate) window.searchJobsImmediate();
                    else if (window.searchJobs) window.searchJobs();
                }, 800);

            } else if (type === 'candidate') {
                // Switch to candidate search page
                $(`.nav-link[data-page="candidate-search"]`).click();

                // Clear previous search if AI suggests it
                if (filters.shouldClear !== false) {
                    if (window.clearCandidateSearch) window.clearCandidateSearch();
                }

                // Set keyword tags
                if (filters.keyword) {
                    const words = filters.keyword.split(/[\s,ã€\t]+/).filter(w => w.length > 0);
                    const $input = $('#c-search-keyword');
                    words.forEach(word => {
                        $input.val(word);
                        const event = jQuery.Event("keypress");
                        event.which = 13;
                        $input.trigger(event);
                    });
                    $input.val('');

                    const mode = filters.keyword_mode || 'AND';
                    $(`input[name="c-search-keyword-mode"][value="${mode}"]`).prop('checked', true);
                }

                // Set location text
                if (filters.location) {
                    const locations = filters.location.split(/[\s,ã€\t]+/).filter(l => l.length > 0);
                    const $locInput = $('#c-search-location');
                    locations.forEach(loc => {
                        $locInput.val(loc);
                        const event = jQuery.Event("keypress");
                        event.which = 13;
                        $locInput.trigger(event);
                    });
                    $locInput.val('');
                }

                // Multi-selects
                if (filters.prefectures && filters.prefectures.length > 0) {
                    setSelect2ByLabels($('#c-search-prefecture'), filters.prefectures);
                }
                if (filters.job_categories && filters.job_categories.length > 0) {
                    setSelect2ByLabels($('#c-search-job-category'), filters.job_categories);
                }
                if (filters.industry_categories && filters.industry_categories.length > 0) {
                    setSelect2ByLabels($('#c-search-industry-category'), filters.industry_categories);
                }
                if (filters.employment_types && filters.employment_types.length > 0) {
                    setSelect2ByLabels($('#c-search-employment-type'), filters.employment_types);
                }
                if (filters.salary_min) {
                    $('#c-search-salary-slider').val(filters.salary_min).trigger('input');
                }

                // Trigger search
                setTimeout(() => {
                    if (window.searchCandidates) window.searchCandidates();
                }, 800);
            }
        }

        // ========================
        // Admin: Data Management (Duplicate Detection & Merge)
        // ========================
        let duplicateResultsCache = [];
        let currentMergeData = { type: '', recordA: null, recordB: null };

        window.loadDataCleanupSettings = async function () {
            if (!currentUser) return;
            try {
                // Get fresh organization settings
                const { data: org, error } = await supabase
                    .from('organizations')
                    .select('settings')
                    .eq('id', currentUser.organization_id)
                    .single();

                if (error) throw error;

                const settings = org.settings?.data_cleanup;
                if (!settings) return;

                // Restore company criteria
                if (settings.company) {
                    $('#criteria-company-name').prop('checked', settings.company.name);
                    $('#criteria-company-phone').prop('checked', settings.company.phone);
                    $('#criteria-company-domain').prop('checked', settings.company.domain);
                    $('#criteria-company-address').prop('checked', settings.company.address);
                }

                // Restore job criteria
                if (settings.job) {
                    $('#criteria-job-title').prop('checked', settings.job.title);
                    $('#criteria-job-company').prop('checked', settings.job.same_company);
                    $('#criteria-job-location').prop('checked', settings.job.location);
                }
            } catch (err) {
                console.error('Load settings error:', err);
            }
        };

        window.saveDataCleanupSettings = async function () {
            if (!currentUser) return;
            showLoading();
            try {
                const settings = {
                    company: {
                        name: $('#criteria-company-name').is(':checked'),
                        phone: $('#criteria-company-phone').is(':checked'),
                        domain: $('#criteria-company-domain').is(':checked'),
                        address: $('#criteria-company-address').is(':checked')
                    },
                    job: {
                        title: $('#criteria-job-title').is(':checked'),
                        same_company: $('#criteria-job-company').is(':checked'),
                        location: $('#criteria-job-location').is(':checked')
                    },
                    updated_at: new Date().toISOString()
                };

                const { error } = await supabase
                    .from('organizations')
                    .update({ settings: { ...currentUser.org_settings, data_cleanup: settings } })
                    .eq('id', currentUser.organization_id);

                if (error) throw error;
                alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            } catch (err) {
                console.error('Save settings error:', err);
                alert('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            } finally {
                hideLoading();
            }
        };

        window.detectDuplicates = async function () {
            const activeTab = $('.data-mgmt-tab.border-indigo-500').data('type');
            showLoading(activeTab === 'company' ? 'é‡è¤‡ä¼æ¥­ã‚’æ¤œç´¢ä¸­...' : 'é‡è¤‡æ±‚äººã‚’æ¤œç´¢ä¸­...');

            try {
                const resultsContainer = $('#data-mgmt-results');
                resultsContainer.html('<div class="text-center py-10"><i class="fas fa-spinner fa-spin text-3xl text-indigo-600"></i></div>');

                if (activeTab === 'company') {
                    await runCompanyDuplicateCheck();
                } else {
                    await runJobDuplicateCheck();
                }
            } catch (err) {
                console.error('Detection error:', err);
                alert('æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            } finally {
                hideLoading();
            }
        };

        async function runCompanyDuplicateCheck() {
            const checkName = $('#criteria-company-name').is(':checked');
            const checkPhone = $('#criteria-company-phone').is(':checked');
            const checkDomain = $('#criteria-company-domain').is(':checked');
            const checkAddress = $('#criteria-company-address').is(':checked');

            const { data: companies, error } = await supabase
                .from('companies')
                .select('*')
                .eq('organization_id', currentUser.organization_id)
                .order('name');

            if (error) throw error;

            const duplicates = [];
            const seen = new Map();

            companies.forEach(co => {
                let key = '';
                if (checkName) key += co.name.replace(/\s+/g, '').toLowerCase();
                if (checkPhone && co.phone) key += '|' + co.phone.replace(/[-\s]/g, '');
                if (checkDomain && co.website) {
                    try {
                        const url = new URL(co.website.startsWith('http') ? co.website : 'http://' + co.website);
                        key += '|' + url.hostname.replace('www.', '');
                    } catch (e) { }
                }

                if (key && seen.has(key)) {
                    duplicates.push({ original: seen.get(key), duplicate: co });
                } else if (key) {
                    seen.set(key, co);
                }
            });

            renderDuplicateResults('company', duplicates);
        }

        async function runJobDuplicateCheck() {
            const checkTitle = $('#criteria-job-title').is(':checked');
            const checkCo = $('#criteria-job-company').is(':checked');
            const checkLoc = $('#criteria-job-location').is(':checked');

            const { data: jobs, error } = await supabase
                .from('jobs')
                .select('*, companies(name)')
                .eq('organization_id', currentUser.organization_id)
                .is('deleted_at', null)
                .order('title');

            if (error) throw error;

            const duplicates = [];
            const seen = new Map();

            jobs.forEach(job => {
                let key = '';
                if (checkTitle) key += job.title.replace(/\s+/g, '').toLowerCase();
                if (checkCo) key += '|' + (job.company_id || job.company);
                if (checkLoc && job.location) key += '|' + job.location.split(/[ã€\s]/)[0];

                if (key && seen.has(key)) {
                    duplicates.push({ original: seen.get(key), duplicate: job });
                } else if (key) {
                    seen.set(key, job);
                }
            });

            renderDuplicateResults('job', duplicates);
        }

        function renderDuplicateResults(type, duplicates) {
            const container = $('#data-mgmt-results');
            duplicateResultsCache = duplicates;

            if (duplicates.length === 0) {
                container.html(`
                    <div class="text-center py-20 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                        <i class="fas fa-check-circle text-5xl text-green-400 mb-4"></i>
                        <p class="text-gray-600 font-medium">é‡è¤‡ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>
                    </div>
                `);
                return;
            }

            let html = `
                <div class="mb-4 flex justify-between items-center">
                    <span class="text-sm font-bold text-gray-700">${duplicates.length} çµ„ã®é‡è¤‡å€™è£œãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ</span>
                </div>
                <div class="space-y-4">
            `;

            duplicates.forEach((pair, idx) => {
                const itemA = pair.original;
                const itemB = pair.duplicate;

                html += `
                    <div class="bg-white border rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center p-4">
                            <div class="flex-1 grid grid-cols-2 gap-8">
                                <div class="p-3 bg-blue-50 rounded-lg">
                                    <div class="text-[10px] font-bold text-blue-600 uppercase mb-1">ãƒ¬ã‚³ãƒ¼ãƒ‰ A</div>
                                    <div class="font-bold text-gray-900">${type === 'company' ? itemA.name : itemA.title}</div>
                                    <div class="text-xs text-gray-500 mt-1">${type === 'company' ? (itemA.industry || 'æ¥­ç¨®ä¸æ˜') : (itemA.companies?.name || itemA.company)}</div>
                                </div>
                                <div class="p-3 bg-amber-50 rounded-lg">
                                    <div class="text-[10px] font-bold text-amber-600 uppercase mb-1">ãƒ¬ã‚³ãƒ¼ãƒ‰ B</div>
                                    <div class="font-bold text-gray-900">${type === 'company' ? itemB.name : itemB.title}</div>
                                    <div class="text-xs text-gray-500 mt-1">${type === 'company' ? (itemB.industry || 'æ¥­ç¨®ä¸æ˜') : (itemB.companies?.name || itemB.company)}</div>
                                </div>
                            </div>
                            <div class="ml-6 flex flex-col gap-2">
                                <button onclick="openMergeModal('${type}', ${idx})" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold hover:bg-indigo-700 whitespace-nowrap">
                                    <i class="fas fa-compress-alt mr-1"></i> çµ±åˆ
                                </button>
                                <button onclick="$(this).closest('.rounded-xl').fadeOut()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg text-sm transition">
                                    ç„¡è¦–
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `</div>`;
            container.html(html);
        }

        window.openMergeModal = function (type, index) {
            const pair = duplicateResultsCache[index];
            currentMergeData = { type, recordA: pair.original, recordB: pair.duplicate };

            const container = $('#merge-fields-container');
            container.empty();

            let fields = [];
            if (type === 'company') {
                fields = [
                    { key: 'name', label: 'ä¼æ¥­å' },
                    { key: 'industry', label: 'æ¥­ç¨®' },
                    { key: 'location', label: 'æ‰€åœ¨åœ°' },
                    { key: 'website', label: 'ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ' },
                    { key: 'phone', label: 'é›»è©±ç•ªå·' },
                    { key: 'description', label: 'ä¼æ¥­èª¬æ˜' }
                ];
            } else {
                fields = [
                    { key: 'title', label: 'æ±‚äººã‚¿ã‚¤ãƒˆãƒ«' },
                    { key: 'company', label: 'ä¼æ¥­å(Snap)' },
                    { key: 'location', label: 'å‹¤å‹™åœ°' },
                    { key: 'employment_type', label: 'é›‡ç”¨å½¢æ…‹' },
                    { key: 'salary_min', label: 'æœ€ä½å¹´å', format: v => v ? (v / 10000) + 'ä¸‡' : '-' },
                    { key: 'salary_max', label: 'æœ€é«˜å¹´å', format: v => v ? (v / 10000) + 'ä¸‡' : '-' }
                ];
            }

            fields.forEach(f => {
                const valA = currentMergeData.recordA[f.key];
                const valB = currentMergeData.recordB[f.key];
                const displayA = f.format ? f.format(valA) : (valA || '-');
                const displayB = f.format ? f.format(valB) : (valB || '-');

                const row = `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium text-gray-500 bg-gray-50/50">${f.label}</td>
                        <td class="px-4 py-3">
                            <label class="flex items-start gap-3 cursor-pointer group">
                                <input type="radio" name="merge_${f.key}" value="A" checked class="mt-1">
                                <span class="text-sm text-gray-800 group-hover:text-indigo-600 transition">${displayA}</span>
                            </label>
                        </td>
                        <td class="px-4 py-3">
                            <label class="flex items-start gap-3 cursor-pointer group">
                                <input type="radio" name="merge_${f.key}" value="B" class="mt-1">
                                <span class="text-sm text-gray-800 group-hover:text-indigo-600 transition">${displayB}</span>
                            </label>
                        </td>
                    </tr>
                `;
                container.append(row);
            });

            $('#data-merge-modal').removeClass('hidden');
        };

        window.selectAllMerge = function (side) {
            $(`#merge-fields-container input[value="${side}"]`).prop('checked', true);
        };

        window.closeDataMergeModal = function () {
            $('#data-merge-modal').addClass('hidden').attr('style', '');
        };

        window.executeMerge = async function () {
            if (!confirm('çµ±åˆã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;

            showLoading('çµ±åˆå‡¦ç†ã‚’å®Ÿè¡Œä¸­...');
            try {
                const { type, recordA, recordB } = currentMergeData;
                const updates = {};

                // é¸æŠã•ã‚ŒãŸå€¤ã®åé›†
                $(`#merge-fields-container tr`).each(function () {
                    const row = $(this);
                    const radio = row.find('input[type="radio"]:checked');
                    if (radio.length) {
                        const fieldName = radio.attr('name').replace('merge_', '');
                        const side = radio.val();
                        updates[fieldName] = side === 'A' ? recordA[fieldName] : recordB[fieldName];
                    }
                });

                const targetTable = type === 'company' ? 'companies' : 'jobs';

                // 1. ãƒ¬ã‚³ãƒ¼ãƒ‰Aã‚’æ›´æ–°
                const { error: updateError } = await supabase
                    .from(targetTable)
                    .update(updates)
                    .eq('id', recordA.id);

                if (updateError) throw updateError;

                // 2. é–¢é€£ãƒ‡ãƒ¼ã‚¿ã®ç´ã¥ã‘æ›¿ãˆ
                if (type === 'company') {
                    // æ±‚äººã®ç´ã¥ã‘æ›¿ãˆ
                    await supabase.from('jobs').update({ company_id: recordA.id }).eq('company_id', recordB.id);
                } else {
                    // å¿œå‹Ÿã€æ¨è–¦ã€ãŠæ°—ã«å…¥ã‚Šã®ç´ã¥ã‘æ›¿ãˆ
                    await supabase.from('applications').update({ job_id: recordA.id }).eq('job_id', recordB.id);
                    await supabase.from('recommendations').update({ job_id: recordA.id }).eq('job_id', recordB.id);
                    await supabase.from('favorites').update({ job_id: recordA.id }).eq('job_id', recordB.id);
                }

                // 3. ãƒ¬ã‚³ãƒ¼ãƒ‰Bã‚’å‰Šé™¤ (è«–ç†å‰Šé™¤å¯èƒ½ãªå ´åˆã¯è«–ç†å‰Šé™¤)
                if (type === 'job') {
                    await supabase.from('jobs').update({ deleted_at: new Date().toISOString() }).eq('id', recordB.id);
                } else {
                    await supabase.from('companies').delete().eq('id', recordB.id);
                }

                alert('çµ±åˆãŒå®Œäº†ã—ã¾ã—ãŸ');
                closeDataMergeModal();
                detectDuplicates(); // å†æ¤œç´¢ã—ã¦æ›´æ–°

            } catch (err) {
                console.error('Merge execution error:', err);
                alert('çµ±åˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
            } finally {
                hideLoading();
            }
        };
        window.switchDataManagementTab = function (type) {
            $('.data-mgmt-tab').removeClass('border-indigo-500 text-indigo-600').addClass('border-transparent text-gray-500');
            $(`#data-mgmt-tab-${type}`).addClass('border-indigo-500 text-indigo-600').removeClass('border-transparent text-gray-500');

            if (type === 'companies') {
                $('#data-mgmt-criteria-companies').removeClass('hidden');
                $('#data-mgmt-criteria-jobs').addClass('hidden');
                $('#data-mgmt-tab-companies').attr('data-type', 'company'); // Used by detectDuplicates
            } else {
                $('#data-mgmt-criteria-companies').addClass('hidden');
                $('#data-mgmt-criteria-jobs').removeClass('hidden');
                $('#data-mgmt-tab-jobs').attr('data-type', 'job'); // Used by detectDuplicates
            }
            // Clear results when switching
            $('#data-mgmt-results').html(`
                <div class="text-center py-12 text-gray-500 border-2 border-dashed border-gray-200 rounded-lg">
                    <i class="fas fa-broom text-4xl mb-4"></i>
                    <p>è¨­å®šã‚’ç¢ºèªã—ã¦ã€ã€Œé‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚’é–‹å§‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</p>
                </div>
            `);
        };

        // Initialize default tab metadata
        $(document).ready(() => {
            $('#data-mgmt-tab-companies').attr('data-type', 'company');
            $('#data-mgmt-tab-jobs').attr('data-type', 'job');
        });
        // ========================================
        // ãƒ¨ãƒŸç®¡ç†ãƒ»é€²æ—ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½
        // ========================================

        let yomiViewMode = 'board';
        let yomiData = [];

        window.switchYomiView = function (view) {
            yomiViewMode = view;
            $('.yomi-view-btn').removeClass('bg-white shadow-sm text-indigo-600').addClass('text-gray-600 hover:text-gray-900');
            $(`#yomi-view-${view}-btn`).addClass('bg-white shadow-sm text-indigo-600').removeClass('text-gray-600 hover:text-gray-900');

            $('.yomi-view-content').addClass('hidden');
            $(`#yomi-${view}-view`).removeClass('hidden');

            renderYomiContent();
        };

        window.loadYomiData = async function () {
            showLoading('ãƒ¨ãƒŸãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ä¸­...');
            try {
                if (!window.supabase) return;

                // 1. ãƒãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
                const { data: teams, error: teamError } = await window.supabase
                    .from('teams')
                    .select('*')
                    .eq('organization_id', currentUser.organization_id)
                    .order('display_order');

                if (!teamError && teams) {
                    const teamSelect = $('#yomi-filter-team');
                    const currentValue = teamSelect.val();
                    teamSelect.empty().append('<option value="">å…¨ã¦ã®ãƒãƒ¼ãƒ </option>');
                    teams.forEach(t => {
                        const indent = '&nbsp;'.repeat((t.level - 1) * 4);
                        teamSelect.append(`<option value="${t.id}">${indent}${t.name}</option>`);
                    });
                    teamSelect.val(currentValue);
                }

                // 2. ã‚³ãƒ¼ãƒï¼ˆæ‹…å½“è€…ï¼‰ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
                const { data: coaches, error: coachError } = await window.supabase
                    .from('users')
                    .select('id, name')
                    .eq('organization_id', currentUser.organization_id)
                    .in('role', ['coach', 'admin', 'org_admin']);

                if (!coachError && coaches) {
                    const coachSelect = $('#yomi-filter-coach');
                    const currentCoach = coachSelect.val();
                    coachSelect.empty().append('<option value="">å…¨å“¡</option>');
                    coaches.forEach(c => {
                        coachSelect.append(`<option value="${c.id}">${c.name}</option>`);
                    });
                    coachSelect.val(currentCoach);
                }

                // 3. å¿œå‹Ÿãƒ‡ãƒ¼ã‚¿ã®å–å¾— (ãƒ¨ãƒŸæƒ…å ±å«ã‚€)
                let query = window.supabase
                    .from('applications')
                    .select(`
                        *,
                        users(id, name, team_id),
                        jobs(id, title, company, company_id)
                    `)
                    .eq('organization_id', currentUser.organization_id)
                    .is('deleted_at', null);

                // ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨
                const teamId = $('#yomi-filter-team').val();
                if (teamId) {
                    query = query.eq('users.team_id', teamId);
                }

                const coachId = $('#yomi-filter-coach').val();
                if (coachId) {
                    query = query.eq('user_id', coachId); // ã‚·ãƒ³ãƒ—ãƒ«ã«user_idï¼ˆé€²æ—ä½œæˆè€…ï¼‰ã§ãƒ•ã‚£ãƒ«ã‚¿ã™ã‚‹å ´åˆ
                    // å®Ÿéš›ã«ã¯RA/CAãã‚Œãã‚Œã®æ‹…å½“ã§ãƒ•ã‚£ãƒ«ã‚¿ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆãŒã‚ã‚‹
                }

                const { data, error } = await query;
                if (error) throw error;

                yomiData = data || [];
                updateYomiStats();
                renderYomiContent();

            } catch (err) {
                console.error('Failed to load yomi data:', err);
                alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            } finally {
                hideLoading();
            }
        };

        function updateYomiStats() {
            let totalRevenue = 0;
            let weightedRevenue = 0;
            let activeCount = yomiData.length;
            let totalProb = 0;

            yomiData.forEach(item => {
                const rev = item.expected_revenue || 0;
                const prob = item.probability_rate || 0;
                totalRevenue += rev;
                weightedRevenue += (rev * prob / 100);
                totalProb += prob;
            });

            $('#yomi-stat-total-revenue').text(new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(totalRevenue));
            $('#yomi-stat-weighted-revenue').text(new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(weightedRevenue));
            $('#yomi-stat-active-count').text(activeCount + 'ä»¶');
            $('#yomi-stat-avg-probability').text((activeCount > 0 ? Math.round(totalProb / activeCount) : 0) + '%');
        }

        function renderYomiContent() {
            if (yomiViewMode === 'board') renderYomiBoard();
            else if (yomiViewMode === 'list') renderYomiList();
            else if (yomiViewMode === 'forecast') renderYomiForecast();
        }

        async function renderYomiBoard() {
            const container = $('#yomi-kanban-container').empty();

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ã‚«ãƒ©ãƒ ã‚’ç”Ÿæˆ
            const { data: statuses } = await window.supabase
                .from('master_data')
                .select('*')
                .eq('type', 'application_status')
                .order('sort_order');

            if (!statuses) return;

            // å„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã‚«ãƒ©ãƒ ã‚’ä½œæˆ
            statuses.forEach(status => {
                const columnData = yomiData.filter(d => d.status === status.value);
                const colHtml = `
                    <div class="flex-shrink-0 w-80 bg-gray-50 rounded-xl flex flex-col max-h-[70vh]">
                        <div class="p-4 flex justify-between items-center border-b">
                            <h3 class="font-bold text-gray-700">${status.value} <span class="ml-2 text-xs text-gray-400 font-normal">${columnData.length}</span></h3>
                        </div>
                        <div class="flex-1 overflow-y-auto p-3 space-y-3 custom-scrollbar" ondragover="event.preventDefault()" ondrop="handleYomiDrop(event, '${status.value}')">
                            ${columnData.map(item => `
                                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 cursor-move hover:shadow-md transition-shadow" 
                                     draggable="true" ondragstart="handleYomiDragStart(event, '${item.id}')">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded">${item.probability_rate || 0}%</span>
                                        <span class="text-[10px] text-gray-400 font-mono">Â¥${(item.expected_revenue || 0).toLocaleString()}</span>
                                    </div>
                                    <h4 class="font-bold text-gray-900 text-sm mb-1">${item.users?.name || 'ä¸æ˜'}</h4>
                                    <p class="text-[10px] text-gray-500 truncate mb-2">${item.jobs?.company || ''} / ${item.jobs?.title || ''}</p>
                                    <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-50">
                                        <span class="text-[10px] text-gray-400"><i class="far fa-calendar-alt mr-1"></i>${item.expected_start_date || '-'}</span>
                                        <button onclick="openApplicationDetail('${item.id}')" class="text-xs text-indigo-500 hover:text-indigo-700">è©³ç´°</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.append(colHtml);
            });
        }

        function renderYomiList() {
            const container = $('#yomi-list-container').empty();
            yomiData.forEach(item => {
                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="font-bold text-gray-900">${item.users?.name || 'ä¸æ˜'}</div>
                            <div class="text-[10px] text-gray-400">æ‹…å½“: ${item.users?.coach_name || '-'}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">${item.jobs?.title || ''}</div>
                            <div class="text-xs text-gray-500">${item.jobs?.company || ''}</div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-[10px] font-bold rounded-full bg-blue-100 text-blue-700">${item.status}</span>
                        </td>
                        <td class="px-6 py-4">
                            <input type="number" value="${item.expected_revenue || 0}" 
                                   onchange="updateYomiField('${item.id}', 'expected_revenue', this.value)"
                                   class="w-24 border-gray-300 rounded text-sm text-right focus:ring-indigo-500">
                        </td>
                        <td class="px-6 py-4">
                            <select onchange="updateYomiField('${item.id}', 'probability_rate', this.value)"
                                    class="w-20 border-gray-300 rounded text-sm focus:ring-indigo-500">
                                ${[0, 20, 40, 60, 80, 100].map(v => `<option value="${v}" ${item.probability_rate == v ? 'selected' : ''}>${v}%</option>`).join('')}
                            </select>
                        </td>
                        <td class="px-6 py-4">
                            <input type="date" value="${item.expected_start_date || ''}" 
                                   onchange="updateYomiField('${item.id}', 'expected_start_date', this.value)"
                                   class="w-32 border-gray-300 rounded text-xs focus:ring-indigo-500">
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="openApplicationDetail('${item.id}')" class="text-indigo-600 hover:text-indigo-900 font-bold text-xs">ç·¨é›†</button>
                        </td>
                    </tr>
                `;
                container.append(row);
            });
        }

        let yomiForecastChart = null;
        let yomiDistributionChart = null;

        function renderYomiForecast() {
            const ctx1 = document.getElementById('yomi-forecast-chart').getContext('2d');
            const ctx2 = document.getElementById('yomi-distribution-chart').getContext('2d');

            if (yomiForecastChart) yomiForecastChart.destroy();
            if (yomiDistributionChart) yomiDistributionChart.destroy();

            // æœˆåˆ¥é›†è¨ˆ
            const monthlyData = {};
            yomiData.forEach(d => {
                if (d.expected_start_date) {
                    const month = d.expected_start_date.substring(0, 7);
                    monthlyData[month] = (monthlyData[month] || 0) + (d.expected_revenue * (d.probability_rate || 0) / 100);
                }
            });

            const sortedMonths = Object.keys(monthlyData).sort();

            yomiForecastChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'äºˆæ¸¬åˆ©ç›Š (ãƒ¨ãƒŸæ›ç®—)',
                        data: sortedMonths.map(m => monthlyData[m]),
                        backgroundColor: 'rgba(79, 70, 229, 0.6)',
                        borderColor: 'rgb(79, 70, 229)',
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // ãƒ¨ãƒŸåˆ¥å†…è¨³
            const dist = { '80%+': 0, '60%+': 0, '40%+': 0, '20%+': 0, '0%+': 0 };
            yomiData.forEach(d => {
                const p = d.probability_rate || 0;
                if (p >= 80) dist['80%+']++;
                else if (p >= 60) dist['60%+']++;
                else if (p >= 40) dist['40%+']++;
                else if (p >= 20) dist['20%+']++;
                else dist['0%+']++;
            });

            yomiDistributionChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(dist),
                    datasets: [{
                        data: Object.values(dist),
                        backgroundColor: ['#4f46e5', '#818cf8', '#c7d2fe', '#e0e7ff', '#f3f4f6']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        window.updateYomiField = async function (id, field, value) {
            try {
                const { error } = await window.supabase
                    .from('applications')
                    .update({ [field]: value })
                    .eq('id', id);

                if (error) throw error;

                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°
                const idx = yomiData.findIndex(d => d.id === id);
                if (idx !== -1) yomiData[idx][field] = value;

                updateYomiStats();
            } catch (err) {
                console.error('Update failed:', err);
            }
        };

        // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ç”¨
        let draggedApplicationId = null;
        window.handleYomiDragStart = function (e, id) {
            draggedApplicationId = id;
            e.dataTransfer.setData('text/plain', id);
        };

        window.handleYomiDrop = async function (e, newStatus) {
            e.preventDefault();
            const id = e.dataTransfer.getData('text/plain');
            if (!id) return;

            showLoading('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ä¸­...');
            try {
                const { error } = await window.supabase
                    .from('applications')
                    .update({ status: newStatus })
                    .eq('id', id);

                if (error) throw error;

                // å†èª­ã¿è¾¼ã¿
                await loadYomiData();
            } catch (err) {
                alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
            } finally {
                hideLoading();
            }
        };

        // ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆæ™‚ã«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        $(document).on('page-switched', function (e, pageId) {
            if (pageId === 'admin-yomi-management') {
                loadYomiData();
            }
        });

        $(document).ready(() => {
            // Initial call if starting on yomi management
            if ($('#admin-yomi-management-content').hasClass('active')) {
                loadYomiData();
            }
        });

    </script>
    <!-- Job Detail Modal -->
    <div id="job-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
        style="z-index: 30000;">
        <div class="bg-white rounded-lg w-full max-w-6xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-900" id="job-detail-title">æ±‚äººè©³ç´°</h3>
                <button onclick="closeJobDetailModal()"
                    class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="flex space-x-8">
                    <button onclick="switchJobDetailTab('details')" id="job-tab-details"
                        class="job-detail-tab py-4 px-1 border-b-2 border-indigo-600 font-medium text-sm text-indigo-600">
                        æ±‚äººæƒ…å ±
                    </button>
                    <button onclick="switchJobDetailTab('candidates')" id="job-tab-candidates"
                        class="job-detail-tab py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        ãƒãƒƒãƒãƒ³ã‚°å€™è£œè€…
                        <span id="job-candidates-count"
                            class="ml-2 bg-gray-100 text-gray-600 py-1 px-2 rounded-full text-xs"></span>
                    </button>
                </nav>
            </div>

            <!-- æ±‚äººè©³ç´°ã‚¿ãƒ– -->
            <div id="job-detail-tab-content" class="space-y-6">
                <!-- Job details will be loaded here -->
            </div>

            <!-- å€™è£œè€…ãƒãƒƒãƒãƒ³ã‚°ã‚¿ãƒ– -->
            <div id="job-candidates-tab-content" class="hidden">
                <div class="mb-4 flex justify-between items-center">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900">AIãƒãƒƒãƒãƒ³ã‚°å€™è£œè€…</h4>
                        <p class="text-sm text-gray-600">ã“ã®æ±‚äººã«æœ€é©ãªå€™è£œè€…ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™</p>
                    </div>
                    <button onclick="runJobMatching()" id="run-matching-btn"
                        class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center gap-2">
                        <i class="fas fa-magic"></i>
                        <span>AI ãƒãƒƒãƒãƒ³ã‚°å®Ÿè¡Œ</span>
                    </button>
                </div>

                <!-- ãƒãƒƒãƒãƒ³ã‚°å€™è£œè€…ãƒªã‚¹ãƒˆ -->
                <div id="job-candidates-list" class="space-y-4">
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-users text-4xl mb-3"></i>
                        <p>ã€ŒAI ãƒãƒƒãƒãƒ³ã‚°å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å€™è£œè€…ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ã‚¹ã‚«ã‚¦ãƒˆä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="scout-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center hidden"
        style="z-index: 99999 !important; position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; background-color: rgba(0, 0, 0, 0.8) !important;">
        <div class="bg-white rounded-lg w-full max-w-2xl p-6" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-paper-plane text-indigo-600 mr-2"></i>ã‚¹ã‚«ã‚¦ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ
                </h3>
                <button onclick="closeScoutModal()"
                    class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="space-y-4">
                <!-- å®›å…ˆ -->
                <div class="bg-gray-50 p-3 rounded border">
                    <span class="text-gray-600 text-sm">å®›å…ˆ:</span>
                    <span id="scout-candidate-name" class="font-bold text-gray-900 ml-2"></span>
                </div>

                <!-- ä»¶å -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä»¶å</label>
                    <input type="text" id="scout-subject"
                        class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- æœ¬æ–‡ -->
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="block text-sm font-medium text-gray-700">æœ¬æ–‡</label>
                        <button onclick="regenerateScoutMessage()"
                            class="text-xs text-indigo-600 hover:text-indigo-800 flex items-center">
                            <i class="fas fa-sync-alt mr-1"></i>AIã§å†ç”Ÿæˆ
                        </button>
                    </div>
                    <textarea id="scout-body" rows="10"
                        class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>

                <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="flex justify-end gap-3 pt-4 border-t">
                    <button onclick="closeScoutModal()"
                        class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button onclick="sendScoutMessage()"
                        class="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 flex items-center">
                        <i class="fas fa-paper-plane mr-2"></i>é€ä¿¡ã™ã‚‹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dynamic modal is injected here via JS -->
    <!-- è·å‹™çµŒæ­´æ›¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="resume-preview-modal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center"
        style="z-index: 10003; width: 100vw; height: 100vh; top: 0; left: 0; display: none;">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-5xl max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b bg-gradient-to-r from-blue-600 to-indigo-600">
                <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                    <i class="fas fa-file-alt"></i>
                    è·å‹™çµŒæ­´æ›¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                </h2>
                <button onclick="closeResumePreviewModal()" class="text-white hover:text-gray-200">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 180px);">
                <!-- ç”Ÿæˆä¸­è¡¨ç¤º -->
                <div id="resume-generating" class="text-center py-16">
                    <i class="fas fa-spinner fa-spin text-6xl text-indigo-600 mb-6"></i>
                    <p class="text-xl text-gray-700 font-medium">AIãŒè·å‹™çµŒæ­´æ›¸ã‚’ç”Ÿæˆä¸­...</p>
                    <p class="text-sm text-gray-500 mt-2">æ±‚äººæƒ…å ±ã¨ãƒãƒƒãƒãƒ³ã‚°åˆ†æã«åŸºã¥ã„ã¦æœ€é©ãªå†…å®¹ã‚’ä½œæˆã—ã¦ã„ã¾ã™</p>
                </div>

                <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º -->
                <div id="resume-preview-content" class="hidden space-y-4">
                    <div class="bg-blue-50 border-l-4 border-blue-600 p-4 mb-6">
                        <p class="text-sm text-blue-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            ç”Ÿæˆã•ã‚ŒãŸå†…å®¹ã‚’ç¢ºèªãƒ»ç·¨é›†ã—ã¦ã‹ã‚‰ã€ŒWordå‡ºåŠ›ã€ãƒœã‚¿ãƒ³ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™
                        </p>
                    </div>

                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                                <i class="fas fa-user-circle text-indigo-600"></i>
                                è·å‹™è¦ç´„
                            </label>
                            <textarea id="resume-summary" rows="4"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                placeholder="è·å‹™è¦ç´„ãŒè¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                                <i class="fas fa-briefcase text-indigo-600"></i>
                                è·å‹™çµŒæ­´
                            </label>
                            <textarea id="resume-work-history" rows="10"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-mono text-sm"
                                placeholder="è·å‹™çµŒæ­´ãŒè¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                                    <i class="fas fa-star text-indigo-600"></i>
                                    å¼·ã¿ãƒ»æ´»ã‹ã›ã‚‹çµŒé¨“
                                </label>
                                <textarea id="resume-strengths" rows="6"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    placeholder="å¼·ã¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                                    <i class="fas fa-laptop-code text-indigo-600"></i>
                                    PCã‚¹ã‚­ãƒ«ãƒ»è³‡æ ¼
                                </label>
                                <textarea id="resume-skills" rows="6"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    placeholder="ã‚¹ã‚­ãƒ«ãƒ»è³‡æ ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                                <i class="fas fa-comment-dots text-indigo-600"></i>
                                è‡ªå·±PR
                            </label>
                            <textarea id="resume-self-pr" rows="5"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                placeholder="è‡ªå·±PRãŒè¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                                <i class="fas fa-heart text-indigo-600"></i>
                                å¿—æœ›å‹•æ©Ÿ
                            </label>
                            <textarea id="resume-motivation" rows="5"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                placeholder="å¿—æœ›å‹•æ©ŸãŒè¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
                        </div>
                    </div>
                </div>

                <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
                <div id="resume-error" class="hidden text-center py-16">
                    <i class="fas fa-exclamation-triangle text-6xl text-red-600 mb-6"></i>
                    <p class="text-xl text-red-600 font-medium" id="resume-error-message"></p>
                    <button onclick="regenerateResume()"
                        class="mt-6 px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        <i class="fas fa-redo mr-2"></i>å†è©¦è¡Œ
                    </button>
                </div>
            </div>

            <div class="flex justify-end gap-3 p-6 border-t bg-gray-50">
                <button onclick="closeResumePreviewModal()"
                    class="px-6 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-100 font-medium">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button onclick="regenerateResume()"
                    class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 font-medium">
                    <i class="fas fa-sync"></i>
                    å†ç”Ÿæˆ
                </button>
                <button onclick="downloadResumeWord()"
                    class="px-6 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center gap-2 font-medium">
                    <i class="fas fa-file-word"></i>
                    Wordå‡ºåŠ›
                </button>
            </div>
        </div>
    </div>

    <!-- æ¨è–¦çŠ¶ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="recommendation-doc-preview-modal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center"
        style="z-index: 10003; width: 100vw; height: 100vh; top: 0; left: 0; display: none;">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-4xl max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b bg-gradient-to-r from-purple-600 to-pink-600">
                <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                    <i class="fas fa-file-signature"></i>
                    æ¨è–¦çŠ¶ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                </h2>
                <button onclick="closeRecommendationDocPreviewModal()" class="text-white hover:text-gray-200">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 180px);">
                <!-- ç”Ÿæˆä¸­è¡¨ç¤º -->
                <div id="recommendation-doc-generating" class="text-center py-16">
                    <i class="fas fa-spinner fa-spin text-6xl text-purple-600 mb-6"></i>
                    <p class="text-xl text-gray-700 font-medium">AIãŒæ¨è–¦çŠ¶ã‚’ç”Ÿæˆä¸­...</p>
                    <p class="text-sm text-gray-500 mt-2">ä¼æ¥­å‘ã‘ã®æ­£å¼ãªæ¨è–¦çŠ¶ã‚’ä½œæˆã—ã¦ã„ã¾ã™</p>
                </div>

                <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º -->
                <div id="recommendation-doc-preview-content" class="hidden">
                    <div class="bg-purple-50 border-l-4 border-purple-600 p-4 mb-6">
                        <p class="text-sm text-purple-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            ç”Ÿæˆã•ã‚ŒãŸæ¨è–¦çŠ¶ã‚’ç¢ºèªãƒ»ç·¨é›†ã—ã¦ã‹ã‚‰ã€ŒWordå‡ºåŠ›ã€ãƒœã‚¿ãƒ³ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™
                        </p>
                    </div>

                    <div class="bg-white border-2 border-gray-200 rounded-lg p-6">
                        <textarea id="recommendation-doc-full-text" rows="25"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent font-serif text-sm leading-relaxed"
                            placeholder="æ¨è–¦çŠ¶ãŒè¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
                    </div>
                </div>

                <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
                <div id="recommendation-doc-error" class="hidden text-center py-16">
                    <i class="fas fa-exclamation-triangle text-6xl text-red-600 mb-6"></i>
                    <p class="text-xl text-red-600 font-medium" id="recommendation-doc-error-message"></p>
                    <button onclick="regenerateRecommendationDoc()"
                        class="mt-6 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        <i class="fas fa-redo mr-2"></i>å†è©¦è¡Œ
                    </button>
                </div>
            </div>

            <div class="flex justify-end gap-3 p-6 border-t bg-gray-50">
                <button onclick="closeRecommendationDocPreviewModal()"
                    class="px-6 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-100 font-medium">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button onclick="regenerateRecommendationDoc()"
                    class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 font-medium">
                    <i class="fas fa-sync"></i>
                    å†ç”Ÿæˆ
                </button>
                <button onclick="downloadRecommendationDocWord()"
                    class="px-6 py-2.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center gap-2 font-medium">
                    <i class="fas fa-file-word"></i>
                    Wordå‡ºåŠ›
                </button>
            </div>
        </div>
    </div>

</body>

</html>
